'' 10-Dec-2013 ReqId-899 By Imran Tax on Purchase order
'' 12-Dec-2013 ReqId-915 Imran Ali error at add item in purchase 
''16-Dec-2013 R933   Imran Ali           Slow working save/update in transaction formstxtTaxDeductPercent
''16-Dec-2013 R934   M Ijaz Javed       Hide Buttons Edit,Delete and Print on Load Form
''19-Dec-2013 R:945 , TaskId:2338        M Ijaz Javed           By default pack rupees
''24-Dec-2013 ReqId-970  Imran Ali        Receiving Note in ERP system
''25-Dec-2013 R:972          Imran Ali        Good Received And Inwardgatepass Formate Report
''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
''28-Dec-2013   R:M6  Imran Ali          Release 2.1.0.0 Bug
''2-Jan-2014   Tsk:2367    Imran Ali             Calculation Problem
''11-Jan-2014 Task:2373         Imran Ali                Add Columns SubSub Title in Account List on Sales/Purchase
''11-Jan-2014 Task:2374           Imran Ali                Net Amount Sales/Purchase 
''18-Jan-2014 TASK:2380             Imran Ali                 Cash and credit sale and purchase invoice
'' 20-Jan-2014    TASK:2384            IMRAN Ali                 Cash Not Save On Purchase
''31-Jan-2014      TASK:2395             Imran Ali                  Apply Rights On IGP And Inspection Report (Auto Mobile)  
''31-Jan-2014     TASK:2401            Imran ali                    Store Issuence Problem 
''31-Jan-2014     Task:2404 Imran Delete Record Problem In Transaction Forms  
''03-Feb-2014        Task:2406   Imran Ali    FIELD CHOOSER restriction (Senior Rozgar)
''03-Feb-2014          Task:2407    Imran Ali       unit of measurement on GRN and purchase window.
''18-Feb-2014 Task:2429 Imran Ali 1-error in payable/receivable tracing
''26-Feb-2014  Task:2442  Imran Ali   4-bill no. DC no. shown on ledger report of party.
''28-Feb-2014   Task:2447   Imran Ali  2-Remove Batch N0. duplication.
''03-Mar-2014  Task:2452    Imran Ali  4-ALPHABETIC order of items in sale and purchase window
''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
'Mughees 7-5-2014 Task No 2608 Update The Code to Get RoundOff Functionality
''08-May-2014 Task:2612 Imran Ali GL Account Department Wise Mapping Problem In Purchase 
'15-May-2014 Task: 2626 Junaid project column added in sale / purchase and both returns in history tab.
'' 26-May-2014 TASK:2647 Imran Ali New Enhancement 
''26-May-2014 TASK:2658 Imran Ali Duplicate Record Show In Purchase History
'' 6-June-2014 TASK:2673 Imran Ali CMFA Document Developement (Ravi)
''19-June-2014 TASK:2696 IMRAN ALI Purchase Order Status Not Working Properlly
''24-Jul-2014 Task:2759 Imran ali Amount Round on all transaction forms
''27-Jul-2014 Task:2762 Imran Ali Total Amount Rounding configuration
''07-Aug-2014 Task:2774 Imrna Ali Revised Invoice Based Aging Report (Ravi)
''18-Aug-2014 Task:2790 Imran Ali Purchase Account Mapping from front end on purchase
''19-Aug-2014 Task:2791 Imran Ali Multi Purchase Invoice Print Option on Purchase
''21-Aug-2014 Task:2794 Imran Ali Sales/Purchase Invoice Depanded Record Delete
''11-Sep-2014 Task:M101 Imran Ali Add new field remarks 
'2015-05-14  Task# 20150504 Add direct printing option from configration Ali Ansari
'2015-06-08 Task# 2015060006 Save Attachements Ali Ansari
''10-June-2015 Task# A2-10-06-2015 Ahmad Sharif: Add Check on grdSaved to check on double click if row less than zero than exit
''10-June-2015 Task# A1-10-06-2015 Ahmad Sharif: Added Key Pres event for some textboxes to take just numeric and dot value
''10-6-2015 TASKM106151 Imran Ali Keep Status Partially Purchase Return Qty
''12-jun-2015 Task#A1 12-06-2015 Add Check on grdSaved to check on double click if row less than zero than exit
''12-jun-2015 Task#A2 12-06-2015 Ahmad Sharif: Check Vendor exist in combox list or not
'06-07-2015 Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
'05-Aug-2015 Task#05082015 Ahmad Sharif  Add Discount Textbox on design, Calucalate discount on item price (Item wise discount)
'16-Sep-2015 Task#16092015 Ahmad Sharif: Load Companies and Locations user wise
''19-9-2015 TASK15 Imran Ali: Posted Purchase Order 
''19-9-2015 TASK22 Imran Ali: Validation On Qty And Price
''12-11-2015 TASK-TFS-51 Imran Ali: Apply Additional Tax @ Exclusive Tax Amount
'' TASK-470 Muhammad Ameen on 01-07-2016 : Stock Statement Report By Pack
'' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
''TASK : TFS1391 get saved ReceivingNoteId in ReceivingDetailTable against Multi GRNs loading on 06-09-2017 by Ameen. 
'' TASK TFS1427 UserName should be saved in voucher. Ameen done on 13-09-2017
''TASK TFS1474 Muhammad Ameen on 15-09-2017. Currency rate can not be edited while base currency is selected.
'' TASK TFS1378 Muhammad Ameen on 16-10-2017. Stock impact on Purchase should be restricted in case GRN's stock impact flag is checked and that GRN is selected on Purchase.
'' TASK TFS1592 Ayesha Rehman on 19-10-2017 Future date entry should be rights based
''TFS1596 Ayesha Rehman : Lot/Batch wise Stock Management on 30-11-2017
''TFS2612 Ayesha Rehman : Cash Payment Voucher No Company Wise on Purchase According to Payment Screen
''TFS2988 Ayesha Rehman : 09-04-2018 : If document is approved from one stage then it should not change able for previous stage
''TFS2989 Ayesha Rehman : 10-04-2018 : If document is rejected from one stage then it should open for previous stage for approval
''TFS4161 Ayesha Rehman : 09-08-2018 : P QTY: (Should Be Static/ Un-Changeable / Un-Editable on All Screens)
''TFS4689 Ayesha Rehman : 03-10-2018 : Show only relevant Accounts on Transactional screens while User wise COA Configuration.
''TFS4705 Ayesha Rehman : 08-10-2018 : Pack Unit & Pack Size issue on PO, GRN and Purchase.
Imports System.Data.OleDb
Imports SBModel
Imports SBDal
Imports SBDal.UtilityDAL
Imports SBDal.StockDAL
Imports SBDal.StockDocTypeDAL
Imports CrystalDecisions.CrystalReports.Engine
Imports CrystalDecisions.Shared
Imports CrystalDecisions.Shared.ExportOptions
Imports CrystalDecisions.Windows.Forms
Imports SBUtility.Utility
Imports Infragistics.Win.UltraWinGrid
Imports Infragistics.Win


Public Class frmPurchaseNew
    'Rq_Id = 828, Discount on Purchase, Change on 18-Sep-13
    Implements IGeneral
    Dim dt As DataTable
    Dim IsEditMode As Boolean = False
    Dim CurrencyRate As Double = 1
    Dim Mode = "Normal"
    Dim IsFormLoaded As Boolean = False
    Dim StockMaster As StockMaster
    Dim StockDetail As StockDetail
    'rafay task start
    ''Dim companyinitials As String
    'rafay task end
    Dim RecQtyBeforePOAccess As Double
    Dim Email As Email
    Dim VNo As String = String.Empty
    Dim ExistingVoucherFlg As Boolean = False
    Dim VoucherId As Integer = 0
    Dim SourceFile As String = String.Empty
    Dim FileName As String = String.Empty
    Dim setVoucherNo As String = String.Empty
    Dim getVoucher_Id As Integer = 0
    Dim Total_Amount As Double = 0D
    Dim setEditMode As Boolean = False
    Dim crpt As New ReportDocument
    Dim Previouse_Amount As Double = 0D
    Dim TaxAmount As Double = 0D
    Dim PrintLog As PrintLogBE
    Dim flgCurrenyonOpenLC As Boolean = False
    Dim flgSelectProject As Boolean = False
    Dim flgCompanyRights As Boolean = False
    Dim flgTransaportationChargesVoucher As Boolean = False
    Dim objRateList As List(Of Double)
    Dim StockList As List(Of StockDetail)
    Dim drReceivingNote As DataRowView 'ReqId-970 Declared Datarowviw Variable
    Dim taxamnt As Double = 0D  ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
    'R:979 Declare Objects 
    Dim PurchaseTaxAccountId As Integer = 0I
    Dim PaymentVoucherFlg As String = String.Empty
    Dim AccountId As Integer = 0I
    Dim flgAvgRate As Boolean = False
    Dim GLAccountArticleDepartment As Boolean = False
    Dim flgAutoLoadPO As Boolean = False
    'End R:979
    ''Task:2376 Declare Boolean Variables
    Dim flgCommentCustomerFormat As Boolean = False
    Dim flgCommentArticleFormat As Boolean = False
    Dim flgCommentArticleSizeFormat As Boolean = False
    Dim flgCommentArticleColorFormat As Boolean = False
    Dim flgCommentQtyFormat As Boolean = False
    Dim flgCommentPriceFormat As Boolean = False
    Dim flgCommentRemarksFormat As Boolean = False
    'End Task:2376
    Dim CreditPurchase As Boolean = True 'Task:2380 Added Flag Credit Purchase
    Public Tags As String = String.Empty
    Dim flgCommentDcNo As Boolean = False ''26-Feb-2014  Task:2442  Imran Ali   4-bill no. DC no. shown on ledger report of party.
    Dim flgCommentInvoiceNo As Boolean = False ''26-Feb-2014  Task:2442  Imran Ali   4-bill no. DC no. shown on ledger report of party.
    Dim lngVoucherId As Integer = 0I ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
    Dim flgPurchaseAccountFrontEnd As Boolean = False
    Dim blnUpdateAll As Boolean = False
    'Marked Against Task#2015060001 Ali Ansari
    'Dim arrfile As String
    'Marked Against Task#2015060001 Ali Ansari
    'Altered Against Task#2015060001 Ali Ansari
    ' Convert string into List of string for making proper count
    Dim arrFile As List(Of String)
    'Altered Against Task#2015060001 Ali Ansari
    Private blnDisplayAll As Boolean = False
    Public intReceivingNoteId As Integer = 0I
    Dim BaseCurrencyId As Integer = 0
    Dim BaseCurrencyName As String = String.Empty
    Dim flgMultipleSalesOrder As Boolean = False
    Dim flgMultiGRN As Boolean = False
    Dim IsGetAllAllowed As Boolean = False
    Dim IsAdminGroup As Boolean = False
    'Code Edit for task 1592 future date rights
    Dim IsDateChangeAllowed As Boolean = False
    Public Shared Rate As Double
    Dim flgCostPrice As Boolean = False
    ''TFS2375 : Ayesha Rehman : This Variable is Added to check ApprovalProcessId ,if it is mapped against the document
    Dim ApprovalProcessId As Integer = 0
    ''TFS2375 : Ayesha Rehman :End
    Dim flgAddItemForMall As Boolean = False ''TFS3762 
    Dim ReceivingId As Integer = 0
    Dim IsPackQtyDisabled As Boolean = False ''TFS4161
    Dim blnOrderQtyExceed As Boolean = False 'Task:2796 declare variable for Purchase order qty exceed against Purchase
    Dim blnDeliveryQtyExceed As Boolean = False 'Task:2796 declare variable for GRN qty exceed against Purchase
    Dim ItemFilterByName As Boolean = False
    Dim IsItemSearchChanged As Boolean = False
    ''TASK TFS4709
    Dim IsGRNStockImpacted As Boolean = False
    Dim ShouldStockImpactGo As Boolean = True
    Dim Total As Double = 0
    'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
    Dim PurchaseDiscountAccountId As Integer = 0
    Dim closingdate As String
    
    Enum grdEnm
        LocationId
        ArticleCode
        Item
        AlternativeItem
        Color
        Size
        Uom 'Task :2407 added index
        Unit
        X_Tray_Weights
        X_Gross_Weights
        X_Net_Weights
        Y_Gross_Weights
        Y_Tray_Weights
        Y_Net_Weights
        ReceivedQty
        RejectedQty
        Qty
        GrossQty
        Column1
        Column2
        Column3
        TotalQty
        VendorQty
        Deduction
        VendorNetQty
        CurrentPrice
        RateDiscPercent
        Price
        BaseCurrencyId
        BaseCurrencyRate
        CurrencyId
        CurrencyRate
        CurrencyAmount
        CurrencyTotalAmount
        Total 'Task:2374 Change Index Position
        TaxPercent
        TaxAmount
        CurrencyTaxAmount
        'TAKS-TFS-51 Added Index
        AdTax_Percent
        AdTax_Amount
        CurrencyAdTaxAmount
        'End 'TAKS-TFS-51
        'Total
        TotalAmount 'Task:2374 Added Index
        Transportation_Charges
        Custom_Charges
        Discount_Price
        ArticleGroupId
        ArticleDefId
        PackQty
        'CurrentPrice
        PackPrice
        BatchId
        BatchNo
        ExpiryDate
        Origin
        Comments
        Pack_Desc
        AccountId
        ItemWiseDisc    'Task#05082015 add itemWiseDiscount to enums (Ahmad Sharif)
        ReceivingDetailId 'TASKM106151 Added Columns In Purchase Detail Record(DiplayDetail(), DisplayPODetail() e.g)
        PurchaseReturnQty 'TASKM106151 Added Columns In Purchase Detail Record(DiplayDetail(), DisplayPODetail() e.g)
        ReceivingNoteDetailId
        PurchaseOrderDetailId
        ReceivingNoteId
        AlternativeItemId
        ButtonDelete
    End Enum
    ''ReqId-970 Added Enum
    Enum enmReceivingNote
        Id
        RceivingNoteNo
        ReceivingNoteId
        LocationId
        ReceivingNo
        ReceivingDate
        VendorId
        PurchaseOrderID
        PartyInvoiceNo
        PartySlipNo
        ReceivingQty
        ReceivingAmount
        CashPaid
        Remarks
        UserName
        IGPNo
        DcNo
        Post
        DcDate
        Driver_Name
        Vehicle_No
        vendor_invoice_no
        CostCenterId
        CurrencyType
        CurrencyRate
        Transportation_Vendor
        Custom_Vendor
        Total_Discount_Amount
        UpdateUserName
        Arrival_Time
        Departure_Time
    End Enum
    Private Sub frmPurchaseNew_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Me.KeyDown
        Try
            'R-974 Ehtisham ul Haq user friendly system modification on 8 -1-14
            If e.KeyCode = Keys.F4 Then
                If BtnSave.Enabled = True Then
                    SaveToolStripButton_Click(Nothing, Nothing)
                End If
            End If
            If e.KeyCode = Keys.Escape Then
                NewToolStripButton_Click(Nothing, Nothing)
            End If
            If e.KeyCode = Keys.F5 Then
                BtnRefresh_Click(Nothing, Nothing)
            End If
            If e.KeyCode = Keys.Insert Then
                btnAdd_Click(Nothing, Nothing)
            End If
            If e.KeyCode = Keys.U AndAlso e.Alt Then
                If Me.BtnSave.Text = "&Update" Then
                    If Me.BtnSave.Enabled = False Then
                        RemoveHandler Me.BtnSave.Click, AddressOf Me.SaveToolStripButton_Click
                    End If
                End If
            End If
            If e.KeyCode = Keys.D AndAlso e.Alt Then
                If Me.BtnSave.Text = "&Delete" Then
                    If Me.BtnDelete.Enabled = False Then
                        RemoveHandler Me.BtnDelete.Click, AddressOf Me.DeleteToolStripButton_Click
                    End If
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub frmPurchaseNew_Shown(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Shown
        Try


            'Commented against Request no. 979
            'If Not getConfigValueByType("CompanyRights").ToString = "Error" Then
            '    flgCompanyRights = getConfigValueByType("CompanyRights")
            'End If

            'If Not getConfigValueByType("CurrencyonOpenLC").ToString = "Error" Then
            '    flgCurrenyonOpenLC = Convert.ToBoolean(getConfigValueByType("CurrencyonOpenLC").ToString)
            'End If

            'If Not getConfigValueByType("TransaportationChargesVoucher").ToString = "Error" Then
            '    flgTransaportationChargesVoucher = getConfigValueByType("TransaportationChargesVoucher")
            'End If
            'End R:979
            'R979 Loading Configurations
            'R-974 Ehtisham ul Haq user friendly system modification on 8-1-14 
            Me.lblProgress.Text = "Loading Please Wait ..."
            Me.lblProgress.BackColor = Color.LightYellow
            Me.lblProgress.Visible = True
            Me.Cursor = Cursors.WaitCursor
            Application.DoEvents()
            If Me.bwLoading.IsBusy Then Exit Sub
            Me.bwLoading.RunWorkerAsync()
            Do While Me.bwLoading.IsBusy
                Application.DoEvents()
            Loop
            'End R:979
            'Task:2376 Get Comments Layout Configurations
            If BackgroundWorker3.IsBusy Then Exit Sub
            BackgroundWorker3.RunWorkerAsync()
            Do While BackgroundWorker3.IsBusy
                Application.DoEvents()
            Loop
            'End Task:2376
            BaseCurrencyId = Val(getConfigValueByType("Currency").ToString)
            BaseCurrencyName = GetBasicCurrencyName(BaseCurrencyId)
            If Not getConfigValueByType("AddItemForMall").ToString = "Error" Then
                flgAddItemForMall = Convert.ToBoolean(getConfigValueByType("AddItemForMall").ToString)
            End If
            closingdate = getConfigValueByType("EndOfDate").ToString
            ''start TFs4161
            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            If Not getConfigValueByType("PurchaseDiablePackQuantity").ToString = "Error" Then
                IsPackQtyDisabled = Convert.ToBoolean(getConfigValueByType("PurchaseDiablePackQuantity").ToString)
            End If
            ''End TFS4161
            ' ''TASK TFS4544
            'If getConfigValueByType("ItemFilterByName").ToString = "True" Then
            '    ItemFilterByName = Convert.ToBoolean(getConfigValueByType("ItemFilterByName").ToString)
            'End If
            ' ''END TFS4544
            FillCombo("Category")
            FillCombo("Vendor")
            FillCombo("CostCenter")
            'FillCombo("Item")
            FillCombo("SM")
            FillCombo("Currency")
            FillCombo("TransportationVendor")
            FillCombo("CustomVendor")
            FillCombo("PurchaseAccount")
            FillCombo("InwardExpense")
            FillCombo("Company")
            'Task:2790 Get Configuration PurchaseAccountFrontEnd
            If Not getConfigValueByType("PurchaseAccountFrontEnd").ToString = "Error" Then
                flgPurchaseAccountFrontEnd = getConfigValueByType("PurchaseAccountFrontEnd")
            End If

            'If frmModProperty.blnListSeachStartWith = True Then
            '    cmbItem.AutoCompleteMode = Win.AutoCompleteMode.Suggest
            '    cmbItem.AutoSuggestFilterMode = Win.AutoSuggestFilterMode.StartsWith
            'End If

            'If frmModProperty.blnListSeachContains = True Then
            '    cmbItem.AutoCompleteMode = Win.AutoCompleteMode.Suggest
            '    cmbItem.AutoSuggestFilterMode = Win.AutoSuggestFilterMode.Contains
            'End If
            'If Not getConfigValueByType("MultipleSalesOrder").ToString = "Error" Then
            '    flgMultipleSalesOrder = Convert.ToBoolean(getConfigValueByType("MultipleSalesOrder").ToString)
            'Else
            '    flgMultipleSalesOrder = False
            'End If
            'End Task:2790
            ''TASK TFS1391
            If Not getConfigValueByType("LoadMultiGRN").ToString = "Error" Then
                flgMultiGRN = Convert.ToBoolean(getConfigValueByType("LoadMultiGRN").ToString)
            Else
                flgMultiGRN = False
            End If
            ''END TASK TFS

            'TAsk:2795 Set ByRef Variable blnOrderQtyExceed
            If Not getConfigValueByType("OrderQtyExceedAgainstPurchase").ToString = "Error" Then
                blnOrderQtyExceed = getConfigValueByType("OrderQtyExceedAgainstPurchase").ToString
            Else
                blnOrderQtyExceed = False
            End If
            'End Task:2796

            'TAsk:2795 Set ByRef Variable blnGRNQtyExceed
            If Not getConfigValueByType("GRNQtyExceedAgainstPurchase").ToString = "Error" Then
                blnDeliveryQtyExceed = getConfigValueByType("GRNQtyExceedAgainstPurchase").ToString
            Else
                blnDeliveryQtyExceed = False
            End If
            'End Task:2796


            'FillCombo("ArticlePack") R933 Commented
            'FillCombo("Company")
            'DisplayRecord()
            RefreshControls()
            'Me.cmbVendor.Focus()
            Me.dtpPODate.Focus()
            'DisplayDetail(-1)
            'Me.DisplayRecord() R933 Commented History Data
            '//This will hide Master grid
            Me.grdSaved.Visible = CType(getConfigValueByType("ShowMasterGrid"), Boolean)
            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            PurchaseDiscountAccountId = CType(getConfigValueByType("PurchaseDiscountAccount"), Integer)
            IsFormLoaded = True
            Get_All(frmModProperty.Tags)
            'TFS3360
            UltraDropDownSearching(cmbVendor, frmMain.blnListSeachStartWith, frmMain.blnListSeachContains)
            UltraDropDownSearching(cmbItem, frmMain.blnListSeachStartWith, frmMain.blnListSeachContains)
            UltraDropDownSearching(cmbPurchaseAccount, frmMain.blnListSeachStartWith, frmMain.blnListSeachContains)
            Me.lblProgress.Visible = False
            Me.Cursor = Cursors.Default




        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            If frmModProperty.Tags.Length > 0 Then frmModProperty.Tags = String.Empty ''18-Feb-2014 Task:2429 Imran Ali 1-error in payable/receivable tracing
        End Try
    End Sub
    Private Sub Form1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Try

            ApplyGridSettings()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub DisplayRecord(Optional ByVal strCondition As String = "")
        Dim ClosingDate As DateTime = Convert.ToDateTime(getConfigValueByType("EndOfDate").ToString)
        Dim PreviouseRecordShow As Boolean = Convert.ToBoolean(getConfigValueByType("PreviouseRecordShow").ToString)
        Dim str As String = String.Empty
        Dim username As String = LoginUserName
        'str = "SELECT     Recv.ReceivingNo, Recv.ReceivingDate AS Date, vwCOADetail.detail_title as CustomerName, V.PurchaseOrderNo, Recv.ReceivingQty, Recv.ReceivingAmount, Recv.ReceivingId,  " & _
        '        "Recv.CustomerCode, EmployeeDefTable.EmployeeName, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid, Recv.EmployeeCode, Recv.PoId " & _
        '        "FROM         ReceivingMasterTable Recv INNER JOIN " & _
        '        "vwCOADetail ON Recv.CustomerCode = vwCOADetail.coa_detail_id LEFT OUTER JOIN " & _
        '        "EmployeeDefTable ON Recv.EmployeeCode = EmployeeDefTable.EmployeeId LEFT OUTER JOIN " & _
        '        "PurchaseOrderMasterTable V ON Recv.POId = V.PurchaseOrderId " & _
        '        "ORDER BY Recv.ReceivingNo DESC"

        'FillGrid(grdSaved, str)
        'grdSaved.Columns(10).Visible = False
        ''grdSaved.Columns(4).Visible = False
        'grdSaved.Columns(6).Visible = False
        'grdSaved.Columns(7).Visible = False
        'grdSaved.Columns("EmployeeCode").Visible = False
        'grdSaved.Columns("PoId").Visible = False

        'grdSaved.Columns(0).HeaderText = "Issue No"
        'grdSaved.Columns(1).HeaderText = "Date"
        'grdSaved.Columns(2).HeaderText = "Customer"
        'grdSaved.Columns(3).HeaderText = "S-Order"
        'grdSaved.Columns(4).HeaderText = "Qty"
        'grdSaved.Columns(5).HeaderText = "Amount"
        'grdSaved.Columns(8).HeaderText = "Employee"

        'grdSaved.Columns(0).Width = 100
        'grdSaved.Columns(1).Width = 100
        'grdSaved.Columns(2).Width = 150
        'grdSaved.Columns(4).Width = 50
        'grdSaved.Columns(5).Width = 80
        'grdSaved.Columns(8).Width = 100
        'grdSaved.Columns(9).Width = 150
        'grdSaved.RowHeadersVisible = False
        If Mode = "Normal" Then
            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '        "Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '        "Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor " & _
            '        "FROM dbo.ReceivingMasterTable Recv INNER JOIN " & _
            '        "vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '        "dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN (Select DISTINCT ReceivingId, LocationId From ReceivingDetailTable) as Location On Location.ReceivingId = Recv.ReceivingId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '       & " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""

            'Before against task:2658
            '     str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            ' "Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            ' "Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name " & _
            ' "FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            ' "vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            ' "dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN (Select DISTINCT ReceivingId, LocationId From ReceivingDetailTable) as Location On Location.ReceivingId = Recv.ReceivingId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '& " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'TAsk:2658 Remove SubQuery ReceivingDetailTable
            'Before against task:2673
            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            ' "Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            ' "Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name " & _
            ' "FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            ' "vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            ' "dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '& " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'End Task:2658
            'Task:2673 Added Field RefCMFADocId

            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '  " Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '   " Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId " & _
            '   " FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '   " vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '   " dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '  & " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'End Task:2673
            ''07-Aug-2014 Task:2774 Imrna Ali Revised Invoice Based Aging Report (Ravi)
            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '  " Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '   " Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays " & _
            '   " FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '   " vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '   " dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '  & " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'End Task:2774
            'Task: 2626 Junaid Retrieve 'Name' field from 'tblDefCostCenter'
            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, tblDefCostCenter.Name ," & _
            '        "Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '        "Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor " & _
            '        "FROM tblDefCostCenter INNER JOIN dbo.ReceivingMasterTable Recv ON tblDefCostCenter.CostCenterID=Recv.CostCenterId  INNER JOIN " & _
            '        "vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '        "dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN (Select DISTINCT ReceivingId, LocationId From ReceivingDetailTable) as Location On Location.ReceivingId = Recv.ReceivingId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '       & " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            ''End task 2626

            'Task:2790 Added Feild PurchaseAcId
            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '  " Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '   " Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId " & _
            '   " FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '   " vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '   " dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '  & " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'end Task:2790
            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            ' " Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '  " Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId " & _
            '  " FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '  " vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '  " dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            ' & " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'str = "SELECT " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '" Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            ' " Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId, V.Contact_Email as Email " & _
            ' " FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            ' " vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            ' " dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " _
            '& " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'str = "SELECT distinct " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '" Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '" Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId, V.Contact_Email as Email, Recv.InvoiceType ,  Adjustment.InvoiceID" & _
            '" FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '" vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '" dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " & _
            '" left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Purchase') as Adjustment on Recv.ReceivingId = Adjustment.InvoiceID " & _
            '" where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'Marked Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
            'str = "SELECT distinct " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, dbo.PurchaseOrderMasterTable.PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '          " Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '          " Recv.PurchaseOrderID, Recv.DcNo, Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name, Recv.DcDate,  Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId, V.Contact_Email as Email, Recv.InvoiceType , IsNull([No Of Attachment],0) as [No Of Attachment], Adjustment.InvoiceID" & _
            '          " FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '          " vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '          " dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " & _
            '          " left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Purchase') as Adjustment on Recv.ReceivingId = Adjustment.InvoiceID  LEFT OUTER JOIN(Select Count(*) as [No Of Attachment], DocId From DocumentAttachment WHERE Source=N'" & Me.Name & "' Group By DocId) Att On Att.DocId=  Recv.ReceivingId " & _
            '          " where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'Marked Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
            'Altered Against Task#2015060006 add no of attachements in query

            '  str = "SELECT distinct " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, Case When IsNull(GRN_PO.PurchaseOrderId,0) = 0 Then dbo.PurchaseOrderMasterTable.PurchaseOrderNo else GRN_PO.PurchaseOrderNo end as PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '" Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '" Recv.PurchaseOrderID, Recv.DcNo, Recv.DcDate, GRN.ReceivingNo as [GRN No], Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name,   Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId, V.Contact_Email as Email, Recv.InvoiceType , IsNull([No Of Attachment],0) as [No Of Attachment], Adjustment.InvoiceID,Recv.UserName as 'User Name',Recv.UpdateUserName as [Modified By] " & _
            '" FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '" vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '" dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " & _
            '" left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Purchase') as Adjustment on Recv.ReceivingId = Adjustment.InvoiceID  LEFT OUTER JOIN(Select Count(*) as [No Of Attachment], DocId From DocumentAttachment WHERE Source=N'" & Me.Name & "' Group By DocId) Att On Att.DocId=  Recv.ReceivingId  LEFT OUTER JOIN ReceivingNoteMasterTable GRN on GRN.ReceivingNoteId  = Recv.ReceivingNoteId LEFT OUTER JOIN PurchaseOrderMasterTable GRN_PO on GRN_PO.PurchaseOrderId = GRN.PurchaseOrderId  " & _
            '" where Recv.ReceivingNo like 'Pur%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""
            'Altered Against Task#2015060006 add no of attachements in query
            'Altered Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms


            '     str = "SELECT distinct " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, Case When IsNull(GRN_PO.PurchaseOrderId,0) = 0 Then dbo.PurchaseOrderMasterTable.PurchaseOrderNo else GRN_PO.PurchaseOrderNo end as PurchaseOrderNo, V.detail_title, Recv.ReceivingQty, " & _
            '" Recv.ReceivingAmount, Recv.ReceivingId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
            '" Recv.PurchaseOrderID, Recv.DcNo, Recv.DcDate, GRN.ReceivingNo as [GRN No], Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name,   Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, Recv.Arrival_Time as [In Time], Recv.Departure_Time as [Out Time], CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId, V.Contact_Email as Email, Recv.InvoiceType , IsNull([No Of Attachment],0) as [No Of Attachment], Adjustment.InvoiceID,Recv.UserName as 'User Name',Recv.UpdateUserName as [Modified By] " & _
            '" FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
            '" vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
            '" dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " & _
            '" left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Purchase') as Adjustment on Recv.ReceivingId = Adjustment.InvoiceID  LEFT OUTER JOIN(Select Count(*) as [No Of Attachment], DocId From DocumentAttachment WHERE Source=N'" & Me.Name & "' Group By DocId) Att On Att.DocId=  Recv.ReceivingId  LEFT OUTER JOIN ReceivingNoteMasterTable GRN on GRN.ReceivingNoteId  = Recv.ReceivingNoteId LEFT OUTER JOIN PurchaseOrderMasterTable GRN_PO on GRN_PO.PurchaseOrderId = GRN.PurchaseOrderId  " & _
            '" where Recv.ReceivingNo like 'Pur%' sssss" & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""


            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            'Rafay Modified query to add amountus field
            str = "SELECT distinct " & IIf(strCondition.ToString = "All", "", "Top 50") & "  Recv.ReceivingNo, Recv.ReceivingDate AS Date, Case When IsNull(GRN_PO.PurchaseOrderId,0) = 0 Then dbo.PurchaseOrderMasterTable.PurchaseOrderNo else GRN_PO.PurchaseOrderNo end as PurchaseOrderNo, V.detail_title,dbo.tblcurrency.currency_code As currency_code, " & _
       " Recv.ReceivingAmount,Recv.ReceivingId,Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid,  " & _
       " Recv.PurchaseOrderID, Recv.DcNo, Recv.DcDate, GRN.ReceivingNo as [GRN No], Isnull(Recv.Total_Discount_Amount,0) as Total_Discount_Amount, IsNull(Recv.TaxDeductionPercent,0) as TaxDeductionPercent,IsNull(Recv.TaxDeductionAmount,0) as TaxDeductionAmount,  IsNull(Recv.Post, 0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end as Status, Recv.Vehicle_No, Recv.Driver_Name,   Recv.Vendor_Invoice_No, Isnull(Recv.CostCenterId,0) as CostCenterId, Recv.IGPNo, Recv.Arrival_Time as [In Time], Recv.Departure_Time as [Out Time], CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], isnull(Recv.CurrencyType,0) as CurrencyType, isnull(Recv.CurrencyRate,0) as CurrencyRate, ISNULL(Recv.Transportation_Vendor,0) as Transportation_Vendor , ISNULL(Recv.Custom_Vendor,0) as Custom_Vendor, CstCntr.Name, IsNull(Recv.RefCMFADocId,0) as RefCMFADocId, IsNull(Recv.DueDays,0) as DueDays, IsNull(Recv.PurchaseAcId,0) as PurchaseAcId, V.Contact_Email as Email, Recv.InvoiceType , IsNull([No Of Attachment],0) as [No Of Attachment], Adjustment.InvoiceID,Recv.UserName as 'User Name',Recv.UpdateUserName as [Modified By], IsNull(Recv.ReceivingNoteId,0) as ReceivingNoteId, Recv.LocationId, Recv.ReceivingQty, ISNULL(Recv.DiscountType,'Flat') AS DiscountType, ISNULL(Recv.AdjDiscount,0) AS AdjDiscount  " & _
       " FROM dbo.tblDefCostCenter CstCntr Right Outer Join dbo.ReceivingMasterTable Recv ON CstCntr.CostCenterID=Recv.CostCenterId INNER JOIN " & _
       " vwCOADetail V ON Recv.VendorId = V.coa_detail_id LEFT OUTER JOIN " & _
       " dbo.tblcurrency ON Recv.CurrencyType = dbo.tblcurrency.currency_id LEFT OUTER JOIN " & _
       " dbo.PurchaseOrderMasterTable ON Recv.PurchaseOrderID = dbo.PurchaseOrderMasterTable.PurchaseOrderId LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.ReceivingNo  " & _
       " left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Purchase') as Adjustment on Recv.ReceivingId = Adjustment.InvoiceID  LEFT OUTER JOIN(Select Count(*) as [No Of Attachment], DocId From DocumentAttachment WHERE Source=N'" & Me.Name & "' Group By DocId) Att On Att.DocId=  Recv.ReceivingId  LEFT OUTER JOIN ReceivingNoteMasterTable GRN on GRN.ReceivingNoteId  = Recv.ReceivingNoteId LEFT OUTER JOIN PurchaseOrderMasterTable GRN_PO on GRN_PO.PurchaseOrderId = GRN.PurchaseOrderId  " & _
       " where Recv.ReceivingNo not like 'SRN%' " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, Recv.ReceivingDate, 102) > Convert(Datetime, N'" & ClosingDate & "', 102))") & ""


            If blnDisplayAll = False Then
                If flgCompanyRights = True Then
                    str += " AND Recv.LocationId=" & MyCompanyId
                End If
            End If
            If Me.dtpFrom.Checked = True Then
                str += " AND Recv.ReceivingDate >= Convert(Datetime, N'" & Me.dtpFrom.Value.ToString("yyyy-M-d 00:00:00") & "', 102)"
            End If
            If Me.dtpTo.Checked = True Then
                str += " AND Recv.ReceivingDate <= Convert(Datetime, N'" & Me.dtpTo.Value.ToString("yyyy-M-d 23:59:59") & "', 102)"
            End If
            If Me.txtSearchDocNo.Text <> String.Empty Then
                str += " AND Recv.ReceivingNo LIKE '%" & Me.txtSearchDocNo.Text & "%'"
            End If
            If Not Me.cmbSearchLocation.SelectedIndex = -1 Then
                If Me.cmbSearchLocation.SelectedIndex <> 0 Then
                    str += " AND Location.LocationId=" & Me.cmbSearchLocation.SelectedValue
                End If
            End If
            If Me.txtFromAmount.Text <> String.Empty Then
                If Val(Me.txtFromAmount.Text) > 0 Then
                    str += " AND Recv.ReceivingAmount >= " & Val(Me.txtFromAmount.Text) & " "
                End If
            End If
            If Me.txtToAmount.Text <> String.Empty Then
                If Val(Me.txtToAmount.Text) > 0 Then
                    str += " AND Recv.ReceivingAmount <= " & Val(Me.txtToAmount.Text) & ""
                End If
            End If
            If Me.cmbSearchAccount.ActiveRow IsNot Nothing Then
                If Me.cmbSearchAccount.SelectedRow.Cells(0).Value <> 0 Then
                    str += " AND Recv.VendorId = " & Me.cmbSearchAccount.Value
                End If
            End If

            If username.Length > 0 AndAlso IsGetAllAllowed = False AndAlso IsAdminGroup = False Then
                str += " And recv.UserName LIKE '%" & username & "%'"
            End If
            If Me.txtSearchRemarks.Text <> String.Empty Then
                str += " AND Recv.Remarks LIKE '%" & Me.txtSearchRemarks.Text & "%'"
            End If
            If Me.txtPurchaseNo.Text <> String.Empty Then
                str += " AND PurchaseOrderMasterTable.PurchaseOrderNo LIKE  '%" & Me.txtPurchaseNo.Text & "%'"
            End If
            str += "  order by Recv.ReceivingId desc"
        End If

        FillGridEx(grdSaved, str, True)
        'rafay
        grdSaved.RootTable.Columns("currency_code").Visible = True
        grdSaved.RootTable.Columns("ReceivingAmount").Visible = True
        grdSaved.RootTable.Columns("ReceivingId").Visible = False
        'rafay
        grdSaved.RootTable.Columns("VendorId").Visible = False
        grdSaved.RootTable.Columns("CashPaid").Visible = False
        grdSaved.RootTable.Columns("PurchaseOrderID").Visible = False
        grdSaved.RootTable.Columns("ReceivingNoteId").Visible = False
        Me.grdSaved.RootTable.Columns("InvoiceID").Visible = False
        grdSaved.RootTable.Columns("PurchaseAcId").Visible = False 'Taks:2790 Set PurchaseAcId Hidden
        Me.grdSaved.RootTable.Columns("RefCMFADocId").Visible = False 'Task:2673 Hidden Column 
        Me.grdSaved.RootTable.Columns("Total_Discount_Amount").Visible = False
        grdSaved.RootTable.Columns("CurrencyType").Visible = False
        grdSaved.RootTable.Columns("CurrencyRate").Visible = False
        grdSaved.RootTable.Columns("Post").Visible = False
        grdSaved.RootTable.Columns("Vehicle_No").Visible = False
        grdSaved.RootTable.Columns("Driver_Name").Visible = False
        grdSaved.RootTable.Columns("CostCenterId").Visible = False
        grdSaved.RootTable.Columns("LocationId").Visible = False
        Me.grdSaved.RootTable.Columns("Transportation_Vendor").Visible = False
        Me.grdSaved.RootTable.Columns("Custom_Vendor").Visible = False
        Me.grdSaved.RootTable.Columns("TaxDeductionAmount").FormatString = "N" & DecimalPointInValue
        Me.grdSaved.RootTable.Columns("TaxDeductionPercent").FormatString = "N" & DecimalPointInValue
        Me.grdSaved.RootTable.Columns("TaxDeductionAmount").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
        Me.grdSaved.RootTable.Columns("TaxDeductionPercent").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
        Me.grdSaved.RootTable.Columns("TaxDeductionAmount").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
        Me.grdSaved.RootTable.Columns("TaxDeductionPercent").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
        Me.grdSaved.RootTable.Columns("TaxDeductionPercent").Caption = "Tax Deduction %"
        Me.grdSaved.RootTable.Columns("Email").Visible = False

        grdSaved.RootTable.Columns(0).Caption = "Doc No"
        grdSaved.RootTable.Columns(1).Caption = "Doc Date"
        grdSaved.RootTable.Columns(2).Caption = "PO No"
        grdSaved.RootTable.Columns(3).Caption = "Vendor Name"
        'rafay
        grdSaved.RootTable.Columns("currency_code").Caption = "Currency"
        grdSaved.RootTable.Columns("ReceivingAmount").Caption = "Base Value"
        'grdSaved.RootTable.Columns("AmountUS").Caption = "Original Value"
        'rafay
        grdSaved.RootTable.Columns("CashPaid").Caption = "Cash Paid"
        grdSaved.RootTable.Columns("Remarks").Caption = "Remarks"
        grdSaved.RootTable.Columns("DcNo").Caption = "Dc No"
        grdSaved.RootTable.Columns("DcDate").Caption = "Dc Date"
        Me.grdSaved.RootTable.Columns("Vendor_Invoice_No").Caption = "Invoice No"
        Me.grdSaved.RootTable.Columns("IGPNo").Caption = "IGP No"
        'Task: 2626 Junaid 'Name' column is modified
        grdSaved.RootTable.Columns("Name").Visible = True
        grdSaved.RootTable.Columns("Name").Caption = "Project Name"
        'END Task: 2626
        grdSaved.RootTable.Columns(0).Width = 100
        grdSaved.RootTable.Columns(1).Width = 100
        grdSaved.RootTable.Columns(2).Width = 100
        grdSaved.RootTable.Columns(3).Width = 200
        grdSaved.RootTable.Columns(8).Width = 200
        Me.grdSaved.RootTable.Columns("Date").FormatString = str_DisplayDateFormat

        'Task:2759 Set rounded amount format.
        Me.grdSaved.RootTable.Columns("ReceivingAmount").FormatString = "N" & DecimalPointInValue
        Me.grdSaved.RootTable.Columns("Total_Discount_Amount").FormatString = "N" & DecimalPointInValue
        'End Task:2759
        ''Rafay:the foreign currency is add on purchase history
        'Dim grdSaved1 As DataTable = GetDataTable(str)
        'grdSaved1.Columns("AmountUS").Expression = "IsNull(ReceivingAmount,0) / (IsNull(CurrencyRate,0))" 'Task:2374 Show Total Amount
        'Me.grdSaved.DataSource = grdSaved1
        ''Set rounded format
        'Me.grdSaved.RootTable.Columns("AmountUS").FormatString = "N" & DecimalPointInValue
        ''rafay


        'Task:2791 Added selector field for multi invoice print
        Me.grdSaved.RootTable.Columns.Add("MultiInvoicePrint")
        Me.grdSaved.RootTable.Columns("MultiInvoicePrint").UseHeaderSelector = True
        Me.grdSaved.RootTable.Columns("MultiInvoicePrint").ActAsSelector = True
        Me.grdSaved.RootTable.Columns("MultiInvoicePrint").Width = 50
        'End Task:2791
        grdSaved.RootTable.Columns("No Of Attachment").ColumnType = Janus.Windows.GridEX.ColumnType.Link
        'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
        Me.grdSaved.RootTable.Columns("AdjDiscount").FormatString = "N" & DecimalPointInValue
        Me.grdSaved.RootTable.Columns("AdjDiscount").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
        Me.grdSaved.RootTable.Columns("AdjDiscount").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
        Me.grdSaved.RootTable.Columns("AdjDiscount").Caption = "Adjustmet Discount"

        Me.CtrlGrdBar2_Load(Nothing, Nothing)
        Me.CtrlGrdBar3_Load(Nothing, Nothing)



    End Sub
    Private Sub btnAdd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAdd.Click
        Try
            If Validate_AddToGrid() Then
                AddItemToGrid()
                ''TASK TFS2578
                Me.txtExpenseTotal.Text = GetNetTotal()
                ''END TASK TFS2578
                'GetTotal()
                ClearDetailControls()
                cmbItem.Focus()
                Me.cmbCurrency.Enabled = False
                'FillCombo("Item")
            End If
        Catch ex As Exception
            msg_Error(ex.Message)
        End Try

    End Sub
    Private Sub RefreshControls()
        Try
            flgCostPrice = False
            'Task 1592 Ayesha Rehman Removing the ErrorProvider on btnNew
            ErrorProvider1.Clear()
            IsEditMode = False
            'If Me.BtnSave.Text = "&Update" Then
            '    FillCombo("Vendor")
            'End If 'R933 Commented

            ''TASK TFS4544
            If getConfigValueByType("ItemFilterByName").ToString = "True" Then
                ItemFilterByName = Convert.ToBoolean(getConfigValueByType("ItemFilterByName").ToString)
            End If
            ''END TFS4544

            ''TASK TFS1378
            If Not getConfigValueByType("GRNStockImpact").ToString = "Error" Then
                IsGRNStockImpacted = Convert.ToBoolean(getConfigValueByType("GRNStockImpact").ToString)
            Else
                IsGRNStockImpacted = False
            End If
            ''END TASK TFS
            txtPONo.Text = ""
            dtpPODate.Value = Now
            Me.dtpDcDate.Value = Now
            Me.dtpPODate.Enabled = True
            Me.dtpDcDate.Checked = False
            Me.CurrencyRate = 1
            Me.txtPackRate.Text = ""
            txtRemarks.Text = ""
            txtPaid.Text = ""
            lblRemainingBudget.Text = ""
            'txtAmount.Text = ""
            txtTotal.Text = ""
            'txtTotalQty.Text = ""
            txtBalance.Text = ""
            txtPackQty.Text = 1
            txtQty.Text = 1
            Me.txtRate.Text = 0
            Me.txtTax.Text = ""
            txtVhNo.Text = ""
            txtDriverName.Text = ""
            'rafay
            ''Me.companyinitials = ""
            'rafay
            Me.txtPackRate.Text = ""
            Me.txtInvoiceNo.Text = String.Empty
            Me.BtnSave.Text = "&Save"
            Me.txtPONo.Text = GetDocumentNo() 'GetNextDocNo("Pur", 6, "ReceivingMasterTable", "ReceivingNo")
            'FillCombo("Batch") R933 Commented
            'FillCombo("SO") 'R933 Commented
            'FillCombo("Item") 'R933 Commented
            'FillCombo("CostCenter")
            cmbUnit.SelectedIndex = 0
            ''Me.cmbSalesMan.SelectedIndex = 0
            cmbVendor.Rows(0).Activate()
            Me.cmbTransportationVendor.Rows(0).Activate()
            Me.cmbCustomVendor.Rows(0).Activate()
            FillCombo("Item")
            cmbItem.Rows(0).Activate()
            Me.cmbPo.Enabled = True
            Me.cmbVendor.Enabled = True
            Me.cmbCurrency.Enabled = True
            'grd.Rows.Clear()
            'DisplayDetail(-1)
            'DisplayPODetail(-1)
            'Me.cmbVendor.Focus()
            Me.dtpPODate.Focus()
            Me.GetSecurityRights()
            If Me.cmbBatchNo.Value = Nothing Then
                Me.cmbBatchNo.Enabled = False
            Else
                Me.cmbBatchNo.Enabled = True
            End If
            Me.txtGRNNo.Text = String.Empty
            Me.cmbInwardExpense.Rows(0).Activate()
            FillInwardExpense(-1, "PUR")
            DisplayDetail(-1)
            DisplayPODetail(-1)
            'FillComboByEdit() R933 Commented
            If flgSelectProject = True Then
                If Not Me.cmbProject.SelectedIndex = -1 Then Me.cmbProject.SelectedIndex = Me.cmbProject.SelectedIndex
            Else
                If Not Me.cmbProject.SelectedIndex = -1 Then Me.cmbProject.SelectedIndex = 0
            End If
            'Me.cmbCompany.SelectedIndex = 0
            If Not Me.cmbCompany.SelectedIndex = -1 Then Me.cmbCompany.SelectedIndex = 0
            If IsEditMode = False Then
                Me.cmbCompany.Enabled = True
            Else
                Me.cmbCompany.Enabled = False
            End If
            Me.txtIGPNo.Text = String.Empty
            '-------------- Payment Voucher --------------
            'Me.SplitContainer1.Panel2Collapsed = True
            FillPaymentMethod()
            Me.cmbMethod.SelectedIndex = 0
            Me.cmbMethod.Enabled = True
            Me.txtChequeNo.Text = String.Empty
            Me.dtpChequeDate.Value = Date.Today
            Me.txtRecAmount.Text = String.Empty
            Me.txtVoucherNo.Text = GetVoucherNo()
            VoucherDetail(String.Empty)
            'If Not Me.cmbCompany.SelectedIndex = -1 Then Me.cmbCompany.SelectedIndex = 0
            '----------------------------------------------
            Me.dtpFrom.Value = Date.Now.AddMonths(-1)
            Me.dtpTo.Value = Date.Now
            Me.dtpFrom.Checked = False
            Me.dtpTo.Checked = False
            Me.dtpArrivalTime.Value = Date.Now
            Me.dtpDepartureTime.Value = Date.Now
            Me.dtpDepartureTime.Checked = False
            Me.txtSearchDocNo.Text = String.Empty
            'Me.cmbSearchLocation.SelectedIndex = 0
            Me.txtFromAmount.Text = String.Empty
            Me.txtToAmount.Text = String.Empty
            Me.txtPurchaseNo.Text = String.Empty
            'Me.cmbSearchAccount.Rows(0).Activate()
            Me.txtSearchRemarks.Text = String.Empty
            Me.SplitContainer2.Panel1Collapsed = True
            Me.lblPrintStatus.Text = String.Empty
            Me.cmbInvoiceType.SelectedIndex = 0
            Me.grpCurrency.Visible = True

            'Ayesha Rehman : TFS2375 : Enable Approval History button only in Eidt Mode
            If IsEditMode = True Then
                Me.btnApprovalHistory.Visible = True
                Me.btnApprovalHistory.Enabled = True
            Else
                Me.btnApprovalHistory.Visible = False
            End If
            'Ayesha Rehman : TFS2375 : End
            ''Ayesha Rehman :TFS2375 :Making Approval Button Enable in Edit Mode
            If Not getConfigValueByType("PurchaseApproval") = "Error" Then
                ApprovalProcessId = Val(getConfigValueByType("PurchaseApproval"))
            End If
            If ApprovalProcessId = 0 Then
                Me.chkPost.Visible = True
                Me.chkPost.Enabled = True

            Else
                Me.chkPost.Visible = False
                Me.chkPost.Enabled = False
                Me.chkPost.Checked = False
            End If
            ''Ayesha Rehman :TFS2375 :End

            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            If Not getConfigValueByType("PurchaseDiscountAccount") = "Error" Then
                PurchaseDiscountAccountId = CType(getConfigValueByType("PurchaseDiscountAccount"), Integer)
            End If
            'If flgCurrenyonOpenLC = True Then
            '    Me.grpCurrency.Visible = True
            '    If Not Me.cmbCurrency.SelectedIndex = -1 Then Me.cmbCurrency.SelectedIndex = 1 ''19-Dec-2013 R:945 , TaskId:2338        M Ijaz Javed           By default pack rupees
            '    Me.txtCurrencyRate.Text = 1     ''19-Dec-2013 R:945 , TaskId:2338        M Ijaz Javed           By default pack rupees
            'Else
            '    Me.grpCurrency.Visible = False
            'End If
            'Comments against task:M12
            'If flgTransaportationChargesVoucher = False Then
            '    Me.GroupBox7.Visible = False
            'Else
            '    Me.GroupBox7.Visible = True
            'End If
            'End Task:M12
            drReceivingNote = Nothing 'ReqId-970 Set Receiving Row Nothing
            ''16-Dec-2013 R934   M Ijaz Javed       Hide Buttons Edit,Delete and Print on Load Form
            Me.BtnEdit.Visible = False
            Me.BtnPrint.Visible = False
            Me.BtnDelete.Visible = False
            '''''''''''''''''''''''''''''
            Me.txtVoucherNo.Text = GetVoucherNo()
            'R:979 Set Enable/Disable Auto Loading PO Link
            If flgAutoLoadPO = True Then
                Me.lnkLoadingPO.Enabled = False
            Else
                Me.lnkLoadingPO.Enabled = True
            End If
            'End R:979
            blnUpdateAll = False
            Me.txtDueDays.Text = String.Empty ''07-Aug-2014 Task:2774 Imrna Ali Revised Invoice Based Aging Report (Ravi)
            If Not getConfigValueByType("PurchaseAccountFrontEnd").ToString = "Error" Then
                flgPurchaseAccountFrontEnd = getConfigValueByType("PurchaseAccountFrontEnd")
            End If

            'Task:2790 Purchase Account Visibility Setting
            If flgPurchaseAccountFrontEnd = False Then
                Me.lblPurchaseAccount.Visible = False
                Me.cmbPurchaseAccount.Visible = False
            Else
                Me.lblPurchaseAccount.Visible = True
                Me.cmbPurchaseAccount.Visible = True
            End If
            Me.cmbPurchaseAccount.Rows(0).Activate()
            Me.cmbCurrency.SelectedValue = BaseCurrencyId
            Me.txtCurrencyRate.Enabled = False
            'Task#05082015 Reset dicount textbox (Ahmad Sharif)
            Me.txtDisc.Text = String.Empty
            'End Task#05082015

            'End Task:2790
            Me.tbPurchaseDetail.SelectedTab = Me.tbPurchaseDetail.Tabs(0).TabPage.Tab
            Me.UltraTabControl1.SelectedTab = Me.UltraTabControl1.Tabs(0).TabPage.Tab
            'Clear Attached file records
            arrFile = New List(Of String)
            Me.btnAttachment.Text = "Attachment (" & arrFile.Count & ")"
            'Altered Against Task#2015060001 Ali Ansri
            'Array.Clear(arrFile, 0, arrFile.Length)
            Me.txtTaxDeductAmount.Text = String.Empty
            Me.txtTaxDeductPercent.Text = String.Empty
            Me.txtCurrentRate.Text = String.Empty
            Me.txtCurrentRate.Text = 0
            Me.txtDisc.Text = String.Empty
            intReceivingNoteId = 0I
            If Not frmReceivingNoteList.cmbVendor.ActiveRow Is Nothing Then
                frmReceivingNoteList.cmbVendor.Rows(0).Activate()
                frmReceivingNoteList.cmbVendor.Enabled = True
            End If
            Me.txtTransCharges.Text = 0
            Me.txtExpenseTotal.Text = 0
            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            Me.txtAdjustment.Text = 0
            ReceivingId = 0
            ShouldStockImpactGo = True
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub ClearDetailControls()
        'cmbCategory.SelectedIndex = 0
        cmbUnit.SelectedIndex = 0
        If cmbBatchNo.Rows.Count > 0 Then cmbBatchNo.Rows(0).Activate()
        txtQty.Text = ""
        txtRate.Text = ""
        Me.txtNetTotal.Text = "" ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        txtTotal.Text = ""
        txtPackQty.Text = 1
        Me.txtTax.Text = ""
        Me.txtPackRate.Text = ""
        Me.txtTotalQuantity.Text = ""
    End Sub

    Private Function Validate_AddToGrid() As Boolean
        If cmbItem.Value <= 0 Then
            msg_Error("Please select an item")
            cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        'Change by murtaza default currency rate(10/26/2022) 
        If cmbCurrency.SelectedValue <> BaseCurrencyId AndAlso Val(txtCurrencyRate.Text) = 1 Then
            msg_Error(cmbCurrency.Text + "Currency Rate cannot be 1")
            txtCurrencyRate.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        'Change by murtaza default currency rate(10/26/2022)
        'rafay task start
        'If Val(txtTax.Text) < 0 Then
        '    msg_Error("please select tax value ")
        '    txtTax.Focus() : Validate_AddToGrid = False : Exit Function
        'End If
        If txtTax.Text = "" Then
            msg_Error("please select tax value ")
            txtTax.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        'rafay task end

        If cmbCategory.SelectedValue <= 0 Then
            msg_Error("Please select a location")
            cmbCategory.Focus() : Validate_AddToGrid = False : Exit Function
        End If

        'If cmbVendor.Value > 0 AndAlso txtInvoiceNo.Text.Trim IsNot Nothing Then
        '    If IsValidateInvoiceNo(txtInvoiceNo.Text.Trim, cmbVendor.Value) = False Then
        '        Validate_AddToGrid = False : Exit Function
        '    End If
        'End If
        'If Me.cmbBatchNo.Text = String.Empty Then
        '    msg_Error("Please enter batch no")
        '    Me.cmbBatchNo.Focus() : Validate_AddToGrid = False : Exit Function
        'End If

        If Val(txtQty.Text) <= 0 Then
            msg_Error("Quantity is not greater than 0")
            txtQty.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        ''TASK-408
        If Val(Me.txtTotalQuantity.Text) <= 0 Then
            msg_Error("Total Quantity is required more than 0")
            txtTotalQuantity.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        ''END TASK-408

        ''TASK TFS4709
        If IsGRNStockImpacted = True AndAlso ReceivingId > 0 Then
            msg_Error("Record edit is not allowed against GRN")
            Validate_AddToGrid = False : Exit Function
        End If
        ''END TFS4709

        UserPriceAllowedRights = GetUserPriceAllowedRights(LoginUserId)
        If UserPriceAllowedRights = False Then
            If Convert.ToBoolean(getConfigValueByType("AllowAddZeroPriceOnPurchase").ToString.Replace("Error", "False").Replace("''", "False")) = False Then
                If Val(txtRate.Text) <= 0 Then
                    msg_Error("Rate is not greater than 0")
                    txtRate.Focus() : Validate_AddToGrid = False : Exit Function
                End If
            Else
                If Val(txtRate.Text) < 0 Then
                    msg_Error("Rate is not greater than 0")
                    txtRate.Focus() : Validate_AddToGrid = False : Exit Function
                End If
            End If
        Else
            If Val(txtRate.Text) < 0 Then
                msg_Error("Rate is not greater than 0")
                txtRate.Focus() : Validate_AddToGrid = False : Exit Function
            End If
        End If
        Validate_AddToGrid = True
    End Function
    Private Sub txtQty_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtQty.LostFocus

        'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtQty.Text) <> 0 AndAlso Val(Me.txtRate.Text) = 0 Then
        '    Me.txtRate.Text = Val(Me.txtTotal.Text) / Val(Me.txtQty.Text)
        'Else
        '    If Val(Me.txtPackQty.Text) = 0 Then
        '        txtPackQty.Text = 1
        '        txtTotal.Text = Math.Round(Val(txtQty.Text) * Val(txtRate.Text), DecimalPointInValue)
        '    Else
        '        txtTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)), DecimalPointInValue)
        '    End If
        'End If



        'If Val(Me.txtPackQty.Text) = 0 Then
        '    txtPackQty.Text = 1
        '    txtNetTotal.Text = Math.Round(Val(txtQty.Text) * Val(txtRate.Text) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
        'Else
        '    txtNetTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
        'End If

        Try
            'If IsSalesOrderAnalysis = True Then
            '    If Val(Me.txtDisc.Text) <> 0 Then
            '        Me.txtDisc.TabStop = True
            '    End If
            'End If
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
        ''''''''''''''''''''''''''''''''''''''''''''''''''
    End Sub

    Private Sub txtRate_KeyDown(sender As Object, e As KeyEventArgs) Handles txtRate.KeyDown

    End Sub

    Private Sub txtRate_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtRate.LostFocus
        Try


            'Task:2367 Change Validation

            'If Val(Me.txtRate.Text) > 0 Then
            '    If Val(Me.txtCurrentRate.Text) > 0 Then
            '        If Val(Me.txtDisc.Text) > 0 Then
            '            If Val(Me.txtCurrentRate.Text) > Val(Me.txtRate.Text) Then
            '                Me.txtDisc.Text = ((Val(Me.txtCurrentRate.Text) - Val(Me.txtRate.Text)) / Val(Me.txtCurrentRate.Text)) * 100
            '            Else
            '                Me.txtDisc.Text = 0
            '            End If
            '        End If
            '    End If
            'End If

            'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtQty.Text) = 0 Then
            '    Me.txtQty.Text = Math.Round((Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)), 2)
            'Else
            '    If Val(Me.txtPackQty.Text) = 0 Then
            '        txtPackQty.Text = 1
            '        txtTotal.Text = Math.Round(Val(txtQty.Text) * Val(txtRate.Text), DecimalPointInValue)
            '    Else
            '        txtTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)), DecimalPointInValue)
            '    End If
            'End If



            'If Val(Me.txtPackQty.Text) = 0 Then
            '    txtPackQty.Text = 1
            '    txtNetTotal.Text = Math.Round((Val(txtQty.Text) * Val(txtRate.Text)) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
            'Else
            '    txtNetTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
            'End If
            'End Task:2367

            Me.GetDetailTotal()
        Catch ex As Exception

        End Try
    End Sub
    'Private Sub txtRate_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtRate.TextChanged
    '    Try
    '        Try
    '            If Me.txtPackQty.Text.Length > 0 Then
    '                If Me.txtRate.Text.Length > 0 Then
    '                    Me.txtPackRate.Text = Val(Me.txtPackQty.Text) * Val(Me.txtRate.Text)
    '                End If
    '            End If
    '        Catch ex As Exception
    '            ShowErrorMessage(ex.Message)
    '        End Try
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Private Sub cmbUnit_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbUnit.SelectedIndexChanged
        ''get the qty in case of pack unit
        If Me.cmbUnit.Text = "Loose" Then
            txtTotal.Text = Math.Round(Val(txtQty.Text) * Val(txtRate.Text), TotalAmountRounding)
            txtPackQty.Text = 1
            Me.txtPackQty.Enabled = False
            Me.txtPackQty.TabStop = False
            Me.txtTotalQuantity.Enabled = False
            Me.txtPackRate.Enabled = False
        Else
            ''Start TFS4161
            If IsPackQtyDisabled = True Then
                Me.txtPackQty.Enabled = False
                Me.txtPackQty.TabStop = False
                Me.txtTotalQuantity.Enabled = False
                Me.txtPackRate.Enabled = False
            Else
                Me.txtPackQty.Enabled = True
                Me.txtPackQty.TabStop = True
                Me.txtTotalQuantity.Enabled = True
                Me.txtPackRate.Enabled = True
            End If
            ''End TFS4161

            'Dim objCommand As New OleDbCommand
            'Dim objCon As OleDbConnection
            'Dim objDataAdapter As New OleDbDataAdapter
            'Dim objDataSet As New DataSet

            'objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")
            'If objCon.State = ConnectionState.Open Then objCon.Close()

            'objCon.Open()
            'objCommand.Connection = objCon
            'objCommand.CommandType = CommandType.Text

            'objCommand.CommandText = "Select PackQty from ArticleDefTable where ArticleID = " & cmbItem.Value
            'txtPackQty.Text = objCommand.ExecuteScalar()
            If TypeOf Me.cmbUnit.SelectedItem Is DataRowView Then
                Me.txtPackQty.Text = Val(CType(Me.cmbUnit.SelectedItem, DataRowView).Item("PackQty").ToString)
            End If
            txtTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)), TotalAmountRounding)
        End If
        Me.txtStock.Text = Convert.ToDouble(GetStockById(Me.cmbItem.ActiveRow.Cells(0).Value, Me.cmbCategory.SelectedValue, IIf(Me.cmbUnit.Text = "Loose", "Loose", "Pack")))

    End Sub
    Public Sub GetFinalWeights()
        Try
            Me.grd.UpdateData()
            If Val(Me.grd.GetRow.Cells("Y_Gross_Weights").Value.ToString) < Val(Me.grd.GetRow.Cells("Y_Tray_Weights").Value.ToString) Then
                ShowErrorMessage("Y Gross Weights Less Then Tray Weights.")
                Exit Sub
            End If
            Me.grd.GetRow.Cells("ReceivedQty").Value = Val(Me.grd.GetRow.Cells("Y_Net_Weights").Value.ToString)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub AddItemToGrid()
        Try
            'Task against Req No 828
            'By Imran Ali 18-9-2013

            'Dim objcommand As New OleDbCommand
            'objcommand.Connection = Con
            'objcommand.CommandType = CommandType.Text
            'objcommand.CommandText = "SELECT COUNT(BatchNo) AS BatchNo  FROM PurchaseBatchTable WHERE     BatchNo = N'" & Me.cmbBatchNo.Text.Trim & "'"
            'If Con.State = ConnectionState.Closed Then Con.Open()
            'If objcommand.ExecuteScalar = 0 Then
            '    If msg_Confirm("The batch No you entered is new. " & Environment.NewLine & "Do you want to add new batch No?") Then
            '        Dim frm As New frmDefBatch
            '        frm.Source = frmDefBatch.FormSource.FromPurchase
            '        frm.uitxtBatch.Text = Me.cmbBatchNo.Text.Trim
            '        frm.dtpStart.Value = DateTime.Now
            '        frm.dtpStart.Enabled = False
            '        frm.dtpEnd.Checked = True
            '        frm.uitxtBatch.Enabled = False
            '        frm.dtpEnd.Focus()

            '        If frm.ShowDialog() <> Windows.Forms.DialogResult.OK Then Exit Sub
            '    Else
            '        Exit Sub
            '    End If
            'End If

            'grd.Rows.Add(cmbCategory.Text, cmbItem.Text, Me.cmbBatchNo.Text, cmbUnit.Text, txtQty.Text, 0, txtQty.Text, txtRate.Text, Val(txtTotal.Text), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue)
            'grd.Rows.Add(cmbCategory.Text, cmbItem.Text, Me.cmbItem.ActiveRow.Cells("Combination").Value, Me.cmbItem.ActiveRow.Cells("Size").Value, Me.cmbBatchNo.Text, cmbUnit.Text, txtQty.Text, 0, txtQty.Text, txtRate.Text, Val(txtTotal.Text), 0, cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue)
            'grd.Rows.Add(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Text, Me.cmbItem.ActiveRow.Cells("Combination").Value, Me.cmbItem.ActiveRow.Cells("Size").Value, Me.cmbBatchNo.Text, cmbUnit.Text, txtQty.Text, 0, txtQty.Text, txtRate.Text, Val(txtTotal.Text), 0, cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue)

            'Dim dt As DataTable = CType(grd.DataSource, DataTable)
            'Dim dr As DataRow

            'Dim objGridItem As DataGridView
            'Dim intLoopCounter As Integer = 0


            'Dim strCategory As New DataColumn("Category", GetType(String))
            'Dim strItem As New DataColumn("Item", GetType(String))
            'Dim strUnit As New DataColumn("Unit", GetType(String))
            'Dim intQty As New DataColumn("Qty", GetType(Integer))
            'Dim dblRate As New DataColumn("Rate", GetType(Double))
            'Dim dblTotal As New DataColumn("Total", GetType(Double))
            'Dim intCategoryID As New DataColumn("CategoryID", GetType(Integer))
            'Dim intItemID As New DataColumn("ItemID", GetType(Integer))

            'dt.Columns.Add(strCategory)
            'dt.Columns.Add(strItem)
            'dt.Columns.Add(strUnit)
            'dt.Columns.Add(intQty)
            'dt.Columns.Add(dblRate)
            'dt.Columns.Add(dblTotal)
            'dt.Columns.Add(intCategoryID)
            'dt.Columns.Add(intItemID)

            'dr = dt.NewRow
            'dr("Category") = cmbCategory.SelectedText
            'dr("Item") = cmbItem.SelectedText
            'dr("Unit") = cmbUnit.SelectedText
            'dr("Qty") = txtQty.Text
            'dr("Rate") = txtRate.Text
            'dr("Total") = Val(txtTotal.Text)
            ''        dr("CategoryID") = cmbCategory.SelectedValue
            ''        dr("ItemID") = cmbItem.SelectedValue

            'dt.Rows.Add(dr)
            'grd.DataSource = dt
            Dim dtGrd As DataTable
            Dim rateSeparate As String
            dtGrd = CType(Me.grd.DataSource, DataTable)
            dtGrd.AcceptChanges()
            Dim drGrd As DataRow
            drGrd = dtGrd.NewRow
            'drGrd.Item(grdEnm.Category) = Me.cmbCategory.Text
            drGrd.Item(grdEnm.LocationId) = Me.cmbCategory.SelectedValue
            drGrd.Item(grdEnm.ArticleCode) = Me.cmbItem.ActiveRow.Cells("Code").Text.ToString
            drGrd.Item(grdEnm.Item) = Me.cmbItem.ActiveRow.Cells("Item").Text.ToString
            drGrd.Item(grdEnm.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Text.ToString
            drGrd.Item(grdEnm.Size) = Me.cmbItem.ActiveRow.Cells("Size").Text.ToString
            drGrd.Item(grdEnm.Uom) = Me.cmbItem.ActiveRow.Cells("Unit").Text.ToString 'Task:2407 Added Field Of Uom
            drGrd.Item(grdEnm.BatchNo) = String.Empty 'Me.cmbBatchNo.Text ''TFS1596
            drGrd.Item(grdEnm.Unit) = IIf(Me.cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString)
            drGrd.Item(grdEnm.PackQty) = Val(Me.txtPackQty.Text)
            drGrd.Item(grdEnm.ReceivedQty) = Convert.ToDecimal(Me.txtQty.Text)
            drGrd.Item(grdEnm.RejectedQty) = Convert.ToDecimal(0)
            drGrd.Item(grdEnm.Qty) = Convert.ToDecimal(0) 'Val(Me.txtQty.Text)
            drGrd.Item(grdEnm.GrossQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
            drGrd.Item(grdEnm.Column1) = Convert.ToDecimal(0)
            drGrd.Item(grdEnm.Column1) = Convert.ToDecimal(0)
            drGrd.Item(grdEnm.Column1) = Convert.ToDecimal(0) 'Val(Me.txtQty.Text)
            drGrd.Item(grdEnm.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text) ''TASK-408
            drGrd.Item(grdEnm.Deduction) = 0
            drGrd.Item(grdEnm.VendorQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
            drGrd.Item(grdEnm.VendorNetQty) = 0

            drGrd.Item(grdEnm.Price) = Val(Me.txtRate.Text)
            '' Before 27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
            'drGrd.Item(grdEnm.Total) = Val(Me.txtTotal.Text)
            ' After
            drGrd.Item(grdEnm.Total) = Val(Me.txtNetTotal.Text)
            drGrd.Item(grdEnm.ItemWiseDisc) = Val(Me.txtDisc.Text)      'Task#05082015 add item to grid
            '''''''''''''''''''''''''''''''''''''''
            drGrd.Item(grdEnm.Transportation_Charges) = 0
            drGrd.Item(grdEnm.Custom_Charges) = 0
            drGrd.Item(grdEnm.Discount_Price) = 0 'Set Value in Discount Price Column
            drGrd.Item(grdEnm.ArticleGroupId) = Me.cmbCategory.SelectedValue
            drGrd.Item(grdEnm.ArticleDefId) = Me.cmbItem.ActiveRow.Cells(0).Value
            drGrd.Item(grdEnm.PackPrice) = Val(Me.txtPackRate.Text)
            drGrd.Item(grdEnm.CurrentPrice) = Val(Me.txtCurrentRate.Text) 'Val(Me.cmbItem.ActiveRow.Cells("Price").Text)
            drGrd.Item(grdEnm.RateDiscPercent) = Val(Me.txtDisc.Text)
            drGrd.Item(grdEnm.PackPrice) = Val(Me.txtPackRate.Text)
            drGrd.Item(grdEnm.BatchId) = 0 'Me.cmbBatchNo.Value
            drGrd.Item(grdEnm.ExpiryDate) = Convert.ToDateTime(Date.Now.AddMonths(1))
            drGrd.Item(grdEnm.TaxPercent) = Val(Me.txtTax.Text)
            drGrd.Item(grdEnm.Comments) = String.Empty
            drGrd.Item(grdEnm.Pack_Desc) = Me.cmbUnit.Text.ToString
            drGrd.Item(grdEnm.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
            drGrd.Item(grdEnm.X_Tray_Weights) = 0
            drGrd.Item(grdEnm.X_Gross_Weights) = 0
            'drGrd.Item(grdEnm.X_Net_Weights) = 0
            drGrd.Item(grdEnm.Y_Tray_Weights) = 0
            drGrd.Item(grdEnm.Y_Gross_Weights) = 0
            'drGrd.Item(grdEnm.TotalQty) = Val(Me.txtTotalQuantity.Text) ''TASK-408
            ' drGrd.Item(grdEnm.Y_Net_Weights) = 0
            drGrd.Item(grdEnm.CurrencyId) = Me.cmbCurrency.SelectedValue
            If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                drGrd.Item(grdEnm.CurrencyAmount) = Val(1)
            Else
                drGrd.Item(grdEnm.CurrencyAmount) = Val(Me.txtTotalQuantity.Text) * Val(Me.txtRate.Text)
            End If
            drGrd.Item(grdEnm.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
            Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
            If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                drGrd.Item(grdEnm.BaseCurrencyId) = Val(ConfigCurrencyVal)
                drGrd.Item(grdEnm.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
            End If
            drGrd.Item(grdEnm.ReceivingNoteId) = 0

            'Task 3913 Saad Afzaal change InsertAt to Add function to maintain sequence of items which add in the grid
            dtGrd.Rows.Add(drGrd)
            'Task 3913 Saad Afzaal move scroll bar at the end when item added into the grid 
            grd.MoveLast()
            'dtGrd.Rows.InsertAt(drGrd, 0)
            'txtDiscount_LostFocus(Nothing, Nothing)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    ''' <summary>
    ''' A new function is made to add items in grid From Item Search Screen
    ''' </summary>
    ''' <remarks>TFS3762 : Ayesha Rehman : 12-07-2018</remarks>
    Public Sub AddItemToGridFromItemSearch()
        Try
            FillCombo("Item")
            cmbItem.Value = frmItemSearch.ArticleId
            txtQty.Text = frmItemSearch.Qty
            Me.txtPackQty.Text = frmItemSearch.PackQty
            'Ali Faisal : TFS4271 : Total qty add from item search popup
            Me.txtTotalQuantity.Text = frmItemSearch.TotalQty
            txtRate.Text = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString ''TFS3762
            cmbUnit.SelectedIndex = IIf(frmItemSearch.PackName <> "Loose", 1, 0) ''TFS3762
            Dim dtGrd As DataTable
            dtGrd = CType(Me.grd.DataSource, DataTable)
            dtGrd.AcceptChanges()
            Dim drGrd As DataRow
            drGrd = dtGrd.NewRow
            'drGrd.Item(grdEnm.Category) = Me.cmbCategory.Text
            drGrd.Item(grdEnm.LocationId) = Me.cmbCategory.SelectedValue
            drGrd.Item(grdEnm.ArticleCode) = Me.cmbItem.ActiveRow.Cells("Code").Text.ToString
            drGrd.Item(grdEnm.Item) = Me.cmbItem.ActiveRow.Cells("Item").Text.ToString
            drGrd.Item(grdEnm.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Text.ToString
            drGrd.Item(grdEnm.Size) = Me.cmbItem.ActiveRow.Cells("Size").Text.ToString
            drGrd.Item(grdEnm.Uom) = Me.cmbItem.ActiveRow.Cells("Unit").Text.ToString 'Task:2407 Added Field Of Uom
            drGrd.Item(grdEnm.BatchNo) = String.Empty 'Me.cmbBatchNo.Text ''TFS1596
            drGrd.Item(grdEnm.Unit) = IIf(Me.cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString)
            drGrd.Item(grdEnm.PackQty) = Val(Me.txtPackQty.Text)
            drGrd.Item(grdEnm.ReceivedQty) = Convert.ToDecimal(Me.txtQty.Text)
            drGrd.Item(grdEnm.RejectedQty) = Convert.ToDecimal(0)
            drGrd.Item(grdEnm.Qty) = Convert.ToDecimal(0) 'Val(Me.txtQty.Text)
            drGrd.Item(grdEnm.GrossQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
            drGrd.Item(grdEnm.Column1) = Convert.ToDecimal(0)
            drGrd.Item(grdEnm.Column1) = Convert.ToDecimal(0)
            drGrd.Item(grdEnm.Column1) = Convert.ToDecimal(0) 'Val(Me.txtQty.Text)
            drGrd.Item(grdEnm.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text) ''TASK-408
            drGrd.Item(grdEnm.Deduction) = 0
            drGrd.Item(grdEnm.VendorQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
            drGrd.Item(grdEnm.VendorNetQty) = 0

            drGrd.Item(grdEnm.Price) = Val(Me.txtRate.Text)
            '' Before 27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
            'drGrd.Item(grdEnm.Total) = Val(Me.txtTotal.Text)
            ' After
            drGrd.Item(grdEnm.Total) = Val(Me.txtNetTotal.Text)
            drGrd.Item(grdEnm.ItemWiseDisc) = Val(Me.txtDisc.Text)      'Task#05082015 add item to grid
            '''''''''''''''''''''''''''''''''''''''
            drGrd.Item(grdEnm.Transportation_Charges) = 0
            drGrd.Item(grdEnm.Custom_Charges) = 0
            drGrd.Item(grdEnm.Discount_Price) = 0 'Set Value in Discount Price Column
            drGrd.Item(grdEnm.ArticleGroupId) = Me.cmbCategory.SelectedValue
            drGrd.Item(grdEnm.ArticleDefId) = Me.cmbItem.ActiveRow.Cells(0).Value
            drGrd.Item(grdEnm.PackPrice) = Val(Me.txtPackRate.Text)
            drGrd.Item(grdEnm.CurrentPrice) = Val(Me.txtCurrentRate.Text) 'Val(Me.cmbItem.ActiveRow.Cells("Price").Text)
            drGrd.Item(grdEnm.RateDiscPercent) = Val(Me.txtDisc.Text)
            drGrd.Item(grdEnm.PackPrice) = Val(Me.txtPackRate.Text)
            drGrd.Item(grdEnm.BatchId) = 0 'Me.cmbBatchNo.Value
            drGrd.Item(grdEnm.ExpiryDate) = Convert.ToDateTime(Date.Now.AddMonths(1))
            drGrd.Item(grdEnm.TaxPercent) = Val(Me.txtTax.Text)
            drGrd.Item(grdEnm.Comments) = String.Empty
            drGrd.Item(grdEnm.Pack_Desc) = Me.cmbUnit.Text.ToString
            drGrd.Item(grdEnm.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
            drGrd.Item(grdEnm.X_Tray_Weights) = 0
            drGrd.Item(grdEnm.X_Gross_Weights) = 0
            'drGrd.Item(grdEnm.X_Net_Weights) = 0
            drGrd.Item(grdEnm.Y_Tray_Weights) = 0
            drGrd.Item(grdEnm.Y_Gross_Weights) = 0
            'drGrd.Item(grdEnm.TotalQty) = Val(Me.txtTotalQuantity.Text) ''TASK-408
            ' drGrd.Item(grdEnm.Y_Net_Weights) = 0
            drGrd.Item(grdEnm.CurrencyId) = Me.cmbCurrency.SelectedValue
            If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                drGrd.Item(grdEnm.CurrencyAmount) = Val(1)
            Else
                drGrd.Item(grdEnm.CurrencyAmount) = Math.Round(Val(Me.txtTotalQuantity.Text) * Val(Me.txtRate.Text), TotalAmountRounding)
            End If
            drGrd.Item(grdEnm.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
            Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
            If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                drGrd.Item(grdEnm.BaseCurrencyId) = Val(ConfigCurrencyVal)
                drGrd.Item(grdEnm.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
            End If
            drGrd.Item(grdEnm.ReceivingNoteId) = 0
            'Task 3913 Saad Afzaal change InsertAt to Add function to maintain sequence of items which add in the grid
            dtGrd.Rows.Add(drGrd)
            'Task 3913 Saad Afzaal move scroll bar at the end when item added into the grid 
            grd.MoveLast()
            'dtGrd.Rows.InsertAt(drGrd, 0)
            'txtDiscount_LostFocus(Nothing, Nothing)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub cmbCategory_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbCategory.SelectedIndexChanged
        'If cmbCategory.SelectedIndex > 0 Then

        '    FillCombo("ItemFilter")
        'End If
        'Start TFS1610:18-OCT-2017:Rai Haider : Stock In Item List According to location selected in location dropdown
        'On Change of location item dropdown fill again
        Try
            Dim id As Integer
            id = 0
            id = Me.cmbItem.Value
            FillCombo("Item")
            Me.cmbItem.Value = id
            'End Task: TFS1610
            If IsFormLoaded = True Then
                If getConfigValueByType("ArticleFilterByLocation") = "True" Then
                    FillCombo("Item")
                End If
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub GetTotal()
    '    Dim i As Integer
    '    Dim dblTotalAmount As Double
    '    Dim dblTotalQty As Double
    '    Dim dblPurchaseTax As Double
    '    For i = 0 To grd.Rows.Count - 1
    '        dblTotalAmount = dblTotalAmount + Val(grd.Rows(i).Cells("total").Value)
    '        dblTotalQty = dblTotalQty + Val(grd.Rows(i).Cells("Qty").Value)
    '        dblPurchaseTax = dblPurchaseTax + ((Val(grd.Rows(i).Cells("Total").Value) * Val(grd.Rows(i).Cells("TaxPercent").Value)) / 100)
    '    Next
    '    txtAmount.Text = dblTotalAmount
    '    txtTotalQty.Text = dblTotalQty
    '    txtBalance.Text = Val(txtAmount.Text) - Val(txtPaid.Text)
    '    Me.txtPercent.Text = dblPurchaseTax
    '    Me.lblRecordCount.Text = "Total Records: " & Me.grd.RowCount
    'End Sub
    ''ReqId-915 Added field of accountid in Item query
    'TFS1610:18-OCT-2017:Rai Haider :Filter Stock In Item List According to location selected in location dropdown
    Private Sub FillCombo(ByVal strCondition As String)
        Dim str As String
        Dim strVendorWiseItemSecurity As String = getConfigValueByType("PurchaseItemsVendorsWise").ToString
        If strCondition = "Item" Or strCondition = "ItemFilter" Then
            'str = "SELECT DISTINCT ArticleDefView.ArticleId as Id, ArticleCode as Code, ArticleDescription as Item,  ArticleSizeName as Size, ArticleColorName as Combination, ArticleUnitName as Unit, ISNULL(PurchasePrice,0) as Price,  ArticleDefView.SizeRangeID as [Size ID], Location.Ranks as Rake, Isnull(ArticleDefView.SubSubId,0) as AccountId, ArticleDefView.SortOrder  FROM ArticleDefView LEFT OUTER JOIN (Select ArticalID, Ranks From ArticalDefLocation WHERE Ranks <> '' AND Ranks IS NOT NULL) Location  ON Location.ArticalID = ArticleDefView.MasterId where Active=1"
            str = "SELECT DISTINCT ArticleDefView.ArticleId as Id, ArticleCode as Code, ArticleDescription as Item,  ArticleSizeName as Size, ArticleColorName as Combination, ArticleModel.Name As Model, ArticleUnitName as Unit, ISNULL(PurchasePrice,0) as Price, Isnull(StockDetail.Stock,0) as Stock, ArticleDefView.ArticleCompanyName as Category,ArticleDefView.ArticleLpoName as Model ,ArticleDefView.ArticleBrandName As Grade, ArticleDefView.SizeRangeID as [Size ID], Location.Ranks as Rake, Isnull(ArticleDefView.SubSubId,0) as AccountId, ArticleDefView.SortOrder, ArticleDefView.MasterId  FROM ArticleDefView LEFT OUTER JOIN (Select ArticalID, Ranks From ArticalDefLocation WHERE Ranks <> '' AND Ranks IS NOT NULL) Location  ON Location.ArticalID = ArticleDefView.MasterId LEFT JOIN (Select ArticleDefId, Sum(IsNull(InQty, 0)-IsNull(OutQty, 0)) As Stock From StockDetailTable " & IIf(Me.cmbCategory.SelectedIndex <> -1, " WHERE LocationId=" & Me.cmbCategory.SelectedValue & "", "") & " Group By ArticleDefId) As StockDetail ON ArticleDefView.ArticleId = StockDetail.ArticleDefId Left Outer Join (Select ArticleId, ArticleModelList.ModelId, tblDefModelList.Name From ArticleModelList Inner Join tblDefModelList ON  ArticleModelList.ModelId = tblDefModelList.ModelId) As ArticleModel On  ArticleDefView.ArticleId=ArticleModel.ArticleId where ArticleDefView.Active=1"
            ''Start TFS3762 : Not Adding filters in Case Configuration "AddItemForMall" = true
            If flgAddItemForMall = False Then
                If flgCompanyRights = True Then
                    str += " AND ArticleDefView.CompanyId=" & MyCompanyId
                End If
                If getConfigValueByType("ArticleFilterByLocation") = "True" Then
                    If GetRestrictedItemFlg(Me.cmbCategory.SelectedValue) = True Then
                        str += " AND ArticleDefView.ArticleId In (Select ArticleDefId From RestrictedItemByLocationTable WHERE LocationId=" & Me.cmbCategory.SelectedValue & " AND Restricted=1)"
                        'Else
                        '    str += str
                    End If
                End If
                If Me.rbtVendor.Checked = True Then
                    str = str + " AND ArticleDefView.MasterId In (Select ArticleDefId From ArticleDefVendors WHERE VendorId=" & Me.cmbVendor.Value & ") "
                End If
            End If
            'str += " ORDER BY ArticleDefView.SortOrder Asc"
            ''03-Mar-2014  Task:2452    Imran Ali  4-ALPHABETIC order of items in sale and purchase window
            If ItemSortOrder = True Then
                str += " ORDER BY ArticleDefView.SortOrder " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            ElseIf ItemSortOrderByCode = True Then
                str += " ORDER BY ArticleDefView.ArticleCode " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            ElseIf ItemSortOrderByName = True Then
                str += " ORDER BY ArticleDefView.ArticleDescription " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            Else
                str += " ORDER BY ArticleDefView.SortOrder " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            End If
            'End Task:2452
            'FillDropDown(cmbItem, str)
            FillUltraDropDown(Me.cmbItem, str)
            Me.cmbItem.Rows(0).Activate()
            If Me.cmbItem.DisplayLayout.Bands(0).Columns.Count > 0 Then
                Me.cmbItem.DisplayLayout.Bands(0).Columns("Id").Hidden = True
                Me.cmbItem.DisplayLayout.Bands(0).Columns("Size ID").Hidden = True
                Me.cmbItem.DisplayLayout.Bands(0).Columns("AccountId").Hidden = True
                Me.cmbItem.DisplayLayout.Bands(0).Columns("SortOrder").Hidden = True
                Me.cmbItem.DisplayLayout.Bands(0).Columns("MasterId").Hidden = True
                If ItemFilterByName = True Then
                    Me.RbtByName.Checked = True
                    Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(2).Column.Key.ToString
                Else
                    If Me.RbtByCode.Checked = True Then
                        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(1).Column.Key.ToString
                    Else
                        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(2).Column.Key.ToString
                    End If
                End If
            End If

        ElseIf strCondition = "Category" Then
            'Task#16092015 Load user wise locations
            'If getConfigValueByType("UserwiseLocation").ToString = "True" Then
            '    str = "Select Location_Id, Location_Code from tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") order by sort_order"
            'Else
            '    str = "Select Location_Id, Location_Code from tblDefLocation order by sort_order"
            'End If

            str = "If  exists(select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") " _
                   & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock, IsNull(comments,'') AS comments from tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") order by sort_order " _
                   & " Else " _
                   & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock, IsNull(comments,'') AS comments from tblDefLocation order by sort_order"

            FillDropDown(cmbCategory, str, False)

        ElseIf strCondition = "SearchLocation" Then
            str = "Select Location_Id, Location_Code from tblDefLocation order by sort_order"
            FillDropDown(Me.cmbSearchLocation, str, True)

            'str = "Select ArticleGroupID, ArticleGroupName from ArticleGroupDefTable where Active=1"
            'FillDropDown(cmbCategory, str)

        ElseIf strCondition = "ItemFilter1" Then
            str = "SELECT  ArticleId as Id, ArticleDescription Item, ArticleCode Code, ArticleSizeName as Size, ArticleColorName as Combination, ArticleUnitName as Unit, PurchasePrice as Price , ArticleDefView.SizeRangeID as [Size ID], Isnull(ArticleDefView.SubSubId,0) as AccountId, ArticleDefView.MasterId FROM         ArticleDefView where Active=1 and ArticleGroupID = " & cmbCategory.SelectedValue
            FillUltraDropDown(cmbItem, str)
            Me.cmbItem.Rows(0).Activate()
            Me.cmbItem.DisplayLayout.Bands(0).Columns("Size ID").Hidden = True
            Me.cmbItem.DisplayLayout.Bands(0).Columns("AccountId").Hidden = True
            Me.cmbItem.DisplayLayout.Bands(0).Columns("MasterId").Hidden = True
        ElseIf strCondition = "Vendor" Then
            'str = "SELECT     tblCustomer.AccountId AS ID, tblCustomer.CustomerName AS Name, tblListTerritory.TerritoryName AS Territory, tblListCity.CityName AS City,  " & _
            '        "tblListState.StateName AS State, tblCustomer.AccountId AS AcId " & _
            '        "FROM         tblListTerritory INNER JOIN " & _
            '        "tblListCity ON tblListTerritory.CityId = tblListCity.CityId INNER JOIN " & _
            '        "tblListState ON tblListCity.StateId = tblListState.StateId INNER JOIN " & _
            '        "tblCustomer ON tblListTerritory.TerritoryId = tblCustomer.Territory"
            If getConfigValueByType("Show Customer On Purchase") = "True" Then
                'Before against task:2373
                'str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name, dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
                '                    "dbo.tblListTerritory.TerritoryName as Territory,dbo.vwCOADetail.account_type as Type, tblVendor.Email, tblVendor.Phone " & _
                '                    "FROM         dbo.tblVendor INNER JOIN " & _
                '                    "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
                '                    "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
                '                    "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
                '                    "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
                '                    "WHERE     (dbo.vwCOADetail.account_type in ('Vendor','Customer')) "
                'Task:2373 Added Column Sub Sub Title
                str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name, dbo.vwCOADetail.detail_code as [Code], dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
                                  "dbo.tblListTerritory.TerritoryName as Territory,dbo.vwCOADetail.account_type as Type, dbo.vwCOADetail.Contact_Email as Email,dbo.vwCOADetail.Contact_Phone as Phone, dbo.vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title " & _
                                  "FROM         dbo.tblVendor INNER JOIN " & _
                                  "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
                                  "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
                                  "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
                                  "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
                                  "WHERE     (dbo.vwCOADetail.account_type in ('Vendor','Customer')) "
                'End Task:2373
                If flgCompanyRights = True Then
                    str += " AND vwCOADetail.CompanyId=" & MyCompanyId
                End If
            Else
                'Before against task:2373
                'str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name, dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
                '                                 "dbo.tblListTerritory.TerritoryName as Territory,dbo.vwCOADetail.account_type as Type,tblVendor.Email, tblVendor.Phone " & _
                '                                 "FROM dbo.tblVendor INNER JOIN " & _
                '                                 "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
                '                                 "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
                '                                 "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
                '                                 "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
                '                                 "WHERE     (dbo.vwCOADetail.account_type ='Vendor') "
                'Task:2373 Added Column Sub Sub Title
                str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name, dbo.vwCOADetail.detail_code as [Code], dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
                                                 "dbo.tblListTerritory.TerritoryName as Territory,dbo.vwCOADetail.account_type as Type,dbo.vwCOADetail.Contact_Email as Email,dbo.vwCOADetail.Contact_Phone as Phone, dbo.vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title " & _
                                                 "FROM dbo.tblVendor INNER JOIN " & _
                                                 "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
                                                 "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
                                                 "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
                                                 "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
                                                 "WHERE     (dbo.vwCOADetail.account_type ='Vendor') "
                'End Task:2373
                If flgCompanyRights = True Then
                    str += " AND vwCOADetail.CompanyId=" & MyCompanyId
                End If
            End If
            ''Start TFS3322 : Ayesha Rehman : 15-05-2018
            'If LoginGroup = "Administrator" Then
            'ElseIf GetMappedUserId() > 0 And getGroupAccountsConfigforPurchase(Me.Name) Then
            If GetMappedUserId() > 0 And getGroupAccountsConfigforPurchase(Me.Name) And LoginGroup <> "Administrator" Then ''TFS4689
                str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name, dbo.vwCOADetail.detail_code as [Code], dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
                                                "dbo.tblListTerritory.TerritoryName as Territory,dbo.vwCOADetail.account_type as Type,dbo.vwCOADetail.Contact_Email as Email,dbo.vwCOADetail.Contact_Phone as Phone, dbo.vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title " & _
                                                "FROM dbo.tblVendor INNER JOIN " & _
                                                "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
                                                "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
                                                "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
                                                "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
                                                "WHERE  (dbo.vwCOADetail.detail_title Is Not NULL ) "
                str += " And (coa_detail_id in (Select COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 3) and COAUserMapping.[User_Id]= " & LoginGroupId & " ) " _
                       & " or main_sub_sub_id in (SELECT COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 2) and COAUserMapping.[User_Id]= " & LoginGroupId & " ) " _
                       & " or main_sub_id in (SELECT COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 1) and COAUserMapping.[User_Id]= " & LoginGroupId & " ) " _
                       & " or coa_main_id in (SELECT   COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 0) and COAUserMapping.[User_Id]= " & LoginGroupId & ") )"
                ''Start TFS4689 :  Ayesha Rehman : 02-10-2018
                If getConfigValueByType("Show Customer On Purchase") = "True" Then
                    str += " And vwCOADetail.account_type in ('Customer' , 'Vendor') "
                Else
                    str += " And vwCOADetail.account_type = 'Vendor' "
                End If
                ''End TFS4689
            End If
            ''End TFS3322
            If IsEditMode = False Then
                str += " AND vwCOADetail.Active=1"
            Else
                str += " AND vwCOADetail.Active in (0,1,NULL)"
            End If
            str += " order by tblVendor.Sortorder, vwCOADetail.detail_title "
            FillUltraDropDown(cmbVendor, str)
            If Me.cmbVendor.DisplayLayout.Bands.Count > 0 Then
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(0).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns("Email").Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns("Sub_Sub_Title").Header.Caption = "Ac Head" 'Task:2373 Change Caption
            End If
        ElseIf strCondition = "TransportationVendor" Then
            'If getConfigValueByType("Show Customer On Purchase") = "True" Then
            '    str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name, dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
            '                        "dbo.tblListTerritory.TerritoryName as Territory,dbo.vwCOADetail.account_type as Type, tblVendor.Email, tblVendor.Phone " & _
            '                        "FROM         dbo.tblVendor INNER JOIN " & _
            '                        "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
            '                        "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
            '                        "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
            '                        "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
            '                        "WHERE     (dbo.vwCOADetail.account_type in ('Vendor','Customer')) "
            '    If flgCompanyRights = True Then
            '        str += " AND vwCOADetail.CompanyId=" & MyCompanyId
            '    End If
            'Else
            '    str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name, dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
            '                                     "dbo.tblListTerritory.TerritoryName as Territory,dbo.vwCOADetail.account_type as Type,tblVendor.Email, tblVendor.Phone " & _
            '                                     "FROM dbo.tblVendor INNER JOIN " & _
            '                                     "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
            '                                     "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
            '                                     "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
            '                                     "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
            '                                     "WHERE     (dbo.vwCOADetail.account_type ='Vendor') "
            '    If flgCompanyRights = True Then
            '        str += " AND vwCOADetail.CompanyId=" & MyCompanyId
            '    End If
            'End If
            'If IsEditMode = False Then
            '    str += " AND vwCOADetail.Active=1"
            'Else
            '    str += " AND vwCOADetail.Active in (0,1,NULL)"
            'End If
            ''If Me.cmbVendor.IsItemInList = True Then
            ''    str += " AND vwCOADetail.coa_detail_id <> " & Me.cmbVendor.Value & ""
            ''End If
            'str += " order by tblVendor.Sortorder, vwCOADetail.detail_title "
            'FillUltraDropDown(Me.cmbTransportationVendor, str)
            'If Me.cmbTransportationVendor.DisplayLayout.Bands.Count > 0 Then
            '    Me.cmbTransportationVendor.DisplayLayout.Bands(0).Columns(0).Hidden = True
            '    Me.cmbTransportationVendor.DisplayLayout.Bands(0).Columns("Email").Hidden = True
            'End If

            'chaning against request no 829 by imran ali set query for transporter
            str = "Select ISNULL([AccountId],0) as AccountId, [TransporterName],[TransporterId] From tblDefTransporter where Active=1 and Custom=0"
            FillUltraDropDown(Me.cmbTransportationVendor, str)
            If Me.cmbTransportationVendor.DisplayLayout.Bands.Count > 0 Then
                Me.cmbTransportationVendor.DisplayLayout.Bands(0).Columns("TransporterId").Hidden = True
                Me.cmbTransportationVendor.DisplayLayout.Bands(0).Columns("AccountId").Hidden = True
                Me.cmbTransportationVendor.DisplayLayout.Bands(0).Columns("TransporterName").Width = 150
            End If
            Me.cmbTransportationVendor.Rows(0).Activate()
        ElseIf strCondition = "CustomVendor" Then
            str = "Select ISNULL([AccountId],0) as AccountId, [TransporterName],[TransporterId] From tblDefTransporter where Active=1 and Custom=1"
            FillUltraDropDown(Me.cmbCustomVendor, str)
            If Me.cmbCustomVendor.DisplayLayout.Bands.Count > 0 Then
                Me.cmbCustomVendor.DisplayLayout.Bands(0).Columns("TransporterId").Hidden = True
                Me.cmbCustomVendor.DisplayLayout.Bands(0).Columns("AccountId").Hidden = True
                Me.cmbCustomVendor.DisplayLayout.Bands(0).Columns("TransporterName").Width = 150
            End If
            Me.cmbCustomVendor.Rows(0).Activate()
        ElseIf strCondition = "SearchVendor" Then
            str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name,dbo.vwCOADetail.detail_code as [Code], dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
                                           "dbo.tblListTerritory.TerritoryName as Territory, dbo.vwCOADetail.Contact_Email as Email, dbo.vwCOADetail.Contact_Phone as Phone, dbo.vwCOADetail.Contact_Mobile as Mobile " & _
                                           "FROM  dbo.tblVendor INNER JOIN " & _
                                           "dbo.tblListTerritory ON dbo.tblVendor.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
                                           "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
                                           "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
                                           "dbo.vwCOADetail ON dbo.tblVendor.AccountId = dbo.vwCOADetail.coa_detail_id " & _
                                           "WHERE  (dbo.vwCOADetail.account_type = 'Vendor') AND dbo.vwCOADetail.detail_title Is Not NULL "
            If flgCompanyRights = True Then
                str += " AND vwCOADetail.CompanyId=" & MyCompanyId
            End If
            str += " order by tblVendor.Sortorder, vwCOADetail.detail_title"
            FillUltraDropDown(cmbSearchAccount, str)
            If Me.cmbSearchAccount.DisplayLayout.Bands.Count > 0 Then
                Me.cmbSearchAccount.DisplayLayout.Bands(0).Columns(0).Hidden = True
                Me.cmbSearchAccount.DisplayLayout.Bands(0).Columns("Email").Hidden = True
            End If
        ElseIf strCondition = "SO" Then
            'str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 113) as PurchaseOrderNo, DcNo,Remarks from PurchaseOrderMasterTable where PurchaseorderId not in(select PurchaseOrderId from ReceivingMasterTable)"
            'str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 102) as PurchaseOrderNo, DcNo,Remarks, IsNull(RefCMFADocId,0) as RefCMFADocId from PurchaseOrderMasterTable where VendorId=" & Me.cmbVendor.Value & " AND Status='Open'"
            'PurchaseorderId not in(select PurchaseOrderId from ReceivingMasterTable)"
            'TASK15 Filter Posted Purchase Order
            'str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 102) as PurchaseOrderNo, DcNo,Remarks, IsNull(RefCMFADocId,0) as RefCMFADocId from PurchaseOrderMasterTable where VendorId=" & Me.cmbVendor.Value & " AND Status='Open' AND IsNull(Post,0)=1  Order By PurchaseOrderID DESC"
            'End TASK15
            str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 102) as PurchaseOrderNo, DcNo,Remarks,CurrencyType, CurrencyRate, IsNull(RefCMFADocId,0) as RefCMFADocId, IsNull(CostCenterId, 0) As CostCenterId from PurchaseOrderMasterTable where VendorId=" & Me.cmbVendor.Value & " AND Status='Open' AND IsNull(Post,0)=1  Order By PurchaseOrderID DESC"
            Me.cmbPo.DataSource = Nothing
            FillDropDown(cmbPo, str)
            'ElseIf strCondition = "Batch" Then
            '    str = "Select BatchID, BatchNo from PurchaseBatchTable order by SortOrder "
            '    FillDropDown(Me.cmbBatch, str)
        ElseIf strCondition = "SOSpecific" Then
            'Before against request no. M6
            'str = "Select PurchaseOrderID, PurchaseOrderNo, DcNo,Remarks from PurchaseOrderMasterTable where PurchaseorderId not in(select PurchaseOrderId from ReceivingMasterTable) and vendorid=" & Me.cmbVendor.Value & ""
            'R:M6 Filter By Post
            str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 102) as PurchaseOrderNo, DcNo,Remarks,CurrencyType, CurrencyRate, IsNull(RefCMFADocId,0) as RefCMFADocId, IsNull(CostCenterId, 0) As CostCenterId from PurchaseOrderMasterTable where PurchaseorderId not in(select PurchaseOrderId from ReceivingMasterTable) and vendorid=" & Me.cmbVendor.Value & " AND IsNull(Post,0)=1 Order By PurchaseOrderID DESC"
            'End R:M6
            FillDropDown(cmbPo, str)

        ElseIf strCondition = "SOComplete" Then
            'Before against request no. M6
            'str = "Select PurchaseOrderID, PurchaseOrderNo, DcNo,Remarks  from PurchaseOrderMasterTable "
            'R:M6 Filter By Post
            str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 102) as PurchaseOrderNo, DcNo,Remarks,CurrencyType, CurrencyRate, IsNull(RefCMFADocId,0) as RefCMFADocId, IsNull(CostCenterId, 0) As CostCenterId  from PurchaseOrderMasterTable WHERE Post=1"
            'End R:M6
            FillDropDown(cmbPo, str)
        ElseIf strCondition = "SM" Then
            str = "Select Employee_ID, Employee_Name  + ' - ' + employee_Code as EmployeeName from tblDefEmployee Where Active = 1" ''TASKTFS75 added and set active =1
            FillDropDown(Me.cmbSalesMan, str)
        ElseIf strCondition = "grdLocation" Then
            'Task#16092015 Load user wise locations
            'If getConfigValueByType("UserwiseLocation").ToString = "True" Then
            '    str = "Select Location_Id, Location_Name From tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ")"
            'Else
            '    str = "Select Location_Id, Location_Name From tblDefLocation"
            'End If

            str = "If  exists(select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") " _
                   & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") order by sort_order " _
                   & " Else " _
                   & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation order by sort_order"

            Dim dt As DataTable = GetDataTable(str)
            Me.grd.RootTable.Columns(grdEnm.LocationId).ValueList.PopulateValueList(dt.DefaultView, "Location_Id", "Location_Code")
        ElseIf strCondition = "GrdOrigin" Then
            str = "select CountryName, CountryName From tblListCountry Where Active = 1"
            Dim dtCountry As DataTable = GetDataTable(str)
            dtCountry.AcceptChanges()
            Me.grd.RootTable.Columns("Origin").ValueList.PopulateValueList(dtCountry.DefaultView, "CountryName", "CountryName")
        ElseIf strCondition = "CostCenter" Then
            'str = "If  exists(select CostCentre_Id FROM tblUserCostCentreRights where UserID = " & LoginUserId & " and ISNULL(CostCentre_Id, 0) > 0) " _
            '        & "Select CostCenterID, Name from tblDefCostCenter where CostCenterID in (select CostCentre_Id FROM tblUserCostCentreRights where UserID = " & LoginUserId & ") order by SortOrder " _
            '        & "Else " _
            '        & "Select CostCenterID, Name from tblDefCostCenter where Active = 1 order by SortOrder"
            str = "select * from tblDefCostCenter where  (ISNULL(SOBudget,0) = 1 AND ISNULL(SalaryBudget,0) = 0 AND ISNULL(DepartmentBudget,0) = 0 AND Active = 1) OR  (ISNULL(PurchaseDemand,0) = 1 AND ISNULL(SOBudget,0) = 0 AND ISNULL(SalaryBudget,0) = 0 AND ISNULL(DepartmentBudget,0) = 0 AND Active = 1) ORDER BY Name ASC"
            FillDropDown(Me.cmbProject, str)
            'ElseIf strCondition = "Company" Then
            '    str = "Select CompanyId, CompanyName From CompanyDefTable"
            '    FillDropDown(Me.cmbCompany, str, False)
        ElseIf strCondition = "ArticlePack" Then
            Me.cmbUnit.ValueMember = "ArticlePackId"
            Me.cmbUnit.DisplayMember = "PackName"
            Me.cmbUnit.DataSource = GetPackData(Me.cmbItem.Value)
            ''18-Aug-2014 Task:2790 Imran Ali Purchase Account Mapping from front end on purchase
        ElseIf strCondition = "PurchaseAccount" Then
            FillUltraDropDown(Me.cmbPurchaseAccount, "Select coa_detail_id, detail_title, detail_code From vwCOADetail WHERE detail_title <> ''")
            Me.cmbPurchaseAccount.Rows(0).Activate()
            If Me.cmbPurchaseAccount.DisplayLayout.Bands(0).Columns.Count > 0 Then
                Me.cmbPurchaseAccount.DisplayLayout.Bands(0).Columns(0).Hidden = True
                Me.cmbPurchaseAccount.DisplayLayout.Bands(0).Columns(1).Header.Caption = "Account Description"
                Me.cmbPurchaseAccount.DisplayLayout.Bands(0).Columns(0).Header.Caption = "Account Code"

                Me.cmbPurchaseAccount.DisplayLayout.Bands(0).Columns(1).Width = 250
                Me.cmbPurchaseAccount.DisplayLayout.Bands(0).Columns(0).Width = 150
            End If
            'End Task:2790
        ElseIf strCondition = "InwardExpense" Then
            FillUltraDropDown(Me.cmbInwardExpense, "Select coa_detail_id, detail_title as [Account Title], detail_code as [Account Code], sub_sub_title as [Account Head], Account_Type as [Account Type] From vwCOADetail where detail_title <> ''")
            Me.cmbInwardExpense.Rows(0).Activate()
            If Me.cmbInwardExpense.DisplayLayout.Bands(0).Columns.Count > 0 Then
                Me.cmbInwardExpense.DisplayLayout.Bands(0).Columns(0).Hidden = True
            End If
        ElseIf strCondition = "Currency" Then ''TASK-407
            str = String.Empty
            str = "Select tblCurrency.currency_id, tblCurrency.currency_code, IsNull(tblCurrencyRate.CurrencyRate, 0) As CurrencyRate From tblCurrency Left Outer Join(Select * FROM tblCurrencyRate Where CurrencyRateId in (Select Max(CurrencyRateId) From tblCurrencyRate group by CurrencyId)) tblCurrencyRate On tblCurrency.currency_id = tblCurrencyRate.CurrencyId "
            FillDropDown(Me.cmbCurrency, str, False)
            Me.cmbCurrency.SelectedValue = BaseCurrencyId
        ElseIf strCondition = "Company" Then
            str = "If  exists(select CompanyId from tblUserCompanyRights where User_Id = " & LoginUserId & " And CompanyId Is Not Null) " _
                & "Select CompanyId, CompanyName, Isnull(CostCenterId,0) as CostCenterId from CompanyDefTable WHERE CompanyName <> '' " & IIf(flgCompanyRights = True, " And CompanyId=" & MyCompanyId, "") & " And CompanyId in (select CompanyId from tblUserCompanyRights where User_Id = " & LoginUserId & ")" _
                & "Else " _
                & "Select CompanyId, CompanyName, Isnull(CostCenterId,0) as CostCenterId from CompanyDefTable " & IIf(flgCompanyRights = True, " WHERE CompanyId=" & MyCompanyId, "") & ""
            FillDropDown(Me.cmbCompany, str, False)
        End If
    End Sub
    Private Sub txtPaid_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtPaid.TextChanged
        txtBalance.Text = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(txtPaid.Text)
    End Sub
    ''' <summary>
    ''' Ayesha Rehman : TFS2576 : GRN Status problem : Update GRN Status When Received Qty + Rejected Qty = Qty
    ''' </summary>
    ''' <param name="ReceivingId"></param>
    ''' <param name="trans"></param>
    ''' <param name="Status"></param>
    ''' <remarks></remarks>
    Public Sub UpdateGRNStatus(ReceivingId As Integer, trans As OleDbTransaction, Optional Status As String = "")
        Dim objCommand As New OleDbCommand
        Try

            objCommand.Connection = trans.Connection
            objCommand.Transaction = trans
            objCommand.CommandTimeout = 300
            objCommand.CommandType = CommandType.Text

            objCommand.CommandText = ""

            objCommand.CommandText = "Select DISTINCT ISNULL(ReceivingNoteId,0) as ReceivingNoteId From ReceivingDetailTable WHERE ReceivingId= " & ReceivingId & " AND ISNULL(Qty,0) <> 0"
            Dim dtPO As New DataTable
            Dim daPO As New OleDbDataAdapter(objCommand)
            daPO.Fill(dtPO)
            If dtPO IsNot Nothing Then
                If dtPO.Rows.Count > 0 Then
                    For Each row As DataRow In dtPO.Rows


                        'objCommand.CommandText = " Select * from ReceivingMasterTable inner join ReceivingNoteMasterTable " & _
                        '                         " on ReceivingMasterTable.ReceivingNoteId = ReceivingNoteMasterTable.ReceivingNoteId " & _
                        '                         " where ReceivingMasterTable.ReceivingQty != ReceivingNoteMasterTable.ReceivingQty " & _
                        '                         " and ReceivingNoteMasterTable.ReceivingNoteId = " & row("ReceivingNoteId") & " "

                        objCommand.CommandText = "Select ReceivingDetailId  from ReceivingDetailTable inner join ReceivingNoteMasterTable " & _
                                                 " on ReceivingDetailTable.ReceivingNoteId = ReceivingNoteMasterTable.ReceivingNoteId Group By ReceivingDetailId, ReceivingDetailTable.ReceivingNoteId, ReceivingQty " & _
                                                 " having Sum(IsNull(ReceivingDetailTable.Qty,0))  < ReceivingNoteMasterTable.ReceivingQty and " & _
                                                 " ReceivingDetailTable.ReceivingNoteId = " & row("ReceivingNoteId") & " "

                        Dim daPOQty As New OleDbDataAdapter(objCommand)
                        Dim dtPOQty As New DataTable
                        daPOQty.Fill(dtPOQty)
                        Dim blnEqual1 As Boolean = True
                        If dtPOQty.Rows.Count > 0 Then
                            'For Each r As DataRow In dtPOQty.Rows
                            'If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
                            blnEqual1 = False
                            'Exit For
                            'End If
                            ' Next
                        End If
                        If blnEqual1 = True Then
                            objCommand.CommandText = "Update ReceivingNoteMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where ReceivingNoteId = " & row("ReceivingNoteId") & ""
                            objCommand.ExecuteNonQuery()
                        Else
                            objCommand.CommandText = "Update ReceivingNoteMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where ReceivingNoteId = " & row("ReceivingNoteId") & ""
                            objCommand.ExecuteNonQuery()
                        End If
                    Next
                End If
            End If

        Catch ex As Exception
            trans.Rollback()
            Throw ex
        End Try
    End Sub
    ''' <summary>
    '''  Ayesha Rehman : TFS3465 : GRN Status problem : Update GRN Status When Purchase is Deleted
    ''' </summary>
    ''' <param name="ReceivingId"></param>
    ''' <param name="trans"></param>
    ''' <param name="Status"></param>
    ''' <remarks></remarks>
    Public Sub UpdateGRNStatusInCaseOfDelete(ReceivingId As Integer, trans As OleDbTransaction, Optional Status As String = "")
        Dim objCommand As New OleDbCommand
        Try

            objCommand.Connection = trans.Connection
            objCommand.Transaction = trans
            objCommand.CommandTimeout = 300
            objCommand.CommandType = CommandType.Text

            objCommand.CommandText = ""

            objCommand.CommandText = "Select DISTINCT ISNULL(ReceivingNoteId,0) as ReceivingNoteId From ReceivingDetailTable WHERE ReceivingId= " & ReceivingId & " AND ISNULL(Qty,0) <> 0"
            Dim dtPO As New DataTable
            Dim daPO As New OleDbDataAdapter(objCommand)
            daPO.Fill(dtPO)
            If dtPO IsNot Nothing Then
                If dtPO.Rows.Count > 0 Then
                    For Each row As DataRow In dtPO.Rows
                        objCommand.CommandText = "Update ReceivingNoteMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where ReceivingNoteId = " & row("ReceivingNoteId") & ""
                        objCommand.ExecuteNonQuery()
                    Next
                End If
            End If

        Catch ex As Exception
            trans.Rollback()
            Throw ex
        End Try
    End Sub



    Private Function Save() As Boolean
        If Me.chkPost.Visible = False Then
            Me.chkPost.Checked = False
        End If
        'Comment against R:979 
        'Dim PurchaseTaxAccountId As Integer = Val(getConfigValueByType("PurchaseTaxDebitAccountId").ToString) 'GetConfigValue("PurchaseTaxDebitAccountId").ToString
        Me.txtPONo.Text = GetDocumentNo() 'GetNextDocNo("Pur", 6, "ReceivingMasterTable", "ReceivingNo")
        'Comment against R:979 
        'Dim PaymentVoucherFlg As String = getConfigValueByType("PaymentVoucherOnPurchase").ToString 'GetConfigValue("PaymentVoucherOnPurchase").ToString
        Dim VoucherNo As String = GetVoucherNo()
        setVoucherNo = Me.txtPONo.Text
        Dim objCommand As New OleDbCommand
        Dim objCon As OleDbConnection
        Dim i As Integer
        gobjLocationId = MyCompanyId
        objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")
        Dim intAdditionalTaxAcId As Integer = Val(getConfigValueByType("AdditionalTaxAcId").ToString)
        Dim PurchaseTaxDeductionAcId As Integer = 0I
        PurchaseTaxDeductionAcId = Val(getConfigValueByType("PurchaseTaxDeductionAcId").ToString)
        Dim VendorDifferenceQtyAccount As Integer = 0I
        VendorDifferenceQtyAccount = Val(getConfigValueByType("VendorDifferenceQty").ToString.Replace("Error", "0"))
        Dim lngVoucherMasterId As Integer = GetVoucherId(Me.Name, Me.txtPONo.Text)
        'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
        If Val(Me.txtAdjustment.Text) > 0 Then
            PurchaseDiscountAccountId = CType(getConfigValueByType("PurchaseDiscountAccount"), Integer)
            If PurchaseDiscountAccountId = 0 AndAlso Me.txtAdjustment.Text > 0 Then
                Throw New Exception("Purchase Discount Account is not mapped.")
            End If
        End If
        'Comment against R:979 
        'Dim AccountId As Integer = Val(getConfigValueByType("PurchaseDebitAccount").ToString) 'GetConfigValue("PurchaseDebitAccount")
        'Dim flgAvgRate As Boolean = Convert.ToBoolean(getConfigValueByType("AvgRate").ToString) 'GetConfigValue("PurchaseDebitAccount")
        'End R:979
        'Dim strvoucherNo As String = GetNextDocNo("PV", 6, "tblVoucher", "voucher_no")

        'If AccountId <= 0 Then
        '    ShowErrorMessage("Purchase account is not map.")
        '    Me.dtpPODate.Focus()
        '    Return False
        'End If


        ''TASK TFS1378
        ''Commented against TASK TFS4709 ON 06-10-2018
        'Dim GRNStockImpact As Boolean = False
        'If Not getConfigValueByType("GRNStockImpact").ToString = "Error" Then
        '    GRNStockImpact = Convert.ToBoolean(getConfigValueByType("GRNStockImpact").ToString)
        'End If
        If Not getConfigValueByType("AvgRate").ToString = "Error" Then
            flgAvgRate = getConfigValueByType("AvgRate")
        End If
        ''END TASK TFS1378

        If Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) <> 0 Then
            If PurchaseTaxAccountId <= 0 Then
                ShowErrorMessage("Purchase tax account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        'Against Request R:979 
        'Dim GLAccountArticleDepartment As Boolean
        'If Not getConfigValueByType("GLAccountArticleDepartment").ToString = "Error" Then
        '    GLAccountArticleDepartment = Convert.ToBoolean(getConfigValueByType("GLAccountArticleDepartment"))
        'Else
        '    GLAccountArticleDepartment = False
        'End If
        'End R:979
        If objCon.State = ConnectionState.Closed Then objCon.Open()
        objCommand.Connection = objCon

        Dim trans As OleDbTransaction = objCon.BeginTransaction
        Try
            objCommand.CommandType = CommandType.Text


            objCommand.Transaction = trans
            'objCon.BeginTransaction()
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No) values( " _
            '                        & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(txtTotalQty.Text) & "," & Val(txtAmount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text & "', N'" & Me.txtDriverName.Text & "', N'" & Me.dtpDcDate.Value & "', N'" & Me.txtInvoiceNo.Text.Replace("'","''") & "')"
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate) values( " _
            '                       & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text & "', N'" & Me.txtDriverName.Text & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'","''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ") Select @@Identity"


            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor) values( " _
            '                       & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text & "', N'" & Me.txtDriverName.Text & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ") Select @@Identity"

            'Chaning against request no 828 by imran ali 18-09-2013 add column of total discount amount
            ''Before against ReqId-970 
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount) values( " _
            '                       & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ") Select @@Identity"
            'ReqId-970 Added Column ReceivingNoteId



            Dim ReceivingNoteId As Integer = 0I
            If Not drReceivingNote Is Nothing Then
                ReceivingNoteId = drReceivingNote(enmReceivingNote.Id)
            ElseIf Not Me.ReceivingId = 0 Then
                ReceivingNoteId = Me.ReceivingId
            End If
            ''TASK TFS4709
            If IsGRNStockImpacted = True AndAlso ReceivingNoteId > 0 Then
                ShouldStockImpactGo = False
            End If
            ''END TASK TFS4709
            'Before against task:2673
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount, ReceivingNoteId) values( " _
            '                                   & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ", " & ReceivingNoteId & ") Select @@Identity"
            'end ReqId-970
            'Task:2673 Added Field RefCMFADocId
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount, ReceivingNoteId,RefCMFADocId) values( " _
            '                                   & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ", " & ReceivingNoteId & ", " & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ") Select @@Identity"
            'End Task:2673
            'Task:2774 Added Field Due Days
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount, ReceivingNoteId,RefCMFADocId, DueDays) values( " _
            '                                   & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ", " & ReceivingNoteId & ", " & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", " & Val(Me.txtDueDays.Text) & ") Select @@Identity"
            'End Taks:2774
            'Task:2790 Added Field PurchaseAcId
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount, ReceivingNoteId,RefCMFADocId, DueDays,PurchaseAcId) values( " _
            '                                   & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ", " & ReceivingNoteId & ", " & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", " & Val(Me.txtDueDays.Text) & ", " & Me.cmbPurchaseAccount.Value & ") Select @@Identity"
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount, ReceivingNoteId,RefCMFADocId, DueDays,PurchaseAcId,InvoiceType) values( " _
            '                                   & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ", " & ReceivingNoteId & ", " & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", " & Val(Me.txtDueDays.Text) & ", " & Me.cmbPurchaseAccount.Value & ",'" & Me.cmbInvoiceType.Text & "') Select @@Identity"
            'End Task:2790
            'objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate,VendorId,PurchaseOrderId, ReceivingQty,ReceivingAmount, CashPaid, Remarks,UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount, ReceivingNoteId,RefCMFADocId, DueDays,PurchaseAcId,InvoiceType,Arrival_Time,Departure_Time) values( " _
            '                                  & gobjLocationId & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ", " & ReceivingNoteId & ", " & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", " & Val(Me.txtDueDays.Text) & ", " & Me.cmbPurchaseAccount.Value & ",'" & Me.cmbInvoiceType.Text & "',Convert(DateTime,'" & Me.dtpArrivalTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)," & IIf(Me.dtpDepartureTime.Checked = True, "Convert(Datetime,'" & Me.dtpDepartureTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)", "NULL") & ") Select @@Identity"

            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            objCommand.CommandText = "Insert into ReceivingMasterTable (locationId,ReceivingNo,ReceivingDate, VendorId, PurchaseOrderId, ReceivingQty, ReceivingAmount, CashPaid, Remarks, UserName, DcNo, Post, Vehicle_No, Driver_Name, dcDate, Vendor_Invoice_No, CostCenterId, IGPNo, CurrencyType, CurrencyRate, Transportation_Vendor, Total_Discount_Amount, ReceivingNoteId,RefCMFADocId, DueDays, PurchaseAcId, InvoiceType, Arrival_Time,Departure_Time, TaxDeductionPercent, TaxDeductionAmount, DiscountType, AdjDiscount, Custom_Vendor) values( " _
                                             & Val(Me.cmbCompany.SelectedValue) & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & Me.cmbPo.SelectedValue & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", " & Val(txtPaid.Text) & ",N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "', N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.txtVhNo.Text.Replace("'", "''") & "', N'" & Me.txtDriverName.Text.Replace("'", "''") & "', " & IIf(Me.dtpDcDate.Checked = True, "N'" & Me.dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', " & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & "," & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", " & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", " & Val(Me.txtDiscount.Text) & ", " & ReceivingNoteId & ", " & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", " & Val(Me.txtDueDays.Text) & ", " & Me.cmbPurchaseAccount.Value & ",'" & Me.cmbInvoiceType.Text & "',Convert(DateTime,'" & Me.dtpArrivalTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)," & IIf(Me.dtpDepartureTime.Checked = True, "Convert(Datetime,'" & Me.dtpDepartureTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)", "NULL") & "," & Val(Me.txtTaxDeductPercent.Text) & "," & Val(Me.txtTaxDeductAmount.Text) & ", N'" & IIf(Me.rbtAdjFlat.Checked = True, "Flat", "Percentage") & "', " & Val(Me.txtAdjustment.Text) & ", " & IIf(Me.cmbCustomVendor.ActiveRow Is Nothing, 0, Me.cmbCustomVendor.Value) & ") Select @@Identity"
            getVoucher_Id = objCommand.ExecuteScalar 'objCommand.ExecuteNonQuery()

            objCommand.CommandText = ""
            'Before against task:M101
            'objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
            '                           & " cheque_no, cheque_date,post,Source,voucher_code)" _
            '                           & " VALUES(" & gobjLocationId & ", 1,  6 , N'" & Me.txtPONo.Text & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
            '                           & " NULL , NULL, " & IIf(Me.chkPost.Checked = True, 1, 0) & " ,'frmPurchase',N'" & Me.txtPONo.Text & "')" _
            '                           & " SELECT @@IDENTITY"
            'Task:M101 Added Field Remarks
            ''TASK TFS1427 Added columns of UserName and Posted_UserName
            objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                                              & " cheque_no, cheque_date,post,Source,voucher_code,Remarks, UserName, Posted_UserName)" _
                                              & " VALUES(" & Val(Me.cmbCompany.SelectedValue) & ", 1,  6 , N'" & Me.txtPONo.Text & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                                              & " NULL , NULL, " & IIf(Me.chkPost.Checked = True, 1, 0) & " ,'frmPurchase',N'" & Me.txtPONo.Text & "',N'" & Me.txtRemarks.Text.Replace("'", "''") & "', N'" & LoginUserName & "', " & IIf(Me.chkPost.Checked = True, "N'" & LoginUserName & "'", "NULL") & ")" _
                                              & " SELECT @@IDENTITY"
            'End Task:M101
            lngVoucherMasterId = objCommand.ExecuteScalar


            'Altered by Ali Ansari for task#2015052
            'Marked Against Task#2015060001 Ali Ansari
            'If arrFile.Length > 0 Then
            '    SaveDocument(getVoucher_Id, Me.Name, trans)
            'End If
            'Marked Against Task#2015060001 Ali Ansari
            'Altered Against Task#2015060001 Ali Ansari

            If arrFile IsNot Nothing Then

                If arrFile.Count > 0 Then
                    SaveDocument(getVoucher_Id, Me.Name, trans)
                End If

            End If

            'Altered Against Task#2015060001 Ali Ansari

            '***********************
            'Deleting Detail
            '***********************
            objCommand.CommandText = ""
            objCommand.CommandText = "delete from tblVoucherDetail where voucher_Id =" & lngVoucherMasterId


            objCommand.ExecuteNonQuery()

            objCommand.CommandText = ""
            Dim strSQL As String
            Dim BatchID As Integer = 0
            StockList = New List(Of StockDetail)
            For i = 0 To grd.RowCount - 1


                'Task:2447 Validation at Batch No.
                If grd.GetRows(i).Cells("BatchNo").Value.ToString.Trim.Length > 1 AndAlso grd.GetRows(i).Cells("BatchNo").Value.ToString.Trim <> "xxxx" Then
                    objCommand.CommandText = ""
                    objCommand.CommandText = "Select Count(*) From ReceivingDetailTable WHERE ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND BatchNo=N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'"
                    Dim objDA As New OleDbDataAdapter
                    Dim objDt As New DataTable
                    objDA.SelectCommand = objCommand
                    objDA.Fill(objDt)
                    If objDt IsNot Nothing Then
                        If Val(objDt.Rows(0).Item(0).ToString) > 0 Then
                            Throw New Exception(Chr(10) & "IR# [" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "] is already exist.")
                        End If
                    End If
                End If
                'End Task:2447


                '********************************
                ' Update Purchase Price By Imran
                '********************************
                Dim CrrStock As Double = 0D
                Dim CostPrice As Double = 0D
                '' Given priority to flgPurchaseAccountFrontEnd over GLAccountArticleDepartment by Ameen on recommendations of Ali sb. 22-11-2016
                If flgPurchaseAccountFrontEnd = True AndAlso cmbPurchaseAccount.Value > 0 Then
                    AccountId = Me.cmbPurchaseAccount.Value
                ElseIf GLAccountArticleDepartment = True Then
                    AccountId = Val(grd.GetRows(i).Cells("PurchaseAccountId").Value.ToString)
                Else
                    AccountId = Val(getConfigValueByType("PurchaseDebitAccount").ToString)
                End If

                If AccountId = 0 Then
                    Throw New Exception("Pruchase Account Is Not Map.")
                End If
                Dim str As String = "Select ServiceItem from ArticleDefView where ArticleId = " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                Dim dt As DataTable = GetDataTable(str, trans)
                dt.AcceptChanges()
                Dim ServiceItem As Boolean = Val(dt.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem = True Then
                    Dim str1 As String = "Select CGSAccountId from ArticleDefView where ArticleId = " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                    Dim dt1 As DataTable = GetDataTable(str1, trans)
                    dt1.AcceptChanges()
                    AccountId = Val(dt1.Rows(0).Item("CGSAccountId").ToString)
                    'AccountId = "Select ServiceItem from ArticleDefView where ArticleId = " & grd.GetRows(i).Cells("ItemId").Value & ""
                End If
                'If flgAvgRate = True Then
                '    Try

                '        objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, 0 as PurchasePrice, Round(ABS(SUM(Isnull(dbo.StockDetailTable.InQty,0) - Isnull(dbo.StockDetailTable.OutQty,0))),4) AS Qty, Round(ABS(SUM(Isnull(dbo.StockDetailTable.InAmount,0) - Isnull(dbo.StockDetailTable.OutAmount,0))),4) as Amount  " _
                '                                & " FROM dbo.ArticleDefTable INNER JOIN " _
                '                                & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId=" & grd.GetRows(i).Cells("ItemId").Value & " " _
                '                                & " GROUP BY dbo.StockDetailTable.ArticleDefId "
                '        Dim dtCrrStock As New DataTable
                '        Dim daCrrStock As New OleDbDataAdapter(objCommand)
                '        daCrrStock.Fill(dtCrrStock)


                '        If dtCrrStock IsNot Nothing Then
                '            If dtCrrStock.Rows.Count > 0 Then
                '                'Before against task:2401
                '                'If Val(grd.GetRows(i).Cells("Price").Value) <> 0 Then
                '                If Val(grd.GetRows(i).Cells("Rate").Value) <> 0 AndAlso Val(dtCrrStock.Rows(0).Item("Qty").ToString) <> 0 Then
                '                    'End Task:2401
                '                    'CrrStock = Val(dtCrrStock.Rows(0).Item(2).ToString) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                '                    'PurchasePriceNew = ((dtCrrStock.Rows(0).Item(3)) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString))) / CrrStock
                '                    CostPrice = (Val(dtCrrStock.Rows(0).Item("Amount").ToString) / Val(dtCrrStock.Rows(0).Item("Qty").ToString)) 'Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '                Else
                '                    CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '                End If
                '            Else
                '                CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '            End If
                '        End If
                '    Catch ex As Exception

                '    End Try

                'Else
                '    CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                'End If

                'StockDetail = New StockDetail
                'StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                'StockDetail.LocationId = grd.GetRows(i).Cells("LocationID").Value
                'StockDetail.ArticleDefId = grd.GetRows(i).Cells("ItemId").Value
                'StockDetail.InQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                'StockDetail.OutQty = 0
                ''StockDetail.Rate = IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)
                'StockDetail.Rate = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))
                'StockDetail.CostPrice = StockDetail.Rate 'IIf(CostPrice = 0, (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)), CostPrice)
                'StockDetail.InAmount = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * StockDetail.Rate), ((Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)) * StockDetail.Rate))
                'StockDetail.OutAmount = 0
                'StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                'StockList.Add(StockDetail)
                'Ali Faisal : TFS2092 : Cost Price Correction
                'Dim strData As String = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0)+" & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & "  as BalanceQty, SUM((IsNull(Rate,0)*IsNull(InQty,0))-(IsNull(Rate,0)*IsNull(OutQty,0))) + " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & " BalanceAmount From StockDetailTable WHERE ArticleDefID=" & Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString) & " AND IsNull(Rate,0) <> 0 Group By ArticleDefId "
                'checking costprice avg rate working

                Dim strData As String
                If ShouldStockImpactGo = True Then
                    'Murtaza
                    strData = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0)+" & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & "  as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) + " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(txtCurrencyRate.Text)) & " BalanceAmount, IsNull(SUM(IsNull(InQty, 0) - IsNull(OutQty, 0)), 0) AS CheckStock From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND IsNull(Rate,0) <> 0 AND StockMasterTable.DocDate < '" & Me.dtpPODate.Value & "' Group By ArticleDefId "
                Else
                    strData = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0) as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) as BalanceAmount, IsNull(SUM(IsNull(InQty, 0) - IsNull(OutQty, 0)), 0) AS CheckStock From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND IsNull(Rate,0) <> 0 AND StockMasterTable.DocDate < '" & Me.dtpPODate.Value & "' Group By ArticleDefId "

                End If
                'Dim strData As String = "Select ArticleDefID, CASE WHEN IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0) > 0 THEN IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0) +" & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & " ELSE " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & " END AS BalanceQty, CASE WHEN SUM((IsNull(Rate,0)*IsNull(InQty,0))-(IsNull(Rate,0)*IsNull(OutQty,0))) > 0 THEN SUM((IsNull(Rate,0)*IsNull(InQty,0))-(IsNull(Rate,0)*IsNull(OutQty,0))) + " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & " ELSE " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & " END AS BalanceAmount, IsNull(SUM(IsNull(InQty, 0) - IsNull(OutQty, 0)), 0)+" & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & " AS CheckStock From StockDetailTable WHERE ArticleDefID=" & Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString) & " AND IsNull(Rate,0) <> 0 Group By ArticleDefId "
                'Dim strData1 As String = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0)+" & (IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))) & "  as BalanceQty, SUM((IsNull(Rate,0)*IsNull(InQty,0))-(IsNull(Rate,0)*IsNull(OutQty,0))) + " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))) & " BalanceAmount From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString) & " AND StockMasterTable.DocNo <> '" & Me.txtPONo.Text & "' AND IsNull(Rate,0) <> 0 Group By ArticleDefId "
                Dim dblCostPrice As Double = 0D
                Dim dtLastestPriceData As New DataTable
                dtLastestPriceData = GetDataTable(strData, trans)
                dtLastestPriceData.AcceptChanges()

                If dtLastestPriceData.Rows.Count > 0 Then
                    'If Val(dtLastestPriceData.Rows(0).Item(1).ToString) > 0 Then
                    If flgAvgRate = True Then
                        dblCostPrice = Val(Val(dtLastestPriceData.Rows(0).Item(2).ToString) / Val(dtLastestPriceData.Rows(0).Item(1).ToString))
                    Else
                        'Murtaza
                        dblCostPrice = Val(Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(txtCurrencyRate.Text)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    End If
                    'If dblCostPrice = 0 Then
                    '    dblCostPrice = Val(Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    'End If
                    'Else
                    '    dblCostPrice = Val(Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    'End If
                    If Val(dtLastestPriceData.Rows(0).Item(3).ToString) < 0 Then
                        flgCostPrice = False
                    Else
                        flgCostPrice = True
                    End If
                Else
                    'Murtaza
                    dblCostPrice = Val(Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(txtCurrencyRate.Text)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    flgCostPrice = True
                End If
                'Ali Faisal : TFS2092 : End

                Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem, trans)
                dt2serviceitem.AcceptChanges()
                Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem1 = False Then

                    If ShouldStockImpactGo = True Then
                        StockDetail = New StockDetail
                        StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                        StockDetail.LocationId = grd.GetRows(i).Cells("LocationID").Value
                        StockDetail.ArticleDefId = IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString))
                        '' TAKS-408
                        'StockDetail.InQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                        StockDetail.InQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)
                        StockDetail.OutQty = 0
                        'StockDetail.Rate = IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)
                        'Murtaza
                        StockDetail.Rate = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * Val(txtCurrencyRate.Text)

                        StockDetail.CostPrice = dblCostPrice '* Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) 'IIf(CostPrice = 0, (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)), CostPrice)
                        ''TASK-408
                        'StockDetail.InAmount = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * StockDetail.Rate), ((Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)) * StockDetail.Rate))
                        StockDetail.InAmount = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * StockDetail.Rate
                        StockDetail.OutAmount = 0
                        StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                        '' Start TASK-470 on 01-07-2016
                        StockDetail.PackQty = Val(grd.GetRows(i).Cells("PackQty").Value.ToString)
                        StockDetail.In_PackQty = Val(grd.GetRows(i).Cells("Qty").Value.ToString)
                        StockDetail.Out_PackQty = 0
                        ''End TASK-470
                        ''TFS1596
                        StockDetail.BatchNo = grd.GetRows(i).Cells("BatchNo").Value.ToString
                        StockDetail.ExpiryDate = CType(grd.GetRows(i).Cells("ExpiryDate").Value, Date).ToString("yyyy-M-d h:mm:ss tt")
                        StockDetail.Origin = grd.GetRows(i).Cells("Origin").Value.ToString
                        StockList.Add(StockDetail)
                    Else
                        StockDetail = New StockDetail
                        StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                        StockDetail.LocationId = grd.GetRows(i).Cells("LocationID").Value
                        StockDetail.ArticleDefId = IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString))
                        '' TAKS-408
                        'StockDetail.InQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                        StockDetail.InQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)
                        StockDetail.OutQty = 0
                        'StockDetail.Rate = IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)
                        'Murtaza
                        StockDetail.Rate = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * Val(txtCurrencyRate.Text)

                        StockDetail.CostPrice = dblCostPrice '* Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) 'IIf(CostPrice = 0, (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)), CostPrice)
                        ''TASK-408
                        'StockDetail.InAmount = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * StockDetail.Rate), ((Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)) * StockDetail.Rate))
                        StockDetail.InAmount = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * StockDetail.Rate
                        StockDetail.OutAmount = 0
                        StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                        '' Start TASK-470 on 01-07-2016
                        StockDetail.PackQty = Val(grd.GetRows(i).Cells("PackQty").Value.ToString)
                        StockDetail.In_PackQty = Val(grd.GetRows(i).Cells("Qty").Value.ToString)
                        StockDetail.Out_PackQty = 0
                        ''End TASK-470
                        ''TFS1596
                        StockDetail.BatchNo = grd.GetRows(i).Cells("BatchNo").Value.ToString
                        StockDetail.ExpiryDate = CType(grd.GetRows(i).Cells("ExpiryDate").Value, Date).ToString("yyyy-M-d h:mm:ss tt")
                        StockDetail.Origin = grd.GetRows(i).Cells("Origin").Value.ToString
                    End If
                End If
                'Dim dt As DataTable = CType(Me.grd.DataSource, DataTable)

                ''Code Commented Againt Task 1596

                Dim TotalQty As Double = 0
                TotalQty = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TotalQty"), Janus.Windows.GridEX.AggregateFunction.Sum))
                Dim TransCharges As Double = 0
                TransCharges = Val(Val(Me.txtTransCharges.Text) / TotalQty)

                Dim intReceivingDetailID As Integer = 0I
                If Me.cmbPo.SelectedIndex > 0 Then
                    Dim dt1 As DataTable = CType(Me.grd.DataSource, DataTable)
                    strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'"
                    Dim dtBatch As DataTable = GetDataTable(strSQL, trans)

                    If dtBatch.Rows.Count = 0 Then
                        If msg_Confirm("The batch No you entered is new. " & Environment.NewLine & "Do you want to add new batch no...?") Then

                            objCommand.CommandText = "insert into PurchaseBatchTable(BatchNo,StartDate, EndDate, Comments,sortorder) values(N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Trim.Replace("'", "''") & "', GetDate(), NULL , '',0" & ") Select @@Identity"
                            BatchID = objCommand.ExecuteScalar()

                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty) values( " _
                            '            & " ident_current('ReceivingMasterTable')," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                            '            & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & BatchID & ",N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & " ) "

                            '**********************************Update Bellow Purchase Tax Debit Account  08-02-2012 by Imran Ali *************************
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, Comments, Transportation_Charges, PackPrice) values( " _
                            '                                        & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                        & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & BatchID & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ") "

                            'Chaning against request no 828 by imran ali 18-09-2013 add column Discount Price
                            ''Before against request no . 934
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc) values( " _
                            '                                       & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                       & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & BatchID & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "
                            ''ReqId-934 Resolve Comma Error

                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,Item_Wise_Disc) values( " _
                            '                                       & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                       & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'," & BatchID & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRow.Cells("Item Wise Disc").Value.ToString) & ")"
                            'Before TASK TFS 51
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                            '                                       & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                       & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'," & BatchID & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ")"
                            'TASK-TFS-51 Added Fields AdTax_Percent
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount) values( " _
                            '                                       & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                       & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'," & BatchID & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ")"
                            'END TASK-TFS-51
                            ''TFS1391 Added column ReceivingNoteId
                            objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount, ReceivingNoteDetailId, PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId, Gross_Quantity, Vendor_Total_Quantity, Column1, COlumn2, Column3, OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                                                  & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                                                  & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'," & 0 & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " , " & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & "', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ") Select @@Identity" '' TASK-408 added TotalQty value here
                            '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'," & BatchID & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ")Select @@Identity"


                            intReceivingDetailID = objCommand.ExecuteScalar()


                        Else
                            strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value & "'"
                            dtBatch = GetDataTable(strSQL, trans)
                            Dim Batch_Id As Integer = 0I
                            If dtBatch IsNot Nothing Then
                                If dtBatch.Rows.Count > 0 Then
                                    Batch_Id = dtBatch.Rows(0).Item(0)
                                End If
                            End If

                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty) values( " _
                            '          & " ident_current('ReceivingMasterTable')," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                            '          & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & dt.Rows(0).Item(0).ToString & ",N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & " ) "
                            '**********************************Update Bellow Purchase Tax Debit Account  08-02-2012 by Imran Ali *************************
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice) values( " _
                            '          & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '          & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ",N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ") "

                            'changing against request no 828 by imran ali 18-09-2013 add column of Discount_Price
                            'Before against request no. 934 
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc) values( " _
                            '          & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '          & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & "," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "
                            'ReqId-934 Resolve Comma Error
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc) values( " _
                            '         & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '         & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & "," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "


                            'Before TASK-TFS-51
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                            '        & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '        & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & "," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ") "
                            'TASK-TFS-51 Added Fields

                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount) values( " _
                            '        & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '        & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & "," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ") "
                            'END TAS-TSF-51
                            ''TFS1391 Added column ReceivingNoteId
                            ''Edit Against TFS1596
                            'rafay show error
                            objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount,ReceivingNoteDetailId,PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,Column2,Column3, OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                             & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                             & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & 0 & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells("ExpiryDate").Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells("ExpiryDate").Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells("ExpiryDate").Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & " ', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ") Select @@Identity" ''TAKS-408 added TotalQty value here
                            '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "                    ," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ") Select @@Identity"

                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount,ReceivingNoteDetailId, PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,Column2,Column3, OtherDeduction) values( " _
                            '        & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '        & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & 0 & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & "," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & " , " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ") Select @@Identity"
                            intReceivingDetailID = objCommand.ExecuteScalar()

                        End If
                    Else
                        strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value & "'"
                        Dim dtBatch1 As DataTable = GetDataTable(strSQL, trans)
                        Dim Batch_Id As Integer = 0I
                        If dtBatch1 IsNot Nothing Then
                            If dtBatch1.Rows.Count > 0 Then
                                Batch_Id = dtBatch1.Rows(0).Item(0)
                            End If
                        End If

                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty) values( " _
                        '              & " ident_current('ReceivingMasterTable')," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                        '              & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & dt.Rows(0).Item(0).ToString & ",N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & " ) "

                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice) values( " _
                        '              & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '              & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ,N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ") "

                        'changing against request no 828 by imran ali 18-9-2013 add column of Discount_Price
                        'Before against request no. 934
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc) values( " _
                        '              & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '              & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " , " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "
                        'ReqId-934 Resolve Comma Error
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc) values( " _
                        '              & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '              & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " , " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "


                        'Before TASK-TFS-51
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                        '             & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '             & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " , " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ") "
                        'TASK-TFS-51 Added Fields AdTax_Percent, AdTax_Amount

                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount) values( " _
                        '             & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '             & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " , " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ") "
                        'END TASK-TFS-51
                        ''TFS1391 Added column ReceivingNoteId
                        ''Edit Against TFS1596
                        objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount,ReceivingNoteDetailId,PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,Column2,Column3, OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                    & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                    & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & 0 & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " , " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " , " & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ",  " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & " ', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ") Select @@Identity" ''TAKS-408 added TotalQty value here
                        '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " , " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ") Select @@Identity"

                        intReceivingDetailID = objCommand.ExecuteScalar()
                    End If

                Else
                    'Dim dt2 As DataTable = CType(Me.grd.DataSource, DataTable)
                    strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value & "'"
                    Dim dtBatch2 As DataTable = GetDataTable(strSQL, trans)
                    Dim Batch_Id As Integer = 0I
                    If dtBatch2 IsNot Nothing Then
                        If dtBatch2.Rows.Count > 0 Then
                            Batch_Id = dtBatch2.Rows(0).Item(0)
                        End If
                    End If
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty) values( " _
                    '                   & " ident_current('ReceivingMasterTable')," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                    '                   & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & dt.Rows(0).Item(0).ToString & ",N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & " ) "

                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice) values( " _
                    '                   & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                   & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ,N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "',N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ") "

                    'changing against request no 828 by imran ali 18-9-2013 add column of discount_Price
                    'Before against request no. 934
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc) values( " _
                    '                   & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                   & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "
                    'ReqId-934 Resolve Comma Error
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,Item_Wise_Disc) values( " _
                    '                   & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                   & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("ItemWiseDisc").Value.ToString) & ") "


                    'Before TASK-TFS-51
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                    '                  & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                  & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ") "

                    'TASK-TFS-51 Added Fields AdTax_Percent, AdTax_Amount
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount) values( " _
                    '                  & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                  & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "                    ," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ") "
                    'End TASK-TFS-51
                    'Dim dt3 As DataTable = CType(Me.grd.DataSource, DataTable)
                    ''TFS1391 Added column ReceivingNoteId
                    ''Edit Against TFS1596
                    objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID,LocationId, ReceivedQty, RejectedQty, TaxPercent, ExpiryDate, Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount,ReceivingNoteDetailId,PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,Column2,Column3, OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                     & " ident_current('ReceivingMasterTable')," & Val(grd.GetRows(i).Cells("ItemId").Value) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                     & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & 0 & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & " ', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ") Select @@Identity" ''TAKS-408 added TotalQty value here
                    '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "                    ," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ") Select @@Identity"

                    intReceivingDetailID = objCommand.ExecuteScalar()

                End If

                ''End Commentation Against Task 1596

                'objCommand.ExecuteNonQuery()
                'Val(grd.Rows(i).Cells(5).Value)

                'update date Purchase Order Detail table
                'objCommand.CommandText = "UPDATE    PurchaseOrderDetailTable" _
                '                        & " SET              DeliveredQty = isnull(DeliveredQty,0) +  " & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & "" _
                '                        & " WHERE   (ArticleDefId = " & Val(grd.GetRows(i).Cells("ItemId").Value) & ")"

                'objCommand.CommandText += " AND  (PurchaseOrderId = " & Me.cmbPo.SelectedValue & ")"
                'If Val(grd.GetRows(i).Cells("PurchaseOrderDetailID").Value.ToString) > 0 Then
                '    objCommand.CommandText += " AND  (PurchaseOrderDetailID = " & Val(grd.GetRows(i).Cells("PurchaseOrderDetailID").Value.ToString) & ")"
                'End If

                'objCommand.ExecuteNonQuery()

                If ServiceItem1 = False Then

                    If Val(grd.GetRows(i).Cells("rate").Value.ToString) > 0 Then
                        If flgAvgRate = True Then
                            If flgCostPrice = True Then
                                objCommand.CommandText = ""
                                objCommand.CommandText = "UPDATE ArticleDefTableMaster Set PurchasePrice=" & (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))) & ", Cost_Price=" & StockDetail.CostPrice & " WHERE ArticleId in (Select MasterId From ArticleDefTable WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ")"
                                objCommand.ExecuteNonQuery()


                                objCommand.CommandText = ""
                                objCommand.CommandText = "UPDATE ArticleDefTable Set PurchasePrice=" & (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))) & ",Cost_Price=" & StockDetail.CostPrice & " WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                                objCommand.ExecuteNonQuery()

                                objCommand.CommandText = ""
                                objCommand.CommandText = " Select a.ArticleDefId, b.SalesItem From IncrementReductionTable a INNER JOIN ArticleDefView b ON b.ArticleId = a.ArticleDefId WHERE (Convert(varchar, a.IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102))  AND a.ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                                Dim dtRate As New DataTable
                                Dim daRate As New OleDbDataAdapter(objCommand)
                                daRate.Fill(dtRate)

                                objCommand.CommandText = "Select ISNULL(SalesItem,0) as SalesItem From ArticleDefView WHERE Active=1 AND ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " "
                                Dim dtSalesItem As New DataTable
                                Dim daSalesItem As New OleDbDataAdapter(objCommand)
                                daSalesItem.Fill(dtSalesItem)

                                If dtSalesItem.Rows.Count > 0 Then
                                    If Not dtRate Is Nothing Then
                                        If dtRate.Rows.Count > 0 Then
                                            objCommand.CommandText = "Update IncrementReductionTable Set PurchaseNewPrice=" & (StockDetail.Rate - Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", SaleNewPrice=" & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, (StockDetail.Rate - Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString))) & ", Cost_Price_New=" & Val(StockDetail.CostPrice) & "  WHERE ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND (Convert(varchar, IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102)) "
                                            objCommand.ExecuteNonQuery()
                                        Else
                                            objCommand.CommandText = "INSERT INTO IncrementReductionTable(IncrementReductionDate, ArticleDefId, StockQty, PurchaseOldPrice, PurchaseNewPrice, SaleOldPrice,SaleNewPrice, Cost_Price_Old,Cost_Price_New) " _
                                            & " Values(N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ",  " & Val(0) & ", " & Val(0) & ", " & (StockDetail.Rate - Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(0) & ", " & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, (StockDetail.Rate - Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))) & ", 0," & Val(StockDetail.CostPrice) & ")"
                                            objCommand.ExecuteNonQuery()
                                        End If
                                    End If
                                End If
                            End If
                        Else


                            objCommand.CommandText = ""
                            objCommand.CommandText = "UPDATE ArticleDefTableMaster Set PurchasePrice=" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", Cost_Price=" & StockDetail.CostPrice & ", CurrencyAmount =" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) * Val(txtCurrencyRate.Text) & " WHERE ArticleId in (Select MasterId From ArticleDefTable WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ")"
                            objCommand.ExecuteNonQuery()

                            'Apply Current Rate 
                            objCommand.CommandText = "UPDATE ArticleDefTable Set PurchasePrice=" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", Cost_Price=" & StockDetail.CostPrice & ", CurrencyAmount =" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) * Val(txtCurrencyRate.Text) & " WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                            objCommand.ExecuteNonQuery()

                            objCommand.CommandText = " Select a.ArticleDefId, b.SalesItem From IncrementReductionTable a INNER JOIN ArticleDefView b ON b.ArticleId = a.ArticleDefId WHERE (Convert(varchar, a.IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102))  AND a.ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                            Dim dtRate As New DataTable
                            Dim daRate As New OleDbDataAdapter(objCommand)
                            daRate.Fill(dtRate)

                            objCommand.CommandText = "Select ISNULL(SalesItem,0) as SalesItem From ArticleDefView WHERE Active=1 AND ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " "
                            Dim dtSalesItem As New DataTable
                            Dim daSalesItem As New OleDbDataAdapter(objCommand)
                            daSalesItem.Fill(dtSalesItem)

                            If dtSalesItem.Rows.Count > 0 Then
                                If Not dtRate Is Nothing Then
                                    If dtRate.Rows.Count > 0 Then
                                        objCommand.CommandText = "Update IncrementReductionTable Set PurchaseNewPrice=" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", SaleNewPrice=" & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString)) & ", Cost_Price_New=" & Val(StockDetail.CostPrice) & "  WHERE ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND (Convert(varchar, IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102)) "
                                        objCommand.ExecuteNonQuery()
                                    Else
                                        objCommand.CommandText = "INSERT INTO IncrementReductionTable(IncrementReductionDate, ArticleDefId, StockQty, PurchaseOldPrice, PurchaseNewPrice, SaleOldPrice,SaleNewPrice,Cost_Price_Old, Cost_Price_New) " _
                                        & " Values(N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ",  " & Val(0) & ", " & Val(0) & ", " & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", " & Val(0) & ", " & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString)) & ",0," & Val(StockDetail.CostPrice) & ")"
                                        objCommand.ExecuteNonQuery()
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
                '***********************
                'Inserting Debit Amount
                '***********************
                'objCommand.CommandText =0 ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & Val(grd.Rows(i).Cells("qty").Value) * Val(grd.Rows(i).Cells("rate").Value) & ", 0, N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")')"

                'Dim CurrencyDeduction As Double = (Val(grd.GetRows(i).Cells("BardanaDeduction").Value.ToString) + Val(grd.GetRows(i).Cells("OtherDeduction").Value.ToString)) * Val(grd.GetRows(i).Cells("Rate").Value.ToString)

                objCommand.CommandText = ""
                'Before against task:2376
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", "" & Val(grd.GetRows(i).Cells("qty").Value.ToString) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & "", "" & (Val(grd.GetRows(i).Cells("PackQty").Value) * Val(grd.GetRows(i).Cells("Qty").Value.ToString)) * Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "") & ",0, N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & " X " & " " & Me.grd.GetRows(i).Cells("rate").Value - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & " )"
                'Task:2376 Chage Comments Layout
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("rate").Value.ToString) * Val(txtCurrencyRate.Text) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ",0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"
                'End Task:2376
                objCommand.ExecuteNonQuery()

                '***********************
                'Inserting Credit Amounts
                '***********************
                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(grd.Rows(i).Cells("qty").Value) * Val(grd.Rows(i).Cells("rate").Value) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")')"

                objCommand.CommandText = ""
                'Before against task:2376
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", "" & Val(grd.GetRows(i).Cells("qty").Value.ToString) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & "", "" & (Val(grd.GetRows(i).Cells("PackQty").Value) * Val(grd.GetRows(i).Cells("Qty").Value.ToString)) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & "") & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & " X " & " " & Me.grd.GetRows(i).Cells("rate").Value - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & "," & grd.GetRows(i).Cells("ItemId").Value & ")"
                ''Task:2376 Change Comments Layout
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("rate").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                ''End Task:2376
                'objCommand.ExecuteNonQuery()

                'Vendor Quantity Based Credit By Imran Ali 26-9-2017\
                'Murtaza
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) * Val(grd.GetRows(i).Cells("rate").Value.ToString) * Val(txtCurrencyRate.Text) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) * Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"

                objCommand.ExecuteNonQuery()
                'nd

                'Vendor Quantity Based Credit By Imran Ali 26-9-2017
                If (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) <> (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) Then

                    If (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) > (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) Then
                        objCommand.CommandText = ""
                        'Murtaza
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id,  debit_amount, credit_amount,comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & VendorDifferenceQtyAccount & ", 0, " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) - (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * Val(txtCurrencyRate.Text) & ", N'Ref:Subtract Quantity', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) - (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"

                        objCommand.ExecuteNonQuery()

                    Else
                        objCommand.CommandText = ""
                        'Murtaza
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, credit_amount,debit_amount, comments, sp_refrence, CostCenterId, direction,Currency_Credit_Amount, Currency_Debit_Amount,  BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & VendorDifferenceQtyAccount & ", 0, " & ((Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) - Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * Val(txtCurrencyRate.Text) & ", N'Ref:Add Quantity', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & ((Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) - Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"

                        objCommand.ExecuteNonQuery()

                    End If
                End If
                'nd


                'If flgTransaportationChargesVoucher = True Then
                '    If Not Me.cmbTransportationVendor.ActiveRow Is Nothing Then
                '        If Me.cmbTransportationVendor.Value > 0 Then
                '            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Then
                '                '************************************
                '                'Transportation Charges Voucher Debit
                '                '************************************
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty

                '                objCommand.ExecuteNonQuery()

                '                '************************************
                '                'Transportation Charges Voucher Credit
                '                '************************************
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbTransportationVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                '                objCommand.ExecuteNonQuery()
                '            End If
                '        Else
                '            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Then
                '                '************************************
                '                'Transportation Charges Voucher Debit
                '                '************************************
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty

                '                objCommand.ExecuteNonQuery()

                '                '************************************
                '                'Transportation Charges Voucher Credit
                '                '************************************
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                '                objCommand.ExecuteNonQuery()
                '            End If
                '        End If
                '    End If
                'End If

                If flgTransaportationChargesVoucher = True Then
                    If Not Me.cmbTransportationVendor.ActiveRow Is Nothing Then
                        If Me.cmbTransportationVendor.Value > 0 Then
                            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Or Val(TransCharges) <> 0 Then
                                '************************************
                                'Transportation Charges Voucher Debit
                                '************************************
                                objCommand.CommandText = ""
                                'Murtaza
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")" ''TASK-408 added TotalQty

                                objCommand.ExecuteNonQuery()

                                '************************************
                                'Transportation Charges Voucher Credit
                                '************************************
                                objCommand.CommandText = ""
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbTransportationVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(txtCurrencyRate.Text) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"
                                objCommand.ExecuteNonQuery()
                            End If
                        Else
                            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Or Val(TransCharges) <> 0 Then
                                '************************************
                                'Transportation Charges Voucher Debit
                                '************************************
                                objCommand.CommandText = ""
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")" ''TASK-408 added TotalQty

                                objCommand.ExecuteNonQuery()

                                '************************************
                                'Transportation Charges Voucher Credit
                                '************************************
                                objCommand.CommandText = ""
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(txtCurrencyRate.Text) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"
                                objCommand.ExecuteNonQuery()
                            End If
                        End If
                    End If
                End If

                If Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) <> 0 Then
                    '************************************
                    'Custom Charges Voucher Debit
                    '************************************
                    objCommand.CommandText = ""
                    'Murtaza
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")" ''TASK-408 added TotalQty

                    objCommand.ExecuteNonQuery()

                    '************************************
                    'Custom Charges Voucher Credit
                    '************************************
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbCustomVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) * Val(txtCurrencyRate.Text) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"
                    objCommand.ExecuteNonQuery()
                End If

                '    'TASK-TFS-51 Additioanl Tax Voucher 
                '    If Val(grd.GetRows(i).Cells("AdTax_Amount").Value) > 0 Then

                '        objCommand.CommandText = ""
                '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction) " _
                '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & intAdditionalTaxAcId & ", " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ",0, 'Ref:Additional Tax Against " & Me.cmbVendor.Text.Replace("'", "''") & ", " & Me.txtPONo.Text.Replace("'", "''") & "" & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & " )"
                '        objCommand.ExecuteNonQuery()

                '        objCommand.CommandText = ""
                '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction) " _
                '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ",'Ref:Additional Tax Againt " & Me.txtPONo.Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & "," & grd.GetRows(i).Cells("ItemId").Value & ")"
                '        objCommand.ExecuteNonQuery()

                '    End If
                '    'END TASK TSK-TFS-51




                'Next

                'If Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) > 0 Then
                '    'Inserting Tax Debit With Purchase Tax Account
                '    objCommand.CommandText = ""
                '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId) " _
                '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & PurchaseTaxAccountId & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",  " & 0 & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ")"
                '    objCommand.ExecuteNonQuery()

                '    'Inserting Tax Credit With Vendor Account
                '    objCommand.CommandText = ""
                '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId) " _
                '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ")"
                '    objCommand.ExecuteNonQuery()

                'End If
                'TASK-TFS-51 Additioanl Tax Voucher 
                If Val(grd.GetRows(i).Cells("AdTax_Amount").Value) > 0 Then
                    'Dim strBudget As String
                    'Dim dtBudget As DataTable
                    'strBudget = "SELECT ISNULL(SOBudget,0) as SOBudget, Amount from tbldefCostCenter where CostCenterID = " & cmbProject.SelectedValue & ""
                    'dtBudget = GetDataTable(strBudget)
                    'If dtBudget.Rows.Count > 0 Then
                    '    If dtBudget.Rows(0).Item(0) = "True" Then
                    '        objCommand.CommandText = ""
                    '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                    '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & intAdditionalTaxAcId & ", " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ",0, 'Ref:Additional Tax Against " & Me.cmbVendor.Text.Replace("'", "''") & ", " & Me.txtPONo.Text.Replace("'", "''") & "" & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & 1 & ", " & grd.GetRows(i).Cells("ItemId").Value & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString()) & ", " & Val(0) & ")"
                    '        objCommand.ExecuteNonQuery()

                    '        objCommand.CommandText = ""
                    '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                    '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ", 'Ref:Additional Tax Against " & Me.txtPONo.Text.Replace("'", "''") & "',N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & 1 & "," & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(0) & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString()) & ")"
                    '        objCommand.ExecuteNonQuery()
                    '    Else
                    '        objCommand.CommandText = ""
                    '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                    '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & intAdditionalTaxAcId & ", " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ",0, 'Ref:Additional Tax Against " & Me.cmbVendor.Text.Replace("'", "''") & ", " & Me.txtPONo.Text.Replace("'", "''") & "" & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString()) & ", " & Val(0) & ")"
                    '        objCommand.ExecuteNonQuery()

                    '        objCommand.CommandText = ""
                    '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                    '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ", 'Ref:Additional Tax Against " & Me.txtPONo.Text.Replace("'", "''") & "',N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(0) & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString()) & ")"
                    '        objCommand.ExecuteNonQuery()
                    '    End If
                    '    'END TASK TSK-TFS-51
                    'Else
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & intAdditionalTaxAcId & ", " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ",0, 'Ref:Additional Tax Against " & Me.cmbVendor.Text.Replace("'", "''") & ", " & Me.txtPONo.Text.Replace("'", "''") & "" & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString()) & ", " & Val(0) & ")"
                    objCommand.ExecuteNonQuery()

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ", 'Ref:Additional Tax Against " & Me.txtPONo.Text.Replace("'", "''") & "',N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(0) & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString()) & ")"
                    objCommand.ExecuteNonQuery()
                    'End If
                End If

            Next

            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.

            If Val(Me.txtAdjustment.Text) > 0 Then
                Dim TotalAmount1 As Double = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total Amount"), Janus.Windows.GridEX.AggregateFunction.Sum)
                Dim DiscountAdj As Double = 0
                If Me.rbtAdjFlat.Checked = True Then
                    DiscountAdj = Val(Me.txtAdjustment.Text)
                Else
                    DiscountAdj = (TotalAmount1 * Val(Me.txtAdjustment.Text) / 100)
                End If
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & DiscountAdj & ", 0, N'Purchase Adjustment Discount voucher', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & DiscountAdj & ", 0, 1,1,1,1)"
                objCommand.ExecuteNonQuery()

                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & PurchaseDiscountAccountId & ", 0, " & DiscountAdj & ", N'Purchase Adjustment Discount voucher', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", 0, " & DiscountAdj & ", 1, 1, 1, 1)"
                objCommand.ExecuteNonQuery()
            End If


            If Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) > 0 Then
                'Inserting Tax Debit With Purchase Tax Account
                'Dim strBudget As String
                'Dim dtBudget As DataTable
                'strBudget = "SELECT ISNULL(SOBudget,0) as SOBudget, Amount from tbldefCostCenter where CostCenterID = " & cmbProject.SelectedValue & ""
                'dtBudget = GetDataTable(strBudget)
                'If dtBudget.Rows.Count > 0 Then
                '    If dtBudget.Rows(0).Item(0) = "True" Then
                '        objCommand.CommandText = ""
                '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & PurchaseTaxAccountId & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",  " & 0 & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & 1 & ", " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(0) & ")"
                '        objCommand.ExecuteNonQuery()

                '        'Inserting Tax Credit With Vendor Account
                '        objCommand.CommandText = ""
                '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & 1 & "," & Val(0) & ", " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ")"
                '        objCommand.ExecuteNonQuery()
                '    Else
                '        objCommand.CommandText = ""
                '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & PurchaseTaxAccountId & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",  " & 0 & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(0) & ")"
                '        objCommand.ExecuteNonQuery()

                '        'Inserting Tax Credit With Vendor Account
                '        objCommand.CommandText = ""
                '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & Val(0) & ", " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ")"
                '        objCommand.ExecuteNonQuery()
                '    End If
                'Else
                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & PurchaseTaxAccountId & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",  " & 0 & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & "," & Val(0) & ")"
                objCommand.ExecuteNonQuery()

                'Inserting Tax Credit With Vendor Account
                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & Val(0) & ", " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ")"
                objCommand.ExecuteNonQuery()
            End If

            'End If

            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grdInwardExpDetail.GetRows
                'If Val(r.Cells("Exp_Amount").Value.ToString) <> 0 Then
                '    objCommand.CommandText = ""
                '    objCommand.CommandText = "INSERT INTO InwardExpenseDetailTable(PurchaseId, AccountId, Exp_Amount,DocType) Values(ident_current('ReceivingMasterTable'), " & Val(r.Cells("AccountId").Value.ToString) & ", " & Val(r.Cells("Exp_Amount").Value) & ",'PUR')"
                '    objCommand.ExecuteNonQuery()


                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(Me.cmbVendor.Value) & ", " & 0 & ",  " & Val(r.Cells("Exp_Amount").Value.ToString) & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & Me.cmbProject.SelectedValue & " )"

                '' objCommand.Transaction = trans
                'objCommand.ExecuteNonQuery()



                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(r.Cells("AccountId").Value.ToString) & ",   " & Val(r.Cells("Exp_Amount").Value.ToString) & "," & 0 & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & Me.cmbProject.SelectedValue & " )"

                '' objCommand.Transaction = trans
                'objCommand.ExecuteNonQuery()

                If Val(r.Cells("Debit").Value.ToString) <> 0 Or Val(r.Cells("Credit").Value.ToString) <> 0 Then
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO InwardExpenseDetailTable(PurchaseId, AccountId, Exp_Amount,DocType) Values(ident_current('ReceivingMasterTable'), " & Val(r.Cells("AccountId").Value.ToString) & ", " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), -Val(r.Cells("Credit").Value.ToString)) & ",'PUR')"
                    objCommand.ExecuteNonQuery()

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(Me.cmbVendor.Value), Val(r.Cells("AccountId").Value.ToString)) & ", " & 0 & ",  " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), Val(r.Cells("Credit").Value.ToString)) & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()



                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & IIf(Val(r.Cells("Credit").Value.ToString) > 0, Val(Me.cmbVendor.Value), Val(r.Cells("AccountId").Value.ToString)) & ",   " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), Val(r.Cells("Credit").Value.ToString)) & "," & 0 & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            Next

            ' Receipt Voucher Master Information 
            If PaymentVoucherFlg = "True" AndAlso Val(Me.txtRecAmount.Text) <> 0 Then
                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                                           & " post,Source,voucher_code, coa_detail_id, Cheque_No, Cheque_Date)" _
                                           & " VALUES(" & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", 1, " & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", N'" & VoucherNo & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                                           & " " & IIf(Me.chkPost.Checked = True, 1, 0) & ",'frmPurchase',N'" & Me.txtPONo.Text & "', " & Me.cmbDepositAccount.SelectedValue & "," & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'") & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'") & ")" _
                                           & " SELECT @@IDENTITY"

                'objCommand.Transaction = trans
                lngVoucherMasterId = objCommand.ExecuteScalar


                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId,Cheque_No,Cheque_Date) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtRecAmount.Text) & ", 0, 'Payment Ref: " & Me.txtPONo.Text & ":" & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'") & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'") & ")"

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, Cheque_No,Cheque_Date) " _
                                                     & " VALUES(" & lngVoucherMasterId & "," & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbDepositAccount.SelectedValue & ", " & 0 & ",  " & Val(Me.txtRecAmount.Text) & ", 'Payment Ref: " & Me.txtPONo.Text & ":" & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'") & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'") & " )"

                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()

            End If


            'If Me.cmbPo.SelectedIndex > 0 Then
            '    'Before against task:2696
            '    'objCommand.CommandText = "Select Qty, isnull(DeliveredQty,0) as DeliveredQty  from PurchaseOrderDetailTable where PurchaseOrderID = " & Me.cmbPo.SelectedValue & ""
            '    ''19-June-2014 TASK:2696 IMRAN ALI Default Selected Invoice Party Through Customer List(Ravi)
            '    objCommand.CommandText = "Select SUM(IsNull(Sz1,0)) as Qty, SUM(isnull(DeliveredQty,0)) as DeliveredQty  from PurchaseOrderDetailTable where PurchaseOrderID = " & Me.cmbPo.SelectedValue & ""
            '    'End Task:2696
            '    Dim da As New OleDbDataAdapter(objCommand)
            '    Dim dt As New DataTable
            '    da.Fill(dt)
            '    dt.AcceptChanges()
            '    Dim blnEqual As Boolean = True

            '    If dt.Rows.Count > 0 Then
            '        For Each r As DataRow In dt.Rows
            '            If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
            '                blnEqual = False
            '                Exit For
            '            End If
            '        Next
            '    End If

            '    If blnEqual = True Then
            '        objCommand.CommandText = "Update PurchaseOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where PurchaseOrderID = " & Me.cmbPo.SelectedValue & " "
            '        objCommand.ExecuteNonQuery()
            '    End If
            'End If


            ''
            'PurchaseTaxDeductionAcId 

            If Val(Me.txtTaxDeductAmount.Text) > 0 Then


                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(Me.cmbVendor.Value) & ", " & Val(Me.txtTaxDeductAmount.Text) & ", " & 0 & ",N'Ref tax deduction against:" & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"
                objCommand.ExecuteNonQuery()


                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(PurchaseTaxDeductionAcId) & ", " & 0 & "," & Val(Me.txtTaxDeductAmount.Text) & ", N'Ref tax deduction against: " & Me.cmbVendor.ActiveRow.Cells("Name").Text.Replace("'", "''") & ", " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"
                objCommand.ExecuteNonQuery()


            End If



            UpdateInwardExpense(Val(getVoucher_Id), trans)
            UpdatePOStatus(getVoucher_Id, trans) ' Update PO Status
            ''Start TFS2576
            UpdateGRNStatus(getVoucher_Id, trans) 'Update GRN Status
            ''End TFS2576


            ''TASK TFS1378 changed conditions for stock impact on 16-10-2017
            'If GRNStockImpact = True AndAlso ReceivingNoteId > 0 Then

            'Else
            If IsValidate() = True AndAlso ShouldStockImpactGo = True Then
                Call New StockDAL().Add(StockMaster, trans)
            End If
            'End If
            ''End TASK TFS1378
            trans.Commit()
            Save = True
            'insertvoucher()
            'Call Save1() 'Upgrading Stock ...
            SendSMS()

            ''insert Activity Log
            SaveActivityLog("POS", Me.Text, EnumActions.Save, LoginUserId, EnumRecordType.Purchase, Me.txtPONo.Text.Trim, True)
            SaveActivityLog("Accounts", Me.Text, EnumActions.Save, LoginUserId, EnumRecordType.AccountTransaction, Me.txtPONo.Text, True)

            ''Start TFS2375
            ''insert Approval Log
            SaveApprovalLog(EnumReferenceType.Purchase, getVoucher_Id, Me.txtPONo.Text.Trim, Me.dtpPODate.Value.Date, "Purchase ," & cmbVendor.Text & "", Me.Name, 6)
            ''End TFS2375

            setEditMode = False
            Total_Amount = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum) + Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)
            drReceivingNote = Nothing 'ReqId-970 Set Nothing Receiving Note Row

        Catch ex As Exception
            trans.Rollback()
            Save = False
            ShowErrorMessage("An error occured while saving record" & ex.Message)
        End Try
    End Function


    Sub InsertVoucher()

        Try
            'SaveVoucherEntry(GetVoucherTypeId("SV"), GetNextDocNo("SV", 6, "tblVoucher", "voucher_no"), Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt"), "", Nothing, GetConfigValue("ReceivingCreditAccount"), Val(Me.cmbVendor.ActiveRow.Cells(0).Text.ToString), Val(Me.txtAmount.Text), Val(Me.txtAmount.Text), "Both", Me.Name, Me.txtPONo.Text, True)
        Catch ex As Exception
            ShowErrorMessage("An error occured while saving voucher: " & ex.Message)
        End Try

    End Sub

    Private Function FormValidate() As Boolean

        If txtPONo.Text = "" Then
            msg_Error("Please enter PO No.")
            txtPONo.Focus() : FormValidate = False : Exit Function
        End If
        If Val(Me.txtRecAmount.Text) > 0 Then
            If Me.cmbDepositAccount.SelectedIndex <= 0 Then
                ShowErrorMessage("Please Select Widthdraw Cash/Bank Account.")
                Me.cmbDepositAccount.Focus()
                Return False
            End If
        End If
        If Me.cmbCompany.SelectedValue <= 0 Then
            msg_Error("Please select Company")
            Me.cmbCompany.Focus() : FormValidate = False : Exit Function
        End If
        ''Task#A2 12-06-2015 Check Vendor exist in combox list or not
        If Not Me.cmbVendor.IsItemInList Then
            msg_Error("Please select Vendor")
            Me.cmbVendor.Focus() : FormValidate = False : Exit Function
        End If
        If cmbVendor.Value > 0 AndAlso txtInvoiceNo.Text.Length > 0 Then
            If IsValidateInvoiceNo(txtInvoiceNo.Text, cmbVendor.Value, txtPONo.Text.Trim) = False Then
                txtInvoiceNo.Focus()
                FormValidate = False : Exit Function
            End If
        End If
        If Me.cmbVendor.Text = String.Empty Then
            msg_Error("Please select Vendor")
            Me.cmbVendor.Focus() : FormValidate = False : Exit Function
        End If
        ''End Task#A2 12-06-2015

        If cmbVendor.ActiveRow.Cells(0).Value <= 0 Then
            msg_Error("Please select Vendor")
            cmbVendor.Focus() : FormValidate = False : Exit Function
        End If

        If Not Me.grd.RowCount > 0 Then
            msg_Error(str_ErrorNoRecordFound)
            cmbItem.Focus() : FormValidate = False : Exit Function
        End If

        If getConfigValueByType("PurchaseAllowedWithPO") = "True" Then
            If Me.cmbPo.SelectedIndex = 0 Then
                msg_Error("Please select PO")
                Me.cmbPo.Focus()
                Return False
            End If
        End If


        'Task:2380 Validation Credit Sales
        'If CreditPurchase = False Then
        '    If Me.grd.RowCount > 0 Then
        '        If Val(Me.txtRecAmount.Text) = 0 Then
        '            Me.btnPayment_Click(Nothing, Nothing)
        '            ShowErrorMessage("Please Enter Cash Amount")
        '            Me.txtRecAmount.Focus()
        '            Return False
        '        End If
        '    End If
        'End If
        'End Task:2380

        'Task:2447 Validation On Batch No Field.
        If CheckDuplicateIRNo() = True Then
            ShowErrorMessage("Serial No Duplication.")
            Me.dtpPODate.Focus()
            Return False
        End If
        'Change by murtaza default currency rate(10/26/2022) 
        If cmbCurrency.SelectedValue <> BaseCurrencyId AndAlso Val(txtCurrencyRate.Text) = 1 Then
            msg_Error(cmbCurrency.Text + "Currency Rate cannot be 1")
            txtCurrencyRate.Focus() : FormValidate = False : Exit Function
        End If
        'Change by murtaza default currency rate(10/26/2022)
        If Convert.ToBoolean(getConfigValueByType("AllowAddZeroPriceOnPurchase").ToString.Replace("Error", "False").Replace("''", "False")) = False Then
            'TASK22 Validation On Price And Qty
            For Each jRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                If (Val(jRow.Cells("Rate").Value.ToString) = 0) Then
                    msg_Error("Rate is not greater than 0")
                    Return False
                    Exit For
                End If
                If (Not Val(jRow.Cells("ReceivedQty").Value.ToString) - Val(jRow.Cells("RejectedQty").Value.ToString) = 0) Then
                    If (Val(jRow.Cells("Qty").Value.ToString) = 0) Then
                        msg_Error("Qty is not greater than 0")
                        Return False
                        Exit For
                    End If
                End If
            Next
        Else
            For Each jRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                If (Val(jRow.Cells("Rate").Value.ToString) < 0) Then
                    msg_Error("Rate is not greater than 0")
                    Return False
                    Exit For
                End If
                If (Not Val(jRow.Cells("ReceivedQty").Value.ToString) - Val(jRow.Cells("RejectedQty").Value.ToString) = 0) Then
                    If (Val(jRow.Cells("Qty").Value.ToString) = 0) Then
                        msg_Error("Qty is not greater than 0")
                        Return False
                        Exit For
                    End If
                End If
            Next
        End If
        'End Task:2447
        'Task:4362 Apply Validation On Order Qty Exceed.
        If blnOrderQtyExceed = True Then
            If Me.cmbPo.SelectedIndex > 0 Then
                Dim objDt As New DataTable
                For Each Row As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows

                    objDt = GetDataTable("Select Detail.ArticleDefId, Detail.PurchaseOrderDetailId, IsNull(Detail.Qty, 0) As POQty, IsNull(Purchase.Qty, 0) As PQty, IsNull(DeliveredQty, 0) As DeliveredQty From PurchaseOrderDetailTable As Detail " _
                                         & " INNER JOIN PurchaseOrderMasterTable As Master ON Detail.PurchaseOrderId  = Master.PurchaseOrderId  " _
                                         & " LEFT OUTER JOIN (Select ArticleDefId, IsNull(PurchaseOrderDetailId, 0) As PurchaseOrderDetailId, Sum(IsNull(ReceivedQty, 0)) As Qty FROM ReceivingDetailTable As Detail INNER JOIN ReceivingMasterTable As Master ON Detail.ReceivingId  = Master.ReceivingId " _
                                         & " Where PurchaseOrderID  =" & cmbPo.SelectedValue & " Group By ArticleDefId, PurchaseOrderDetailId) " _
                                         & " As Purchase ON Detail.PurchaseOrderDetailId = Purchase.PurchaseOrderDetailId And Detail.ArticleDefId = Purchase.ArticleDefId  Where Master.PurchaseOrderId = " & cmbPo.SelectedValue & "")

                    If objDt IsNot Nothing Then
                        If objDt.Rows.Count > 0 Then
                            For Each grdRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                                For Each r As DataRow In objDt.Rows
                                    If grdRow.Cells(grdEnm.ArticleDefId).Value = Val(r.Item("ArticleDefId").ToString) AndAlso grdRow.Cells(grdEnm.PurchaseOrderDetailId).Value = Val(r.Item("PurchaseOrderDetailId").ToString) Then
                                        If IsEditMode Then
                                            ''TFS4360 : Ayesha Rehman : 04-09-2018 : Changes SQty to SOQty
                                            If (Val(r.Item("DeliveredQty").ToString) + Val(grdRow.Cells(grdEnm.ReceivedQty).Value) - Val(r.Item("PQty").ToString)) > Val(r.Item("POQty").ToString) Then
                                                ShowErrorMessage("Order [" & grdRow.Cells(grdEnm.Item).Value.ToString & "] qty exceed")
                                                grd.Focus()
                                                Return False
                                                'End If
                                            End If
                                        Else
                                            ''TFS4362 : Ayesha Rehman : 04-09-2018 : Added DeliveredQty to check whole qty in Purchase Order
                                            If (Val(r.Item("DeliveredQty").ToString) + Val(grdRow.Cells(grdEnm.ReceivedQty).Value)) > Val(r.Item("POQty").ToString) Then
                                                ShowErrorMessage("Order [" & grdRow.Cells(grdEnm.Item).Value.ToString & "] qty exceed")
                                                grd.Focus()
                                                Return False
                                            End If
                                        End If
                                    End If
                                Next
                            Next
                        End If
                    End If
                Next
            End If
        End If
        'End Task:4362
        'Task:4362 Apply Validation On GRN Qty Excess Qty
        If blnDeliveryQtyExceed = True Then
            Dim objDt As New DataTable
            For Each Row As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                If Row.Cells(grdEnm.ReceivingNoteId).Value > 0 Then
                    objDt = GetDataTable("SELECT RN.ArticleDefId, SUM(ISNULL(RN.ReceivedQty,0)) AS Qty, SUM(IsNull(P_DT.Qty,0)) as PQty FROM dbo.ReceivingNoteDetailTable AS RN LEFT OUTER JOIN dbo.ReceivingMasterTable AS Pur ON RN.ReceivingNoteId  = Pur.ReceivingNoteId  LEFT OUTER JOIN (SELECT ReceivingId, ArticleDefId, IsNull(ReceivedQty, 0) AS Qty FROM ReceivingDetailTable " & IIf(Me.BtnSave.Text = "&Update", " WHERE ReceivingId <> " & Val(Me.txtReceivingID.Text) & "", "") & ") P_DT ON P_DT.ReceivingId = Pur.ReceivingId AND  P_DT.ArticleDefID = RN.ArticleDefId  WHERE RN.ReceivingNoteId =" & Row.Cells(grdEnm.ReceivingNoteId).Value & " GROUP BY RN.ArticleDefId, Pur.ReceivingNoteId ")
                    If objDt IsNot Nothing Then
                        If objDt.Rows.Count > 0 Then
                            For Each grdRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                                For Each r As DataRow In objDt.Rows
                                    If (grdRow.Cells(grdEnm.ArticleDefId).Value = Val(r.Item("ArticleDefId").ToString)) Then
                                        If (grdRow.Cells(grdEnm.ReceivedQty).Value + Val(r.Item("PQty").ToString)) > Val(r.Item("Qty").ToString) Then
                                            ShowErrorMessage("Order [" & grdRow.Cells(grdEnm.Item).Value.ToString & "] qty exceed")
                                            grd.Focus()
                                            Return False
                                        End If
                                    End If
                                Next
                            Next
                        End If
                    End If
                End If
            Next
        End If
        'End Task:4362
        Dim StockInConfigration As String = "" ''1596
        ''Start Task 1596
        If Not getConfigValueByType("StockInConfigration").ToString = "Error" Then ''1596
            StockInConfigration = getConfigValueByType("StockInConfigration").ToString
        End If
        'ShowInformationMessage(StockInConfigration)
        For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
            If StockInConfigration.Equals("Required") AndAlso r.Cells(grdEnm.BatchNo).Value.ToString = String.Empty Then
                msg_Error("Please Enter Value in Batch No")
                Return False
                Exit For
            End If
        Next
        'End Task:1596
        ''Start TFS2988
        If IsEditMode = True Then
            If ValidateApprovalProcessMapped(Me.txtPONo.Text.Trim) Then
                If ValidateApprovalProcessInProgress(Me.txtPONo.Text.Trim) Then
                    msg_Error("Document is in Approval Process") : Return False : Exit Function
                End If
            End If
        End If
        ''End TFS2988

        'Dim strBudget As String
        'Dim dtBudget As DataTable
        'strBudget = "SELECT ISNULL(SOBudget,0) as SOBudget, Amount from tbldefCostCenter where CostCenterID = " & cmbProject.SelectedValue & ""
        'dtBudget = GetDataTable(strBudget)
        'If dtBudget.Rows.Count > 0 Then
        '    If dtBudget.Rows(0).Item(0) = "True" Then
        '        If Val(lblRemainingBudget.Text) < (Me.grd.GetTotal(Me.grd.RootTable.Columns("rate"), Janus.Windows.GridEX.AggregateFunction.Sum) + Me.grd.GetTotal(Me.grd.RootTable.Columns("Transportation_Charges"), Janus.Windows.GridEX.AggregateFunction.Sum) + Me.grd.GetTotal(Me.grd.RootTable.Columns("Custom_Charges"), Janus.Windows.GridEX.AggregateFunction.Sum) - Me.grd.GetTotal(Me.grd.RootTable.Columns("Discount_Price"), Janus.Windows.GridEX.AggregateFunction.Sum)) * (Me.grd.GetTotal(Me.grd.RootTable.Columns("TotalQty"), Janus.Windows.GridEX.AggregateFunction.Sum) * Val(txtCurrencyRate.Text)) Then
        '            msg_Error("Amount exceeds from SO Budget.") : Return False : Exit Function
        '        End If
        '    End If
        'End If
        Return True


    End Function
    Sub EditRecord()
        Try
            'If Not Me.grdSaved.RowCount > 0 Then Exit Sub
            'If Me.grd.RowCount > 0 Then
            '    If Not msg_Confirm(str_ConfirmGridClear) = True Then Exit Sub
            'End If

            'txtPONo.Text = grdSaved.CurrentRow.Cells(0).Value.ToString
            'dtpPODate.Value = CType(grdSaved.CurrentRow.Cells(1).Value, Date)
            'txtReceivingID.Text = grdSaved.CurrentRow.Cells("ReceivingId").Value
            ''TODO. ----
            'cmbVendor.Value = grdSaved.CurrentRow.Cells(3).Value

            'txtRemarks.Text = grdSaved.CurrentRow.Cells("Remarks").Value & ""
            'txtPaid.Text = grdSaved.CurrentRow.Cells("CashPaid").Value & ""
            ''Me.cmbSalesMan.SelectedValue = grdSaved.CurrentRow.Cells("EmployeeCode").Value.ToString
            'Me.cmbPo.SelectedValue = Me.grdSaved.CurrentRow.Cells("PoId").Value
            'Call DisplayDetail(grdSaved.CurrentRow.Cells("ReceivingId").Value)
            'GetTotal()
            'Me.SaveToolStripButton.Text = "&Update"
            Me.BtnSave.Text = "&Update"
            'Me.cmbPo.Enabled = False
            If blnUpdateAll = False Then
                If Not Me.grdSaved.RowCount > 0 Then Exit Sub
                If Me.grd.RowCount > 0 Then
                    If Not msg_Confirm(str_ConfirmGridClear) = True Then Exit Sub
                End If
            End If
            IsEditMode = True
            'FillCombo("Vendor") 'R933 Commented
            'FillCombo("CostCenter") 'R933 Commented
            'Me.FillCombo("SOComplete")

            ''Ayesha Rehman :TFS2375 :Making Approval Button Enable in Edit Mode
            Me.btnApprovalHistory.Visible = True
            Me.btnApprovalHistory.Enabled = True
            ''Ayesha Rehman :TFS2375 :End

            Me.cmbVendor.Enabled = IsDBNull(Me.grdSaved.GetRow.Cells("InvoiceID").Value)

            txtPONo.Text = grdSaved.CurrentRow.Cells(0).Value
            Me.GetSecurityRights()
            'Task 1592
            If grdSaved.CurrentRow.Cells(1).Value > Date.Today.ToString("yyyy-MM-dd 23:59:59") AndAlso IsDateChangeAllowed = False Then
                dtpPODate.MaxDate = dtpPODate.Value.AddMonths(3)
                dtpPODate.Value = CType(grdSaved.CurrentRow.Cells(1).Value, Date)
            Else
                dtpPODate.MaxDate = "9998/12/31"
                dtpPODate.Value = CType(grdSaved.CurrentRow.Cells(1).Value, Date)
            End If
            If Val(Me.grdSaved.CurrentRow.Cells("LocationId").Value.ToString) = Val(0) Then
                Me.cmbCompany.SelectedIndex = 0
            Else
                Me.cmbCompany.SelectedValue = Val(Me.grdSaved.CurrentRow.Cells("LocationId").Value.ToString)
            End If
            If IsEditMode = False Then
                Me.cmbCompany.Enabled = True
            Else
                Me.cmbCompany.Enabled = False
            End If
            txtReceivingID.Text = grdSaved.CurrentRow.Cells("ReceivingId").Value
            intReceivingNoteId = Val(Me.grdSaved.CurrentRow.Cells("ReceivingNoteId").Value.ToString)
            ReceivingId = intReceivingNoteId
            cmbVendor.Value = grdSaved.CurrentRow.Cells("VendorId").Value 'cmbVendor.FindStringExact((grdSaved.CurrentRow.Cells(3).Value))
            If Me.cmbVendor.ActiveRow Is Nothing Then
                ShowErrorMessage("Vendor is disable.")
                Exit Sub
            End If
            cmbPo.SelectedValue = Me.grdSaved.CurrentRow.Cells("PurchaseOrderID").Value
            'R933 Validate PO
            If cmbPo.SelectedValue Is Nothing Then
                Dim dt As New DataTable("PO", "PO")
                dt = CType(Me.cmbPo.DataSource, DataTable)
                dt.AcceptChanges()
                'dt.Columns.Add("PurchaseOrderID", GetType(System.Int32))
                'dt.Columns.Add("PurchaseOrderNo", GetType(System.String))
                'dt.Columns.Add("RefCMFADocId", GetType(System.Int32)) 'Task:2673 Added Column 

                Dim dr As DataRow
                dr = dt.NewRow
                dr(0) = Me.grdSaved.CurrentRow.Cells("PurchaseOrderID").Value
                dr(1) = Me.grdSaved.CurrentRow.Cells("PurchaseOrderNo").Value
                dr(4) = Val(Me.grdSaved.CurrentRow.Cells("RefCMFADocId").Value.ToString) 'Task:2673 RefCMFADocId Value Input In Row.
                dt.Rows.Add(dr)
                dt.AcceptChanges()
                'Me.cmbPo.DataSource = Nothing
                'Me.cmbPo.ValueMember = "PurchaseOrderID"
                'Me.cmbPo.DisplayMember = "PurchaseOrderNo"
                'Me.cmbPo.DataSource = dt
                Me.cmbPo.SelectedValue = Me.grdSaved.CurrentRow.Cells("PurchaseOrderID").Value
            End If
            'End R933
            txtRemarks.Text = grdSaved.CurrentRow.Cells("Remarks").Value & ""
            txtDcNo.Text = grdSaved.CurrentRow.Cells("DcNo").Value & ""
            txtPaid.Text = grdSaved.CurrentRow.Cells("CashPaid").Value & ""
            Me.txtDriverName.Text = grdSaved.GetRow.Cells("Driver_Name").Value.ToString
            Me.txtVhNo.Text = grdSaved.GetRow.Cells("Vehicle_No").Value.ToString
            If Not IsDBNull(grdSaved.GetRow.Cells("DcDate").Value) Then
                Me.dtpDcDate.Value = grdSaved.GetRow.Cells("DcDate").Value
            Else
                Me.dtpDcDate.Value = Now
                Me.dtpDcDate.Checked = False
            End If
            Me.txtDiscount.Text = Me.grdSaved.GetRow.Cells("Total_Discount_Amount").Value.ToString
            Me.txtInvoiceNo.Text = Me.grdSaved.GetRow.Cells("Vendor_Invoice_No").Value.ToString
            Me.cmbProject.SelectedValue = Me.grdSaved.GetRow.Cells("CostCenterId").Value.ToString
            Me.txtIGPNo.Text = Me.grdSaved.GetRow.Cells("IGPNo").Text.ToString
            Call DisplayDetail(grdSaved.CurrentRow.Cells("ReceivingId").Value)
            FillInwardExpense(grdSaved.CurrentRow.Cells("ReceivingId").Value, "PUR")
            Previouse_Amount = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum) + Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)
            'Me.cmbCurrency.SelectedValue = Me.grdSaved.GetRow.Cells("CurrencyType").Text.ToString
            'Me.cmbCurrency.Enabled = False
            Me.txtCurrencyRate.Text = Me.grdSaved.GetRow.Cells("CurrencyRate").Text.ToString
            Me.txtDueDays.Text = Val(Me.grdSaved.GetRow.Cells("DueDays").Value.ToString) ''07-Aug-2014 Task:2774 Imrna Ali Revised Invoice Based Aging Report (Ravi)
            If Me.cmbTransportationVendor.IsItemInList = True Then
                Me.cmbTransportationVendor.Value = Me.grdSaved.GetRow.Cells("Transportation_Vendor").Value
            End If
            If Me.cmbCustomVendor.IsItemInList = True Then
                Me.cmbCustomVendor.Value = Me.grdSaved.GetRow.Cells("Custom_Vendor").Value
            End If
            Me.txtGRNNo.Text = Me.grdSaved.GetRow.Cells("GRN No").Value.ToString
            Me.cmbPurchaseAccount.Value = Val(Me.grdSaved.GetRow.Cells("PurchaseAcId").Value.ToString) 'Task:2790 Get PurchaseAcId 
            Me.cmbInvoiceType.Text = Me.grdSaved.GetRow.Cells("InvoiceType").Value.ToString
            Me.txtTaxDeductPercent.Text = Val(Me.grdSaved.GetRow.Cells("TaxDeductionPercent").Value.ToString)
            Me.txtTaxDeductAmount.Text = Val(Me.grdSaved.GetRow.Cells("TaxDeductionAmount").Value.ToString)
            If IsDBNull(Me.grdSaved.GetRow.Cells("In Time").Value) Then
                Me.dtpArrivalTime.Value = Date.Now
            Else
                Me.dtpArrivalTime.Value = Me.grdSaved.GetRow.Cells("In Time").Value
            End If


            If IsDBNull(Me.grdSaved.GetRow.Cells("Out Time").Value) Then
                Me.dtpDepartureTime.Value = Date.Now
                Me.dtpDepartureTime.Checked = False
            Else
                Me.dtpDepartureTime.Value = Me.grdSaved.GetRow.Cells("Out Time").Value
                Me.dtpDepartureTime.Checked = True
            End If

            If flgPurchaseAccountFrontEnd = True Then
                Me.cmbPurchaseAccount.Visible = True
                Me.lblPurchaseAccount.Visible = True
            Else
                Me.cmbPurchaseAccount.Visible = False
                Me.lblPurchaseAccount.Visible = False
            End If
            'End Task:2790
            'GetTotal()
            If Me.cmbPo.SelectedValue > 0 Then
                Me.cmbVendor.Enabled = False
            Else
                Me.cmbVendor.Enabled = True
            End If


            If getConfigValueByType("AllowChangePO").ToString.ToUpper = "TRUE" Then
                Me.cmbPo.Enabled = True
            Else
                Me.cmbPo.Enabled = False
            End If
            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            Me.txtExpenseTotal.Text = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total Amount"), Janus.Windows.GridEX.AggregateFunction.Sum)
            If Me.grdSaved.GetRow.Cells("DiscountType").Value.ToString = "Flat" Then
                Me.rbtAdjFlat.Checked = True
                Me.txtAdjustment.Text = Val(Me.grdSaved.GetRow.Cells("AdjDiscount").Value.ToString)
            Else
                Me.rbtAdjPercentage.Checked = True
                Me.txtAdjustment.Text = Val(Me.grdSaved.GetRow.Cells("AdjDiscount").Value.ToString)
            End If

            'Dim strInv As String = "Select Count(*) From InvoiceAdjustmentTable WHERE InvoiceId=" & grdSaved.CurrentRow.Cells("ReceivingId").Value & " And InvoiceType='Purchase'"
            'Dim dtInv As New DataTable
            'dtInv = GetDataTable(strInv)
            'dtInv.AcceptChanges()
            'If dtInv IsNot Nothing Then
            '    If dtInv.Rows.Count > 0 Then
            '        If Val(dtInv.Rows(0).Item(0).ToString) > 0 Then
            '            Me.cmbVendor.Enabled = False
            '        End If
            '    End If
            'End If

            Me.BtnSave.Text = "&Update"
            'Me.GetSecurityRights()
            Me.chkPost.Checked = Me.grdSaved.CurrentRow.Cells("Post").Value
            If blnUpdateAll = False Then Me.UltraTabControl1.SelectedTab = Me.UltraTabPageControl1.Tab : Me.tbPurchaseDetail.SelectedTab = Me.tbPurchaseDetail.Tabs(0).TabPage.Tab
            VoucherDetail(Me.txtPONo.Text)
            Me.lblPrintStatus.Text = "Print Status: " & Me.grdSaved.GetRow.Cells("Print Status").Text.ToString
            '//Start TASK # 1592
            '25-OCT-2017: Ayesha Rehman: If user dont have update rights then btnsave should not be enable true
            If BtnSave.Enabled = True Then
                If grdSaved.CurrentRow.Cells(1).Value > Date.Today.ToString("yyyy-MM-dd 23:59:59") AndAlso IsDateChangeAllowed = False Then
                    Me.BtnSave.Enabled = False
                    ErrorProvider1.SetError(Me.Label2, "Future Date can not be edit")
                    ErrorProvider1.BlinkRate = 1000
                    ErrorProvider1.BlinkStyle = ErrorBlinkStyle.AlwaysBlink
                Else
                    Me.BtnSave.Enabled = True
                    ErrorProvider1.Clear()
                End If
            End If
            'End Task # 1592
            If flgDateLock = True Then
                If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00"))) Then
                    'ShowErrorMessage("Previous date work not allowed") : Exit Sub
                    Me.dtpPODate.Enabled = False
                Else
                    Me.dtpPODate.Enabled = True
                End If
            Else
                Me.dtpPODate.Enabled = True
            End If
            'Altered Against Task# 2015060001 Ali Ansari
            'Get no of attached files
            Dim intCountAttachedFiles As Integer = 0I
            If Me.BtnSave.Text <> "&Save" Then
                If Me.grdSaved.RowCount > 0 Then
                    intCountAttachedFiles = Val(grdSaved.CurrentRow.Cells("No Of Attachment").Value)
                    Me.btnAttachment.Text = "Attachment (" & intCountAttachedFiles & ")"
                End If
            End If
            'Altered Against Task# 2015060001 Ali Ansari
            ''16-Dec-2013 R934   M Ijaz Javed       Hide Buttons Edit,Delete and Print on Load Form
            Me.BtnDelete.Visible = True
            Me.BtnPrint.Visible = True
            '''''''''''''''''''''''''''
            Me.CtrlGrdBar1_Load(Nothing, Nothing)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    '' ReqId-899 Added field TaxPercent From Purchase Order Detail Table
    Private Sub DisplayPODetail(ByVal ReceivingID As Integer)
        Try


            Dim str As String
            'Dim i As Integer

            'str = "SELECT Article_Group.ArticleGroupName AS Category, Article.ArticleDescription AS item, Recv_D.ArticleSize AS unit,  Recv_D.Sz1 - Isnull(DeliveredQty , 0) AS ReceivedQty, 0 as RejectedQty, 0 AS Qty, Recv_D.Price, " _
            '      & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price  - isnull(DeliveredQty,0) * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty  - isnull(DeliveredQty,0) * Recv_D.Price END  AS Total, " _
            '      & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as PackQty,Recv_D.Price as CurrentPrice, 'xxxx' as BatchNo FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '      & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            '      & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '      & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"

            'str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit,  Convert(float, (Recv_D.Sz1 - Isnull(DeliveredQty , 0))) AS ReceivedQty, Convert(float, 0) as RejectedQty, Convert(float, 0) AS Qty, Recv_D.Price as Rate, 0 As TaxPercent, 0 as TaxAmount,  " _
            '  & " CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price))  ELSE Convert(float, ((Recv_D.Sz1 * Recv_D.Price) * Article.PackQty))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price)) END  AS Total,  0 as Transportation_Charges, " _
            '  & " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty, Recv_D.Price as CurrentPrice, 0 as PackPrice, 0 as BatchId, getDate() as ExpiryDate,  '' as BatchNo , '' as Comments  FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '  & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            '  & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '  & " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
            '  & " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId  " _
            '  & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"

            'Changing against request no 828 by imran ali 18-9-2013 add column of discount Price
            '' 
            ' str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit,  Convert(float, (Recv_D.Sz1 - Isnull(DeliveredQty , 0))) AS ReceivedQty, Convert(float, 0) as RejectedQty, Convert(float, 0) AS Qty, Recv_D.Price as Rate, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0 as TaxAmount,  " _
            '& " CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price))  ELSE Convert(float, ((Recv_D.Sz1 * Recv_D.Price) * Article.PackQty))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price)) END  AS Total,  0 as Transportation_Charges, 0 as Discount_Price, " _
            '& " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty, Recv_D.Price as CurrentPrice, 0 as PackPrice, 0 as BatchId, getDate() as ExpiryDate,  '' as BatchNo , '' as Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc  , Isnull(Article_Group.SubSubId,0) as PurchaseAccountId  FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '& " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            '& " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '& " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
            '& " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId  " _
            '& " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"
            'Before against task:2374
            ' '' ReqId-928 Comments Fields From Purchase Order Detail Table 
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit,  Convert(float, (Recv_D.Sz1 - Isnull(DeliveredQty , 0))) AS ReceivedQty, Convert(float, 0) as RejectedQty, Convert(float, 0) AS Qty, Recv_D.Price as Rate, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0 as TaxAmount,  " _
            '  & " CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price))  ELSE Convert(float, ((Recv_D.Sz1 * Recv_D.Price) * Article.PackQty))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price)) END  AS Total,  0 as Transportation_Charges, 0 as Discount_Price, " _
            '  & " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty, Recv_D.Price as CurrentPrice, 0 as PackPrice, 0 as BatchId, getDate() as ExpiryDate,  '' as BatchNo , Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc  , Isnull(Article_Group.SubSubId,0) as PurchaseAccountId  FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '  & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            '  & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '  & " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
            '  & " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId  " _
            '  & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"
            'Task:2374 Added Column Total Amount And Change Index Position Of Total
            '' ReqId-928 Comments Fields From Purchase Order Detail Table 
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit,  Convert(float, (Recv_D.Sz1 - Isnull(DeliveredQty , 0))) AS ReceivedQty, Convert(float, 0) as RejectedQty, Convert(float, 0) AS Qty, Recv_D.Price as Rate, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price))  ELSE Convert(float, ((Recv_D.Sz1 * Recv_D.Price) * Article.PackQty))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price)) END  AS Total,IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0 as TaxAmount,  " _
            '  & " Convert(float,0) as [Total Amount],  0 as Transportation_Charges, 0 as Discount_Price, " _
            '  & " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty, Recv_D.Price as CurrentPrice, 0 as PackPrice, 0 as BatchId, getDate() as ExpiryDate,  '' as BatchNo , Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc  , Isnull(Article_Group.SubSubId,0) as PurchaseAccountId  FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '  & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            '  & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '  & " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
            '  & " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId  " _
            '  & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"
            'End Task:2374


            ''03-Feb-2014          Task:2407    Imran Ali       unit of measurement on GRN and purchase window.
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit,  Convert(float, (Recv_D.Sz1 - Isnull(DeliveredQty , 0))) AS ReceivedQty, Convert(float, 0) as RejectedQty, Convert(float, 0) AS Qty, Recv_D.Price as Rate, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price))  ELSE Convert(float, ((Recv_D.Sz1 * Recv_D.Price) * Article.PackQty))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price)) END  AS Total,IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0 as TaxAmount,  " _
            '             & " Convert(float,0) as [Total Amount],  0 as Transportation_Charges, 0 as Discount_Price, " _
            '             & " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty, Recv_D.Price as CurrentPrice, 0 as PackPrice, 0 as BatchId, '' as BatchNo , Convert(DateTime, null) as ExpiryDate,   Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc  , Isnull(Article_Group.SubSubId,0) as PurchaseAccountId  FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '             & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            '             & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '             & " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
            '             & " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId " _
            '             & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"
            'TaskM106151 Added Columns ReceivingDetailId, PurchaseReturnQty 
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, 0 as X_Tray_Weights, 0 as X_Gross_Weights, 0 as X_Net_Weights, 0 as Y_Gross_Weights, 0 as Y_Tray_Weights, 0 as Y_Net_Weights, Convert(float, (Recv_D.Sz1 - Isnull(DeliveredQty , 0))) AS ReceivedQty, Convert(float, 0) as RejectedQty, Convert(float, 0) AS Qty, Recv_D.Price as Rate, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price))  ELSE Convert(float, ((Recv_D.Sz1 * Recv_D.Price) * Article.PackQty))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price)) END  AS Total,IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0 as TaxAmount, IsNull(Recv_D.AdTax_Percent,0) as AdTax_Percent, IsNull(Recv_D.AdTax_Amount,0) as AdTax_Amount, " _
            '           & " Convert(float,0) as [Total Amount],  0 as Transportation_Charges, 0 as Discount_Price, " _
            '           & " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty, Recv_D.Price as CurrentPrice, 0 as PackPrice, 0 as BatchId, '' as BatchNo , Convert(DateTime, null) as ExpiryDate,   Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc  , Isnull(Article_Group.SubSubId,0) as PurchaseAccountId, IsNull(Recv_D.Item_Wise_Disc,0) as ItemWiseDisc ,0 as ReceivingDetailId, 0.0 as PurchaseReturnQty,0 as ReceivingNoteDetailId, Recv_D.PurchaseOrderDetailId  FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '           & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            '           & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '           & " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
            '           & " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId " _
            '           & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"
            'End TaskM106151
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, 0 as X_Tray_Weights, 0 as X_Gross_Weights, 0 as X_Net_Weights, 0 as Y_Gross_Weights, 0 as Y_Tray_Weights, 0 as Y_Net_Weights, Convert(float, (Recv_D.Sz1 - Isnull(DeliveredQty , 0))) AS ReceivedQty, Convert(float, 0) as RejectedQty, Convert(float, 0) AS Qty, Recv_D.Price as CurrentPrice, 0 as RateDiscPercent, Recv_D.Price as Rate, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price))  ELSE Convert(float, ((Recv_D.Sz1 * Recv_D.Price) * Article.PackQty))  - Convert(float, (isnull(DeliveredQty,0) * Recv_D.Price)) END  AS Total,IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0 as TaxAmount, IsNull(Recv_D.AdTax_Percent,0) as AdTax_Percent, IsNull(Recv_D.AdTax_Amount,0) as AdTax_Amount, " _
            '          & " Convert(float,0) as [Total Amount],  0 as Transportation_Charges, 0 as Discount_Price, " _
            '          & " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty,  0 as PackPrice, 0 as BatchId, '' as BatchNo , Convert(DateTime, null) as ExpiryDate,   Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc  , Isnull(Article_Group.SubSubId,0) as PurchaseAccountId, IsNull(Recv_D.Item_Wise_Disc,0) as ItemWiseDisc ,0 as ReceivingDetailId, 0.0 as PurchaseReturnQty,0 as ReceivingNoteDetailId, Recv_D.PurchaseOrderDetailId  FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
            '          & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _Recv_D.BaseCurrencyId As BaseCurrencyId , Recv_D.BaseCurrencyRate As BaseCurrencyRate, Recv_D.CurrencyId As  CurrencyId, Recv_D.CurrencyRate As CurrencyRate,  Recv_D.CurrencyAmount As CurrencyAmount 
            '          & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
            '          & " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
            '          & " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId " _
            '          & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"
            'End Task:2407
            '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
            ''TFS1391 Added column ReceivingNoteId
            str = "SELECT Recv_D.LocationId, Article.ArticleCode, Article.ArticleDescription AS item, Recv_D.AlternativeItem, ArticleColorDefTable.ArticleColorName AS Color,dbo.ArticleSizeDefTable.ArticleSizeName AS Size, Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, 0 as X_Tray_Weights, 0 as X_Gross_Weights, 0 as X_Net_Weights, 0 as Y_Gross_Weights, 0 as Y_Tray_Weights, 0 as Y_Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), (Recv_D.Sz1 - Isnull(DeliveredQty , 0)), 1) AS ReceivedQty, Convert(Decimal(18, " & DecimalPointInQty & "), 0) as RejectedQty, Convert(Decimal(18, " & DecimalPointInQty & "), 0) AS Qty, IsNull(Recv_D.Qty,0) AS Gross_Qty, ISNULL(NULL,0) as Column1, ISNULL(NULL,0) as Column2,  ISNULL(NULL,0) as Column3, Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Qty, 0)-IsNull(Recv_D.ReceivedTotalQty, 0), 1) As TotalQty, Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Qty, 0)-IsNull(Recv_D.ReceivedTotalQty, 0), 1) as Vendor_Qty, Convert(Decimal(18, " & DecimalPointInQty & "), 0) AS Deduction, Convert(Decimal(18, " & DecimalPointInQty & "), 0) as VendorNetQty, Recv_D.CurrentPrice, Case When IsNull(Recv_D.CurrentPrice,0) > (IsNull(Price,0)) then ((IsNull(Recv_D.CurrentPrice,0)-IsNull(Price,0))/IsNull(Recv_D.CurrentPrice,0))*100 else 0 end as RateDiscPercent, Recv_D.Price as Rate , Recv_D.BaseCurrencyId As BaseCurrencyId , Recv_D.BaseCurrencyRate As BaseCurrencyRate, Recv_D.CurrencyId As  CurrencyId, Recv_D.CurrencyRate As CurrencyRate,  Recv_D.CurrencyAmount As CurrencyAmount , Convert(float, 0) As [TotalCurrencyAmount], Convert(float, (Recv_D.Qty * Recv_D.Price))  - Convert(float, (isnull(ReceivedTotalQty,0) * Recv_D.Price)) AS Total,IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.00 as TaxAmount,  0.00 as CurrencyTaxAmount, IsNull(Recv_D.AdTax_Percent,0) as AdTax_Percent, IsNull(Recv_D.AdTax_Amount,0) as AdTax_Amount, 0 As CurrencyAdTaxAmount, " _
                    & " Convert(float,0) as [Total Amount],  0.00 as Transportation_Charges, 0.00 as Custom_Charges, 0.00 as Discount_Price, " _
                    & " Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 as PackQty,  0 as PackPrice, 0 as BatchId, '' as BatchNo , getDate() as ExpiryDate,'' as Origin,   Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc  , Isnull(Article_Group.SubSubId,0) as PurchaseAccountId, IsNull(Recv_D.Item_Wise_Disc,0) as ItemWiseDisc ,0 as ReceivingDetailId, 0.0 as PurchaseReturnQty,0 as ReceivingNoteDetailId, Recv_D.PurchaseOrderDetailId, 0 AS ReceivingNoteId, Recv_D.AlternativeItemId FROM dbo.PurchaseOrderDetailTable Recv_D INNER JOIN " _
                    & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
                    & " dbo.ArticleGroupDefTable Article_Group ON Article.ArticleGroupId = Article_Group.ArticleGroupId " _
                    & " LEFT OUTER JOIN  dbo.ArticleColorDefTable ON Article.ArticleColorId = dbo.ArticleColorDefTable.ArticleColorId " _
                    & " LEFT OUTER JOIN ArticleSizeDefTable ON Article.SizeRangeId = dbo.ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN tblDefLocation Loc ON Loc.Location_Id = Recv_D.LocationId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId " _
                    & " Where Recv_D.PurchaseOrderID =" & ReceivingID & " and  Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0"

            'Dim objCommand As New OleDbCommand
            'Dim objCon As OleDbConnection
            'Dim objDataAdapter As New OleDbDataAdapter
            'Dim objDataSet As New DataSet

            'objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

            'If objCon.State = ConnectionState.Open Then objCon.Close()

            'objCon.Open()
            'objCommand.Connection = objCon
            'objCommand.CommandType = CommandType.Text


            'objCommand.CommandText = str

            'objDataAdapter.SelectCommand = objCommand
            'objDataAdapter.Fill(objDataSet)
            ''grd.Rows.Clear()
            'objDataSet.Tables(0).Columns("Qty").Expression = "ReceivedQty - RejectedQty"
            ''objDataSet.Tables(0).Columns("Total").Expression = "[Qty] * [Price]"
            'For i = 0 To objDataSet.Tables(0).Rows.Count - 1
            '    'grd.Rows.Add(Me.cmbCategory.Text, objDataSet.Tables(0).Rows(i)(1), objDataSet.Tables(0).Rows(i)("BatchNo"), objDataSet.Tables(0).Rows(i)(2), objDataSet.Tables(0).Rows(i)(3), objDataSet.Tables(0).Rows(i)(4), objDataSet.Tables(0).Rows(i)(5), objDataSet.Tables(0).Rows(i)(6), objDataSet.Tables(0).Rows(i)(7), objDataSet.Tables(0).Rows(i)(8), objDataSet.Tables(0).Rows(i)(9), Me.cmbCategory.SelectedValue)

            '    'grd.Rows(i).Cells(0).Value = objDataSet.Tables(0).Rows(i)(0)
            '    'grd.Rows(i).Cells(1).Value = objDataSet.Tables(0).Rows(i)(1)
            '    ''selecting the item
            '    Me.cmbItem.Value = objDataSet.Tables(0).Rows(i)("ArticleDefId")
            '    Me.cmbItem_Leave(Nothing, Nothing)

            '    ''selecting batch no
            '    Me.cmbBatchNo.Text = objDataSet.Tables(0).Rows(i)("BatchNo")
            '    'Me.cmbBatchNo_Leave(Nothing, Nothing)

            '    ''selecting unit
            '    Me.cmbUnit.Text = objDataSet.Tables(0).Rows(i)(2)
            '    Me.cmbUnit_SelectedIndexChanged(Nothing, Nothing)

            '    Me.txtQty.Text = objDataSet.Tables(0).Rows(i)(3)
            '    txtPackQty.Text = "1"

            '    Me.txtQty_LostFocus(Nothing, Nothing)
            '    Me.txtQty_TextChanged(Nothing, Nothing)
            '    ''selecing rate
            '    Me.txtRate.Text = objDataSet.Tables(0).Rows(i)(6)

            '    '*************** Chnage Calculation 17-01-2012 By Imran Ali
            '    ' Me.txtTotal.Text = Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
            '    If Me.cmbUnit.Text = "Pack" Then
            '        Me.txtTotal.Text = Val(Me.txtRate.Text) * (Val(objDataSet.Tables(0).Rows(i)(3)) * Val(objDataSet.Tables(0).Rows(i)(8)))
            '    Else
            '        Me.txtTotal.Text = Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
            '    End If
            '    Me.btnAdd_Click(Nothing, Nothing)
            'Next
            Dim dtDisplayDetail As DataTable = GetDataTable(str)
            'dtDisplayDetail.Columns.Add("TaxAmount", GetType(System.Double))
            dtDisplayDetail.AcceptChanges()
            'dtDisplayDetail.Columns("Qty").Expression = "ReceivedQty-RejectedQty"
            'dtDisplayDetail.Columns("Total").Expression = "IIF(Unit='Pack', ((PackQty*Qty)*Rate), (Qty*Rate))"


            'dtDisplayDetail.Columns("TaxAmount").Expression = "((IIF(Unit='Pack', ((PackQty*Qty)*(Rate-Discount_Price)), (Qty*(Rate-Discount_Price)))*TaxPercent)/100)"
            'dtDisplayDetail.Columns("X_Net_Weights").Expression = "(IsNull(X_Gross_Weights,0)-IsNull(X_Tray_Weights,0))"
            'dtDisplayDetail.Columns("Y_Net_Weights").Expression = "(IsNull(Y_Gross_Weights,0)-IsNull(Y_Tray_Weights,0))"
            'dtDisplayDetail.Columns("Qty").Expression = "IsNull(ReceivedQty,0)-IsNull(RejectedQty,0)"
            'dtDisplayDetail.Columns("Total").Expression = "IsNull(TotalQty,0)*IsNull(Rate,0)"
            ''dtDisplayDetail.Columns("TaxAmount").Expression = "((IIF(Unit='Pack', ((Isnull(PackQty,0)*IsNull(Qty,0))*(IsNull(Rate,0)-IsNull(Discount_Price,0))), (IsNull(Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))))*IsNull(TaxPercent,0))/100)"
            'dtDisplayDetail.Columns("TaxAmount").Expression = "((((IsNull(TotalQty,0)* IsNull(Rate,0))-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100)"
            ''TASK-TFS-51 Set Expression for AdTax Amount
            'dtDisplayDetail.Columns("AdTax_Amount").Expression = "((((IsNull(TotalQty,0)* IsNull(Rate,0))-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            'dtDisplayDetail.Columns("Total Amount").Expression = "IsNull([Total],0) + (IsNull([TaxAmount],0)+IsNull([AdTax_Amount],0))" 'Task:2374 Show Total Amount
            ''END TASK-TFS-51

            dtDisplayDetail.Columns("X_Net_Weights").Expression = "(IsNull(X_Gross_Weights,0)-IsNull(X_Tray_Weights,0))"
            dtDisplayDetail.Columns("Y_Net_Weights").Expression = "(IsNull(Y_Gross_Weights,0)-IsNull(Y_Tray_Weights,0))"
            dtDisplayDetail.Columns("Qty").Expression = "IsNull(ReceivedQty,0)-IsNull(RejectedQty,0)"
            'dtDisplayDetail.Columns("Total").Expression = "IIF(Unit='Pack', ((IsNull(PackQty,0)*IsNull(Qty,0))*IsNull(Rate,0)), (IsNull(Qty,0)*IsNull(Rate,0)))"
            'dtDisplayDetail.Columns("Total").Expression = "IsNull(TotalQty,0)*IsNull(Rate,0)*CurrencyRate"
            dtDisplayDetail.Columns("CurrencyAmount").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))*IsNull(Rate,0)"
            dtDisplayDetail.Columns("Total").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))*IsNull(Rate,0)* CurrencyRate"
            'dtDisplayDetail.Columns("TaxAmount").Expression = "((IIF(Unit='Pack', ((Isnull(PackQty,0)*IsNull(Qty,0))*(IsNull(Rate,0)-IsNull(Discount_Price,0))), (IsNull(Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))))*IsNull(TaxPercent,0))/100)"
            'dtDisplayDetail.Columns("TaxAmount").Expression = "((((IsNull(TotalQty,0)* IsNull(Rate,0))-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100)"
            dtDisplayDetail.Columns("CurrencyTaxAmount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100) / CurrencyRate"
            dtDisplayDetail.Columns("TaxAmount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100)"
            'dtDisplayDetail.Columns("CurrencyTaxAmount").Expression = "((((CurrencyAmount)-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100)"
            dtDisplayDetail.Columns("CurrencyTaxAmount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100) / CurrencyRate"
            dtDisplayDetail.Columns("VendorNetQty").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))"
            'TASK-TFS-51 Set Expression for AdTax Amount
            'dtDisplayDetail.Columns("AdTax_Amount").Expression = "((IIF(Unit='Pack', ((Isnull(PackQty,0)*IsNull(Qty,0))*(IsNull(Rate,0)-IsNull(Discount_Price,0))), (IsNull(Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))))*IsNull(AdTax_Percent,0))/100)"
            'dtDisplayDetail.Columns("AdTax_Amount").Expression = "((((IsNull(TotalQty,0)* IsNull(Rate,0))-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            dtDisplayDetail.Columns("AdTax_Amount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            dtDisplayDetail.Columns("CurrencyAdTaxAmount").Expression = "((((CurrencyAmount)-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            dtDisplayDetail.Columns("Total Amount").Expression = "IsNull([Total],0) + (IsNull([TaxAmount],0)+IsNull([AdTax_Amount],0))" 'Task:2374 Show Total Amount
            dtDisplayDetail.Columns("TotalCurrencyAmount").Expression = "IsNull([CurrencyAmount],0) + (IsNull([CurrencyTaxAmount],0)+IsNull([CurrencyAdTaxAmount],0))"
            'dtDisplayDetail.Columns("VendorNetQty").Expression = "(IsNull(Vendor_Qty,0)-(IsNull(Deduction,0)))"
            'dtDisplayDetail.Columns("Vendor_Qty").Expression = "IsNull(TotalQty, 0)-IsNull(Deduction, 0)"
            'dtDisplayDetail.Columns("AfterDeductionQty").Expression = "(isnull(TotalQty,0)-(IsNull(BardanaDeduction, 0)+ISNULL(OtherDeduction, 0)))"
            'Me.grd.DataSource = Nothing
            Me.grd.DataSource = dtDisplayDetail
            'If dtDisplayDetail.Rows.Count > 0 Then
            '    If IsDBNull(dtDisplayDetail.Rows.Item(0).Item("CurrencyId")) Or Val(dtDisplayDetail.Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
            '        'Me.cmbCurrency.SelectedValue = Nothing
            '        Me.cmbCurrency.Enabled = False
            '    Else
            '        Me.cmbCurrency.SelectedValue = Val(dtDisplayDetail.Rows.Item(0).Item("CurrencyId").ToString)
            '        Me.cmbCurrency.Enabled = False
            '    End If
            'End If
            ApplyGridSettings()
            FillCombo("grdLocation")
            FillInwardExpense(ReceivingID, "PO")
            'Me.CtrlGrdBar1_Load(Nothing, Nothing)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub DisplayDetail(ByVal ReceivingID As Integer)
        Try
            Dim str As String
            'Dim i As Integer
            'str = "SELECT tblDefLocation.Location_code AS Category, Article.ArticleDescription AS item, Recv_D.ArticleSize AS unit, IsNull(Recv_D.ReceivedQty,0) As ReceivedQty, IsNull(Recv_D.RejectedQty,0) as RejectedQty, Recv_D.Sz1 AS Qty, Recv_D.Price, " _
            '      & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty END AS Total, " _
            '      & " Article.ArticleGroupId, Recv_D.ArticleDefId,Recv_D.Sz7 as PackQty,Recv_D.CurrentPrice,isnull(Recv_D.BatchNo,'xxxx') as BatchNo, Recv_D.BatchID, recv_D.LocationId as LocationId FROM dbo.ReceivingDetailTable Recv_D INNER JOIN " _
            '      & " dbo.ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId Inner JOIN " _
            '      & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id " _
            '      & " Where Recv_D.ReceivingID =" & ReceivingID & ""

            ''************************* Add 2 Columns Color And Size + Unit here.... By Imran 07-02-2012 12:33:00 PM
            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.ReceivedQty, 0) " _
            '      & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Recv_D.Price as Rate, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.ExpiryDate, getDate()) as ExpiryDate, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.Comments  " _
            '      & " FROM   ReceivingDetailTable Recv_D INNER JOIN " _
            '      & "        ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
            '      & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
            '      & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
            '      & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId " _
            '      & " Where Recv_D.ReceivingID =" & ReceivingID & ""
            'Before against task:2374
            ''changing against request no 828 by imran ali add column of discount_price
            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.ReceivedQty, 0) " _
            '    & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.ExpiryDate, getDate()) as ExpiryDate, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article_Group.SubSubId,0) as PurchaseAccountId   " _
            '    & " FROM   ReceivingDetailTable Recv_D INNER JOIN " _
            '    & "        ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
            '    & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
            '    & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
            '    & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN ArticleGroupDefTable Article_Group on Article_Group.ArticleGroupId = Article.ArticleGroupId " _
            '    & " Where Recv_D.ReceivingID =" & ReceivingID & ""

            'Task:2374 Added Column Total Amount And Change Index Position Of Total
            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.ReceivedQty, 0) " _
            '    & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate,CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, Convert(float,0) as [Total Amount], Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.ExpiryDate, getDate()) as ExpiryDate, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article_Group.SubSubId,0) as PurchaseAccountId   " _
            '    & " FROM   ReceivingDetailTable Recv_D INNER JOIN " _
            '    & "        ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
            '    & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
            '    & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
            '    & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN ArticleGroupDefTable Article_Group on Article_Group.ArticleGroupId = Article.ArticleGroupId " _
            '    & " Where Recv_D.ReceivingID =" & ReceivingID & ""
            'End Task:2374
            ''03-Feb-2014          Task:2407    Imran Ali       unit of measurement on GRN and purchase window.
            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size, Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.ReceivedQty, 0) " _
            '    & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate,CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, Convert(float,0) as [Total Amount], Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.ExpiryDate,  Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article_Group.SubSubId,0) as PurchaseAccountId   " _
            '    & " FROM   ReceivingDetailTable Recv_D INNER JOIN " _
            '    & "        ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
            '    & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
            '    & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
            '    & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN ArticleGroupDefTable Article_Group on Article_Group.ArticleGroupId = Article.ArticleGroupId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId   " _
            '    & " Where Recv_D.ReceivingID =" & ReceivingID & ""
            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, Article.ArticleColorName AS Color,Article.ArticleSizeName AS Size, Article.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.ReceivedQty, 0) " _
            '   & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate,CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, Convert(float,0) as [Total Amount], Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.ExpiryDate,  Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as PurchaseAccountId   " _
            '   & " FROM   ReceivingDetailTable Recv_D INNER JOIN " _
            '   & "        ArticleDefView Article   On Article.ArticleId = Recv_D.ArticleDefID " _
            '   & " Where Recv_D.ReceivingID =" & ReceivingID & ""
            'TaskM106151 Added Columns ReceivingDetailId, PurchaseReturnQty


            'Before 'TASK-TFS-51
            '  str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, Article.ArticleColorName AS Color,Article.ArticleSizeName AS Size, Article.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit,   IsNull(Recv_D.X_Tray_Weights,0) as X_Tray_Weights,IsNull(Recv_D.X_Gross_Weights,0) as X_Gross_Weights, IsNull(Recv_D.X_Net_Weights,0) as X_Net_Weights, IsNull(Recv_D.Y_Gross_Weights,0) as Y_Gross_Weights, IsNull(Recv_D.Y_Tray_Weights,0) as Y_Tray_Weights, IsNull(Recv_D.Y_Net_Weights,0) as Y_Net_Weights,ISNULL(Recv_D.ReceivedQty, 0) " _
            '& "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate,CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, Convert(float,0) as [Total Amount], Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.ExpiryDate,  Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as PurchaseAccountId, IsNull(Recv_D.Item_Wise_Disc,0) as ItemWiseDisc ,Recv_D.ReceivingDetailId, IsNull(Recv_D.PurchaseReturnQty,0) as PurchaseReturnQty   " _
            '& " FROM   ReceivingDetailTable Recv_D INNER JOIN " _
            '& "        ArticleDefView Article   On Article.ArticleId = Recv_D.ArticleDefID " _
            '& " Where Recv_D.ReceivingID =" & ReceivingID & ""
            'TASK-TFS-51 Added new fields AdTax_Percent and AdTax_Amount
            '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
            ''TFS1391 Added column ReceivingNoteId
            str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, Recv_D.AlternativeItem, Article.ArticleColorName AS Color,Article.ArticleSizeName AS Size, Article.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit,   IsNull(Recv_D.X_Tray_Weights,0) as X_Tray_Weights,IsNull(Recv_D.X_Gross_Weights,0) as X_Gross_Weights, IsNull(Recv_D.X_Net_Weights,0) as X_Net_Weights, IsNull(Recv_D.Y_Gross_Weights,0) as Y_Gross_Weights, IsNull(Recv_D.Y_Tray_Weights,0) as Y_Tray_Weights, IsNull(Recv_D.Y_Net_Weights,0) as Y_Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), ISNULL(Recv_D.ReceivedQty, 0), 1) " _
                & "        AS ReceivedQty, Convert(Decimal(18, " & DecimalPointInQty & "), ISNULL(Recv_D.RejectedQty, 0), 1) AS RejectedQty, Convert(Decimal(18, " & DecimalPointInQty & "), Recv_D.Sz1, 1) AS Qty, CASE WHEN IsNull(Recv_D.Gross_Quantity,0) = 0 THEN Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Qty, 0), 1) ELSE Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Gross_Quantity, 0), 1) END AS Gross_Qty, ISNULL(Recv_D.Column1,0) as Column1, ISNULL(Recv_D.Column2,0) as Column2,  ISNULL(Recv_D.Column3,0) as Column3, Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Qty, 0), 1) As TotalQty, CASE WHEN IsNull(Recv_D.Vendor_Total_Quantity,0) = 0 THEN Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Qty, 0), 1) ELSE Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Vendor_Total_Quantity, 0), 1) END as Vendor_Qty, Convert(Decimal(18, " & DecimalPointInQty & "), IsNull(Recv_D.OtherDeduction, 0)) AS Deduction, Convert(Decimal(18, " & DecimalPointInQty & "), 0) as VendorNetQty, Recv_D.CurrentPrice, Case When IsNull(Recv_D.CurrentPrice,0) > (IsNull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0)) then ((IsNull(Recv_D.CurrentPrice,0)-IsNull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0))/IsNull(Recv_D.CurrentPrice,0))*100 else 0 end as RateDiscPercent, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate , IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As  CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount , Convert(float, 0) As [TotalCurrencyAmount], Convert(float, (Recv_D.Qty * Recv_D.Price * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End)) AS Total, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, 0.00 As [CurrencyTaxAmount], IsNull(Recv_D.AdTax_Percent,0) as AdTax_Percent,  IsNull(Recv_D.AdTax_Amount,0) as AdTax_Amount, Convert(Float, 0) As CurrencyAdTaxAmount, Convert(float,0) as [Total Amount], Isnull(Recv_D.Transportation_Charges,0.00) as Transportation_Charges, Isnull(Recv_D.Custom_Charges,0.00) as Custom_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.ExpiryDate,ISNULL(Recv_D.Origin, '') as Origin,  Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as PurchaseAccountId, IsNull(Recv_D.Item_Wise_Disc,0) as ItemWiseDisc ,Recv_D.ReceivingDetailId, IsNull(Recv_D.PurchaseReturnQty,0) as PurchaseReturnQty,IsNull(Recv_D.ReceivingNoteDetailId,0) as ReceivingNoteDetailId, IsNull(Recv_D.PurchaseOrderDetailId,0) as PurchaseOrderDetailId, IsNull(Recv_D.ReceivingNoteId, 0) As ReceivingNoteId, Recv_D.AlternativeItemId " _
                & " FROM   ReceivingDetailTable Recv_D INNER JOIN ReceivingMasterTable Recv ON Recv_D.ReceivingId = Recv.ReceivingId LEFT OUTER JOIN  ReceivingNoteMasterTable AS ReceivingNote ON CASE WHEN Recv_D.ReceivingNoteId > 0 Then Recv_D.ReceivingNoteId ELSE Recv.ReceivingNoteId End = ReceivingNote.ReceivingNoteId " _
                & "  INNER JOIN ArticleDefView Article   On Article.ArticleId = Recv_D.ArticleDefID " _
                & " Where Recv_D.ReceivingID =" & ReceivingID & ""
            'End 'TASK-TFS-51
            'End TASKM106151
            'End Task:2407
            'Dim objCommand As New OleDbCommand
            'Dim objCon As OleDbConnection
            'Dim objDataAdapter As New OleDbDataAdapter
            'Dim objDataSet As New DataSet

            'objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

            'If objCon.State = ConnectionState.Open Then objCon.Close()

            'objCon.Open()
            'objCommand.Connection = objCon
            'objCommand.CommandType = CommandType.Text


            'objCommand.CommandText = str

            'objDataAdapter.SelectCommand = objCommand
            'objDataAdapter.Fill(objDataSet)
            'grd.Rows.Clear()
            'objDataSet.Tables(0).Columns("Qty").Expression = "ReceivedQty - RejectedQty"
            ''objDataSet.Tables(0).Columns("Total").Expression = "Qty * Price"
            'For i = 0 To objDataSet.Tables(0).Rows.Count - 1
            '    'grd.Rows.Add(objDataSet.Tables(0).Rows(i)(0), objDataSet.Tables(0).Rows(i)(1), objDataSet.Tables(0).Rows(i)("BatchNo").ToString, objDataSet.Tables(0).Rows(i)(2), objDataSet.Tables(0).Rows(i)(3), objDataSet.Tables(0).Rows(i)(4), objDataSet.Tables(0).Rows(i)(5), objDataSet.Tables(0).Rows(i)(6), objDataSet.Tables(0).Rows(i)(7), objDataSet.Tables(0).Rows(i)(8), objDataSet.Tables(0).Rows(i)(9), objDataSet.Tables(0).Rows(i)("BatchID"), objDataSet.Tables(0).Rows(i)("LocationId"))
            '    grd.Rows.Add(objDataSet.Tables(0).Rows(i)(grdEnm.Category), objDataSet.Tables(0).Rows(i)(grdEnm.Item), objDataSet.Tables(0).Rows(i)(grdEnm.Color), objDataSet.Tables(0).Rows(i)(grdEnm.Size), objDataSet.Tables(0).Rows(i)(grdEnm.BatchNo).ToString, objDataSet.Tables(0).Rows(i)(grdEnm.Unit), objDataSet.Tables(0).Rows(i)(grdEnm.ReceivedQty), objDataSet.Tables(0).Rows(i)(grdEnm.RejectedQty), objDataSet.Tables(0).Rows(i)(grdEnm.Qty), objDataSet.Tables(0).Rows(i)(grdEnm.Price), objDataSet.Tables(0).Rows(i)(grdEnm.Total), objDataSet.Tables(0).Rows(i)(grdEnm.TaxPercent), objDataSet.Tables(0).Rows(i)(grdEnm.ArticleGroupId), objDataSet.Tables(0).Rows(i)(grdEnm.ArticleDefId), objDataSet.Tables(0).Rows(i)(grdEnm.PackQty), objDataSet.Tables(0).Rows(i)(grdEnm.CurrentPrice), objDataSet.Tables(0).Rows(i)(grdEnm.BatchId), objDataSet.Tables(0).Rows(i)(grdEnm.LocationId))
            '    'grd.Rows(i).Cells(0).Value = objDataSet.Tables(0).Rows(i)(0)
            '    'grd.Rows(i).Cells(1).Value = objDataSet.Tables(0).Rows(i)(1)
            'Next
            ''//grd.Columns("Category").HeaderText = "Location"





            Dim dtDisplayDetail As DataTable = GetDataTable(str)
            'dtDisplayDetail.Columns.Add("TaxAmount", GetType(System.Double))
            dtDisplayDetail.AcceptChanges()
            dtDisplayDetail.Columns("X_Net_Weights").Expression = "(IsNull(X_Gross_Weights,0)-IsNull(X_Tray_Weights,0))"
            dtDisplayDetail.Columns("Y_Net_Weights").Expression = "(IsNull(Y_Gross_Weights,0)-IsNull(Y_Tray_Weights,0))"
            dtDisplayDetail.Columns("Qty").Expression = "IsNull(ReceivedQty,0)-IsNull(RejectedQty,0)"
            'dtDisplayDetail.Columns("Total").Expression = "IIF(Unit='Pack', ((IsNull(PackQty,0)*IsNull(Qty,0))*IsNull(Rate,0)), (IsNull(Qty,0)*IsNull(Rate,0)))"
            'dtDisplayDetail.Columns("Total").Expression = "IsNull(TotalQty,0)*IsNull(Rate,0)* CurrencyRate"
            dtDisplayDetail.Columns("CurrencyAmount").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))*IsNull(Rate,0)"
            dtDisplayDetail.Columns("Total").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))*IsNull(Rate,0) * CurrencyRate"
            'dtDisplayDetail.Columns("TaxAmount").Expression = "((IIF(Unit='Pack', ((Isnull(PackQty,0)*IsNull(Qty,0))*(IsNull(Rate,0)-IsNull(Discount_Price,0))), (IsNull(Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))))*IsNull(TaxPercent,0))/100)"
            'dtDisplayDetail.Columns("TaxAmount").Expression = "((((IsNull(TotalQty,0)* IsNull(Rate,0))-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100)"
            dtDisplayDetail.Columns("CurrencyTaxAmount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100) / CurrencyRate"
            dtDisplayDetail.Columns("TaxAmount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100)"
            'TASK-TFS-51 Set Expression for AdTax Amount
            'dtDisplayDetail.Columns("AdTax_Amount").Expression = "((IIF(Unit='Pack', ((Isnull(PackQty,0)*IsNull(Qty,0))*(IsNull(Rate,0)-IsNull(Discount_Price,0))), (IsNull(Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))))*IsNull(AdTax_Percent,0))/100)"
            'dtDisplayDetail.Columns("AdTax_Amount").Expression = "((((IsNull(TotalQty,0)* IsNull(Rate,0))-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            dtDisplayDetail.Columns("AdTax_Amount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            dtDisplayDetail.Columns("CurrencyAdTaxAmount").Expression = "((((CurrencyAmount)-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"

            dtDisplayDetail.Columns("Total Amount").Expression = "IsNull([Total],0) + (IsNull([TaxAmount],0)+IsNull([AdTax_Amount],0))" 'Task:2374 Show Total Amount
            dtDisplayDetail.Columns("TotalCurrencyAmount").Expression = "IsNull([CurrencyAmount],0) + (IsNull([CurrencyTaxAmount],0)+IsNull([CurrencyAdTaxAmount],0))"

            dtDisplayDetail.Columns("VendorNetQty").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))"
            'dtDisplayDetail.Columns("Vendor_Qty").Expression = "IsNull(TotalQty, 0)-IsNull(Deduction, 0)"
            'dtDisplayDetail.Columns("AfterDeductionQty").Expression = "(isnull(TotalQty,0)-(IsNull(BardanaDeduction, 0)+ISNULL(OtherDeduction, 0)))"
            'dtDisplayDetail.Columns("TaxAmount").Expression = "((Total*Tax_Percent)/100)"
            'dtDisplayDetail.Columns("Total Amount").Expression = "Total+TaxAmount" 'Task:2370 Show Total Amount
            'dtDisplayDetail.Columns("Currency Tax Amount").Expression = "((CurrencyAmount*Tax_Percent)/100)"
            'dtDisplayDetail.Columns("Total Currency Amount").Expression = "CurrencyAmount+[Currency Tax Amount]"
            'End TASK-TFS-51

            'Me.grd.DataSource = Nothing
            Me.grd.DataSource = dtDisplayDetail
            If dtDisplayDetail.Rows.Count > 0 Then
                If IsDBNull(dtDisplayDetail.Rows.Item(0).Item("CurrencyId")) Or Val(dtDisplayDetail.Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
                    'Me.cmbCurrency.SelectedValue = Nothing
                    Me.cmbCurrency.Enabled = False
                Else
                    Me.CurrencyRate = Val(dtDisplayDetail.Rows.Item(0).Item("CurrencyRate").ToString)
                    Me.cmbCurrency.SelectedValue = Val(dtDisplayDetail.Rows.Item(0).Item("CurrencyId").ToString)
                    Me.cmbCurrency.Enabled = False
                End If
            End If
            ApplyGridSettings()
            'If getConfigValueByType("ItemExpiryDateOnPurchase").ToString = "True" Then Me.grd.RootTable.Columns(grdEnm.ExpiryDate).Visible = True Else Me.grd.RootTable.Columns(grdEnm.ExpiryDate).Visible = False
            FillCombo("grdLocation")
            FillCombo("GrdOrigin")

            'Dim InwardExpId As Integer = 0I
            'If Not getConfigValueByType("InwardExpHeadAcId").ToString = "Error" Then
            '    InwardExpId = getConfigValueByType("InwardExpHeadAcId").ToString
            'End If
            'Dim dtInwardExpDetail As DataTable = GetDataTable("Select Exp.PurchaseId, vw.coa_detail_id as AccountId , vw.Detail_Title, isnull(Exp_Amount,0) as Exp_Amount From vwCoaDetail vw LEFT OUTER JOIN (select PurchaseId, AccountId, Exp_Amount From InwardExpenseDetailTable WHERE PurchaseId=" & ReceivingID & ") Exp ON Exp.AccountId = vw.coa_detail_id WHERE  vw.main_sub_sub_id=" & InwardExpId)
            'Me.grdInwardExpDetail.DataSource = dtInwardExpDetail

            Me.CtrlGrdBar1_Load(Nothing, Nothing)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub FillInwardExpense(ReceivingID As Integer, Optional DocType As String = "")
        Try

            'Dim dtInwardExpDetail As DataTable = GetDataTable("Select IsNull(PurchaseId,0) as PurchaseId, IsNull(coa.coa_detail_id,0)  as AccountId ,coa.detail_title, IsNull(Exp_Amount,0) as Exp_Amount From tblDefInwardAccounts INNER JOIN vwCOADetail coa on coa.coa_detail_id = tblDefInwardAccounts.InwardAccountId LEFT OUTER JOIN (select PurchaseId, AccountId,Exp_Amount From InwardExpenseDetailTable WHERE PurchaseId=" & ReceivingID & " AND DocType=N'" & DocType & "') Exp_D  ON Exp_D.AccountId = COA.coa_detail_id")
            Dim dtInwardExpDetail As DataTable = GetDataTable("Select Exp.PurchaseId, tblDefInwardAccounts.InwardAccountId as AccountId,vw.Detail_Title,Case When  isnull(Exp_Amount,0) > 0 then isnull(Exp_Amount,0) else 0 end as Debit,Case When  isnull(Exp_Amount,0) <0 then abs(isnull(Exp_Amount,0))  else 0 end as Credit From vwCoaDetail vw INNER JOIN tblDefInwardAccounts on tblDefInwardAccounts.InwardAccountId = vw.coa_detail_id LEFT OUTER JOIN (select PurchaseId,AccountId,Exp_Amount From InwardExpenseDetailTable WHERE PurchaseId=" & ReceivingID & " AND DocType=N'" & DocType & "') Exp ON Exp.AccountId = vw.coa_detail_id")
            Me.grdInwardExpDetail.DataSource = dtInwardExpDetail
            Me.grdInwardExpDetail.RootTable.Columns("Debit").FormatString = "N" & DecimalPointInValue
            Me.grdInwardExpDetail.RootTable.Columns("Credit").FormatString = "N" & DecimalPointInValue
            Me.grdInwardExpDetail.RootTable.Columns("Debit").TotalFormatString = "N" & DecimalPointInValue
            Me.grdInwardExpDetail.RootTable.Columns("Credit").TotalFormatString = "N" & DecimalPointInValue
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    ''ReqId-970 Added method detail record from receiving note detail
    Private Sub DisplayDetailByReceingNo(ByVal ReceivingID As Integer)
        Try
            Dim str As String


            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.ReceivedQty, 0) " _
            '    & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.ExpiryDate, getDate()) as ExpiryDate, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo, Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article_Group.SubSubId,0) as PurchaseAccountId   " _
            '    & " FROM   ReceivingNoteDetailTable Recv_D INNER JOIN " _
            '    & "        ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
            '    & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
            '    & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
            '    & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN ArticleGroupDefTable Article_Group on Article_Group.ArticleGroupId = Article.ArticleGroupId " _
            '    & " Where Recv_D.ReceivingNoteID =" & ReceivingID & ""

            ''03-Feb-2014          Task:2407    Imran Ali       unit of measurement on GRN and purchase window.
            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size,Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.ReceivedQty, 0) " _
            '    & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo,ISNULL(Recv_D.ExpiryDate, getDate()) as ExpiryDate,  Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article_Group.SubSubId,0) as PurchaseAccountId   " _
            '    & " FROM   ReceivingNoteDetailTable Recv_D INNER JOIN " _
            '    & "        ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
            '    & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
            '    & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
            '    & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN ArticleGroupDefTable Article_Group on Article_Group.ArticleGroupId = Article.ArticleGroupId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId  " _
            '    & " Where Recv_D.ReceivingNoteID =" & ReceivingID & ""
            'End Task:2407
            'TaskM106151 Added Columns ReceivingDetailId, PurchaseReturnQty 
            'str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size,Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, IsNull(Recv_D.X_Tray_Weights,0) as X_Tray_Weights,IsNull(Recv_D.X_Gross_Weights,0) as X_Gross_Weights, IsNull(Recv_D.X_Net_Weights,0) as X_Net_Weights, IsNull(Recv_D.Y_Gross_Weights,0) as Y_Gross_Weights, IsNull(Recv_D.Y_Tray_Weights,0) as Y_Tray_Weights, IsNull(Recv_D.Y_Net_Weights,0) as Y_Net_Weights, ISNULL(Recv_D.ReceivedQty, 0) " _
            ' & "        AS ReceivedQty, ISNULL(Recv_D.RejectedQty, 0) AS RejectedQty, Recv_D.Sz1 AS Qty, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate,  CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, IsNull(Recv_D.AdTax_Percent,0) as AdTax_Percent,IsNull(Recv_D.AdTax_Amount,0) as AdTax_Amount,  Convert(float,0) as [Total Amount], Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,  Recv_D.CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo,ISNULL(Recv_D.ExpiryDate, getDate()) as ExpiryDate,  Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article_Group.SubSubId,0) as PurchaseAccountId, IsNull(Recv_D.Item_Wise_Disc,0) as ItemWiseDisc , 0 as ReceivingDetailId, 0.0 as PurchaseReturnQty,Recv_D.ReceivingDetailId as ReceivingNoteDetailId, 0 as PurchaseOrderDetailId   " _
            ' & " FROM   ReceivingNoteDetailTable Recv_D INNER JOIN " _
            ' & "        ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
            ' & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
            ' & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
            ' & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN ArticleGroupDefTable Article_Group on Article_Group.ArticleGroupId = Article.ArticleGroupId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId  " _
            ' & " Where Recv_D.ReceivingNoteID =" & ReceivingID & ""
            'End TaskM106151
            '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
            ''TFS1391 Added column ReceivingNoteId


            Dim intBaseCurrencyID As Integer = Val(getConfigValueByType("Currency"))
            Dim dblBaseCurrencyRate As Double = Val(GetCurrencyRate(intBaseCurrencyID))


            str = "SELECT  Recv_D.LocationId AS LocationId, Article.ArticleCode, Article.ArticleDescription AS item, Recv_D.AlternativeItem, ArticleColorDefTable.ArticleColorName AS Color,ArticleSizeDefTable.ArticleSizeName AS Size,Uom.ArticleUnitName as Uom, Recv_D.ArticleSize AS unit, IsNull(Recv_D.X_Tray_Weights,0) as X_Tray_Weights,IsNull(Recv_D.X_Gross_Weights,0) as X_Gross_Weights, IsNull(Recv_D.X_Net_Weights,0) as X_Net_Weights, IsNull(Recv_D.Y_Gross_Weights,0) as Y_Gross_Weights, IsNull(Recv_D.Y_Tray_Weights,0) as Y_Tray_Weights, IsNull(Recv_D.Y_Net_Weights,0) as Y_Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), ISNULL(Recv_D.ReceivedQty, 0), 1) " _
     & "        AS ReceivedQty, Convert(Decimal(18, " & DecimalPointInQty & "), ISNULL(Recv_D.RejectedQty, 0), 1) AS RejectedQty, Convert(Decimal(18, " & DecimalPointInQty & "), IsNull(Recv_D.Sz1, 0), 1) AS Qty, CASE WHEN IsNull(Recv_D.Gross_Quantity,0) =0 THEN ISNULL(Recv_D.Qty,0) ELSE IsNull(Recv_D.Gross_Quantity,0) END AS Gross_Qty, ISNULL(Recv_D.Column1,0) as Column1, ISNULL(Recv_D.Column2,0) as Column2,  ISNULL(Recv_D.Column3,0) as Column3,  Convert(Decimal(18, " & DecimalPointInQty & "),IsNull(Recv_D.Qty, 0), 1) As TotalQty, CASE WHEN IsNull(Recv_D.Vendor_Total_Quantity,0)=0 THEN ISNULL(Recv_D.Qty,0) ELSE IsNull(Recv_D.Vendor_Total_Quantity,0) END  as Vendor_Qty, Convert(Decimal(18, " & DecimalPointInQty & "), IsNull(Recv_D.OtherDeduction, 0)) AS Deduction, Convert(Decimal(18, " & DecimalPointInQty & "), 0) as VendorNetQty, Recv_D.CurrentPrice, Case When IsNull(Recv_D.CurrentPrice,0) > (IsNull(Price,0)+ISNULL(Recv_D.Discount_Price,0)) then ((IsNull(Recv_D.CurrentPrice,0)-IsNull(Price,0)+ISNULL(Recv_D.Discount_Price,0))/IsNull(Recv_D.CurrentPrice,0))*100 else 0 end as RateDiscPercent, Isnull(Recv_D.Price,0)+ISNULL(Recv_D.Discount_Price,0) as Rate,IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float, 0) As CurrencyTotalAmount,  CASE WHEN recv_d.articlesize = 'Loose' THEN Convert(float, (Recv_D.Sz1 * Recv_D.Price)) ELSE Convert(float, ((Recv_D.Sz1  * Article.PackQty) * Recv_D.Price)) END AS Total, IsNull(Recv_D.TaxPercent,0) As TaxPercent, 0.0 as TaxAmount, 0.0 as CurrencyTaxAmount, IsNull(Recv_D.AdTax_Percent,0) as AdTax_Percent,IsNull(Recv_D.AdTax_Amount,0) as AdTax_Amount, 0 As CurrencyAdTaxAmount,  Convert(float,0) as [Total Amount], Isnull(Recv_D.Transportation_Charges,0) as Transportation_Charges, Isnull(Recv_D.Custom_Charges,0) as Custom_Charges, ISNULL(Recv_D.Discount_Price,0) as Discount_Price,  Article.ArticleGroupId, Recv_D.ArticleDefId as ItemId, Recv_D.Sz7 AS PackQty,   Isnull(Recv_D.PackPrice,0) as PackPrice, Recv_D.BatchID, ISNULL(Recv_D.BatchNo, 'xxxx') AS BatchNo,ISNULL(Recv_D.ExpiryDate, getDate()) as ExpiryDate,ISNULL(Recv_D.Origin, '') as Origin,  Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article_Group.SubSubId,0) as PurchaseAccountId, IsNull(Recv_D.Item_Wise_Disc,0) as ItemWiseDisc , 0 as ReceivingDetailId, 0.0 as PurchaseReturnQty,Recv_D.ReceivingDetailId as ReceivingNoteDetailId, 0 as PurchaseOrderDetailId,IsNull(Recv_D.ReceivingNoteId, 0) As ReceivingNoteId, Recv_D.AlternativeItemId " _
     & " FROM   ReceivingNoteDetailTable Recv_D INNER JOIN  ReceivingNoteMasterTable AS Receiving ON Recv_D.ReceivingNoteId = Receiving.ReceivingNoteId  " _
     & "   INNER JOIN ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId INNER JOIN " _
     & "        tblDefLocation ON Recv_D.LocationId = tblDefLocation.location_id LEFT OUTER JOIN " _
     & "        ArticleColorDefTable ON Article.ArticleColorId = ArticleColorDefTable.ArticleColorId  LEFT OUTER JOIN " _
     & "        ArticleSizeDefTable ON Article.SizeRangeId = ArticleSizeDefTable.ArticleSizeId LEFT OUTER JOIN ArticleGroupDefTable Article_Group on Article_Group.ArticleGroupId = Article.ArticleGroupId LEFT OUTER JOIN ArticleUnitDefTable Uom on Uom.ArticleUnitId = Article.ArticleUnitId  " _
     & " Where Recv_D.ReceivingNoteID =" & ReceivingID & ""

            Dim dtDisplayDetail As DataTable = GetDataTable(str)
            dtDisplayDetail.AcceptChanges()
            dtDisplayDetail.Columns("X_Net_Weights").Expression = "(IsNull(X_Gross_Weights,0)-IsNull(X_Tray_Weights,0))"
            dtDisplayDetail.Columns("Y_Net_Weights").Expression = "(IsNull(Y_Gross_Weights,0)-IsNull(Y_Tray_Weights,0))"
            dtDisplayDetail.Columns("Qty").Expression = "IsNull(ReceivedQty,0)-IsNull(RejectedQty,0)"
            'dtDisplayDetail.Columns("Total").Expression = "IIF(Unit='Pack', ((IsNull(PackQty,0)*IsNull(Qty,0))*IsNull(Rate,0)), (IsNull(Qty,0)*IsNull(Rate,0)))"
            'dtDisplayDetail.Columns("Total").Expression = "(IsNull(TotalQty,0)*IsNull(Rate,0)*CurrencyRate)" ''TASK-408 added TotalQty instead of Qty
            dtDisplayDetail.Columns("CurrencyAmount").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))*IsNull(Rate,0)"
            dtDisplayDetail.Columns("Total").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))*IsNull(Rate,0)* CurrencyRate"
            ''dtDisplayDetail.Columns("TaxAmount").Expression = "((IIF(Unit='Pack', ((Isnull(PackQty,0)*IsNull(Qty,0))*(IsNull(Rate,0)-IsNull(Discount_Price,0))), (IsNull(Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))))*IsNull(TaxPercent,0))/100)"
            dtDisplayDetail.Columns("TaxAmount").Expression = "(IsNull(TotalQty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))*IsNull(TaxPercent,0)/100)* CurrencyRate"
            dtDisplayDetail.Columns("VendorNetQty").Expression = "(IsNull(Vendor_Qty,0)-IsNull(Deduction,0))"
            'TASK-TFS-51 Set Expression for AdTax Amount
            'dtDisplayDetail.Columns("AdTax_Amount").Expression = "((IIF(Unit='Pack', ((Isnull(PackQty,0)*IsNull(Qty,0))*(IsNull(Rate,0)-IsNull(Discount_Price,0))), (IsNull(Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))))*IsNull(AdTax_Percent,0))/100)"
            ''dtDisplayDetail.Columns("AdTax_Amount").Expression = "IsNull(Vendor_Qty,0)*(IsNull(Rate,0)-IsNull(Discount_Price,0))*IsNull(AdTax_Percent,0)/100" ''Task-408 added TotalQty instead of Qty
            dtDisplayDetail.Columns("AdTax_Amount").Expression = "((((Total)-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            dtDisplayDetail.Columns("Total Amount").Expression = "IsNull([Total],0) + (IsNull([TaxAmount],0)+IsNull([AdTax_Amount],0))" 'Task:2374 Show Total Amount
            'End TASK-TFS-51

            'dtDisplayDetail.Columns("CurrencyTaxAmount").Expression = "((((CurrencyAmount)-IsNull(Discount_Price,0)) * IsNull(TaxPercent,0))/100)"
            'dtDisplayDetail.Columns("CurrencyAdTaxAmount").Expression = "((((CurrencyAmount)-IsNull(Discount_Price,0)) * IsNull(AdTax_Percent,0))/100)"
            'dtDisplayDetail.Columns("TotalCurrencyAmount").Expression = "IsNull([CurrencyAmount],0) + (IsNull([CurrencyTaxAmount],0)+IsNull([CurrencyAdTaxAmount],0))"

            'dtDisplayDetail.Columns("Vendor_Qty").Expression = "IsNull(TotalQty, 0)-IsNull(Deduction, 0)"
            'dtDisplayDetail.Columns("AfterDeductionQty").Expression = "(isnull(TotalQty,0)-(IsNull(BardanaDeduction, 0)+ISNULL(OtherDeduction, 0)))"
            'Me.grd.DataSource = Nothing
            ''TFS1391 Option to add multi GRNs
            If Me.flgMultiGRN Then
                Dim dtGrid As DataTable = CType(Me.grd.DataSource, DataTable)
                If dtGrid.Rows.Count > 0 Then
                    dtDisplayDetail.Merge(dtGrid)
                End If
                Me.grd.DataSource = dtDisplayDetail
            Else
                Me.grd.DataSource = dtDisplayDetail
            End If
            ''End TASK TFS1391
            FillInwardExpense(ReceivingID, "GRN")
            ApplyGridSettings()

            Me.CtrlGrdBar1_Load(Nothing, Nothing)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Function Update_Record() As Boolean
        'If Not Me.chkPost.Checked = True Then
        '    If Me.chkPost.Visible = False Then
        '        Me.chkPost.Checked = False
        '    End If
        'End If
        If ApprovalProcessId = 0 Then
            'Start TFS2375 :Ayesha Rehman
            If Me.chkPost.Visible = False Then
                Me.chkPost.Checked = False
            End If
        Else
            Me.chkPost.Visible = False
        End If
        ''End TFS2375
        'Commented against R:979
        'Dim PurchaseTaxAccountId As Integer = Val(getConfigValueByType("PurchaseTaxDebitAccountId").ToString) 'GetConfigValue("PurchaseTaxDebitAccountId").ToString
        'Dim PaymentVoucherFlg As String = getConfigValueByType("PaymentVoucherOnPurchase").ToString 'GetConfigValue("PaymentVoucherOnPurchase").ToString
        'Dim flgAvgRate As Boolean = Convert.ToBoolean(getConfigValueByType("AvgRate").ToString) 'GetConfigValue("PurchaseDebitAccount")
        'End E:979
        Dim VoucherNo As String = GetVoucherNo()
        Dim objCommand As New OleDbCommand
        Dim objCon As OleDbConnection
        Dim i As Integer
        gobjLocationId = MyCompanyId
        objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")
        If objCon.State = ConnectionState.Open Then objCon.Close()
        objCon.Open()
        Dim cmd As New OleDbCommand
        cmd.Connection = Con
        cmd.CommandType = CommandType.Text
        'cmd.CommandText = "SELECT Sz1, ArticleDefID,IsNull(PurchaseOrderDetailID,0) as PurchaseOrderDetailId, IsNull(ReceivingNoteDetailId,0) as ReceivingNoteDetailId FROM ReceivingDetailTable WHERE  ReceivingID = " & Me.txtReceivingID.Text & ""
        'Dim da As New OleDbDataAdapter(cmd)
        'Dim dtSavedItems As New DataTable
        'da.Fill(dtSavedItems)

        Dim intAdditionalTaxAcId As Integer = Val(getConfigValueByType("AdditionalTaxAcId").ToString)
        Dim PurchaseTaxDeductionAcId As Integer = 0I
        PurchaseTaxDeductionAcId = Val(getConfigValueByType("PurchaseTaxDeductionAcId").ToString)
        Dim VendorDifferenceQtyAccount As Integer = 0I
        VendorDifferenceQtyAccount = Val(getConfigValueByType("VendorDifferenceQty").ToString)

        Dim lngVoucherMasterId As Integer = GetVoucherId("frmPurchase", Me.txtPONo.Text)




        ''TASK TFS1378
        ''Commented against TASK TFS4709
        'Dim GRNStockImpact As Boolean = False
        'If Not getConfigValueByType("GRNStockImpact").ToString = "Error" Then
        '    GRNStockImpact = Convert.ToBoolean(getConfigValueByType("GRNStockImpact").ToString)
        'End If
        If Not getConfigValueByType("AvgRate").ToString = "Error" Then
            flgAvgRate = getConfigValueByType("AvgRate")
        End If
        ''END TASK TFS1378



        'Dim strVoucherNo As String = String.Empty
        'Dim dt As DataTable = GetRecords("SELECT voucher_no   FROM tblVoucher  WHERE voucher_id = " & lngVoucherMasterId & " ")

        'If Not dt Is Nothing Then
        '    If Not dt.Rows.Count = 0 Then
        '        strVoucherNo = dt.Rows(0)("voucher_no")
        '    End If
        'End If
        Dim AccountId As Integer = 0I 'Val(getConfigValueByType("PurchaseDebitAccount").ToString) 'GetConfigValue("PurchaseDebitAccount")

        'If AccountId <= 0 Then
        '    ShowErrorMessage("Purchase account is not map.")
        '    Me.dtpPODate.Focus()
        '    Return False
        'End If
        If Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) <> 0 Then
            If PurchaseTaxAccountId <= 0 Then
                ShowErrorMessage("Purchase tax account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        'Commented against R:979
        'Dim GLAccountArticleDepartment As Boolean
        'If Not getConfigValueByType("GLAccountArticleDepartment").ToString = "Error" Then
        '    GLAccountArticleDepartment = Convert.ToBoolean(getConfigValueByType("GLAccountArticleDepartment"))
        'Else
        '    GLAccountArticleDepartment = False
        'End If
        'End R:979
        If objCon.State = ConnectionState.Closed Then objCon.Open()
        objCommand.Connection = objCon

        Dim trans As OleDbTransaction = objCon.BeginTransaction
        Try
            objCommand.CommandType = CommandType.Text

            objCommand.Transaction = trans

            'Dim transId As Integer = 0
            'transId = Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
            'objCon.BeginTransaction()

            'objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & gobjLocationId & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ", PurchaseOrderId=" & IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.SelectedValue, 0) & ", " _
            '& " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text & "',UserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text & "', Driver_Name=N'" & Me.txtDriverName.Text & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & Me.cmbProject.SelectedValue & ", IGPNo=N'" & Me.txtIGPNo.Text & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & "  Where ReceivingID= " & txtReceivingID.Text & " "

            'Changing against request no 828 by imran ali add column of total discount amount 
            'Before against request 970
            ' objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & gobjLocationId & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ", PurchaseOrderId=" & IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.SelectedValue, 0) & ", " _
            '& " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text.Replace("'", "''") & "', Driver_Name=N'" & Me.txtDriverName.Text.Replace("'", "''") & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & Me.cmbProject.SelectedValue & ", IGPNo=N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", Total_Discount_Amount=" & Val(Me.txtDiscount.Text) & "  Where ReceivingID= " & txtReceivingID.Text & " "
            'ReqId-970 Added Column ReceivingNoteId
            Dim ReceivingNoteId As Integer = 0I
            If Not drReceivingNote Is Nothing Then
                ReceivingNoteId = drReceivingNote(enmReceivingNote.Id)
            Else
                ReceivingNoteId = intReceivingNoteId
            End If

            ''TASK TFS4709
            If IsGRNStockImpacted = True AndAlso ReceivingNoteId > 0 Then
                ShouldStockImpactGo = False
            End If
            ''END TASK TFS4709
            'Task:2774 Added Field Due Days
            'objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & gobjLocationId & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ", PurchaseOrderId=" & IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.SelectedValue, 0) & ", " _
            '& " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text.Replace("'", "''") & "', Driver_Name=N'" & Me.txtDriverName.Text.Replace("'", "''") & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & Me.cmbProject.SelectedValue & ", IGPNo=N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", Total_Discount_Amount=" & Val(Me.txtDiscount.Text) & ",ReceivingNoteId=" & ReceivingNoteId & ",RefCMFADocId=" & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", DueDays=" & Val(Me.txtDueDays.Text) & "  Where ReceivingID= " & txtReceivingID.Text & " "
            'Task:2790 Added PurchaseAcId
            'objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & gobjLocationId & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ", PurchaseOrderId=" & IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.SelectedValue, 0) & ", " _
            '           & " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text.Replace("'", "''") & "', Driver_Name=N'" & Me.txtDriverName.Text.Replace("'", "''") & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & Me.cmbProject.SelectedValue & ", IGPNo=N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", Total_Discount_Amount=" & Val(Me.txtDiscount.Text) & ",ReceivingNoteId=" & ReceivingNoteId & ",RefCMFADocId=" & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", PurchaseAcId=" & Me.cmbPurchaseAccount.Value & "  Where ReceivingID= " & txtReceivingID.Text & " "

            ' Commented by Rai Shahid 14-Sep-15 to resolve PO and GRN number removes automatically
            'objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & gobjLocationId & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ", PurchaseOrderId=" & IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.SelectedValue, 0) & ", " _
            '          & " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UpdateUserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text.Replace("'", "''") & "', Driver_Name=N'" & Me.txtDriverName.Text.Replace("'", "''") & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & Me.cmbProject.SelectedValue & ", IGPNo=N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", Total_Discount_Amount=" & Val(Me.txtDiscount.Text) & ",ReceivingNoteId=" & ReceivingNoteId & ",RefCMFADocId=" & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", PurchaseAcId=" & Me.cmbPurchaseAccount.Value & ",InvoiceType='" & Me.cmbInvoiceType.Text & "'  Where ReceivingID= " & txtReceivingID.Text & " "


            ' Change by Rai Shahid 14-Sep-15 to resolve PO and GRN number removes automatically
            'objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & gobjLocationId & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ",  " _
            '          & " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UpdateUserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text.Replace("'", "''") & "', Driver_Name=N'" & Me.txtDriverName.Text.Replace("'", "''") & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & Me.cmbProject.SelectedValue & ", IGPNo=N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", Total_Discount_Amount=" & Val(Me.txtDiscount.Text) & ", RefCMFADocId=" & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", PurchaseAcId=" & Me.cmbPurchaseAccount.Value & ",InvoiceType='" & Me.cmbInvoiceType.Text & "'  Where ReceivingID= " & txtReceivingID.Text & " "
            'objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & gobjLocationId & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ",  " _
            '        & " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UpdateUserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text.Replace("'", "''") & "', Driver_Name=N'" & Me.txtDriverName.Text.Replace("'", "''") & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & Me.cmbProject.SelectedValue & ", IGPNo=N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", Total_Discount_Amount=" & Val(Me.txtDiscount.Text) & ", RefCMFADocId=" & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", PurchaseAcId=" & Me.cmbPurchaseAccount.Value & ",InvoiceType='" & Me.cmbInvoiceType.Text & "',Arrival_Time=Convert(Datetime,'" & Me.dtpArrivalTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102),Departure_Time=" & IIf(Me.dtpDepartureTime.Checked = True, "Convert(Datetime,'" & Me.dtpDepartureTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)", "NULL") & "   Where ReceivingID= " & txtReceivingID.Text & " "

            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
            objCommand.CommandText = "Update ReceivingMasterTable set LocationId=" & Val(Me.cmbCompany.SelectedValue) & ", ReceivingNo =N'" & txtPONo.Text & "',ReceivingDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',VendorId=" & cmbVendor.ActiveRow.Cells(0).Value & ",  " _
                   & " ReceivingQty=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TotalQty"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",ReceivingAmount=" & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(Me.txtDiscount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UpdateUserName=N'" & LoginUserName & "', DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Vehicle_No=N'" & Me.txtVhNo.Text.Replace("'", "''") & "', Driver_Name=N'" & Me.txtDriverName.Text.Replace("'", "''") & "', DcDate=" & IIf(Me.dtpDcDate.Checked = True, "N'" & dtpDcDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", Vendor_Invoice_No=N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', CostCenterId=" & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", IGPNo=N'" & Me.txtIGPNo.Text.Replace("'", "''") & "', CurrencyType=" & IIf(Me.grpCurrency.Visible = True, "" & Me.cmbCurrency.SelectedValue & "", "NULL") & ", CurrencyRate=" & IIf(Me.grpCurrency.Visible = True, "" & Val(Me.txtCurrencyRate.Text) & "", "NULL") & ", Transportation_Vendor=" & IIf(Me.cmbTransportationVendor.ActiveRow Is Nothing, 0, Me.cmbTransportationVendor.Value) & ", Total_Discount_Amount=" & Val(Me.txtDiscount.Text) & ", RefCMFADocId=" & Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("RefCMFADocId").ToString) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", PurchaseAcId=" & Me.cmbPurchaseAccount.Value & ",InvoiceType='" & Me.cmbInvoiceType.Text & "',Arrival_Time=Convert(Datetime,'" & Me.dtpArrivalTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102),Departure_Time=" & IIf(Me.dtpDepartureTime.Checked = True, "Convert(Datetime,'" & Me.dtpDepartureTime.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)", "NULL") & ",TaxDeductionPercent=" & Val(Me.txtTaxDeductPercent.Text) & ", TaxDeductionAmount=" & Val(Me.txtTaxDeductAmount.Text) & ", ReceivingNoteId=" & ReceivingNoteId & ", DiscountType = N'" & IIf(Me.rbtAdjFlat.Checked = True, "Flat", "Percentage") & "', AdjDiscount = " & Val(Me.txtAdjustment.Text) & " , Custom_Vendor=" & IIf(Me.cmbCustomVendor.ActiveRow Is Nothing, 0, Me.cmbCustomVendor.Value) & "   Where ReceivingID= " & txtReceivingID.Text & " "

            objCommand.ExecuteNonQuery()

            'Marked Against Task#2015060001 Ali Ansari
            'If arrFile.Length > 0 Then
            '    SaveDocument(Val(txtReceivingID.Text), Me.Name, trans)
            'End If
            'Marked Against Task#2015060001 Ali Ansari
            'Altered Against Task#2015060001 Ali Ansari
            UpdatePOStatus(Val(Me.txtReceivingID.Text), trans, "Delete")

            ''Start TFS2576
            UpdateGRNStatus(Val(Me.txtReceivingID.Text), trans) 'Update GRN Status
            ''End TFS2576
            If arrFile.Count > 0 Then
                SaveDocument(Val(txtReceivingID.Text), Me.Name, trans)
            End If
            'Altered Against Task#2015060001 Ali Ansari
            objCommand.CommandText = ""
            objCommand.CommandText = "Delete from ReceivingDetailTable where ReceivingID = " & txtReceivingID.Text
            objCommand.ExecuteNonQuery()

            objCommand.CommandText = ""
            'Before against task:M101
            'objCommand.CommandText = "update tblVoucher set voucher_date=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & " " _
            '                        & "   where voucher_id=" & lngVoucherMasterId
            'Task:M101 Added Field Remarks
            ''TASK TFS1427 added Posted_UserName column
            objCommand.CommandText = "update tblVoucher set voucher_date=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ",Remarks=N'" & Me.txtRemarks.Text.Replace("'", "''") & "', Posted_UserName = " & IIf(Me.chkPost.Checked = True, "N'" & LoginUserName & "'", "NULL") & " " _
                                    & "   where voucher_id=" & lngVoucherMasterId
            'End Task:M101
            objCommand.ExecuteNonQuery()

            '***********************
            'Deleting Detail
            '***********************
            objCommand.CommandText = ""
            objCommand.CommandText = "delete from tblVoucherDetail where voucher_Id =" & lngVoucherMasterId

            objCommand.ExecuteNonQuery()


            ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
            If VoucherId > 0 Then
                objCommand.CommandText = ""
                objCommand.CommandText = "delete from tblVoucherDetail where voucher_Id =" & VoucherId
                objCommand.ExecuteNonQuery()
            End If
            'End Task:2483

            ''make reversal of saved items in sale order detail table against poid
            'If dtSavedItems.Rows.Count > 0 Then
            '    For Each r As DataRow In dtSavedItems.Rows
            '        objCommand.CommandText = "Update PurchaseOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & ") where PurchaseOrderID = " & Me.cmbPo.SelectedValue & " and ArticleDefID = " & r.Item(1) & " " & IIf(Val(r.Item("PurchaseOrderDetailId").ToString) > 0, " AND PurchaseOrderDetailId=" & Val(r.Item("PurchaseOrderDetailId").ToString) & "", "") & ""
            '        objCommand.ExecuteNonQuery()
            '    Next
            'End If

            Dim strSQL As String
            Dim BatchID As Integer = 0
            StockList = New List(Of StockDetail)
            For i = 0 To grd.RowCount - 1




                'Task:2447 Validation at Batch No.
                If grd.GetRows(i).Cells("BatchNo").Value.ToString.Trim.Length > 1 AndAlso grd.GetRows(i).Cells("BatchNo").Value.ToString.Trim <> "xxxx" Then
                    objCommand.CommandText = ""
                    objCommand.CommandText = "Select Count(*) From ReceivingDetailTable WHERE ReceivingId <> '" & Me.txtReceivingID.Text & "' AND ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND BatchNo=N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'"
                    Dim objDA As New OleDbDataAdapter
                    Dim objDt As New DataTable
                    objDA.SelectCommand = objCommand
                    objDA.Fill(objDt)
                    If objDt IsNot Nothing Then
                        If Val(objDt.Rows(0).Item(0).ToString) > 0 Then
                            Throw New Exception(Chr(10) & "IR# [" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "] is already exist.")
                        End If
                    End If
                End If
                'End Task:2447



                '********************************
                ' Update Purchase Price By Imran
                '********************************
                Dim CrrStock As Double = 0D
                Dim CostPrice As Double = 0D
                If flgPurchaseAccountFrontEnd = True AndAlso Me.cmbPurchaseAccount.Value > 0 Then
                    AccountId = Me.cmbPurchaseAccount.Value
                ElseIf GLAccountArticleDepartment = True Then
                    AccountId = Val(grd.GetRows(i).Cells("PurchaseAccountId").Value.ToString)
                Else
                    AccountId = Val(getConfigValueByType("PurchaseDebitAccount").ToString)
                End If

                If AccountId = 0 Then
                    Throw New Exception("Purchase Account Is Not Map.")
                End If
                Dim str1 As String = "Select ServiceItem from ArticleDefView where ArticleId = " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                Dim dt As DataTable = GetDataTable(str1, trans)
                dt.AcceptChanges()
                Dim ServiceItem As Boolean = Val(dt.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem = True Then
                    Dim str2 As String = "Select CGSAccountId from ArticleDefView where ArticleId = " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                    Dim dt1 As DataTable = GetDataTable(str2, trans)
                    dt1.AcceptChanges()
                    AccountId = Val(dt1.Rows(0).Item("CGSAccountId").ToString)
                    'AccountId = "Select ServiceItem from ArticleDefView where ArticleId = " & grd.GetRows(i).Cells("ItemId").Value & ""
                End If
                'If flgAvgRate = True Then
                '    Try
                '        objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, 0 as PurchasePrice, Round(ABS(SUM(Isnull(dbo.StockDetailTable.InQty,0) - Isnull(dbo.StockDetailTable.OutQty,0))),4) AS Qty, Round(ABS(SUM(Isnull(dbo.StockDetailTable.InAmount,0) - Isnull(dbo.StockDetailTable.OutAmount,0))),4) as Amount  " _
                '                                & " FROM dbo.ArticleDefTable INNER JOIN " _
                '                                & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId=" & grd.GetRows(i).Cells("ItemId").Value & " AND StockDetailTable.StockTransId IN(Select StockTransId From StockMasterTable WHERE DocNo <> N'" & Me.txtPONo.Text.Replace("'", "''") & "') " _
                '                                & " GROUP BY dbo.StockDetailTable.ArticleDefId "
                '        Dim dtCrrStock As New DataTable
                '        Dim daCrrStock As New OleDbDataAdapter(objCommand)
                '        daCrrStock.Fill(dtCrrStock)
                '        '        If dtCrrStock IsNot Nothing Then
                '        '            If dtCrrStock.Rows.Count > 0 Then
                '        '                'Before against task:2401
                '        '                'If Val(grd.GetRows(i).Cells("rate").Value) <> 0 Then
                '        '                If Val(grd.GetRows(i).Cells("rate").Value) <> 0 AndAlso Val(dtCrrStock.Rows(0).Item("qty").ToString) <> 0 Then
                '        '                    'End Task:2401
                '        '                    'CrrStock = dtCrrStock.Rows(0).Item(2) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                '        '                    'PurchasePriceNew = ((dtCrrStock.Rows(0).Item(3)) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString))) / CrrStock
                '        '                    CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '        '                Else
                '        '                    CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '        '                End If
                '        '            Else
                '        '                CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '        '            End If
                '        '        End If


                '        '    Catch ex As Exception

                '        '    End Try
                '        'End If

                '        'StockDetail = New StockDetail
                '        'StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                '        'StockDetail.LocationId = grd.GetRows(i).Cells("LocationID").Value
                '        'StockDetail.ArticleDefId = grd.GetRows(i).Cells("ItemId").Value
                '        'StockDetail.InQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                '        'StockDetail.OutQty = 0
                '        'StockDetail.Rate = IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)
                '        'StockDetail.InAmount = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)), ((Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)) * IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)))
                '        'StockDetail.OutAmount = 0
                '        'StockDetail.Remarks = String.Empty
                '        'StockList.Add(StockDetail)

                '        If dtCrrStock IsNot Nothing Then
                '            If dtCrrStock.Rows.Count > 0 Then
                '                'Before against task:2401
                '                'If Val(grd.GetRows(i).Cells("Price").Value) <> 0 Then
                '                If Val(grd.GetRows(i).Cells("Rate").Value) <> 0 AndAlso Val(dtCrrStock.Rows(0).Item("Qty").ToString) <> 0 Then
                '                    'End Task:2401
                '                    'CrrStock = Val(dtCrrStock.Rows(0).Item(2).ToString) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                '                    'PurchasePriceNew = ((dtCrrStock.Rows(0).Item(3)) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString))) / CrrStock
                '                    CostPrice = (Val(dtCrrStock.Rows(0).Item("Amount").ToString) / Val(dtCrrStock.Rows(0).Item("Qty").ToString)) 'Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '                Else
                '                    CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '                End If
                '            Else
                '                CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                '            End If
                '        End If
                '    Catch ex As Exception

                '    End Try
                'Else
                '    CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                'End If

                'StockDetail = New StockDetail
                'StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                'StockDetail.LocationId = grd.GetRows(i).Cells("LocationID").Value
                'StockDetail.ArticleDefId = grd.GetRows(i).Cells("ItemId").Value
                'StockDetail.InQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                'StockDetail.OutQty = 0
                ''StockDetail.Rate = IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)
                'StockDetail.Rate = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))
                'StockDetail.CostPrice = IIf(CostPrice = 0, (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)), CostPrice)
                'StockDetail.InAmount = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * StockDetail.Rate), ((Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)) * StockDetail.Rate))
                'StockDetail.OutAmount = 0
                'StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                'StockList.Add(StockDetail)
                If ShouldStockImpactGo = True Then

                End If
                Dim strData As String '= "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0)+" & (IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))) & "  as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) + " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))) & " BalanceAmount From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString) & " AND StockMasterTable.DocNo <> '" & Me.txtPONo.Text & "' AND IsNull(Rate,0) <> 0 Group By ArticleDefId "
                Dim str As String = "Select * from stockmastertable where docno = '" & Me.txtPONo.Text & "'"
                Dim dtdocdata As DataTable = GetDataTable(str)
                If ShouldStockImpactGo = True AndAlso dtdocdata.Rows.Count > 0 Then
                    strData = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0)+" & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & "  as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) + " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * (Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString))) & " BalanceAmount From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND StockMasterTable.DocNo <> '" & Me.txtPONo.Text & "' AND IsNull(Rate,0) <> 0  AND StockMasterTable.DocDate <= '" & Me.dtpPODate.Value & "' Group By ArticleDefId "
                Else
                    strData = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0)+" & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) & "  as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) + " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * (Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString))) & " BalanceAmount From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & "  AND StockMasterTable.DocDate <= '" & Me.dtpPODate.Value & "' Group By ArticleDefId "
                End If
                If ShouldStockImpactGo = False Then
                    strData = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0) as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) as BalanceAmount, IsNull(SUM(IsNull(InQty, 0) - IsNull(OutQty, 0)), 0) AS CheckStock From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND IsNull(Rate,0) <> 0  AND StockMasterTable.DocDate <= '" & Me.dtpPODate.Value & "'  Group By ArticleDefId "
                End If
                Dim dblCostPrice As Double = 0D
                Dim dtLastestPriceData As New DataTable
                dtLastestPriceData = GetDataTable(strData, trans)
                dtLastestPriceData.AcceptChanges()

                If dtLastestPriceData.Rows.Count > 0 Then
                    'If Val(dtLastestPriceData.Rows(0).Item(1).ToString) > 0 Then
                    If flgAvgRate = True Then
                        dblCostPrice = (Val(dtLastestPriceData.Rows(0).Item(2).ToString) / Val(dtLastestPriceData.Rows(0).Item(1).ToString))
                    Else
                        dblCostPrice = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    End If
                    'If dblCostPrice = 0 Then
                    '    dblCostPrice = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    'End If
                    'If dblCostPrice = 0 Then
                    '    dblCostPrice = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    'End If
                    'Else
                    '    dblCostPrice = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                    'End If
                Else
                    dblCostPrice = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * (Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString)) 'Val(grd.GetRows(i).Cells("Rate").Value.ToString)

                End If
                Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem, trans)
                dt2serviceitem.AcceptChanges()
                Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem1 = False Then

                    If ShouldStockImpactGo = True Then
                        StockDetail = New StockDetail
                        StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                        StockDetail.LocationId = grd.GetRows(i).Cells("LocationID").Value
                        StockDetail.ArticleDefId = IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString))
                        ''TASK-408
                        StockDetail.InQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)
                        StockDetail.OutQty = 0
                        'StockDetail.Rate = IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)
                        StockDetail.Rate = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString)
                        StockDetail.CostPrice = dblCostPrice '* Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) 'IIf(CostPrice = 0, (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)), CostPrice)
                        ''TASK-408
                        StockDetail.InAmount = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * StockDetail.Rate
                        StockDetail.OutAmount = 0
                        StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                        '' Start TASK-470 on 01-07-2016
                        StockDetail.PackQty = Val(grd.GetRows(i).Cells("PackQty").Value.ToString)
                        StockDetail.In_PackQty = Val(grd.GetRows(i).Cells("Qty").Value.ToString)
                        StockDetail.Out_PackQty = 0
                        ''End TASK-470
                        '' Start TASK-1596 on 27-01-2017
                        StockDetail.BatchNo = grd.GetRows(i).Cells("BatchNo").Value.ToString
                        StockDetail.ExpiryDate = CType(grd.GetRows(i).Cells("ExpiryDate").Value, Date).ToString("yyyy-M-d h:mm:ss tt")
                        ''End TASK-1596
                        StockDetail.Origin = grd.GetRows(i).Cells("Origin").Value.ToString
                        StockList.Add(StockDetail)
                    Else
                        StockDetail = New StockDetail
                        StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                        StockDetail.LocationId = grd.GetRows(i).Cells("LocationID").Value
                        StockDetail.ArticleDefId = IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString))
                        ''TASK-408
                        StockDetail.InQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)
                        StockDetail.OutQty = 0
                        'StockDetail.Rate = IIf(PurchasePriceNew = 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString), PurchasePriceNew)
                        StockDetail.Rate = (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString)
                        StockDetail.CostPrice = dblCostPrice '* Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) 'IIf(CostPrice = 0, (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)), CostPrice)
                        ''TASK-408
                        StockDetail.InAmount = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * StockDetail.Rate
                        StockDetail.OutAmount = 0
                        StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                        '' Start TASK-470 on 01-07-2016
                        StockDetail.PackQty = Val(grd.GetRows(i).Cells("PackQty").Value.ToString)
                        StockDetail.In_PackQty = Val(grd.GetRows(i).Cells("Qty").Value.ToString)
                        StockDetail.Out_PackQty = 0
                        ''End TASK-470
                        '' Start TASK-1596 on 27-01-2017
                        StockDetail.BatchNo = grd.GetRows(i).Cells("BatchNo").Value.ToString
                        StockDetail.ExpiryDate = CType(grd.GetRows(i).Cells("ExpiryDate").Value, Date).ToString("yyyy-M-d h:mm:ss tt")
                        StockDetail.Origin = grd.GetRows(i).Cells("Origin").Value.ToString
                    End If
                End If
                Dim dataTable As DataTable = CType(Me.grd.DataSource, DataTable)

                Dim TotalQty As Double = 0
                TotalQty = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TotalQty"), Janus.Windows.GridEX.AggregateFunction.Sum))
                Dim TransCharges As Double = 0
                TransCharges = Val(Val(Me.txtTransCharges.Text) / TotalQty)

                If Me.cmbPo.SelectedIndex > 0 Then
                    strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'"
                    Dim dtBatch As DataTable = GetDataTable(strSQL, trans)
                    If dtBatch.Rows.Count = 0 Then
                        If msg_Confirm("The batch No you entered is new. " & Environment.NewLine & "Do you want to add new batch no...?") Then

                            objCommand.CommandText = "insert into PurchaseBatchTable(BatchNo,StartDate, EndDate, Comments,sortorder) values(N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Trim.Replace("'", "''") & "', GetDate(), NULL , '',0" & ") Select @@Identity"

                            BatchID = objCommand.ExecuteScalar()



                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty) values( " _
                            '            & " " & txtReceivingID.Text & "," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                            '            & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & BatchID & " ,N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & ") "


                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges, PackPrice) values( " _
                            '           & " " & txtReceivingID.Text & "," & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '           & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & BatchID & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ",N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value) & ") "

                            'Changing against request no 828 by imran ali 18-9-2013 add column of discount price
                            ''Before against request no. 934
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges, PackPrice,Discount_Price) values( " _
                            '           & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '           & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & BatchID & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ",N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ") "
                            'ReqId-934 Resolve Comma Error
                            'TASKM106151 Added Column PurchaseReturnQty
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges, PackPrice,Discount_Price,PurchaseReturnQty,Item_Wise_Disc) values( " _
                            '           & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '           & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & BatchID & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ",N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ItemWiseDisc").Value.ToString) & ") Select @@Identity"


                            'Before TASK-TFS-51
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges, PackPrice,Discount_Price,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                            '           & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '           & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & BatchID & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ",N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ") Select @@Identity"

                            'TASK-TFS-51 Added Fields AdTax_Percent, AdTax_Amount
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges, PackPrice,Discount_Price,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount) values( " _
                            '           & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '           & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & BatchID & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ",N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ") Select @@Identity"
                            'END TASK-TFS-51
                            objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges, PackPrice,Discount_Price,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount,ReceivingNoteDetailId, PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,Column2,Column3,  OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                       & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                       & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & BatchID & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ", " & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " , " & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & " ', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ") Select @@Identity" '' TASK-408 added TotalQty value here
                            '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & BatchID & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & ",N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ") Select @@Identity"


                            Dim intPurchaseDetailId As Integer = objCommand.ExecuteScalar()

                            'TaskM106151 New ReceivingDetailId Update In PurchaseReturnDetailTable, bacause there is exist old ReceivingDetailId
                            objCommand.CommandText = ""
                            objCommand.CommandText = "Update PurchaseReturnDetailTable Set RefPurchaseDetailId=" & intPurchaseDetailId & " WHERE PurchaseReturnId In(Select PurchaseReturnId From PurchaseReturnMasterTable WHERE PurchaseOrderId=" & Val(Me.txtReceivingID.Text) & ") AND RefPurchaseDetailId=" & Val(grd.GetRows(i).Cells("ReceivingDetailId").Value.ToString) & ""
                            objCommand.ExecuteNonQuery()
                            'End TaskM106151


                        Else
                            strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value & "'"
                            dtBatch = GetDataTable(strSQL, trans)
                            Dim Batch_Id As Integer = 0I
                            If dtBatch IsNot Nothing Then
                                If dtBatch.Rows.Count > 0 Then
                                    Batch_Id = dtBatch.Rows(0).Item(0)
                                End If
                            End If

                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty) values( " _
                            '          & " " & txtReceivingID.Text & "," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                            '          & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & dt.Rows(0).Item(0).ToString & " ,N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & ") "

                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice) values( " _
                            '          & " " & txtReceivingID.Text & "," & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '          & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ,N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "',N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ") "

                            'changing against request no 828 by imran ali 18-09-2013 add column of Discount_Price
                            'Before against request no. 934
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price) values( " _
                            '                                     & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ArticleDefId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                     & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ") "
                            'ReqId-934 Resolve Comma Error
                            'TASKM106151 Added Column PurchaseReturnQty
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price,PurchaseReturnQty,Item_Wise_Disc) values( " _
                            '                                     & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ArticleDefId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                     & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ItemWiseDisc").Value.ToString) & ")Select @@Identity "

                            'Before TASK-TFS-51
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                            '                                    & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ArticleDefId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                    & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ")Select @@Identity "


                            'TASK-TFS-51 Added Fields AdTax_Percent,AdTax_Amount
                            'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount) values( " _
                            '                                    & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ArticleDefId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                            '                                    & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ")Select @@Identity "
                            'END TASK-TFS-51
                            ''TFS1391 Added column ReceivingNoteId
                            objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount,ReceivingNoteDetailId, PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,COlumn2,Column3, OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                                               & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                                               & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & " , N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " , " & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & " ', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ")Select @@Identity " '' TASK-408 added TotalQty value here
                            '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ")Select @@Identity "

                            Dim intPurchaseDetailId As Integer = objCommand.ExecuteScalar()

                            'TaskM106151 New ReceivingDetailId Update In PurchaseReturnDetailTable, bacause there is exist old ReceivingDetailId
                            objCommand.CommandText = ""
                            objCommand.CommandText = "Update PurchaseReturnDetailTable Set RefPurchaseDetailId=" & intPurchaseDetailId & " WHERE PurchaseReturnId In(Select PurchaseReturnId From PurchaseReturnMasterTable WHERE PurchaseOrderId=" & Val(Me.txtReceivingID.Text) & ") AND RefPurchaseDetailId=" & Val(grd.GetRows(i).Cells("ReceivingDetailId").Value.ToString) & ""
                            objCommand.ExecuteNonQuery()
                            'End TaskM106151


                        End If
                    Else
                        strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & "'"
                        dtBatch = GetDataTable(strSQL, trans)
                        Dim Batch_Id As Integer = 0I
                        If dtBatch IsNot Nothing Then
                            If dtBatch.Rows.Count > 0 Then
                                Batch_Id = dtBatch.Rows(0).Item(0)
                            End If
                        End If
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty) values( " _
                        '              & " " & txtReceivingID.Text & "," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                        '              & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & dt.Rows(0).Item(0).ToString & ",N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & " ) "

                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice) values( " _
                        '              & " " & txtReceivingID.Text & "," & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '              & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ,N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "', N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "'," & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ") "

                        'Changing Against Request No 828 by imran ali add column of discount price
                        'Before against request no . 934
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc) values( " _
                        '              & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '              & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "'," & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "
                        ''ReqId-934 Resolve Comma Error
                        'TASKM106151 Added Column PurchaseReturnQty
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,Item_Wise_Disc) values( " _
                        '              & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '              & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "'," & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ItemWiseDisc").Value.ToString) & ") Select @@Identity"

                        'Before TASK-TFS-51 
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                        '             & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '             & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "'," & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ") Select @@Identity"


                        'TASK-TFS-51 Added Fields AdTax_Percent, AdTax_Amount
                        'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount) values( " _
                        '             & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                        '             & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "'," & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ") Select @@Identity"
                        'END TASK-TFS-51
                        ''TFS1391 Added column ReceivingNoteId
                        objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate, Comments, Transportation_Charges,PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent, AdTax_Amount,ReceivingNoteDetailId, PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,COlumn2,Column3, OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                    & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                    & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & " , N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "'," & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " , " & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & " ', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ") Select @@Identity" ''TASK-408 added TotalQty value here
                        '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & ",N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & ", " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ", N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "'," & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & " ," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ") Select @@Identity"

                        Dim intPurchaseDetailId As Integer = objCommand.ExecuteScalar()

                        'TaskM106151 New ReceivingDetailId Update In PurchaseReturnDetailTable, bacause there is exist old ReceivingDetailId
                        objCommand.CommandText = ""
                        objCommand.CommandText = "Update PurchaseReturnDetailTable Set RefPurchaseDetailId=" & intPurchaseDetailId & " WHERE PurchaseReturnId In(Select PurchaseReturnId From PurchaseReturnMasterTable WHERE PurchaseOrderId=" & Val(Me.txtReceivingID.Text) & ") AND RefPurchaseDetailId=" & Val(grd.GetRows(i).Cells("ReceivingDetailId").Value.ToString) & ""
                        objCommand.ExecuteNonQuery()
                        'End TaskM106151


                    End If

                Else
                    strSQL = "select BatchID from PurchaseBatchTable where BatchNo = N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString & "'"
                    Dim dtBatch1 As DataTable = GetDataTable(strSQL, trans)
                    Dim Batch_Id As Integer = 0I
                    If dtBatch1 IsNot Nothing Then
                        If dtBatch1.Rows.Count > 0 Then
                            Batch_Id = dtBatch1.Rows(0).Item(0)
                        End If
                    End If

                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty) values( " _
                    '                   & " " & txtReceivingID.Text & "," & Val(grd.Rows(i).Cells("ItemId").Value) & ",N'" & (grd.Rows(i).Cells("Unit").Value) & "'," & Val(grd.Rows(i).Cells("Qty").Value) & ", " _
                    '                   & " " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", Val(grd.Rows(i).Cells("qty").Value), (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value))) & ", " & Val(grd.Rows(i).Cells("rate").Value) & ", " & Val(grd.Rows(i).Cells("PackQty").Value) & " , " & Val(grd.Rows(i).Cells("CurrentPrice").Value) & ",N'" & grd.Rows(i).Cells("BatchNo").Value & " '," & dt.Rows(0).Item(0).ToString & " ,N'" & grd.Rows(i).Cells("LocationId").Value & " ', " & grd.Rows(i).Cells("ReceivedQty").Value & ", " & grd.Rows(i).Cells("RejectedQty").Value & "  ) "

                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate,Comments, Transportation_Charges, PackPrice) values( " _
                    '                                       & " " & txtReceivingID.Text & "," & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                                       & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & Val(grd.GetRows(i).Cells("rate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & " , " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ,N'" & CDate(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value).ToString("yyyy-M-d h:mm:ss tt") & "',N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ") "

                    'Changing against request no 828 by imran ali add column of discount price
                    'Before against ReqId-934
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate,Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc) values( " _
                    '                                       & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                                       & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & " , " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "') "
                    'ReqId-934 Resolve Comma Error
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate,Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,Item_Wise_Disc) values( " _
                    '                                       & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                                       & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & " , " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ItemWiseDisc").Value.ToString) & ") Select @@Identity"


                    'Before TASK-TFS-51
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate,Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights) values( " _
                    '                                      & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                                      & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & " , " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & ") Select @@Identity"



                    'TASK-TFS-51 Added Fields AdTax_Percent, AdTax_Amount
                    'objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate,Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount) values( " _
                    '                                      & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                    '                                      & " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & " , " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ") Select @@Identity"
                    'END TASK-TFS-51
                    ''TFS1391 Added column ReceivingNoteId
                    objCommand.CommandText = "Insert into ReceivingDetailTable (ReceivingId, ArticleDefId,ArticleSize, Sz1,Qty,Price,Sz7,CurrentPrice,BatchNo, BatchID, LocationId, ReceivedQty, RejectedQty, TaxPercent,ExpiryDate,Comments, Transportation_Charges, PackPrice, Discount_Price, Pack_Desc,PurchaseReturnQty,X_Tray_Weights,X_Gross_Weights,X_Net_Weights,Y_Gross_Weights,Y_Tray_Weights,Y_Net_Weights,AdTax_Percent,AdTax_Amount,ReceivingNoteDetailId, PurchaseOrderDetailId, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, ReceivingNoteId,Gross_Quantity,Vendor_Total_Quantity,Column1,Column2,Column3,  OtherDeduction, Origin, Custom_Charges, AlternativeItem, AlternativeItemId) values( " _
                                                          & " " & txtReceivingID.Text & "," & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ",N'" & (grd.GetRows(i).Cells("Unit").Value) & "'," & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & ", " _
                                                          & " " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & " , " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & " ,N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & IIf(Val(TransCharges > 0), Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & ", " & Val(Me.grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " , " & Val(Me.grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("ReceivingNoteId").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column1").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column2").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Column3").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Deduction").Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value.ToString.Replace("'", "''") & " ', " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ",N'" & (grd.GetRows(i).Cells("AlternativeItem").Value) & "'," & Val(grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) & ") Select @@Identity" '' TASK-408 added TotalQty value here
                    '& " " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) & ", " & (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", " & Val(grd.GetRows(i).Cells("PackQty").Value) & " , " & Val(grd.GetRows(i).Cells("CurrentPrice").Value) & ",N'" & grd.GetRows(i).Cells("BatchNo").Value.ToString.Replace("'", "''") & " '," & Batch_Id & " ,N'" & grd.GetRows(i).Cells("LocationId").Value & " ', " & grd.GetRows(i).Cells("ReceivedQty").Value & ", " & grd.GetRows(i).Cells("RejectedQty").Value & " , " & Val(grd.GetRows(i).Cells("TaxPercent").Value.ToString) & " ," & IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, "NULL", "N'" & CDate(IIf(grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value Is DBNull.Value, Now.ToString("yyyy-M-d h:mm:ss tt"), grd.GetRows(i).Cells(grdEnm.ExpiryDate).Value)).ToString("yyyy-M-d h:mm:ss tt") & "'") & ",N'" & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', " & Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("PackPrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & grd.GetRows(i).Cells("Pack_Desc").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("PurchaseReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("X_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Gross_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Tray_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Y_Net_Weights").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Percent").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("ReceivingNoteDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ") Select @@Identity"

                    Dim intPurchaseDetailId As Integer = objCommand.ExecuteScalar()

                    'TaskM106151 New ReceivingDetailId Update In PurchaseReturnDetailTable, bacause there is exist old ReceivingDetailId
                    objCommand.CommandText = ""
                    objCommand.CommandText = "Update PurchaseReturnDetailTable Set RefPurchaseDetailId=" & intPurchaseDetailId & " WHERE PurchaseReturnId In(Select PurchaseReturnId From PurchaseReturnMasterTable WHERE PurchaseOrderId=" & Val(Me.txtReceivingID.Text) & ") AND RefPurchaseDetailId=" & Val(grd.GetRows(i).Cells("ReceivingDetailId").Value.ToString) & ""
                    objCommand.ExecuteNonQuery()
                    'End TASKM106151

                End If

                'objCommand.ExecuteNonQuery()
                'Val(grd.Rows(i).Cells(5).Value)

                'update date Purchase Order Detail table

                'objCommand.CommandText = "UPDATE    PurchaseOrderDetailTable" _
                '                        & " SET              DeliveredQty = isnull(DeliveredQty,0) +  " & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & "" _
                '                        & " WHERE     (ArticleDefId = " & Val(grd.GetRows(i).Cells("ItemId").Value.ToString) & ")"

                'objCommand.CommandText += " AND (PurchaseOrderId = " & Me.cmbPo.SelectedValue & ")"
                'If Val(grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) > 0 Then
                '    objCommand.CommandText += " AND (PurchaseOrderDetailId = " & Val(grd.GetRows(i).Cells("PurchaseOrderDetailId").Value.ToString) & ")"
                'End If

                'objCommand.ExecuteNonQuery()
                If ServiceItem1 = False Then

                    If Val(grd.GetRows(i).Cells("rate").Value.ToString) > 0 AndAlso ShouldStockImpactGo = True Then

                        If flgAvgRate = True Then

                            objCommand.CommandText = ""
                            objCommand.CommandText = "UPDATE ArticleDefTableMaster Set PurchasePrice=" & (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))) & ", Cost_Price=" & Val(StockDetail.CostPrice) & " WHERE ArticleId in (Select MasterId From ArticleDefTable WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ")"
                            objCommand.ExecuteNonQuery()


                            objCommand.CommandText = ""
                            objCommand.CommandText = "UPDATE ArticleDefTable Set PurchasePrice=" & (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))) & ", Cost_Price=" & Val(StockDetail.CostPrice) & " WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                            objCommand.ExecuteNonQuery()

                            objCommand.CommandText = ""
                            objCommand.CommandText = " Select a.ArticleDefId, b.SalesItem From IncrementReductionTable a INNER JOIN ArticleDefView b ON b.ArticleId = a.ArticleDefId WHERE (Convert(varchar, a.IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102))  AND a.ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                            Dim dtRate As New DataTable
                            Dim daRate As New OleDbDataAdapter(objCommand)
                            daRate.Fill(dtRate)

                            objCommand.CommandText = "Select ISNULL(SalesItem,0) as SalesItem From ArticleDefView WHERE Active=1 AND ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " "
                            Dim dtSalesItem As New DataTable
                            Dim daSalesItem As New OleDbDataAdapter(objCommand)
                            daSalesItem.Fill(dtSalesItem)

                            If dtSalesItem.Rows.Count > 0 Then
                                If Not dtRate Is Nothing Then
                                    If dtRate.Rows.Count > 0 Then
                                        objCommand.CommandText = "Update IncrementReductionTable Set PurchaseNewPrice=" & (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & ", SaleNewPrice=" & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))))) & ", Cost_Price_New=" & Val(StockDetail.CostPrice) & "  WHERE ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND (Convert(varchar, IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102)) "
                                        objCommand.ExecuteNonQuery()
                                    Else
                                        objCommand.CommandText = "INSERT INTO IncrementReductionTable(IncrementReductionDate, ArticleDefId, StockQty, PurchaseOldPrice, PurchaseNewPrice, SaleOldPrice,SaleNewPrice, Cost_Price_Old, Cost_Price_New) " _
                                        & " Values(N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ",  " & Val(0) & ", " & Val(0) & ", " & (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString))) & ", " & Val(0) & ", " & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, (StockDetail.Rate - (Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) + Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) + Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)))) & ",0," & Val(StockDetail.CostPrice) & ")"
                                        objCommand.ExecuteNonQuery()
                                    End If
                                End If
                            End If
                        Else


                            objCommand.CommandText = ""
                            objCommand.CommandText = "UPDATE ArticleDefTableMaster Set PurchasePrice=" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", Cost_Price=" & Val(StockDetail.CostPrice) & ", CurrencyAmount =" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " WHERE ArticleId in (Select MasterId From ArticleDefTable WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ")"
                            objCommand.ExecuteNonQuery()

                            'Apply Current Rate 
                            objCommand.CommandText = "UPDATE ArticleDefTable Set PurchasePrice=" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", Cost_Price=" & Val(StockDetail.CostPrice) & ", CurrencyAmount =" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & " WHERE ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                            objCommand.ExecuteNonQuery()

                            objCommand.CommandText = " Select a.ArticleDefId, b.SalesItem From IncrementReductionTable a INNER JOIN ArticleDefView b ON b.ArticleId = a.ArticleDefId WHERE (Convert(varchar, a.IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102))  AND a.ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ""
                            Dim dtRate As New DataTable
                            Dim daRate As New OleDbDataAdapter(objCommand)
                            daRate.Fill(dtRate)

                            objCommand.CommandText = "Select ISNULL(SalesItem,0) as SalesItem From ArticleDefView WHERE Active=1 AND ArticleId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " "
                            Dim dtSalesItem As New DataTable
                            Dim daSalesItem As New OleDbDataAdapter(objCommand)
                            daSalesItem.Fill(dtSalesItem)

                            If dtSalesItem.Rows.Count > 0 Then
                                If Not dtRate Is Nothing Then
                                    If dtRate.Rows.Count > 0 Then
                                        objCommand.CommandText = "Update IncrementReductionTable Set PurchaseNewPrice=" & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", SaleNewPrice=" & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString)) & ", Cost_Price_New=" & Val(StockDetail.CostPrice) & "  WHERE ArticleDefId=" & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & " AND (Convert(varchar, IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102)) "
                                        objCommand.ExecuteNonQuery()
                                    Else
                                        objCommand.CommandText = "INSERT INTO IncrementReductionTable(IncrementReductionDate, ArticleDefId, StockQty, PurchaseOldPrice, PurchaseNewPrice, SaleOldPrice,SaleNewPrice,Cost_Price_Old, Cost_Price_New) " _
                                        & " Values(N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " & IIf(Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells("AlternativeItemId").Value.ToString), Val(Me.grd.GetRows(i).Cells("ItemId").Value.ToString)) & ",  " & Val(0) & ", " & Val(0) & ", " & Val(grd.GetRows(i).Cells("Rate").Value.ToString) & ", " & Val(0) & ", " & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, Val(grd.GetRows(i).Cells("Rate").Value.ToString)) & ",0," & Val(StockDetail.CostPrice) & ")"
                                        objCommand.ExecuteNonQuery()
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
                'Dim CurrencyDeduction As Double = (Val(grd.GetRows(i).Cells("BardanaDeduction").Value.ToString) + Val(grd.GetRows(i).Cells("OtherDeduction").Value.ToString)) * Val(grd.GetRows(i).Cells("Rate").Value.ToString)
                '***********************
                'Inserting Debit Amount
                '***********************
                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & Val(grd.Rows(i).Cells("qty").Value) * Val(grd.Rows(i).Cells("rate").Value) & ", 0, N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")')"

                objCommand.CommandText = ""
                'Before against task:2376
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", "" & Val(grd.GetRows(i).Cells("qty").Value.ToString) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & "", "" & (Val(grd.GetRows(i).Cells("PackQty").Value) * Val(grd.GetRows(i).Cells("Qty").Value.ToString)) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & "") & ", 0, N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & " X " & " " & Me.grd.GetRows(i).Cells("rate").Value - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ")"
                'Task:2376 Change Comments Layouts
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("rate").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ",0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                'End Task:2376
                objCommand.ExecuteNonQuery()

                '***********************
                'Inserting Credit Amounts
                '***********************
                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(grd.Rows(i).Cells("qty").Value) * Val(grd.Rows(i).Cells("rate").Value) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")')"

                objCommand.CommandText = ""
                'Before against task:2376
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", "" & Val(grd.GetRows(i).Cells("qty").Value.ToString) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & "", "" & (Val(grd.GetRows(i).Cells("PackQty").Value) * Val(grd.GetRows(i).Cells("Qty").Value.ToString)) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) & "") & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("Qty").Value.ToString) & " X " & " " & Me.grd.GetRows(i).Cells("rate").Value - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & "," & grd.GetRows(i).Cells("ItemId").Value & ")"
                ''Task:2376 Change Comments Layout
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("rate").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                ''End Task:2376
                'objCommand.ExecuteNonQuery()
                'Vendor Quantity Based Credit By Imran Ali 26-9-2017
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) * Val(grd.GetRows(i).Cells("rate").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) * Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                objCommand.ExecuteNonQuery()
                'nd

                'Vendor Quantity Based Credit By Imran Ali 26-9-2017
                If (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) <> (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) Then
                    If (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) > (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) Then
                        objCommand.CommandText = ""
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,  comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & VendorDifferenceQtyAccount & ", 0, " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) - (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", N'Ref:Subtract Quantity', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) - (Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString))) * Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                        objCommand.ExecuteNonQuery()
                    Else
                        objCommand.CommandText = ""
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, credit_amount, debit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Credit_Amount,  Currency_Debit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & VendorDifferenceQtyAccount & ", 0, " & ((Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) - Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) * Val(grd.GetRows(i).Cells("rate").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", N'Ref:Add Quantity', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", 0, " & ((Val(grd.GetRows(i).Cells("Vendor_Qty").Value.ToString) - Val(grd.GetRows(i).Cells("Deduction").Value.ToString)) - Val(grd.GetRows(i).Cells("TotalQty").Value.ToString)) * Val(grd.GetRows(i).Cells("rate").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"
                        objCommand.ExecuteNonQuery()
                    End If
                End If
                'nd


                'If flgTransaportationChargesVoucher = True Then
                '    If Not Me.cmbTransportationVendor.ActiveRow Is Nothing Then
                '        If Me.cmbTransportationVendor.Value > 0 Then
                '            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Then
                '                '************************************
                '                'Transportation Charges Voucher Debit
                '                '************************************
                '                ' objCommand.CommandText = ""
                '                ' objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty

                '                objCommand.ExecuteNonQuery()

                '                '************************************
                '                'Transportation Charges Voucher Credit
                '                '************************************
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbTransportationVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"

                '                objCommand.ExecuteNonQuery()
                '            End If
                '        Else
                '            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Then
                '                '************************************
                '                'Transportation Charges Voucher Debit
                '                '************************************
                '                ' objCommand.CommandText = ""
                '                ' objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty

                '                objCommand.ExecuteNonQuery()

                '                '************************************
                '                'Transportation Charges Voucher Credit
                '                '************************************
                '                objCommand.CommandText = ""
                '                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                '                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"

                '                objCommand.ExecuteNonQuery()
                '            End If
                '        End If
                '    End If
                'End If


                If flgTransaportationChargesVoucher = True Then
                    If Not Me.cmbTransportationVendor.ActiveRow Is Nothing Then
                        If Me.cmbTransportationVendor.Value > 0 Then
                            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Or Val(TransCharges) <> 0 Then
                                '************************************
                                'Transportation Charges Voucher Debit
                                '************************************
                                ' objCommand.CommandText = ""
                                ' objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty
                                objCommand.CommandText = ""
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty

                                objCommand.ExecuteNonQuery()

                                '************************************
                                'Transportation Charges Voucher Credit
                                '************************************
                                objCommand.CommandText = ""
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbTransportationVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"

                                objCommand.ExecuteNonQuery()
                            End If
                        Else
                            If Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) <> 0 Or Val(TransCharges) <> 0 Then
                                '************************************
                                'Transportation Charges Voucher Debit
                                '************************************
                                ' objCommand.CommandText = ""
                                ' objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & Val(Me.grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & Me.cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("CurrencyAmount").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbcurrency.selectedvalue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty
                                objCommand.CommandText = ""
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")" ''TASK-408 added TotalQty

                                objCommand.ExecuteNonQuery()

                                '************************************
                                'Transportation Charges Voucher Credit
                                '************************************
                                objCommand.CommandText = ""
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString)) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ")"

                                objCommand.ExecuteNonQuery()
                            End If
                        End If
                    End If
                End If


                If Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString) <> 0 Then
                    '************************************
                    'Custom Charges Voucher Debit
                    '************************************
                    objCommand.CommandText = ""
                    'Murtaza
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & AccountId & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) * Val(grd.GetRows(i).Cells("CurrencyRate").Value.ToString) & ", 0,N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ", 0, " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")" ''TASK-408 added TotalQty

                    objCommand.ExecuteNonQuery()

                    '************************************
                    'Custom Charges Voucher Credit
                    '************************************
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbCustomVendor.Value & ", 0," & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) * Val(txtCurrencyRate.Text) & ", N'" & grd.GetRows(i).Cells("item").Value & " " & Me.grd.GetRows(i).Cells("Size").Value & "  (" & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) & " X " & " " & IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ") " & " " & grd.GetRows(i).Cells("Comments").Text.Replace("'", "''") & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & " , 0, " & Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * IIf(Val(cmbCustomVendor.Value) > 0, Val(grd.GetRows(i).Cells("Custom_Charges").Value.ToString), 0) & ", " & Val(grd.GetRows(i).Cells("BaseCurrencyId").Value.ToString) & " , " & Val(grd.GetRows(i).Cells("BaseCurrencyRate").Value.ToString) & ", " & cmbCurrency.SelectedValue & " , " & Val(txtCurrencyRate.Text) & ")"
                    objCommand.ExecuteNonQuery()
                End If

                'TASK-TFS-51 Additioanl Tax Voucher 
                If Val(grd.GetRows(i).Cells("AdTax_Amount").Value) > 0 Then

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & intAdditionalTaxAcId & ", " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ",0, 'Ref:Additional Tax Against " & Me.cmbVendor.Text.Replace("'", "''") & ", " & Me.txtPONo.Text.Replace("'", "''") & "" & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells("ItemId").Value & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString()) & ", " & Val(0) & ")"
                    objCommand.ExecuteNonQuery()

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, direction, Currency_Debit_Amount,Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0, " & Val(grd.GetRows(i).Cells("AdTax_Amount").Value.ToString) & ", 'Ref:Additional Tax Against " & Me.txtPONo.Text.Replace("'", "''") & "',N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & grd.GetRows(i).Cells("ItemId").Value & ", " & Val(0) & "," & Val(grd.GetRows(i).Cells("CurrencyAdTaxAmount").Value.ToString) & ")"
                    objCommand.ExecuteNonQuery()

                End If
                'END TASK TSK-TFS-51



            Next

            'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.

            If Val(Me.txtAdjustment.Text) > 0 Then
                Dim TotalAmount1 As Double = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total Amount"), Janus.Windows.GridEX.AggregateFunction.Sum)
                Dim DiscountAdj As Double = 0
                If Me.rbtAdjFlat.Checked = True Then
                    DiscountAdj = Val(Me.txtAdjustment.Text)
                Else
                    DiscountAdj = (TotalAmount1 * Val(Me.txtAdjustment.Text) / 100)
                End If
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & DiscountAdj & ", 0, N'Purchase Adjustment Discount voucher', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & DiscountAdj & ", 0, 1,1,1,1)"
                objCommand.ExecuteNonQuery()

                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId, Currency_Debit_Amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & PurchaseDiscountAccountId & ", 0, " & DiscountAdj & ", N'Purchase Adjustment Discount voucher', N'" & Me.txtInvoiceNo.Text.Replace("'", "''").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", 0, " & DiscountAdj & ", 1, 1, 1, 1)"
                objCommand.ExecuteNonQuery()
            End If

            If Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) > 0 Then
                'Inserting Tax Debit With Purchase Tax Account
                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & PurchaseTaxAccountId & ", " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",  " & 0 & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ",0)"
                objCommand.ExecuteNonQuery()

                'Inserting Tax Credit With Vendor Account
                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, sp_refrence, CostCenterId,Currency_Debit_Amount,Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ", 'Tax Ref: " & Me.txtPONo.Text & "', N'" & Me.txtInvoiceNo.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ",0, " & Val(grd.GetTotal(grd.RootTable.Columns("CurrencyTaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)) & ")"
                objCommand.ExecuteNonQuery()

            End If


            If PaymentVoucherFlg = "True" Then
                objCommand.CommandText = ""
                objCommand.CommandText = "Delete From tblVoucherDetail WHERE Voucher_Id=" & VoucherId
                objCommand.ExecuteNonQuery()
            End If

            objCommand.CommandText = ""
            objCommand.CommandText = "Delete From InwardExpenseDetailTable WHERE PurchaseId=" & Val(Me.txtReceivingID.Text) & " AND Doctype='PUR'"
            objCommand.ExecuteNonQuery()


            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grdInwardExpDetail.GetRows
                'If Val(r.Cells("Exp_Amount").Value.ToString) <> 0 Then
                '    objCommand.CommandText = ""
                '    objCommand.CommandText = "INSERT INTO InwardExpenseDetailTable(PurchaseId, AccountId, Exp_Amount,DocType) Values(" & Val(Me.txtReceivingID.Text) & ", " & Val(r.Cells("AccountId").Value.ToString) & ", " & Val(r.Cells("Exp_Amount").Value.ToString) & ",'PUR')"
                '    objCommand.ExecuteNonQuery()


                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(Me.cmbVendor.Value) & ", " & 0 & ",  " & Val(r.Cells("Exp_Amount").Value.ToString) & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & Me.cmbProject.SelectedValue & " )"

                '' objCommand.Transaction = trans
                'objCommand.ExecuteNonQuery()



                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(r.Cells("AccountId").Value.ToString) & ",   " & Val(r.Cells("Exp_Amount").Value.ToString) & "," & 0 & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & Me.cmbProject.SelectedValue & " )"

                '' objCommand.Transaction = trans
                'objCommand.ExecuteNonQuery()


                If Val(r.Cells("Debit").Value.ToString) <> 0 Or Val(r.Cells("Credit").Value.ToString) <> 0 Then
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO InwardExpenseDetailTable(PurchaseId, AccountId, Exp_Amount,DocType) Values(" & Val(Me.txtReceivingID.Text) & ", " & Val(r.Cells("AccountId").Value.ToString) & ", " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), -Val(r.Cells("Credit").Value.ToString)) & ",'PUR')"
                    objCommand.ExecuteNonQuery()

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(Me.cmbVendor.Value), Val(r.Cells("AccountId").Value.ToString)) & ", " & 0 & ",  " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), Val(r.Cells("Credit").Value.ToString)) & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()



                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & IIf(Val(r.Cells("Credit").Value.ToString) > 0, Val(Me.cmbVendor.Value), Val(r.Cells("AccountId").Value.ToString)) & ",   " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), Val(r.Cells("Credit").Value.ToString)) & "," & 0 & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            Next
            If PaymentVoucherFlg = "True" AndAlso Val(Me.txtRecAmount.Text) <> 0 Then

                If Not ExistingVoucherFlg = True Then

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                                               & " cheque_no, cheque_date,post,Source,voucher_code,coa_detail_id)" _
                                               & " VALUES(" & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", 1,  " & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", N'" & VoucherNo & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                                               & " " & IIf(Me.txtChequeNo.Visible = True, "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'", "NULL") & ", " & IIf(Me.dtpChequeDate.Visible = True, "N'" & dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'", "NULL") & ", " & IIf(Me.chkPost.Checked = True, 1, 0) & ",'frmPurchase',N'" & Me.txtPONo.Text & "', " & Me.cmbDepositAccount.SelectedValue & ")" _
                                               & " SELECT @@IDENTITY"

                    'objCommand.Transaction = trans
                    lngVoucherMasterId = objCommand.ExecuteScalar


                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, cheque_no, cheque_date) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtRecAmount.Text) & ", 0, 'Payment Ref: " & Me.txtPONo.Text & ":" & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'") & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'") & " )"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, cheque_no,cheque_date) " _
                                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbDepositAccount.SelectedValue & ", " & 0 & ",  " & Val(Me.txtRecAmount.Text) & ", 'Payment Ref: " & Me.txtPONo.Text & ":" & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'") & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'") & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                Else

                    objCommand.CommandText = ""
                    objCommand.CommandText = "Update tblVoucher Set Voucher_Type_Id=" & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", Voucher_No=N'" & Me.txtVoucherNo.Text & "', Voucher_Date=N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', Cheque_No=" & IIf(Me.txtChequeNo.Visible = True, "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'", "NULL") & ", Cheque_Date=" & IIf(Me.dtpChequeDate.Visible = True, "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'", "NULL") & ", coa_detail_id=" & Me.cmbDepositAccount.SelectedValue & " WHERE Voucher_Id=" & VoucherId
                    objCommand.ExecuteNonQuery()

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId,cheque_no,cheque_date) " _
                                           & " VALUES(" & VoucherId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtRecAmount.Text) & ", 0, 'Payment Ref: " & Me.txtPONo.Text & ":" & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " ," & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'") & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'") & ")"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, cheque_no,cheque_date) " _
                                                         & " VALUES(" & VoucherId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Me.cmbDepositAccount.SelectedValue & ", " & 0 & ",  " & Val(Me.txtRecAmount.Text) & ", 'Payment Ref: " & Me.txtPONo.Text & ":" & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & "," & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'") & ", " & IIf(Me.txtChequeNo.Text = "", "NULL", "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mmm:ss tt") & "'") & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If

            'If Me.cmbPo.SelectedIndex > 0 Then
            '    'Before against task:2696
            '    'objCommand.CommandText = "Select Qty , isnull(DeliveredQty,0) as DeliveredQty from PurchaseOrderDetailTable where PurchaseOrderID = " & Me.cmbPo.SelectedValue & ""
            '    ''19-June-2014 TASK:2696 IMRAN ALI Default Selected Invoice Party Through Customer List(Ravi)
            '    objCommand.CommandText = "Select SUM(IsNull(Sz1,0)) as Qty , SUM(isnull(DeliveredQty,0)) as DeliveredQty from PurchaseOrderDetailTable where PurchaseOrderID = " & Me.cmbPo.SelectedValue & ""
            '    'End Task:2696
            '    da.SelectCommand = objCommand
            '    Dim dt As New DataTable
            '    da.Fill(dt)
            '    dt.AcceptChanges()
            '    Dim blnEqual As Boolean = True

            '    If dt.Rows.Count > 0 Then
            '        For Each r As DataRow In dt.Rows
            '            If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
            '                blnEqual = False
            '                Exit For
            '            End If
            '        Next
            '    End If

            '    If blnEqual = True Then
            '        objCommand.CommandText = "Update PurchaseOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where PurchaseOrderID = " & Me.cmbPo.SelectedValue & ""
            '        objCommand.ExecuteNonQuery()
            '    Else
            '        objCommand.CommandText = "Update PurchaseOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where PurchaseOrderID = " & Me.cmbPo.SelectedValue & ""
            '        objCommand.ExecuteNonQuery()
            '    End If
            'End If





            If Val(Me.txtTaxDeductAmount.Text) > 0 Then



                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(Me.cmbVendor.Value) & ", " & Val(Me.txtTaxDeductAmount.Text) & ", " & 0 & ",N'Ref tax deduction against:" & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"
                objCommand.ExecuteNonQuery()



                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & Val(PurchaseTaxDeductionAcId) & ", " & 0 & "," & Val(Me.txtTaxDeductAmount.Text) & ", N'Ref tax deduction against: " & Me.cmbVendor.ActiveRow.Cells("Name").Text.Replace("'", "''") & ", " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & " )"
                objCommand.ExecuteNonQuery()




            End If


            UpdateInwardExpense(Val(Me.txtReceivingID.Text), trans)
            UpdatePOStatus(Val(Me.txtReceivingID.Text), trans) ' Update PO Status
            ''Start TFS2576
            UpdateGRNStatus(Val(Me.txtReceivingID.Text), trans) 'Update GRN Status
            ''End TFS2576

            'If IsValidate() = True Then
            '    StockMaster.StockTransId = StockTransId(Me.txtPONo.Text, trans)
            '    Call New StockDAL().Update(StockMaster, trans)
            'End If

            ''TASK TFS1378 changed conditions for stock impact on 16-10-2017
            ''Below lines are commented on 22-02-2018
            'If GRNStockImpact = True AndAlso ReceivingNoteId > 0 Then

            'Else
            '    If IsValidate() = True Then
            '        StockMaster.StockTransId = StockTransId(Me.txtPONo.Text, trans)
            '        Call New StockDAL().Update(StockMaster, trans)
            '    End If
            'End If
            ''End TASK TFS1378
            'If GRNStockImpact = True AndAlso ReceivingNoteId > 0 Then

            'Else
            If IsValidate() = True AndAlso ShouldStockImpactGo = True Then
                StockMaster.StockTransId = StockTransId(Me.txtPONo.Text, trans)
                Call New StockDAL().Update(StockMaster, trans)
            End If
            'End If

            trans.Commit()
            Update_Record = True

            'insertvoucher()
            'Call Update1() 'Upgrading Stock ...
            If blnUpdateAll = False Then SendSMS()

            SaveActivityLog("POS", Me.Text, EnumActions.Update, LoginUserId, EnumRecordType.Purchase, Me.txtPONo.Text.Trim, True)
            SaveActivityLog("Accounts", Me.Text, EnumActions.Update, LoginUserId, EnumRecordType.AccountTransaction, Me.txtPONo.Text, True)

            ''Start TFS2989
            If ValidateApprovalProcessMapped(Me.txtPONo.Text.Trim, Me.Name) Then
                If ValidateApprovalProcessIsInProgressAgain(Me.txtPONo.Text.Trim, Me.Name) = False Then
                    SaveApprovalLog(EnumReferenceType.Purchase, getVoucher_Id, Me.txtPONo.Text.Trim, Me.dtpPODate.Value.Date, "Purchase ," & cmbVendor.Text & "", Me.Name, 6)
                End If
            End If
            ''End TFS2989

            ''insertvoucher()
            'Call Update1() 'Upgrading Stock ...
            setVoucherNo = Me.txtPONo.Text
            getVoucher_Id = Me.txtReceivingID.Text
            setEditMode = True
            Total_Amount = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum) + Total_Amount = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum) + Me.grd.GetTotal(Me.grd.RootTable.Columns("TaxAmount"), Janus.Windows.GridEX.AggregateFunction.Sum)
            drReceivingNote = Nothing 'ReqId-970 Set Receiving Row Nothing

        Catch ex As Exception
            trans.Rollback()
            Update_Record = False
            ShowErrorMessage("An error occured while updating record" & ex.Message)
        End Try
    End Function



    Private Sub SaveToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnSave.Click
        If Me.BtnSave.Enabled = False Then Exit Sub
        Me.Cursor = Cursors.WaitCursor
        Try
            Me.grd.Update()
            Me.grd.UpdateData()
            'ValidateDateLock()
            'If flgDateLock = True Then ShowErrorMessage("Previous date work not allowed") : Exit Sub
            'If flgDateLock = True Then
            '    If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00"))) Then
            '        ShowErrorMessage("Previous date work not allowed") : Exit Sub
            '    End If
            'End If
            If IsDateLock(Me.dtpPODate.Value) = True Then
                ShowErrorMessage(str_ErrorPreviouseDateRecordUpdateAllow) : Exit Sub
            End If
            If Convert.ToDateTime(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00")) <= Convert.ToDateTime((getConfigValueByType("EndOfDate").ToString)) Then
                ShowErrorMessage("Your can not change this becuase financial year is closed")
                Me.dtpPODate.Focus()
                Exit Sub
            End If
            If FormValidate() Then
                Me.grd.UpdateData()
                If Me.BtnSave.Text = "Save" Or Me.BtnSave.Text = "&Save" Then
                    'If Not msg_Confirm(str_ConfirmSave) = True Then Exit Sub
                    'If Not msg_Confirm(str_ConfirmSave) = True Then Exit Sub

                    'If Not msg_Confirm(str_ConfirmSave) = True Then Exit Sub
                    Me.lblProgress.Text = "Processing Please Wait ..."
                    Me.lblProgress.Visible = True
                    Application.DoEvents()
                    If Save() Then
                        DisplayRecord()
                        Me.ReceivingId = 0
                        '' Made changes to  against TASK TFS1462 on 13-09-2017
                        Dim Printing As Boolean
                        Printing = Convert.ToBoolean(getConfigValueByType("Print").ToString)
                        Dim DirectVoucherPrinting As Boolean
                        DirectVoucherPrinting = Convert.ToBoolean(getConfigValueByType("DirectVoucherPrinting").ToString)
                        If Printing = True Or DirectVoucherPrinting = True Then
                            If msg_Confirm("Do you want to print", Printing, DirectVoucherPrinting) = True Then
                                Dim Print1 As Boolean = frmMessages.Print
                                Dim PrintVoucher As Boolean = frmMessages.DirectVoucherPrinting
                                If Print1 = True Then
                                    Call Isprint(getVoucher_Id)
                                End If
                                If PrintVoucher = True Then
                                    GetVoucherPrint(Me.txtPONo.Text, "frmPurchase", BaseCurrencyName, BaseCurrencyId, True)
                                End If
                            End If
                        End If
                        ''END TASK TFS1462



                        'EmailSave()
                        flgSelectProject = True
                        'msg_Information(str_informSave)
                        RefreshControls()
                        ClearDetailControls()

                        '''''''''''''''''''''''''''''''''
                        ' Altered against Task# 20150504 Ali Ansari
                        ''Below lines of code are commented on 14-09-2017
                        'Dim Printing As Boolean = Convert.ToBoolean(getConfigValueByType("Print").ToString)
                        'If Printing = True Then
                        '    If msg_Confirm("Do you want to print") = True Then
                        '        Call Isprint(getVoucher_Id)
                        '    End If
                        'End If
                        ' Altered against Task# 20150504 Ali Ansari




                        ''''''''''''''''''''''''''''''''
                        'grd.Rows.Clear()
                        'DisplayRecord() R933 Commented History Data


                        If BackgroundWorker2.IsBusy Then Exit Sub
                        BackgroundWorker2.RunWorkerAsync()
                        'Do While BackgroundWorker2.IsBusy
                        '    Application.DoEvents()
                        'Loop
                        '---------------------------------
                        If BackgroundWorker1.IsBusy Then Exit Sub
                        BackgroundWorker1.RunWorkerAsync()
                        'Do While BackgroundWorker1.IsBusy
                        '    Application.DoEvents()
                        'Loop

                    Else
                        Exit Sub 'MsgBox("Record has not been added")
                    End If
                Else
                    If Not msg_Confirm(str_ConfirmUpdate) = True Then Exit Sub
                    Me.lblProgress.Text = "Processing Please Wait ..."
                    Me.lblProgress.Visible = True
                    Application.DoEvents()
                    If Update_Record() Then
                        ''''''''''''''''''''''''''''''''''''''''''
                        ' Altered against Task# 20150504 Ali Ansari
                        '' Below section of code is commented against TASK TFS1462
                        'Dim Printing As Boolean
                        'Printing = Convert.ToBoolean(getConfigValueByType("Print").ToString)
                        'If Printing = True Then
                        '    If msg_Confirm("Do you want to print") = True Then
                        '        Call Isprint()
                        '    End If
                        'End If
                        ' Altered against Task# 20150504 Ali Ansari
                        ''''''''''''''''''''''''''''''''''''''''''
                        'DisplayRecord()
                        '' Made changes to  against TASK TFS1462 on 13-09-2017
                        Dim Printing As Boolean
                        Printing = Convert.ToBoolean(getConfigValueByType("Print").ToString)
                        Dim DirectVoucherPrinting As Boolean
                        DirectVoucherPrinting = Convert.ToBoolean(getConfigValueByType("DirectVoucherPrinting").ToString.Replace("Error", "false"))
                        If Printing = True Or DirectVoucherPrinting = True Then
                            If msg_Confirm("Do you want to print", Printing, DirectVoucherPrinting) = True Then
                                Dim Print1 As Boolean = frmMessages.Print
                                Dim PrintVoucher As Boolean = frmMessages.DirectVoucherPrinting
                                If Print1 = True Then
                                    Call Isprint(getVoucher_Id)
                                End If
                                If PrintVoucher = True Then
                                    GetVoucherPrint(Me.txtPONo.Text, "frmPurchase", BaseCurrencyName, BaseCurrencyId, True)
                                End If
                            End If
                        End If
                        ''END TASK TFS1462
                        ' EmailSave()
                        flgSelectProject = True
                        'msg_Information(str_informUpdate)
                        RefreshControls()
                        ClearDetailControls()
                        'grd.Rows.Clear()
                        'DisplayRecord() R933 Commented History Data

                        If BackgroundWorker2.IsBusy Then Exit Sub
                        BackgroundWorker2.RunWorkerAsync()
                        'Do While BackgroundWorker2.IsBusy
                        '    Application.DoEvents()
                        'Loop
                        '---------------------------------
                        If BackgroundWorker1.IsBusy Then Exit Sub
                        BackgroundWorker1.RunWorkerAsync()
                        'Do While BackgroundWorker1.IsBusy
                        '    Application.DoEvents()
                        'Loop

                    Else
                        Exit Sub 'MsgBox("Record has not been updated")
                    End If
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
            Me.lblProgress.Visible = False
        End Try
    End Sub
    Private Sub NewToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnNew.Click
        Try
            Me.Cursor = Cursors.WaitCursor
            'Dim s As String
            's = "1234-567-890"
            'MsgBox(Microsoft.VisualBasic.Right(s, InStr(1, s, "-") - 2))
            If Me.grd.RowCount > 0 Then
                If Not msg_Confirm(str_ConfirmGridClear) = True Then Exit Sub
            End If
            flgSelectProject = False

            RefreshControls()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub OpenToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnEdit.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            EditRecord()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    Private Sub grdSaved_CellDoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles grdSaved.DoubleClick
        ''Task#A1 12-06-2015 Add Check on grdSaved to check on double click if row less than zero than exit
        Try
            If Me.grdSaved.Row < 0 Then
                Exit Sub
            Else
                EditRecord()
                'Me.UltraTabControl1.SelectedTab = Me.UltraTabControl1.Tabs(0).TabPage.Tab
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
        ''End Task#A1 12-06-2015
    End Sub

    Private Sub cmbPo_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbPo.SelectedIndexChanged
        Try
            If Me.cmbPo.SelectedIndex <= 0 Then Exit Sub


            If Me.BtnSave.Text <> "&Save" Then
                If Val(Me.grdSaved.GetRow.Cells("PurchaseOrderID").Value.ToString) > 0 Then
                    If Me.cmbPo.SelectedIndex > 0 Then
                        If Me.cmbPo.SelectedValue <> (Me.grdSaved.GetRow.Cells("PurchaseOrderID").Value.ToString) Then
                            If msg_Confirm("You have changed PO [" & CType(Me.cmbPo.SelectedItem, DataRowView).Row.Item("PurchaseOrderNo").ToString & "], do you want to proceed. ?") = False Then
                                RemoveHandler cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
                                Me.cmbPo.SelectedValue = (Me.grdSaved.GetRow.Cells("PurchaseOrderID").Value.ToString)
                                AddHandler cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
                                Exit Sub
                            End If
                        Else
                            Exit Sub
                        End If
                    End If
                End If
            End If


            If flgAutoLoadPO = False Then Exit Sub 'R:979 Check Auto Load PO
            Me.txtRemarks.Text = CType(Me.cmbPo.SelectedItem, DataRowView).Item("Remarks").ToString 'GetPurchaseRemarks(Me.cmbPo.SelectedValue).ToString
            Me.txtDcNo.Text = CType(Me.cmbPo.SelectedItem, DataRowView).Item("DcNo").ToString 'GetPODcNo(Me.cmbPo.SelectedValue).ToString
            Me.cmbProject.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("CostCenterId").ToString)
            Me.cmbCurrency.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("CurrencyType").ToString)
            Me.txtCurrencyRate.Text = CType(Me.cmbPo.SelectedItem, DataRowView).Item("CurrencyRate").ToString
            Me.DisplayPODetail(Me.cmbPo.SelectedValue)
            'If Me.cmbPo.SelectedIndex > 0 Then
            '    Dim adp As New OleDbDataAdapter
            '    Dim dt As New DataTable
            '    Dim Sql As String = "SELECT     dbo.PurchaseOrderMasterTable.VendorId, dbo.vwCOADetail.detail_title FROM         dbo.PurchaseOrderMasterTable INNER JOIN                       dbo.vwCOADetail ON dbo.PurchaseOrderMasterTable.VendorId = dbo.vwCOADetail.coa_detail_id where PurchaseOrderMasterTable.PurchaseOrderId=" & Me.cmbPo.SelectedValue
            '    adp = New OleDbDataAdapter(Sql, Con)
            '    adp.Fill(dt)

            '    If Not dt.Rows.Count > 0 Then
            '        Me.cmbVendor.Enabled = True : Me.cmbVendor.Rows(0).Activate()
            '    Else
            '        Me.cmbVendor.Value = dt.Rows(0).Item("VendorId").ToString
            '        Me.cmbVendor.Enabled = False
            '    End If
            'GetTotal()
            'Else
            'Me.cmbVendor.Enabled = True
            'Me.cmbVendor.Rows(0).Activate()
            'End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub cmbItem_KeyDown(sender As Object, e As KeyEventArgs) Handles cmbItem.KeyDown
        Try
            ''TFS1858 : Ayesha Rehman :Item dropdown shall be searchable
            If e.KeyCode = Keys.F1 Then
                If flgCompanyRights = True Then
                    frmItemSearch.CompanyId = MyCompanyId
                End If
                If getConfigValueByType("ArticleFilterByLocation") = "True" Then
                    If GetRestrictedItemFlg(Me.cmbCategory.SelectedValue) = True Then
                        frmItemSearch.LocationId = Me.cmbCategory.SelectedValue
                    Else
                        frmItemSearch.LocationId = 0
                    End If
                End If

                If Me.rbtVendor.Checked = True Then
                    If Me.cmbVendor.ActiveRow Is Nothing Then Exit Sub
                    frmItemSearch.VendorId = Me.cmbVendor.Value
                End If
                ''Start TFS3762
                If flgAddItemForMall = True Then
                    frmItemSearch.formName = Me.Name
                End If
                ''End TFS3762
                If Not Me.cmbCategory.SelectedIndex = -1 Then
                    frmItemSearch.LocationComments = CType(Me.cmbCategory.SelectedItem, DataRowView).Item("comments").ToString()
                End If
                frmItemSearch.BringToFront()
                frmItemSearch.ShowDialog()
                If frmItemSearch.DialogResult = Windows.Forms.DialogResult.OK Then
                    cmbItem.Value = frmItemSearch.ArticleId
                    txtQty.Text = frmItemSearch.Qty
                    txtRate.Text = frmItemSearch.Rate
                    cmbUnit.SelectedIndex = IIf(frmItemSearch.PackName <> "Loose", 1, 0)
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub grd_CellEndEdit(ByVal sender As Object, ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.CellEdited

    '    With Me.grd.CurrentRow
    '        Me.grd.UpdateData()
    '        '.Cells("Qty").Value = Val(.Cells("ReceivedQty").Value) - Val(.Cells("RejectedQty").Value)
    '        'If Val(Me.grd.CurrentRow.Cells("RejectedQty").Value) > Val(Me.grd.CurrentRow.Cells("ReceivedQty").Value) Then
    '        '    ShowErrorMessage("Rejected Qty Grater Than Received Qty")
    '        '    ' e.Cancel = True
    '        '    Me.grd.CurrentRow.Cells("RejectedQty").Value = 0
    '        '    .Cells("Qty").Value = Val(.Cells("ReceivedQty").Value) - Val(.Cells("RejectedQty").Value)
    '        'End If

    '        'If Me.grd.CurrentRow.Cells("Unit").Value = "Loose" Then
    '        '    'txtPackQty.Text = 1
    '        '    .Cells("Total").Value = Val(.Cells("Qty").Value) * Val(.Cells("Rate").Value)
    '        'Else
    '        '    .Cells("Total").Value = (Val(.Cells("Qty").Value) * Val(.Cells("Rate").Value) * Val(.Cells("PackQty").Value))
    '        'End If
    '        ''If Not grd.DataSource Is Nothing Then CType(grd.DataSource, DataTable).AcceptChanges()
    '        'txtDiscount_LostFocus(Nothing, Nothing)
    '    End With
    '    'GetTotal()

    'End Sub
    Private Sub cmbItem_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbItem.Leave
        Try
            If Me.cmbItem.IsItemInList = False Then
                Me.txtStock.Text = 0
                Exit Sub
            End If
            If Me.cmbItem.ActiveRow Is Nothing Then Exit Sub
            'ClearDetailControls() ''Commented Against TFS4705
            Me.txtStock.Text = Convert.ToDouble(GetStockById(Me.cmbItem.ActiveRow.Cells(0).Value, Me.cmbCategory.SelectedValue))
            Me.txtCurrentRate.Text = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString
            Me.txtRate.Text = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString
            If Val(Me.txtQty.Text) <= 0 Then
                Me.txtQty.Text = 1
            End If
            Dim strSQl As String = String.Empty
            FillCombo("ArticlePack")
            'If GetConfigValue("WithSizeRange") = "False" Then
            '    strSQl = "SELECT Stock, BatchNo as [Batch No] FROM  dbo.vw_Batch_Stock WHERE     (NOT (Stock = 0))and articleid= " & Me.cmbItem.ActiveRow.Cells(0).Value
            '    Me.cmbBatchNo.LimitToList = False
            'If GetConfigValue("WithSizeRange") = "True" Then
            '    strSQl = "SELECT     ISNULL(a.Stock, 0) AS Stock, PurchaseBatchTable.BatchNo as [Batch No], PurchaseBatchTable.BatchID" _
            '            & " FROM         SizeRangeTable INNER JOIN" _
            '            & "                   PurchaseBatchTable ON SizeRangeTable.BatchID = PurchaseBatchTable.BatchID LEFT OUTER JOIN " _
            '            & "                    (SELECT     * " _
            '            & "   FROM vw_Batch_Stock " _
            '            & "                WHERE      articleID = " & Me.cmbItem.Value & ") a ON PurchaseBatchTable.BatchID = a.BatchID " _
            '            & "WHERE(SizeRangeTable.SizeID = " & IIf(Val(Me.cmbItem.ActiveRow.Cells("Size ID").Value.ToString) > 0, Me.cmbItem.ActiveRow.Cells("Size ID").Value, 0) & ") "
            'Else
            '    strSQl = "SELECT Stock, BatchNo as [Batch No],BatchID FROM  dbo.vw_Batch_Stock WHERE     (NOT (Stock = 0))and articleid= " & Me.cmbItem.ActiveRow.Cells(0).Value
            'End If

            'Dim dt As DataTable = GetDataTable(strSQl)
            'cmbBatchNo.DataSource = dt
            'cmbBatchNo.ValueMember = "BatchID"
            'cmbBatchNo.DisplayMember = "Batch No"
            'cmbBatchNo.DisplayLayout.Bands(0).Columns("BatchNo").Hidden = True
            'cmbBatchNo.DisplayLayout.Bands(0).Columns("BatchID").Hidden = True

            'Dim dr As DataRow = dt.NewRow
            'dr.Item(1) = ""
            'dr.Item(2) = 0
            'dr.Item(0) = 0
            'dt.Rows.Add(dr)

            'If Me.cmbBatchNo.Rows.Count > 0 Then
            '    Me.cmbBatchNo.Rows(0).Activate()
            'End If
            'Me.cmbBatchNo.Enabled = True
        Catch ex As Exception
            msg_Error(ex.Message)
        End Try

    End Sub
    Private Sub cmbItem_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbItem.Enter
        Me.cmbItem.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.ToggleDropdown)
    End Sub

    Private Sub cmbVendor_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbVendor.Enter
        Me.cmbVendor.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.ToggleDropdown)
    End Sub

    Private Sub DeleteToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnDelete.Click
        'ValidateDateLock()
        'If flgDateLock = True Then ShowErrorMessage("Previous date work not allowed") : Exit Sub
        'If flgDateLock = True Then
        '    If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt"))) Then
        '        ShowErrorMessage("Previous date work not allowed") : Exit Sub
        '    End If
        'End If
        If IsDateLock(Me.dtpPODate.Value) = True Then
            ShowErrorMessage(str_ErrorPreviouseDateRecordDeleteAllow) : Exit Sub
        End If
        Dim flgAvgRate As Boolean = Convert.ToBoolean(getConfigValueByType("AvgRate").ToString)
        If Not Me.grdSaved.RowCount > 0 Then
            msg_Error(str_ErrorNoRecordFound)
            Exit Sub
        End If

        ''Start TFS2988 : Ayesha Rehman : 09-04-2018
        If IsEditMode = True Then
            If ValidateApprovalProcessMapped(Me.txtPONo.Text.Trim) Then
                If ValidateApprovalProcessInProgress(Me.txtPONo.Text.Trim) Then
                    msg_Error("Document is in Approval Process ") : Exit Sub
                End If
            End If
        End If
        ''End TFS2988

        'Task:2794 Check Invoice Based Receipt/Payment Depanded Record Exist
        Dim dt As New DataTable
        dt = GetDataTable("Select Count(*) From InvoiceBasedPaymentsDetail WHERE InvoiceNo=N'" & Me.txtPONo.Text.Replace("'", "''") & "'")
        If Val(dt.Rows(0).Item(0).ToString) > 0 Then
            ShowErrorMessage(str_ErrorDependentRecordFound)
            Exit Sub
        End If
        'End Task:2794

        If Not msg_Confirm(str_ConfirmDelete) = True Then Exit Sub
        If Con.State = ConnectionState.Closed Then Con.Open()

        'R-974 Ehtisham ul Haq user friendly system modification on 20-1-14 

        Me.lblProgress.Text = "Processing Please Wait ..."
        Me.lblProgress.Visible = True
        Application.DoEvents()
        Dim cmd As New OleDbCommand
        cmd.Connection = Con
        cmd.CommandType = CommandType.Text
        'cmd.CommandText = "SELECT Isnull(Qty,0) as Qty, ArticleDefID, Isnull(Price,0) as Price FROM ReceivingDetailTable WHERE  ReceivingID = " & Me.grdSaved.CurrentRow.Cells(6).Value.ToString & ""
        cmd.CommandText = "SELECT Isnull(Sz1,0) as Qty, ArticleDefID, Isnull(Price,0) as Price , IsNull(PurchaseOrderDetailId,0) as PurchaseOrderDetailId, IsNull(ReceivingNoteDetailId,0) as ReceivingNoteDetailId FROM ReceivingDetailTable WHERE  ReceivingID = " & Me.grdSaved.CurrentRow.Cells("ReceivingID").Value.ToString & ""
        Dim da As New OleDbDataAdapter(cmd)
        Dim dtSavedItems As New DataTable
        da.Fill(dtSavedItems)

        Dim lngVoucherMasterId As Integer = GetVoucherId("frmPurchase", grdSaved.CurrentRow.Cells(0).Value.ToString)

        ''TASK TFS4709
        If IsGRNStockImpacted = True AndAlso Val(Me.grdSaved.CurrentRow.Cells("ReceivingNoteId").Value.ToString) > 0 Then
            ShouldStockImpactGo = False
        End If
        ''END TASK TFS4709

        'Dim strvoucherno As String = String.Empty
        'Dim dt As DataTable = GetRecords("select voucher_no   from tblvoucher  where voucher_id = " & lngVoucherMasterId & " ")

        'If Not dt Is Nothing Then
        '    If Not dt.Rows.Count = 0 Then
        '        strvoucherno = dt.Rows(0)("voucher_no")
        '    End If
        'End If
        If Con.State = ConnectionState.Closed Then Con.Open()
        Dim objTrans As OleDbTransaction
        objTrans = Con.BeginTransaction
        Me.Cursor = Cursors.WaitCursor
        Dim DelRecordId As String = String.Empty 'Task:2612 purpose of set record id 
        Try
            Dim cm As New OleDbCommand


            '********************************
            ' Update Purchase Price By Imran
            '********************************
            For i As Integer = 0 To dtSavedItems.Rows.Count - 1
                Dim CrrStock As Double = 0D
                Dim CostPrice As Double = 0D
                If flgAvgRate = True Then

                    Try
                        cm.Connection = Con
                        cm.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, dbo.ArticleDefTable.PurchasePrice, Round(ABS(SUM(Isnull(dbo.StockDetailTable.InQty,0) - Isnull(dbo.StockDetailTable.OutQty,0))),4) AS qty, Round(ABS(SUM(Isnull(dbo.StockDetailTable.InAmount,0) - Isnull(dbo.StockDetailTable.OutAmount,0))),4) As Amount " _
                                                & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId INNER JOIN StockMasterTable on StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE dbo.ArticleDefTable.ArticleId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & " AND DocNo <> N'" & grdSaved.CurrentRow.Cells(0).Value.ToString.Replace("'", "''") & "' " _
                                                & " GROUP BY dbo.StockDetailTable.ArticleDefId, dbo.ArticleDefTable.PurchasePrice "

                        cm.Transaction = objTrans
                        Dim dtCrrStock As New DataTable
                        Dim daCrrStock As New OleDbDataAdapter
                        daCrrStock.SelectCommand = cm
                        daCrrStock.Fill(dtCrrStock)
                        If dtCrrStock IsNot Nothing Then
                            If dtCrrStock.Rows.Count > 0 Then
                                'Before against task:2401
                                'If Val(grd.GetRows(i).Cells("Price").Value) <> 0 Then
                                If Val(grd.GetRows(i).Cells("Rate").Value) <> 0 AndAlso Val(dtCrrStock.Rows(0).Item("Qty").ToString) <> 0 Then
                                    'End Task:2401
                                    'CrrStock = Val(dtCrrStock.Rows(0).Item(2).ToString) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value)))
                                    'PurchasePriceNew = ((dtCrrStock.Rows(0).Item(3)) + IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("qty").Value.ToString), (Val(grd.GetRows(i).Cells("Qty").Value.ToString) * Val(grd.GetRows(i).Cells("PackQty").Value))) * (Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString))) / CrrStock
                                    CostPrice = (Val(dtCrrStock.Rows(0).Item("Amount").ToString) / Val(dtCrrStock.Rows(0).Item("Qty").ToString)) 'Val(grd.GetRows(i).Cells("rate").Value.ToString) + Val(grd.GetRows(i).Cells("Transportation_Charges").Value.ToString) - Val(Me.grd.GetRows(i).Cells("Discount_Price").Value.ToString)
                                Else
                                    CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString)
                                End If
                            Else
                                CostPrice = Val(grd.GetRows(i).Cells("rate").Value.ToString)
                            End If
                        End If
                    Catch ex As Exception

                    End Try



                    cm.CommandText = ""
                    cm.Connection = Con
                    cm.Transaction = objTrans
                    cm.CommandText = "UPDATE ArticleDefTableMaster Set PurchasePrice=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ", Cost_Price=" & CostPrice & " WHERE ArticleId in (Select MasterId From ArticleDefTable WHERE ArticleId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ")"
                    cm.ExecuteNonQuery()



                    cm.CommandText = ""
                    cm.Connection = Con
                    cm.Transaction = objTrans
                    cm.CommandText = "UPDATE ArticleDefTable Set PurchasePrice=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ", Cost_Price=" & CostPrice & " WHERE ArticleId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ""
                    cm.ExecuteNonQuery()

                    cm.CommandText = ""
                    cm.CommandText = " Select a.ArticleDefId, b.SalesItem From IncrementReductionTable a INNER JOIN ArticleDefView b ON b.ArticleId = a.ArticleDefId WHERE (Convert(varchar, a.IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', 102))  AND a.ArticleDefId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ""
                    Dim dtRate As New DataTable
                    Dim daRate As New OleDbDataAdapter(cm)
                    daRate.Fill(dtRate)

                    cm.CommandText = "Select ISNULL(SalesItem,0) as SalesItem From ArticleDefView WHERE Active=1 AND ArticleId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & " "
                    Dim dtSalesItem As New DataTable
                    Dim daSalesItem As New OleDbDataAdapter(cm)
                    daSalesItem.Fill(dtSalesItem)

                    If dtSalesItem.Rows.Count > 0 Then
                        If Not dtRate Is Nothing Then
                            If dtRate.Rows.Count > 0 Then
                                cm.CommandText = ""
                                cm.Connection = Con
                                cm.Transaction = objTrans
                                cm.CommandText = "Update IncrementReductionTable Set  PurchasePriceNew=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ",  Cost_Price_New=" & CostPrice & "  WHERE ArticleDefId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & " AND (Convert(varchar, IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', 102)) "
                                cm.ExecuteNonQuery()
                            Else
                                cm.CommandText = ""
                                cm.Connection = Con
                                cm.Transaction = objTrans
                                cm.CommandText = "INSERT INTO IncrementReductionTable(IncrementReductionDate, ArticleDefId, StockQty, PurchaseOldPrice, PurchaseNewPrice, SaleOldPrice,SaleNewPrice, Cost_Price_Old, Cost_Price_New) " _
                                & " Values(N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ",  " & Val(0) & ", " & Val(0) & ", " & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ", " & Val(0) & ", " & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, Val(dtSavedItems.Rows(i).Item("Price").ToString)) & ",0," & CostPrice & ")"
                                cm.ExecuteNonQuery()
                            End If
                        End If
                    End If


                Else


                    cm.CommandText = ""
                    cm.Connection = Con
                    cm.Transaction = objTrans
                    cm.CommandText = "UPDATE ArticleDefTableMaster Set PurchasePrice=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ",Cost_Price=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & " WHERE ArticleId in (Select MasterId From ArticleDefTable WHERE ArticleId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ")"
                    cm.ExecuteNonQuery()


                    'Apply Current Rate 
                    cm.Connection = Con
                    cm.CommandText = "UPDATE ArticleDefTable Set PurchasePrice=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ",Cost_Price=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & " WHERE ArticleId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ""
                    cm.Transaction = objTrans
                    cm.ExecuteNonQuery()

                    cm.Connection = Con
                    cm.Transaction = objTrans
                    cm.CommandText = " Select a.ArticleDefId, b.SalesItem From IncrementReductionTable a INNER JOIN ArticleDefView b ON b.ArticleId = a.ArticleDefId WHERE (Convert(varchar, a.IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', 102))  AND a.ArticleDefId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ""
                    Dim dtRate As New DataTable
                    Dim daRate As New OleDbDataAdapter(cm)
                    daRate.Fill(dtRate)

                    cm.Connection = Con
                    cm.Transaction = objTrans
                    cm.CommandText = "Select ISNULL(SalesItem,0) as SalesItem From ArticleDefView WHERE Active=1 AND ArticleId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & " "
                    Dim dtSalesItem As New DataTable
                    Dim daSalesItem As New OleDbDataAdapter(cm)
                    daSalesItem.Fill(dtSalesItem)

                    If dtSalesItem.Rows.Count > 0 Then
                        If Not dtRate Is Nothing Then
                            If dtRate.Rows.Count > 0 Then
                                cm.Connection = Con
                                cm.CommandText = "Update IncrementReductionTable Set PurchaseNewPrice=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ", SaleNewPrice=" & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, Val(dtSavedItems.Rows(i).Item("Price").ToString)) & ", Cost_Price_New=" & Val(dtSavedItems.Rows(i).Item("Price").ToString) & "  WHERE ArticleDefId=" & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & " AND (Convert(varchar, IncrementReductionDate, 102) = Convert(Datetime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', 102)) "
                                cm.Transaction = objTrans
                                cm.ExecuteNonQuery()
                            Else
                                cm.Connection = Con
                                cm.CommandText = "INSERT INTO IncrementReductionTable(IncrementReductionDate, ArticleDefId, StockQty, PurchaseOldPrice, PurchaseNewPrice, SaleOldPrice,SaleNewPrice, Cost_Price_Old,  Cost_Price_New) " _
                                & " Values(N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " & Val(dtSavedItems.Rows(i).Item("ArticleDefId").ToString) & ",  " & Val(0) & ", " & Val(0) & ", " & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ", " & Val(0) & ", " & IIf(dtSalesItem.Rows(0).Item(0) = True, 0, Val(dtSavedItems.Rows(i).Item("Price").ToString)) & ",0," & Val(dtSavedItems.Rows(i).Item("Price").ToString) & ")"
                                cm.Transaction = objTrans
                                cm.ExecuteNonQuery()
                            End If
                        End If
                    End If
                End If
            Next

            UpdatePOStatus(Val(Me.grdSaved.GetRow.Cells("ReceivingId").Value.ToString), objTrans, "Delete")
            ''Start TFS2576
            UpdateGRNStatusInCaseOfDelete(Val(Me.grdSaved.GetRow.Cells("ReceivingId").Value.ToString), objTrans) 'Update GRN Status to 'Open' when Purchase is Deleted 
            ''End TFS2576

            cm.Connection = Con
            cm.CommandText = "delete from InwardExpenseDetailTable WHERE PurchaseId =" & Val(Me.grdSaved.GetRow.Cells("ReceivingId").Value.ToString) & ""
            cm.Transaction = objTrans
            cm.ExecuteNonQuery()


            cm.Connection = Con
            cm.CommandText = "delete from tblVoucherDetail WHERE Voucher_Id In(Select Voucher_Id From tblVoucher WHERE Voucher_Code=N'" & Me.grdSaved.GetRow.Cells("ReceivingNo").Value.ToString & "' And Voucher_Code <> Voucher_No)"
            cm.Transaction = objTrans
            cm.ExecuteNonQuery()


            cm.Connection = Con
            cm.CommandText = "delete from tblVoucher WHERE Voucher_Code=N'" & Me.grdSaved.GetRow.Cells("ReceivingNo").Value.ToString & "' And Voucher_Code <> Voucher_No"
            cm.Transaction = objTrans
            cm.ExecuteNonQuery()


            cm.Connection = Con
            cm.CommandText = "delete from ReceivingDetailTable where Receivingid=" & Me.grdSaved.CurrentRow.Cells("ReceivingID").Value.ToString
            cm.Transaction = objTrans
            cm.ExecuteNonQuery()

            cm = New OleDbCommand
            cm.Connection = Con
            cm.CommandText = "delete from ReceivingMasterTable where Receivingid=" & Me.grdSaved.CurrentRow.Cells("ReceivingID").Value.ToString

            cm.Transaction = objTrans
            cm.ExecuteNonQuery()


            cm = New OleDbCommand
            cm.Connection = Con
            cm.CommandText = "delete from tblvoucherdetail where voucher_id=" & lngVoucherMasterId

            cm.Transaction = objTrans
            cm.ExecuteNonQuery()

            cm = New OleDbCommand
            cm.Connection = Con
            cm.CommandText = "delete from tblvoucher where voucher_id=" & lngVoucherMasterId

            cm.Transaction = objTrans
            cm.ExecuteNonQuery()

            ''make reversal of saved items in sale order detail table against poid
            'If dtSavedItems.Rows.Count > 0 Then
            '    For Each r As DataRow In dtSavedItems.Rows
            '        cm.CommandText = "Update PurchaseOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & ") where PurchaseOrderID = " & Me.grdSaved.CurrentRow.Cells("PurchaseOrderID").Value & " and ArticleDefID = " & r.Item(1) & " " & IIf(Val(r.Item("PurchsaeOrderDetailId").ToString) > 0, " AND PurchaseOrderDetailId=" & Val(r.Item("PurchsaeOrderDetailId").ToString) & "", "") & ""
            '        cm.ExecuteNonQuery()
            '    Next
            'End If


            'cm.CommandText = "Update PurchaseOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where PurchaseOrderID = " & Me.grdSaved.CurrentRow.Cells("PurchaseOrderID").Value & ""
            'cm.ExecuteNonQuery()

            lngVoucherId = lngVoucherMasterId
            Voucher_Delete(objTrans)

            If ShouldStockImpactGo = True Then
                StockMaster = New StockMaster
                StockMaster.StockTransId = Convert.ToInt32(StockTransId(Me.grdSaved.CurrentRow.Cells(0).Value, objTrans))
                Call New StockDAL().Delete(StockMaster, objTrans)
            End If

            objTrans.Commit()
            'Call Delete() 'Upgrading Stock ...


            DelRecordId = Me.grdSaved.CurrentRow.Cells(0).Value.ToString
            'Task-2389 Ehtisham ul Haq Reload History After Delete Record on 25-1-14 

            'lngVoucherId = lngVoucherMasterId ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
        Catch ex As Exception
            objTrans.Rollback()
            msg_Error("Error occured while deleting record: " & ex.Message)
        Finally
            Con.Close()
            Me.Cursor = Cursors.Default
            Me.lblProgress.Visible = False
        End Try
        'Voucher_Delete() 'Payment Delete Voucher 
        'Task:2612 Before 
        'SaveActivityLog("POS", Me.Text, EnumActions.Delete, LoginUserId, EnumRecordType.Purchase, Me.grdSaved.CurrentRow.Cells(0).Value.ToString, True)
        'SaveActivityLog("Accounts", Me.Text, EnumActions.Delete, LoginUserId, EnumRecordType.AccountTransaction, Me.grdSaved.CurrentRow.Cells(0).Value.ToString, True)

        'Task:2612 Changed With DelRecordId
        SaveActivityLog("POS", Me.Text, EnumActions.Delete, LoginUserId, EnumRecordType.Purchase, DelRecordId, True)
        SaveActivityLog("Accounts", Me.Text, EnumActions.Delete, LoginUserId, EnumRecordType.AccountTransaction, DelRecordId, True)
        'End Task:2612
        Me.grdSaved.CurrentRow.Delete()
        'msg_Information(str_informDelete)
        Me.txtReceivingID.Text = 0
        Me.RefreshControls()
        lngVoucherId = 0I
    End Sub
    Private Sub cmbVendor_ValueChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbVendor.ValueChanged
        Try
            If Me.cmbVendor.ActiveRow Is Nothing Then Exit Sub
            Dim Str As String = String.Empty
            'If Me.IsEditMode = False Then

            '    ' Str = "Select SalesOrderID, SalesOrderNo from SalesOrderMasterTable where salesorderId not in(select PoId from salesMasterTable) and VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & " and Status = N'" & EnumStatus.Open.ToString & "'"
            '    'Before against request no. RM6
            '    'Str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 113) as PurchaseOrderNo,DcNo,Remarks from PurchaseOrderMasterTable where  VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & " and Status = N'" & EnumStatus.Open.ToString & "'"
            '    'R:M6 Filter By Posted
            '    'Str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 113) as PurchaseOrderNo,DcNo,Remarks from PurchaseOrderMasterTable where  VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & " and Status = N'" & EnumStatus.Open.ToString & "' AND Post=1"
            '    'Str = "Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 102) as PurchaseOrderNo,DcNo,Remarks, IsNull(RefCMFADocId,0) as RefCMFADocId from PurchaseOrderMasterTable where  VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & " and Status = N'" & EnumStatus.Open.ToString & "' AND Post=1"
            '    'End R:M6
            '    'FillDropDown(cmbPo, Str)
            '    FillCombo("SO")
            'Else
            '    'Str = "Select SalesOrderID, SalesOrderNo from SalesOrderMasterTable where VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & ""
            '    'Str = " Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 113) as PurchaseOrderNo,DcNo,Remarks  from PurchaseOrderMasterTable where  vendorid=" & Me.cmbVendor.Value & ""
            '    'R:M6 Filter By Posted
            '    'Str = " Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 113) as PurchaseOrderNo,DcNo,Remarks  from PurchaseOrderMasterTable where  vendorid=" & Me.cmbVendor.Value & " AND Post=1"
            '    'Str = " Select PurchaseOrderID, PurchaseOrderNo + ' ~ ' + Convert(Varchar(12), PurchaseOrderDate, 102) as PurchaseOrderNo,DcNo,Remarks, IsNull(RefCMFADocId,0) as RefCMFADocId  from PurchaseOrderMasterTable where  vendorid=" & Me.cmbVendor.Value & " AND Post=1"
            '    'End R:M6
            '    'FillDropDown(cmbPo, Str)
            '    FillCombo("SO")
            'End If
            FillCombo("SO")
            CtrlGrdBar1.Email = New SBModel.SendingEmail
            CtrlGrdBar1.Email.ToEmail = Me.cmbVendor.ActiveRow.Cells("Email").Text
            CtrlGrdBar1.Email.Subject = "Purchase: " + "(" & Me.txtPONo.Text & ")"
            CtrlGrdBar1.Email.Body = String.Empty
            CtrlGrdBar1.Email.DocumentNo = Me.txtPONo.Text
            CtrlGrdBar1.Email.DocumentDate = Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt")


        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub grd_RowsRemoved(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewRowsRemovedEventArgs)
        'Me.GetTotal()
    End Sub
    Private Sub GetSecurityRights()
        Try
            If LoginGroup = "Administrator" Then
                Me.BtnSave.Enabled = True
                Me.BtnDelete.Enabled = True
                Me.BtnPrint.Enabled = True
                Me.chkPost.Visible = True
                PrintVoucherToolStripMenuItem.Enabled = True
                PrintVoucherToolStripMenuItem1.Enabled = True
                If Me.BtnSave.Text = "&Save" Then Me.chkPost.Checked = True
                IsAdminGroup = True
                IsGetAllAllowed = True
                'Task 1592 Apply future date rights
                IsDateChangeAllowed = True
                dtpPODate.MaxDate = Date.Today.AddMonths(3)
                dtpDcDate.MaxDate = Date.Today.AddMonths(3)

                Exit Sub
            End If
            If getConfigValueByType("NewSecurityRights").ToString = "False" Or getConfigValueByType("NewSecurityRights").ToString = "Error" Then
                If RegisterStatus = EnumRegisterStatus.Expired Then
                    Me.BtnSave.Enabled = False
                    Me.BtnDelete.Enabled = False
                    Me.BtnPrint.Enabled = False
                    PrintVoucherToolStripMenuItem.Enabled = False
                    PrintVoucherToolStripMenuItem1.Enabled = False
                    IsAdminGroup = False
                    IsGetAllAllowed = False
                    'Task 1592 Apply future date rights
                    IsDateChangeAllowed = False
                    DateChange(False)
                    'Me.PrintListToolStripMenuItem.Enabled = False
                    'PrintToolStripMenuItem.Enabled = False
                    Exit Sub
                End If
                Dim dt As DataTable = GetFormRights(EnumForms.frmPurchase)
                If Not dt Is Nothing Then
                    If Not dt.Rows.Count = 0 Then
                        If Me.BtnSave.Text = "Save" Or Me.BtnSave.Text = "&Save" Then
                            Me.BtnSave.Enabled = dt.Rows(0).Item("Save_Rights").ToString()
                        Else
                            Me.BtnSave.Enabled = dt.Rows(0).Item("Update_Rights").ToString
                        End If
                        Me.BtnDelete.Enabled = dt.Rows(0).Item("Delete_Rights").ToString
                        Me.BtnPrint.Enabled = dt.Rows(0).Item("Print_Rights").ToString
                        Me.Visible = dt.Rows(0).Item("View_Rights").ToString
                    End If
                End If
                UserPostingRights = GetUserPostingRights(LoginUserId)
                If UserPostingRights = True Then
                    Me.chkPost.Visible = True
                    Me.grd.RootTable.Columns("ReceivedQty").Visible = True
                    'Me.grd.RootTable.Columns("RejectedQty").Visible = True
                    InspectionReportToolStripMenuItem.Enabled = True
                    PurchaseReturnReportToolStripMenuItem.Enabled = True
                Else
                    Me.chkPost.Visible = False
                    If Me.BtnSave.Text = "&Save" Then Me.chkPost.Checked = False
                    Me.grd.RootTable.Columns("ReceivedQty").Visible = False
                    Me.grd.RootTable.Columns("RejectedQty").Visible = False
                    InspectionReportToolStripMenuItem.Enabled = False
                    PurchaseReturnReportToolStripMenuItem.Enabled = False
                End If
                UserPriceAllowedRights = GetUserPriceAllowedRights(LoginUserId)
                If UserPriceAllowedRights = True Then
                    Me.pnlRateHidden.Visible = True
                    Me.grd.RootTable.Columns("Rate").Visible = True
                    Me.grd.RootTable.Columns("Total").Visible = True
                Else
                    Me.pnlRateHidden.Visible = False
                    Me.grd.RootTable.Columns("Rate").Visible = False
                    Me.grd.RootTable.Columns("Total").Visible = False
                End If
                GetSecurityByPostingUser(UserPostingRights, BtnSave, BtnDelete)
            Else
                'Me.Visible = False
                Me.BtnSave.Enabled = False
                Me.BtnDelete.Enabled = False
                Me.BtnPrint.Enabled = False
                Me.pnlRateHidden.Visible = False
                Me.chkPost.Visible = False
                IsAdminGroup = False
                IsGetAllAllowed = False
                'Task 1592 Apply future date rights
                IsDateChangeAllowed = False
                DateChange(False)
                PrintVoucherToolStripMenuItem.Enabled = False
                PrintVoucherToolStripMenuItem1.Enabled = False
                If Me.BtnSave.Text = "&Save" Then Me.chkPost.Checked = False
                CtrlGrdBar1.mGridPrint.Enabled = False
                CtrlGrdBar3.mGridPrint.Enabled = False
                CtrlGrdBar1.mGridExport.Enabled = False
                CtrlGrdBar3.mGridPrint.Enabled = False
                CtrlGrdBar2.mGridExport.Enabled = False ''TFS1823
                Me.pnlRateHidden.Visible = False
                Me.grd.RootTable.Columns("Rate").Visible = False
                Me.grd.RootTable.Columns("Total").Visible = False
                InspectionReportToolStripMenuItem.Enabled = False
                PurchaseReturnReportToolStripMenuItem.Enabled = False
                Me.grd.RootTable.Columns("ReceivedQty").Visible = False
                Me.grd.RootTable.Columns("RejectedQty").Visible = False
                CreditPurchase = False 'Task:2380 Default Cash Purchase Security
                'Task:2395 Added Security Print
                ReceivedToolStripMenuItem.Enabled = False
                PurchaseReturnReportToolStripMenuItem.Enabled = False
                InspectionReportToolStripMenuItem.Enabled = False
                InwordGatePToolStripMenuItem.Enabled = False
                GoodReceivedToolStripMenuItem.Enabled = False
                RejectionReportToolStripMenuItem.Enabled = False
                InspectionReportToolStripMenuItem1.Enabled = False
                InwardGatepassToolStripMenuItem.Enabled = False
                CtrlGrdBar1.mGridChooseFielder.Enabled = False 'Task:2406 Added Field Chooser Rights
                'End Task:2395

                'For i As Integer = 0 To Rights.Count - 1
                For Each RightsDt As GroupRights In Rights
                    If RightsDt.FormControlName = "View" Then
                        'Me.Visible = True
                    ElseIf RightsDt.FormControlName = "Save" Then
                        If Me.BtnSave.Text = "&Save" Then BtnSave.Enabled = True
                    ElseIf RightsDt.FormControlName = "Update" Then
                        If Me.BtnSave.Text = "&Update" Then BtnSave.Enabled = True
                    ElseIf RightsDt.FormControlName = "Delete" Then
                        Me.BtnDelete.Enabled = True
                    ElseIf RightsDt.FormControlName = "Print" Then
                        Me.BtnPrint.Enabled = True
                        CtrlGrdBar1.mGridPrint.Enabled = True
                        CtrlGrdBar3.mGridPrint.Enabled = True
                    ElseIf RightsDt.FormControlName = "Export" Then
                        CtrlGrdBar1.mGridExport.Enabled = True
                        CtrlGrdBar2.mGridExport.Enabled = True
                        CtrlGrdBar3.mGridExport.Enabled = True ''TFS1823
                    ElseIf RightsDt.FormControlName = "Post" Then
                        Me.chkPost.Visible = True
                    ElseIf RightsDt.FormControlName = "Get All" Then
                        IsGetAllAllowed = True
                        If Me.BtnSave.Text = "&Save" Then Me.chkPost.Checked = True
                        Me.grd.RootTable.Columns("ReceivedQty").Visible = True
                        Me.grd.RootTable.Columns("RejectedQty").Visible = True
                        'Coment against Task:2395 Added Security Print
                        'InspectionReportToolStripMenuItem.Enabled = True
                        'PurchaseReturnReportToolStripMenuItem.Enabled = True
                        'End Task:2395
                    ElseIf RightsDt.FormControlName = "Price Allow" Then
                        Me.pnlRateHidden.Visible = True
                        Me.grd.RootTable.Columns("Rate").Visible = True
                        Me.grd.RootTable.Columns("Total").Visible = True
                        'Task:2380 Added Security Credit Purchase
                    ElseIf RightsDt.FormControlName = "Credit Purchase" Then
                        CreditPurchase = True
                        'End Task:2380
                        'Task:1592 Added Future Date Rights
                    ElseIf RightsDt.FormControlName = "Future Transaction" Then
                        IsDateChangeAllowed = True
                        DateChange(True)
                        'Task:2395 Added Security Print
                    ElseIf RightsDt.FormControlName = "Print Inward Gatepass" Then
                        InwordGatePToolStripMenuItem.Enabled = True
                        InwardGatepassToolStripMenuItem.Enabled = True

                    ElseIf RightsDt.FormControlName = "Print Inspection Report" Then
                        InspectionReportToolStripMenuItem.Enabled = True
                        InspectionReportToolStripMenuItem1.Enabled = True

                    ElseIf RightsDt.FormControlName = "Print Rejection Report" Then
                        PurchaseReturnReportToolStripMenuItem.Enabled = True
                        RejectionReportToolStripMenuItem.Enabled = True

                    ElseIf RightsDt.FormControlName = "Print Goods Received" Then
                        ReceivedToolStripMenuItem.Enabled = True
                        GoodReceivedToolStripMenuItem.Enabled = True
                        'End Task:2395
                        'Task:2406 Added Field Chooser Rights
                    ElseIf RightsDt.FormControlName = "Field Chooser" Then
                        CtrlGrdBar1.mGridChooseFielder.Enabled = True
                        'End Task:2406
                    ElseIf RightsDt.FormControlName = "Print Voucher" Then
                        PrintVoucherToolStripMenuItem.Enabled = True
                        PrintVoucherToolStripMenuItem1.Enabled = True
                    End If
                Next
            End If
        Catch ex As Exception
            msg_Error(ex.Message)
        End Try
    End Sub
    'Task 1592 Apply future date rights
    Private Sub DateChange(ByRef IsDateChangeAllowed As Boolean)
        Try
            If IsDateChangeAllowed = False Then
                dtpPODate.MaxDate = DateTime.Now.ToString("yyyy/M/d 23:59:59")
                dtpDcDate.MaxDate = DateTime.Now.ToString("yyyy/M/d 23:59:59")
            Else
                dtpPODate.MaxDate = Date.Today.AddMonths(3)
                dtpDcDate.MaxDate = Date.Today.AddMonths(3)
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    'END TASk:1592

    Private Sub cmbItem_KeyUp(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles cmbItem.KeyUp
        If e.KeyCode = Keys.ShiftKey Then
            If Me.cmbItem.DisplayMember = "Item" Then
                Me.cmbItem.DisplayMember = "Code"
            Else
                Me.cmbItem.DisplayMember = "Item"
            End If
        End If
    End Sub
    Private Sub ListOfItemToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ListOfItemToolStripMenuItem.Click
        frmMain.LoadControl("ListOfItems")
    End Sub
    Private Sub SummaryOfPurchaesInvoicesToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles SummaryOfPurchaesInvoicesToolStripMenuItem.Click
        'frmMain.LoadControl("SummaryOfPurchaseInvoices")
        rptDateRange.ReportName = rptDateRange.ReportList.SummaryOfPurchaseInvoices
        ApplyStyleSheet(rptDateRange)
        rptDateRange.ShowDialog()
    End Sub
    Private Sub PayablesToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PayablesToolStripMenuItem.Click
        frmMain.LoadControl("rptPayables")
    End Sub
    Private Sub ToolStripButton2_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ToolStripButton2.Click
        'frmMain.LoadControl("AddVendors")
        Dim CustId As Integer = 0
        CustId = Me.cmbVendor.Value

        ''Task 3461: Aashir: Edited Becuase Shortcut link account add option was not working 
        'FrmAddCustomers.FormType = "Vendor"
        'FrmAddCustomers.ShowDialog()
        frmMain.LoadControl("AddVendor")

        Me.FillCombo("Vendor")
        Me.cmbVendor.Value = CustId
    End Sub
    'Private Sub UltraTabControl1_SelectedTabChanged(ByVal sender As System.Object, ByVal e As Infragistics.Win.UltraWinTabControl.SelectedTabChangedEventArgs) Handles UltraTabControl1.SelectedTabChanged
    '    If Me.UltraTabControl1.SelectedTab.Index = 0 Then
    '        Me.BtnLoadAll.Visible = False
    '        Me.ToolStripButton1.Visible = False
    '        Me.ToolStripSeparator1.Visible = False
    '    Else
    '        Me.BtnLoadAll.Visible = True
    '        Me.ToolStripButton1.Visible = True
    '        Me.ToolStripSeparator1.Visible = True
    '    End If
    'End Sub
    'Private Sub BtnLoadAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnLoadAll.Click
    '    Me.Cursor = Cursors.WaitCursor
    '    DisplayRecord("All")
    '    Me.DisplayDetail(-1)
    '    Me.Cursor = Cursors.Hand
    'End Sub
    Private Sub BtnRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnRefresh.Click
        'R-974 Ehtisham ul Haq user friendly system modification on 8-1-14 

        'If Not msg_Confirm(str_ConfirmRefresh) = True Then Exit Sub
        Dim id As Integer = 0
        Me.lblProgress.Text = "Processing Please Wait ..."
        Me.lblProgress.Visible = True
        Application.DoEvents()
        'R:979 Loading Configurations
        If Me.bwLoading.IsBusy Then Exit Sub
        Me.bwLoading.RunWorkerAsync()
        Do While Me.bwLoading.IsBusy
            Application.DoEvents()
        Loop
        'End R:979
        'Task:2376 Get Comments Layout Configurations
        If BackgroundWorker3.IsBusy Then Exit Sub
        BackgroundWorker3.RunWorkerAsync()
        Do While BackgroundWorker3.IsBusy
            Application.DoEvents()
        Loop
        'End Task:2376

        id = Me.cmbVendor.SelectedRow.Cells(0).Value
        FillCombo("Vendor")
        Me.cmbVendor.Value = id

        id = Me.cmbSalesMan.SelectedValue
        FillCombo("SM")
        Me.cmbSalesMan.SelectedValue = id

        id = Me.cmbPo.SelectedValue
        FillCombo("SO")
        Me.cmbPo.SelectedValue = id

        id = Me.cmbCategory.SelectedValue
        FillCombo("Category")
        Me.cmbCategory.SelectedValue = id

        id = Me.cmbItem.SelectedRow.Cells(0).Value
        FillCombo("Item")
        Me.cmbItem.Value = id

        id = Me.cmbProject.SelectedValue
        FillCombo("CostCenter")
        Me.cmbProject.SelectedValue = id

        id = Me.cmbTransportationVendor.Value
        FillCombo("TransportationVendor")
        Me.cmbTransportationVendor.Value = id

        id = Me.cmbCustomVendor.Value
        FillCombo("CustomVendor")
        Me.cmbCustomVendor.Value = id

        If Me.cmbInwardExpense.ActiveRow Is Nothing Then
            Me.cmbInwardExpense.Rows(0).Activate()
        End If

        id = Me.cmbInwardExpense.ActiveRow.Cells(0).Value
        FillCombo("InwardExpense")
        Me.cmbInwardExpense.Value = id
        ''START TFS3876
        If Not getConfigValueByType("AddItemForMall").ToString = "Error" Then
            flgAddItemForMall = Convert.ToBoolean(getConfigValueByType("AddItemForMall").ToString)
        End If
        ''End TFS3876
        ''TASK TFS4544
        If getConfigValueByType("ItemFilterByName").ToString = "True" Then
            ItemFilterByName = Convert.ToBoolean(getConfigValueByType("ItemFilterByName").ToString)
        End If
        ''END TFS4544
        ''start TFs4161
        'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
        If Not getConfigValueByType("PurchaseDiablePackQuantity").ToString = "Error" Then
            IsPackQtyDisabled = Convert.ToBoolean(getConfigValueByType("PurchaseDiablePackQuantity").ToString)
        End If
        ''End TFS4161
        FillCombo("grdLocation")
        FillCombo("SearchVendor")
        FillCombo("SearchLocation")
        FillCombo("GrdOrigin")
        'If Not getConfigValueByType("CurrencyonOpenLC").ToString = "Error" Then
        '    flgCurrenyonOpenLC = Convert.ToBoolean(getConfigValueByType("CurrencyonOpenLC").ToString)
        'End If

        'If Not getConfigValueByType("TransaportationChargesVoucher").ToString = "Error" Then
        '    flgTransaportationChargesVoucher = getConfigValueByType("TransaportationChargesVoucher")
        'End If


        'If flgCurrenyonOpenLC = True Then
        '    Me.grpCurrency.Visible = True
        'Else
        '    Me.grpCurrency.Visible = False
        'End If

        id = Me.cmbCurrency.SelectedValue
        FillCombo("Currency")
        Me.cmbCurrency.SelectedValue = id

        'id = Me.cmbCompany.SelectedIndex
        'FillCombo("Company")
        'Me.cmbCompany.SelectedIndex = id

        id = Me.cmbCompany.SelectedValue
        FillCombo("Company")
        Me.cmbCompany.SelectedValue = id

        Me.lblProgress.Visible = False
        'DisplayDetail(-1)
        'DisplayDetail(Val(Me.txtReceivingID.Text))
    End Sub
    Function GetPurchaseRemarks(ByVal POID As Integer) As String
        Try
            Dim str As String
            Dim dt As New DataTable
            Dim adp As OleDb.OleDbDataAdapter
            str = "Select Remarks From PurchaseOrderMasterTable WHERE PurchaseOrderId=" & POID & ""
            adp = New OleDb.OleDbDataAdapter(str, Con)
            adp.Fill(dt)
            Return dt.Rows(0).Item(0).ToString
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Function GetPODcNo(ByVal POID As Integer) As String
        Try
            Dim str As String
            Dim dt As New DataTable
            Dim adp As OleDb.OleDbDataAdapter
            str = "Select DcNo From PurchaseOrderMasterTable WHERE PurchaseOrderId=" & POID & ""
            adp = New OleDb.OleDbDataAdapter(str, Con)
            adp.Fill(dt)
            Return dt.Rows(0).Item(0).ToString
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub InspectionReportToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles InspectionReportToolStripMenuItem.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            AddRptParam("@ReceivingId", Me.grdSaved.GetRow.Cells(6).Value)
            ShowReport("goodsincpectonreports", , , , , , , , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub PurchaseReturnReportToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PurchaseReturnReportToolStripMenuItem.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            AddRptParam("@ReceivingId", Me.grdSaved.GetRow.Cells(6).Value)
            ShowReport("purchasereturnnew", , , , , , , , , , , Me.grdSaved.GetRow.Cells("Eamail").Value.ToString)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub InwordGatePToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles InwordGatePToolStripMenuItem.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            AddRptParam("@ReceivingId", Me.grdSaved.GetRow.Cells(6).Value)
            ShowReport("inwardgatepass", , , , , , , , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    Private Sub PurchaseInvoiceToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PurchaseInvoiceToolStripMenuItem.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            PrintLog = New SBModel.PrintLogBE
            PrintLog.DocumentNo = grdSaved.GetRow.Cells("ReceivingNo").Value.ToString
            PrintLog.UserName = LoginUserName
            PrintLog.PrintDateTime = Date.Now
            Call SBDal.PrintLogDAL.PrintLog(PrintLog)
            ShowReport("PurchaseInvoice", "{ReceivingMasterTable.ReceivingId}=" & grdSaved.CurrentRow.Cells(6).Value, , , , , , , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub LinkLabel1_LinkClicked(ByVal sender As System.Object, ByVal e As System.Windows.Forms.LinkLabelLinkClickedEventArgs)
        Try
            Dim Str As String = "SELECT ArticleDefTable.ArticleId FROM ArticleDefTable INNER JOIN ArticleDefVendors ON ArticleDefTable.MasterID = ArticleDefVendors.ArticleDefId WHERE ArticleDefVendors.VendorId=" & Me.cmbVendor.Value & ""
            Dim dt As DataTable = GetDataTable(Str)
            If dt.Rows.Count < 1 Then Exit Sub
            For Each Row As Infragistics.Win.UltraWinGrid.UltraGridRow In Me.cmbItem.Rows
                If Row.Index > 0 Then
                    Me.cmbItem.Focus()
                    Row.Selected = True
                    Me.txtQty.Focus()
                    For i As Integer = 0 To dt.Rows.Count - 1
                        If Row.Cells(0).Value = dt.Rows(i).Item("ArticleId") Then
                            AddItemToGrid()
                            Application.DoEvents()
                        End If
                    Next
                End If
            Next
            Me.cmbItem.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.CloseDropdown)
            'Me.GetTotal()
            Me.ClearDetailControls()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub rbtAllItem_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtAllItem.CheckedChanged, rbtVendor.CheckedChanged
        Try
            If Me.IsFormLoaded = True Then FillCombo("Item")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub AllItems()
    '    Try
    '        If IsFormLoaded = True Then
    '            If Me.rbtAllItem.Checked = True Then
    '                FillCombo("Item")
    '            Else
    '                Dim Str As String = "SELECT ArticleDefView.ArticleId AS Id, ArticleDefView.ArticleCode AS Code, ArticleDefView.ArticleDescription AS Item,  ArticleDefView.ArticleSizeName AS Size, ArticleDefView.ArticleColorName AS Combination, ArticleDefView.PurchasePrice AS Price, ArticleDefView.SizeRangeId AS [Size ID]FROM ArticleDefView INNER JOIN  ArticleDefVendors ON ArticleDefView.MasterID = ArticleDefVendors.ArticleDefId  WHERE (ArticleDefView.Active = 1) AND (ArticleDefVendors.VendorId=" & Me.cmbVendor.Value & ")"
    '                'FillDropDown(cmbItem, str)
    '                FillUltraDropDown(Me.cmbItem, Str)
    '                Me.cmbItem.Rows(0).Activate()
    '            End If
    '        End If
    '    Catch ex As Exception
    '        Throw ex
    '    End Try
    'End Sub
    Private Sub cmbVendor_Leave(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbVendor.Leave
        Try
            If Me.IsFormLoaded = True AndAlso Me.rbtVendor.Checked = True Then
                FillCombo("Item")
            End If

            'If Me.cmbVendor.IsItemInList = True Then
            '    FillCombo("TransportationVendor")
            'End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub RbtByName_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles RbtByName.CheckedChanged, RbtByCode.CheckedChanged
        Try
            If Me.IsFormLoaded = True Then
                ItemFilterByName = False
                If Me.RbtByCode.Checked = True Then
                    Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(1).Column.Key.ToString
                Else
                    Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(2).Column.Key.ToString
                End If
                'FillCombo("Item")
            End If
        Catch ex As Exception

        End Try
    End Sub
    Private Sub FillComboByEdit()
        Try
            FillCombo("Vendor")
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Public Sub ApplyGridSettings(Optional ByVal Condition As String = "") Implements IGeneral.ApplyGridSettings
        Try
            Dim StockInConfigration As String = "" ''1596
            If getConfigValueByType("WeighbridgePurchase").ToString.ToUpper = "TRUE" Then

                Me.grd.RootTable.Columns(grdEnm.X_Tray_Weights).Visible = True
                Me.grd.RootTable.Columns(grdEnm.X_Gross_Weights).Visible = True
                Me.grd.RootTable.Columns(grdEnm.X_Net_Weights).Visible = True
                Me.grd.RootTable.Columns(grdEnm.Y_Gross_Weights).Visible = True
                Me.grd.RootTable.Columns(grdEnm.Y_Tray_Weights).Visible = True
                Me.grd.RootTable.Columns(grdEnm.Y_Net_Weights).Visible = True
            Else

                Me.grd.RootTable.Columns(grdEnm.X_Tray_Weights).Visible = False
                Me.grd.RootTable.Columns(grdEnm.X_Gross_Weights).Visible = False
                Me.grd.RootTable.Columns(grdEnm.X_Net_Weights).Visible = False
                Me.grd.RootTable.Columns(grdEnm.Y_Gross_Weights).Visible = False
                Me.grd.RootTable.Columns(grdEnm.Y_Tray_Weights).Visible = False
                Me.grd.RootTable.Columns(grdEnm.Y_Net_Weights).Visible = False

            End If
            ''Start Task 1596
            If Not getConfigValueByType("StockInConfigration").ToString = "Error" Then ''1596
                StockInConfigration = getConfigValueByType("StockInConfigration").ToString
            End If
            'ShowInformationMessage(StockInConfigration)
            If StockInConfigration.Equals("Disabled") Then
                Me.grd.RootTable.Columns(grdEnm.BatchNo).Visible = False
            ElseIf StockInConfigration.Equals("Enabled") Then
                Me.grd.RootTable.Columns(grdEnm.BatchNo).Visible = True
                Me.grd.RootTable.Columns(grdEnm.BatchNo).EditType = Janus.Windows.GridEX.EditType.TextBox
            Else
                Me.grd.RootTable.Columns(grdEnm.BatchNo).Visible = True
                Me.grd.RootTable.Columns(grdEnm.BatchNo).EditType = Janus.Windows.GridEX.EditType.TextBox
            End If
            ''End Task 1596
            Me.grd.RootTable.Columns(grdEnm.X_Tray_Weights).Caption = "V Tray Wts"
            Me.grd.RootTable.Columns(grdEnm.X_Gross_Weights).Caption = "V Gross Wts"
            Me.grd.RootTable.Columns(grdEnm.X_Net_Weights).Caption = "V Net Wts"
            Me.grd.RootTable.Columns(grdEnm.Y_Gross_Weights).Caption = "F Gross Wts"
            Me.grd.RootTable.Columns(grdEnm.Y_Tray_Weights).Caption = "F Tray Wts"
            Me.grd.RootTable.Columns(grdEnm.Y_Net_Weights).Caption = "F Net Wts"

            For Each col As Janus.Windows.GridEX.GridEXColumn In Me.grd.RootTable.Columns
                If col.Index <> grdEnm.LocationId AndAlso col.Index <> grdEnm.ReceivedQty _
                    AndAlso col.Index <> grdEnm.RejectedQty _
                    AndAlso col.Index <> grdEnm.Price AndAlso col.Index <> grdEnm.TaxPercent AndAlso col.Index <> grdEnm.CurrencyTaxAmount _
                    AndAlso col.Index <> grdEnm.ExpiryDate AndAlso col.Index <> grdEnm.BatchNo _
                    AndAlso col.Index <> grdEnm.Origin _
                     AndAlso col.Index <> grdEnm.Comments AndAlso col.Index <> grdEnm.Transportation_Charges AndAlso col.Index <> grdEnm.Custom_Charges _
                     AndAlso col.Index <> grdEnm.PackPrice AndAlso col.Index <> grdEnm.X_Tray_Weights AndAlso _
                     col.Index <> grdEnm.X_Gross_Weights AndAlso col.Index <> grdEnm.Y_Gross_Weights _
                     AndAlso col.Index <> grdEnm.Y_Tray_Weights AndAlso col.Index <> grdEnm.AdTax_Percent _
                     AndAlso col.Index <> grdEnm.CurrentPrice AndAlso col.Index <> grdEnm.RateDiscPercent _
 AndAlso col.Index <> grdEnm.CurrencyAmount AndAlso col.Index <> grdEnm.Column1 _
 AndAlso col.Index <> grdEnm.Column2 AndAlso col.Index <> grdEnm.Column3 AndAlso col.Index <> grdEnm.VendorQty AndAlso col.Index <> grdEnm.Deduction AndAlso col.Index <> grdEnm.GrossQty Then
                    col.EditType = Janus.Windows.GridEX.EditType.NoEdit
                End If
            Next
            For Each col As Janus.Windows.GridEX.GridEXColumn In Me.grdInwardExpDetail.RootTable.Columns
                If col.Index <> 3 AndAlso col.Index <> 4 Then
                    col.EditType = Janus.Windows.GridEX.EditType.NoEdit
                End If
            Next
            ''Start TFS4161
            If IsPackQtyDisabled = True Then
                Me.grd.RootTable.Columns(grdEnm.TotalQty).EditType = Janus.Windows.GridEX.EditType.NoEdit
                Me.grd.RootTable.Columns(grdEnm.VendorQty).EditType = Janus.Windows.GridEX.EditType.NoEdit
                Me.grd.RootTable.Columns(grdEnm.GrossQty).EditType = Janus.Windows.GridEX.EditType.NoEdit
            Else
                Me.grd.RootTable.Columns(grdEnm.TotalQty).EditType = Janus.Windows.GridEX.EditType.TextBox
                Me.grd.RootTable.Columns(grdEnm.VendorQty).EditType = Janus.Windows.GridEX.EditType.TextBox
                Me.grd.RootTable.Columns(grdEnm.GrossQty).EditType = Janus.Windows.GridEX.EditType.TextBox
            End If
            ''End TFS4161
            'rafay
            Me.grd.RootTable.Columns(grdEnm.Uom).EditType = Janus.Windows.GridEX.EditType.TextBox
            'rafay
            Me.grd.RootTable.Columns("Pack_Desc").Position = Me.grd.RootTable.Columns("Unit").Index
            Me.grd.RootTable.Columns("Unit").Position = Me.grd.RootTable.Columns("Pack_Desc").Index
            Me.grd.RootTable.Columns("Total Amount").FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns("Total Amount").FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("Total Amount").TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("Vendor_Qty").FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns("Vendor_Qty").TotalFormatString = "N" & DecimalPointInQty
            'Me.grd.RootTable.Columns("Vendor_Qty").FormatString = "N" & TotalAmountRounding
            'Me.grd.RootTable.Columns("Vendor_Qty").TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("Deduction").FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns("Deduction").TotalFormatString = "N" & DecimalPointInQty
            'Me.grd.RootTable.Columns("Deduction").FormatString = "N" & TotalAmountRounding
            'Me.grd.RootTable.Columns("Deduction").TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("VendorNetQty").FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns("VendorNetQty").TotalFormatString = "N" & DecimalPointInQty
            'Me.grd.RootTable.Columns("VendorNetQty").FormatString = "N" & TotalAmountRounding
            'Me.grd.RootTable.Columns("VendorNetQty").TotalFormatString = "N" & TotalAmountRounding

            '''
            Me.grd.RootTable.Columns("TotalQty").FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns("TotalQty").FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("TotalQty").TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.ReceivedQty).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(grdEnm.ReceivedQty).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.ReceivedQty).TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.RejectedQty).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(grdEnm.RejectedQty).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.RejectedQty).TotalFormatString = "N" & TotalAmountRounding

            'Me.grd.RootTable.Columns(grdEnm.Qty).FormatString = "N" & DecimalPointInQty
            'Me.grd.RootTable.Columns(grdEnm.Qty).TotalFormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns("TotalQty").FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns("TotalQty").FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("TotalQty").TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.TaxAmount).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(grdEnm.TaxAmount).FormatString = "N" & TotalAmountRounding 'Task:2647 Set Rounding Format
            ''27-Jul-2014 Task:2762 Imran Ali Total Amount Rounding configuration
            Me.grd.RootTable.Columns(grdEnm.TaxAmount).TotalFormatString = "N" & TotalAmountRounding 'Task:2647 Set Rounding Format 
            Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).FormatString = "N" & 2
            Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).FormatString = "N" & 2 'Task:2647 Set Rounding Format
            ''27-Jul-2014 Task:2762 Imran Ali Total Amount Rounding configuration
            Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).TotalFormatString = "N" & 2
            Me.grd.RootTable.Columns(grdEnm.TotalAmount).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(grdEnm.TotalAmount).FormatString = "N" & TotalAmountRounding 'Task:2647 Set Rounding Format
            Me.grd.RootTable.Columns(grdEnm.TotalAmount).TotalFormatString = "N" & TotalAmountRounding 'Task:2647 Set Rounding Format

            'Task:2759 Set Rounded Amount Format.

            Me.grd.RootTable.Columns(grdEnm.Total).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(grdEnm.Total).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.Total).TotalFormatString = "N" & TotalAmountRounding
            'End Task:2762
            'End Task:2759

            Me.grd.RootTable.Columns(grdEnm.Price).FormatString = "N"
            Me.grd.RootTable.Columns(grdEnm.Price).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(grdEnm.Price).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.Price).TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.CurrentPrice).FormatString = "N"
            Me.grd.RootTable.Columns(grdEnm.CurrentPrice).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(grdEnm.CurrentPrice).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.CurrentPrice).TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.CurrencyRate).FormatString = "N" & 4
            Me.grd.RootTable.Columns(grdEnm.CurrencyRate).FormatString = "N" & 4
            Me.grd.RootTable.Columns(grdEnm.CurrencyRate).TotalFormatString = "N" & 4
            Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.CurrencyTotalAmount).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(grdEnm.CurrencyTotalAmount).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(grdEnm.CurrencyTotalAmount).TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("Origin").HasValueList = True
            Me.grd.RootTable.Columns("Origin").LimitToList = False
            Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns(grdEnm.BatchNo).Visible = True
            Me.grd.RootTable.Columns(grdEnm.ExpiryDate).Visible = True
            Dim bln As Boolean = Convert.ToBoolean(getConfigValueByType("GridFreezColumn").Replace("Error", "False").Replace("''", "False"))
            If bln = True Then
                Me.grd.FrozenColumns = grdEnm.Size
            Else
                Me.grd.FrozenColumns = 0
            End If

            Dim dtColSettings As DataTable = GetDataTable("Select * From InventoryColumnSettings")
            dtColSettings.AcceptChanges()
            If (dtColSettings.Rows.Count > 0 _
                AndAlso grd.DataSource IsNot Nothing) Then

                grd.RootTable.Columns(grdEnm.Column1).Caption = dtColSettings.Rows(0)("Column1").ToString()
                grd.RootTable.Columns("Column1").Visible = dtColSettings.Rows(0)("Column1Visibility")


                grd.RootTable.Columns("Column2").Caption = dtColSettings.Rows(0)("Column2").ToString()
                grd.RootTable.Columns("Column2").Visible = dtColSettings.Rows(0)("Column2Visibility")

                grd.RootTable.Columns("Column3").Caption = dtColSettings.Rows(0)("Column3").ToString()
                grd.RootTable.Columns("Column3").Visible = dtColSettings.Rows(0)("Column3Visibility")


            Else
                If (grd.DataSource IsNot Nothing) Then
                    grd.RootTable.Columns("Column1").Visible = False
                    grd.RootTable.Columns("Column2").Visible = False
                    grd.RootTable.Columns("Column3").Visible = False

                End If
            End If



            'Me.grd.AutoSizeColumns()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Public Sub ApplySecurity(ByVal Mode As SBUtility.Utility.EnumDataMode, Optional ByVal Condition As String = "") Implements IGeneral.ApplySecurity

    End Sub

    Public Function Delete(Optional ByVal Condition As String = "") As Boolean Implements IGeneral.Delete
        Try
            StockMaster = New StockMaster
            StockMaster.StockTransId = Convert.ToInt32(GetStockTransId(Me.grdSaved.CurrentRow.Cells(0).Value))
            Return New StockDAL().Delete(StockMaster)
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Public Sub FillCombos(Optional ByVal Condition As String = "") Implements IGeneral.FillCombos

    End Sub

    Public Sub FillModel(Optional ByVal Condition As String = "") Implements IGeneral.FillModel
        Try

            Dim transId As Integer = 0
            'transId = Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
            StockMaster = New StockMaster
            StockMaster.StockTransId = 0I 'transId
            StockMaster.DocNo = Me.txtPONo.Text.ToString.Replace("'", "''")
            StockMaster.DocDate = Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt")
            StockMaster.DocType = 1 ''Convert.ToInt32(GetStockDocTypeId("GRN").ToString)
            StockMaster.Remaks = Me.txtRemarks.Text.ToString.Replace("'", "''")
            StockMaster.Project = Me.cmbProject.SelectedValue
            StockMaster.AccountId = Me.cmbVendor.Value
            StockMaster.StockDetailList = StockList 'New List(Of StockDetail)
            Dim i As Integer = 0
            'For Each grdRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
            '    StockDetail = New StockDetail
            '    StockDetail.StockTransId = transId 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
            '    StockDetail.LocationId = grdRow.Cells("LocationID").Value
            '    StockDetail.ArticleDefId = grdRow.Cells("ItemId").Value
            '    StockDetail.InQty = IIf(grdRow.Cells("Unit").Value = "Loose", Val(grdRow.Cells("Qty").Value), (Val(grdRow.Cells("Qty").Value) * Val(grdRow.Cells("PackQty").Value)))
            '    StockDetail.OutQty = 0
            '    StockDetail.Rate = IIf(objRateList.Count = 0, Val(grdRow.Cells("Rate").Value.ToString), objRateList(i))
            '    StockDetail.InAmount = IIf(grdRow.Cells("Unit").Value = "Loose", (Val(grdRow.Cells("Qty").Value) * IIf(objRateList.Count = 0, Val(grdRow.Cells("Rate").Value.ToString), objRateList(i))), ((Val(grdRow.Cells("Qty").Value) * Val(grdRow.Cells("PackQty").Value)) * IIf(objRateList.Count = 0, Val(grdRow.Cells("Rate").Value.ToString), objRateList(i))))
            '    StockDetail.OutAmount = 0
            '    StockDetail.Remarks = String.Empty
            '    StockMaster.StockDetailList.Add(StockDetail)
            '    i += 1
            'Next
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Public Sub GetAllRecords(Optional ByVal Condition As String = "") Implements IGeneral.GetAllRecords

    End Sub

    Public Function IsValidate(Optional ByVal Mode As SBUtility.Utility.EnumDataMode = SBUtility.Utility.EnumDataMode.Disabled, Optional ByVal Condition As String = "") As Boolean Implements IGeneral.IsValidate
        Try

            FillModel()
            Return True
        Catch ex As Exception
            Throw ex
        End Try
    End Function


    Public Sub ReSetControls(Optional ByVal Condition As String = "") Implements IGeneral.ReSetControls

    End Sub

    Public Function Save1(Optional ByVal Condition As String = "") As Boolean Implements IGeneral.Save
        Try
            If IsValidate() = True Then
                Return New StockDAL().Add(StockMaster)
            Else
                Return False
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Public Sub SetButtonImages() Implements IGeneral.SetButtonImages

    End Sub

    Public Sub SetConfigurationBaseSetting() Implements IGeneral.SetConfigurationBaseSetting

    End Sub

    Public Sub SetNavigationButtons(ByVal Mode As SBUtility.Utility.EnumDataMode, Optional ByVal Condition As String = "") Implements IGeneral.SetNavigationButtons

    End Sub

    Public Function Update1(Optional ByVal Condition As String = "") As Boolean Implements IGeneral.Update
        Try
            If IsValidate() = True Then
                Return New StockDAL().Update(StockMaster)
            Else
                Return False
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub grd_ColumnButtonClick(ByVal sender As System.Object, ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.ColumnButtonClick
        Try
            If Not msg_Confirm(str_ConfirmDelete) = True Then Exit Sub
            If e.Column.Key = "Delete" Then
                Me.grd.GetRow.Delete()
                grd.UpdateData()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Function POAccess(ByVal ArticleId As Integer, ByVal PONo As String) As Double
        Try
            Dim str As String = String.Empty
            Dim dt As DataTable
            Dim POAccessFlg As Boolean
            POAccessFlg = IIf(getConfigValueByType("POAccessOnPurchase").ToString = "Error" Or getConfigValueByType("POAccessOnPurchase").ToString = "", False, getConfigValueByType("POAccessOnPurchase").ToString)
            If POAccessFlg = True Then
                str = " Select PONo, ItemId, Qty, RecQty " _
                      & " From( " _
                      & " SELECT dbo.PurchaseOrderMasterTable.PurchaseOrderNo as PONo, dbo.PurchaseOrderDetailTable.ArticleDefId as ItemId, SUM(ISNULL(dbo.PurchaseOrderDetailTable.Qty, 0))  " _
                      & " AS Qty, Sum(Isnull(Rec.Qty,0)) as RecQty " _
                      & " FROM dbo.PurchaseOrderMasterTable INNER JOIN " _
                      & " dbo.PurchaseOrderDetailTable ON dbo.PurchaseOrderMasterTable.PurchaseOrderId = dbo.PurchaseOrderDetailTable.PurchaseOrderId " _
                      & " LEFT OUTER JOIN " _
                      & " (SELECT dbo.ReceivingMasterTable.PurchaseOrderID, dbo.ReceivingDetailTable.ArticleDefId, SUM(ISNULL(dbo.ReceivingDetailTable.Qty, 0))AS Qty " _
                      & " FROM dbo.ReceivingMasterTable INNER JOIN dbo.ReceivingDetailTable ON dbo.ReceivingMasterTable.ReceivingId = dbo.ReceivingDetailTable.ReceivingId " _
                      & " GROUP BY dbo.ReceivingMasterTable.PurchaseOrderID, dbo.ReceivingDetailTable.ArticleDefId) Rec ON  " _
                      & " Rec.PurchaseOrderID = PurchaseOrderMasterTable.PurchaseOrderId And Rec.ArticleDefId = PurchaseOrderDetailTable.ArticleDefId " _
                      & " GROUP BY dbo.PurchaseOrderMasterTable.PurchaseOrderNo, dbo.PurchaseOrderDetailTable.ArticleDefId  " _
                      & " ) " _
                      & " Abc " _
                      & " WHERE PONo=N'" & PONo & "' AND ItemId=N'" & ArticleId & "' " _
                      & " ORDER BY 1,2 Asc "
                dt = GetDataTable(str)
                dt.Columns.Add("Balance", GetType(System.Double))
                dt.Columns("Balance").Expression = "Qty-RecQty"
                If dt.Rows.Count > 0 Then
                    If Val(Me.grd.GetRow.Cells("ReceivedQty").Value) > Val(dt.Rows(0).Item("Qty")) Then
                        If msg_Confirm("Receiving qty grater than Purchase order qty. " + vbCrLf + " Are you sure! you want to Received Qty") = True Then
                            Me.grd.GetRow.Cells("ReceivedQty").Value = Me.grd.GetRow.Cells("ReceivedQty").Value
                        Else
                            Me.grd.GetRow.Cells("ReceivedQty").Value = 0
                            Dim RowCol As New Janus.Windows.GridEX.GridEXFormatStyle
                            RowCol.BackColor = Color.AntiqueWhite
                            Me.grd.GetRows(Me.grd.GetRow.Cells("ReceivedQty").Row.RowIndex).RowStyle = RowCol
                            Me.grd.Focus()
                        End If
                    End If
                Else
                    Return 0
                End If
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub grd_CellUpdated(ByVal sender As System.Object, ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.CellUpdated
        Try
            If Me.grd.RowCount = 0 Then Exit Sub
            GetGridDetailQtyCalculate(e)
            If e.Column.Index = grdEnm.Price Then
                Me.grd.GetRow.Cells("RateDiscPercent").Value = 0
                Me.grd.GetRow.Cells("CurrentPrice").Value = Val(Me.grd.GetRow.Cells("Rate").Value.ToString)
            End If
            GetDiscountedPrice()
            If (e.Column.Index = grdEnm.X_Tray_Weights Or e.Column.Index = grdEnm.X_Gross_Weights Or e.Column.Index = grdEnm.Y_Gross_Weights Or e.Column.Index = grdEnm.Y_Tray_Weights) Then
                GetFinalWeights()
            End If
            With grd.CurrentRow
                POAccess(.Cells("ItemId").Value, Me.cmbPo.Text)
                'txtDiscount_LostFocus(Nothing, Nothing)
            End With
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub cmbItem_RowSelected(ByVal sender As System.Object, ByVal e As Infragistics.Win.UltraWinGrid.RowSelectedEventArgs) Handles cmbItem.RowSelected
    '    Try
    '        If Me.cmbItem.IsItemInList = False Then
    '            Me.txtStock.Text = 0
    '            Exit Sub
    '        Else
    '            If Me.cmbItem.Value Is Nothing Then Exit Sub
    '            Me.txtStock.Text = Convert.ToDouble(GetStockById(Me.cmbItem.ActiveRow.Cells(0).Value, Me.cmbCategory.SelectedValue))
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Private Sub CtrlGrdBar1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CtrlGrdBar1.Load
        Try
            If IO.File.Exists(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grd.Name) Then
                Dim fs As New IO.FileStream(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grd.Name, IO.FileMode.Open, IO.FileAccess.ReadWrite)
                Me.grd.LoadLayoutFile(fs)
                fs.Close()
                fs.Dispose()
            End If
            CtrlGrdBar.strForm_Name = CtrlGrdBar.EnmAccountType.Vendors
            Me.CtrlGrdBar1.txtGridTitle.Text = CompanyTitle & Chr(10) & "Purchase"
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Function GetDocumentNo() As String
        Try
            Dim PreFix As String = ""
            Dim CompanyWisePrefix As Boolean = False
            CompanyWisePrefix = Convert.ToBoolean(getConfigValueByType("ShowCompanyWisePrefix").ToString)
            'rafay commented this
            'If CompanyWisePrefix = True Then
            '    PreFix = "PI" & Me.cmbCompany.SelectedValue & "-"
            'Else
            '    PreFix = "PI-"
            'End If
            ''rafay:task start
            'If str_Company = "V-ERP (UAE)" Then
            '    CompanyPrefix = "UE"
            'Else
            '    CompanyPrefix = "PK"
            'End If
            ''rafay:task end
            If getConfigValueByType("VoucherNo").ToString = "Yearly" Then
                ' Return GetSerialNo(PreFix + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "ReceivingMasterTable", "ReceivingNo")
                'rafay:task start
                If CompanyPrefix = "V-ERP (UAE)" Then
                    'companyinitials = "UE"
                    Return GetSerialNo("Pur-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "ReceivingMasterTable", "ReceivingNo")
                Else
                    ''companyinitials = "PK"
                    Return GetNextDocNo("PI-" & companyinitials & "-" & Format(Me.dtpPODate.Value, "yy"), 4, "ReceivingMasterTable", "ReceivingNo")
                End If
                ' Return GetNextDocNo(PreFix & CompanyPrefix & "-" & Format(Me.dtpPODate.Value, "yy"), 4, "ReceivingMasterTable", "ReceivingNo")
            ElseIf getConfigValueByType("VoucherNo").ToString = "Monthly" Then
                'rafay:task start
                If CompanyPrefix = "V-ERP (UAE)" Then
                    'companyinitials = "UE"
                    Return GetSerialNo("Pur-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "ReceivingMasterTable", "ReceivingNo")
                Else
                    ''companyinitials = "PK"
                    Return GetNextDocNo("PI-" & companyinitials & "-" & Format(Me.dtpPODate.Value, "yy"), 4, "ReceivingMasterTable", "ReceivingNo")
                End If
                ' Return GetNextDocNo(PreFix & CompanyPrefix & "-" & Format(Me.dtpPODate.Value, "yy"), 4, "ReceivingMasterTable", "ReceivingNo")
                'rafay : task end
            Else
                Return GetNextDocNo("PI-", 6, "ReceivingMasterTable", "ReceivingNo")
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub btnAddNewItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAddNewItem.Click
        Call frmAddItem.ShowDialog()
        Call FillCombo("Item")
    End Sub

    Private Sub CtrlGrdBar3_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CtrlGrdBar3.Load
        Try
            If IO.File.Exists(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name) Then
                Dim fs As New IO.FileStream(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name, IO.FileMode.Open, IO.FileAccess.ReadWrite)
                'Me.grdSaved.SaveLayoutFile(fs)
                Me.grdSaved.LoadLayoutFile(fs)
                fs.Close()
                fs.Dispose()
            End If
            Me.CtrlGrdBar3.txtGridTitle.Text = CompanyTitle & Chr(10) & "Purchase"
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Function EmailSave()
        EmailSave = Nothing
        Dim flg As Boolean = False
        If Me.cmbVendor.ActiveRow Is Nothing Then Exit Function

        If IsEmailAlert = True Then
            Dim dtForm As DataTable = GetDataTable("Select ISNULL(EmailAlert,0) as EmailAlert  From tblForm WHERE Form_Name='frmPurchase' AND EmailAlert=1")
            If dtForm.Rows.Count > 0 Then
                flg = True
            Else
                flg = False
            End If
            If flg = True Then
                Email = New Email
                Email.ToEmail = AdminEmail
                Email.CCEmail = String.Empty
                Email.BccEmail = Me.cmbVendor.ActiveRow.Cells("Email").Text.ToString
                Email.Attachment = SourceFile
                Email.Subject = "Purchase Invoice " & setVoucherNo & ""
                Email.Body = "Purchase Invoice " _
                & " " & IIf(setEditMode = False, "of amount " & Total_Amount & " is made", "of amount " & Previouse_Amount & " is updated to " & Total_Amount & "") & " by user " & LoginUserName & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & "Auto Generated By SIRIUS ERP System"
                Email.Status = "Pending"
                Call New MailSentDAL().Add(Email)
            End If
        End If
        Return EmailSave

    End Function
    'Private Sub btnPayment_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnPayment.Click
    '    Try
    '        If Me.grd.RowCount = 0 Then Exit Sub
    '        If getConfigValueByType("PaymentVoucherOnPurchase").ToString = "True" Then
    '            'If Me.SplitContainer1.Panel2Collapsed = True Then
    '            '    Me.SplitContainer1.Panel2Collapsed = False
    '            'End If
    '            Me.GroupBox5.Visible = True
    '        Else
    '            Me.GroupBox5.Visible = False
    '        End If
    '        If Me.SplitContainer1.Panel2Collapsed = True Then
    '            Me.SplitContainer1.Panel2Collapsed = False
    '        Else
    '            Me.SplitContainer1.Panel2Collapsed = True
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Sub FillPaymentMethod()

        Dim dt As New DataTable
        Dim dr As DataRow
        Dim dr1 As DataRow
        dt.Columns.Add("Id")
        dt.Columns.Add("Name")
        dr = dt.NewRow
        dr1 = dt.NewRow

        dr(0) = Convert.ToInt32(4)
        dr(1) = "Bank"
        dt.Rows.InsertAt(dr, 0)

        dr1(0) = Convert.ToInt32(2)
        dr1(1) = "Cash"
        dt.Rows.InsertAt(dr1, 0)

        Me.cmbMethod.DisplayMember = dt.Columns(1).ColumnName.ToString() 'objDataSet.Tables(0).Columns(1).ColumnName
        Me.cmbMethod.ValueMember = dt.Columns(0).ColumnName.ToString() 'objDataSet.Tables(0).Columns(0).ColumnName)
        Me.cmbMethod.DataSource = dt

    End Sub
    Private Sub VoucherDetail(ByVal PurchaseNo As String)
        Try
            Dim str As String = String.Empty
            str = "SELECT dbo.tblVoucher.voucher_id, dbo.tblVoucher.location_id, dbo.tblVoucher.voucher_code, dbo.tblVoucher.voucher_type_id, dbo.tblVoucher.voucher_no, " _
                  & " dbo.tblVoucherDetail.credit_amount, tblVoucherDetail.debit_amount, dbo.tblVoucherDetail.CostCenterID, tblVoucher.coa_detail_id, tblVoucher.Cheque_No, tblVoucher.Cheque_Date " _
                  & " FROM  dbo.tblVoucher INNER JOIN " _
                  & " dbo.tblVoucherDetail ON dbo.tblVoucher.voucher_id = dbo.tblVoucherDetail.voucher_id " _
                  & " WHERE (dbo.tblVoucher.voucher_type_id = 2 Or dbo.tblVoucher.voucher_type_id=4) AND (tblVoucherDetail.coa_detail_id=" & Me.cmbVendor.Value & ") AND (dbo.tblVoucher.voucher_code = N'" & PurchaseNo & "')"
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then
                    Me.cmbMethod.SelectedValue = Convert.ToInt32(dt.Rows(0).ItemArray(3))
                    Me.cmbDepositAccount.SelectedValue = Convert.ToInt32(dt.Rows(0).ItemArray(8))

                    If Not IsDBNull(dt.Rows(0).ItemArray(9)) Then
                        Me.txtChequeNo.Text = dt.Rows(0).ItemArray(9).ToString
                    Else
                        Me.txtChequeNo.Text = String.Empty
                    End If

                    If Not IsDBNull(dt.Rows(0).ItemArray(10)) Then
                        Me.dtpChequeDate.Value = Convert.ToDateTime(dt.Rows(0).ItemArray(10))
                    Else
                        Me.dtpChequeDate.Value = Date.Today
                    End If

                    Me.txtVoucherNo.Text = dt.Rows(0).ItemArray(4)
                    Me.txtRecAmount.Text = Convert.ToDouble(dt.Rows(0).ItemArray(6))
                    VNo = dt.Rows(0).ItemArray(4)
                    VoucherId = dt.Rows(0).ItemArray(0)
                    'Me.cmbMethod.Enabled = False
                    ExistingVoucherFlg = True
                Else
                    Me.cmbMethod.SelectedIndex = 0
                    cmbDepositAccount.SelectedIndex = 0
                    Me.txtChequeNo.Text = String.Empty
                    Me.dtpChequeDate.Value = Date.Today
                    VoucherId = 0I
                    VNo = String.Empty
                    Me.txtVoucherNo.Text = String.Empty
                    Me.txtRecAmount.Text = String.Empty
                    ExistingVoucherFlg = False
                End If
            Else
                Me.cmbMethod.SelectedIndex = 0
                cmbDepositAccount.SelectedIndex = 0
                Me.txtChequeNo.Text = String.Empty
                Me.dtpChequeDate.Value = Date.Today
                VoucherId = 0I
                VNo = String.Empty
                Me.txtVoucherNo.Text = String.Empty
                Me.txtRecAmount.Text = String.Empty
                ExistingVoucherFlg = False
            End If
        Catch ex As Exception

        End Try
    End Sub
    Function GetVoucherNo() As String
        Dim docNo As String = String.Empty
        Dim VType As String = String.Empty
        If Me.cmbMethod.SelectedIndex > 0 Then
            ''Start TFS2612
            VType = "BPV" & IIf(getConfigValueByType("CompanyWisePrefix").ToString = "True", Me.cmbCompany.SelectedValue, String.Empty)
        Else
            VType = "CPV" & IIf(getConfigValueByType("CompanyWisePrefix").ToString = "True", Me.cmbCompany.SelectedValue, String.Empty)
            ''End TFS2612
        End If
        Try
            If getConfigValueByType("VoucherNo").ToString = "Yearly" Then
                Return GetSerialNo(VType + "-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "tblVoucher", "voucher_no")
            Else
                Dim strSQL As String = "Select * from ConfigValuesTable Where Config_type='VoucherNo'"
                Dim dr As DataRow = SBDal.UtilityDAL.ReturnDataRow(strSQL)
                If Not dr Is Nothing Then
                    If dr("config_Value") = "Monthly" Then
                        Return GetNextDocNo(VType & "-" & Format(Me.dtpPODate.Value, "yy") & Me.dtpPODate.Value.Month.ToString("00"), 4, "tblVoucher", "voucher_no")
                    Else
                        docNo = GetNextDocNo(VType, 6, "tblVoucher", "voucher_no")
                        Return docNo
                    End If
                Else
                    docNo = GetNextDocNo(VType, 6, "tblVoucher", "voucher_no")
                    Return docNo
                End If
                Return ""
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub cmbMethod_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMethod.SelectedIndexChanged
        Try
            Dim str As String = String.Empty
            If Me.cmbMethod Is Nothing Then Exit Sub
            str = "If exists(select Account_Id FROM tblUserAccountRights where UserID = " & LoginUserId & " And Rights = 1 And Account_Id Is Not Null) " _
                                  & " select coa_detail_id, detail_title from vwCoaDetail where account_type=N'" & Me.cmbMethod.Text & "' And coa_detail_id in (select Account_Id FROM tblUserAccountRights where UserID = " & LoginUserId & " And Rights = 1) " _
                                  & " Else " _
                                  & " select coa_detail_id, detail_title from vwCoaDetail where account_type=N'" & Me.cmbMethod.Text & "' "

            'str = "select coa_detail_id,detail_title from vwCoaDetail where account_type=N'" & Me.cmbMethod.Text & "'"
            FillDropDown(Me.cmbDepositAccount, str, True)
            'If getConfigValueByType("PaymentVoucherOnPurchase").ToString = "True" Then
            If Me.cmbMethod.SelectedIndex = 0 Then
                'Me.txtChequeNo.Visible = False
                'Me.dtpChequeDate.Visible = False
                Me.grpCashPayment.Visible = False
            Else
                'Me.txtChequeNo.Visible = True
                'Me.dtpChequeDate.Visible = True
                Me.grpCashPayment.Visible = True
            End If
            Me.txtVoucherNo.Text = GetVoucherNo()
            'End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    'Private Sub ToolStripButton1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ToolStripButton1.Click
    '    Try
    '        If Me.SplitContainer2.Panel1Collapsed = True Then
    '            Me.SplitContainer2.Panel1Collapsed = False
    '        Else
    '            Me.SplitContainer2.Panel1Collapsed = True
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Private Sub btnSearch_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearch.Click
        Try
            DisplayRecord("All")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub Voucher_Delete(ByVal objTrans As OleDb.OleDbTransaction)
        ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
        'Dim lngVoucherId As Integer = GetVoucherId("frmPurchase", grdSaved.CurrentRow.Cells(0).Value.ToString)
        'End Task:2483
        Dim cm As New OleDbCommand
        'If Con.State = ConnectionState.Closed Then Con.Open()
        'Dim objTrans As OleDbTransaction
        'objTrans = Con.BeginTransaction
        Try


            cm = New OleDbCommand
            cm.Connection = Con
            cm.CommandText = "delete from tblvoucherdetail where voucher_id=" & lngVoucherId

            cm.Transaction = objTrans
            cm.ExecuteNonQuery()

            cm = New OleDbCommand
            cm.Connection = Con
            cm.CommandText = "delete from tblvoucher where voucher_id=" & lngVoucherId

            cm.Transaction = objTrans
            cm.ExecuteNonQuery()

            'objTrans.Commit()

        Catch ex As Exception
            objTrans.Rollback()
            Throw ex
        Finally
            'Con.Close()
        End Try
    End Sub
    Public Function Get_All(ByVal ReceivingNo As String)
        Try
            Get_All = Nothing
            If Not ReceivingNo.Length > 0 Then Exit Try
            If IsFormLoaded = True Then
                If ReceivingNo.Length > 0 Then
                    Dim str As String = "Select * From ReceivingMasterTable WHERE ReceivingNo=N'" & ReceivingNo & "'"
                    Dim dt As DataTable = GetDataTable(str)
                    If dt IsNot Nothing Then
                        If dt.Rows.Count > 0 Then

                            IsEditMode = True
                            'FillCombo("Vendor")
                            'FillCombo("CostCenter")
                            Me.txtReceivingID.Text = dt.Rows(0).Item("ReceivingId")
                        End If
                    End If
                    '            Me.txtPONo.Text = dt.Rows(0).Item("ReceivingNo").ToString
                    '            Me.dtpPODate.Value = dt.Rows(0).Item("ReceivingDate")
                    '            Me.cmbVendor.Value = dt.Rows(0).Item("VendorId")
                    '            If Me.cmbVendor.Value Is Nothing Then
                    '                ShowErrorMessage("Vendor is disabled.")
                    '                Return Nothing
                    '            End If
                    '            Me.txtRemarks.Text = dt.Rows(0).Item("Remarks").ToString
                    '            Me.txtPaid.Text = dt.Rows(0).Item("CashPaid")
                    '            Me.cmbPo.SelectedValue = dt.Rows(0).Item("PurchaseOrderid")
                    '            Me.chkPost.Checked = dt.Rows(0).Item("Post")
                    '            Me.txtVhNo.Text = dt.Rows(0).Item("Vehicle_No").ToString
                    '            Me.txtDriverName.Text = dt.Rows(0).Item("Driver_Name").ToString
                    '            If Not IsDBNull(dt.Rows(0).Item("Dcdate")) Then
                    '                Me.dtpDcDate.Value = dt.Rows(0).Item("Dcdate")
                    '                Me.dtpDcDate.Checked = True
                    '            Else
                    '                Me.dtpDcDate.Value = Date.Today
                    '                Me.dtpDcDate.Checked = False
                    '            End If
                    '            Me.txtInvoiceNo.Text = dt.Rows(0).Item("Vendor_Invoice_No").ToString
                    '            Me.cmbProject.SelectedValue = dt.Rows(0).Item("CostCenterId").ToString
                    '            Me.txtIGPNo.Text = dt.Rows(0).Item("IGPNo").ToString
                    '            If Not IsDBNull(dt.Rows(0).Item("Total_Discount_Amount")) Then
                    '                Me.txtDiscount.Text = Val(dt.Rows(0).Item("Total_Discount_Amount"))
                    '            Else
                    '                Me.txtDiscount.Text = String.Empty
                    '            End If

                    '            If IsDBNull(dt.Rows(0).Item("CurrencyType")) Then
                    '                Me.cmbCurrency.SelectedIndex = 0
                    '            Else
                    '                cmbCurrency.SelectedValue = dt.Rows(0).Item("CurrencyType")
                    '            End If

                    '            If IsDBNull(dt.Rows(0).Item("Transportation_Vendor")) Then
                    '                Me.cmbTransportationVendor.Rows(0).Activate()
                    '            Else
                    '                Me.cmbTransportationVendor.Value = dt.Rows(0).Item("Transportation_Vendor")
                    '            End If

                    '            If IsDBNull(dt.Rows(0).Item("CurrencyRate")) Then
                    '                Me.cmbCurrency.SelectedIndex = 0
                    '            Else
                    '                cmbCurrency.SelectedValue = dt.Rows(0).Item("CurrencyRate")
                    '            End If


                    '            If Me.cmbPo.SelectedValue > 0 Then
                    '                Me.cmbVendor.Enabled = False
                    '            Else
                    '                Me.cmbVendor.Enabled = True
                    '            End If
                    '            Me.BtnSave.Text = "&Update"
                    '            Me.GetSecurityRights()
                    '            Me.UltraTabControl1.SelectedTab = Me.UltraTabPageControl1.Tab
                    '            Me.tbPurchaseDetail.SelectedTab = Me.tbPurchaseDetail.Tabs(0).TabPage.Tab
                    '            VoucherDetail(Me.txtPONo.Text)
                    '            IsDrillDown = True
                    '            Me.cmbVendor.PerformAction(Win.UltraWinGrid.UltraComboAction.CloseDropdown)

                    '            If flgDateLock = True Then
                    '                If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00"))) Then
                    '                    'ShowErrorMessage("Previous date work not allowed") : Exit Sub
                    '                    Me.dtpPODate.Enabled = False
                    '                Else
                    '                    Me.dtpPODate.Enabled = True
                    '                End If
                    '            Else
                    '                Me.dtpPODate.Enabled = True
                    '            End If

                    '        Else
                    '            Exit Function
                    '        End If
                    '    Else
                    '        Exit Function
                    '    End If
                    'End If

                    ''Task# H08062015  Ahmad Sharif:
                    DisplayDetail(Val(Me.txtReceivingID.Text))
                    IsDrillDown = True
                    If Me.grdSaved.RowCount <= 50 Then
                        blnDisplayAll = True
                        Me.btnSearchLoadAll_Click(Nothing, Nothing)
                        blnDisplayAll = False
                    End If
                    ''Start TFS3097 :Ayesha Rehman : Edit Against TFS3097
                    Dim flag As Boolean = False
                    flag = CBool(Me.grdSaved.FindAll(Me.grdSaved.RootTable.Columns("ReceivingNo"), Janus.Windows.GridEX.ConditionOperator.Equal, ReceivingNo))
                    ''End TFS3097
                    If flag = True Then
                        Me.grdSaved_CellDoubleClick(Nothing, Nothing)
                    Else
                        Exit Function
                    End If
                    '' End Task# H08062015

                End If

            End If

            Return Get_All
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Private Sub btnSearchDocument_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchDocument.Click
        Try
            If Not Me.cmbSearchLocation.Items.Count > 0 Then
                FillCombo("SearchLocation")
                If Not Me.cmbSearchLocation.SelectedIndex = -1 Then Me.cmbSearchLocation.SelectedIndex = 0
            Else
                If Not Me.cmbSearchLocation.SelectedIndex = -1 Then Me.cmbSearchLocation.SelectedIndex = 0
            End If
            If Not Me.cmbSearchAccount.IsItemInList Then
                FillCombo("SearchVendor")
                Me.cmbSearchAccount.Rows(0).Activate()
            Else
                Me.cmbSearchAccount.Rows(0).Activate()
            End If
            FillCombo("SearchCostCenter")

            If Me.SplitContainer2.Panel1Collapsed = True Then
                Me.SplitContainer2.Panel1Collapsed = False
            Else
                Me.SplitContainer2.Panel1Collapsed = True
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnSearchLoadAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchLoadAll.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            DisplayRecord("All")
            Me.DisplayDetail(-1)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub btnSearchDelete_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchDelete.Click
        Try
            DeleteToolStripButton_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnSearchEdit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchEdit.Click
        Try
            OpenToolStripButton_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub PurchaseInvoiceToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PurchaseInvoiceToolStripMenuItem1.Click
        Try
            PurchaseInvoiceToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub InwardGatepassToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles InwardGatepassToolStripMenuItem.Click
        Try
            InwordGatePToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub InspectionReportToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles InspectionReportToolStripMenuItem1.Click
        Try
            InspectionReportToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub RejectionReportToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles RejectionReportToolStripMenuItem.Click
        Try
            PurchaseReturnReportToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub UltraTabControl1_SelectedTabChanging(ByVal sender As System.Object, ByVal e As Infragistics.Win.UltraWinTabControl.SelectedTabChangingEventArgs) Handles UltraTabControl1.SelectedTabChanging
        Try
            If e.Tab.Index = 1 Then
                DisplayRecord()
            Else
                ''16-Dec-2013 R934   M Ijaz Javed       Hide Buttons Edit,Delete and Print on Load Form
                If IsEditMode = False Then Me.BtnDelete.Visible = False
                If IsEditMode = False Then Me.BtnPrint.Visible = False
                '''''''''''''''''''''''''''''''''''''''''''''''''''''''
                Me.BtnEdit.Visible = False
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub ExportFile(ByVal VoucherId As Integer)
        Try
            If IsEmailAlert = True Then
                If IsAttachmentFile = True Then
                    crpt = New ReportDocument
                    If IO.File.Exists(str_ApplicationStartUpPath & "\Reports\PurchaseInvoice.rpt") = False Then Exit Sub
                    crpt.Load(str_ApplicationStartUpPath & "\Reports\PurchaseInvoice.rpt", DBServerName)
                    If DBUserName <> "" Then
                        crpt.DataSourceConnections.Item(0).SetConnection(DBServerName, DBName, DBUserName, DBPassword)
                        crpt.DataSourceConnections.Item(0).SetLogon(DBName, DBPassword)
                    Else
                        crpt.DataSourceConnections.Item(0).SetConnection(DBServerName, DBName, True)
                    End If

                    Dim ConnectionInfo As New ConnectionInfo
                    With ConnectionInfo
                        .ServerName = DBServerName
                        .DatabaseName = DBName
                        If DBUserName <> "" Then
                            .UserID = DBUserName
                            .Password = DBPassword
                            .IntegratedSecurity = False
                        Else
                            .IntegratedSecurity = True
                        End If
                    End With
                    Dim tbLogOnInfo As New TableLogOnInfo
                    For Each dt As Table In crpt.Database.Tables
                        tbLogOnInfo = dt.LogOnInfo
                        tbLogOnInfo.ConnectionInfo = ConnectionInfo
                        dt.ApplyLogOnInfo(tbLogOnInfo)
                    Next
                    crpt.RecordSelectionFormula = "{ReceivingMasterTable.ReceivingId}=" & VoucherId


                    Dim crExportOps As New ExportOptions
                    Dim crDiskOps As New DiskFileDestinationOptions
                    Dim crExportType As New PdfRtfWordFormatOptions


                    If Not IO.Directory.Exists(str_ApplicationStartUpPath & "\EmailAttachments\") Then
                        IO.Directory.CreateDirectory(str_ApplicationStartUpPath & "\EmailAttachments\")
                    Else
                    End If
                    FileName = String.Empty
                    FileName = "Purchase Invoice" & "-" & setVoucherNo & ""
                    SourceFile = String.Empty
                    SourceFile = _FileExportPath & "\" & FileName & ".pdf"
                    crDiskOps.DiskFileName = SourceFile
                    crExportOps = crpt.ExportOptions
                    With crExportOps
                        .ExportDestinationType = CrystalDecisions.Shared.ExportDestinationType.DiskFile
                        .ExportFormatType = CrystalDecisions.Shared.ExportFormatType.PortableDocFormat
                        .ExportDestinationOptions = crDiskOps
                        .ExportFormatOptions = crExportType
                    End With
                    crpt.Refresh()
                    Try
                        crpt.SetParameterValue("@CompanyName", CompanyTitle)
                        crpt.SetParameterValue("@CompanyAddress", CompanyAddHeader)
                        crpt.SetParameterValue("@ShowHeader", IsCompanyInfo)
                    Catch ex As Exception
                        'IsCompanyInfo = False
                        'CompanyTitle = String.Empty
                        'CompanyAddHeader = String.Empty
                    End Try
                    crpt.Export(crExportOps)
                    'crpt.Close()
                    'crpt.Dispose()
                End If
            End If
        Catch ex As Exception

        End Try
    End Sub

    Private Sub BackgroundWorker1_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs) Handles BackgroundWorker1.DoWork
        Try
            EmailSave()
        Catch ex As Exception

        End Try
    End Sub

    Private Sub BackgroundWorker2_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs) Handles BackgroundWorker2.DoWork
        Try
            ExportFile(getVoucher_Id)
        Catch ex As Exception

        End Try
    End Sub

    Private Sub txtRemarks_Validating(ByVal sender As System.Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txtRemarks.Validating
        Try
            SpellChecker(Me.txtRemarks)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub CtrlGrdBar2_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CtrlGrdBar2.Load
        Try
            If IO.File.Exists(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name) Then
                Dim fs As New IO.FileStream(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name, IO.FileMode.Open, IO.FileAccess.ReadWrite)
                Me.grdSaved.LoadLayoutFile(fs)
                fs.Close()
                fs.Dispose()
            End If
            Me.CtrlGrdBar2.txtGridTitle.Text = CompanyTitle & Chr(10) & "Purchase New"
            'CtrlGrdBar.strForm_Name = CtrlGrdBar.EnmAccountType.Vendors
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Function chkDateLock(ByVal DateLock As SBModel.DateLockBE) As Boolean
        Try
            If DateLock.DateLock.ToString("yyyy-M-d 00:00:00") = Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") Then
                If DateLock.Lock = True Then
                    Return True
                End If
            End If
        Catch ex As Exception

        End Try
    End Function
    Public Sub ValidateDateLock()
        Try

            Dim dateLock As New SBModel.DateLockBE
            dateLock = DateLockList.Find(AddressOf chkDateLock)
            If dateLock IsNot Nothing Then
                If dateLock.DateLock.ToString.Length > 0 Then
                    flgDateLock = True
                Else
                    flgDateLock = False
                End If
            Else
                flgDateLock = False
            End If
        Catch ex As Exception

        End Try
    End Sub
    Private Sub txtPackQty_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtPackQty.TextChanged
        Try
            'If Me.txtPackRate.Text.Length > 0 AndAlso (Me.txtPackRate.Text) > 0 Then
            '    If Me.cmbUnit.Text <> "Loose" Then
            '        Me.txtRate.Text = ((Val(Me.txtPackRate.Text)) / Val(Me.txtPackQty.Text))
            '    End If
            'End If
            If Me.txtPackRate.Text.Length > 0 AndAlso Val(Me.txtPackRate.Text) > 0 Then
                If Me.cmbUnit.Text <> "Loose" Then
                    Me.txtRate.Text = ((Val(Me.txtPackRate.Text)) / Val(Me.txtPackQty.Text))

                Else

                    Me.txtRate.Text = Val(Me.txtRate.Text)

                End If
            End If
            If Val(Me.txtPackQty.Text) > 0 Then
                Me.txtTotalQuantity.Text = Math.Round(Val(Me.txtPackQty.Text) * Val(Me.txtQty.Text), TotalAmountRounding)
            Else
                Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtPackRate_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtPackRate.LostFocus
        Try
            If Val(Me.txtPackQty.Text) = 0 Then
                txtPackQty.Text = 1
                txtTotal.Text = Math.Round(Val(txtQty.Text) * Val(txtRate.Text), TotalAmountRounding)
            Else
                txtTotal.Text = Math.Round(Val(txtQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text), TotalAmountRounding)
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtPackRate_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtPackRate.TextChanged
        Try
            If Val(Me.txtPackRate.Text) > 0 Then
                If getConfigValueByType("Apply40KgRate").ToString = "True" AndAlso Me.cmbUnit.Text <> "Loose" Then
                    Me.txtRate.Text = (Val(Me.txtPackRate.Text) / 40)
                ElseIf Me.cmbUnit.Text <> "Loose" Then
                    Me.txtRate.Text = (Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text))
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtQty_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtQty.TextChanged
        Try
            'If Me.txtPackRate.Text.Length > 0 AndAlso (Me.txtPackRate.Text) > 0 Then
            '    If Me.cmbUnit.Text <> "Loose" Then
            '        Me.txtRate.Text = ((Val(Me.txtPackRate.Text)) / Val(Me.txtPackQty.Text))
            '    End If
            'End If
            ''TASK : TFS1357 Replaced Val() function with Convert.ToDecimal to retain last zero after points. Ameen on 22-08-2017
            If Val(Me.txtPackQty.Text) > 0 AndAlso Me.txtQty.Text <> "" Then
                Me.txtTotalQuantity.Text = Math.Round(Convert.ToDecimal(Me.txtPackQty.Text) * Convert.ToDecimal(Me.txtQty.Text), TotalAmountRounding)
            ElseIf Me.txtQty.Text <> "" Then
                Me.txtTotalQuantity.Text = Convert.ToDecimal(Me.txtQty.Text)
            End If
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub txtDiscount_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtDiscount.LostFocus
    '    Try
    '        'If Me.grd.RowCount = 0 Then Exit Sub
    '        'If Not IsInputNumeric(Me.txtDiscount.Text.ToString) Then ShowErrorMessage("Amount format incorrect.") : Exit Sub
    '        'Dim dblTotalAmount As Double = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)
    '        'For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
    '        '    r.BeginEdit()
    '        '    If Val(r.Cells("Qty").Value) <> 0 AndAlso Val(r.Cells("Rate").Value) <> 0 Then
    '        '        r.Cells("Discount_Price").Value = (Math.Round((((Val(r.Cells(grdEnm.Total).Value) / dblTotalAmount)) * Val(Me.txtDiscount.Text)) / IIf(r.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(r.Cells(grdEnm.Qty).Value), (Val(r.Cells(grdEnm.Qty).Value) * Val(r.Cells(grdEnm.PackQty).Value))), 2))
    '        '    Else
    '        '        r.Cells("Discount_Price").Value = 0
    '        '    End If
    '        '    r.EndEdit()
    '        'Next
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Private Sub cmbItem_RowSelected(ByVal sender As Object, ByVal e As Infragistics.Win.UltraWinGrid.RowSelectedEventArgs) Handles cmbItem.RowSelected
        Try
            If Me.cmbItem.IsItemInList = False Then Exit Sub
            'If Me.cmbItem.Value Is Nothing Then Exit Sub
            If Me.cmbItem.ActiveRow Is Nothing Then Exit Sub
            FillCombo("ArticlePack")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''ReqId-970 Added Event
    Private Sub btnReceivingNote_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnReceivingNote.Click
        Try
            If Me.grd.RowCount > 0 AndAlso ReceivingId = 0 AndAlso IsGRNStockImpacted = True Then
                msg_Error("Please remove existing  record from grid first. Then load a GRN")
                Exit Sub
            End If
            Dim frm As New frmLoadReceivingNotes()
            frm.ShowDialog()


            'ApplyStyleSheet(frmReceivingNoteList)
            'If frmReceivingNoteList.ShowDialog = Windows.Forms.DialogResult.Yes Then 'Open Receiving Note List Form
            '    drReceivingNote = CType(frmReceivingNoteList.cmbReceiving.SelectedItem, DataRowView) ' Return Selected Row 
            '    If drReceivingNote IsNot Nothing Then 'Check Row Is Nothing

            '        Me.txtDcNo.Text = drReceivingNote(enmReceivingNote.DcNo).ToString
            '        If IsDBNull(drReceivingNote(enmReceivingNote.DcDate)) Then
            '            Me.dtpDcDate.Value = Now
            '        Else
            '            Me.dtpDcDate.Value = drReceivingNote(enmReceivingNote.DcDate)
            '        End If
            '        Me.txtGRNNo.Text = drReceivingNote(enmReceivingNote.ReceivingNo).ToString
            '        Me.cmbProject.SelectedValue = Val(drReceivingNote(enmReceivingNote.CostCenterId).ToString)
            '        Me.txtRemarks.Text = drReceivingNote(enmReceivingNote.Remarks).ToString
            '        Me.txtVhNo.Text = drReceivingNote(enmReceivingNote.Vehicle_No).ToString
            '        Me.txtDriverName.Text = drReceivingNote(enmReceivingNote.Driver_Name).ToString
            '        Me.txtIGPNo.Text = drReceivingNote(enmReceivingNote.IGPNo).ToString
            '        'Me.cmbCurrency.Text = drReceivingNote(enmReceivingNote.CurrencyType).ToString
            '        'Me.txtCurrencyRate.Text = Val(drReceivingNote(enmReceivingNote.CurrencyRate).ToString)
            '        Me.cmbTransportationVendor.Value = Val(drReceivingNote(enmReceivingNote.Transportation_Vendor).ToString)
            '        If Not IsDBNull(drReceivingNote(enmReceivingNote.Arrival_Time)) Then
            '            Me.dtpArrivalTime.Value = drReceivingNote(enmReceivingNote.Arrival_Time)
            '        Else
            '            Me.dtpArrivalTime.Value = Date.Now
            '        End If
            '        If Not IsDBNull(drReceivingNote(enmReceivingNote.Departure_Time)) Then
            '            Me.dtpDepartureTime.Value = drReceivingNote(enmReceivingNote.Departure_Time)
            '            Me.dtpDepartureTime.Checked = True
            '        Else
            '            Me.dtpDepartureTime.Value = Date.Now
            '            Me.dtpDepartureTime.Checked = False
            '        End If
            '        Me.flgMultiGRN = frmReceivingNoteList.flgMultiGRN

            '        DisplayDetailByReceingNo(drReceivingNote(0)) 'Call Detail Record method

            '    End If
            '    ''TFS1391 This event should be called in case Multi GRNs is on
            '    If Me.flgMultiGRN = True Then
            '        btnReceivingNote_Click(Nothing, Nothing)
            '    End If
            'End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try

    End Sub
    ''R:972 Added Print Event
    Private Sub ReceivedToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ReceivedToolStripMenuItem.Click
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            AddRptParam("@ReceivingId", Me.grdSaved.GetRow.Cells(6).Value)
            ShowReport("rptGoodReceived", , , , , , , , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'R:972 Added Print Event
    Private Sub GoodReceivedToolStripMenuItem_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles GoodReceivedToolStripMenuItem.Click
        Try
            ReceivedToolStripMenuItem_Click(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
    Private Sub txtTotal_Leave(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtTotal.Leave, txtTotal.MouseLeave
        Try
            ''Commented against task:2367
            'Dim dbl As Double = 0D
            'If Val(Me.txtQty.Text) > 0 And Val(Me.txtTotal.Text) Then
            '    dbl = Val(Me.txtTotal.Text) / Val(Me.txtQty.Text)
            '    Me.txtRate.Text = Math.Round(dbl, 2).ToString()
            'Else
            '    dbl = Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)
            '    Me.txtQty.Text = Math.Round(dbl, 2).ToString()
            'End If

            'Task:2367 Change Total
            'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtQty.Text) = 0 Then
            '    Me.txtQty.Text = Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)
            'End If

            'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtQty.Text) <> 0 AndAlso Val(Me.txtRate.Text) = 0 Then
            '    Me.txtRate.Text = Val(Me.txtTotal.Text) / Val(Me.txtQty.Text)
            'End If

            'If Val(Me.txtPackQty.Text) = 0 Then
            '    txtPackQty.Text = 1
            '    txtNetTotal.Text = Math.Round((Val(txtQty.Text) * Val(txtRate.Text)) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
            'Else
            '    txtNetTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
            'End If
            'End Task:2367
            ''Below line is commened against TASK TFS4546 on 18-09-2018
            'GetDetailTotal()
            ''Below lines of code are added against TASK TFS4546 ON 18-09-2018

            If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
                Me.txtCurrentRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)
            End If
            If Val(txtCurrentRate.Text) = 0 Then
                If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
                    Me.txtCurrentRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)
                End If
            End If
            Dim dblTaxPercent As Double = 0D
            Double.TryParse(Me.txtTax.Text, dblTaxPercent)
            Me.txtNetTotal.Text = Math.Round((((dblTaxPercent / 100) * Val(Me.txtTotal.Text)) + Val(Me.txtTotal.Text)), TotalAmountRounding)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    '''''''''''''''''''''''''''''''''''''''''''''''

    ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
    'Private Sub txtTax_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtTax.Leave
    '    Try
    '        If Val(Me.txtTax.Text) > 0 Then
    '            taxamnt = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
    '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + taxamnt
    '        ElseIf Me.txtTax.Text = String.Empty Then
    '            taxamnt = 0D
    '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
    '        Else
    '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    '''''''''''''''''''''''''''''''''''''''''''

    ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
    Private Sub txtTax_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtTax.LostFocus
        Try
            'If Val(Me.txtTax.Text) > 0 Then
            '    Me.txtNetTotal.Text = Math.Round(Val(Me.txtTotal.Text) + ((Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
            'Else
            '    Me.txtNetTotal.Text = Math.Round(Val(Me.txtTotal.Text), DecimalPointInValue)
            'End If
            'GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''''''''''''''''''''''''''''''''''''''''''''''''''
    ''R:979 Added Event DoWork (Set Configurations)
    Private Sub bwLoading_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs) Handles bwLoading.DoWork
        Try

            If Not getConfigValueByType("PurchaseDebitAccount").ToString = "Error" Then
                AccountId = getConfigValueByType("PurchaseDebitAccount")
            End If

            If Not getConfigValueByType("AvgRate").ToString = "Error" Then
                flgAvgRate = getConfigValueByType("AvgRate")
            End If

            If Not getConfigValueByType("PurchaseTaxDebitAccountId").ToString = "Error" Then
                PurchaseTaxAccountId = getConfigValueByType("PurchaseTaxDebitAccountId")
            End If

            If Not getConfigValueByType("CompanyRights").ToString = "Error" Then
                flgCompanyRights = getConfigValueByType("CompanyRights")
            End If

            If Not getConfigValueByType("CurrencyonOpenLC").ToString = "Error" Then
                flgCurrenyonOpenLC = Convert.ToBoolean(getConfigValueByType("CurrencyonOpenLC").ToString)
            End If

            If Not getConfigValueByType("TransaportationChargesVoucher").ToString = "Error" Then
                flgTransaportationChargesVoucher = getConfigValueByType("TransaportationChargesVoucher")
            End If

            'Dim GLAccountArticleDepartment As Boolean 'Task:2612 Commented line
            If Not getConfigValueByType("GLAccountArticleDepartment").ToString = "Error" Then
                GLAccountArticleDepartment = Convert.ToBoolean(getConfigValueByType("GLAccountArticleDepartment"))
            Else
                GLAccountArticleDepartment = False
            End If

            If Not getConfigValueByType("TransaportationChargesVoucher").ToString = "Error" Then
                flgTransaportationChargesVoucher = getConfigValueByType("TransaportationChargesVoucher")
            End If

            If Not getConfigValueByType("AutoLoadPO").ToString = "Error" Then
                flgAutoLoadPO = getConfigValueByType("AutoLoadPO")
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    '''''''''''''''''''''''''''' End R:979 ''''''''''''''''''''''''''''''''''
    'R:979 Added Load PO's Link Event
    Private Sub lnkLoadingPO_LinkClicked(ByVal sender As System.Object, ByVal e As System.Windows.Forms.LinkLabelLinkClickedEventArgs) Handles lnkLoadingPO.LinkClicked
        Try
            If Me.cmbPo.SelectedValue IsNot Nothing AndAlso Me.cmbPo.SelectedIndex > 0 Then
                Me.txtRemarks.Text = CType(Me.cmbPo.SelectedItem, DataRowView).Item("Remarks").ToString 'GetPurchaseRemarks(Me.cmbPo.SelectedValue).ToString
                Me.txtDcNo.Text = CType(Me.cmbPo.SelectedItem, DataRowView).Item("DcNo").ToString 'GetPODcNo(Me.cmbPo.SelectedValue).ToString
                Me.DisplayPODetail(Me.cmbPo.SelectedValue)
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''''''''''''''''''''''''''' End R:979 ''''''''''''''''''''''''''''''''''



    Private Sub grd_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)

        'R-974 Ehtisham ul Haq user friendly system modification on 8-1-14
        If e.KeyCode = Keys.F2 Then
            OpenToolStripButton_Click(Me.BtnEdit, Nothing)
            Exit Sub
        End If
        ''31-Jan-2014     Task:2404 Imran Delete Record Problem In Transaction Forms   
        'If e.KeyCode = Keys.Delete Then
        '    DeleteToolStripButton_Click(BtnDelete, Nothing)
        '    Exit Sub
        'End If

    End Sub
    ''Task:2376 Added Function Set Comments
    Public Function SetComments(ByVal GridExRow As Janus.Windows.GridEX.GridEXRow, Optional ByVal TotalQty As Double = 0) As String
        Try
            Dim Comments As String = String.Empty
            If GridExRow IsNot Nothing Then
                If flgCommentCustomerFormat = True Then
                    Comments += Me.cmbVendor.Text.Replace("'", "''") & ","
                End If
                If flgCommentArticleFormat = True Then
                    Comments += " " & GridExRow.Cells(grdEnm.Item).Value.ToString & ","
                End If
                If flgCommentArticleSizeFormat = True Then
                    Comments += " " & GridExRow.Cells(grdEnm.Size).Value.ToString & ","
                End If
                If flgCommentArticleColorFormat = True Then
                    Comments += " " & GridExRow.Cells(grdEnm.Color).Value.ToString & ","
                End If
                If flgCommentQtyFormat = True Then
                    'Comments += " " & IIf(GridExRow.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(GridExRow.Cells(grdEnm.Qty).Value.ToString), Val(GridExRow.Cells(grdEnm.Qty).Value.ToString) * Val(GridExRow.Cells(grdEnm.PackQty).Value.ToString))
                    'Comments += " " & IIf(GridExRow.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(GridExRow.Cells(grdEnm.Qty).Value.ToString), Val(GridExRow.Cells(grdEnm.Qty).Value.ToString * GridExRow.Cells(grdEnm.PackQty).Value.ToString))

                    If TotalQty > 0 Then
                        Comments += " " & TotalQty

                    Else
                        Comments += " " & IIf(GridExRow.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(GridExRow.Cells(grdEnm.Qty).Value.ToString), Val(GridExRow.Cells(grdEnm.Qty).Value.ToString * GridExRow.Cells(grdEnm.PackQty).Value.ToString))
                    End If

                End If
                If flgCommentPriceFormat = True AndAlso flgCommentQtyFormat = True Then
                    'Task No 2608 Update For Rounding Off Price
                    'Comments += " X " & Val(GridExRow.Cells(grdEnm.Price).Value.ToString) - Val(GridExRow.Cells(grdEnm.Discount_Price).Value.ToString)
                    Comments += " X " & Math.Round(Val(GridExRow.Cells(grdEnm.Price).Value.ToString) - Val(GridExRow.Cells(grdEnm.Discount_Price).Value.ToString), DecimalPointInValue)
                    'End Task
                ElseIf flgCommentPriceFormat = True Then
                    'Task No 2608 Updating The Rounding Off 
                    'Comments += " " & Val(GridExRow.Cells(grdEnm.Price).Value.ToString) - Val(GridExRow.Cells(grdEnm.Discount_Price).Value.ToString) & ","
                    Comments += " " & Math.Round(Val(GridExRow.Cells(grdEnm.Price).Value.ToString), DecimalPointInValue) - Math.Round(Val(GridExRow.Cells(grdEnm.Discount_Price).Value.ToString), DecimalPointInValue) & ","
                    'End Task
                End If
                If flgCommentRemarksFormat = True Then
                    If Me.txtRemarks.Text.Length > 0 Then Comments += " " & Me.txtRemarks.Text.Replace("'", "''") & ","
                End If
                'Task:2442 Added Comments Dc No And Invoice No
                If flgCommentDcNo = True Then
                    If Me.txtDcNo.Text.Length > 0 Then Comments += " Dc No:" & Me.txtDcNo.Text.ToString & ","
                End If
                If flgCommentInvoiceNo = True Then
                    If Me.txtInvoiceNo.Text.ToString.Length > 0 Then Comments += " Invoice No:" & Me.txtInvoiceNo.Text.ToString & ","
                End If
                'End Task:2442
            End If

            Comments += " " & GridExRow.Cells(grdEnm.Comments).Value.ToString
            Dim str As String = String.Empty

            If Comments.ToString.Trim.Length > 0 AndAlso Comments.Contains(",") Then str = Comments.Substring(Comments.LastIndexOf(","))
            If str.Length > 1 Then
                Comments = Comments
            Else
                If Comments.ToString.Trim.Length > 0 AndAlso Comments.Contains(",") Then Comments = Comments.Substring(0, Comments.LastIndexOf(",") - 1)
            End If

            Return Comments
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    'End Task:2376

    Private Sub BackgroundWorker3_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs) Handles BackgroundWorker3.DoWork
        Try

            ''Task:2376 Get Comments Configurations
            If Not getConfigValueByType("CommentCustomerFormat").ToString = "Error" Then
                flgCommentCustomerFormat = Convert.ToBoolean(getConfigValueByType("CommentCustomerFormat").ToString)
            Else
                flgCommentCustomerFormat = False
            End If
            If Not getConfigValueByType("CommentArticleFormat").ToString = "Error" Then
                flgCommentArticleFormat = Convert.ToBoolean(getConfigValueByType("CommentArticleFormat").ToString)
            Else
                flgCommentArticleFormat = False
            End If
            If Not getConfigValueByType("CommentArticleSizeFormat").ToString = "Error" Then
                flgCommentArticleSizeFormat = Convert.ToBoolean(getConfigValueByType("CommentArticleSizeFormat").ToString)
            Else
                flgCommentArticleSizeFormat = False
            End If
            If Not getConfigValueByType("CommentArticleColorFormat").ToString = "Error" Then
                flgCommentArticleColorFormat = Convert.ToBoolean(getConfigValueByType("CommentArticleColorFormat").ToString)
            Else
                flgCommentArticleColorFormat = False
            End If
            If Not getConfigValueByType("CommentQtyFormat").ToString = "Error" Then
                flgCommentQtyFormat = Convert.ToBoolean(getConfigValueByType("CommentQtyFormat").ToString)
            Else
                flgCommentQtyFormat = False
            End If
            If Not getConfigValueByType("CommentPriceFormat").ToString = "Error" Then
                flgCommentPriceFormat = Convert.ToBoolean(getConfigValueByType("CommentPriceFormat").ToString)
            Else
                flgCommentPriceFormat = False
            End If
            If Not getConfigValueByType("CommentRemarksFormat").ToString = "Error" Then
                flgCommentRemarksFormat = Convert.ToBoolean(getConfigValueByType("CommentRemarksFormat").ToString)
            Else
                flgCommentRemarksFormat = False
            End If
            'End Task:2376



            'Task:2442 Added Flag Comments DCNo And Invoice No
            If Not getConfigValueByType("CommentsDCNoOnPurchase").ToString = "Error" Then
                flgCommentDcNo = Convert.ToBoolean(getConfigValueByType("CommentsDCNoOnPurchase").ToString)
            Else
                flgCommentDcNo = False
            End If

            If Not getConfigValueByType("CommentsInvNoOnPurchase").ToString = "Error" Then
                flgCommentInvoiceNo = Convert.ToBoolean(getConfigValueByType("CommentsInvNoOnPurchase").ToString)
            Else
                flgCommentInvoiceNo = False
            End If
            'End Task:2442

            'Task:2790 Get Configuration PurchaseAccountFrontEnd
            If Not getConfigValueByType("PurchaseAccountFrontEnd").ToString = "Error" Then
                flgPurchaseAccountFrontEnd = getConfigValueByType("PurchaseAccountFrontEnd")
            End If
            'End Task:2790

            PaymentVoucherFlg = getConfigValueByType("PaymentVoucherOnPurchase").ToString 'Task:2384 Added Configuration
        Catch ex As Exception

        End Try
    End Sub

    Private Sub grdSaved_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles grdSaved.KeyDown
        'R-974 Ehtisham ul Haq user friendly system modification on 20-1-14
        If e.KeyCode = Keys.F2 Then
            OpenToolStripButton_Click(Nothing, Nothing)
            Exit Sub
        End If


        If e.KeyCode = Keys.Delete Then
            If Me.grdSaved.RowCount <= 0 Then Exit Sub
            DeleteToolStripButton_Click(Nothing, Nothing)
            Exit Sub
        End If
    End Sub
    'Task:2447 Validate Duplicate Batch No 
    Public Function CheckDuplicateIRNo() As Boolean
        Try
            If Me.grd.RowCount = 0 Then Return False
            For i As Int32 = 0 To Me.grd.RowCount - 1
                For j As Int32 = i + 1 To Me.grd.RowCount - 1
                    If Me.grd.GetRows(j).Cells("BatchNo").Value.ToString.Trim.Length > 1 AndAlso Me.grd.GetRows(j).Cells("BatchNo").Value.ToString.Trim <> "xxxx" Then
                        If Me.grd.GetRows(j).Cells("BatchNo").Value.ToString.Trim = Me.grd.GetRows(i).Cells("BatchNo").Value.ToString.Trim Then
                            Return True
                        End If
                    End If
                Next
            Next
            Return False
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    'End Task:2447
    ''07-Aug-2014 Task:2774 Imrna Ali Revised Invoice Based Aging Report (Ravi)
    Private Sub txtDueDays_KeyPress(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtDueDays.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2774

    Private Sub txtRecAmount_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs)
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Task:2791 Added Event for multi purchase invoice printing
    Private Sub SelectedPurchaseInvoiceToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles SelectedPurchaseInvoiceToolStripMenuItem.Click
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub ' in case not record exits
            If Me.grdSaved.GetCheckedRows Is Nothing Then Exit Sub 'in case un checked invoices
            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grdSaved.GetCheckedRows
                PrintLog = New SBModel.PrintLogBE 'Create object for printed status  update
                PrintLog.DocumentNo = r.Cells("ReceivingNo").Value.ToString
                PrintLog.UserName = LoginUserName
                PrintLog.PrintDateTime = Date.Now
                Call SBDal.PrintLogDAL.PrintLog(PrintLog) 'Called update function
                'Called function for direct print option
                AddRptParam("@ReceivingId", r.Cells("ReceivingId").Value)
                ShowReport("PurchaseInvoiceNew", , , , True)
            Next 'Next Invoice
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2791

    Private Sub btnUpdateAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnUpdateAll.Click
        Try
            blnUpdateAll = True
            Me.btnUpdateAll.Enabled = False
            Dim blnStatus As Boolean = False
            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grdSaved.GetCheckedRows
                Me.grdSaved.Row = r.Position
                DisplayDetail(-1)
                EditRecord()
                If Update_Record() = True Then
                    blnStatus = True
                Else
                    blnStatus = False
                End If
            Next
            If blnStatus = True Then msg_Information("Records update successful.") : Me.btnUpdateAll.Enabled = True : RefreshControls()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

#Region "SMS Template Setting"
    Public Function GetSMSParamters() As List(Of String)
        Try
            Dim str As New List(Of String)
            str.Add("@AccountCode")
            str.Add("@AccountTitle")
            str.Add("@DocumentNo")
            str.Add("@DocumentDate")
            str.Add("@OtherDocNo")
            str.Add("@Remarks")
            str.Add("@Amount")
            str.Add("@Quantity")
            str.Add("@RejectedQuantity")
            str.Add("@DCNo")
            str.Add("@SONo")
            str.Add("@InvParty")
            str.Add("@DetailInformation")
            str.Add("@CompanyName")
            str.Add("@SIRIUS")
            Return str
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Public Function GetSMSKey() As List(Of String)
        Try
            Dim str As New List(Of String)
            str.Add("Purchase Invoice")
            Return str
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub btnSMSTemplate_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSMSTemplate.Click
        Try
            Dim frmSMS As New frmSMSTemplate
            ApplyStyleSheet(frmSMS)
            frmSMS.cmbKey.DataSource = GetSMSKey()
            frmSMS.lstParameters.DataSource = GetSMSParamters()
            frmSMS.Show()
            frmSMS.BringToFront()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub SendSMS()
        Try
            '...................... Send SMS .............................
            If GetSMSConfig("SMS To Location On Purchase Invoice").Enable = True Then
                Dim strSMSBody As String = String.Empty
                Dim objData As DataTable = CType(Me.grd.DataSource, DataTable)
                Dim dt_Loc As DataTable = objData.DefaultView.ToTable("Default", True, "LocationId")
                Dim drData() As DataRow
                For j As Integer = 0 To dt_Loc.Rows.Count - 1
                    strSMSBody = String.Empty
                    strSMSBody += "Purchase Invoice, Doc No: " & Me.txtPONo.Text & ", Doc Date: " & Me.dtpPODate.Value.ToShortDateString & ", Supplier: " & Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString & ", Invoice No: " & Me.txtInvoiceNo.Text & ", Remarks:" & Me.txtRemarks.Text & ", "
                    drData = objData.Select("LocationId=" & dt_Loc.Rows(j).Item(0).ToString & "")
                    Dim dblTotalQty As Double = 0D
                    Dim dblTotalAmount As Double = 0D
                    For Each dr As DataRow In drData
                        dblTotalQty += IIf(dr(grdEnm.Unit).ToString = "Loose", Val(dr(grdEnm.Qty).ToString), Val(dr(grdEnm.Qty).ToString) * Val(dr(grdEnm.PackQty).ToString))
                        strSMSBody += " " & dr(grdEnm.Item).ToString & ", " & IIf(dr(grdEnm.Unit).ToString = "Loose", " " & dr(grdEnm.Qty).ToString & "", "" & (Val(dr(grdEnm.Qty)).ToString * Val(dr(grdEnm.PackQty)).ToString) & "") & ", "
                    Next
                    strSMSBody += " Total Qty: " & dblTotalQty & ""
                    Dim LocationPhone() As String = GetLocation(Val(dt_Loc.Rows(j).Item(0).ToString)).Mobile_No.Replace(",", ";").Replace("|", ";").Replace("\", ";").Replace("/", ";").Replace("^", ";").Replace("*", ";").Split(";")
                    If LocationPhone.Length > 0 Then
                        For Each strPhone As String In LocationPhone
                            If strPhone.Length > 0 Then
                                Try
                                    SaveSMSLog(strSMSBody, strPhone, "SMS to Location")
                                Catch ex As Exception
                                    Throw ex
                                End Try
                            End If
                        Next
                    End If
                Next
            End If
            If GetSMSConfig("Purchase Invoice").Enable = True Then
                If msg_Confirm(str_ConfirmSendSMSMessage) = False Then Exit Try
                Dim strDetailMessage As String = String.Empty
                For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    'If strDetailMessage.Length = 0 Then
                    '    strDetailMessage = r.Cells(grdEnm.Item).Value.ToString & ", Qty: " & IIf(r.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(r.Cells(grdEnm.Qty).Value.ToString), Val(r.Cells(grdEnm.Qty).Value.ToString) * Val(r.Cells(grdEnm.PackQty).Value.ToString))
                    'Else
                    '    strDetailMessage += "," & r.Cells(grdEnm.Item).Value.ToString & ", Qty: " & IIf(r.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(r.Cells(grdEnm.Qty).Value.ToString), Val(r.Cells(grdEnm.Qty).Value.ToString) * Val(r.Cells(grdEnm.PackQty).Value.ToString))
                    'End If
                    If strDetailMessage.Length = 0 Then
                        strDetailMessage = r.Cells(grdEnm.Item).Value.ToString & ", Rejected Qty: " & IIf(r.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(r.Cells(grdEnm.RejectedQty).Value.ToString), Val(r.Cells(grdEnm.RejectedQty).Value.ToString) * Val(r.Cells(grdEnm.PackQty).Value.ToString)) & ", Qty: " & IIf(r.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(r.Cells(grdEnm.Qty).Value.ToString), Val(r.Cells(grdEnm.Qty).Value.ToString) * Val(r.Cells(grdEnm.PackQty).Value.ToString))
                    Else
                        strDetailMessage += "," & r.Cells(grdEnm.Item).Value.ToString & ", Rejected Qty: " & IIf(r.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(r.Cells(grdEnm.RejectedQty).Value.ToString), Val(r.Cells(grdEnm.RejectedQty).Value.ToString) * Val(r.Cells(grdEnm.PackQty).Value.ToString)) & ", Qty: " & IIf(r.Cells(grdEnm.Unit).Value.ToString = "Loose", Val(r.Cells(grdEnm.Qty).Value.ToString), Val(r.Cells(grdEnm.Qty).Value.ToString) * Val(r.Cells(grdEnm.PackQty).Value.ToString))
                    End If
                Next
                Dim objTemp As New SMSTemplateParameter
                Dim obj As Object = GetSMSTemplate("Purchase Invoice")
                If obj IsNot Nothing Then
                    objTemp.SMSTemplate = CType(obj, SMSTemplateParameter).SMSTemplate
                    Dim strMessage As String = objTemp.SMSTemplate
                    strMessage = strMessage.Replace("@AccountTitle", Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString).Replace("@AccountCode", Me.cmbVendor.ActiveRow.Cells("Code").Value.ToString).Replace("@DocumentNo", Me.txtPONo.Text).Replace("@DocumentDate", Me.dtpPODate.Value.ToShortDateString).Replace("@OtherDoc", Me.txtDcNo.Text).Replace("@Remarks", Me.txtRemarks.Text).Replace("@Amount", grd.GetTotal(Me.grd.RootTable.Columns(grdEnm.TotalAmount), Janus.Windows.GridEX.AggregateFunction.Sum)).Replace("@Quantity", Me.grd.GetTotal(grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)).Replace("@DCNo", Me.txtDcNo.Text).Replace("@SONo", IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.Text, String.Empty)).Replace("@InvParty", Me.txtInvoiceNo.Text).Replace("@CompanyName", CompanyTitle).Replace("@SIRIUS", "Automated by www.SIRIUS.net").Replace("@RejectedQuantity", Me.grd.GetTotal(Me.grd.RootTable.Columns("RejectedQty"), Janus.Windows.GridEX.AggregateFunction.Sum)).Replace("@DetailInformation", strDetailMessage)
                    SaveSMSLog(strMessage, Me.cmbVendor.ActiveRow.Cells("Mobile").Value.ToString, "Purchase Invoice")

                    If GetSMSConfig("Purchase Invoice").EnabledAdmin = True Then
                        For Each strMob As String In strAdminMobileNo.Replace(",", ";").Replace("|", ";").Replace("^", ";").Split(";")
                            If strMob.Length > 10 Then
                                SaveSMSLog(strMessage, strMob, "Purchase Invoice")
                            End If
                        Next
                    End If
                End If
            End If

            '...................... End Send SMS ................
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
#End Region



    Public Sub New()

        ' This call is required by the Windows Form Designer.
        InitializeComponent()

        ' Add any initialization after the InitializeComponent() call.

    End Sub

    'Private Sub cmbInvoiceType_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbInvoiceType.SelectedIndexChanged
    '    Try
    '        'If Me.grd.RowCount = 0 Then Exit Sub
    '        If getConfigValueByType("PaymentVoucherOnPurchase").ToString = "True" Or Me.cmbInvoiceType.Text = "Cash" Then
    '            Me.GroupBox5.Visible = True
    '        Else
    '            Me.GroupBox5.Visible = False
    '        End If

    '        'If Me.cmbInvoiceType.Text = "Cash" Then
    '        '    Me.SplitContainer1.Panel2Collapsed = False
    '        'Else
    '        '    Me.SplitContainer1.Panel2Collapsed = True
    '        'End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Public Sub Isprint(Optional ByVal InvoiceId As Integer = 0)
        Try
            Me.Cursor = Cursors.WaitCursor
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            PrintLog = New SBModel.PrintLogBE
            PrintLog.DocumentNo = grdSaved.GetRow.Cells("ReceivingNo").Value.ToString
            PrintLog.UserName = LoginUserName
            PrintLog.PrintDateTime = Date.Now
            Call SBDal.PrintLogDAL.PrintLog(PrintLog)
            'ShowReport("PurchaseInvoicenew", "{ReceivingMasterTable.ReceivingId}=" & grdSaved.CurrentRow.Cells(6).Value, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            AddRptParam("@ReceivingId", IIf(InvoiceId = 0, grdSaved.CurrentRow.Cells("ReceivingID").Value, InvoiceId))
            ShowReport("PurchaseInvoiceNew", , , , False)

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    Private Sub btnAttachment_ButtonClick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAttachment.ButtonClick
        Try
            Dim intCountAttachedFiles As Integer = 0I
            OpenFileDialog1.FileName = String.Empty
            'Marked Against Task#2015060005 
            'OpenFileDialog1.Filter = "All Images|*.BMP;*.DIB;*.RLE;*.JPG;*.JPEG;*.JPE;*.JFIF;*.GIF;*.TIF;*.TIFF;*.PNG"
            'Marked Against Task#2015060005 

            '            OpenFileDialog1.Filter = "Word Documents|*.doc|Excel Worksheets|*.xls|Portable Document Format|*.pdf|Corel Draw|*.cdr|All Images|*.BMP;*.DIB;*.RLE;*.JPG;*.JPEG;*.JPE;*.JFIF;*.GIF;*.TIF;*.TIFF;*.PNG"
            'Altered Against Task#2015060006 to make all files attachement physible
            OpenFileDialog1.Filter = "Word Documents|*.doc|Excel Worksheets|*.xls|Portable Document Format|*.pdf|Corel Draw Files|*.cdr|All Images|*.BMP;*.DIB;*.RLE;*.JPG;*.JPEG;*.JPE;*.JFIF;*.GIF;*.TIF;*.TIFF;*.PNG|" + _
            "All files (*.*)|*.*"
            'Altered Against Task#2015060006 to make all files attachement physible
            If OpenFileDialog1.ShowDialog = Windows.Forms.DialogResult.OK Then
                'Altered Against Task#2015060001 Ali Ansari
                Dim a As Integer = 0I
                For a = 0 To OpenFileDialog1.FileNames.Length - 1
                    arrFile.Add(OpenFileDialog1.FileNames(a))
                Next a
                'Altered Against Task#2015060001 Ali Ansari

                If Me.BtnSave.Text <> "&Save" Then
                    If Me.grdSaved.RowCount > 0 Then
                        intCountAttachedFiles = Val(grdSaved.CurrentRow.Cells("No Of Attachment").Value)
                    End If
                End If


                'Marked Against Task#2015060001 Ali Ansari
                'Me.btnAttachment.Text = "Attachment (" & arrFile.Length + intCountAttachedFiles & ")"
                'Marked Against Task#2015060001 Ali Ansari
                'Altered Against Task#2015060001 Ali Ansari
                Me.btnAttachment.Text = "Attachment (" & arrFile.Count + intCountAttachedFiles & ")"
                'Altered Against Task#2015060001 Ali Ansari
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Function SaveDocument(ByVal DocId As Integer, ByVal Source As String, ByVal objTrans As OleDb.OleDbTransaction) As Boolean
        Dim cmd As New OleDbCommand
        cmd.Connection = objTrans.Connection
        cmd.Transaction = objTrans
        Try

            Dim dt As New DataTable
            dt = GetDataTable("Select DocId, Source, Path + '\' + FileName  as [FileNames]  From DocumentAttachment WHERE DocId=" & DocId & " AND Source=N'" & Source & "'", objTrans)
            dt.AcceptChanges()


            Dim objdt As New DataTable
            objdt = GetDataTable("Select IsNull(Count(*),0)+1 as Cont From DocumentAttachment WHERE DocId=" & DocId & " AND Source=N'" & Source & "'", objTrans)
            Dim intId As Integer = objdt.Rows(0)(0)

            Dim strSQL As String = String.Empty
            cmd.CommandText = String.Empty
            strSQL = "Delete From DocumentAttachment WHERE DocId=" & DocId & " AND Source=N'" & Source & "'"
            cmd.CommandText = strSQL
            cmd.ExecuteNonQuery()

            Dim objPath As String = getConfigValueByType("FileAttachmentPath").ToString
            'Altered Against Task#2015060001 Ali Ansari
            If arrFile.Count > 0 Then
                'Altered Against Task#2015060001 Ali Ansari
                'Marked Against Task#2015060001 Ali Ansari
                '            If arrFile.Length > 0 Then
                'Marked Against Task#2015060001 Ali Ansari
                For Each objFile As String In arrFile
                    If IO.File.Exists(objFile) Then
                        If IO.Directory.Exists(objPath) = False Then
                            IO.Directory.CreateDirectory(objPath)
                        End If
                        Dim New_Files As String = intId & "_" & DocId & "_" & Me.dtpPODate.Value.ToString("yyyyMMdd") & "." & objFile.Substring(objFile.LastIndexOf(".") + 1)
                        Dim dr As DataRow
                        dr = dt.NewRow
                        dr(0) = DocId
                        dr(1) = Source
                        dr(2) = objPath & "\" & New_Files
                        dt.Rows.Add(dr)
                        dt.AcceptChanges()
                        If IO.File.Exists(objPath & "\" & New_Files) Then
                            IO.File.Delete(objPath & "\" & New_Files)
                        End If
                        IO.File.Copy(objFile, objPath & "\" & New_Files)
                        intId += 1
                    End If
                Next
            End If


            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then
                    For Each r As DataRow In dt.Rows
                        Dim strPath As String = objPath
                        Dim strFileName As String = r.Item("FileNames").ToString.Substring(r.Item("FileNames").ToString.LastIndexOf("\") + 1)
                        cmd.CommandText = String.Empty
                        strSQL = "INSERT INTO DocumentAttachment(DocId, Source, FileName, Path) Values(" & Val(r("DocId").ToString) & ",N'" & r.Item("Source").ToString.Replace("'", "''") & "', N'" & strFileName.Replace("'", "''") & "', N'" & strPath.Replace("'", "''") & "')"
                        cmd.CommandText = strSQL
                        cmd.ExecuteNonQuery()
                    Next
                End If
            End If
          


        Catch ex As Exception
            objTrans.Rollback()
            Throw ex
        End Try
    End Function

    Private Sub grdSaved_LinkClicked(ByVal sender As Object, ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdSaved.LinkClicked, grd.LinkClicked
        Try
            If e.Column.Key = "No Of Attachment" Then
                Dim frm As New frmAttachmentView
                frm._Source = Me.Name
                frm._VoucherId = Val(Me.grdSaved.GetRow.Cells("ReceivingId").Value.ToString)
                frm.ShowDialog()
                Exit Sub
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    ''Task#A3 12-06-2015 Added Key Pres event for some textboxes to take just numeric and dot value
    'Task#05082015 add txtDisc textbox for only accept numbers as input (Ahmad Sharif)
    Private Sub txtNUM_KeyPress(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtCurrencyRate.KeyPress, txtPackRate.KeyPress, txtDiscount.KeyPress, txtPackQty.KeyPress, txtStock.KeyPress, txtQty.KeyPress, txtRate.KeyPress, txtTotal.KeyPress, txtTax.KeyPress, txtNetTotal.KeyPress, txtDisc.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''End Task#A3 12-06-2015

    'End Task#05082015 on lost focus from txtDisc textbox, calculate item wise discount (Ahmad Sharif)
    'Private Sub txtDisc_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtDiscPercent.LostFocus
    '    Try
    '        Dim disc As Double = 0D
    '        Double.TryParse(Me.txtDiscPercent.Text.Trim, disc)
    '        Dim price As Double = 0D
    '        Double.TryParse(Me.cmbItem.ActiveRow.Cells("Price").Value.ToString, price)
    '        If Val(disc) <> 0 AndAlso Val(price) <> 0 Then
    '            Me.txtRate.Text = price - ((price / 100) * disc)
    '        Else
    '            Me.txtRate.Text = Me.txtRate.Text
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    'End Task#05082015

    Protected Overrides Sub Finalize()
        MyBase.Finalize()
    End Sub

    Private Sub btnAddExp_Click(sender As Object, e As EventArgs) Handles btnAddExp.Click
        Try

            If Me.cmbInwardExpense.IsItemInList = False Then Exit Sub
            If Me.cmbInwardExpense.ActiveRow Is Nothing Then Exit Sub
            If Con Is Nothing Then Exit Sub
            If Me.grdInwardExpDetail.RowCount > 0 Then
                Dim bln As Boolean = Me.grdInwardExpDetail.Find(Me.grdInwardExpDetail.RootTable.Columns("AccountId"), Janus.Windows.GridEX.ConditionOperator.Equal, Me.cmbInwardExpense.Value, 0, 1)
                If bln = True Then
                    ShowErrorMessage("Account is already added")
                    Exit Sub
                End If
            End If
            Dim objcon As New OleDbConnection(Con.ConnectionString)
            Dim cmd As New OleDbCommand

            If objcon.State = ConnectionState.Closed Then objcon.Open()
            Dim objtrans As OleDbTransaction = objcon.BeginTransaction
            cmd.Connection = objcon
            cmd.Transaction = objtrans
            cmd.CommandType = CommandType.Text

            cmd.CommandText = String.Empty
            cmd.CommandText = "INSERT INTO tblDefInwardAccounts(InwardAccountId,Active) VALUES(" & Me.cmbInwardExpense.Value & ",1) Select @@Identity"

            cmd.ExecuteNonQuery()
            objtrans.Commit()

            objcon.Close()
            objtrans.Dispose()
            objcon.Dispose()

            Dim dt As DataTable = CType(Me.grdInwardExpDetail.DataSource, DataTable)
            dt.AcceptChanges()
            Dim dr As DataRow
            dr = dt.NewRow
            If Me.BtnSave.Text <> "&Save" Then
                dr(0) = Val(Me.grdSaved.GetRow.Cells("ReceivingId").Value.ToString)
            Else
                dr(0) = 0
            End If
            dr(1) = Me.cmbInwardExpense.Value
            dr(2) = Me.cmbInwardExpense.ActiveRow.Cells("Account Title").Value.ToString
            dr(3) = 0
            dr(4) = 0
            dt.Rows.Add(dr)
            dt.AcceptChanges()


        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub grdInwardExpDetail_CellUpdated(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdInwardExpDetail.CellUpdated
        Try
            Me.grdInwardExpDetail.UpdateData()
            If Me.grdInwardExpDetail.RootTable.Columns(e.Column.Index).DataMember.ToString = "Debit" Then
                If Val(Me.grdInwardExpDetail.GetRow.Cells("Credit").Value.ToString) > 0 Then
                    Me.grdInwardExpDetail.GetRow.Cells("Credit").Value = 0
                End If
            End If

            If Me.grdInwardExpDetail.RootTable.Columns(e.Column.Index).DataMember.ToString = "Credit" Then
                If Val(Me.grdInwardExpDetail.GetRow.Cells("Debit").Value.ToString) > 0 Then
                    Me.grdInwardExpDetail.GetRow.Cells("Debit").Value = 0
                End If
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub grdInwardExpDetail_ColumnButtonClick(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdInwardExpDetail.ColumnButtonClick
        Try

            If Not IsValidToDeleteAccount() Then
                ShowErrorMessage("Dependent Record Exist Against This Account ,Can't be deleted")
                Exit Sub
            End If
            Dim objcon As New OleDbConnection(Con.ConnectionString)
            Dim cmd As New OleDbCommand

            If objcon.State = ConnectionState.Closed Then objcon.Open()
            Dim objtrans As OleDbTransaction = objcon.BeginTransaction
            cmd.Connection = objcon
            cmd.Transaction = objtrans
            cmd.CommandType = CommandType.Text

            cmd.CommandText = String.Empty
            cmd.CommandText = "Delete From tblDefInwardAccounts  WHERE InwardAccountId=" & Val(grdInwardExpDetail.GetRow.Cells("AccountId").Value.ToString) & ""

            cmd.ExecuteNonQuery()
            objtrans.Commit()

            objcon.Close()
            objtrans.Dispose()
            objcon.Dispose()

            Me.grdInwardExpDetail.GetRow.Delete()


        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''' <summary>
    ''' Thsi Function is made to insure that ,dependent accounts cannot be deleted
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks>Ayesha Rehman : 02-05-2018 : TFS3142</remarks>
    Private Function IsValidToDeleteAccount() As Boolean
        Try
            Dim str As String = "Select AccountId from InwardExpenseDetailTable where DocType !='PUR' "
            Dim dt As DataTable = GetDataTable(str)
            If dt.Rows.Count > 0 Then
                For Each r As DataRow In dt.Rows
                    If Val(grdInwardExpDetail.GetRow.Cells("AccountId").Value.ToString) = Val(r.Item("AccountId").ToString) Then
                        Return False
                    End If
                Next
            End If
            Return True
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Function

    Protected Sub UpdateInwardExpense(ReceivingId As Integer, objtrans As OleDbTransaction)
        Dim cmd As New OleDbCommand
        cmd.Connection = objtrans.Connection
        cmd.Transaction = objtrans
        cmd.CommandType = CommandType.Text

        Try
            Dim Str As String = String.Empty
            Str = "Update ReceivingMasterTable set TotalInwardExpense = 0 Where ReceivingId= " & ReceivingId & ""
            cmd.CommandText = Str
            cmd.ExecuteNonQuery()
            Dim strSQL As String = String.Empty
            strSQL = "if exists(Select * from information_schema.tables where table_name='InwardExpenseDetailTable') " _
                   & " Update ReceivingMasterTable SET TotalInwardExpense= IsNull(a.Exp_Amount,0) From ReceivingMasterTable," _
                   & " (Select PurchaseId, ISNull(SUM(Exp_Amount),0) as Exp_Amount From InwardExpenseDetailTable WHERE DocType='PUR' AND PurchaseId=" & ReceivingId & " Group By PurchaseId) a WHERE a.PurchaseId = ReceivingMasterTable.ReceivingId AND ReceivingMasterTable.ReceivingId=" & ReceivingId & ""
            cmd.CommandText = strSQL
            cmd.ExecuteNonQuery()


        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Public Sub UpdatePOStatus(ReceivingId As Integer, trans As OleDbTransaction, Optional Status As String = "")
        Dim objCommand As New OleDbCommand
        Try
            objCommand.Connection = trans.Connection
            objCommand.Transaction = trans
            objCommand.CommandTimeout = 300
            objCommand.CommandType = CommandType.Text

            objCommand.CommandText = ""
            objCommand.CommandText = "Update PurchaseOrderDetailTable Set DeliveredQty=IsNull(DeliveredQty,0)  " & IIf(Status = "", "+", "-") & "  IsNull(GRN_D.Sz1,0), ReceivedTotalQty=IsNull(PurchaseOrderDetailTable.ReceivedTotalQty,0)  " & IIf(Status = "", "+", "-") & "  IsNull(GRN_D.Qty,0) From PurchaseOrderDetailTable, ReceivingDetailTable  GRN_D, ReceivingMasterTable GRN WHERE GRN.ReceivingId=" & ReceivingId & " AND  GRN.ReceivingId = GRN_D.ReceivingId " ''TASK-408 Updated ReceivedTotalQty also 
            objCommand.CommandText += " AND GRN_D.ArticleDefId = PurchaseOrderDetailTable.ArticleDefId"
            objCommand.CommandText += " AND GRN.PurchaseOrderID = PurchaseOrderDetailTable.PurchaseOrderId "
            objCommand.CommandText += " AND GRN_D.PurchaseOrderDetailId = PurchaseOrderDetailTable.PurchaseOrderDetailId"

            objCommand.ExecuteNonQuery()
            objCommand.CommandText = ""
            objCommand.CommandText = "Update PurchaseOrderMasterTable Set Status=Case When IsNull(PO_D.RemainingQty,0) > 0 then 'Open' ELSE 'Close' END From PurchaseOrderMasterTable, (Select PurchaseOrderId, IsNull(SUM(IsNull(Sz1,0)-IsNull(DeliveredQty,0)),0) as RemainingQty From PurchaseOrderDetailTable WHERE PurchaseOrderId=" & Me.cmbPo.SelectedValue & " Group By PurchaseOrderId ) PO_D WHERE PO_D.PurchaseOrderID = PurchaseOrderMasterTable.PurchaseOrderId AND PurchaseOrderMasterTable.PurchaseOrderId=" & Me.cmbPo.SelectedValue & ""

        Catch ex As Exception
            trans.Rollback()
            Throw ex
        End Try
    End Sub

    Private Sub txtTaxDeductAmount_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtTaxDeductPercent.KeyPress, txtTaxDeductAmount.KeyPress
        Try

            NumValidation(sender, e)

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtTaxDeductPercent_TextChanged(sender As Object, e As EventArgs) Handles txtTaxDeductPercent.TextChanged
        Try
            If Me.grd.RowCount = 0 Then
                Me.txtTaxDeductAmount.Text = 0
            Else
                Dim dblTax As Double = Me.grd.GetTotal(Me.grd.RootTable.Columns(grdEnm.TaxAmount), Janus.Windows.GridEX.AggregateFunction.Sum)
                Dim lngTaxPercent As Long = Val(Me.txtTaxDeductPercent.Text)
                If lngTaxPercent > 0 Then
                    Me.txtTaxDeductAmount.Text = Math.Round((lngTaxPercent / 100) * dblTax, TotalAmountRounding)
                Else
                    Me.txtTaxDeductAmount.Text = 0
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub GetDiscountedPrice()
        Try

            Me.grd.UpdateData()
            Dim dblCurrentRate As Double = 0D
            Dim dblDiscPercent As Double = 0D
            Dim dblActualPrice As Double = 0D

            dblCurrentRate = Val(Me.grd.GetRow.Cells(grdEnm.CurrentPrice).Value.ToString)
            dblDiscPercent = Val(Me.grd.GetRow.Cells(grdEnm.RateDiscPercent).Value.ToString)
            If dblDiscPercent > 0 Then
                If dblCurrentRate > 0 Then
                    dblActualPrice = Val(dblDiscPercent / 100) * dblCurrentRate
                    Me.grd.GetRow.Cells(grdEnm.Price).Value = dblCurrentRate - dblActualPrice
                Else
                    dblActualPrice = Val(Me.grd.GetRow.Cells(grdEnm.Price).Value.ToString)
                    Me.grd.GetRow.Cells(grdEnm.Price).Value = dblActualPrice
                    Me.grd.GetRow.Cells(grdEnm.RateDiscPercent).Value = 0
                End If
            Else
                If Val(Me.grd.GetRow.Cells(grdEnm.CurrentPrice).Value.ToString) > Val(Me.grd.GetRow.Cells(grdEnm.Price).Value.ToString) Then
                    dblActualPrice = Val(Me.grd.GetRow.Cells(grdEnm.CurrentPrice).Value.ToString)
                    Me.grd.GetRow.Cells(grdEnm.Price).Value = dblActualPrice
                Else
                    dblActualPrice = Val(Me.grd.GetRow.Cells(grdEnm.Price).Value.ToString)
                    Me.grd.GetRow.Cells(grdEnm.Price).Value = dblActualPrice
                End If
            End If

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub txtCurrentRate_KeyDown(sender As Object, e As KeyEventArgs) Handles txtCurrentRate.KeyDown
        Try
            If e.KeyCode = Keys.F1 Then
                frmRateConversion.formname = Me.Name
                frmRateConversion.ShowDialog()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtCurrentRate_TextChanged(sender As Object, e As EventArgs) Handles txtCurrentRate.TextChanged
        Try
            If Val(Me.txtCurrentRate.Text) > 0 Then
                If Val(Me.txtDisc.Text) > 0 Then
                    Me.txtRate.Text = Math.Round(Val(Me.txtCurrentRate.Text) - ((Val(Me.txtDisc.Text) / 100) * Val(Me.txtCurrentRate.Text)), TotalAmountRounding)
                Else
                    Me.txtRate.Text = Val(Me.txtCurrentRate.Text)
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtDiscPercent_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtDisc.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub grd_Error(sender As Object, e As Janus.Windows.GridEX.ErrorEventArgs) Handles grd.Error
        Try
            e.DisplayErrorMessage = False
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub GetDetailTotal()
        Try
            'If Val(Me.txtPackRate.Text) > 0 Then
            '    If getConfigValueByType("Apply40KgRate").ToString = "True" AndAlso Me.cmbUnit.Text <> "Loose" Then
            '        Me.txtRate.Text = (Val(Me.txtPackRate.Text) / 40)
            '    ElseIf Me.cmbUnit.Text <> "Loose" Then
            '        Me.txtRate.Text = (Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text))
            '    End If
            'End If

            If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtTotal.Text) = 0 Then
                Me.txtTotal.Text = Math.Round((Val(Me.txtTotalQuantity.Text) * Val(Me.txtRate.Text)), TotalAmountRounding)
                Total = Val(Me.txtTotal.Text)
            End If

            ''Below line is commented against TASK TFS4546 on 18-09-2018
            If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtRate.Text) = 0 Then
                'If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
                ''Below line is commented against TASK TFS4546 on 18-09-2018
                Me.txtRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)
                'Me.txtCurrentRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)

            End If
            'If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '    'If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '    ''Below line is commented against TASK TFS4546 on 18-09-2018
            '    Me.txtCurrentRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)
            '    'Me.txtCurrentRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)

            'End If
            If Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtTotalQuantity.Text) = 0 Then
                If Not Me.cmbUnit.Text <> "Loose" Then
                    Me.txtQty.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtRate.Text), TotalAmountRounding)
                    Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
                Else
                    If Val(Me.txtPackQty.Text) > 0 Then
                        Me.txtQty.Text = Math.Round((Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)) / Val(Me.txtPackQty.Text), TotalAmountRounding)
                        Me.txtTotalQuantity.Text = Math.Round((Val(Me.txtQty.Text) * Val(Me.txtPackQty.Text)), TotalAmountRounding)
                    Else
                        Me.txtQty.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtRate.Text), TotalAmountRounding)
                        Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
                    End If
                End If
            Else
                Me.txtTotal.Text = Math.Round(Val(Me.txtTotalQuantity.Text) * Val(Me.txtRate.Text), TotalAmountRounding)     'Task#26082015
                Total = Val(Me.txtTotal.Text)
            End If

            Dim dblTaxPercent As Double = 0D
            Double.TryParse(Me.txtTax.Text, dblTaxPercent)
            Me.txtNetTotal.Text = Math.Round((((dblTaxPercent / 100) * Val(Me.txtTotal.Text)) + Val(Me.txtTotal.Text)), TotalAmountRounding)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub txtTotalQuantity_LostFocus(sender As Object, e As EventArgs) Handles txtTotalQuantity.LostFocus
        Me.GetDetailTotal()
    End Sub

    Private Sub txtTotalQuantity_TextChanged(sender As Object, e As EventArgs) Handles txtTotalQuantity.TextChanged
        Try
            If Not Val(Me.txtPackQty.Text) > 0 Then
                Me.txtQty.Text = Val(Me.txtTotalQuantity.Text)
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub txtDisc_LostFocus(sender As Object, e As EventArgs) Handles txtDisc.LostFocus
        Dim disc As Double = 0D
        Double.TryParse(Me.txtDisc.Text.Trim, disc)
        Dim price As Double = 0D
        'Double.TryParse(Me.cmbItem.ActiveRow.Cells("Price").Value.ToString, price)
        Double.TryParse(Me.txtCurrentRate.Text, price)

        If Val(disc) <> 0 AndAlso Val(price) <> 0 Then
            If disc > 0 Then
                Me.txtRate.Text = price - ((price / 100) * disc)
            End If
        Else
            Me.txtRate.Text = txtRate.Text
        End If
    End Sub

    Private Sub txtDisc_TextChanged(sender As Object, e As EventArgs) Handles txtDisc.TextChanged
        Try
            If Val(Me.txtDisc.Text) > 0 Then
                If Val(Me.txtCurrentRate.Text) > 0 Then
                    Me.txtRate.Text = Math.Round(Val(Me.txtCurrentRate.Text) - (Val(txtDisc.Text) / 100) * Val(Me.txtCurrentRate.Text), TotalAmountRounding)
                Else
                    Me.txtRate.Text = Val(Me.txtCurrentRate.Text)
                End If
            Else
                Me.txtRate.Text = Val(Me.txtCurrentRate.Text)
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub txtTotal_LostFocus(sender As Object, e As EventArgs) Handles txtTotal.LostFocus
        If Me.cmbItem.ActiveRow Is Nothing Then Exit Sub
        If Not Me.cmbItem.ActiveRow.Cells(0).Value > 0 Or Me.cmbItem.ActiveRow Is Nothing Then Exit Sub
        'GetDetailTotal()
    End Sub
    Public Sub GetGridDetailQtyCalculate(ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs)
        Try
            Me.grd.UpdateData()
            ''Or e.Column.Index = grdEnm.Column1 Or e.Column.Index = grdEnm.Column2 Or e.Column.Index = grdEnm.Column3)
            If (e.Column.Index = grdEnm.ReceivedQty Or e.Column.Index = grdEnm.RejectedQty Or e.Column.Index = grdEnm.Qty Or e.Column.Index = grdEnm.PackQty) Then
                Me.grd.GetRow.Cells(grdEnm.GrossQty).Value = (IIf(Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString) = 0 Or Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString) = 1, 1, Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString)) * Val(Me.grd.GetRow.Cells(grdEnm.Qty).Value.ToString))
                Me.grd.GetRow.Cells(grdEnm.TotalQty).Value = Val(Me.grd.GetRow.Cells(grdEnm.GrossQty).Value.ToString) - (Val(Me.grd.GetRow.Cells(grdEnm.Column1).Value.ToString) + Val(Me.grd.GetRow.Cells(grdEnm.Column2).Value.ToString) + Val(Me.grd.GetRow.Cells(grdEnm.Column3).Value.ToString))
                Me.grd.GetRow.Cells(grdEnm.VendorQty).Value = Val(Me.grd.GetRow.Cells(grdEnm.TotalQty).Value.ToString)
                'Me.grd.GetRow.Cells(grdEnm.LoadQty).Value = Me.grd.GetRow.Cells(grdEnm.TotalQty).Value
                'ElseIf e.Column.Index = grdEnm.TotalQty Then
                '    If Not Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString) > 2 Then
                '        Me.grd.GetRow.Cells(grdEnm.ReceivedQty).Value = (Val(Me.grd.GetRow.Cells(grdEnm.RejectedQty).Value.ToString) + Val(Me.grd.GetRow.Cells(grdEnm.TotalQty).Value.ToString))
                '        'Me.grd.GetRow.Cells(grdEnm.LoadQty).Value = Me.grd.GetRow.Cells(grdEnm.Qty).Value
                '        Me.grd.GetRow.Cells(grdEnm.VendorQty).Value = Me.grd.GetRow.Cells(grdEnm.TotalQty).Value
                '    End If
            ElseIf e.Column.Index = grdEnm.PackPrice Then
                'If getConfigValueByType("Apply40KgRate").ToString = "False" Then
                If Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString) > 1 Then
                    Me.grd.GetRow.Cells(grdEnm.Price).Value = (Val(Me.grd.GetRow.Cells(grdEnm.PackPrice).Value.ToString) / Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString))
                End If
                'Else
                '    If Val(Me.grd.GetRow.Cells(grdEnm.PackPrice).Value.ToString) > 0 Then
                '        Me.grd.GetRow.Cells(grdEnm.Price).Value = (Val(Me.grd.GetRow.Cells(grdEnm.PackPrice).Value.ToString) / 40)
                '    End If
                'End If
            ElseIf (e.Column.Index = grdEnm.GrossQty Or e.Column.Index = grdEnm.Column1 Or e.Column.Index = grdEnm.Column2 Or e.Column.Index = grdEnm.Column3) Then
                Me.grd.GetRow.Cells(grdEnm.TotalQty).Value = Val(Me.grd.GetRow.Cells(grdEnm.GrossQty).Value.ToString) - (Val(Me.grd.GetRow.Cells(grdEnm.Column1).Value.ToString) + Val(Me.grd.GetRow.Cells(grdEnm.Column2).Value.ToString) + Val(Me.grd.GetRow.Cells(grdEnm.Column3).Value.ToString))
                Me.grd.GetRow.Cells(grdEnm.VendorQty).Value = Val(Me.grd.GetRow.Cells(grdEnm.TotalQty).Value.ToString)

            ElseIf e.Column.Index = grdEnm.Deduction Then
                If Val(Me.grd.GetRow.Cells(grdEnm.Deduction).Value.ToString) > Val(Me.grd.GetRow.Cells(grdEnm.VendorQty).Value.ToString) Then
                    ShowErrorMessage("You can not enter more than vendor quantity.")
                    Me.grd.GetRow.Cells(grdEnm.Deduction).Value = Me.grd.GetRow.Cells(grdEnm.VendorQty).Value
                End If
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    'Public Sub GetGridDetailQtyCalculate(ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs)
    '    Try
    '        Me.grd.UpdateData()
    '        If e.Column.Index = grdEnm.ReceivedQty Or e.Column.Index = grdEnm.PackQty Then
    '            If Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString) > 1 Then
    '                Me.grd.GetRow.Cells(grdEnm.TotalQty).Value = (Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString) * Val(Me.grd.GetRow.Cells(grdEnm.ReceivedQty).Value.ToString))
    '                'Me.grd.GetRow.Cells(GrdEnum.LoadQty).Value = Me.grd.GetRow.Cells(GrdEnum.TotalQty).Value
    '            Else
    '                Me.grd.GetRow.Cells(grdEnm.TotalQty).Value = Val(Me.grd.GetRow.Cells(grdEnm.ReceivedQty).Value.ToString)
    '                'Me.grd.GetRow.Cells(GrdEnum.LoadQty).Value = Me.grd.GetRow.Cells(GrdEnum.TotalQty).Value
    '            End If
    '        ElseIf e.Column.Index = grdEnm.TotalQty Then
    '            If Not Val(Me.grd.GetRow.Cells(grdEnm.PackQty).Value.ToString) > 1 Then
    '                Me.grd.GetRow.Cells(grdEnm.ReceivedQty).Value = Val(Me.grd.GetRow.Cells(grdEnm.TotalQty).Value.ToString)
    '                'Me.grd.GetRow.Cells(GrdEnum.LoadQty).Value = Me.grd.GetRow.Cells(GrdEnum.Qty).Value
    '            End If
    '        End If
    '        'Me.grd.Refetch()
    '    Catch ex As Exception
    '        Throw ex
    '    End Try
    'End Sub

    Private Sub cmbCurrency_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbCurrency.SelectedIndexChanged
        Try
            If Not Me.cmbCurrency.SelectedItem Is Nothing Then
                Dim dr As DataRowView = CType(cmbCurrency.SelectedItem, DataRowView)
                If IsEditMode = True Then
                Else
                    Me.txtCurrencyRate.Text = Math.Round(Convert.ToDouble(dr.Row.Item("CurrencyRate").ToString), 4)
                End If


                ''TASK TFS1474
                If Me.cmbCurrency.SelectedValue = BaseCurrencyId Then
                    Me.txtCurrencyRate.Enabled = False
                Else
                    Me.txtCurrencyRate.Enabled = True
                End If
                ''END TASK TFS1474
                If Val(Me.txtCurrencyRate.Text) = 0 Then
                    Me.txtCurrencyRate.Text = 1
                End If

                If Me.CurrencyRate > 1 Then
                    Me.txtCurrencyRate.Text = CurrencyRate
                End If

                Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).Caption = "Amount (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns("Total Amount").Caption = "Total Amount (" & Me.BaseCurrencyName & ")"
                Me.grd.RootTable.Columns("Total").Caption = "Total (" & Me.BaseCurrencyName & ")"

                Me.grd.RootTable.Columns(grdEnm.BaseCurrencyRate).Caption = "Base Currency Rate (" & Me.BaseCurrencyName & ")"
                Me.grd.RootTable.Columns(grdEnm.CurrencyRate).Caption = "Currency Rate (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).Caption = "Tax Amount (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(grdEnm.CurrencyTotalAmount).Caption = "Total Amount (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(grdEnm.CurrencyAdTaxAmount).Caption = "AdTax Amount (" & Me.cmbCurrency.Text & ")"

                grd.AutoSizeColumns()
                If cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                    Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).Visible = False
                    'Me.grd.RootTable.Columns(grdEnm.BaseCurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(grdEnm.CurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).Visible = False
                    Me.grd.RootTable.Columns(grdEnm.CurrencyTotalAmount).Visible = False
                    Me.grd.RootTable.Columns(grdEnm.CurrencyAdTaxAmount).Visible = False
                    If Me.grd.RowCount > 0 Then
                        For Each GriDEX As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                            GriDEX.BeginEdit()
                            GriDEX.Cells("CurrencyRate").Value = 1
                            GriDEX.Cells("CurrencyId").Value = Me.cmbCurrency.SelectedValue
                            GriDEX.Cells("BaseCurrencyId").Value = BaseCurrencyId
                            GriDEX.Cells("BaseCurrencyRate").Value = 1
                            GriDEX.EndEdit()
                        Next
                    End If
                Else
                    Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).Visible = True
                    'Me.grd.RootTable.Columns(grdEnm.BaseCurrencyRate).Visible = True
                    Me.grd.RootTable.Columns(grdEnm.CurrencyRate).Visible = True
                    Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).Visible = True
                    Me.grd.RootTable.Columns(grdEnm.CurrencyTotalAmount).Visible = True
                    Me.grd.RootTable.Columns(grdEnm.CurrencyAdTaxAmount).Visible = True
                    If Me.grd.RowCount > 0 Then
                        For Each GriDEX As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                            GriDEX.BeginEdit()
                            GriDEX.Cells("CurrencyRate").Value = Val(Me.txtCurrencyRate.Text)
                            GriDEX.Cells("CurrencyId").Value = Me.cmbCurrency.SelectedValue
                            GriDEX.Cells("BaseCurrencyId").Value = BaseCurrencyId
                            GriDEX.Cells("BaseCurrencyRate").Value = 1
                            GriDEX.EndEdit()
                        Next
                    End If
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Function GetCurrencyRate(ByVal currencyId As Integer) As Double ''TAKS-407
        Dim str As String = String.Empty
        Dim dt As New DataTable
        Dim currencyRate As Double = 0
        Try
            'str = "Select CurrencyRate, CurrencyId From tblCurrencyRate Where CurrencyRateId in (Select Max(CurrencyRateId) From tblCurrencyRate group by CurrencyId) And CurrencyId = " & currencyId & ""
            str = "Select TOP 1 CurrencyRate, CurrencyId From tblCurrencyRate Where CurrencyId = " & currencyId & ""
            dt = GetDataTable(str)
            dt.AcceptChanges()
            If dt.Rows.Count > 0 Then
                currencyRate = Val(dt.Rows.Item(0).Item(0).ToString)
            End If
            Return currencyRate
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Private Sub BtnPrint_ButtonClick(sender As Object, e As EventArgs) Handles BtnPrint.ButtonClick

    End Sub

    Private Sub cmbItem_InitializeLayout(sender As Object, e As Win.UltraWinGrid.InitializeLayoutEventArgs) Handles cmbItem.InitializeLayout
        Try
            Dim Layout As UltraGridLayout = e.Layout
            Dim ov As UltraGridOverride = Layout.Override
            ov.HeaderClickAction = HeaderClickAction.SortMulti
            ov.AllowRowFiltering = DefaultableBoolean.True
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub PrintVoucherToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles PrintVoucherToolStripMenuItem.Click, PrintVoucherToolStripMenuItem1.Click
        Try
            GetVoucherPrint(Me.grdSaved.CurrentRow.Cells("ReceivingNo").Value.ToString, "frmPurchase", BaseCurrencyName, BaseCurrencyId)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub cmbVendor_KeyDown(sender As Object, e As KeyEventArgs) Handles cmbVendor.KeyDown
        Try
            ''TFS1781 : Ayesha Rehman :Added for Selection of Customer or Vendor
            If e.KeyCode = Keys.F1 Then
                If getConfigValueByType("Show Customer On Purchase") = "True" Then
                    'frmSearchCustomersVendors.rbtCustomers.Checked = True
                    'frmSearchCustomersVendors.rbtVendors.Checked = True
                    'frmSearchCustomersVendors.rbtCustomers.Visible = True
                    'frmSearchCustomersVendors.rbtVendors.Visible = True
                    frmAccountSearch.AccountType = "'Vendor','Customer' "
                Else
                    'frmSearchCustomersVendors.rbtCustomers.Checked = False
                    'frmSearchCustomersVendors.rbtVendors.Checked = True
                    'frmSearchCustomersVendors.rbtVendors.Visible = True
                    frmAccountSearch.AccountType = "'Vendor'"
                End If

                frmAccountSearch.BringToFront()
                frmAccountSearch.ShowDialog()
                If frmAccountSearch.DialogResult = Windows.Forms.DialogResult.OK Then
                    cmbVendor.Value = frmAccountSearch.SelectedAccountId
                End If
            End If
            ''1686 : Ayesha Rehman :Added for Showing Customer or Vendor
            If e.KeyCode = Keys.F2 Then
                frmShowCustomerVendor.SelectedAccountId = Me.cmbVendor.Value
                frmShowCustomerVendor.BringToFront()
                frmShowCustomerVendor.ShowDialog()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try

    End Sub

    Private Sub cmbCompany_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbCompany.SelectedIndexChanged
        Try
            If IsEditMode = False Then
                Me.txtPONo.Text = GetDocumentNo()
                Me.txtVoucherNo.Text = GetVoucherNo() ''TFS2612
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub grd_KeyDown1(sender As Object, e As KeyEventArgs) Handles grd.KeyDown
        Try
            If e.KeyCode = Keys.F1 Then
                frmRateConversion.formname = Me.Name
                Rate = grd.CurrentRow.Cells("CurrentPrice").Value.ToString
                frmRateConversion.ShowDialog()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Public Sub fillPurchaseNewGrid(ByVal dt As DataTable, ByVal ReceivingId As Integer)

        Dim dt1 As New DataTable

        Try

            Me.grd.DataSource = dt1

            'Me.ReceivingId = ReceivingId

            For Each row As DataRow In dt.Rows

                Me.ReceivingId = row.Item("ReceivingNoId")
                'row.Item("Vendor")

                Me.txtGRNNo.Text = row.Item("ReceivingNo").ToString

                If IsDBNull(row.Item("ReceivingDate")) Then
                    Me.dtpDcDate.Value = Now
                Else
                    Me.dtpDcDate.Value = row.Item("ReceivingDate")
                End If


                Me.txtIGPNo.Text = row.Item("IGPNo").ToString
                Me.txtRemarks.Text = row.Item("Remarks").ToString

                Me.txtDcNo.Text = row.Item("DcNo").ToString

                Me.txtVhNo.Text = row.Item("Vehicle").ToString

                Me.txtInvoiceNo.Text = row.Item("InvoiceNo").ToString

                'row.Item("CostCenterName")

                Me.cmbVendor.Value = Val(row.Item("VendorId").ToString)

                Me.cmbProject.SelectedValue = Val(row.Item("CostCenterID").ToString)

                Me.txtDriverName.Text = row.Item("Driver_Name").ToString
                If Val(row.Item("CurrencyType").ToString) > 0 Then
                    Me.cmbCurrency.SelectedValue = Val(row.Item("CurrencyType").ToString)
                    If Val(row.Item("CurrencyRate").ToString) > 0 Then
                        Me.txtCurrencyRate.Text = Val(row.Item("CurrencyRate").ToString)
                    End If
                Else
                    Me.cmbCurrency.SelectedValue = BaseCurrencyId
                End If
                Me.cmbTransportationVendor.Value = Val(row.Item("Transportation_Vendor").ToString)
                Me.cmbCustomVendor.Value = Val(row.Item("Custom_Vendor").ToString)
                If Not IsDBNull(row.Item("Arrival_Time")) Then
                    Me.dtpArrivalTime.Value = row.Item("Arrival_Time").ToString
                Else
                    Me.dtpArrivalTime.Value = Date.Now
                End If

                If Not IsDBNull(row.Item("Departure_Time")) Then
                    Me.dtpDepartureTime.Value = row.Item("Departure_Time")
                    Me.dtpDepartureTime.Checked = True
                Else
                    Me.dtpDepartureTime.Value = Date.Now
                    Me.dtpDepartureTime.Checked = False
                End If

                DisplayDetailByReceingNo(Val(row.Item("ReceivingNoId").ToString))

            Next

            'Me.grd.DataSource = dt

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    ''' <summary>
    ''' Ayesha Rehman : TFS2375 : Show Approval History of the current Document
    ''' </summary>
    ''' <param name="sender"></param>
    ''' <param name="e"></param>
    ''' <remarks></remarks>
    Private Sub btnApprovalHistory_Click(sender As Object, e As EventArgs) Handles btnApprovalHistory.Click
        Try
            frmApprovalHistory.DocumentNo = Me.txtPONo.Text
            frmApprovalHistory.Source = Me.Name
            frmApprovalHistory.ShowDialog()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub grdInwardExpDetail_CellEdited(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdInwardExpDetail.CellEdited
        Try
            If Me.grdInwardExpDetail.GetRow.RowType = Janus.Windows.GridEX.RowType.Record Then
                Me.txtExpenseTotal.Text = GetNetTotal()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''' <summary>
    ''' TASK TFS2578
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Private Function GetNetTotal() As Double
        Try
            Dim TotalDebit As Double = Me.grdInwardExpDetail.GetTotal(Me.grdInwardExpDetail.RootTable.Columns("Debit"), Janus.Windows.GridEX.AggregateFunction.Sum)
            Dim TotalCredit As Double = Me.grdInwardExpDetail.GetTotal(Me.grdInwardExpDetail.RootTable.Columns("Credit"), Janus.Windows.GridEX.AggregateFunction.Sum)
            Dim TotalAmount As Double = Me.grd.GetTotal(Me.grd.RootTable.Columns("Total Amount"), Janus.Windows.GridEX.AggregateFunction.Sum)
            If Me.rbtAdjFlat.Checked = True Then
                TotalAmount = TotalAmount - Val(Me.txtAdjustment.Text)
            Else
                TotalAmount = TotalAmount - (TotalAmount * Val(Me.txtAdjustment.Text) / 100)
            End If
            Return TotalAmount + (TotalDebit - TotalCredit)
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Private Sub grd_CellEdited(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.CellEdited
        Try
            If Me.grd.GetTotal(Me.grd.RootTable.Columns("Total Amount"), Janus.Windows.GridEX.AggregateFunction.Sum) Then
                Me.txtExpenseTotal.Text = GetNetTotal()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub frmPurchaseNew_Paint(sender As Object, e As PaintEventArgs) Handles Me.Paint

    End Sub

    Private Sub frmPurchaseNew_Resize(sender As Object, e As EventArgs) Handles Me.Resize

    End Sub

    Private Sub txtTax_TextChanged(sender As Object, e As EventArgs) Handles txtTax.TextChanged
        Try
            'If Val(Me.txtTax.Text) > 0 Then
            '    Me.txtNetTotal.Text = Math.Round(Val(Me.txtTotal.Text) + ((Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100), DecimalPointInValue)
            'Else
            '    Me.txtNetTotal.Text = Math.Round(Val(Me.txtTotal.Text), DecimalPointInValue)
            'End If
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtTotal_TextChanged(sender As Object, e As EventArgs) Handles txtTotal.TextChanged
        Try
            ''If Total > 0 Then
            ''If Val(txtTotal.Text) <> Total Then
            'If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '    Me.txtCurrentRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)
            'End If
            ''End If
            ''End If
            'If Val(txtCurrentRate.Text) = 0 Then
            '    If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '        Me.txtCurrentRate.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text), TotalAmountRounding)
            '    End If
            'End If
            'Dim dblTaxPercent As Double = 0D
            'Double.TryParse(Me.txtTax.Text, dblTaxPercent)
            'Me.txtNetTotal.Text = Math.Round((((dblTaxPercent / 100) * Val(Me.txtTotal.Text)) + Val(Me.txtTotal.Text)), TotalAmountRounding)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
    Private Sub txtAdjustment_TextChanged(sender As Object, e As EventArgs) Handles txtAdjustment.TextChanged
        Try
            txtExpenseTotal.Text = GetNetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub rbtAdjFlat_CheckedChanged(sender As Object, e As EventArgs) Handles rbtAdjFlat.CheckedChanged, rbtAdjPercentage.CheckedChanged
        Try
            txtAdjustment_TextChanged(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtRate_TextChanged(sender As Object, e As EventArgs) Handles txtRate.TextChanged
        Me.GetDetailTotal()
    End Sub

    Private Sub btnSaveDocuments_Click(sender As Object, e As EventArgs) Handles btnSaveDocuments.Click
        Try
            If ApprovalProcessId = 0 Then
                If Me.chkPost.Visible = False Then
                    Me.chkPost.Checked = False
                End If
            Else
                Me.chkPost.Visible = False
            End If
            Me.lblProgress.Text = "Loading Please Wait ..."
            Me.lblProgress.BackColor = Color.LightYellow
            Me.lblProgress.Visible = True
            Dim VoucherNo As String = GetVoucherNo()
            Dim objCommand As New OleDbCommand
            Dim objCon As OleDbConnection
            Dim i As Integer
            gobjLocationId = MyCompanyId
            objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")
            If objCon.State = ConnectionState.Open Then objCon.Close()
            objCon.Open()
            Dim cmd As New OleDbCommand
            cmd.Connection = Con
            cmd.CommandType = CommandType.Text

            Dim intAdditionalTaxAcId As Integer = Val(getConfigValueByType("AdditionalTaxAcId").ToString)
            Dim PurchaseTaxDeductionAcId As Integer = 0I
            PurchaseTaxDeductionAcId = Val(getConfigValueByType("PurchaseTaxDeductionAcId").ToString)
            Dim VendorDifferenceQtyAccount As Integer = 0I
            VendorDifferenceQtyAccount = Val(getConfigValueByType("VendorDifferenceQty").ToString)



            Dim lngVoucherMasterId As Integer = GetVoucherId("frmPurchase", Me.txtPONo.Text)



            If Not getConfigValueByType("AvgRate").ToString = "Error" Then
                flgAvgRate = getConfigValueByType("AvgRate")
            End If

            Dim AccountId As Integer = 0I
            If objCon.State = ConnectionState.Closed Then objCon.Open()
            objCommand.Connection = objCon



            Dim trans As OleDbTransaction = objCon.BeginTransaction
            Try
                objCommand.CommandType = CommandType.Text



                objCommand.Transaction = trans
                Dim ReceivingNoteId As Integer = 0I
                If Not drReceivingNote Is Nothing Then
                    ReceivingNoteId = drReceivingNote(enmReceivingNote.Id)
                Else
                    ReceivingNoteId = intReceivingNoteId
                End If
                If IsGRNStockImpacted = True AndAlso ReceivingNoteId > 0 Then
                    ShouldStockImpactGo = False
                End If
                If arrFile.Count > 0 Then
                    SaveDocument(Val(txtReceivingID.Text), Me.Name, trans)
                    trans.Commit()
                End If
                msg_Information("Document Saved Successfully")
                RefreshControls()
                Me.lblProgress.Visible = False
            Catch ex As Exception
                ShowErrorMessage(ex.Message)
            End Try
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Change by Murtaza for txtcurrencyrate text change (11/09/2022) 
    Private Sub txtCurrencyRate_TextChanged(sender As Object, e As EventArgs) Handles txtCurrencyRate.TextChanged
        Try
            If Not Me.cmbCurrency.SelectedItem Is Nothing Then
                Dim dr As DataRowView = CType(cmbCurrency.SelectedItem, DataRowView)
                If Me.cmbCurrency.SelectedValue = BaseCurrencyId Then
                    Me.txtCurrencyRate.Enabled = False
                Else
                    Me.txtCurrencyRate.Enabled = True

                End If
                If Val(Me.txtCurrencyRate.Text) = 0 Then
                    Me.txtCurrencyRate.Text = 1
                End If

                Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).Caption = "Amount (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(grdEnm.CurrencyRate).Caption = "Currency Rate (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).Caption = "Tax Amount (" & Me.cmbCurrency.Text & ")"

                'grd.AutoSizeColumns()
                If cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                    Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).Visible = False
                    Me.grd.RootTable.Columns(grdEnm.BaseCurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(grdEnm.CurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).Visible = False
                    If Me.grd.RowCount > 0 Then
                        For Each GriDEX As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                            GriDEX.BeginEdit()
                            GriDEX.Cells("CurrencyRate").Value = Val(Me.txtCurrencyRate.Text)
                            GriDEX.Cells("CurrencyId").Value = Me.cmbCurrency.SelectedValue
                            GriDEX.Cells("BaseCurrencyId").Value = BaseCurrencyId
                            GriDEX.Cells("BaseCurrencyRate").Value = 1
                            GriDEX.EndEdit()
                        Next
                    End If
                Else
                    Me.grd.RootTable.Columns(grdEnm.CurrencyAmount).Visible = True
                    Me.grd.RootTable.Columns(grdEnm.CurrencyRate).Visible = True
                    Me.grd.RootTable.Columns(grdEnm.CurrencyTaxAmount).Visible = False
                    If Me.grd.RowCount > 0 Then
                        For Each GriDEX As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                            GriDEX.BeginEdit()
                            GriDEX.Cells("CurrencyRate").Value = Val(Me.txtCurrencyRate.Text)
                            GriDEX.Cells("CurrencyId").Value = Me.cmbCurrency.SelectedValue
                            GriDEX.Cells("BaseCurrencyId").Value = BaseCurrencyId
                            GriDEX.Cells("BaseCurrencyRate").Value = 1
                            GriDEX.EndEdit()
                        Next
                    End If
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Change by Murtaza for txtcurrencyrate text change (11/09/2022)
    'Change by Murtaza for alternativee items (01/09/2022)
    'Private Sub lnkRelatedItems_LinkClicked(sender As Object, e As LinkLabelLinkClickedEventArgs) Handles lnkRelatedItems.LinkClicked
    '    Try
    '        Dim frmanme As String = Me.Text
    '        If Not Me.cmbItem.ActiveRow Is Nothing Then
    '            If Val(Me.cmbItem.ActiveRow.Cells("MasterId").Value.ToString) > 0 Then
    '                Dim frmRelItems As New frmRelatedItems(Val(Me.cmbItem.ActiveRow.Cells("MasterId").Value.ToString), frmanme)
    '                frmRelItems.ShowDialog()
    '            End If
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    'Change by Murtaza for alternativee items (01/09/2022)
    Private Sub cmbProject_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbProject.SelectedIndexChanged
        Try
            'Dim Budget As String
            'Dim dtbudget As DataTable
            'Dim BudgetValue As Double
            'If cmbProject.SelectedValue > 0 Then
            '    If BtnSave.Text = "&Save" Then
            '        Budget = "SELECT ISNULL(Amount,0) as Amount from tbldefCostCenter where CostCenterID =" & cmbProject.SelectedValue & ""
            '        dtbudget = GetDataTable(Budget)
            '        If dtbudget.Rows.Count > 0 Then
            '            BudgetValue = dtbudget.Rows(0).Item(0)
            '        End If
            '        lblRemainingBudget.Text = BudgetValue - CDbl(GetAccountBalance(Me.cmbProject.SelectedValue))
            '    Else
            '        lblRemainingBudget.Text = BudgetValue - CDbl(GetAccountBalance(Me.cmbProject.SelectedValue, txtPONo.Text))
            '    End If
            'Else
            '    lblRemainingBudget.Text = ""
            'End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
End Class
