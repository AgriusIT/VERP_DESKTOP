'' 13-Dec-2013 ReqId-924 Imran Ali Sales Invoice slow working
'' 13-Dec-2013 ReqId-926 Imran Ali Button Hide Edit/Delete/Print on Sale Invoice Data Entry 
''14-Dec-2013 R916  Imran Ali               Add comments column
''16-Dec-2013 R934   M Ijaz Javed       Hide Buttons Edit,Delete and Print on Load Form
''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
''29-Dec-2013 R:M6  Imarn Ali     Release 2.1.0.0 Bug
''2-Jan-2014   Tsk:2367    Imran Ali             Calculation Problem
''6-Jan-2014 Task:2369       Imran Ali                Comments layout on ledger
''11-Jan-2014 Task:2373         Imran Ali                Add Columns SubSub Title in Account List on Sales/Purchase
''11-Jan-2014 Task:2374           Imran Ali                Net Amount Sales/Purchase 
''18-Jan-2014 TASK:2380             Imran Ali                 Cash and credit sale and purchase invoice
''21-Jan-2014   TASK:2388             Imran Ali                  Service Item Check Not Working Properly  
'22-Jan-2014  Task:2391       Imran Ali              Avrage Rate Re-Calculation in ERP
''31-Jan-2014     TASK:2401            Imran ali                    Store Issuence Problem 
''03-Feb-2014        Task:2406   Imran Ali    FIELD CHOOSER restriction (Senior Rozgar)
''06-Feb-2014          TASK:M16     Imran Ali   Add New Fields Engine No And Chassis No. on Sales 
''07-Feb-2014             TASK:2416     Imran Ali       Minus Stock Allowed Work Not Properly
''07-Feb-2014        TASK:2417     Imran Ali     Item Filter Customer Wise On Sales Order
''07-Feb-2014    TASK:2415      Imran Ali  Add New Fields Engine No and Chassis No In Sales Module
''17-Feb-2014  Task:2427 Imran Ali  Dispatch Detail Repor Problem.
''20-Feb-2014   TASK:2432 Imran Ali 1 Delivery Chalan Multi Record of Same Item   
''21-Feb-2014 Task:2435   Imran Ali  Update Cost Price In Sales, Sales Return and Store Issuance
''28-Feb-2014 Task:2446 Imran Ai        1-DC No. and ENGINE No. field on customer ledgerc
''01-Mar-2014  TASK:2451   Imran Ali     4-ALPHABETIC order of items in sale and purchase window
''03-Mar-2014  Task:2452    Imran Ali  4-ALPHABETIC order of items in sale and purchase window
''04-Mar-2014  Task:2457  Imran Ali      Sales Certificate Report And Add New Field Certificate No In Sale Form
''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
''13-Mar-2014 Task:2488 Imran Ali Sales Certificate In ERP
''26-Mar-2014 TASK:2517 Imran Ali TASK 2517 PL and Item Problem
''27-Mar-2014 TASK:2521 Imran Ali Searching Engine No on Sales History Window
''29-Mar-2014 TASK:2527 Imran Ali engine no And chassis no re-enter after sales return
''31-Mar-2014 TASK:M28 Imran Ali Send Email With Attachment File Problem
''1-Apr-2014 TASK:M29 Imran Ali Credit Limit Problem
''21-Apr-2014 TASK:2582 Imran Ali Transit insurance value show in Marketing return columnt in po that genrate from sale order and sale invoice.
''21-Apr-2014 Task:2583 Imran Ali Comment Format On Ledger (Pasha Emb)
'Mughees 7-5-2014 Task No 2608 Update The Code to Get RoundOff Functionality
'15-May-2014 Task: 2626 Junaid project column added in sale / purchase and both returns in history tab.
''23-May-2014 TASK:2645 Imran Ali Enhancement in Sales Certificate
''11-June-2014 TASK:2677 Imran Ali Commercial Invoice Configuration On Company Information (Ravi)
''12-June-2014 Task:2681 Imran Ali Add new field Invoice Party On Sales Invoice (Ravi)
''19-June-2014 TASK:2698 IMRAN ALI Default Selected Invoice Party Through Customer List(Ravi)
''25-June-2014 TASK:2702 IMRAN ALI CMFA Load on Sales Invoice (RAVI)
'' 02-Jul-2014 TASK:2712 Imran Ali Purchase Price Update through Adjustment Average Rate
''24-Jul-2014 Task:2759 Imran ali Amount Round on all transaction forms
''27-Jul-2014 Task:2762 Imran Ali Total Amount Rounding configuration
''06-Aug-2014 Task:2770 Imran Ali Due Days Field on Sale Invoice Form (Ravi)
''21-Aug-2014 Task:2794 Imran Ali Sales/Purchase Invoice Depanded Record Delete
''22-Aug-2014 Task:2796 Imran Ali DCQtyExceedAgainstSales
''11-Sep-2014 Task:M101 Imran Ali Add new field remarks 
'2015-02-21 Changes Against Task #20150004 Show Comments
'2015-05-14  Task# 20150504 Add direct printing option from configration Ali Ansari
'08-Jun-2015  Task#2015060005 to allow all files to attach
'10-6-2015 TASKM106151 Imran Ali SalesReturnQty Exists After Update Sales Return
''16-6-2015 TASKM166151 Imran Ali Sales Certificate Ledger Problem
'26-06-2015 Task# 201506027 Allow Equal Qty in Grid Ali Ansari 
'06-07-2015 Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
'07-Jul-2015 Task#07072015 Add new field Invoice Status
''08-07-2015 TASKM78151 Apply Discount Flat
'08-Aug-2015 Task#08082015 Ahmad Sharif: Add configuration for sending sms with just item qunatity and engine no
'16-Sep-2015 Task#16092015 Ahmad Sharif: Load Companies and Locations user wise
''19-9-2015 TASK18 Imran Ali: Validation On Stock If Less Than 1
''12-10-2015 TASKTFS132 Muhammad Ameen: Set key Alt & F1 for Cash Receipt tab selection.
''11-12-2015 TASKTFS126 Muhammad Ameen: Sales invoice: Add label to show total receivables of customer based on (Current Bill + Previous)
''TASK-470 Muhammad Ameen on 01-07-2016: Stock Statement Report By Pack
''TASK:TFS1077  Build central function to print voucher from any transaction screen. Done by Ameen on 20-07-2017
''TFS1153 Added flat discount optional on 07-08-2017
''TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
''TASK : TFS1398 Delivery Chalan's SalesOrderDetailId should be saved to Sales based on it Sales Order should be update from Sales Return.
''TASK TFS1427 User Name should get saved to voucher. Muhammad Ameen on 12-09-2017
''TASK TFS1474 Muhammad Ameen on 15-09-2017. Currency rate can not be edited while base currency is selected.
''TASK TFS1495 Muhammad Ameen : Expense grid values should be updated in net amount field.
''TASK TFS1561 Muhammad Ameen on 03-10-2017 : Item search does not work accurately in case multiple items exist with same name.
''TASK TFS1378 Muhammad Ameen on 16-10-2017. Stock impact on Sales should be restricted in case Delivery Chalan's stock impact flag is checked and that Delivery Chalan is selected on Sales.
''TASK TFS1592 Ayesha Rehman on 19-10-2017 Future date entry should be rights based
''Task TFS1620 Ayesha Rehman on 25-10-2017 Currency Based Control on sales Screen 
''TASK TFS1648 Muhammad Ameen on 03-11-2017. Item's quantity merging should also look location.
''TFS1154 Added Trade Price and Retail Price against Item on sales on 07-11-2017
''TFS1153 Added Item Wise Flat and Percentage Discount Handling on Sales Screen on 13-11-2017
''TFS1596 Ayesha Rehman : Lot/Batch wise Stock Management on 30-11-2017
''TFS1971 Muhammad Ameen done on 27-12-2017. If an invoice no is skipped from skipping invoice no screen then system should generate next invoice no.
''TFS1864 Ayesha Rehman on 2-1-2017 New field to store customer remarks on Sale Invoice.
''TFS1964 Ayesha Rehman on 10-1-2018 Pack Rate in Article Defination
''TFS1799 Ayesha Rehman on 26-1-2018 Reverse calculation of price from a price including tax on Sales screen
''TFS2611 Ayesha Rehman on 09-03-2018 Cash Receipt Voucher No Company Wise on Sales According to Receipt Screen
''TASK TFS3324 Muhammad Ameen done on 31-05-2018. In case an item is logical then its cost sheet items should be effected in stock.
''TFS3520 Ayesha Rehman on 14-06-2018. Sales Order status issue
''TFS4161 Ayesha Rehman : 09-08-2018 : P QTY: (Should Be Static/ Un-Changeable / Un-Editable on All Screens)
''TFS4689 Ayesha Rehman : 03-10-2018 : Show only relevant Accounts on Transactional screens while User wise COA Configuration.
''TFS4718 Ayesha Rehman : 10-10-2018 : Change of PDP rate should be right based on sales.
''TFS4773 Ayesha Rehman : 11-10-2018 : System checking stock on Sales when stock was impacted from DC.

Imports SBDal
Imports SBModel
Imports SBUtility.Utility
Imports SBDal.StockDAL
Imports SBDal.StockDocTypeDAL
Imports System.Data.OleDb
'Imports System.Speech.Synt
Imports CrystalDecisions.CrystalReports.Engine
Imports CrystalDecisions.Shared
Imports CrystalDecisions.Shared.ExportOptions
Imports CrystalDecisions.Windows.Forms
Imports Infragistics.Win.UltraWinTabControl
Imports Infragistics.Win.UltraWinGrid
Imports Infragistics.Win
'07-July-2017: Task # TFS1042: Waqar Raza: Import to check the Maximum value of JobCardId
Imports System.Linq
Imports System
Imports System.Data
Imports System.Data.SqlClient


'txtInternalRemarks


Public Class frmSales
Implements IGeneral
    Enum EnmGrdInventoryEffect
        AritcleID
        Code
        Description
        PurchasePrice
        SalePrice
        Qty
        TotalQty
        Remarks
        'Rafay: Add column 
        PONo
        'rafay
        'Changes add to add column contract no (Murtaza) (11/15/2022)
        contractno
        'Changes add to add column contract no (Murtaza) (11/15/2022)
        ParentId
    End Enum
    ' Add CNG Columns, Changes on 22-Oct-213 (CNG Changes)
    Enum Customer
        Id
        Name
        Code
        State
        City
        Territory
        ExpiryDate
        Discount
        Other_Exp
        Fuel
        CNG
        TransitInsurance
        Credit_Limit
        Type
        Email
        PhoneNo
        Mobile
        SubSubTitle
        SaleMan
    End Enum
    Enum EnumGridDetail
        LocationID
        ArticleCode
        Item
        AlternativeItem
        Size
        Color
        Unit
        Qty
        PostDiscountPrice 'TFS1153
        DiscountId    'TFS1153
        DiscountType  'TFS1153
        Discount_Percentage
        FlatDiscount
        DiscountFactor  'TFS1153
        DiscountValue  'TFS1153
        Price
        BaseCurrencyId
        BaseCurrencyRate
        CurrencyId
        CurrencyRate
        CurrencyAmount
        TotalCurrencyAmount
        Total
        GroupID
        ArticleID
        PackQty
        CurrentPrice
        PackPrice
        SaleDetailID
        RetailPrice 'Task:1154 Added Index
        TradePrice
        Tax
        TaxAmount 'Task:2374 Added Index
        CurrencyTaxAmount
        SED
        TotalAmount 'Task:2374 Added Index
        SavedQty
        SampleQty
        Freight
        MarketReturns
        SO_ID
        LoadQty
        PurchasePrice
        NetBill
        BatchID
        BatchNo
        ExpiryDate
        Origin
        BardanaDeduction
        OtherDeduction
        AfterDeductionQty
        Comments
        OtherComments
        Engine_No 'TASK:M16 Added Index
        Chassis_No 'TASK:M16 Added Index
        Pack_Desc
        AccountId
        SalesAccountId
        CGSAccountId
        CostPrice 'Task:2435 Added Index
        SalesDetailIdByCertificate
        SaleCertificateId
        Stock
        SalesReturnQty 'TASKM106151 Added Column In Detail Record Query (DisplayDetail(),DisplayPODetail() e.g)
        DeliveryChalanId
        DeliveryChalanDetailId
        Transport_Charges
        ApplyAdjustmentFuelExp
        Gross_Weights
        Tray_Weights
        Net_Weight
        TotalQty
        SODetailId
        ArticleLpoName
        OldSalePrice
        SalePriceProcessId
        LogicalItem ''TFS1957
        AlternativeItemId
        DeleteButton
    End Enum
    Dim dt As DataTable
    Dim IsFormOpend As Boolean = False
    Dim IsEditMode As Boolean = False
    Dim ExistingBalance As Double = 0D
    Dim Mode As String = "Normal"
    ' Dim Spech As New SpeechSynthesizer
    Dim ReceiptPost As Boolean = False

    Dim InvId As Integer = 0
    Dim SalesDetailId As Integer = 0
    Dim SelectCategory As Integer
    Dim SelectBarcodes As Integer
    Dim SelectVendor As Integer
    Dim SelectSaleMan As Integer
    Dim SelectCompany As Integer
    Dim SelectTrans As Integer
    Dim CostId As Integer
    Dim FuelExpAccount As Integer
    Dim AdjustmentExpAccount As Integer
    Dim OtherExpAccount As Integer
    Dim EditCustomerListOnSale As String
    Dim StockMaster As StockMaster
    Dim StockDetail As StockDetail

    Dim VNo As String = String.Empty
    Dim ExistingVoucherFlg As Boolean = False
    Dim VoucherId As Integer = 0
    Dim Email As Email
    Dim TradePrice As Double = 0
    Dim SalesTax_Percentage As Double = 0
    Dim SchemeQty As Double = 0
    Dim Discount_Percentage As Double = 0
    Dim Freight As Double = 0
    Dim MarketReturns As Double = 0D
    Dim IsSalesOrderAnalysis As Boolean = False
    Dim SourceFile As String = String.Empty
    Dim FileName As String = String.Empty
    Dim setVoucherNo As String = String.Empty
    Dim crpt As New ReportDocument
    Dim Total_Amount As Double = 0D
    Dim setEditMode As Boolean = False
    Dim getVoucher_Id As Integer = 0
    Dim companyId As Integer = 0
    Dim Previouse_Amount As Double = 0D
    'Dim ServicesItem As String = 0D
    Dim TransitInssuranceTax As Double = 0D
    Dim WHTax As Double = 0D
    Dim PrintLog As PrintLogBE
    Dim CompanyBasePrefix As Boolean = False
    Dim flgMultipleSalesOrder As Boolean = False
    Dim flgLoadAllItems As Boolean = False
    Dim DefaultTax As Double = 0D
    Dim flgCompanyRights As Boolean = False
    Dim LoadQty As Double = 0D
    Public flgAutoInvoiceGenerate As Boolean = False
    Public DeliveryChalanId As Integer = 0I
    Dim Adjustment As Double = 0D
    Dim flgCgsVoucher As Boolean = False
    Dim flgPrintLog As Boolean = False
    Dim flgLocationWiseItems As Boolean = False
    Dim _RefDocId As Integer = 0I
    Dim _RefDocNo As String = String.Empty
    Dim StockList As List(Of StockDetail)
    Dim StockAssemblyList As List(Of StockDetail)
    Dim flgExcludeTaxPrice As Boolean = False
    ''Task:2369 Declare Boolean Variables
    Dim flgCommentCustomerFormat As Boolean = False
    Dim flgCommentArticleFormat As Boolean = False
    Dim flgCommentArticleSizeFormat As Boolean = False
    Dim flgCommentArticleColorFormat As Boolean = False
    Dim flgCommentQtyFormat As Boolean = False
    Dim flgCommentPriceFormat As Boolean = False
    Dim flgCommentRemarksFormat As Boolean = False
    'End Task:2369
    Dim CreditSales As Boolean = True 'Task:2380 Added Flag Credit Sales
    Dim flgVehicleIdentificationInfo As Boolean = False 'Task:M16 Added Flag Vehicle Identification
    Dim flgMargeItem As Boolean = False ''20-Feb-2014   TASK:2432 Imran Ali 1 Delivery Chalan Multi Record of Same Item  
    Dim flgCommentSalesDcNo As Boolean = False 'Task:2446 e.g Dc No Comment on Ledger.
    Dim flgCommentEngineNo As Boolean = False 'Task:2446 e.g Engine No Comment on Ledger.
    Dim lngVoucherId As Integer = 0I ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
    Dim flgAvgRate As Boolean = False 'Task:2517 Added Flag AvgRate
    Dim blnNoneFinancialEffectInvoice As Boolean = False 'Task:2645 @TODO None Financial Invoice
    Dim blnCommercialInvoice As Boolean = False 'Task:2677 TODO Commercial Invoice In Which GST Will Not Apply
    Dim blnCMFADocumentLoad As Boolean = False 'Task:2702 Declare Var For CMFA Load Through User.
    Dim blnOrderQtyExceed As Boolean = False 'Task:2796 declare variable for order qty exceed against delivery chalan
    Dim blnDeliveryQtyExceed As Boolean = False 'Task:2796 declare variable for order qty exceed against delivery chalan
    Dim blnUpdateAll As Boolean = False
    Dim currencyamount As Double = 0
    'Marked Against Task#2015060001 Ali Ansari
    'Dim arrFile() As String = {}
    'Marked Against Task#2015060001 Ali Ansari
    'Altered Against Task#2015060001 Ali Ansari
    ' Convert string into List of string for making proper count
    Dim arrFile As List(Of String)
    'Altered Against Task#2015060001 Ali Ansari
    Dim BiltyCommentSales As Boolean = False
    Dim TransporterCommentsSales As Boolean = False
    Dim blnCertificateIssued As Boolean = False
    Private _Previous_Balance As Double = 0D
    Private blnRefreshMod As Boolean = False
    Private blnDisplayAll As Boolean = False
    Dim strOtherComments As String = String.Empty
    Dim strComments As String = String.Empty
    Dim blnTradePriceExceed As Boolean = False
    Dim dblSEDPercent As Double = 0D
    Dim soDetailId As Integer = 0
    Dim dblTaxPercent As Double = 0D
    Dim soID As Integer = 0
    Dim AttachmentRight As Boolean = False
    Dim BaseCurrencyId As Integer
    Dim BaseCurrencyName As String = String.Empty
    Dim AvailableStockInLoose As Double = 0D
    Dim AvailableStockInPack As Double = 0D
    Dim AvailableStock As Double = 0D
    Dim StockChecked As Boolean = False
    Dim _Qty As Double = 0D
    Dim _TotalQty As Double = 0D
    Dim QtyBefore As Double = 0D
    Dim LoadQtyBefore As Double = 0D
    Dim TotalQtyBefore As Double = 0D
    Dim Price As String = String.Empty
    Dim PDP As String = String.Empty 'TFS1153
    Dim CurrentPrice As String = String.Empty
    Dim NotificationDAL As New NotificationTemplatesDAL
    Public ModelId As Integer = 0
    Dim ModelListDAL As New ModelListDAL
    ''//To get value from save messagebox TASK # 943
     Public Paid As Boolean = False
    Public UnPaid As Boolean = False
    Dim IsGetAllAllowed As Boolean = False
    Dim IsAdminGroup As Boolean = False
    'Code Edit for task 1592 future date rights
    Dim IsDateChangeAllowed As Boolean = False
    ''TASK TASK TFS1561
    Dim KeyDownPrice As Double = 0
    Dim KeyDownArticleId As Integer
    Dim KeyDownArticleCode As String
    Dim IsKeyDownCalled As Boolean = False
    ''END TASK TFS1561
    'Ali Faisal : TFS1606 : Add CompanyId veriable
    Public Shared SalesCompanyId As Integer = 0I
    'Ali Faisal : TFS1606 : End
    Public Const DiscountType_Percentage As String = "Percentage" ''TFS1153
    Public Const DiscountType_Flat As String = "Flat" ''TFS1153
    Public Shared UnbuildCustomerId As Integer = 0I
    Public Shared InvoiceAmount As Double
    Public Shared CostCenterId As Integer = 0I
    Dim ApprovalProcessId As Integer = 0 ''TFS3113
    Dim CustSaleRate As Double = 0D ''TFS1663
    Dim IsSOSeparateClosure As Boolean = False
    Dim Total As Double = 0 ''TFS3330 : Ayesha Rehman : This Total is Added to retain the value of total ,when pack rate changes
    Dim flgSOSeparateClosure As Boolean = False ''TFS3520 : Ayesha Rehman
    Dim CurrencyRate As Double = 1
    Dim IsSOLoaded As Boolean = False
    Dim IsPackQtyDisabled As Boolean = False ''TFS4161
    Dim IsRevisionRestrictedFirstTime As Boolean = False
    Dim ItemFilterByName As Boolean = False

    Dim SOBatchNo As String = String.Empty
    Dim SOExpiryDate As DateTime = Date.Now.AddMonths(1)
    Dim SOOrigin As String = String.Empty
    Dim IsAllowPDPEdit As Boolean = False  ''TFS4718
    Dim DCStockImpact As Boolean = False ''TFS4773
    Private Sub frmSales_Activated(sender As Object, e As EventArgs)

    End Sub

    Private Sub frmSales_KeyUp(sender As Object, e As KeyEventArgs) Handles MyBase.KeyUp
        Try
            If getConfigValueByType("BarcodeEnabled") = "True" Then
                If e.KeyCode = Keys.OemQuestion Then
                    Me.Panel4.Visible = True
                    Me.Panel4.BringToFront()
                    Me.txtBarcodescan.Focus()
                    e.SuppressKeyPress = True
                End If
            End If
            If e.KeyCode = Keys.F4 Then
                If BtnSave.Enabled = True Then
                    SaveToolStripButton_Click(Nothing, Nothing)
                End If
            End If
            'If cmbDeliveryChalan.SelectedIndex > 0 Then
            '    chkDelivered.Checked = True
            'Else
            '    chkDelivered.Checked = False
            'End If
            ''TASKTFS132
            If e.KeyCode = Keys.F1 AndAlso e.Alt Then
                Dim tabs As UltraTabsCollection = tbSalesDetail.Tabs
                Me.tbSalesDetail.SelectedTab = tabs("cashreceipt")
            End If

            If e.KeyCode = Keys.ShiftKey AndAlso e.Alt Then
                Dim tabs As UltraTabsCollection = tbSalesDetail.Tabs
                Me.tbSalesDetail.SelectedTab = tabs("Expense")
            End If

            If e.KeyCode = Keys.F2 AndAlso e.Alt Then
                Dim tabs As UltraTabsCollection = tbSalesDetail.Tabs
                Me.tbSalesDetail.SelectedTab = tabs(0)
            End If

            If e.KeyCode = Keys.Escape Then
                NewToolStripButton_Click(Nothing, Nothing)
                Exit Sub
            End If

            If e.KeyCode = Keys.P AndAlso e.Control = True Then
                PrintToolStripButton_Click(Nothing, Nothing)
                Exit Sub
            End If
            If e.KeyCode = Keys.F5 Then
                BtnRefresh_Click(Nothing, Nothing)
            End If
            If e.KeyCode = Keys.Insert Then
                btnAdd_Click(Nothing, Nothing)
            End If
            If e.KeyCode = Keys.U AndAlso e.Alt Then
                If Me.BtnSave.Text = "&Update" Then
                    If Me.BtnSave.Enabled = False Then
                        RemoveHandler Me.BtnSave.Click, AddressOf Me.SaveToolStripButton_Click
                    End If
                End If
            End If
            If e.KeyCode = Keys.D AndAlso e.Alt Then
                If Me.BtnSave.Text = "&Delete" Then
                    If Me.BtnDelete.Enabled = False Then
                        RemoveHandler Me.BtnDelete.Click, AddressOf Me.DeleteToolStripButton_Click
                    End If
                End If
            End If
        Catch ex As Exception

        End Try
    End Sub
    'Private Sub frmSales_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
    '    Try
    '        If getConfigValueByType("BarcodeEnabled") = "True" Then
    '            If e.KeyCode = Keys.OemQuestion Then
    '                Me.Panel4.Visible = True
    '                Me.Panel4.BringToFront()
    '                Me.txtBarcodescan.Focus()
    '                e.SuppressKeyPress = True
    '            End If
    '        End If
    '        If e.KeyCode = Keys.F4 Then
    '            If BtnSave.Enabled = True Then
    '                SaveToolStripButton_Click(Nothing, Nothing)
    '            End If
    '        End If
    '        ''TASKTFS132
    '        If e.KeyCode = Keys.F1 AndAlso e.Alt Then
    '            Dim tabs As UltraTabsCollection = tbSalesDetail.Tabs
    '            Me.tbSalesDetail.SelectedTab = tabs("cashreceipt")

    '        End If

    '        If e.KeyCode = Keys.Escape Then
    '            NewToolStripButton_Click(Nothing, Nothing)
    '            Exit Sub
    '        End If

    '        If e.KeyCode = Keys.P AndAlso e.Control = True Then
    '            PrintToolStripButton_Click(Nothing, Nothing)
    '            Exit Sub
    '        End If
    '        If e.KeyCode = Keys.F5 Then
    '            BtnRefresh_Click(Nothing, Nothing)
    '        End If
    '        If e.KeyCode = Keys.Insert Then
    '            btnAdd_Click(Nothing, Nothing)
    '        End If
    '        If e.KeyCode = Keys.U AndAlso e.Alt Then
    '            If Me.BtnSave.Text = "&Update" Then
    '                If Me.BtnSave.Enabled = False Then
    '                    RemoveHandler Me.BtnSave.Click, AddressOf Me.SaveToolStripButton_Click
    '                End If
    '            End If
    '        End If
    '        If e.KeyCode = Keys.D AndAlso e.Alt Then
    '            If Me.BtnSave.Text = "&Delete" Then
    '                If Me.BtnDelete.Enabled = False Then
    '                    RemoveHandler Me.BtnDelete.Click, AddressOf Me.DeleteToolStripButton_Click
    '                End If
    '            End If
    '        End If
    '    Catch ex As Exception

    '    End Try
    'End Sub
    Private Sub frmSales_Shown(ByVal sender As Object, ByVal e As System.EventArgs) Handles MyBase.Shown
        Me.gbJobCard.Visible = False
        Me.lblProgress.Text = "Loading please wait ..."
        Me.lblProgress.BackColor = Color.LightYellow
        Me.lblProgress.Visible = True
        Me.Cursor = Cursors.WaitCursor
        Application.DoEvents()
        Try
            If Not getConfigValueByType("PrintLog").ToString = "Error" Then
                flgPrintLog = getConfigValueByType("PrintLog").ToString
            Else
                flgPrintLog = False
            End If

            If Not getConfigValueByType("LoadAllItemsInSales").ToString = "Error" Then
                flgLoadAllItems = getConfigValueByType("LoadAllItemsInSales")
            End If

            If Not getConfigValueByType("ArticleFilterByLocation").ToString = "Error" Then
                flgLocationWiseItems = getConfigValueByType("ArticleFilterByLocation")
            End If

            If Not getConfigValueByType("ExcludeTaxPrice").ToString = "Error" Then
                flgExcludeTaxPrice = Convert.ToBoolean(getConfigValueByType("ExcludeTaxPrice").ToString)
            End If
            'Task:M16 Added Flag Vehicle Identification Info
            If Not getConfigValueByType("flgVehicleIdentificationInfo").ToString = "Error" Then
                flgVehicleIdentificationInfo = getConfigValueByType("flgVehicleIdentificationInfo")
            Else
                flgVehicleIdentificationInfo = False
            End If
            'End Task:M16


            If Not getConfigValueByType("BiltyCommentsSales").ToString = "Error" Then
                BiltyCommentSales = getConfigValueByType("BiltyCommentsSales")
            Else
                BiltyCommentSales = False
            End If
            If Not getConfigValueByType("TransporterCommentsSales").ToString = "Error" Then
                TransporterCommentsSales = getConfigValueByType("TransporterCommentsSales")
            Else
                TransporterCommentsSales = False
            End If

            'Task:2432 Added Flag Marge Item 
            If Not getConfigValueByType("flgMargeItem").ToString = "Error" Then
                flgMargeItem = getConfigValueByType("flgMargeItem")
            Else
                flgMargeItem = False
            End If
            'End Task:2432

            'Task:2702 Get Config CMFA Document Load
            If Not getConfigValueByType("CMFADocumentOnSales").ToString = "Error" Then
                blnCMFADocumentLoad = getConfigValueByType("CMFADocumentOnSales")
            Else
                blnCMFADocumentLoad = False
            End If
            'End Task:2702




            'TAsk:2795 Set ByRef Variable blnOrderQtyExceed
            If Not getConfigValueByType("OrderQtyExceedAgainstSales").ToString = "Error" Then
                blnOrderQtyExceed = getConfigValueByType("OrderQtyExceedAgainstSales").ToString
            Else
                blnOrderQtyExceed = False
            End If
            'End Task:2796

            'TAsk:2795 Set ByRef Variable blnOrderQtyExceed
            If Not getConfigValueByType("DCQtyExceedAgainstSales").ToString = "Error" Then
                blnDeliveryQtyExceed = getConfigValueByType("DCQtyExceedAgainstSales").ToString
            Else
                blnDeliveryQtyExceed = False
            End If
            'End Task:2796
            ''Start TFS4161
            If Not getConfigValueByType("DiablePackQuantity").ToString = "Error" Then
                IsPackQtyDisabled = Convert.ToBoolean(getConfigValueByType("DiablePackQuantity").ToString)
            End If
            ''End TFS4161

            If Not getConfigValueByType("MultipleSalesOrder").ToString = "Error" Then
                flgMultipleSalesOrder = Convert.ToBoolean(getConfigValueByType("MultipleSalesOrder").ToString)
            Else
                flgMultipleSalesOrder = False
            End If
            ''Start TFS3520
            If Not getConfigValueByType("SeparateClosureOfSODC") = "Error" Then
                flgSOSeparateClosure = getConfigValueByType("SeparateClosureOfSODC")
            Else
                flgSOSeparateClosure = False
            End If

            If flgSOSeparateClosure = True Then
                btnLoadSOAndDC.Visible = True
                Me.pnlSO.Visible = False
                Me.pnlSOMove.Location = New Point(3, 83)
            Else
                btnLoadSOAndDC.Visible = False
                Me.pnlSO.Visible = True
                Me.pnlSOMove.Location = New Point(3, 144)
            End If
            ''End TFS3520

            If getConfigValueByType("BarcodeEnabled") = "True" Then
                Mode = "BarcodeEnabled"
                Me.Panel4.Visible = True
                'pnlSimple.TabStop = False
                'pnlSimple.Enabled = False
                Me.txtBarcodescan.Focus()
            Else
                Panel4.Visible = False
            End If
            ''Start TFS4773
            If Not getConfigValueByType("DCStockImpact").ToString = "Error" Then
                DCStockImpact = Convert.ToBoolean(getConfigValueByType("DCStockImpact").ToString)
            End If
            ''End TFS4773
            ''TASK TFS4544
            'If getConfigValueByType("ItemFilterByName").ToString = "True" Then
            '    ItemFilterByName = Convert.ToBoolean(getConfigValueByType("ItemFilterByName").ToString)
            'End If
            ''END TFS4544
            BaseCurrencyId = Val(getConfigValueByType("Currency").ToString)
            BaseCurrencyName = GetBasicCurrencyName(BaseCurrencyId)
            rbPer.Visible = False
            rbFlat.Visible = False

            '' End setting account ids
            FillCombo("Category")
            'FillCombo("Barcodes")
            FillCombo("Vendor")
            FillCombo("SM")
            FillCombo("Transporter")
            ''FillCombo("Item") Move to ResetControl 31-10-2017
            FillCombo("Company")
            FillCombo("Project")
            FillCombo("CMFA") 'Task:2702 Get CMFA
            FillCombo("TaxRate")
            FillCombo("Discount Type") 'Task1153

            FillCombo("Status")
            FillCombo("OutwardExpense")
            If frmMain.blnListSeachStartWith = True Then
                cmbItem.AutoCompleteMode = Win.AutoCompleteMode.Suggest
                cmbItem.AutoSuggestFilterMode = Win.AutoSuggestFilterMode.StartsWith
            End If

            If frmMain.blnListSeachContains = True Then
                cmbItem.AutoCompleteMode = Win.AutoCompleteMode.Suggest
                cmbItem.AutoSuggestFilterMode = Win.AutoSuggestFilterMode.Contains
            End If
            'FillCombo("ArticlePack")
            'FillCombo("SO")
            'Me.DisplayRecord()
            'ServicesItem = GetConfigValue("ServiceItem").ToString
            '' Setting Account ids
            Me.IsFormOpend = True
            If BackgroundWorker4.IsBusy Then Exit Sub
            BackgroundWorker4.RunWorkerAsync()
            'Do While BackgroundWorker4.IsBusy
            '    Application.DoEvents()
            'Loop
            'FillCombo("Currency")
            RefreshControls()
            'Me.DisplayRecord()
            '//This will hide Master grid
            Me.grdSaved.Visible = CType(getConfigValueByType("ShowMasterGrid"), Boolean)

            GetSalesOrderAnalysis()
            'cmbCategory_SelectedIndexChanged(Nothing, Nothing)
            txtTransitInsurancePercentage.Text = TransitInssuranceTax
            Me.txtWHTaxPercent.Text = WHTax
            Get_All(frmModProperty.Tags)
            'FillCombo("Currency")
            FillCombo("Lift")
            'Me.cmbItem.Editor()

            'TFS3360
            UltraDropDownSearching(cmbVendor, frmMain.blnListSeachStartWith, frmMain.blnListSeachContains)
            UltraDropDownSearching(cmbItem, frmMain.blnListSeachStartWith, frmMain.blnListSeachContains)

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
            Me.lblProgress.Visible = False
            If frmModProperty.Tags.Length > 0 Then frmModProperty.Tags = String.Empty ''18-Feb-2014 Task:2429 Imran Ali 1-error in payable/receivable tracing
        End Try
    End Sub

    '' ReqId-924 Comment Display Record And Article Pack Method
    Private Sub Form1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub DisplayRecord(Optional ByVal StrCondition As String = "")
    '    Try
    '        'Dim ServiceItem As String = GetConfigValue("ServiceItem").ToString
    '        Dim ClosingDate As DateTime = Convert.ToDateTime(getConfigValueByType("EndOfDate").ToString)
    '        Dim PreviouseRecordShow As Boolean = Convert.ToBoolean(getConfigValueByType("PreviouseRecordShow").ToString)
    '        '20-July-2017: Task TFS1084: Waqar Raza: Added for sales history load quntity.
    '        'Start Task:
    '        Dim HistoryLoad As Integer = Convert.ToInt32(Val(getConfigValueByType("SalesHistoryLoadQuantity").ToString))
    '        'End Task:
    '        Dim username As String = LoginUserName
    '        Dim str As String = String.Empty

    '        'Marked Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
    '        'Altered Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
    '        '07-July-2017: Task # TFS1042: Waqar Raza: Modified Query To add jobcardNo is sales history.
    '        '02-Dec-2017: Task # TFS1864: Ayesha Rehman: Modified Query To add Internal Remarks is sales history.

    '        str = "SELECT " & IIf(StrCondition.ToString = "All", "", "Top " & If(HistoryLoad = 0, 50, HistoryLoad)) & "    Recv.SalesNo, Recv.SalesDate AS Date,Case When IsNull(DV.POID,0)=0 Then V.SalesOrderNo else SO_DL.SalesOrderNo End as SalesOrderNo,  Case When IsNull(DV.POID,0)=0 Then V.SalesOrderDate else SO_DL.SalesOrderDate End as SalesOrderDate, vwCOADetail.detail_title as CustomerName, Pack.Packs, Recv.SalesQty, Recv.SalesAmount, Recv.SalesId, Recv.Arrival_Time , Recv.Departure_Time, Recv.Com_Percentage,  " & _
    '                 "Recv.CustomerCode, tbldefEmployee.Employee_Name, Recv.Remarks, Recv.InternalRemarks,CONVERT(varchar, Recv.CashPaid) AS CashPaid, Recv.EmployeeCode, Recv.PoId, Recv.BiltyNo,isnull(Recv.TransporterId ,0) as TransporterId, Recv.LocationId, Recv.FuelExpense as Fuel, Recv.OtherExpense as Expense ,recv.Adjustment, " & IIf(flgExcludeTaxPrice = True, "(Recv.SalesAmount + NetInfo.SedTaxAmount ) As NetAmount ", " (Recv.SalesAmount + NetInfo.SedTaxAmount + NetInfo.TaxAmount ) As NetAmount ") & ", IsNull(Recv.Invoice_Status,0) as InvoiceStatus , isnull(recv.TransitInsurance,0) as TransitInsurance, IsNull(Recv.Post,0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end As Status, ISNULL(Recv.ServiceItemSale,0) as ServiceItemSale, Recv.DeliveryDate, ISNULL(Recv.Delivered,0) as Delivered, isnull(Recv.DeliveryChalanId, 0) as DeliveryId, DV.DeliveryNo, DV.DeliveryDate as [Dc Date], Recv.DcNo, isnull(Recv.Adj_Flag,0) as Adj_Flag, isnull(Recv.Adj_Percentage,0) as Adj_Percentage ,Isnull(Recv.CostCenterId,0) as CostCenterId, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], tblDefCostCenter.Name, Isnull(Recv.ManualInvoice,0) as ManualInvoice, Recv.InvoiceParty, ISNULL(Recv.CMFADocId,0) as CMFADocID, (CMFA.DocNo + '~' + Convert(varchar,Convert(varchar,CMFA.DocDate, 102))) as CMFADocNo, IsNull(Recv.DueDays,0) as DueDays, dbo.vwCOADetail.Contact_Email as Email, IsNull(Recv.InvoiceType,'Credit') as [Inv Type], IsNull([No Of Attachment],0) as  [No Of Attachment],Recv.Other_Company, Recv.Party_Mobile_No , Adjustment.InvoiceID,Recv.UserName as 'User Name',Recv.UpdateUserName as [Modified By], IsNull(tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID,0) as SalesTaxInvoiceStatus_ID, tblSalesTaxInvoiceStatus.SalesTaxInvoice_Status as [Invoice Status], IsNull(Recv.PreviousBalance,0) as PreviousBalance, IsNull(Recv.JobCardId, 0) As JobCardId, tblJobCard.JobCardNo,  Convert(bit, IsNull(Recv.IsSOSeparateClosure, 0)) AS IsSOSeparateClosure " & _
    '                 "FROM tblDefCostCenter Right Outer JOIN SalesMasterTable Recv ON tblDefCostCenter.CostCenterID=Recv.CostCenterId INNER JOIN " & _
    '                 "vwCOADetail ON Recv.CustomerCode = vwCOADetail.coa_detail_id LEFT OUTER JOIN tblJobCard ON Recv.JobCardId = tblJobCard.JobCardID LEFT OUTER JOIN (Select SalesId, Sum(IsNull(Sz1, 0)) As Packs From SalesDetailTable Group By SalesId) As Pack ON Recv.SalesId = Pack.SalesId LEFT OUTER JOIN " & _
    '                 "tblDefEmployee ON Recv.EmployeeCode = tblDefEmployee.Employee_Id LEFT OUTER JOIN " & _
    '                 "SalesOrderMasterTable V ON Recv.POId = V.SalesOrderId  LEFT OUTER JOIN (Select Count(*) as [No Of Attachment],DocId From DocumentAttachment WHERE (source = N'" & Me.Name & "') Group By DocId, Source) Doc_Att on Doc_Att.DocId = Recv.SalesId LEFT OUTER JOIN DeliveryChalanMasterTable DV ON DV.DeliveryId = Recv.DeliveryChalanId LEFT OUTER JOIN CMFAMasterTable CMFA ON CMFA.DocId = Recv.CMFADocID LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.SalesNo LEFT OUTER JOIN SalesOrderMasterTable SO_DL On SO_DL.SalesOrderId = DV.POId " & _
    '                 " left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Sales') as Adjustment on Recv.SalesId = Adjustment.InvoiceID  Left Outer Join tblSalesTaxInvoiceStatus on Recv.Invoice_Status = tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID   " & _
    '                 "  left outer join (SELECT     SalesDetailTable.SalesId, SUM((ISNULL(TaxPercent, 0) / 100) * (ISNULL(Qty, 0) * ISNULL(Price, 0))) AS TaxAmount,SUM((ISNULL(SEDPercent, 0) / 100) * (ISNULL(Qty, 0) * ISNULL(Price, 0))) AS SedTaxAmount " & _
    '                 " FROM         dbo.SalesDetailTable INNER JOIN SalesMasterTable on SalesMasterTable.SalesId = SalesDetailTable.SalesId group by SalesDetailTable.SalesId ) As NetInfo on Recv.SalesId = NetInfo.SalesId " & _
    '                 " where Recv.SalesNo <> '' " & IIf(blnDisplayAll = True, "", " AND recv.LocationId=" & Me.cmbCompany.SelectedValue & "") & " " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, SalesDate, 102) > Convert(Datetime, N'" & ClosingDate.ToString("yyyy-M-d 23:59:59") & "', 102))") & " "
    '        'Altered Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
    '        If blnNoneFinancialEffectInvoice = False Then
    '            str += " AND IsNull(Recv.ManualInvoice,0) <> 1"
    '        Else
    '            str += " AND IsNull(Recv.ManualInvoice,0) = 1"
    '        End If
    '        If Me.dtpFrom.Checked = True Then
    '            str += " AND Recv.SalesDate >= Convert(Datetime, N'" & Me.dtpFrom.Value.ToString("yyyy-M-d 00:00:00") & "', 102)"
    '        End If
    '        If Me.dtpTo.Checked = True Then
    '            str += " AND Recv.SalesDate <= Convert(Datetime, N'" & Me.dtpTo.Value.ToString("yyyy-M-d 23:59:59") & "', 102)"
    '        End If
    '        If Me.txtSearchDocNo.Text <> String.Empty Then
    '            str += " AND Recv.SalesNo LIKE '%" & Me.txtSearchDocNo.Text & "%'"
    '        End If
    '        If Me.cmbSearchLocation.SelectedIndex <> 0 Then
    '            If Not Me.cmbSearchLocation.SelectedValue Is Nothing Then
    '                str += " AND Recv.SalesId In(Select SalesId From SalesDetailTable where LocationID=" & Me.cmbSearchLocation.SelectedValue & ")"
    '            End If
    '        End If
    '        If Me.txtFromAmount.Text <> String.Empty Then
    '            If Val(Me.txtFromAmount.Text) > 0 Then
    '                str += " AND Recv.SalesAmount >= " & Val(Me.txtFromAmount.Text) & " "
    '            End If
    '        End If
    '        If Me.txtToAmount.Text <> String.Empty Then
    '            If Val(Me.txtToAmount.Text) > 0 Then
    '                str += " AND Recv.SalesAmount <= " & Val(Me.txtToAmount.Text) & ""
    '            End If
    '        End If
    '        If cmbSearchAccount.ActiveRow IsNot Nothing Then
    '            If Me.cmbSearchAccount.SelectedRow.Cells(0).Value <> 0 Then
    '                str += " AND Recv.CustomerCode = " & Me.cmbSearchAccount.Value
    '            End If
    '        End If
    '        If Me.txtSearchRemarks.Text <> String.Empty Then
    '            str += " AND Recv.Remarks LIKE '%" & Me.txtSearchRemarks.Text & "%'"
    '        End If
    '        ''TFS1864 Added to match the Internal Remarks with Search Remarks 
    '        If Me.txtSearchRemarks.Text <> String.Empty Then
    '            str += " AND Recv.InternalRemarks LIKE '%" & Me.txtSearchRemarks.Text & "%'"
    '        End If
    '        If Me.txtPurchaseNo.Text <> String.Empty Then
    '            str += " AND V.SalesOrderNo LIKE  '%" & Me.txtPurchaseNo.Text & "%'"
    '        End If
    '        'Task:2521 Engine No Filter
    '        If Me.txtSearchEngineNo.Text.Length > 0 Then
    '            str += " AND Recv.SalesId In (Select SalesId From SalesDetailTable WHERE Engine_No LIKE '%" & Me.txtSearchEngineNo.Text & "%')"
    '        End If
    '        If username.Length > 0 AndAlso IsGetAllAllowed = False AndAlso IsAdminGroup = False Then
    '            str += " And Recv.UserName LIKE '%" & username & "%'"
    '        End If
    '        'End Task:2521
    '        str += " ORDER BY Recv.SalesNo DESC"
    '        'End If
    '        '07-July-2017: Task # TFS1042 Waqar Raza: Added by Waqar to show JobCard No for HFR to make visible and invisible the JobCardNo Column.
    '        'Start TFS1042:
    '        Dim dt As DataTable = GetDataTable(str)
    '       'End TFS1042:
    '        Me.grdSaved.DataSource = dt
    '        Me.grdSaved.RetrieveStructure()
    '        Me.grdSaved.RootTable.Columns("No Of Attachment").ColumnType = Janus.Windows.GridEX.ColumnType.Link
    '        Me.grdSaved.RootTable.Columns.Add("Column1")
    '        Me.grdSaved.RootTable.Columns("Column1").ActAsSelector = True
    '        Me.grdSaved.RootTable.Columns("Column1").UseHeaderSelector = True
    '        ' ''FillGrid(grdSaved, str)
    '        grdSaved.RootTable.Columns("SalesId").Visible = False
    '        'grdSaved.Columns(4).Visible = False
    '        grdSaved.RootTable.Columns("CustomerCode").Visible = False
    '        grdSaved.RootTable.Columns("InvoiceID").Visible = False
    '        grdSaved.RootTable.Columns("PreviousBalance").Visible = False
    '        grdSaved.RootTable.Columns("EmployeeCode").Visible = False
    '        grdSaved.RootTable.Columns("PoId").Visible = False
    '        grdSaved.RootTable.Columns("TransporterId").Visible = False
    '        grdSaved.RootTable.Columns("BiltyNo").Visible = False
    '        grdSaved.RootTable.Columns("LocationId").Visible = False
    '        grdSaved.RootTable.Columns("Adjustment").Visible = False
    '        grdSaved.RootTable.Columns("Post").Visible = False
    '        grdSaved.RootTable.Columns("DeliveryId").Visible = False
    '        Me.grdSaved.RootTable.Columns("ServiceItemSale").Visible = False
    '        Me.grdSaved.RootTable.Columns("InvoiceStatus").Visible = False             'Task#07072015 Hide the Invoice status column
    '        grdSaved.RootTable.Columns("DeliveryNo").Caption = "DC No"
    '        grdSaved.RootTable.Columns("ManualInvoice").Visible = False 'Task:2645 Hidden Column
    '        grdSaved.RootTable.Columns("Adj_Flag").Visible = False
    '        grdSaved.RootTable.Columns("Adj_Percentage").Visible = False
    '        Me.grdSaved.RootTable.Columns("CostCenterId").Visible = False
    '        Me.grdSaved.RootTable.Columns("Other_Company").Visible = False
    '        Me.grdSaved.RootTable.Columns("Com_Percentage").Visible = False
    '        Me.grdSaved.RootTable.Columns("InvoiceParty").Visible = False 'Task:2681 Hidden Column
    '        'grdSaved.RootTable.Columns("ServiceItemSale").Visible = False
    '        grdSaved.RootTable.Columns("CMFADocId").Visible = False 'TAsk:2702 Default Hidden Field
    '        Me.grdSaved.RootTable.Columns("Email").Visible = False
    '        Me.grdSaved.RootTable.Columns("Party_Mobile_No").Visible = False
    '        Me.grdSaved.RootTable.Columns("DeliveryDate").Visible = False
    '        Me.grdSaved.RootTable.Columns("SalesTaxInvoiceStatus_ID").Visible = False
    '        Me.grdSaved.RootTable.Columns("JobCardId").Visible = False
    '        '07-July-2017: Task # TFS1042: Waqar Raza: Added by Waqar to show JobCard No for HFR.
    '        'Start TFS1042:
    '        grdSaved.RootTable.Columns("JobCardNo").Visible = False
    '        'Énd TFS1042:
    '        'IsSOSeparateClosure
    '        grdSaved.RootTable.Columns("IsSOSeparateClosure").Visible = False
    '        grdSaved.RootTable.Columns("SalesNo").Caption = "Issue No"
    '        grdSaved.RootTable.Columns("Date").Caption = "Date"
    '        grdSaved.RootTable.Columns("SalesOrderNo").Caption = "S-Order"
    '        grdSaved.RootTable.Columns("SalesOrderDate").Caption = "Order Date"
    '        grdSaved.RootTable.Columns("CustomerName").Caption = "Customer"
    '        grdSaved.RootTable.Columns("SalesQty").Caption = "Qty"
    '        grdSaved.RootTable.Columns("SalesAmount").Caption = "Amount"
    '        grdSaved.RootTable.Columns("Employee_Name").Caption = "Employee"
    '        grdSaved.RootTable.Columns("DcNo").Caption = "Manual Dc No"
    '        'Task: 2626 Junaid
    '        grdSaved.RootTable.Columns("Name").Visible = True
    '        grdSaved.RootTable.Columns("Name").Caption = "Project Name"
    '        'END Task: 2626
    '        grdSaved.RootTable.Columns("CustomerName").Width = 150
    '        grdSaved.RootTable.Columns("Remarks").Width = 150
    '        grdSaved.RootTable.Columns("InternalRemarks").Width = 150 ''TFS1864

    '        grdSaved.RootTable.Columns("Arrival_Time").Caption = "In Time"
    '        grdSaved.RootTable.Columns("Departure_Time").Caption = "Out Time"
    '        grdSaved.RootTable.Columns("NetAmount").Visible = True ''TFS4677
    '        Me.grdSaved.TotalRow = Janus.Windows.GridEX.InheritableBoolean.True
    '        Me.grdSaved.TotalRowPosition = Janus.Windows.GridEX.TotalRowPosition.BottomFixed
    '        Me.grdSaved.RootTable.Columns("Packs").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
    '        Me.grdSaved.RootTable.Columns("SalesQty").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
    '        Me.grdSaved.RootTable.Columns("SalesAmount").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
    '        Me.grdSaved.RootTable.Columns("Expense").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
    '        Me.grdSaved.RootTable.Columns("Fuel").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
    '        Me.grdSaved.RootTable.Columns("Adjustment").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
    '        Me.grdSaved.RootTable.Columns("CashPaid").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
    '        Me.grdSaved.RootTable.Columns("NetAmount").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum ''TFS4677
    '        Me.grdSaved.RootTable.Columns("Packs").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("SalesQty").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("SalesAmount").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("Expense").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("Fuel").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("Adjustment").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("TransitInsurance").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("NetAmount").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS4677
    '        Me.grdSaved.RootTable.Columns("Packs").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("SalesQty").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("SalesAmount").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("Expense").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("Fuel").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("Adjustment").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("TransitInsurance").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
    '        Me.grdSaved.RootTable.Columns("NetAmount").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS4677
    '        Me.grdSaved.RootTable.Columns("Date").FormatString = str_DisplayDateFormat

    '        'Task:2759 set Rounded amount format
    '        grdSaved.RootTable.Columns("SalesAmount").FormatString = "N" & DecimalPointInValue
    '        Me.grdSaved.RootTable.Columns("Expense").FormatString = "N" & DecimalPointInValue
    '        Me.grdSaved.RootTable.Columns("Fuel").FormatString = "N" & DecimalPointInValue
    '        Me.grdSaved.RootTable.Columns("Adjustment").FormatString = "N" & DecimalPointInValue
    '        Me.grdSaved.RootTable.Columns("TransitInsurance").FormatString = "N" & DecimalPointInValue
    '        Me.grdSaved.RootTable.Columns("NetAmount").FormatString = "N" & DecimalPointInValue
    '        'end Task:2759
    '        Me.grdSaved.RootTable.Columns("Arrival_Time").FormatString = "hh:mm:ss tt"
    '        Me.grdSaved.RootTable.Columns("Departure_Time").FormatString = "hh:mm:ss tt"

    '        CtrlGrdBar3_Load(Nothing, Nothing)
    '        CtrlGrdBar2_Load(Nothing, Nothing)

    '    Catch ex As Exception
    '        Throw ex
    '    End Try
    'End Sub
    Private Sub DisplayRecord(Optional ByVal StrCondition As String = "")
        Try
            'Dim ServiceItem As String = GetConfigValue("ServiceItem").ToString
            Dim ClosingDate As DateTime = Convert.ToDateTime(getConfigValueByType("EndOfDate").ToString)
            Dim PreviouseRecordShow As Boolean = Convert.ToBoolean(getConfigValueByType("PreviouseRecordShow").ToString)
            '20-July-2017: Task TFS1084: Waqar Raza: Added for sales history load quntity.
            'Start Task:
            Dim HistoryLoad As Integer = Convert.ToInt32(Val(getConfigValueByType("SalesHistoryLoadQuantity").ToString))
            'End Task:
            Dim username As String = LoginUserName
            Dim str As String = String.Empty

            'Marked Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
            'Altered Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
            '07-July-2017: Task # TFS1042: Waqar Raza: Modified Query To add jobcardNo is sales history.
            '02-Dec-2017: Task # TFS1864: Ayesha Rehman: Modified Query To add Internal Remarks is sales history.
            'Rafay :Task : Modified Query to add PO_NO in sales history
            'Rafay :Task : Modified Query to add CUrrency And AmountUS in sales history
            str = "SELECT " & IIf(StrCondition.ToString = "All", "", "Top " & If(HistoryLoad = 0, 50, HistoryLoad)) & "    Recv.SalesNo, Recv.SalesDate AS Date,Case When IsNull(DV.POID,0)=0 Then V.SalesOrderNo else SO_DL.SalesOrderNo End as SalesOrderNo,  Case When IsNull(DV.POID,0)=0 Then V.SalesOrderDate else SO_DL.SalesOrderDate End as SalesOrderDate, vwCOADetail.detail_title as CustomerName, Pack.Packs, Recv.SalesQty,dbo.tblcurrency.currency_code,Currency.CurrencyRate, Recv.SalesAmount,Recv.AmountUS, Recv.SalesAmount, Recv.SalesId, Recv.Arrival_Time , Recv.Departure_Time, Recv.Com_Percentage,  " & _
                     "Recv.CustomerCode, tbldefEmployee.Employee_Name,Recv.PO_NO,Recv.ContractNo, Recv.Remarks, Recv.InternalRemarks,CONVERT(varchar, Recv.CashPaid) AS CashPaid, Recv.EmployeeCode, Recv.PoId, Recv.BiltyNo,isnull(Recv.TransporterId ,0) as TransporterId, Recv.LocationId, Recv.FuelExpense as Fuel, Recv.OtherExpense as Expense ,recv.Adjustment, " & IIf(flgExcludeTaxPrice = True, "(Recv.SalesAmount + NetInfo.SedTaxAmount ) As NetAmount ", " (Recv.SalesAmount + NetInfo.SedTaxAmount + NetInfo.TaxAmount ) As NetAmount ") & ", IsNull(Recv.Invoice_Status,0) as InvoiceStatus , isnull(recv.TransitInsurance,0) as TransitInsurance, IsNull(Recv.Post,0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end As Status, ISNULL(Recv.ServiceItemSale,0) as ServiceItemSale, Recv.DeliveryDate, ISNULL(Recv.Delivered,0) as Delivered, isnull(Recv.DeliveryChalanId, 0) as DeliveryId, DV.DeliveryNo, DV.DeliveryDate as [Dc Date], Recv.DcNo, isnull(Recv.Adj_Flag,0) as Adj_Flag, isnull(Recv.Adj_Percentage,0) as Adj_Percentage ,Isnull(Recv.CostCenterId,0) as CostCenterId, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], tblDefCostCenter.Name, Isnull(Recv.ManualInvoice,0) as ManualInvoice, Recv.InvoiceParty, ISNULL(Recv.CMFADocId,0) as CMFADocID, (CMFA.DocNo + '~' + Convert(varchar,Convert(varchar,CMFA.DocDate, 102))) as CMFADocNo, IsNull(Recv.DueDays,0) as DueDays, dbo.vwCOADetail.Contact_Email as Email, IsNull(Recv.InvoiceType,'Credit') as [Inv Type], IsNull([No Of Attachment],0) as  [No Of Attachment],Recv.Other_Company, Recv.Party_Mobile_No , Adjustment.InvoiceID,Recv.UserName as 'User Name',Recv.UpdateUserName as [Modified By], IsNull(tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID,0) as SalesTaxInvoiceStatus_ID, tblSalesTaxInvoiceStatus.SalesTaxInvoice_Status as [Invoice Status], IsNull(Recv.PreviousBalance,0) as PreviousBalance, IsNull(Recv.JobCardId, 0) As JobCardId, tblJobCard.JobCardNo,  Convert(bit, IsNull(Recv.IsSOSeparateClosure, 0)) AS IsSOSeparateClosure " & _
                     "FROM tblDefCostCenter Right Outer JOIN SalesMasterTable Recv ON tblDefCostCenter.CostCenterID=Recv.CostCenterId INNER JOIN " & _
                     "vwCOADetail ON Recv.CustomerCode = vwCOADetail.coa_detail_id LEFT OUTER JOIN tblJobCard ON Recv.JobCardId = tblJobCard.JobCardID LEFT OUTER JOIN (Select SalesId, Sum(IsNull(Sz1, 0)) As Packs From SalesDetailTable Group By SalesId) As Pack ON Recv.SalesId = Pack.SalesId LEFT OUTER JOIN " & _
                     "tblDefEmployee ON Recv.EmployeeCode = tblDefEmployee.Employee_Id LEFT OUTER JOIN " & _
                     "(Select Distinct SalesDetailTable.SalesId,CurrencyId,CurrencyRate  From SalesDetailTable) As Currency ON Recv.SalesId = Currency.SalesId LEFT OUTER JOIN  " & _
                     "dbo.tblcurrency ON Currency.CurrencyId = dbo.tblcurrency.currency_id Left Outer Join " & _
                     "SalesOrderMasterTable V ON Recv.POId = V.SalesOrderId  LEFT OUTER JOIN (Select Count(*) as [No Of Attachment],DocId From DocumentAttachment WHERE (source = N'" & Me.Name & "') Group By DocId, Source) Doc_Att on Doc_Att.DocId = Recv.SalesId LEFT OUTER JOIN DeliveryChalanMasterTable DV ON DV.DeliveryId = Recv.DeliveryChalanId LEFT OUTER JOIN CMFAMasterTable CMFA ON CMFA.DocId = Recv.CMFADocID LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.SalesNo LEFT OUTER JOIN SalesOrderMasterTable SO_DL On SO_DL.SalesOrderId = DV.POId " & _
                     " left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Sales') as Adjustment on Recv.SalesId = Adjustment.InvoiceID  Left Outer Join tblSalesTaxInvoiceStatus on Recv.Invoice_Status = tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID   " & _
                     "  left outer join (SELECT     SalesDetailTable.SalesId, SUM((ISNULL(TaxPercent, 0) / 100) * (ISNULL(Qty, 0) * ISNULL(Price, 0))) AS TaxAmount,SUM((ISNULL(SEDPercent, 0) / 100) * (ISNULL(Qty, 0) * ISNULL(Price, 0))) AS SedTaxAmount " & _
                     " FROM         dbo.SalesDetailTable INNER JOIN SalesMasterTable on SalesMasterTable.SalesId = SalesDetailTable.SalesId group by SalesDetailTable.SalesId ) As NetInfo on Recv.SalesId = NetInfo.SalesId " & _
                     " where Recv.SalesNo <> '' " & IIf(blnDisplayAll = True, "", " AND recv.LocationId=" & Me.cmbCompany.SelectedValue & "") & " " & IIf(PreviouseRecordShow = True, "", " AND (Convert(varchar, SalesDate, 102) > Convert(Datetime, N'" & ClosingDate.ToString("yyyy-M-d 23:59:59") & "', 102))") & " "
            'Altered Against Task#201507010 Ali Ansari to add user name field in Grid of all transactions forms
            If blnNoneFinancialEffectInvoice = False Then
                str += " AND IsNull(Recv.ManualInvoice,0) <> 1"
            Else
                str += " AND IsNull(Recv.ManualInvoice,0) = 1"
            End If
            If Me.dtpFrom.Checked = True Then
                str += " AND Recv.SalesDate >= Convert(Datetime, N'" & Me.dtpFrom.Value.ToString("yyyy-M-d 00:00:00") & "', 102)"
            End If
            If Me.dtpTo.Checked = True Then
                str += " AND Recv.SalesDate <= Convert(Datetime, N'" & Me.dtpTo.Value.ToString("yyyy-M-d 23:59:59") & "', 102)"
            End If
            If Me.txtSearchDocNo.Text <> String.Empty Then
                str += " AND Recv.SalesNo LIKE '%" & Me.txtSearchDocNo.Text & "%'"
            End If
            If Me.cmbSearchLocation.SelectedIndex <> 0 Then
                If Not Me.cmbSearchLocation.SelectedValue Is Nothing Then
                    str += " AND Recv.SalesId In(Select SalesId From SalesDetailTable where LocationID=" & Me.cmbSearchLocation.SelectedValue & ")"
                End If
            End If
            If Me.txtFromAmount.Text <> String.Empty Then
                If Val(Me.txtFromAmount.Text) > 0 Then
                    str += " AND Recv.SalesAmount >= " & Val(Me.txtFromAmount.Text) & " "
                End If
            End If
            If Me.txtToAmount.Text <> String.Empty Then
                If Val(Me.txtToAmount.Text) > 0 Then
                    str += " AND Recv.SalesAmount <= " & Val(Me.txtToAmount.Text) & ""
                End If
            End If
            If cmbSearchAccount.ActiveRow IsNot Nothing Then
                If Me.cmbSearchAccount.SelectedRow.Cells(0).Value <> 0 Then
                    str += " AND Recv.CustomerCode = " & Me.cmbSearchAccount.Value
                End If
            End If
            If Me.txtSearchRemarks.Text <> String.Empty Then
                str += " AND Recv.Remarks LIKE '%" & Me.txtSearchRemarks.Text & "%'"
            End If
            ''TFS1864 Added to match the Internal Remarks with Search Remarks 
            If Me.txtSearchRemarks.Text <> String.Empty Then
                str += " AND Recv.InternalRemarks LIKE '%" & Me.txtSearchRemarks.Text & "%'"
            End If
            If Me.txtPurchaseNo.Text <> String.Empty Then
                str += " AND V.SalesOrderNo LIKE  '%" & Me.txtPurchaseNo.Text & "%'"
            End If
            'Task:2521 Engine No Filter
            If Me.txtSearchEngineNo.Text.Length > 0 Then
                str += " AND Recv.SalesId In (Select SalesId From SalesDetailTable WHERE Engine_No LIKE '%" & Me.txtSearchEngineNo.Text & "%')"
            End If
            If username.Length > 0 AndAlso IsGetAllAllowed = False AndAlso IsAdminGroup = False Then
                str += " And Recv.UserName LIKE '%" & username & "%'"
            End If
            'End Task:2521
            'Rafay apply filter to show record on top
            ' str += " ORDER BY Recv.SalesNo DESC"
            str += " ORDER BY Recv.SalesId DESC"
            'rafay task End
            'End If
            '07-July-2017: Task # TFS1042 Waqar Raza: Added by Waqar to show JobCard No for HFR to make visible and invisible the JobCardNo Column.
            'Start TFS1042:
            Dim dt As DataTable = GetDataTable(str)
            'End TFS1042:
            Me.grdSaved.DataSource = dt
            Me.grdSaved.RetrieveStructure()
            Me.grdSaved.RootTable.Columns("No Of Attachment").ColumnType = Janus.Windows.GridEX.ColumnType.Link
            Me.grdSaved.RootTable.Columns.Add("Column1")
            Me.grdSaved.RootTable.Columns("Column1").ActAsSelector = True
            Me.grdSaved.RootTable.Columns("Column1").UseHeaderSelector = True
            ' ''FillGrid(grdSaved, str)
            grdSaved.RootTable.Columns("SalesId").Visible = False
            'grdSaved.Columns(4).Visible = False
            grdSaved.RootTable.Columns("CustomerCode").Visible = False
            grdSaved.RootTable.Columns("SalesAmount1").Visible = False
            grdSaved.RootTable.Columns("InvoiceID").Visible = False
            grdSaved.RootTable.Columns("PreviousBalance").Visible = False
            grdSaved.RootTable.Columns("EmployeeCode").Visible = False
            grdSaved.RootTable.Columns("PoId").Visible = False
            grdSaved.RootTable.Columns("TransporterId").Visible = False
            grdSaved.RootTable.Columns("BiltyNo").Visible = False
            grdSaved.RootTable.Columns("LocationId").Visible = False
            grdSaved.RootTable.Columns("Adjustment").Visible = False
            grdSaved.RootTable.Columns("Post").Visible = False
            grdSaved.RootTable.Columns("DeliveryId").Visible = False
            Me.grdSaved.RootTable.Columns("ServiceItemSale").Visible = False
            Me.grdSaved.RootTable.Columns("InvoiceStatus").Visible = False             'Task#07072015 Hide the Invoice status column
            grdSaved.RootTable.Columns("DeliveryNo").Caption = "DC No"
            grdSaved.RootTable.Columns("ManualInvoice").Visible = False 'Task:2645 Hidden Column
            grdSaved.RootTable.Columns("Adj_Flag").Visible = False
            grdSaved.RootTable.Columns("Adj_Percentage").Visible = False
            Me.grdSaved.RootTable.Columns("CostCenterId").Visible = False
            Me.grdSaved.RootTable.Columns("Other_Company").Visible = False
            Me.grdSaved.RootTable.Columns("Com_Percentage").Visible = False
            Me.grdSaved.RootTable.Columns("InvoiceParty").Visible = False 'Task:2681 Hidden Column
            'grdSaved.RootTable.Columns("ServiceItemSale").Visible = False
            grdSaved.RootTable.Columns("CMFADocId").Visible = False 'TAsk:2702 Default Hidden Field
            Me.grdSaved.RootTable.Columns("Email").Visible = False
            Me.grdSaved.RootTable.Columns("Party_Mobile_No").Visible = False
            Me.grdSaved.RootTable.Columns("DeliveryDate").Visible = False
            Me.grdSaved.RootTable.Columns("SalesTaxInvoiceStatus_ID").Visible = False
            Me.grdSaved.RootTable.Columns("JobCardId").Visible = False
            '07-July-2017: Task # TFS1042: Waqar Raza: Added by Waqar to show JobCard No for HFR.
            'Start TFS1042:
            grdSaved.RootTable.Columns("JobCardNo").Visible = False
            'Énd TFS1042:
            'IsSOSeparateClosure
            grdSaved.RootTable.Columns("IsSOSeparateClosure").Visible = False
            grdSaved.RootTable.Columns("SalesNo").Caption = "Issue No"
            grdSaved.RootTable.Columns("Date").Caption = "Date"
            grdSaved.RootTable.Columns("SalesOrderNo").Caption = "S-Order"
            grdSaved.RootTable.Columns("SalesOrderDate").Caption = "Order Date"
            grdSaved.RootTable.Columns("CustomerName").Caption = "Customer"
            grdSaved.RootTable.Columns("SalesQty").Caption = "Qty"
            'rafay task start
            grdSaved.RootTable.Columns("SalesAmount").Caption = "Base Currency"
            grdSaved.RootTable.Columns("currency_code").Caption = "Currency"
            grdSaved.RootTable.Columns("AmountUS").Caption = "Original Value"
            'rafay task end
            grdSaved.RootTable.Columns("Employee_Name").Caption = "Employee"
            grdSaved.RootTable.Columns("DcNo").Caption = "Manual Dc No"
            'Task: 2626 Junaid
            grdSaved.RootTable.Columns("Name").Visible = True
            grdSaved.RootTable.Columns("Name").Caption = "Project Name"
            'END Task: 2626
            grdSaved.RootTable.Columns("CustomerName").Width = 150
            grdSaved.RootTable.Columns("Remarks").Width = 150
            'Rafay
            grdSaved.RootTable.Columns("PO_NO").Width = 150
            'Rafay:the foreign currency is add on purchase history
            Dim grdSaved1 As DataTable = GetDataTable(str)
            grdSaved1.Columns("AmountUS").Expression = "IsNull(SalesAmount,0) / (IsNull(CurrencyRate,0))" 'Task:2374 Show Total Amount
            Me.grdSaved.DataSource = grdSaved1
            'Set rounded format
            Me.grdSaved.RootTable.Columns("AmountUS").FormatString = "N" & DecimalPointInValue
            'rafay
            grdSaved.RootTable.Columns("InternalRemarks").Width = 150 ''TFS1864

            grdSaved.RootTable.Columns("Arrival_Time").Caption = "In Time"
            grdSaved.RootTable.Columns("Departure_Time").Caption = "Out Time"
            grdSaved.RootTable.Columns("NetAmount").Visible = True ''TFS4677
            Me.grdSaved.TotalRow = Janus.Windows.GridEX.InheritableBoolean.True
            Me.grdSaved.TotalRowPosition = Janus.Windows.GridEX.TotalRowPosition.BottomFixed
            Me.grdSaved.RootTable.Columns("Packs").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grdSaved.RootTable.Columns("SalesQty").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grdSaved.RootTable.Columns("SalesAmount").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grdSaved.RootTable.Columns("Expense").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grdSaved.RootTable.Columns("Fuel").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grdSaved.RootTable.Columns("Adjustment").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grdSaved.RootTable.Columns("CashPaid").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grdSaved.RootTable.Columns("NetAmount").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum ''TFS4677
            Me.grdSaved.RootTable.Columns("Packs").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("SalesQty").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("SalesAmount").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("Expense").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("Fuel").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("Adjustment").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("TransitInsurance").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("NetAmount").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS4677
            Me.grdSaved.RootTable.Columns("Packs").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("SalesQty").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("SalesAmount").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("Expense").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("Fuel").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("Adjustment").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("TransitInsurance").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grdSaved.RootTable.Columns("NetAmount").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS4677
            Me.grdSaved.RootTable.Columns("Date").FormatString = str_DisplayDateFormat

            'Task:2759 set Rounded amount format
            grdSaved.RootTable.Columns("SalesAmount").FormatString = "N" & DecimalPointInValue
            Me.grdSaved.RootTable.Columns("Expense").FormatString = "N" & DecimalPointInValue
            Me.grdSaved.RootTable.Columns("Fuel").FormatString = "N" & DecimalPointInValue
            Me.grdSaved.RootTable.Columns("Adjustment").FormatString = "N" & DecimalPointInValue
            Me.grdSaved.RootTable.Columns("TransitInsurance").FormatString = "N" & DecimalPointInValue
            Me.grdSaved.RootTable.Columns("NetAmount").FormatString = "N" & DecimalPointInValue
            'end Task:2759
            Me.grdSaved.RootTable.Columns("Arrival_Time").FormatString = "hh:mm:ss tt"
            Me.grdSaved.RootTable.Columns("Departure_Time").FormatString = "hh:mm:ss tt"

            CtrlGrdBar3_Load(Nothing, Nothing)
            CtrlGrdBar2_Load(Nothing, Nothing)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub btnAdd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAdd.Click
        Try
            'If Not sender.GetType.Name.ToString = "UltraCombo" Then

            If Not Validate_AddToGrid() Then
                If Not Mode = "Normal" Then Me.txtBarcodescan.Focus()
                Exit Sub
            End If
            'End If
            'If Not GetConfigValue("ServiceItem").ToString = "True" Then
            'LoadQty = Val(Me.txtTotalQuantity.Text)
            LoadQty = Convert.ToDecimal(Me.txtTotalQuantity.Text)

            'If FindExistsItem(Me.cmbItem.Value, Val(Me.txtRate.Text), Me.cmbUnit.Text, Val(Me.txtPackQty.Text), Val(Me.cmbPo.SelectedValue)) = True Then
            'Else
            'If Not FindExistsItem(Me.cmbItem.Value, Val(Me.txtRate.Text), Me.cmbUnit.Text, Val(Me.txtPackQty.Text), Val(Me.cmbPo.SelectedValue), Val(Me.cmbCategory.SelectedValue)) = True Then
            AddItemToGrid()
            'End If
            'End If
            ' Me.cmbItem.ActiveRow.Cells("Stock").Value = Val(Me.cmbItem.ActiveRow.Cells("Stock").Value) - Val(Me.txtQty.Text)
            GetTotal()
            dt = grd.DataSource
            ClearDetailControls()
            If Me.Mode = "Normal" Then cmbItem.Focus()
            'FillCombo("Item")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub RefreshControls()
        Try

            'Task 1592 Ayesha Rehman Removing the ErrorProvider on btnNew
            ErrorProvider2.Clear()
            Me.IsEditMode = False
            ''ReqId 924 Comment Code
            'If Me.BtnSave.Text = "&Update" Then
            '    FillCombo("Vendor")
            'End If

            Me.txtAdjustment.Text = String.Empty
            If getConfigValueByType("BarcodeEnabled") = "True" Then
                Mode = "BarcodeEnabled"
            Else
                Mode = "Normal"
            End If
            Me.pnlSimple.Height = Val(pnlSimple.Tag)
            DeliveryChalanId = 0I
            IsDrillDown = False
            IsSOLoaded = False
            'Marked Against Task#2015060001
            'Array.Clear(arrFile, 0, arrFile.Length)
            'Marked Against Task#2015060001 Ali Ansari
            'Altered Against Task#2015060001 Ali Ansari
            'Clear arrfile
            arrFile = New List(Of String)
            'Altered Against Task#2015060001 Ali Ansari
            'DisplayDetail(-1)
            'Me.cmbVendor.Focus()
            SOBatchNo = String.Empty
            SOExpiryDate = Date.Now.AddMonths(1)
            SOOrigin = String.Empty
            blnRefreshMod = False
            Me.btnAttachment.Text = "Attachment"
            Me.CurrencyRate = 1
            ''TASK TFS4544
            If getConfigValueByType("ItemFilterByName").ToString = "True" Then
                ItemFilterByName = Convert.ToBoolean(getConfigValueByType("ItemFilterByName").ToString)
            End If
            ''END TFS4544
            If Me.Mode = "Normal" Then
                Me.dtpPODate.Focus()
                txtPONo.Text = ""
                '12-July-2017: Task# TFS1042: Waqar Raza: Change Now date to server Date
                dtpPODate.Value = Date.Now
                txtRemarks.Text = ""
                'Rafay
                txtPO.Text = ""
                'Changes add to add column contract no (Murtaza) (11/15/2022)
                txtcontractno.Text = ""
                'Changes add to add column contract no (Murtaza) (11/15/2022)
                companyinitials = ""
                'Rafay
                richTxtInternalRemarks.Text = "" ''TFS1864
                txtPaid.Text = ""
                txtAmount.Text = ""
                txtTotal.Text = ""
                txtTotalQty.Text = ""
                txtComPercentage.Text = ""
                '9-Nov-2017: Task# TFS1154: Ayesha Rehman: Set Retail Price text empty on load,new
                txtRetailPrice.Text = ""
                '15-Nov-2017: Task# TFS1153: Ayesha Rehman: Set these controls text empty on load,new
                txtPDP.Text = 0
                txtDiscountValue.Text = ""
                '27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
                Me.txtNetTotal.Text = ""
                Me.txtQty.Text = ""
                Me.txtRate.Text = ""
                Me.txtTax.Text = ""
                Me.txtDisc.Text = ""
                txtBalance.Text = ""
                ''''''''''''''''''''''''''''''
                txtPackQty.Text = 1
                Me.txtExpense.Text = 0
                Me.txtFuel.Text = 0
                Me.uitxtBiltyNo.Text = ""
                Me.txtPackRate.Text = String.Empty
                Me.BtnSave.Text = "&Save"
                Me.txtPONo.Text = GetDocumentNo() 'GetNextDocNo("SI" & Me.cmbCompany.SelectedValue, 6, "SalesMasterTable", "SalesNo")
                Me.ExistingBalance = 0D
                'FillCombo("SO")
                'If Me.cmbCategory.SelectedValue > 0 Then
                '    FillCombo("ItemFilter")
                'Else
                '    FillCombo("Item")
                'End If
                Me.cmbDiscountType.SelectedIndex = 1
                Me.cmbCompany.Enabled = True
                Me.cmbPo.Enabled = True
                Me.cmbCurrency.Enabled = True
                If Me.cmbSalesMan.SelectedIndex = 0 Then Me.cmbSalesMan.SelectedIndex = 0 Else Me.cmbSalesMan.SelectedIndex = Me.cmbSalesMan.SelectedIndex
                Me.cmbTransporter.SelectedIndex = 0 ''TFS4339
                cmbUnit.SelectedIndex = 0
                cmbTaxCategory.SelectedIndex = 0 ''TFS1799
                If Me.cmbVendor.Rows.Count > 0 Then cmbVendor.Rows(0).Activate()
                'grd1.Rows.Clear()
                '
                'Me.cmbSalesMan.Focus()
                'Me.cmbSalesMan.DroppedDown = True
                'Me.cmbVendor.Focus()
                'me.cmbVendor
                Me.cmbVendor.Enabled = True
                If cmbPo.Items.Count > 0 Then Me.cmbPo.SelectedIndex = 0
                'Me.LinkLabel1.Enabled = True
                'If Not GetConfigValue("ServiceItem").ToString = "True" Then
                'Me.txtChalanNo.Text = String.Empty
                If flgLoadAllItems = True Then
                    Me.DisplayDetail(-1, -1, "LoadAll")
                    'Me.LinkLabel1.Visible = False
                Else
                    'Me.LinkLabel1.Visible = True
                    'Me.LinkLabel1.Enabled = True
                    Me.DisplayDetail(-1)
                End If
                DisplayRecord()
                'Else
                '    Me.DisplayDetail(-1)
                'End If
                'GetSalesOrderAnalysis()


                Me.rdoCNG.Checked = False
                Me.rdoFuel.Checked = True
                Me.GetSecurityRights()
                Me.dtpFrom.Value = Date.Now.AddMonths(-1)
                Me.dtpTo.Value = Date.Now
                Me.dtpFrom.Checked = False
                Me.dtpTo.Checked = False
                Me.txtSearchDocNo.Text = String.Empty
                Me.txtFromAmount.Text = String.Empty
                Me.txtToAmount.Text = String.Empty
                Me.txtPurchaseNo.Text = String.Empty
                Me.txtSearchEngineNo.Text = String.Empty 'Task:2521 reset engine control
                'Me.cmbSearchAccount.Rows(0).Activate()
                'Me.cmbSearchLocation.SelectedIndex = 0
                Me.txtSearchRemarks.Text = String.Empty
                Me.SplitContainer2.Panel1Collapsed = True
                'Me.CtrlGrdBar3_Load(Nothing, Nothing)
                'CtrlGrdBar2_Load(Nothing, Nothing)
                Me.txtAddTransitInsurance.Text = 0
                Me.txtTransitInsurancePercentage.Text = TransitInssuranceTax
                DeliveryChalanId = 0
                Me.txtDcNo.Text = String.Empty
                Me.txtMobileNo.Text = String.Empty
                'Me.rbtAdjFlat.Checked = True
                Adjustment = 0D
                Me.dtpPODate.Enabled = True
                'If Not Me.cmbProject.SelectedIndex = -1 Then Me.cmbProject.SelectedIndex = 0 'Comment Against task:2427
                _RefDocId = 0
                'FillCombo("Item")
                FillCombo("Other_Company")
                Me.cmbOtherCompany.Text = String.Empty
                blnCertificateIssued = False
                Me.CtrlGrdBar3_Load(Nothing, Nothing)
                CtrlGrdBar2_Load(Nothing, Nothing)
                'DisplayRecord()
            Else
                Me.cmbCompany.Enabled = True
                Me.cmbPo.Enabled = True
                txtPONo.Text = ""
                dtpPODate.Value = Now
                txtRemarks.Text = ""
                'Rafay
                txtPO.Text = ""
                'Changes add to add column contract no (Murtaza) (11/15/2022)
                txtcontractno.Text = ""
                'Changes add to add column contract no (Murtaza) (11/15/2022)
                companyinitials = ""
                'Rafay
                richTxtInternalRemarks.Text = "" ''TFS1864
                cmbUnit.SelectedIndex = 0
                'Me.cmbProject.SelectedIndex = 0 'Comment against task:2427
                If Me.cmbSalesMan.SelectedIndex > 1 Then Me.cmbSalesMan.SelectedIndex = 1
                Me.cmbPo.Enabled = True
                txtPaid.Text = ""
                txtAmount.Text = ""
                txtTotal.Text = ""
                txtTotalQty.Text = ""
                txtBalance.Text = ""
                txtPackQty.Text = 1
                Me.uitxtBiltyNo.Text = ""
                Me.BtnSave.Text = "&Save"
                Me.txtPONo.Text = GetDocumentNo() 'GetNextDocNo("SI" & Me.cmbCompany.SelectedValue, 6, "SalesMasterTable", "SalesNo")
                Me.ExistingBalance = 0D
                Me.txtAddTransitInsurance.Text = 0
                Me.txtTransitInsurancePercentage.Text = 0
                If Me.cmbVendor.Rows.Count > 1 Then Me.cmbVendor.Rows(1).Activate()
                ''Commented Against TFS4339
                ' If Me.cmbTransporter.Items.Count > 1 Then Me.cmbTransporter.SelectedIndex = 1
                Me.cmbTransporter.SelectedIndex = 0
                Me.txtBarcodescan.Focus()
                DisplayRecord()
                GetSecurityRights()
                'If Not GetConfigValue("ServiceItem").ToString = "True" Then
                If flgLoadAllItems = True Then
                    Me.DisplayDetail(-1, -1, "LoadAll")
                    'Me.LinkLabel1.Visible = False
                Else
                    'Me.LinkLabel1.Visible = True
                    'Me.LinkLabel1.Enabled = True
                    Me.DisplayDetail(-1)
                End If
                'Else
                '    Me.DisplayDetail(-1)
                'End If
                'GetSalesOrderAnalysis()
                'Me.CtrlGrdBar3_Load(Nothing, Nothing)
                'CtrlGrdBar2_Load(Nothing, Nothing)
                'Me.Mode = "Normal"
            End If

            DeliveryChalanId = 0
            Me.txtDcNo.Text = String.Empty
            EditCustomerListOnSale = getConfigValueByType("EditCustomerListOnSale").ToString
            If IsEditMode = True Then
                If EditCustomerListOnSale = "False" Then
                    Me.cmbVendor.Enabled = True
                Else
                    Me.cmbVendor.Enabled = False
                End If
            End If
            If Me.cmbBatchNo.Value = Nothing Then
                Me.cmbBatchNo.Enabled = False
            Else
                Me.cmbBatchNo.Enabled = True
            End If
            'ComboFillByEdit() R933 Commented
            '---------------- Receipt Voucher ---------------
            FillPaymentMethod()
            ' Me.cmbMethod.SelectedIndex = 0
            Me.cmbMethod.Enabled = True
            Me.cmbVendor.Enabled = True
            Me.txtChequeNo.Text = String.Empty
            Me.dtpChequeDate.Value = Date.Today
            Me.txtRecAmount.Text = String.Empty
            Me.txtVoucherNo.Text = GetVoucherNo()
            VoucherDetail(String.Empty)
            Adjustment = 0D
            If IsSalesOrderAnalysis = True Then
                Me.rbtAdjPercentage.Enabled = False
            Else
                Me.rbtAdjPercentage.Enabled = True
            End If
            If flgMultipleSalesOrder = True Then
                Me.btnLoad.Visible = True
            Else
                Me.btnLoad.Visible = False
            End If
            'Me.SplitContainer1.Panel2Collapsed = True
            '-------------------------------------------------
            ''16-Dec-2013 R934   M Ijaz Javed       Hide Buttons Edit,Delete and Print on Load Form
            Me.BtnEdit.Visible = False
            Me.BtnDelete.Visible = False
            Me.BtnPrint.Visible = False
            ''''''''''''''''''''''''''''''''''''''''''''''''''''
            Me.txtNetAmount.Text = String.Empty 'Task:2373 Clear Net Amount
            'Task:2427 CostCenter Selected Company Wise
            If Not Me.cmbCompany.SelectedIndex = -1 Then
                If Not Me.cmbProject.SelectedIndex = -1 Then Me.cmbProject.SelectedValue = Val(CType(Me.cmbCompany.SelectedItem, DataRowView).Row.Item("CostCenterId").ToString)
            End If
            'End Task:2427
            'Task:2677 Enabled/Disabled Controls
            If Not Me.cmbCompany.SelectedIndex = -1 Then
                blnCommercialInvoice = CType(Me.cmbCompany.SelectedItem, DataRowView).Row.Item("CommercialInvoice")
                If blnCommercialInvoice = True Then
                    Me.txtTax.Enabled = False
                    Me.grd.RootTable.Columns(EnumGridDetail.Tax).EditType = Janus.Windows.GridEX.EditType.NoEdit
                Else
                    Me.txtTax.Enabled = True
                    Me.grd.RootTable.Columns(EnumGridDetail.Tax).EditType = Janus.Windows.GridEX.EditType.TextBox
                End If
            End If
            'End Task:2677
            Dim StockOutConfigration As String = "" ''1596
            ''Start Task 1596
            If Not getConfigValueByType("StockOutConfigration").ToString = "Error" Then ''1596
                StockOutConfigration = getConfigValueByType("StockOutConfigration").ToString
            End If
            'ShowInformationMessage(StockOutConfigration)
            If StockOutConfigration.Equals("Disabled") Then
                Me.grd.RootTable.Columns("Batch No").Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).Visible = False
                Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.NoEdit
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).EditType = Janus.Windows.GridEX.EditType.NoEdit
            ElseIf StockOutConfigration.Equals("Enabled") Then
                Me.grd.RootTable.Columns("Batch No").Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).Visible = True
                Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.Combo
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).EditType = Janus.Windows.GridEX.EditType.CalendarDropDown
            Else
                Me.grd.RootTable.Columns("Batch No").Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).Visible = True
                Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.Combo
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).EditType = Janus.Windows.GridEX.EditType.CalendarDropDown
            End If
            ''End Task 1596
            ''Start TFS4161
            If IsAllowPDPEdit = False Then
                Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).EditType = Janus.Windows.GridEX.EditType.NoEdit
            Else
                Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).EditType = Janus.Windows.GridEX.EditType.TextBox
            End If
            ''End TFS4161
            Me.tbSalesDetail.SelectedTab = Me.tbSalesDetail.Tabs(0).TabPage.Tab
            Me.UltraTabControl2.SelectedTab = Me.UltraTabControl2.Tabs(0).TabPage.Tab
            Me.txtInvParty.Text = String.Empty 'TAsk:2681 Reseting Value
            'Task:2702 Reseting 
            'Rafay:Reseting value
            Me.txtPO.Text = String.Empty ' Reseting Value
            'rafay:task end
            'Changes add to add column contract no (Murtaza) (11/15/2022)
            txtcontractno.Text = String.Empty
            'Changes add to add column contract no (Murtaza) (11/15/2022)
            If Not Me.cmbCMFADoc.SelectedIndex = -1 Then Me.cmbCMFADoc.SelectedIndex = 0
            If blnCMFADocumentLoad = False Then
                Me.cmbCMFADoc.Enabled = False
            Else
                Me.cmbCMFADoc.Enabled = True
            End If
            'End Task:2702
            Me.txtVoucherNo.Text = GetVoucherNo()

            Me.txtDueDays.Text = String.Empty 'Task:2770 Reset Due Day Control.

            Me.txtJobCardId.Text = ""
            Me.txtJobCardNo.Text = ""
            Me.dtpJobCardDate.Value = Date.Now
            'Me.txtLeft.Text = ""
            Me.txtJobCardCustomer.Text = ""
            Me.txtVehicle.Text = ""
            Me.txtRegistrationNo.Text = ""
            Me.gbJobCard.Visible = False
            ModelId = 0
            Me.cmbInvType.SelectedIndex = 0I
            blnUpdateAll = False
            Me.btnUpdateAll.Enabled = True
            Me.cmbVendor.Enabled = True
            'Task#07072015 Select Not Sent value in cmbInvoiceStatus
            Me.cmbInvoiceStatus.Rows(0).Activate()
            'End Task#07072015
            'Added by Waqar Raza to Remove Bug reported by QA.
            'Start Task:
            'Dim id As Integer
            'id = Me.cmbItem.Value
            'FillCombo("Item")
            'Me.cmbItem.Value = id
            If Me.cmbVendor.Rows.Count > 0 Then cmbVendor.Rows(0).Activate()
            'End Task:
            '12-July-2017: Task # TFS1042: Waqar Raza: Added to check the radio button configuration based.
            'Start TFS1042:
            'show select first value of dropdown
            If Me.cmbItem.Rows.Count > 0 Then cmbItem.Rows(0).Activate()
            If getConfigValueByType("ItemFilterByName") = "True" Then
                Me.rdoName.Checked = True
            Else
                Me.RdoCode.Checked = True
            End If
            Me.txtRack.Text = ""
            'End TFS1042:
            'Edit Against Task# 2015072401  Allow Multiple printing for invoice Ali Ansari
            GrpPrint.Visible = False
            BtnPrintNew.Visible = False
            'Edit Against Task# 2015072401  Allow Multiple printing for invoice Ali Ansari
            Me.txtCurrentBalance.Text = String.Empty
            Me.txtTotalAmount.Text = String.Empty
            FillCombo("Currency")
            FillCombo("Item") '' 31-10-2017
            Me.cmbCurrency.SelectedValue = BaseCurrencyId
            Me.txtCurrencyRate.Enabled = False
            Me.dtpArrivalTime1.Value = Date.Now
            Me.dtpDepartureTime1.Value = Date.Now
            Me.dtpDepartureTime1.Checked = False
            'Change Againt TFS1153
            'Me.rbPer.Checked = True
            Me.cmbDiscountType.SelectedIndex = 1
            Me.txtTransCharges.Text = 0
            IsSOSeparateClosure = False
            'Ayesha Rehman : TFS2375 : Enable Approval History button only in Eidt Mode
            If IsEditMode = True Then
                Me.btnApprovalHistory.Visible = True
                Me.btnApprovalHistory.Enabled = True
            Else
                Me.btnApprovalHistory.Visible = False
            End If
            'Ayesha Rehman : TFS2375 : End
            ''Ayesha Rehman :TFS2375 :Making Approval Button Enable in Edit Mode
            If Not getConfigValueByType("SalesInvoiceApproval") = "Error" Then
                ApprovalProcessId = Val(getConfigValueByType("SalesInvoiceApproval"))
            End If
            If ApprovalProcessId = 0 Then
                Me.chkPost.Visible = True
                Me.chkPost.Enabled = True
                Me.chkDelivered.Visible = True
                Me.chkDelivered.Enabled = True
            Else
                Me.chkPost.Visible = False
                Me.chkPost.Enabled = False
                Me.chkPost.Checked = False
                Me.chkDelivered.Visible = False
                Me.chkDelivered.Enabled = False
                Me.chkDelivered.Checked = False
            End If
            ''Ayesha Rehman :TFS2375 :End
            ''Start TFS3520
            If Not getConfigValueByType("SeparateClosureOfSODC") = "Error" Then
                flgSOSeparateClosure = getConfigValueByType("SeparateClosureOfSODC")
            Else
                flgSOSeparateClosure = False
            End If

            If flgSOSeparateClosure = True Then
                btnLoadSOAndDC.Visible = True
                Me.pnlSO.Visible = False
                Me.pnlSOMove.Location = New Point(3, 83)
            Else
                btnLoadSOAndDC.Visible = False
                Me.pnlSO.Visible = True
                Me.pnlSOMove.Location = New Point(3, 144)
            End If
            ''End TFS3520
            ''TASK TFS4391
            Me.cmbRevisionNumber.Visible = False
            Me.lblRev.Visible = False
            Me.lnkLblRevisions.Visible = False
            ''END TASK TFS4391

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub ClearDetailControls()
        'cmbCategory.SelectedIndex = 0
        cmbUnit.SelectedIndex = 0
        txtQty.Text = ""
        txtRate.Text = ""
        txtTotal.Text = ""
        txtPackQty.Text = 1
        Me.txtTax.Text = ""
        Me.txtNetTotal.Text = ""    ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        Me.txtDisc.Text = ""        ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        Me.txtRate.Text = ""        ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        Me.txtPDP.Text = ""          ''11-Nov-2017   TFS1153    Ayesha Rehman    
        Me.txtDiscountValue.Text = ""        ''11-Nov-2017   TFS1153   Ayesha Rehamn   
        Me.txtPackRate.Text = ""
        Me.txtTotalQuantity.Text = "" ''TASK-408
        If IsAllowPDPEdit = True Then ''TFS4718 ,Check Wether PDP change Allowed or not
        Me.txtPDP.Enabled = True
        Else
            Me.txtPDP.Enabled = False
        End If
    End Sub
    ''Start TFS4868
    Private Sub ClearDetailControlsUponUnit()
        'cmbCategory.SelectedIndex = 0
        'cmbUnit.SelectedIndex = 0
        txtQty.Text = ""
        txtRate.Text = ""
        txtTotal.Text = ""
        txtPackQty.Text = 1
        Me.txtTax.Text = ""
        Me.txtNetTotal.Text = ""    ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        Me.txtDisc.Text = ""        ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        Me.txtRate.Text = ""        ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        Me.txtPDP.Text = ""          ''11-Nov-2017   TFS1153    Ayesha Rehman    
        Me.txtDiscountValue.Text = ""        ''11-Nov-2017   TFS1153   Ayesha Rehamn   
        Me.txtPackRate.Text = ""
        Me.txtTotalQuantity.Text = "" ''TASK-408
        If IsAllowPDPEdit = True Then ''TFS4718 ,Check Wether PDP change Allowed or not
            Me.txtPDP.Enabled = True
        Else
            Me.txtPDP.Enabled = False
        End If
    End Sub
    ''End TFS4868
    Private Function Validate_AddToGrid() As Boolean
        If cmbItem.ActiveRow.Cells(0).Value <= 0 Then
            msg_Error("Please select any item")
            cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        'If Not GetConfigValue("ServiceItem").ToString = "True" Then
        If flgLoadAllItems = False Then
            If Val(txtQty.Text) <= 0 Then
                msg_Error("Quantity is not greater than 0")
                txtQty.Focus() : Validate_AddToGrid = False : Exit Function
            End If
        End If
        'Change by murtaza default currency rate(10/26/2022) 
        If cmbCurrency.SelectedValue <> BaseCurrencyId AndAlso Val(txtCurrencyRate.Text) = 1 Then
            msg_Error(cmbCurrency.Text + "Currency Rate cannot be 1")
            txtCurrencyRate.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        'Change by murtaza default currency rate(10/26/2022)
        'Else
        '    If Val(txtServiceQty.Text) <= 0 Then
        '        msg_Error("Service Quantity must be greater than 0")
        '        txtServiceQty.Focus() : Validate_AddToGrid = False : Exit Function
        '    End If
        'End If

        If Val(txtRate.Text) <= 0 Then
            msg_Error("Rate is not greater than 0")
            txtRate.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        'Ayesha Rehman :TFS1154 : Check on Retail Price not to be negative
        If Val(txtRetailPrice.Text) < 0 Then
            msg_Error("RetailPrice is less than 0")
            txtRate.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        'Rafay :task Start
        If Val(txtTax.Text) < 0 Then
            msg_Error("Please select tax value ")
            txtTax.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        If Me.cmbTaxCategory.SelectedIndex = 0 Then
            msg_Error("Please select tax category ")
            cmbTaxCategory.Focus() : Exit Function
        End If
        'Rafay:task end

        If Val(Me.txtTotalQuantity.Text) <= 0 Then
            msg_Error("Total quantity more than 0 is required")
            txtTotalQuantity.Focus() : Validate_AddToGrid = False : Exit Function
        End If
        Dim flag As Boolean = False
        If blnTradePriceExceed = True Then
            If cmbItem.ActiveRow.Cells("Trade Price").Value > Val(txtRate.Text.Trim) Then
                ShowErrorMessage("Sale price is less than trade price")
                flag = True
                cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
                'End If
            End If
        End If
        ''Start TFS1663
        If getCustomerBottomSaleRate() > Val(txtRate.Text.Trim) Then
            ShowErrorMessage("Sale price is less than Bottom Sale Rate ")
            cmbItem.Focus() : Validate_AddToGrid = False : Exit Function

        End If
        ''End TFS1663
        If flag = False Then
            If cmbItem.ActiveRow.Cells("PurchasePrice").Value > Val(txtRate.Text.Trim) Then
                If Not msg_Confirm("Sale Price is less than purchase price..." & (Chr(13)) & "Do you want to add this item?") = True Then
                    cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
                End If
            End If
        End If
        Dim totalQuantity As Double = 0D
        If Me.cmbUnit.Text = "Pack" Then
            totalQuantity = Val(Me.txtQty.Text)
        Else
            totalQuantity = Val(Me.txtTotalQuantity.Text)
        End If
        'Before against task:2388
        'Dim IsMinus As Boolean = getConfigValueByType("AllowMinusStock")
        'Task:2388 Added Validate Service item
        Dim IsMinus As Boolean = True
        If CType(Me.cmbItem.SelectedRow, Infragistics.Win.UltraWinGrid.UltraGridRow).Cells("ServiceItem").Value = False Then
            IsMinus = getConfigValueByType("AllowMinusStock")

        End If
        'End Task:2388
        'If Not GetConfigValue("ServiceItem").ToString = "True" Then
        If StockChecked = False Then
            If Mode = "Normal" Then
                If Not IsMinus = True Then
                    'If CheckLocationWiseMinusStock(Me.cmbCategory.SelectedValue) = False Then
                    If Val(Me.txtStock.Text) <> Val(txtTotalQuantity.Text) Then
                        'If Val(Me.txtStock.Text) - IIf(Val(txtPackQty.Text) = 0, Val(Me.txtQty.Text), Val(txtPackQty.Text)) * Val(txtQty.Text) <= 0 Then
                        If Val(Me.txtStock.Text) - Val(totalQuantity) < 0 Then

                            'Altered agaisnt task#201506027 to allow equal qty to grid Ali Ansari
                            msg_Error(Me.cmbItem.ActiveRow.Cells("Item").Value.ToString & str_ErrorStockNotEnough)
                            cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
                        End If
                    End If
                    'End If
                    ' Return True 'Comment against task:2416
                    'If Val(Me.cmbItem.ActiveRow.Cells("Stock").Value) <= 0 Then
                    '    'If MsgBox("Stock does not exist against this item..." & (Chr(13)) & "Do u want to add this item...?", MsgBoxStyle.YesNo + MsgBoxStyle.Question, LoginUserName) = MsgBoxResult.No Then
                    '    '    cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
                    '    'Else
                    '    '    Return True
                    '    'End If
                    '    If Val(Me.cmbItem.ActiveRow.Cells("Stock").Value) < Val(txtQty.Text) Then
                    '        If MsgBox("Stock is not enough, you want to add against this item..." & (Chr(13)) & "Do u want to add this item...?", MsgBoxStyle.YesNo + MsgBoxStyle.Question, LoginUserName) = MsgBoxResult.No Then
                    '            txtQty.Focus() : Validate_AddToGrid = False : Exit Function
                    '        End If
                    '    End If
                    'End If
                    'Else 'Comment against task:2416
                    'If getConfigValueByType("StockViewOnSale").ToString = "True" Then
                    '    If Val(Me.cmbItem.ActiveRow.Cells("Stock").Value) <= 0 Then
                    '        msg_Error("Stock does not exist against this item")
                    '        cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
                    '    End If

                    '    If Val(Me.cmbItem.ActiveRow.Cells("Stock").Value) < Val(txtQty.Text) Then
                    '        msg_Error("Stock is not enough")
                    '        txtQty.Focus() : Validate_AddToGrid = False : Exit Function
                    '    End If
                    'Else

                End If
                If CType(Me.cmbCategory.SelectedItem, DataRowView).Row.Item("AllowMinusStock").ToString = "False" AndAlso IsMinus = True Then
                    'Marked agaisnt task#201506027 to allow equal qty to grid Ali Ansari
                    'If Val(Me.txtStock.Text) - IIf(Val(txtPackQty.Text) = 0, 1, Val(txtPackQty.Text)) * Val(txtQty.Text) <= 0 Then
                    'Marked agaisnt task#201506027 to allow equal qty to grid Ali Ansari
                    'Altered agaisnt task#201506027 to allow equal qty to grid Ali Ansari
                    'TASK18 Validation On Stock 
                    If Val(Me.txtStock.Text) <> Val(txtTotalQuantity.Text) Then
                        If Val(Me.txtStock.Text) - Val(totalQuantity) < 0 Then
                            'Altered agaisnt task#201506027 to allow equal qty to grid Ali Ansari
                            msg_Error(Me.cmbItem.ActiveRow.Cells("Item").Value.ToString & str_ErrorStockNotEnough)
                            cmbItem.Focus() : Validate_AddToGrid = False : Exit Function
                        End If
                    End If

                    'If Val(Me.txtStock.Text) < IIf(Val(txtPackQty.Text) = 0, 1, Val(txtPackQty.Text)) * Val(txtQty.Text) Then
                    '    msg_Error("Stock is not enough")
                    '    txtQty.Focus() : Validate_AddToGrid = False : Exit Function
                    'End If
                End If
            End If
        End If
        'End If
        Validate_AddToGrid = True
    End Function
    'Task:2681 Numeric Validation
    Private Sub txtQty_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtQty.KeyPress, txtRetailPrice.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681
    Private Sub txtQty_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs)
        'If Not GetConfigValue("ServiceItem").ToString = "True" Then
        'Commented against task:2367
        ' Before ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        'If Val(Me.txtPackQty.Text) = 0 Then
        '    'txtPackQty.Text = 1
        '    txtTotal.Text = Val(txtQty.Text) * Val(txtRate.Text) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'Else
        '    txtTotal.Text = ((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'End If
        ''Else
        ''If cmbUnit.SelectedIndex = 0 Then
        ''    txtPackQty.Text = 1
        ''    txtTotal.Text = Val(txtServiceQty.Text) * Val(txtRate.Text)
        ''Else
        ''    txtTotal.Text = Val(txtServiceQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
        ''End If
        ''End If

        ' After ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        'Dim db As Double = 0D
        'If Val(Me.txtPackQty.Text) = 0 Or Val(Me.txtPackQty.Text) = 1 Then
        '    db = Val(Me.txtQty.Text) * Val(Me.txtRate.Text)
        '    Me.txtTotal.Text = Math.Round(db, 2).ToString()
        '    ' For Minus Disc %
        '    Dim discount As Double = 0D
        '    'Before against Task:2367
        '    'If Val(Me.txtDisc.Text) > 0  Then
        '    'Task:2367 Change Validation
        '    If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '        discount = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
        '        Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(discount, 2).ToString()
        '    End If
        '    'Calculate Tax
        '    'Before against task:2367
        '    'If Val(Me.txtTax.Text) > 0 Then
        '    'Task:2367 Change Validation
        '    If Val(Me.txtTax.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '        db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
        '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
        '    Else
        '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
        '    End If
        'Else
        '    db = Val(Me.txtPackQty.Text) * Val(Me.txtQty.Text) * Val(Me.txtRate.Text)
        '    Me.txtTotal.Text = Math.Round(db, 2).ToString()
        '    ' For Minus Disc %
        '    Dim discount As Double = 0D
        '    'Before against task:2367
        '    'If Val(Me.txtDisc.Text) > 0 Then
        '    'Task:2367 Change Validation
        '    If Val(Me.txtDisc.Text) > 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '        discount = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
        '        Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(discount, 2).ToString()
        '    End If
        '    'Calculate Tax
        '    'Before against task:2367
        '    'If Val(Me.txtTax.Text) > 0 Then
        '    'Task:2367 Change Validation
        '    If Val(Me.txtTax.Text) > 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '        db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
        '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
        '    Else
        '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
        '    End If

        'End If
        'End Task : 2367
        '''''''''''''''''''''''''''''''''''''''''''''''''

        If IsSalesOrderAnalysis = True Then
            If Val(Me.txtDisc.Text) <> 0 Then
                Me.txtDisc.TabStop = True
            End If
        End If

        'Task:2367 Change Total
        'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtQty.Text) <> 0 AndAlso Val(Me.txtRate.Text) = 0 Then
        '    Me.txtRate.Text = Val(Me.txtTotal.Text) / Val(Me.txtQty.Text)
        'Else
        '    If Val(Me.txtPackQty.Text) = 0 Then
        '        txtPackQty.Text = 1
        '        txtTotal.Text = Val(txtQty.Text) * Val(txtRate.Text)
        '    Else
        '        txtTotal.Text = Val(txtQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
        '    End If
        'End If

        'If Val(Me.txtPackQty.Text) = 0 Then
        '    txtPackQty.Text = 1
        '    txtNetTotal.Text = Val(txtQty.Text) * Val(txtRate.Text) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'Else
        '    txtNetTotal.Text = ((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'End If
        'End Task:2367

        Try
            'If Me.txtPackRate.Text.Length > 0 AndAlso Val(Me.txtPackRate.Text) > 0 Then
            '    If Me.cmbUnit.Text <> "Loose" Then
            '        Me.txtRate.Text = ((Val(Me.txtPackRate.Text)) / Val(Me.txtPackQty.Text))
            '    End If
            'End If
            'If Val(Me.txtPackQty.Text) > 0 Then
            '    Me.txtTotalQuantity.Text = Val(Me.txtPackQty.Text) * Val(Me.txtQty.Text)
            'Else
            '    Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
            'End If
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try

    End Sub
    'Task:2681 Numeric Validation
    Private Sub txtRate_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtRate.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681
    Private Sub txtRate_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs)

        'If Not GetConfigValue("ServiceItem").ToString = "True" Then
        'If cmbUnit.SelectedIndex = 0 Then
        '    txtPackQty.Text = 1
        '    txtTotal.Text = Val(txtQty.Text) * Val(txtRate.Text)
        'Else
        '    txtTotal.Text = Val(txtQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
        'End If

        'Commented against task:2367
        ' Before  ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        'If Val(Me.txtPackQty.Text) = 0 Then
        '    'txtPackQty.Text = 1
        '    txtTotal.Text = (Val(txtQty.Text) * Val(txtRate.Text)) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'Else
        '    txtTotal.Text = ((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'End If

        ' After ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
        'If Val(Me.txtRate.Text) > 0 And Val(Me.txtQty.Text) > 0 Then
        '    If Val(Me.txtPackQty.Text) = 0 Or Val(Me.txtPackQty.Text) = 1 Then
        '        Me.txtTotal.Text = Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
        '        ' For Minus Disc %
        '        Dim db As Double = 0D
        '        'Before against task:2367
        '        'If Val(Me.txtDisc.Text) > 0 Then
        '        'Task:2367 Change Validation
        '        If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
        '            Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(db, 2).ToString()
        '        End If
        '        'Calculate Tax
        '        'Before against task:2367
        '        'If Val(Me.txtTax.Text) > 0 Then
        '        'Task:2367 Change Validation
        '        If Val(Me.txtTax.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
        '        Else
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
        '        End If
        '    Else
        '        Me.txtTotal.Text = Val(Me.txtPackQty.Text) * Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
        '        ' For Minus Disc %
        '        Dim db As Double = 0D
        '        'Before against task:2367
        '        'If Val(Me.txtDisc.Text) > 0 Then
        '        'Task:2367 Change Validation
        '        If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
        '            Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(db, 2).ToString()
        '        End If
        '        'Calculate Tax
        '        'Before against task:2367
        '        'If Val(Me.txtTax.Text) > 0 Then
        '        'Task:2367 Change Validation
        '        If Val(Me.txtTax.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
        '        Else
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
        '        End If
        '    End If
        'Else
        '    If Val(Me.txtPackQty.Text) = 0 Or Val(Me.txtPackQty.Text) = 1 Then
        '        Me.txtTotal.Text = Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
        '        ' For Minus Disc %
        '        Dim db As Double = 0D
        '        'Before against task:2367
        '        'If Val(Me.txtDisc.Text) > 0 Then
        '        'Task:22367 Change Validation 
        '        If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
        '            Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(db, 2).ToString()
        '        End If
        '        'Calculate Tax
        '        'Before against task:2367
        '        'If Val(Me.txtDisc.Text) > 0 Then
        '        'Task:22367 Change Validation 
        '        If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
        '        Else
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
        '        End If
        '    Else
        '        Me.txtTotal.Text = Val(Me.txtPackQty.Text) * Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
        '        ' For Minus Disc %
        '        Dim db As Double = 0D
        '        'Before against task:2367
        '        'If Val(Me.txtDisc.Text) > 0 Then
        '        'Task:22367 Change Validation 
        '        If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
        '            Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(db, 2).ToString()
        '        End If
        '        'Calculate Tax
        '        'Before against task:2367
        '        'If Val(Me.txtDisc.Text) > 0 Then
        '        'Task:22367 Change Validation 
        '        If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
        '            db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
        '        Else
        '            Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
        '        End If
        '    End If
        'End If
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        'Else
        'If cmbUnit.SelectedIndex = 0 Then
        '    txtPackQty.Text = 1
        '    txtTotal.Text = Val(txtServiceQty.Text) * Val(txtRate.Text)
        'Else
        '    txtTotal.Text = Val(txtServiceQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
        'End If
        'End If
        'Task:2367 Change Total
        'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtQty.Text) = 0 Then
        '    Me.txtQty.Text = Math.Round((Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)), 2)
        'Else
        '    If Val(Me.txtPackQty.Text) = 0 Then
        '        txtPackQty.Text = 1
        '        txtTotal.Text = Val(txtQty.Text) * Val(txtRate.Text)
        '    Else
        '        txtTotal.Text = Val(txtQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
        '    End If
        'End If

        'If Val(Me.txtQty.Text) <> 0 AndAlso Val(Me.txtTotal.Text) = 0 Then
        '    If Val(Me.txtPackQty.Text) = 0 Then
        '        txtPackQty.Text = 1
        '        txtTotal.Text = Val(txtQty.Text) * Val(txtRate.Text)
        '    Else
        '        txtTotal.Text = Val(txtQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
        '    End If
        'End If

        'If Val(Me.txtPackQty.Text) = 0 Then
        '    txtPackQty.Text = 1
        '    txtNetTotal.Text = Val(txtQty.Text) * Val(txtRate.Text) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'Else
        '    txtNetTotal.Text = ((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
        'End If
        'End Task:2367
        Try
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub


    Private Sub cmbUnit_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbUnit.SelectedIndexChanged
        ' ''get the qty in case of pack unit
        ''If Not GetConfigValue("ServiceItem").ToString = "True" Then
        'If Me.cmbUnit.SelectedIndex < 0 Then Me.txtPackQty.Text = String.Empty : Exit Sub
        'If Me.cmbUnit.Text = "Loose" Then
        '    txtTotal.Text = Math.Round(Val(txtTotalQuantity.Text) * Val(txtRate.Text), DecimalPointInValue)
        '    txtPackQty.Text = 1
        '    txtPackQty.TabStop = False
        '    txtPackQty.Enabled = False
        'Else
        '    'Dim objCommand As New OleDbCommand
        '    'Dim objCon As OleDbConnection
        '    'Dim objDataAdapter As New OleDbDataAdapter
        '    'Dim objDataSet As New DataSet

        '    'objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

        '    'If objCon.State = ConnectionState.Open Then objCon.Close()

        '    'objCon.Open()
        '    'objCommand.Connection = objCon
        '    'objCommand.CommandType = CommandType.Text


        '    'objCommand.CommandText = "Select ISNULL(PackQty,0) as PackQty from ArticleDefTable where ArticleID = " & cmbItem.Value 'cmbItem.ActiveRow.Cells(0).Value
        '    'txtPackQty.Text = objCommand.ExecuteScalar()
        '    If TypeOf Me.cmbUnit.SelectedItem Is DataRowView Then
        '        Me.txtPackQty.Text = Val(CType(Me.cmbUnit.SelectedItem, DataRowView).Item("PackQty").ToString)
        '    End If
        '    'txtTotal.Text = Val(txtQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
        '    'txtTotal.Text = ((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)

        '    txtPackQty.TabStop = True
        '    txtPackQty.Enabled = True

        'End If
        ''Else
        ''    If cmbUnit.SelectedIndex = 0 Then
        ''        txtTotal.Text = Val(txtServiceQty.Text) * Val(txtRate.Text)
        ''        txtPackQty.Text = 1
        ''        txtPackQty.TabStop = False
        ''        txtPackQty.Enabled = False
        ''    Else
        ''        Dim objCommand As New OleDbCommand
        ''        Dim objCon As OleDbConnection
        ''        Dim objDataAdapter As New OleDbDataAdapter
        ''        Dim objDataSet As New DataSet

        ''        objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

        ''        If objCon.State = ConnectionState.Open Then objCon.Close()

        ''        objCon.Open()
        ''        objCommand.Connection = objCon
        ''        objCommand.CommandType = CommandType.Text


        ''        objCommand.CommandText = "Select PackQty from ArticleDefTable where ArticleID = " & cmbItem.Value 'cmbItem.ActiveRow.Cells(0).Value

        ''        txtPackQty.Text = objCommand.ExecuteScalar()

        ''        'txtTotal.Text = Val(txtServiceQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)

        ''        txtPackQty.TabStop = True
        ''        txtPackQty.Enabled = True
        ''    End If
        ''End If
        ''get the qty in case of pack unit
        'If Not GetConfigValue("ServiceItem").ToString = "True" Then
        If Me.cmbUnit.SelectedIndex < 0 Then Me.txtPackQty.Text = String.Empty : Exit Sub
        If Me.cmbUnit.Text = "Loose" Then
            'TASKM22815
            'txtTotal.Text = Math.Round(Val(txtQty.Text) * Val(txtRate.Text), DecimalPointInValue)
            txtPackQty.Text = 1
            txtPackQty.TabStop = False
            txtPackQty.Enabled = False
            Me.txtTotalQuantity.Enabled = False
            Me.txtPackRate.Enabled = False
            If IsAllowPDPEdit = True Then ''TFS4718 ,Check Wether PDP change Allowed or not
            Me.txtPDP.Enabled = True ''TFS3330
            Else
                Me.txtPDP.Enabled = False
            End If
            'ClearDetailControls() ''TFS3330 : Reset controls when unit change to loose 
            ClearDetailControlsUponUnit()
            Me.txtPDP.Text = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString 'TFS3330
            Dim StrSQl As String = "" ''TFS3330 : Ayesha Rehman
            If Me.cmbVendor.ActiveRow.Cells(0).Value > 0 Then
                If Me.cmbItem.ActiveRow.Cells(0).Value > 0 Then
                    If getConfigValueByType("ApplyFlatDiscountOnSale").ToString = "False" Then
                        StrSQl = "select discount from tbldefcustomerbasediscounts where articledefid = " & Me.cmbItem.ActiveRow.Cells(0).Value _
                        & " and typeid = " & Me.cmbVendor.ActiveRow.Cells("typeid").Value & "  and discount > 0 "
                        Dim dtdiscount As DataTable = GetDataTable(StrSQl)
                        dtdiscount.AcceptChanges()

                        If Not dtdiscount Is Nothing Then
                            If dtdiscount.Rows.Count <> 0 Then

                                Dim disc As Double = 0D
                                Double.TryParse(dtdiscount.Rows(0)(0).ToString, disc)

                                Dim price As Double = 0D
                                'Ayesha Tip
                                Double.TryParse(Me.txtRate.Text, price)
                                Double.TryParse(Me.txtPDP.Text, price) 'TFS1153
                                Me.txtRate.Text = price - ((price / 100) * disc)
                                Me.txtPDP.Text = price - ((price / 100) * disc) 'TFS1153
                                Me.txtDisc.TabStop = False
                            Else
                                If IsSalesOrderAnalysis = True Then
                                    Me.txtDisc.TabStop = True
                                End If
                            End If
                        End If
                    Else

                        StrSQl = "select discount from tbldefcustomerbasediscountsFlat where articledefid = " & Me.cmbItem.ActiveRow.Cells(0).Value _
                                              & " and typeid = " & Me.cmbVendor.ActiveRow.Cells("typeid").Value & "  and discount > 0 "
                        Dim dtdiscountFlat As DataTable = GetDataTable(StrSQl)
                        dtdiscountFlat.AcceptChanges()


                        If Not dtdiscountFlat Is Nothing Then
                            If dtdiscountFlat.Rows.Count <> 0 Then

                                Dim disc As Double = 0D
                                Double.TryParse(dtdiscountFlat.Rows(0)(0).ToString, disc)

                                Dim price As Double = 0D
                                Double.TryParse(Me.txtRate.Text, price)
                                Double.TryParse(Me.txtPDP.Text, price) 'TFS1153
                                Dim dblDiscountPercent As Double = 0D
                                If disc > 0 Then
                                    dblDiscountPercent = (disc / price) * 100

                                    If price > 0 Then
                                        Me.txtRate.Text = price - ((price / 100) * dblDiscountPercent)
                                        Me.txtPDP.Text = price - ((price / 100) * dblDiscountPercent) 'TFS1153
                                        Me.txtDisc.TabStop = False
                                    Else
                                        Me.txtRate.Text = Me.txtRate.Text
                                        Me.txtPDP.Text = Me.txtPDP.Text 'TFS1153
                                        Me.txtDisc.TabStop = True
                                    End If
                                Else
                                    dblDiscountPercent = 0
                                    Me.txtDisc.TabStop = True
                                End If
                            End If
                        End If
                    End If
                End If
            End If

            If Val(Me.txtQty.Text) <= 0 Then
                Me.txtQty.Text = 1
                Me.txtTotalQuantity.Text = 1
            End If
        Else
            If TypeOf Me.cmbUnit.SelectedItem Is DataRowView Then
                Me.txtPackQty.Text = Val(CType(Me.cmbUnit.SelectedItem, DataRowView).Item("PackQty").ToString)
                If Val(CType(Me.cmbUnit.SelectedItem, DataRowView).Item("PackRate").ToString) = 1 Then
                    txtPackRate.Text = 0
                Else
                    txtPackRate.Text = Val(CType(Me.cmbUnit.SelectedItem, DataRowView).Item("PackRate").ToString)
                End If ''TFS1964
                'If txtPackRate.Text = 1 Then
                '    txtPackRate.Text = 0
                '    'txtRate.Text = 0
                'End If
            End If
            ''Start TFS4161
            If IsPackQtyDisabled = True Then
                txtPackQty.TabStop = False
                txtPackRate.TabStop = False
                txtPackQty.Enabled = False
                Me.txtTotalQuantity.Enabled = False
                Me.txtPackRate.Enabled = False
            Else
                txtPackQty.TabStop = True
                txtPackRate.TabStop = True ''TFS1964
                txtPackQty.Enabled = True
                Me.txtTotalQuantity.Enabled = True
                Me.txtPackRate.Enabled = True
            End If
            ''End TFS4161
        End If
        'TASKM22815
        ' GetDetailTotal() ''TFS4614
        'Task#02092015 getting stock by Loose/Pack separately by ahmad sharif
        Me.txtStock.Text = Convert.ToDouble(GetStockById(Me.cmbItem.ActiveRow.Cells(0).Value, Me.cmbCategory.SelectedValue, IIf(Me.cmbUnit.Text = "Loose", "Loose", "Pack")))

    End Sub


    Private Sub AddItemToGrid()
        'If Not Me.cmbPo.SelectedIndex > 0 Then
        'If Not Val(Me.txtTax.Text) > 0 


        If IsSalesOrderAnalysis = True Then
            If GST_Applicable = True Then
                If SalesTax_Percentage = 0 Then SalesTax_Percentage = DefaultTax
            ElseIf FlatRate_Applicable = True Then
                If SalesTax_Percentage = 0 Then SalesTax_Percentage = ((FlatRate / Val(Me.cmbItem.SelectedRow.Cells("Price").Text)) * 100)
            End If
        Else
            SalesTax_Percentage = Val(Me.txtTax.Text)

        End If

        Dim dblPurchasePrice As Double = 0D
        Dim dblCostPrice As Double = 0D

        Dim strPriceData() As String = GetRateByItem(Me.cmbItem.Value).Split(",")

        If strPriceData.Length > 1 Then
            dblCostPrice = Val(strPriceData(0).ToString)
            dblPurchasePrice = Val(strPriceData(1).ToString)

            If dblCostPrice = 0 Then
                dblCostPrice = dblPurchasePrice
            End If

        End If


        'Else
        'SalesTax_Percentage = Val(Me.txtTax.Text)
        'End If
        ' If (Val(Me.txtStock.Text) >= 0 Or Val(Me.txtStock.Text)) <= 0 Then

        ''Commented below lines against TASK : TFS1357
        Dim qty As Double = 0D
        Dim qty1 As Double = 0D
        Dim totalQty As Double = 0D
        Dim stockQty As Double = 0D
        Dim qtyLrgThnStock As Double = 0D
        Dim frstTotalQty As Double = 0D
        Dim scndTotalQty As Double = 0D
        Dim frstQty As Double = 0D
        Dim scndQty As Double = 0D
        Dim packQty As Double = 0D
        Dim totalQuantity As Decimal = 0D
        'Dim qty As Decimal = 0
        'Dim qty1 As Decimal = 0
        'Dim totalQty As Decimal = 0
        'Dim stockQty As Decimal = 0
        'Dim qtyLrgThnStock As Decimal = 0
        'Dim frstTotalQty As Decimal = 0
        'Dim scndTotalQty As Decimal = 0
        'Dim frstQty As Decimal = 0
        'Dim scndQty As Decimal = 0
        'Dim packQty As Decimal = 0
        'Dim totalQuantity As Decimal = 1D


        'FormatNumber(totalQty, 3)
        Dim dtGrid As DataTable = CType(Me.grd.DataSource, DataTable)
        dtGrid.AcceptChanges()
        Dim drNewItem As DataRow
        If Me.cmbUnit.Text = "Pack" Then
            'totalQuantity = Val(Me.txtQty.Text)
            totalQuantity = Convert.ToDecimal(Me.txtQty.Text)
        Else
            totalQuantity = Convert.ToDecimal(Me.txtTotalQuantity.Text)
            'Dim totalQuantity1 As Decimal = CDec(Me.txtTotalQuantity.Text)
            'Dim stFormatNumber As Double = FormatNumber(totalQuantity, DecimalPointInQty)
        End If

        If Val(totalQuantity) > Val(Me.txtStock.Text) AndAlso Val(Me.txtStock.Text) > 0 Then
            If Me.cmbUnit.Text = "Pack" Then
                'qty = Val(Me.txtTotalQuantity.Text) - (Val(Me.txtStock.Text) * Val(Me.txtPackQty.Text))
                'qtyLrgThnStock = Val(Me.txtTotalQuantity.Text) - (Val(Me.txtStock.Text) * Val(Me.txtPackQty.Text))
                qty = Math.Round(Convert.ToDecimal(Me.txtTotalQuantity.Text) - (Convert.ToDecimal(Me.txtStock.Text) * Convert.ToDecimal(Me.txtPackQty.Text)), TotalAmountRounding)
                qtyLrgThnStock = Math.Round(Convert.ToDecimal(Me.txtTotalQuantity.Text) - (Convert.ToDecimal(Me.txtStock.Text) * Convert.ToDecimal(Me.txtPackQty.Text)), TotalAmountRounding)
            Else
                'qty = Val(Me.txtTotalQuantity.Text) - Val(Me.txtStock.Text)
                'qtyLrgThnStock = Val(Me.txtTotalQuantity.Text) - Val(Me.txtStock.Text)
                qty = Math.Round(Convert.ToDecimal(Me.txtTotalQuantity.Text) - Convert.ToDecimal(Me.txtStock.Text), TotalAmountRounding)
                qtyLrgThnStock = Math.Round(Convert.ToDecimal(Me.txtTotalQuantity.Text) - Convert.ToDecimal(Me.txtStock.Text), TotalAmountRounding)
            End If
            frstTotalQty = Convert.ToDecimal(Me.txtTotalQuantity.Text) - qtyLrgThnStock
            scndTotalQty = qtyLrgThnStock
            packQty = Convert.ToDecimal(Me.txtPackQty.Text)
            frstQty = frstTotalQty / packQty
            scndQty = scndTotalQty / packQty
            qty1 = Convert.ToDecimal(Me.txtQty.Text)
            stockQty = Val(Me.txtStock.Text)
            Me.cmbItem.ActiveRow.Cells("Stock").Value = 0
        ElseIf Val(Me.txtStock.Text) > 0 Then
            Me.cmbItem.ActiveRow.Cells("Stock").Value = Me.cmbItem.ActiveRow.Cells("Stock").Value - Val(Me.txtTotalQuantity.Text)
        Else
            qty = Convert.ToDecimal(Me.txtQty.Text)
        End If
        If StockChecked Then
            drNewItem = dtGrid.NewRow()
            'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
            drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
            'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
            ''TASK TFS1561
            If IsKeyDownCalled = False Then
                drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
            Else
                drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
            End If
            '' END TASK TFS1561
            drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
            drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString ''TFS1596
            drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
            drNewItem("Origin") = Me.SOOrigin
            drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString)
            'drNewItem(EnumGridDetail.Qty) = Val(txtQty.Text) ''IIf(Val(Me.txtStock.Text) < Val(txtQty.Text), Me.txtStock.Text, txtQty.Text)
            drNewItem(EnumGridDetail.Qty) = Convert.ToDecimal(txtQty.Text) ''IIf(Val(Me.txtStock.Text) < Val(txtQty.Text), Me.txtStock.Text, txtQty.Text)
            drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
            'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
            'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
            'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
            ''TASK TFS1561
            If IsKeyDownCalled = False Then
                drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
            Else
                drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
            End If
            '' END TASK TFS1561
            drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
            drNewItem(EnumGridDetail.CurrentPrice) = Me.cmbItem.ActiveRow.Cells("Price").Value
            drNewItem(EnumGridDetail.SaleDetailID) = 0
            drNewItem(EnumGridDetail.SavedQty) = 0
            drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
            drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
            drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
            drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage '0
            drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
            drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
            drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
            'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
            drNewItem(EnumGridDetail.SampleQty) = SchemeQty
            'drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
            'Change Againt TFS1153 
            'If rbPer.Checked = True Then
            '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
            '    drNewItem(EnumGridDetail.FlatDiscount) = 0
            'Else
            '    ''
            '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
            '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
            '    ''
            'End If

            'TFS1153
            If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
            ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                ''
                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
            Else

                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                ''
            End If

            drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
            'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153


            drNewItem(EnumGridDetail.Freight) = Freight
            drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
            drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
            'drNewItem(EnumGridDetail.LoadQty) =LoadQty
            drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))
            drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
            drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
            drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
            drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
            drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
            drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
            drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
            drNewItem(EnumGridDetail.Comments) = strComments
            drNewItem(EnumGridDetail.OtherComments) = strOtherComments
            drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
            drNewItem(EnumGridDetail.Gross_Weights) = 0
            drNewItem(EnumGridDetail.Tray_Weights) = 0
            drNewItem(EnumGridDetail.Net_Weight) = 0

            ''
            drNewItem(EnumGridDetail.BardanaDeduction) = 0
            drNewItem(EnumGridDetail.OtherDeduction) = 0
            drNewItem(EnumGridDetail.AfterDeductionQty) = 0

            drNewItem(EnumGridDetail.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text) ''Val(Me.txtTotalQuantity.Text)
            drNewItem(EnumGridDetail.SODetailId) = soDetailId
            'drNewItem(EnumGridDetail.SO_ID) = soID
            drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
            drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
            If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
            Else
                drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
            End If
            drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
            Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
            If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
            End If
            'drNewItem(EnumGridDetail.Debit) = IIf(Me.txtDebit.Text = "", 0, Val(Me.txtDebit.Text) * Val(Me.txtCurrencyRate.Text))
            'drNewItem(EnumGridDetail.Credit) = IIf(Me.txtCredit.Text = "", 0, Val(Me.txtCredit.Text) * Val(Me.txtCurrencyRate.Text))
            drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
            drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
            dtGrid.Rows.Add(drNewItem)
        Else
            If Val(totalQuantity) > Val(Me.txtStock.Text) AndAlso Val(Me.txtStock.Text) > 0 Then
                'grd.AddItem(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value, cmbUnit.Text, IIf(Val(Me.txtStock.Text) < Val(txtQty.Text), Me.txtStock.Text, txtQty.Text), txtRate.Text, Val(txtTotal.Text), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                drNewItem = dtGrid.NewRow()
                'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                ''TASK TFS1561
                If IsKeyDownCalled = False Then
                    drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                Else
                    drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                End If
                '' END TASK TFS1561
                drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo 'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
                drNewItem("Origin") = Me.SOOrigin
                drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString)
                'drNewItem(EnumGridDetail.Qty) = frstQty ''IIf(Val(Me.txtStock.Text) < Val(txtQty.Text), Me.txtStock.Text, txtQty.Text)
                drNewItem(EnumGridDetail.Qty) = CDec(FormatNumber(frstQty, DecimalPointInQty))
                drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                ''TASK TFS1561
                If IsKeyDownCalled = False Then
                    drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                Else
                    drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                End If
                '' END TASK TFS1561
                drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
                drNewItem(EnumGridDetail.CurrentPrice) = Me.cmbItem.ActiveRow.Cells("Price").Value
                drNewItem(EnumGridDetail.SaleDetailID) = 0
                drNewItem(EnumGridDetail.SavedQty) = 0
                drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage '0
                drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                drNewItem(EnumGridDetail.SampleQty) = SchemeQty

                'Change Againt TFS1153 
                ' ''TFS1153 Added flat discount optional 
                'If rbPer.Checked = True Then
                '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                'Else
                '    ''
                '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                '    ''
                'End If
                ' ''End TASK TFS1153

                'TFS1153
                If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                    drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                    drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                    drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                    drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                    ''
                    drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                    drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                    drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue   'TFS1153
                    drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                    ''
                Else

                    drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                    drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                    drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                    drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                End If
                drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153


                drNewItem(EnumGridDetail.Freight) = Freight
                drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                'drNewItem(EnumGridDetail.LoadQty) = Convert.ToDecimal(LoadQty)
                drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))
                drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                drNewItem(EnumGridDetail.Comments) = strComments
                drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                drNewItem(EnumGridDetail.Gross_Weights) = 0
                drNewItem(EnumGridDetail.Tray_Weights) = 0
                drNewItem(EnumGridDetail.Net_Weight) = 0
                ''
                drNewItem(EnumGridDetail.BardanaDeduction) = 0
                drNewItem(EnumGridDetail.OtherDeduction) = 0
                drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                drNewItem(EnumGridDetail.TotalQty) = CDec(FormatNumber(frstTotalQty, DecimalPointInQty)) ''Val(Me.txtTotalQuantity.Text)
                drNewItem(EnumGridDetail.SODetailId) = soDetailId
                'drNewItem(EnumGridDetail.SO_ID) = soID
                drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                    drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                Else
                    drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                End If
                drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                    drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                    drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                End If
                'drNewItem(EnumGridDetail.Debit) = IIf(Me.txtDebit.Text = "", 0, Val(Me.txtDebit.Text) * Val(Me.txtCurrencyRate.Text))
                'drNewItem(EnumGridDetail.Credit) = IIf(Me.txtCredit.Text = "", 0, Val(Me.txtCredit.Text) * Val(Me.txtCurrencyRate.Text))
                drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                dtGrid.Rows.Add(drNewItem)
            End If

            If Val(Me.txtStock.Text) > 0 AndAlso Val(totalQuantity) <= Val(Me.txtStock.Text) Then
                'grd.AddItem(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value, cmbUnit.Text, IIf(Val(Me.txtStock.Text) < Val(txtQty.Text), Me.txtStock.Text, txtQty.Text), txtRate.Text, Val(txtTotal.Text), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                drNewItem = dtGrid.NewRow()
                'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                ''TASK TFS1561
                If IsKeyDownCalled = False Then
                    drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                Else
                    drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                End If
                '' END TASK TFS1561
                drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1))
                drNewItem("Origin") = Me.SOOrigin
                drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString)
                drNewItem(EnumGridDetail.Qty) = IIf(Val(Me.txtStock.Text) < Val(txtQty.Text), Me.txtStock.Text, Convert.ToDecimal(txtQty.Text))
                drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                ''TASK TFS1561
                If IsKeyDownCalled = False Then
                    drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                Else
                    drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                End If
                '' END TASK TFS1561
                drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
                drNewItem(EnumGridDetail.CurrentPrice) = Me.cmbItem.ActiveRow.Cells("Price").Value
                drNewItem(EnumGridDetail.SaleDetailID) = 0
                drNewItem(EnumGridDetail.SavedQty) = 0
                drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage '0
                drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                drNewItem(EnumGridDetail.SampleQty) = SchemeQty
                'drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage

                'Change Againt TFS1153 
                ' ''
                'If rbPer.Checked = True Then
                '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                'Else
                '    ''
                '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                '    ''
                'End If
                ''
                'TFS1153
                If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                    drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                    'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                    drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue   'TFS1153
                    drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                    ''
                    drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                    'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                    drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                    drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                    ''
                Else

                    drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                    'drNewItem(EnumGridDetail.DiscountType) = ""
                    drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153 'TFS1153
                    drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                End If


                drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153


                drNewItem(EnumGridDetail.Freight) = Freight
                drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                'drNewItem(EnumGridDetail.LoadQty) = Val(LoadQty)
                drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))
                drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                drNewItem(EnumGridDetail.Comments) = strComments
                drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                drNewItem(EnumGridDetail.Gross_Weights) = 0
                drNewItem(EnumGridDetail.Tray_Weights) = 0
                drNewItem(EnumGridDetail.Net_Weight) = 0
                ''
                drNewItem(EnumGridDetail.BardanaDeduction) = 0
                drNewItem(EnumGridDetail.OtherDeduction) = 0
                drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                drNewItem(EnumGridDetail.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
                drNewItem(EnumGridDetail.SODetailId) = soDetailId
                'drNewItem(EnumGridDetail.SO_ID) = soID
                drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                    drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                Else
                    drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                End If
                drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                    drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                    drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                End If
                drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                dtGrid.Rows.Add(drNewItem)
            End If



            ' If Me.cmbBatchNo.ActiveRow.Cells("Stock").Value < Val(Me.txtQty.Text) Then
            Dim dt As DataTable = CType(Me.cmbBatchNo.DataSource, DataTable)
            If Not dt Is Nothing AndAlso dt.Rows.Count > 0 Then
                For i As Integer = 0 To dt.Rows.Count - 2
                    If Me.cmbBatchNo.ActiveRow.Index <> i Then
                        If dt.Rows(i)("Stock") > 0 And dt.Rows(i)("Stock") < qty Then
                            'grd.AddItem(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, dt.Rows(i)("Batch No").ToString, cmbUnit.Text, dt.Rows(i)("Stock"), txtRate.Text, Val(dt.Rows(i)("Stock")) * Val(txtRate.Text), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                            drNewItem = dtGrid.NewRow()
                            'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                            drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                            'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                            ''TASK TFS1561
                            If IsKeyDownCalled = False Then
                                drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                            Else
                                drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                            End If
                            '' END TASK TFS1561
                            drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                            drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                            drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate ' Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
                            drNewItem("Origin") = Me.SOOrigin
                            drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString) 'cmbUnit.Text
                            drNewItem(EnumGridDetail.Qty) = CDec(FormatNumber(qty, DecimalPointInQty))
                            drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                            'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                            'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                            'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                            ''TASK TFS1561
                            If IsKeyDownCalled = False Then
                                drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                            Else
                                drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                            End If
                            '' END TASK TFS1561
                            drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)


                            drNewItem(EnumGridDetail.CurrentPrice) = Me.cmbItem.ActiveRow.Cells("Price").Value
                            drNewItem(EnumGridDetail.SaleDetailID) = 0
                            drNewItem(EnumGridDetail.SavedQty) = 0
                            drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                            drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                            drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                            drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
                            drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                            drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                            drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                            'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                            drNewItem(EnumGridDetail.SampleQty) = SchemeQty
                            'drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) '0Discount_Percentage

                            'Change Againt TFS1153 
                            ' ''TFS1153 Added flat discount optional 
                            'If rbPer.Checked = True Then
                            '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                            '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                            'Else

                            '    ''
                            '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                            '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                            '    ''
                            'End If
                            ' ''
                            ' ''END TASK TFS1153

                            'TFS1153
                            If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                                'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                                drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                            ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                                ''
                                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                                'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                                drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                                ''
                            Else

                                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                                'drNewItem(EnumGridDetail.DiscountType) = ""
                                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                                drNewItem(EnumGridDetail.DiscountFactor) = 0  'TFS1153
                            End If

                            drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                            'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153

                            drNewItem(EnumGridDetail.Freight) = Freight
                            drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                            drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                            drNewItem(EnumGridDetail.LoadQty) = Convert.ToDecimal(LoadQty)
                            drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                            drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                            drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                            drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                            drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                            drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                            drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                            drNewItem(EnumGridDetail.Comments) = strComments
                            drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                            drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                            drNewItem(EnumGridDetail.Gross_Weights) = 0
                            drNewItem(EnumGridDetail.Tray_Weights) = 0
                            drNewItem(EnumGridDetail.Net_Weight) = 0

                            ''
                            drNewItem(EnumGridDetail.BardanaDeduction) = 0
                            drNewItem(EnumGridDetail.OtherDeduction) = 0
                            drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                            drNewItem(EnumGridDetail.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
                            drNewItem(EnumGridDetail.SODetailId) = soDetailId
                            'drNewItem(EnumGridDetail.SO_ID) = soID
                            drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                            drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                            If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                                drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                            Else
                                drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                            End If
                            drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                            Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                            If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                                drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                                drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                            End If
                            drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                            drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                            dtGrid.Rows.Add(drNewItem)
                            qty = qty - dt.Rows(i)("Stock")
                            dt.Rows(i)("Stock") = 0
                        ElseIf dt.Rows(i)("Stock") > 0 Then
                            'grd.AddItem(cmbCategory.Text, Me.cmbItem.ActiveRow.Cells("Code").Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, dt.Rows(i)("Batch No").ToString, cmbUnit.Text, qty, txtRate.Text, qty * Val(txtRate.Text), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                            'grd.AddItem(cmbCategory.Text, Me.cmbItem.ActiveRow.Cells("Code").Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, dt.Rows(i)("Batch No").ToString, cmbUnit.Text, qty, txtRate.Text, qty * Val(txtRate.Text), cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value)
                            drNewItem = dtGrid.NewRow()
                            'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                            drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                            'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                            ''TASK TFS1561
                            If IsKeyDownCalled = False Then
                                drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                            Else
                                drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                            End If
                            '' END TASK TFS1561
                            drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                            drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                            drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
                            drNewItem("Origin") = Me.SOOrigin
                            drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString) 'cmbUnit.Text
                            'drNewItem(EnumGridDetail.Qty) = qty
                            drNewItem(EnumGridDetail.Qty) = CDec(FormatNumber(qty, DecimalPointInQty))
                            drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                            'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                            'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                            'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                            ''TASK TFS1561
                            If IsKeyDownCalled = False Then
                                drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                            Else
                                drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                            End If
                            '' END TASK TFS1561
                            drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
                            drNewItem(EnumGridDetail.CurrentPrice) = Me.cmbItem.ActiveRow.Cells("Price").Value
                            drNewItem(EnumGridDetail.SaleDetailID) = 0
                            drNewItem(EnumGridDetail.SavedQty) = 0
                            drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                            drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                            drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                            drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
                            drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                            drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                            drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                            'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                            drNewItem(EnumGridDetail.SampleQty) = SchemeQty
                            'drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage

                            'Change Againt TFS1153 
                            ' ''TFS1153 Added flat discount optional 
                            'If rbPer.Checked = True Then
                            '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                            '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                            'Else
                            '    ''
                            '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                            '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                            '    ''
                            'End If
                            ' ''End TASK TFS1153

                            'TFS1153
                            If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                                'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                                drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                            ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                                ''
                                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                                'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                                drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                                ''
                            Else

                                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                                'drNewItem(EnumGridDetail.DiscountType) = ""
                                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                                drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                            End If

                            drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                            'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153

                            ' ''End TASK TFS1153

                            drNewItem(EnumGridDetail.Freight) = Freight
                            drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                            drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                            'drNewItem(EnumGridDetail.LoadQty) = Convert.ToDecimal(LoadQty)
                            drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))
                            drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                            drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                            drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                            drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                            drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                            drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                            drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                            drNewItem(EnumGridDetail.Comments) = strComments
                            drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                            drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                            drNewItem(EnumGridDetail.Gross_Weights) = 0
                            drNewItem(EnumGridDetail.Tray_Weights) = 0
                            drNewItem(EnumGridDetail.Net_Weight) = 0
                            ''
                            drNewItem(EnumGridDetail.BardanaDeduction) = 0
                            drNewItem(EnumGridDetail.OtherDeduction) = 0
                            drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                            drNewItem(EnumGridDetail.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
                            drNewItem(EnumGridDetail.SODetailId) = soDetailId
                            'drNewItem(EnumGridDetail.SO_ID) = soID
                            drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                            drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                            If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                                drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                            Else
                                drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                            End If
                            drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                            Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                            If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                                drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                                drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                            End If
                            drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                            drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                            dtGrid.Rows.Add(drNewItem)
                            dt.Rows(i)("Stock") = dt.Rows(i)("Stock") - qty
                            qty = 0
                        End If
                    End If
                Next
            End If
            If flgLoadAllItems = False Then
                If qty > 0 AndAlso qtyLrgThnStock <= 0 Then
                    '    'grd.AddItem(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, dt.Rows(dt.Rows.Count - 1)("Batch No").ToString, cmbUnit.Text, qty, txtRate.Text, IIf(cmbUnit.Text = "Pack", qty * Val(txtRate.Text) * Val(txtPackQty.Text), qty * Val(txtRate.Text)), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                    drNewItem = dtGrid.NewRow()
                    'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                    drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    Else
                        drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                    drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                    drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
                    drNewItem("Origin") = Me.SOOrigin
                    drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString) 'cmbUnit.Text
                    drNewItem(EnumGridDetail.Qty) = CDec(FormatNumber(qty, DecimalPointInQty))
                    drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                    'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                    'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    Else
                        drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
                    drNewItem(EnumGridDetail.CurrentPrice) = Val(Me.cmbItem.ActiveRow.Cells("Price").Value)
                    drNewItem(EnumGridDetail.SaleDetailID) = 0
                    drNewItem(EnumGridDetail.SavedQty) = 0
                    drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                    drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                    drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                    drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
                    drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                    drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                    drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                    'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                    drNewItem(EnumGridDetail.SampleQty) = SchemeQty
                    'Change Againt TFS1153 
                    ' ''TFS1153 Added flat discount optional 
                    'If rbPer.Checked = True Then
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                    '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                    'Else
                    '    ''
                    '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                    '    ''
                    'End If
                    ' ''END TASK TFS1153


                    'TFS1153
                    If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                    ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                        ''
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue   'TFS1153
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                        ''
                    Else

                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = ""
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153 'TFS1153
                        drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                    End If


                    drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                    'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153

                    ' ''End TASK TFS1153
                    drNewItem(EnumGridDetail.Freight) = Freight
                    drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                    drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                    'drNewItem(EnumGridDetail.LoadQty) = Convert.ToDecimal(LoadQty)
                    drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))
                    drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                    drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                    drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                    drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                    drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CostPrice) = dblCostPrice  'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                    drNewItem(EnumGridDetail.Comments) = strComments
                    drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                    drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                    drNewItem(EnumGridDetail.Gross_Weights) = 0
                    drNewItem(EnumGridDetail.Tray_Weights) = 0
                    drNewItem(EnumGridDetail.Net_Weight) = 0
                    ''
                    drNewItem(EnumGridDetail.BardanaDeduction) = 0
                    drNewItem(EnumGridDetail.OtherDeduction) = 0
                    drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                    drNewItem(EnumGridDetail.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
                    drNewItem(EnumGridDetail.SODetailId) = soDetailId
                    drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                    drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                    If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                    Else
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                    End If
                    drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                    Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                    If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                        drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                        drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                    End If
                    drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                    drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                    dtGrid.Rows.Add(drNewItem)
                ElseIf qty > 0 AndAlso qtyLrgThnStock > 0 Then
                    '    'grd.AddItem(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, dt.Rows(dt.Rows.Count - 1)("Batch No").ToString, cmbUnit.Text, qty, txtRate.Text, IIf(cmbUnit.Text = "Pack", qty * Val(txtRate.Text) * Val(txtPackQty.Text), qty * Val(txtRate.Text)), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                    drNewItem = dtGrid.NewRow()
                    'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                    drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    Else
                        drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                    drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                    drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
                    drNewItem("Origin") = Me.SOOrigin
                    drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString) 'cmbUnit.Text
                    'drNewItem(EnumGridDetail.Qty) = scndQty
                    drNewItem(EnumGridDetail.Qty) = CDec(FormatNumber(scndQty, DecimalPointInQty))

                    drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                    'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                    'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    Else
                        drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
                    drNewItem(EnumGridDetail.CurrentPrice) = Val(Me.cmbItem.ActiveRow.Cells("Price").Value)
                    drNewItem(EnumGridDetail.SaleDetailID) = 0
                    drNewItem(EnumGridDetail.SavedQty) = 0
                    drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                    drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                    drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                    drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
                    drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                    drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                    drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                    'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                    drNewItem(EnumGridDetail.SampleQty) = SchemeQty

                    'Change Againt TFS1153 
                    'If rbPer.Checked = True Then
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                    '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                    'Else
                    '    ''
                    '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                    '    ''
                    'End If

                    'TFS1153
                    If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                    ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                        ''
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                        ''
                    Else

                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        ''drNewItem(EnumGridDetail.DiscountType) = ""
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                        drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                    End If

                    drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                    'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153

                    ' ''End TASK TFS1153
                    drNewItem(EnumGridDetail.Freight) = Freight
                    drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                    drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                    'drNewItem(EnumGridDetail.LoadQty) = Convert.ToDecimal(LoadQty)
                    drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))
                    drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                    drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                    drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                    drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                    drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CostPrice) = dblCostPrice  'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                    drNewItem(EnumGridDetail.Comments) = strComments
                    drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                    drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                    drNewItem(EnumGridDetail.Gross_Weights) = 0
                    drNewItem(EnumGridDetail.Tray_Weights) = 0
                    drNewItem(EnumGridDetail.Net_Weight) = 0
                    'drNewItem(EnumGridDetail.TotalQty) = scndTotalQty ''Val(Me.txtTotalQuantity.Text)
                    ''
                    drNewItem(EnumGridDetail.BardanaDeduction) = 0
                    drNewItem(EnumGridDetail.OtherDeduction) = 0
                    drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                    drNewItem(EnumGridDetail.TotalQty) = CDec(FormatNumber(scndTotalQty, DecimalPointInQty))
                    drNewItem(EnumGridDetail.SODetailId) = soDetailId
                    drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                    drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                    If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                    Else
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                    End If
                    drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                    Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                    If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                        drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                        drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                    End If
                    drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                    drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                    dtGrid.Rows.Add(drNewItem)
                End If
            Else
                If qty >= 0 AndAlso qtyLrgThnStock > 0 Then
                    '    'grd.AddItem(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, dt.Rows(dt.Rows.Count - 1)("Batch No").ToString, cmbUnit.Text, qty, txtRate.Text, IIf(cmbUnit.Text = "Pack", qty * Val(txtRate.Text) * Val(txtPackQty.Text), qty * Val(txtRate.Text)), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                    drNewItem = dtGrid.NewRow()
                    'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                    drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    Else
                        drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                    drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo ' String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                    drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
                    drNewItem("Origin") = Me.SOOrigin
                    drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString) 'cmbUnit.Text
                    'drNewItem(EnumGridDetail.Qty) = scndQty ''qty
                    drNewItem(EnumGridDetail.Qty) = CDec(FormatNumber(scndQty, DecimalPointInQty)) ''qty

                    drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                    'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                    'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    Else
                        drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
                    drNewItem(EnumGridDetail.CurrentPrice) = Val(Me.cmbItem.ActiveRow.Cells("Price").Value)
                    drNewItem(EnumGridDetail.SaleDetailID) = 0
                    drNewItem(EnumGridDetail.SavedQty) = 0
                    drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                    drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                    drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                    drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
                    drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                    drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                    drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                    'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                    drNewItem(EnumGridDetail.SampleQty) = SchemeQty
                    'Change Againt TFS1153 
                    ' ''TFS1153 Added flat discount optional 
                    'If rbPer.Checked = True Then
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                    '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                    'Else
                    '    ''
                    '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                    '    ''
                    'End If
                    ' ''End Task TFS1153
                    'TFS1153
                    If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                    ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                        ''
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                        ''
                    Else

                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = ""
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                    End If

                    drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                    'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153

                    ' ''End TASK TFS1153
                    drNewItem(EnumGridDetail.Freight) = Freight
                    drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                    drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                    'drNewItem(EnumGridDetail.LoadQty) = Convert.ToDecimal(LoadQty)
                    drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))

                    drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                    drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                    drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                    drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                    drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                    drNewItem(EnumGridDetail.Comments) = strComments
                    drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                    drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                    drNewItem(EnumGridDetail.Gross_Weights) = 0
                    drNewItem(EnumGridDetail.Tray_Weights) = 0
                    drNewItem(EnumGridDetail.Net_Weight) = 0
                    'drNewItem(EnumGridDetail.TotalQty) = scndTotalQty ''Val(Me.txtTotalQuantity.Text)
                    ''
                    drNewItem(EnumGridDetail.BardanaDeduction) = 0
                    drNewItem(EnumGridDetail.OtherDeduction) = 0
                    drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                    drNewItem(EnumGridDetail.TotalQty) = CDec(FormatNumber(scndTotalQty, DecimalPointInQty)) ''Val(Me.txtTotalQuantity.Text)

                    drNewItem(EnumGridDetail.SODetailId) = soDetailId
                    drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                    drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                    If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                    Else
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                    End If
                    drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                    Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                    If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                        drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                        drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                    End If
                    drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                    drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                    dtGrid.Rows.Add(drNewItem)
                ElseIf qty >= 0 AndAlso qtyLrgThnStock <= 0 Then
                    '    'grd.AddItem(cmbCategory.Text, cmbItem.ActiveRow.Cells("Item").Value.ToString, dt.Rows(dt.Rows.Count - 1)("Batch No").ToString, cmbUnit.Text, qty, txtRate.Text, IIf(cmbUnit.Text = "Pack", qty * Val(txtRate.Text) * Val(txtPackQty.Text), qty * Val(txtRate.Text)), cmbCategory.SelectedValue, cmbItem.ActiveRow.Cells(0).Value, Me.txtPackQty.Text, Me.cmbItem.ActiveRow.Cells("Price").Value, "0", "0", Me.cmbBatchNo.Value, Me.cmbCategory.SelectedValue, 0)
                    drNewItem = dtGrid.NewRow()
                    'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
                    drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
                    Else
                        drNewItem(EnumGridDetail.ArticleCode) = KeyDownArticleCode
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
                    drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value.ToString
                    drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
                    drNewItem("Origin") = Me.SOOrigin
                    drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString) 'cmbUnit.Text
                    'drNewItem(EnumGridDetail.Qty) = qty
                    drNewItem(EnumGridDetail.Qty) = CDec(FormatNumber(qty, DecimalPointInQty))
                    drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, Val(txtRate.Text))
                    'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
                    'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
                    'drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    ''TASK TFS1561
                    If IsKeyDownCalled = False Then
                        drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
                    Else
                        drNewItem(EnumGridDetail.ArticleID) = KeyDownArticleId
                    End If
                    '' END TASK TFS1561
                    drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
                    drNewItem(EnumGridDetail.CurrentPrice) = Val(Me.cmbItem.ActiveRow.Cells("Price").Value)
                    drNewItem(EnumGridDetail.SaleDetailID) = 0
                    drNewItem(EnumGridDetail.SavedQty) = 0
                    drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
                    drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
                    drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
                    drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
                    drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
                    drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
                    drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
                    'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
                    drNewItem(EnumGridDetail.SampleQty) = SchemeQty
                    'Change Againt TFS1153 
                    ' ''TFS1153 Added flat discount optional 
                    'If rbPer.Checked = True Then
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
                    '    drNewItem(EnumGridDetail.FlatDiscount) = 0
                    'Else
                    '    ''
                    '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
                    '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
                    '    ''
                    'End If
                    ' ''End Task TFS1153

                    'TFS1153
                    If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                    ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                        ''
                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153
                        ''
                    Else

                        drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                        'drNewItem(EnumGridDetail.DiscountType) = ""
                        drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue
                        drNewItem(EnumGridDetail.DiscountFactor) = 0   'TFS1153
                    End If

                    drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
                    'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153

                    ' ''End TASK TFS1153
                    drNewItem(EnumGridDetail.Freight) = Freight
                    drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
                    drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
                    'drNewItem(EnumGridDetail.LoadQty) = Convert.ToDecimal(LoadQty)
                    drNewItem(EnumGridDetail.LoadQty) = CDec(FormatNumber(LoadQty, DecimalPointInQty))
                    drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
                    drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
                    drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
                    drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
                    drNewItem(EnumGridDetail.SalesAccountId) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
                    drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
                    drNewItem(EnumGridDetail.Comments) = strComments
                    drNewItem(EnumGridDetail.OtherComments) = strOtherComments
                    drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
                    drNewItem(EnumGridDetail.Gross_Weights) = 0
                    drNewItem(EnumGridDetail.Tray_Weights) = 0
                    drNewItem(EnumGridDetail.Net_Weight) = 0
                    drNewItem(EnumGridDetail.TotalQty) = Convert.ToDecimal(Me.txtTotalQuantity.Text)
                    ''
                    drNewItem(EnumGridDetail.BardanaDeduction) = 0
                    drNewItem(EnumGridDetail.OtherDeduction) = 0
                    drNewItem(EnumGridDetail.AfterDeductionQty) = 0
                    drNewItem(EnumGridDetail.SODetailId) = soDetailId
                    drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
                    drNewItem(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                    If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(0)
                    Else
                        drNewItem(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                    End If
                    drNewItem(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                    Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                    If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                        drNewItem(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                        drNewItem(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                    End If
                    drNewItem(EnumGridDetail.OldSalePrice) = Val(0)
                    drNewItem(EnumGridDetail.SalePriceProcessId) = Val(0)
                    dtGrid.Rows.Add(drNewItem)
                End If
            End If
        End If


        'If GetConfigValue("ServiceItem").ToString = "True" Then
        '    drNewItem = dtGrid.NewRow()
        '    'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
        '    drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
        '    drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
        '    drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
        '    drNewItem(EnumGridDetail.BatchNo) = Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value
        '    drNewItem(EnumGridDetail.Unit) = cmbUnit.Text
        '    drNewItem(EnumGridDetail.Qty) = qty
        '    drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, txtRate.Text)
        '    'drNewItem(EnumGridDetail.Total) = Val(txtTotal.Text)
        '    'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
        '    drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
        '    drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
        '    drNewItem(EnumGridDetail.CurrentPrice) = Me.cmbItem.ActiveRow.Cells("Price").Value
        '    drNewItem(EnumGridDetail.SaleDetailID) = 0
        '    drNewItem(EnumGridDetail.SavedQty) = 0
        '    drNewItem(EnumGridDetail.BatchID) = Me.cmbBatchNo.Value
        '    drNewItem(EnumGridDetail.TradePrice) = TradePrice
        '    drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
        '    drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
        '    drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
        '    drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
        '    'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
        '    drNewItem(EnumGridDetail.SampleQty) = SchemeQty
        '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text)
        '    drNewItem(EnumGridDetail.Freight) = Freight
        '    drNewItem(EnumGridDetail.MarketReturns) = MarketReturns
        '    dtGrid.Rows.Add(drNewItem)
        'End If

        'Dim dt As DataTable = CType(grd.DataSource, DataTable)
        'Dim dr As DataRow

        'Dim objGridItem As DataGridView
        'Dim intLoopCounter As Integer = 0


        'Dim strCategory As New DataColumn("Category", GetType(String))
        'Dim strItem As New DataColumn("Item", GetType(String))
        'Dim strUnit As New DataColumn("Unit", GetType(String))
        'Dim intQty As New DataColumn("Qty", GetType(Integer))
        'Dim dblRate As New DataColumn("Rate", GetType(Double))
        'Dim dblTotal As New DataColumn("Total", GetType(Double))
        'Dim intCategoryID As New DataColumn("CategoryID", GetType(Integer))
        'Dim intItemID As New DataColumn("ItemID", GetType(Integer))

        'dt.Columns.Add(strCategory)
        'dt.Columns.Add(strItem)
        'dt.Columns.Add(strUnit)
        'dt.Columns.Add(intQty)
        'dt.Columns.Add(dblRate)
        'dt.Columns.Add(dblTotal)
        'dt.Columns.Add(intCategoryID)
        'dt.Columns.Add(intItemID)

        'dr = dt.NewRow
        'dr("Category") = cmbCategory.SelectedText
        'dr("Item") = cmbItem.SelectedText
        'dr("Unit") = cmbUnit.SelectedText
        'dr("Qty") = txtQty.Text
        'dr("Rate") = txtRate.Text
        'dr("Total") = Val(txtTotal.Text)
        ''        dr("CategoryID") = cmbCategory.SelectedValue
        ''        dr("ItemID") = cmbItem.SelectedValue


        'dt.Rows.Add(dr)


        'grd.DataSource = dt
        'Me.grd.Refetch()

        dtGrid.AcceptChanges()
        TradePrice = 0D
        Freight_Rate = 0D
        MarketReturns_Rate = 0D
        'dt = grd.DataSource
        FlatRate = 0D
        LoadQty = 0D
        soDetailId = 0
        soID = 0
        ''TAKS TFS1561
        IsKeyDownCalled = False
        KeyDownArticleCode = ""
        KeyDownArticleId = 0
        KeyDownPrice = 0
        ''END TASK TFS1561
    End Sub
    Private Sub AddItemToGrid(ByVal ZeroQty As Boolean)
        Try

            'If Not Val(Me.txtTax.Text) <> 0 Then
            If IsSalesOrderAnalysis = True Then
                If GST_Applicable = True Then
                    If SalesTax_Percentage = 0 Then SalesTax_Percentage = DefaultTax
                ElseIf FlatRate_Applicable = True Then
                    If SalesTax_Percentage = 0 Then SalesTax_Percentage = ((FlatRate / Val(Me.cmbItem.SelectedRow.Cells("Price").Text)) * 100)
                End If
            Else
                SalesTax_Percentage = Val(Me.txtTax.Text)
            End If
            'Else
            'End If
            Dim dblPurchasePrice As Double = 0D
            Dim dblCostPrice As Double = 0D

            Dim strPriceData() As String = GetRateByItem(Me.cmbItem.Value).Split(",")

            If strPriceData.Length > 1 Then
                dblCostPrice = Val(strPriceData(0).ToString)
                dblPurchasePrice = Val(strPriceData(1).ToString)

                If dblCostPrice = 0 Then
                    dblCostPrice = dblPurchasePrice
                End If

            End If

            Dim qty As Double = 0D
            Dim dtGrid As DataTable = CType(Me.grd.DataSource, DataTable)
            Dim drNewItem As DataRow

            drNewItem = dtGrid.NewRow()
            'drNewItem(EnumGridDetail.Category) = cmbCategory.Text
            drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue 'cmbCategory.Text
            drNewItem(EnumGridDetail.ArticleCode) = cmbItem.ActiveRow.Cells("Code").Text.ToString
            drNewItem(EnumGridDetail.Item) = cmbItem.ActiveRow.Cells("Item").Value.ToString
            If Me.cmbBatchNo.Text.Trim = "" Then
                drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  '""
                drNewItem(EnumGridDetail.BatchID) = 0
            Else
                drNewItem(EnumGridDetail.BatchNo) = Me.SOBatchNo  'String.Empty 'Me.cmbBatchNo.ActiveRow.Cells("Batch No").Value
                drNewItem(EnumGridDetail.BatchID) = 0 'Me.cmbBatchNo.Value
            End If
            drNewItem(EnumGridDetail.ExpiryDate) = Me.SOExpiryDate  'Convert.ToDateTime(Date.Now.AddMonths(1)) ''TFS4181
            drNewItem("Origin") = Me.SOOrigin
            drNewItem(EnumGridDetail.Unit) = IIf(cmbUnit.Text.ToString <> "Loose", "Pack", Me.cmbUnit.Text.ToString) 'cmbUnit.Text
            drNewItem(EnumGridDetail.Qty) = IIf(txtQty.Text.Trim = "", 0, txtQty.Text)
            If ZeroQty = True Then
                drNewItem(EnumGridDetail.Qty) = 0
            End If
            drNewItem(EnumGridDetail.Price) = IIf(txtRate.Text.Trim = "", 0, txtRate.Text)
            'drNewItem(EnumGridDetail.LocationID) = cmbCategory.SelectedValue
            drNewItem(EnumGridDetail.ArticleID) = cmbItem.ActiveRow.Cells(0).Value
            drNewItem(EnumGridDetail.PackQty) = Val(Me.txtPackQty.Text)
            drNewItem(EnumGridDetail.CurrentPrice) = Me.cmbItem.ActiveRow.Cells("Price").Value
            drNewItem(EnumGridDetail.SaleDetailID) = 0
            drNewItem(EnumGridDetail.SavedQty) = 0
            drNewItem(EnumGridDetail.TradePrice) = Me.cmbItem.ActiveRow.Cells("Trade Price").Value ''TradePrice
            drNewItem(EnumGridDetail.RetailPrice) = Val(Me.txtRetailPrice.Text) ''RetailPrice TFS1154
            drNewItem(EnumGridDetail.Tax) = SalesTax_Percentage
            drNewItem(EnumGridDetail.SED) = Val(Me.txtWHTaxPercent.Text)
            drNewItem(EnumGridDetail.Size) = Me.cmbItem.ActiveRow.Cells("Size").Value
            drNewItem(EnumGridDetail.Color) = Me.cmbItem.ActiveRow.Cells("Combination").Value
            'drNewItem(EnumGridDetail.ServiceQty) = Val(Me.txtServiceQty.Text)
            drNewItem(EnumGridDetail.SampleQty) = SchemeQty
            'Change Againt TFS1153 
            'drNewItem(EnumGridDetail.Discount_Percentage) = Val(Me.txtDisc.Text)
            ' ''
            'If rbPer.Checked = True Then
            '    drNewItem(EnumGridDetail.Discount_Percentage) = Val(txtDisc.Text) 'Discount_Percentage
            '    drNewItem(EnumGridDetail.FlatDiscount) = 0
            'Else
            '    ''
            '    drNewItem(EnumGridDetail.FlatDiscount) = Val(txtDisc.Text)
            '    drNewItem(EnumGridDetail.Discount_Percentage) = 0
            '    ''
            'End If
            ''

            'TFS1153
            If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) AndAlso Val(txtDisc.Text) > 0 Then
                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue   'TFS1153
            ElseIf Me.cmbDiscountType.Text.Equals(DiscountType_Flat) AndAlso Val(txtDisc.Text) > 0 Then
                ''
                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue  'TFS1153
                ''
            Else

                drNewItem(EnumGridDetail.DiscountValue) = Val(txtDiscountValue.Text) 'DiscountValue
                drNewItem(EnumGridDetail.DiscountType) = Me.cmbDiscountType.Text
                drNewItem(EnumGridDetail.DiscountId) = Me.cmbDiscountType.SelectedValue   'TFS1153
            End If

            drNewItem(EnumGridDetail.PostDiscountPrice) = Val(txtPDP.Text)   'TFS1153
            'drNewItem(EnumGridDetail.DiscountId) = Val(Me.cmbDiscountType.SelectedValue)   'TFS1153
            drNewItem(EnumGridDetail.DiscountFactor) = Val(txtDisc.Text)   'TFS1153

            drNewItem(EnumGridDetail.Freight) = Freight
            drNewItem(EnumGridDetail.SO_ID) = Val(Me.cmbPo.SelectedValue)
            drNewItem(EnumGridDetail.LoadQty) = Val(LoadQty)
            drNewItem(EnumGridDetail.PurchasePrice) = dblPurchasePrice 'Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString)
            drNewItem(EnumGridDetail.PackPrice) = Val(Me.txtPackRate.Text)
            drNewItem(EnumGridDetail.Pack_Desc) = Me.cmbUnit.Text.ToString
            drNewItem(EnumGridDetail.AccountId) = Val(Me.cmbItem.ActiveRow.Cells("AccountId").Value.ToString)
            drNewItem(EnumGridDetail.SaleDetailID) = Val(Me.cmbItem.ActiveRow.Cells("SalesAccountId").Value.ToString)
            drNewItem(EnumGridDetail.CGSAccountId) = Val(Me.cmbItem.ActiveRow.Cells("CGSAccountId").Value.ToString)
            drNewItem(EnumGridDetail.CostPrice) = dblCostPrice 'IIf(Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString) = 0, Val(Me.cmbItem.ActiveRow.Cells("PurchasePrice").Value.ToString), Val(Me.cmbItem.ActiveRow.Cells("Cost_Price").Value.ToString))
            drNewItem(EnumGridDetail.Comments) = strComments
            drNewItem(EnumGridDetail.OtherComments) = strOtherComments
            drNewItem(EnumGridDetail.ApplyAdjustmentFuelExp) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("ApplyAdjustmentFuelExp").Value.ToString)
            drNewItem(EnumGridDetail.TotalQty) = Val(Me.txtTotalQuantity.Text)
            drNewItem(EnumGridDetail.LogicalItem) = Convert.ToBoolean(Me.cmbItem.ActiveRow.Cells("LogicalItem").Value.ToString) ''TFS1957
            dtGrid.Rows.Add(drNewItem)
            dtGrid.AcceptChanges()

            TradePrice = 0D
            Freight_Rate = 0D
            MarketReturns_Rate = 0D
            FlatRate = 0D

        Catch ex As Exception
            Throw ex
        End Try

    End Sub

    Private Sub cmbCategory_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbCategory.SelectedIndexChanged
        Try
            'Start TFS1610:18-OCT-2017:Rai Haider : Stock In Item List According to location selected in location dropdown
            'On Change of location item dropdown fill again
            Dim id As Integer
            id = 0
            id = Me.cmbItem.Value
            FillCombo("Item")
            Me.cmbItem.Value = id
            'End Task: TFS1610
            If Me.IsFormOpend = True Then
                If flgLocationWiseItems = True Then FillCombo("Item")
                If flgLoadAllItems = True Then
                    If Me.cmbCategory.SelectedIndex = 0 Or Me.cmbCategory.SelectedIndex > 0 Then
                        For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                            If Me.grd.RowCount > 0 Then
                                r.BeginEdit()
                                r.Cells("LocationId").Value = Me.cmbCategory.SelectedValue
                                r.EndEdit()
                            End If
                        Next
                    End If
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub GetTotal()
    '    Try

    '        If Me.grd.RootTable Is Nothing Then Exit Sub
    '        Me.grd.UpdateData()


    '        If getConfigValueByType("ApplyAdjustmentFuelExpTotal").ToString = "False" Then

    '            Dim i As Integer
    '            Dim dblTotalAmount As Double = 0
    '            Dim dblTotalTax As Double = 0
    '            Dim dblTotalQty As Double = 0
    '            Dim dblTotalSEDTax As Double = 0
    '            Dim dblSchemeTaxValue As Double = 0D
    '            Dim dblTotalMarketReturns As Double = 0D
    '            Dim dblTotalFreight As Double = 0D

    '            For i = 0 To grd.RecordCount - 1
    '                'dblTotalAmount = dblTotalAmount + Val(grd1.Rows(i).Cells("total").Value)
    '                'dblTotalQty = dblTotalQty + Val(grd1.Rows(i).Cells("Qty").Value)

    '                If Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) > 0 Then
    '                    If Not IsSalesOrderAnalysis = True Then
    '                        If flgExcludeTaxPrice = False Then
    '                            dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * Val(grd.GetRows(i).Cells(EnumGridDetail.Total).Value)
    '                        Else
    '                            dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Total).Value)
    '                        End If
    '                    Else
    '                        dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)), ((Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value))))
    '                    End If
    '                End If
    '                If Val(grd.GetRows(i).Cells(EnumGridDetail.SED).Value) > 0 Then
    '                    'dblTotalSEDTax = dblTotalSEDTax + (((Me.grd.GetRows(i).Cells(EnumGridDetail.Total).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value) / 100
    '                    If Not IsSalesOrderAnalysis = True Then
    '                        dblTotalSEDTax = dblTotalSEDTax + ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Total).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value)) / 100)
    '                    Else
    '                        dblSchemeTaxValue = IIf(Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) = 0, 0, (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)))
    '                        dblTotalSEDTax = dblTotalSEDTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.SED).Value) / 100) * (dblSchemeTaxValue + (Val(grd.GetRows(i).Cells(EnumGridDetail.TradePrice).Value) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)))))
    '                    End If
    '                End If

    '                dblTotalMarketReturns += IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value)), (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value)))
    '                dblTotalFreight += IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value)), (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value)))
    '            Next
    '            Me.txtSEDTaxAmount.Text = dblTotalSEDTax
    '            txtTotalQty.Text = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Qty), Janus.Windows.GridEX.AggregateFunction.Sum))
    '            txtBalance.Text = Val(txtAmount.Text) - Val(Me.txtRecAmount.Text)
    '            txtTaxTotal.Text = Math.Round(dblTotalTax, DecimalPointInValue)
    '            If IsSalesOrderAnalysis = False Then

    '                If Convert.ToBoolean(getConfigValueByType("ExpenseChargeToCustomer").ToString) = False Then
    '                    If Me.rbtAdjFlat.Checked = True Then
    '                        txtAmount.Text = Math.Round((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(txtAdjustment.Text)) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
    '                    Else
    '                        txtAmount.Text = Math.Round((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum))) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
    '                        Adjustment = Math.Round(((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                        txtAmount.Text = Math.Round(Val(txtAmount.Text) - ((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                    End If


    '                Else

    '                    If Me.rbtAdjFlat.Checked = True Then
    '                        txtAmount.Text = Math.Round((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(txtAdjustment.Text)) + Val(Me.txtAddTransitInsurance.Text)) + Val(Me.txtFuel.Text)) + Val(Me.txtExpense.Text), DecimalPointInValue)
    '                    Else
    '                        txtAmount.Text = Math.Round((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum))) + Val(Me.txtAddTransitInsurance.Text)) + Val(Me.txtFuel.Text)) + Val(Me.txtExpense.Text), DecimalPointInValue)
    '                        Adjustment = Math.Round(((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                        txtAmount.Text = Math.Round(Val(txtAmount.Text) + ((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                    End If



    '                End If

    '            ElseIf IsSalesOrderAnalysis = True Then
    '                'Me.txtSEDTaxAmount.Text = Val(dblTotalSEDTax)
    '                If Convert.ToBoolean(getConfigValueByType("ExpenseChargeToCustomer").ToString) = False Then
    '                    Me.txtExpense.Text = dblTotalMarketReturns
    '                    txtTransitInsurancePercentage_TextChanged(Nothing, Nothing)
    '                    If Me.rbtAdjFlat.Checked = True Then
    '                        txtAmount.Text = Math.Round((((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum))) - Val(txtAdjustment.Text))) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
    '                    Else
    '                        txtAmount.Text = Math.Round((((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum)))) + Val(txtSEDTaxAmount.Text)) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
    '                        Adjustment = Math.Round(((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                        txtAmount.Text = Math.Round(Val(txtAmount.Text) - ((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                    End If
    '                    'Me.txtAddTransitInsurance.Text = (((Val(Me.txtTransitInsurancePercentage.Text) / 100) * (Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum)) + Val(Me.txtSEDTaxAmount.Text))), 2)
    '                    'ElseIf ServicesItem = "True" Then
    '                    '    txtAmount.Text = (((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(txtAdjustment.Text) + Val(txtSEDTaxAmount.Text)) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text)

    '                Else

    '                    Me.txtExpense.Text = dblTotalMarketReturns
    '                    txtTransitInsurancePercentage_TextChanged(Nothing, Nothing)
    '                    If Me.rbtAdjFlat.Checked = True Then
    '                        txtAmount.Text = Math.Round((((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum))) - Val(txtAdjustment.Text))) + Val(Me.txtAddTransitInsurance.Text)) + Val(Me.txtFuel.Text)) + Val(Me.txtExpense.Text), DecimalPointInValue)
    '                    Else
    '                        txtAmount.Text = Math.Round((((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum))))) + Val(Me.txtAddTransitInsurance.Text)) + Val(Me.txtFuel.Text)) + Val(Me.txtExpense.Text), DecimalPointInValue)
    '                        Adjustment = Math.Round(((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                        txtAmount.Text = Math.Round(Val(txtAmount.Text) + ((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
    '                    End If



    '                End If
    '            End If

    '            If Me.grd.RowCount = 0 Then
    '                Me.txtAmount.Text = 0
    '                Adjustment = 0D
    '            End If
    '            Me.txtNetAmount.Text = Math.Round(Val(Me.txtAmount.Text) + Val(Me.txtTaxTotal.Text) + Val(Me.txtSEDTaxAmount.Text), DecimalPointInValue) 'Task:2374 Net Amount
    '        Else

    '            Dim dblTotalAmount As Double = 0
    '            Dim dblTotalTax As Double = 0
    '            Dim dblTotalQty As Double = 0
    '            Dim dblTotalSEDTax As Double = 0
    '            Dim dblSchemeTaxValue As Double = 0D
    '            Dim dblTotalMarketReturns As Double = 0D
    '            Dim dblTotalFreight As Double = 0D

    '            For i As Integer = 0 To grd.RecordCount - 1
    '                If Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) > 0 Then
    '                    If Not IsSalesOrderAnalysis = True Then
    '                        If flgExcludeTaxPrice = False Then
    '                            dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * Val(grd.GetRows(i).Cells(EnumGridDetail.Total).Value)
    '                        Else
    '                            dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Total).Value)
    '                        End If
    '                    Else
    '                        dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)), ((Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value))))
    '                    End If
    '                End If
    '                If Val(grd.GetRows(i).Cells(EnumGridDetail.SED).Value) > 0 Then
    '                    'dblTotalSEDTax = dblTotalSEDTax + (((Me.grd.GetRows(i).Cells(EnumGridDetail.Total).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value) / 100
    '                    If Not IsSalesOrderAnalysis = True Then
    '                        dblTotalSEDTax = dblTotalSEDTax + ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Total).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value)) / 100)
    '                    Else
    '                        dblSchemeTaxValue = IIf(Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) = 0, 0, (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)))
    '                        dblTotalSEDTax = dblTotalSEDTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.SED).Value) / 100) * (dblSchemeTaxValue + (Val(grd.GetRows(i).Cells(EnumGridDetail.TradePrice).Value) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)))))
    '                    End If
    '                End If

    '                dblTotalMarketReturns += IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value)), (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value)))
    '                dblTotalFreight += IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value)), (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value)))
    '            Next
    '            Me.txtSEDTaxAmount.Text = dblTotalSEDTax
    '            txtTotalQty.Text = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Qty), Janus.Windows.GridEX.AggregateFunction.Sum))
    '            txtTaxTotal.Text = Math.Round(dblTotalTax, DecimalPointInValue)
    '            GetExclueExpenseTotal()
    '            txtBalance.Text = Val(txtNetAmount.Text) - Val(Me.txtRecAmount.Text)
    '        End If
    '    Catch ex As Exception

    '    End Try
    'End Sub

    Private Sub GetTotal()
        Try

            If Me.grd.RootTable Is Nothing Then Exit Sub
            Me.grd.UpdateData()
            Dim i As Integer
            Dim dblTotalAmount As Double = 0
            Dim dblTotalTax As Double = 0
            Dim dblTotalQty As Double = 0
            Dim dblTotalSEDTax As Double = 0
            Dim dblSchemeTaxValue As Double = 0D
            Dim dblTotalMarketReturns As Double = 0D
            Dim dblTotalFreight As Double = 0D

            For i = 0 To grd.RecordCount - 1
                'dblTotalAmount = dblTotalAmount + Val(grd1.Rows(i).Cells("total").Value)
                'dblTotalQty = dblTotalQty + Val(grd1.Rows(i).Cells("Qty").Value)

                If Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) > 0 Then
                    If Not IsSalesOrderAnalysis = True Then
                        If flgExcludeTaxPrice = False Then
                            dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * Val(grd.GetRows(i).Cells(EnumGridDetail.Total).Value)
                        Else
                            dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Total).Value)
                        End If
                    Else
                        dblTotalTax = dblTotalTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)), ((Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value))))
                    End If
                End If
                If Val(grd.GetRows(i).Cells(EnumGridDetail.SED).Value) > 0 Then
                    'dblTotalSEDTax = dblTotalSEDTax + (((Me.grd.GetRows(i).Cells(EnumGridDetail.Total).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value) / 100
                    If Not IsSalesOrderAnalysis = True Then
                        dblTotalSEDTax = dblTotalSEDTax + ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Total).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value)) / 100)
                    Else
                        dblSchemeTaxValue = IIf(Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) = 0, 0, (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)))
                        dblTotalSEDTax = dblTotalSEDTax + (Val(grd.GetRows(i).Cells(EnumGridDetail.SED).Value) / 100) * (dblSchemeTaxValue + (Val(grd.GetRows(i).Cells(EnumGridDetail.TradePrice).Value) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)))))
                    End If
                End If

                'dblTotalMarketReturns += IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value)), (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value)))
                'dblTotalFreight += IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value)), (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value)))
                dblTotalMarketReturns += ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value))
                dblTotalFreight += ((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) + Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value))
            Next
            Me.txtSEDTaxAmount.Text = dblTotalSEDTax
            txtQty.Text = Math.Round(Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Qty), Janus.Windows.GridEX.AggregateFunction.Sum)), TotalAmountRounding)
            txtTotalQty.Text = Math.Round(Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.AfterDeductionQty), Janus.Windows.GridEX.AggregateFunction.Sum)), TotalAmountRounding)
            txtBalance.Text = Math.Round(Val(txtAmount.Text) - Val(Me.txtRecAmount.Text), TotalAmountRounding)
            txtTaxTotal.Text = Math.Round(dblTotalTax, TotalAmountRounding)
            If IsSalesOrderAnalysis = False Then
                If Me.rbtAdjFlat.Checked = True Then
                    txtAmount.Text = Math.Round((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(txtAdjustment.Text)) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
                Else
                    txtAmount.Text = Math.Round((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum))) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
                    If Val(Me.grd.GetRow.Cells(EnumGridDetail.CurrencyId).Value.ToString) > 1 Then
                        Adjustment = Math.Round(((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount), Janus.Windows.GridEX.AggregateFunction.Sum)) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    Else
                        Adjustment = Math.Round(((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    End If
                    txtAmount.Text = Math.Round(Val(txtAmount.Text) - ((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                End If

            ElseIf IsSalesOrderAnalysis = True Then
                'Me.txtSEDTaxAmount.Text = Val(dblTotalSEDTax)
                Me.txtExpense.Text = dblTotalMarketReturns
                txtTransitInsurancePercentage_TextChanged(Nothing, Nothing)
                If Me.rbtAdjFlat.Checked = True Then
                    txtAmount.Text = Math.Round((((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum))) - Val(txtAdjustment.Text))) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
                Else
                    txtAmount.Text = Math.Round((((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum)))) + Val(txtSEDTaxAmount.Text)) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text), DecimalPointInValue)
                    If Val(Me.grd.GetRow.Cells(EnumGridDetail.CurrencyId).Value.ToString) > 1 Then
                        Adjustment = Math.Round(((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount), Janus.Windows.GridEX.AggregateFunction.Sum)) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    Else
                        Adjustment = Math.Round(((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    End If
                    txtAmount.Text = Math.Round(Val(txtAmount.Text) - ((Val(txtAmount.Text) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                End If
                'Me.txtAddTransitInsurance.Text = (((Val(Me.txtTransitInsurancePercentage.Text) / 100) * (Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.NetBill), Janus.Windows.GridEX.AggregateFunction.Sum)) + Val(Me.txtSEDTaxAmount.Text))), 2)
                'ElseIf ServicesItem = "True" Then
                '    txtAmount.Text = (((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)) - Val(txtAdjustment.Text) + Val(txtSEDTaxAmount.Text)) + Val(Me.txtAddTransitInsurance.Text)) - Val(Me.txtFuel.Text)) - Val(Me.txtExpense.Text)
            End If

            If Me.grd.RowCount = 0 Then
                Me.txtAmount.Text = 0
                Adjustment = 0D
            End If
            ''Edit Against TFS1799
            'If flgExcludeTaxPrice = True Then
            '    Me.txtNetAmount.Text = Math.Round(Val(Me.txtAmount.Text) + Val(Me.txtSEDTaxAmount.Text), DecimalPointInValue) 'Task:2374 Net Amount
            'Else
            Me.txtNetAmount.Text = Math.Round(Val(Me.txtAmount.Text) + Val(Me.txtTaxTotal.Text) + Val(Me.txtSEDTaxAmount.Text), TotalAmountRounding) 'Task:2374 Net Amount
            'End If

            GetExclueExpenseTotal()
        Catch ex As Exception

        End Try

    End Sub
    ''' <summary>
    ''' This Function is Added to get the BottomSaleRate from tblDefCustomerBottomSaleRate 
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks> 'Ayesha Rehman :TFS1663 </remarks>
    Public Function getCustomerBottomSaleRate(ByVal ArticleID As Integer) As Integer
        Try


            Dim str As String = "SELECT * FROM tblDefCustomerBottomSaleRate WHERE TypeID = " & Me.cmbVendor.ActiveRow.Cells("typeid").Value & " and ArticleDefID = " & ArticleID & ""
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then

                    CustSaleRate = Val(dt.Rows(0).Item("MPrice").ToString)
                    Return CustSaleRate
                End If
            End If
        Catch ex As Exception

        End Try
    End Function
    ''End TFS1663
    ''' <summary>
    ''' This Function is Added to get the BottomSaleRate from tblDefCustomerBottomSaleRate 
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks> 'Ayesha Rehman :TFS1663 </remarks>
    Public Function getCustomerBottomSaleRate() As Integer
        Try


            Dim str As String = "SELECT * FROM tblDefCustomerBottomSaleRate WHERE TypeID = " & Me.cmbVendor.ActiveRow.Cells("typeid").Value & " and ArticleDefID = " & Me.cmbItem.ActiveRow.Cells(0).Value & ""
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then

                    CustSaleRate = Val(dt.Rows(0).Item("MPrice").ToString)
                    Return CustSaleRate
                End If
            End If
        Catch ex As Exception

        End Try
    End Function
    ''End TFS1663
    Public Sub FillCombo(ByVal strCondition As String)
        Dim str As String = String.Empty
        'Dim List As New List(Of COAMain)
        'Dim List1 As New List(Of COAMainSub)
        'Dim List2 As New List(Of COAMainSubSub)
        'Dim List3 As New List(Of COADeail)
        'List = New COADetailDAL().AllCOAMain()
        'List1 = main.COAMainSubList

        'select * from tbldeftransporter where active=1
        If strCondition = "ItemFilter" Then
            'If Me.RdoCode.Checked = True Then
            '    str = "SELECT     ArticleDefView.ArticleId AS Id, ArticleDefView.ArticleCode AS Code, ArticleDefView.ArticleDescription AS Item, "
            'Else
            '    str = "SELECT     ArticleDefView.ArticleId AS Id, ArticleDefView.ArticleDescription AS Item, ArticleDefView.ArticleCode AS Code, "
            'End If

            ''If Not Me.cmbCategory.SelectedValue > 0 Then
            'str = str + " ArticleDefView.ArticleSizeName AS Size, ArticleDefView.ArticleColorName AS Combination, ArticleDefView.SalePrice AS Price, " & _
            '      "ArticleDefView.PurchasePrice, vw_articlestock.Stock  , ArticleDefView.SizeRangeID as [Size ID]   FROM         ArticleDefView, vw_articlestock " & _
            '      "WHERE     ArticleDefView.ArticleId = vw_articlestock.ArticleId and (ArticleDefView.Active = 1)"

            ''Else

            ''    str = str + " ArticleDefView.ArticleSizeName AS Size, ArticleDefView.ArticleColorName AS Combination, ArticleDefView.SalePrice AS Price, " & _
            ''         "ArticleDefView.PurchasePrice , vw_articlestock.Stock , ArticleDefView.SizeRangeID as [Size ID] FROM         ArticleDefView, vw_articlestock  " & _
            ''         "WHERE       ArticleDefView.ArticleId = vw_articlestock.ArticleId and (ArticleDefView.Active = 1) And ArticleGroupID = " & cmbCategory.SelectedValue

            ''End If
        ElseIf strCondition = "Item" Or strCondition = "ItemFilter" Then
            'Comment against task:2388
            'If getConfigValueByType("StockViewOnSale").ToString = "True" Then
            '    str = "SP_ProductList"
            '    FillUltraDropDown(Me.cmbItem, str)
            '    Me.cmbItem.Rows(0).Activate()
            '    Me.cmbItem.DisplayLayout.Bands(0).Columns("Size ID").Hidden = True
            '    Me.cmbItem.DisplayLayout.Bands(0).Columns("PurchasePrice").Hidden = True
            '    If rdoName.Checked = True Then
            '        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(2).Column.Key.ToString
            '    Else
            '        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(1).Column.Key.ToString
            '    End If
            'Else
            'End Task:2388
            'Before against task:2
            'str = "SELECT ArticleId as Id, ArticleCode as Code, ArticleDescription as Item, ArticleSizeName as Size, ArticleColorName as Combination, Isnull(SalePrice,0) as Price,  ArticleDefView.SizeRangeID as [Size ID], 0 as Stock, Isnull(PurchasePrice,0) as PurchasePrice, Isnull(SubSubId,0) as AccountId FROM ArticleDefView where Active=1 AND SalesItem=1"
            'Task:2388 Added Field ServiceItem
            'str = "SELECT ArticleId as Id, ArticleCode as Code, ArticleDescription as Item, ArticleSizeName as Size, ArticleColorName as Combination, Isnull(SalePrice,0) as Price,  ArticleDefView.SizeRangeID as [Size ID], 0 as Stock, Isnull(PurchasePrice,0) as PurchasePrice, Isnull(SubSubId,0) as AccountId, Isnull(ServiceItem,0) as ServiceItem, ArticleDefView.SortOrder , ArticleGroupName as [Dept], ArticleTypeName as [Type], ArticleGenderName as [Origin],ArticleLPOName as [Brand] FROM ArticleDefView where Active=1 AND SalesItem=1"
            'End Task:2388
            'str = "SELECT ArticleId as Id, ArticleCode as Code, ArticleDescription as Item, ArticleSizeName as Size, ArticleColorName as Combination, Isnull(SalePrice,0) as Price,  ArticleDefView.SizeRangeID as [Size ID], 0 as Stock, Isnull(PurchasePrice,0) as PurchasePrice, Isnull(SubSubId,0) as AccountId, Isnull(ServiceItem,0) as ServiceItem, ArticleDefView.SortOrder , ArticleGroupName as [Dept], ArticleTypeName as [Type], ArticleGenderName as [Origin],ArticleLPOName as [Brand], SalesAccountId, CGSAccountId FROM ArticleDefView where Active=1 AND SalesItem=1"
            '29-Jun-2017: Task # 945: Waqar Raza: Add Rack and model on basis of jobcard.
            'TFS1610:18-OCT-2017:Rai Haider :Filter Stock In Item List According to location selected in location dropdown
            'TFS1154 : Filling Combo Item with Retail Price
            ''TFS3328 : Added MasterId in Query while filling Item  : Ayesha Rehman : 14-05-2018 

            str = "SELECT ArticleDefView.ArticleId as Id, ArticleCode as Code, ArticleDescription as Item, ArticleSizeName as Size, ArticleColorName as Combination, ArticleModel.Name As Model,ArticleDefView.ArticleBrandName As Grade, Isnull(SalePrice,0) as Price, ArticleDefView.SizeRangeID as [Size ID], Isnull(ArticleDefView.ArticleTaxId,0) as [Tax ID], Isnull(PurchasePrice,0) as PurchasePrice, Isnull(SubSubId,0) as AccountId, Isnull(ServiceItem,0) as ServiceItem, ArticleDefView.SortOrder, ArticleGroupName as [Dept], ArticleTypeName as [Type], ArticleGenderName as [Origin],ArticleLPOName as [Brand],Isnull(LogicalItem,0) as LogicalItem, SalesAccountId, CGSAccountId, MasterID , IsNull(Cost_Price,0) as Cost_Price, IsNull(TradePrice,0) as [Trade Price], IsNull(PrintedRetailPrice,0) as [Retail Price], Isnull(StockDetail.Stock,0) as Stock, IsNull(dbo.ArticleDefView.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp FROM ArticleDefView LEFT OUTER JOIN  (Select ArticleDefId, Sum(IsNull(InQty, 0)-IsNull(OutQty, 0)) As Stock From StockDetailTable " & IIf(Me.cmbCategory.SelectedIndex <> -1, " WHERE LocationId=" & Me.cmbCategory.SelectedValue & "", "") & "  Group By ArticleDefId) As StockDetail ON ArticleDefView.ArticleId = StockDetail.ArticleDefId Left Outer Join (Select ArticleId, ArticleModelList.ModelId, tblDefModelList.Name From ArticleModelList Inner Join tblDefModelList ON  ArticleModelList.ModelId = tblDefModelList.ModelId " & IIf(ModelId > 0, "where ArticleModelList.ModelId = " & ModelId & "", "") & ") As ArticleModel On  ArticleDefView.ArticleId=ArticleModel.ArticleId Where ArticleDefView.Active=1 AND IsNull(ArticleDefView.SalesItem, 0) = 1 "
            If flgCompanyRights = True Then
                str += " AND ArticleDefView.CompanyId=" & MyCompanyId
            End If
            If getConfigValueByType("ArticleFilterByLocation") = "True" Then
                If GetRestrictedItemFlg(Me.cmbCategory.SelectedValue) = True Then
                    str += " AND ArticleDefView.ArticleId In (Select ArticleDefId From RestrictedItemByLocationTable WHERE LocationId=" & Me.cmbCategory.SelectedValue & " AND Restricted=1)"
                End If
            End If
            If ModelId > 0 Then
                'If GetRestrictedItemFlg(Me.cmbCategory.SelectedValue) = True Then
                str += " AND ArticleDefView.ArticleId In (Select ArticleId From ArticleModelList WHERE ModelId=" & ModelId & ")"

                'End If
            End If
            If Me.rbtCustomer.Checked = True Then
                If Me.cmbVendor.ActiveRow Is Nothing Then Exit Sub
                str += " AND MasterId in(Select ArticleDefId From ArticleDefCustomers WHERE CustomerId=N'" & Me.cmbVendor.Value & "')"
            End If
            'str += " ORDER By ArticleDefView.SortOrder Asc "
            ''03-Mar-2014  Task:2452    Imran Ali  4-ALPHABETIC order of items in sale and purchase window
            If ItemSortOrder = True Then
                str += " ORDER By ArticleDefView.SortOrder " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            ElseIf ItemSortOrderByCode = True Then
                str += " ORDER By ArticleDefView.ArticleCode " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            ElseIf ItemSortOrderByName = True Then
                str += " ORDER By ArticleDefView.ArticleDescription " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            Else
                str += " ORDER By ArticleDefView.SortOrder " & IIf(ItemAscending = True, "Asc", "Desc") & ""
            End If
            'End Task:2452

            FillUltraDropDown(Me.cmbItem, str)
            Me.cmbItem.Rows(0).Activate()

            '29-Jun-2017: Task # 975: Waqar Raza: Rack enable/disable wrt its configuration value.
            If getConfigValueByType("RackonSalesItemLoad") = "True" Then
                '20-July-2017: Task TFS1084: Waqar Raza: Added for HFR to Show rack on item load.
                'Start Task:
                Me.txtRack.Visible = True
            Else
                Me.txtRack.Visible = False
            End If
            'End Task:
            Me.cmbItem.DisplayLayout.Bands(0).Columns("Size ID").Hidden = True
            'Me.cmbItem.DisplayLayout.Bands(0).Columns("Stock").Hidden = True
            Me.cmbItem.DisplayLayout.Bands(0).Columns("PurchasePrice").Hidden = True
            Me.cmbItem.DisplayLayout.Bands(0).Columns("AccountId").Hidden = True '' Add New Column for Sales Account Id
            Me.cmbItem.DisplayLayout.Bands(0).Columns("ServiceItem").Hidden = True '' Task:2388 Servicie Item Column Hidden
            Me.cmbItem.DisplayLayout.Bands(0).Columns("SortOrder").Hidden = True
            Me.cmbItem.DisplayLayout.Bands(0).Columns("SalesAccountId").Hidden = True '' Task:2388 Servicie Item Column Hidden
            Me.cmbItem.DisplayLayout.Bands(0).Columns("CGSAccountId").Hidden = True
            Me.cmbItem.DisplayLayout.Bands(0).Columns("Cost_Price").Hidden = True
            Me.cmbItem.DisplayLayout.Bands(0).Columns("ApplyAdjustmentFuelExp").Hidden = True

            If ItemFilterByName = True Then
                rdoName.Checked = True
                Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(2).Column.Key.ToString
            Else
                If rdoName.Checked = True Then
                    Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(2).Column.Key.ToString
                Else
                    Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(1).Column.Key.ToString
                End If
            End If
            'End If 'Comment against task:2388





        ElseIf strCondition = "Transporter" Then
            str = "select * from tbldeftransporter where active=1 order by sortorder,2"
            FillDropDown(Me.cmbTransporter, str)
            '13-11-2017 : Ayesha Rehman : TFS1153 : Filling Combo Discount Type 
        ElseIf strCondition = "Discount Type" Then
            str = "select DiscountID, DiscountType from tblDiscountType "
            FillDropDown(Me.cmbDiscountType, str, False)
            'Me.cmbDiscountType.SelectedIndex = 2 'TFS1153
            'ElseIf strCondition = "Barcodes" Then
            '    str = "SELECT     ArticleDefView.ArticleId AS Id, ArticleDefView.ArticleDescription AS Item, ArticleDefView.ArticleCode AS Code, "
            '    str = str + " ArticleDefView.ArticleSizeName AS Size, ArticleDefView.ArticleColorName AS Combination, ArticleDefView.SalePrice AS Price, " & _
            '                          " ArticleDefView.PurchasePrice, vw_articlestock.Stock  , ArticleDefView.SizeRangeID as [Size ID]   FROM         ArticleDefView, vw_articlestock " & _
            '                          " WHERE ArticleDefView.ArticleId = vw_articlestock.ArticleId and (ArticleDefView.Active = 1)"
            '    If flgCompanyRights = True Then
            '        str += " AND ArticleDefView.CompanyId=" & MyCompanyId
            '    End If
            'FillUltraDropDown(Me.cmbCodes, str)
            'If Me.cmbCodes.Rows.Count > 0 Then Me.cmbCodes.Rows(0).Activate() : Me.cmbCodes.DisplayLayout.Bands(0).Columns("Size ID").Hidden = True
            '24-11-2017 : Ayesha Rehman : TFS1153 : Filling Grid Combo Discount Type 
        ElseIf strCondition = "grdDiscountType" Then
            str = "select DiscountID, DiscountType from tblDiscountType"
            Dim dt As DataTable = GetDataTable(str)
            Me.grd.RootTable.Columns("DiscountId").ValueList.PopulateValueList(dt.DefaultView, "DiscountID", "DiscountType")
            '24-11-2017 : Ayesha Rehman : TFS1153 : Filling Grid Combo Discount Type 
            'ElseIf strCondition = "grdDiscountType" Then
            '    str = "select DiscountID, DiscountType from tblDiscountType"
            '    Dim dt As DataTable = GetDataTable(str)
            '    Me.grd.RootTable.Columns("DiscountType").ValueList.PopulateValueList(dt.DefaultView, "DiscountID", "DiscountType")
        ElseIf strCondition = "Category" Then
            'Task#16092015  Load user wise locations
            'If getConfigValueByType("UserwiseLocation").ToString = "True" Then
            '    str = "Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") order by sort_order"
            'Else
            '    str = "Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation order by sort_order"
            'End If
            'TFS1610:18-OCT-2017:Rai Haider :Location fill according to given rights for location for user
            str = "If  exists(select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") " _
                    & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") order by sort_order " _
                    & " Else " _
                    & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation order by sort_order"
            FillDropDown(cmbCategory, str, False)
        ElseIf strCondition = "SearchLocation" Then
            str = "Select CompanyId, CompanyName from CompanyDefTable order by 1"
            FillDropDown(Me.cmbSearchLocation, str, True)
            'Task#07072015 Add Condition Status for filling Status in cmbInvoiceStatus
        ElseIf strCondition = "Status" Then
            str = "SELECT SalesTaxInvoiceStatus_ID, SalesTaxInvoice_Status FROM tblSalesTaxInvoiceStatus"
            FillUltraDropDown(cmbInvoiceStatus, str, True)
            Me.cmbInvoiceStatus.Rows(0).Activate()
            Me.cmbInvoiceStatus.DisplayLayout.Bands(0).Columns("SalesTaxInvoiceStatus_ID").Hidden = True
            Me.cmbInvoiceStatus.DisplayLayout.Bands(0).Columns("SalesTaxInvoice_Status").Hidden = False
            Me.cmbInvoiceStatus.DisplayLayout.Bands(0).Columns("SalesTaxInvoice_Status").Header.Caption = "Invoice Status"
            'End Task#07072015
            'ElseIf strCondition = "ItemFilter" Then
            '    str = "SELECT     ArticleId as Id, ArticleCode Code, ArticleDescription Item, ArticleSizeName as Size, ArticleColorName as Combination,SalePrice as Price,Stock FROM         ArticleDefView where Active=1 and ArticleGroupID = " & cmbCategory.SelectedValue
            '    FillUltraDropDown(cmbItem, str)
            '    Me.cmbItem.Rows(0).Activate()
        ElseIf strCondition = "Vendor" Then
            'str = "SELECT     tblCustomer.AccountId AS ID, tblCustomer.CustomerName AS Name, tblListTerritory.TerritoryName AS Territory, tblListCity.CityName AS City,  " & _
            '        "tblListState.StateName AS State, tblCustomer.AccountId AS AcId " & _
            '        "FROM         tblListTerritory INNER JOIN " & _
            '        "tblListCity ON tblListTerritory.CityId = tblListCity.CityId INNER JOIN " & _
            '        "tblListState ON tblListCity.StateId = tblListState.StateId INNER JOIN " & _
            '        "tblCustomer ON tblListTerritory.TerritoryId = tblCustomer.Territory"

            If getConfigValueByType("Show Vendor On Sales") = "True" Then
                'Before against task:2373
                'str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name, tblListState.StateName as State, tblListCity.CityName as City,  " & _
                '                    "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate, tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel, tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, tblCustomer.Email,tblCustomer.Phone " & _
                '                    "FROM  tblCustomer LEFT OUTER JOIN " & _
                '                    "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                '                    "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                '                    "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                '                    "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                '                    "WHERE (vwCOADetail.account_type in( 'Customer','Vendor' )) and  vwCOADetail.coa_detail_id is not  null "
                'Task:2373 Added Column Sub Sub Title
                'str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name, tblListState.StateName as State, tblListCity.CityName as City,  " & _
                '                    "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate, tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel, tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, tblCustomer.Email,tblCustomer.Phone, vwCOADetail.Sub_Sub_Title " & _
                '                    "FROM  tblCustomer LEFT OUTER JOIN " & _
                '                    "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                '                    "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                '                    "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                '                    "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                '                    "WHERE (vwCOADetail.account_type in( 'Customer','Vendor' )) and  vwCOADetail.coa_detail_id is not  null "
                'End Task:2373
                ''Start TFS2236 : Ayesha Rehman : Sales to Employees, friends and family

                If getConfigValueByType("ShowMiscAccountsOnSales") = "True" Then

                    str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name, vwCOADetail.detail_code as [Code],tblListState.StateName as State, tblListCity.CityName as City,  " & _
                                 "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate, tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel, tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, vwCOADetail.Contact_Email as Email, vwCOADetail.Contact_Phone as Phone, vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title, IsNull(vwCOADetail.SaleMan,0) as SaleManId,IsNull(vwCOADetail.CreditDays,0) as CreditDays " & _
                                 "FROM  tblCustomer LEFT OUTER JOIN " & _
                                 "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                                 "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                                 "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                                 "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                                 "WHERE (vwCOADetail.account_type in( 'Customer','Vendor' )) and  vwCOADetail.coa_detail_id is not  null or vwCOADetail.coa_detail_id in (SELECT tblCOAMainSubSubDetail.coa_detail_id " & _
                                 "FROM tblMiscAccountsonSales INNER JOIN   tblCOAMainSubSubDetail ON tblMiscAccountsonSales.AccountId = tblCOAMainSubSubDetail.main_sub_sub_id where tblMiscAccountsonSales.Active = 1) "
                Else
                    str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name, vwCOADetail.detail_code as [Code],tblListState.StateName as State, tblListCity.CityName as City,  " & _
                                  "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate, tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel, tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, vwCOADetail.Contact_Email as Email, vwCOADetail.Contact_Phone as Phone, vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title, IsNull(vwCOADetail.SaleMan,0) as SaleManId,IsNull(vwCOADetail.CreditDays,0) as CreditDays " & _
                                  "FROM  tblCustomer LEFT OUTER JOIN " & _
                                  "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                                  "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                                  "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                                  "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                                  "WHERE (vwCOADetail.account_type in( 'Customer','Vendor' )) and  vwCOADetail.coa_detail_id is not  null "
                End If
               

                If flgCompanyRights = True Then
                    str += " AND vwCOADetail.CompanyId=" & MyCompanyId
                End If
            Else
                'Before against task:2373
                'str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name, tblListState.StateName as State, tblListCity.CityName as City,  " & _
                '                                   "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate,tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel , tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, tblCustomer.Email,tblCustomer.Phone " & _
                '                                   "FROM         tblCustomer LEFT OUTER JOIN " & _
                '                                   "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                '                                   "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                '                                   "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                '                                   "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                '                                   "WHERE (vwCOADetail.account_type='Customer') and  vwCOADetail.coa_detail_id is not  null "
                'Task:2373
                'str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name, tblListState.StateName as State, tblListCity.CityName as City,  " & _
                '                   "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate,tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel , tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, tblCustomer.Email,tblCustomer.Phone, vwCOADetail.Sub_Sub_Title " & _
                '                   "FROM         tblCustomer LEFT OUTER JOIN " & _
                '                   "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                '                   "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                '                   "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                '                   "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                '                   "WHERE (vwCOADetail.account_type='Customer') and  vwCOADetail.coa_detail_id is not  null "
                'End Task:2373
                '25-July-2017 TFS# 1045 : Waqar Raza : Added Configuration to show Customer User Wise if configuration is True
                'And if There is no Customer saved against any user then all Customer should display
                If getConfigValueByType("UserWiseCustomer") = "True" Then
                    ''Start TFS2236 : Ayesha Rehman : Sales to Employees, friends and family According to Accounts
                    If getConfigValueByType("ShowMiscAccountsOnSales") = "True" Then

                        str = "if exists(Select Userid from tblUserWiseCustomerList where Userid = " & LoginUserId & ")SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title AS Name, vwCOADetail.detail_code AS Code, tblListState.StateName AS State, tblListCity.CityName AS City, " & _
                         "tblListTerritory.TerritoryName AS Territory, tblCustomer.ExpiryDate, tblCustomer.DiscPer AS Discount, tblCustomer.OtherExpanses AS [Other Expense], " & _
                         "tblCustomer.Fuel, tblCustomer.CNG, tblCustomer.CridtLimt AS Limit, vwCOADetail.account_type AS Type, ISNULL(tblCustomer.CustomerTypes, 0) AS typeid, " & _
                         "vwCOADetail.Contact_Email AS Email, vwCOADetail.Contact_Phone AS Phone, vwCOADetail.Contact_Mobile AS Mobile, vwCOADetail.sub_sub_title, " & _
                         "ISNULL(vwCOADetail.SaleMan, 0) AS SaleManId, ISNULL(vwCOADetail.CreditDays, 0) AS CreditDays, tblUserWiseCustomerList.UserName, " & _
                       "tblUserWiseCustomerList.UserId " & _
                       "FROM         tblUserWiseCustomerList INNER JOIN " & _
                         "vwCOADetail ON tblUserWiseCustomerList.CustomerId = vwCOADetail.coa_detail_id LEFT OUTER JOIN " & _
                         "tblCustomer LEFT OUTER JOIN " & _
                         "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                         "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                         "tblListState ON tblListCity.StateId = tblListState.StateId ON vwCOADetail.coa_detail_id = tblCustomer.AccountId " & _
                           "WHERE     (vwCOADetail.account_type = 'Customer') AND (vwCOADetail.coa_detail_id IS NOT NULL) and tblUserWiseCustomerList.UserId = " & LoginUserId & " else " & _
                            "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name,vwCOADetail.detail_code as [Code], tblListState.StateName as State, tblListCity.CityName as City,  " & _
                                     "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate,tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel , tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, vwCOADetail.Contact_Email as Email, vwCOADetail.Contact_Phone as Phone, vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title, IsNull(vwCOADetail.SaleMan,0) as SaleManId, ISNULL(vwCOADetail.CreditDays,0) as CreditDays " & _
                                     "FROM         tblCustomer LEFT OUTER JOIN " & _
                                     "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                                     "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                                     "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                                     "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                                     "WHERE (vwCOADetail.account_type='Customer') and  vwCOADetail.coa_detail_id is not  null or vwCOADetail.coa_detail_id in (SELECT tblCOAMainSubSubDetail.coa_detail_id " & _
                                 "FROM tblMiscAccountsonSales INNER JOIN   tblCOAMainSubSubDetail ON tblMiscAccountsonSales.AccountId = tblCOAMainSubSubDetail.main_sub_sub_id where tblMiscAccountsonSales.Active = 1) "
                    Else
                        str = "if exists(Select Userid from tblUserWiseCustomerList where Userid = " & LoginUserId & ")SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title AS Name, vwCOADetail.detail_code AS Code, tblListState.StateName AS State, tblListCity.CityName AS City, " & _
                          "tblListTerritory.TerritoryName AS Territory, tblCustomer.ExpiryDate, tblCustomer.DiscPer AS Discount, tblCustomer.OtherExpanses AS [Other Expense], " & _
                          "tblCustomer.Fuel, tblCustomer.CNG, tblCustomer.CridtLimt AS Limit, vwCOADetail.account_type AS Type, ISNULL(tblCustomer.CustomerTypes, 0) AS typeid, " & _
                          "vwCOADetail.Contact_Email AS Email, vwCOADetail.Contact_Phone AS Phone, vwCOADetail.Contact_Mobile AS Mobile, vwCOADetail.sub_sub_title, " & _
                          "ISNULL(vwCOADetail.SaleMan, 0) AS SaleManId, ISNULL(vwCOADetail.CreditDays, 0) AS CreditDays, tblUserWiseCustomerList.UserName, " & _
                        "tblUserWiseCustomerList.UserId " & _
                        "FROM         tblUserWiseCustomerList INNER JOIN " & _
                          "vwCOADetail ON tblUserWiseCustomerList.CustomerId = vwCOADetail.coa_detail_id LEFT OUTER JOIN " & _
                          "tblCustomer LEFT OUTER JOIN " & _
                          "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                          "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                          "tblListState ON tblListCity.StateId = tblListState.StateId ON vwCOADetail.coa_detail_id = tblCustomer.AccountId " & _
                            "WHERE     (vwCOADetail.account_type = 'Customer') AND (vwCOADetail.coa_detail_id IS NOT NULL) and tblUserWiseCustomerList.UserId = " & LoginUserId & " else " & _
                             "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name,vwCOADetail.detail_code as [Code], tblListState.StateName as State, tblListCity.CityName as City,  " & _
                                      "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate,tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel , tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, vwCOADetail.Contact_Email as Email, vwCOADetail.Contact_Phone as Phone, vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title, IsNull(vwCOADetail.SaleMan,0) as SaleManId, ISNULL(vwCOADetail.CreditDays,0) as CreditDays " & _
                                      "FROM         tblCustomer LEFT OUTER JOIN " & _
                                      "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                                      "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                                      "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                                      "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                                      "WHERE (vwCOADetail.account_type='Customer') and  vwCOADetail.coa_detail_id is not  null "
                    End If
                Else
                    ''Start TFS2236 : Ayesha Rehman : Sales to Employees, friends and family According to Accounts
                    If getConfigValueByType("ShowMiscAccountsOnSales") = "True" Then

                        str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name,vwCOADetail.detail_code as [Code], tblListState.StateName as State, tblListCity.CityName as City,  " & _
                                    "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate,tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel , tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, vwCOADetail.Contact_Email as Email, vwCOADetail.Contact_Phone as Phone, vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title, IsNull(vwCOADetail.SaleMan,0) as SaleManId, ISNULL(vwCOADetail.CreditDays,0) as CreditDays " & _
                                    "FROM         tblCustomer LEFT OUTER JOIN " & _
                                    "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                                    "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                                    "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                                    "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                                    "WHERE (vwCOADetail.account_type='Customer') and vwCOADetail.coa_detail_id is not  null or vwCOADetail.coa_detail_id in (SELECT tblCOAMainSubSubDetail.coa_detail_id " & _
                                   "FROM tblMiscAccountsonSales INNER JOIN   tblCOAMainSubSubDetail ON tblMiscAccountsonSales.AccountId = tblCOAMainSubSubDetail.main_sub_sub_id where tblMiscAccountsonSales.Active = 1) "
                    Else
                        str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name,vwCOADetail.detail_code as [Code], tblListState.StateName as State, tblListCity.CityName as City,  " & _
                                      "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate,tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel , tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, vwCOADetail.Contact_Email as Email, vwCOADetail.Contact_Phone as Phone, vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title, IsNull(vwCOADetail.SaleMan,0) as SaleManId, ISNULL(vwCOADetail.CreditDays,0) as CreditDays " & _
                                      "FROM         tblCustomer LEFT OUTER JOIN " & _
                                      "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                                      "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                                      "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                                      "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                                      "WHERE (vwCOADetail.account_type='Customer') and  vwCOADetail.coa_detail_id is not  null "
                    End If
                End If
                If flgCompanyRights = True Then
                    str += " AND vwCOADetail.CompanyId=" & MyCompanyId
                End If
            End If
            ''Start TFS3322 : Ayesha Rehman : 15-05-2018
            ' If LoginGroup = "Administrator" Then
            If GetMappedUserId() > 0 And getGroupAccountsConfigforSales(Me.Name) And LoginGroup <> "Administrator" Then
                str = "SELECT     vwCOADetail.coa_detail_id AS Id, vwCOADetail.detail_title as Name,vwCOADetail.detail_code as [Code], tblListState.StateName as State, tblListCity.CityName as City,  " & _
                                   "tblListTerritory.TerritoryName as Territory , tblCustomer.ExpiryDate,tblCustomer.Discper as [Discount] ,tblCustomer.otherexpanses as [Other Expense], tblCustomer.Fuel as Fuel , tblCustomer.CNG as CNG , tblCustomer.Cridtlimt as Limit, dbo.vwCOADetail.account_type as Type, isnull(customertypes,0) as typeid, vwCOADetail.Contact_Email as Email, vwCOADetail.Contact_Phone as Phone, vwCOADetail.Contact_Mobile as Mobile, vwCOADetail.Sub_Sub_Title, IsNull(vwCOADetail.SaleMan,0) as SaleManId, ISNULL(vwCOADetail.CreditDays,0) as CreditDays " & _
                                   "FROM         tblCustomer LEFT OUTER JOIN " & _
                                   "tblListTerritory ON tblCustomer.Territory = tblListTerritory.TerritoryId LEFT OUTER JOIN " & _
                                   "tblListCity ON tblListTerritory.CityId = tblListCity.CityId LEFT OUTER JOIN " & _
                                   "tblListState ON tblListCity.StateId = tblListState.StateId RIGHT OUTER JOIN " & _
                                   "vwCOADetail ON tblCustomer.AccountId = vwCOADetail.coa_detail_id " & _
                                   "WHERE ( vwCOADetail.coa_detail_id is not  null ) "
                str += " And (coa_detail_id in (Select COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 3) and COAUserMapping.[User_Id]= " & LoginGroupId & " ) " _
                       & " or main_sub_sub_id in (SELECT COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 2) and COAUserMapping.[User_Id]= " & LoginGroupId & " ) " _
                       & " or main_sub_id in (SELECT COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 1) and COAUserMapping.[User_Id]= " & LoginGroupId & " ) " _
                       & " or coa_main_id in (SELECT   COAAccountMapping.AccountId FROM COAAccountMapping INNER JOIN COAGroups ON COAAccountMapping.COAGroupId = COAGroups.COAGroupId INNER JOIN COAUserMapping ON COAGroups.COAGroupId = COAUserMapping.COAGroupId WHERE (COAAccountMapping.AccountLevel = 0) and COAUserMapping.[User_Id]= " & LoginGroupId & ") ) "
                ''TFS4689 : Getting Relevent Accounts according to the screen and Configuration
                If Not getConfigValueByType("Show Vendor On Sales") = "True" Then
                    str += " AND   (dbo.vwCOADetail.account_type = 'Customer') "
                Else
                    str += " AND   (dbo.vwCOADetail.account_type in('Customer','Vendor')) "
            End If
            End If
            ''End TFS3322
            If IsEditMode = False Then
                str += " AND vwCOADetail.Active=1"
            Else
                str += " AND vwCOADetail.Active in(0,1,NULL)"
            End If
            str += " order by tblCustomer.Sortorder, vwCOADetail.detail_title "
            FillUltraDropDown(cmbVendor, str)
            If cmbVendor.DisplayLayout.Bands(0).Columns.Count > 0 Then
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Id).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Territory).Hidden = False
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.State).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.ExpiryDate).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Fuel).Hidden = True
                ' CNG Changes
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.CNG).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Other_Exp).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns("typeid").Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns("Email").Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Discount).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Credit_Limit).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Type).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Name).Width = 300
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Credit_Limit).Width = 80
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.Discount).Width = 80
                'Task:2373 Column Formating
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.SubSubTitle).Header.Caption = "Ac Head"
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.SubSubTitle).Width = 120
                'End Task:2373
                Me.cmbVendor.DisplayLayout.Bands(0).Columns(Customer.SaleMan).Hidden = True
                Me.cmbVendor.DisplayLayout.Bands(0).Columns("CreditDays").Hidden = True
            End If
            Me.cmbVendor.Rows(0).Activate()
        ElseIf strCondition = "SearchVendor" Then
            Dim ShowVendorOnSales As Boolean = False
            Dim ShowMiscAccountsOnSales As Boolean = False

            If Not getConfigValueByType("Show Vendor On Sales") = "Error" Then
                ShowVendorOnSales = CBool(getConfigValueByType("Show Vendor On Sales"))
            End If
            If Not getConfigValueByType("ShowMiscAccountsOnSales") = "Error" Then
                ShowMiscAccountsOnSales = CBool(getConfigValueByType("ShowMiscAccountsOnSales"))
            End If
            str = "SELECT     dbo.vwCOADetail.coa_detail_id AS Id, dbo.vwCOADetail.detail_title as Name,vwCOADetail.detail_code as [Code], dbo.tblListState.StateName as State, dbo.tblListCity.CityName as City,  " & _
                                           "dbo.tblListTerritory.TerritoryName as Territory, tblCustomer.Email,tblCustomer.Phone, tblCustomer.Mobile " & _
                                           "FROM dbo.tblCustomer INNER JOIN " & _
                                           "dbo.tblListTerritory ON dbo.tblCustomer.Territory = dbo.tblListTerritory.TerritoryId INNER JOIN " & _
                                           "dbo.tblListCity ON dbo.tblListTerritory.CityId = dbo.tblListCity.CityId INNER JOIN " & _
                                           "dbo.tblListState ON dbo.tblListCity.StateId = dbo.tblListState.StateId RIGHT OUTER JOIN " & _
                                           "dbo.vwCOADetail ON dbo.tblCustomer.AccountId = dbo.vwCOADetail.coa_detail_id " _
                                           & " WHERE dbo.vwCOADetail.detail_title Is Not NULL " & IIf(ShowVendorOnSales = True, " AND (dbo.vwCOADetail.account_type in ('Customer','Vendor'))", " AND (dbo.vwCOADetail.account_type in ('Customer'))") & "" _
                                       & "" & IIf(ShowMiscAccountsOnSales = True, " OR vwCOADetail.coa_detail_id IN (SELECT  DISTINCT tblCOAMainSubSubDetail.coa_detail_id " & _
                                      "FROM tblMiscAccountsonSales INNER JOIN   tblCOAMainSubSubDetail ON tblMiscAccountsonSales.AccountId = tblCOAMainSubSubDetail.main_sub_sub_id where tblMiscAccountsonSales.Active = 1) ", "") & ""
            If flgCompanyRights = True Then
                str += " AND vwCOADetail.CompanyId=" & MyCompanyId
            End If
            str += " order by tblCustomer.Sortorder, vwCOADetail.detail_title"
            FillUltraDropDown(cmbSearchAccount, str)
            If Me.cmbSearchAccount.DisplayLayout.Bands.Count > 0 Then
                Me.cmbSearchAccount.DisplayLayout.Bands(0).Columns(0).Hidden = True
                Me.cmbSearchAccount.DisplayLayout.Bands(0).Columns("Email").Hidden = True
            End If

        ElseIf strCondition = "SO" Then
            'Before against request no . M6
            'str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(varchar(12), SalesOrderMasterTable.SalesOrderDate,113) as SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date, ISNULL(SpecialAdjustment,0) as SpecialAdjustment from SalesOrderMasterTable where salesorderId not in(select PoId from salesMasterTable) " & IIf(flgCompanyRights = True, " AND LocationId=" & MyCompanyId & "", "") & " ORDER BY 1 ASC"
            'R:M6 Filter By Post
            'str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(varchar(12), SalesOrderMasterTable.SalesOrderDate,113) as SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date, ISNULL(SpecialAdjustment,0) as SpecialAdjustment from SalesOrderMasterTable where salesorderId not in(select PoId from salesMasterTable) " & IIf(flgCompanyRights = True, " AND LocationId=" & MyCompanyId & "", "") & " AND IsNull(Posted,0)=1 AND Status='Open' ORDER BY SalesOrderID DESC"

            'End R:M6
            'str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(varchar(12), SalesOrderMasterTable.SalesOrderDate,113) as SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date, ISNULL(SpecialAdjustment,0) as SpecialAdjustment from SalesOrderMasterTable where VendorID=" & Me.cmbVendor.Value & " AND SalesOrderNo  <> '' " & IIf(flgCompanyRights = True, " AND LocationId=" & MyCompanyId & "", "") & " AND IsNull(Posted,0)=1 AND Status='Open' ORDER BY SalesOrderID DESC"
            ''Start TFS3668 : Ayesha Rehman : 29-06-2018 : Selecting Adjustment column from SalesOrderMasterTable
            str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(varchar(12), SalesOrderMasterTable.SalesOrderDate,113) as SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date, ISNULL(SpecialAdjustment,0) as SpecialAdjustment,ISNULL(Adjustment,0) as Adjustment, ISNULL(Adj_Flag,0) as Adj_Flag,IsNull(SalesOrderMasterTable.UserId, 0) As UserId, IsNull(TransporterId, 0) AS TransporterId from SalesOrderMasterTable where VendorID=" & Me.cmbVendor.Value & " AND SalesOrderNo  <> '' AND LocationId=" & Me.cmbCompany.SelectedValue & " AND IsNull(Posted,0)=1 AND Status='Open' ORDER BY SalesOrderID DESC"
            FillDropDown(cmbPo, str)
        ElseIf strCondition = "SOComplete" Then
            'Before against R:M6
            'str = "Select SalesOrderID, SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date,ISNULL(SpecialAdjustment,0) as SpecialAdjustment from SalesOrderMasterTable " & IIf(flgCompanyRights = True, " AND LocationId=" & MyCompanyId & "", "") & " "
            'R:M6 Filter By Posted
            ''Start TFS3668 : Ayesha Rehman : 29-06-2018 : Selecting Adjustment ,Adj_flg column from SalesOrderMasterTable
            str = "SalesOrderID, SalesOrderNo + ' ~ ' + Convert(varchar(12), SalesOrderMasterTable.SalesOrderDate,113) as SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date, ISNULL(SpecialAdjustment,0) as SpecialAdjustment,ISNULL(Adjustment,0) as Adjustment,ISNULL(Adj_Flag,0) as Adj_Flag, IsNull(SalesOrderMasterTable.UserId, 0) As UserId, IsNull(TransporterId, 0) AS TransporterId   from SalesOrderMasterTable " & IIf(flgCompanyRights = True, " AND LocationId=" & MyCompanyId & "", "") & "  AND Posted=1"
            'End R:M6
            FillDropDown(cmbPo, str)
        ElseIf strCondition = "SM" Then
            str = "Select Employee_ID, Employee_Name  + ' - ' + employee_Code as EmployeeName from tblDefEmployee WHERE SalePerson <> 0 And Active = 1" ''TASKTFS75 added and set active =1
            FillDropDown(Me.cmbSalesMan, str)
        ElseIf strCondition = "Company" Then
            'Before against task:2427
            'str = "Select CompanyId, CompanyName from CompanyDefTable " & IIf(flgCompanyRights = True, " WHERE CompanyId=" & MyCompanyId, "") & ""
            'Task:2427 Added Column CosterCenterId
            'Before against task:2677
            'str = "Select CompanyId, CompanyName, Isnull(CostCenterId,0) as CostCenterId from CompanyDefTable " & IIf(flgCompanyRights = True, " WHERE CompanyId=" & MyCompanyId, "") & ""
            'End Task:2427
            'Task:2677 Added Field CommercialInvoice
            'Task#16092015  Load user wise companies
            'If getConfigValueByType("UserwiseCompany").ToString = "True" Then
            '    str = "Select CompanyId, CompanyName, Isnull(CostCenterId,0) as CostCenterId, IsNull(CommercialInvoice,0) as CommercialInvoice from CompanyDefTable WHERE CompanyName <> '' " & IIf(flgCompanyRights = True, " WHERE CompanyId=" & MyCompanyId, "") & " And CompanyId in (select CompanyId from tblUserCompanyRights where User_Id = " & LoginUserId & ")"
            'Else
            '    str = "Select CompanyId, CompanyName, Isnull(CostCenterId,0) as CostCenterId, IsNull(CommercialInvoice,0) as CommercialInvoice from CompanyDefTable " & IIf(flgCompanyRights = True, " WHERE CompanyId=" & MyCompanyId, "") & ""
            'End If
            str = "If  exists(select CompanyId from tblUserCompanyRights where User_Id = " & LoginUserId & " And CompanyId Is Not Null) " _
                & "Select CompanyId, CompanyName, Isnull(CostCenterId,0) as CostCenterId, IsNull(CommercialInvoice,0) as CommercialInvoice from CompanyDefTable WHERE CompanyName <> '' " & IIf(flgCompanyRights = True, " WHERE CompanyId=" & MyCompanyId, "") & " And CompanyId in (select CompanyId from tblUserCompanyRights where User_Id = " & LoginUserId & ")" _
                & "Else " _
                & "Select CompanyId, CompanyName, Isnull(CostCenterId,0) as CostCenterId, IsNull(CommercialInvoice,0) as CommercialInvoice from CompanyDefTable " & IIf(flgCompanyRights = True, " WHERE CompanyId=" & MyCompanyId, "") & ""

            'End Task:2677
            FillDropDown(Me.cmbCompany, str, False)
        ElseIf strCondition = "grdLocation" Then
            'Task#16092015  Load user wise locations
            'If getConfigValueByType("UserwiseLocation").ToString = "True" Then
            '    str = "Select Location_Id, Location_Name,IsNull(AllowMinusStock,0) as AllowMinusStock From tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ")"
            'Else
            '    str = "Select Location_Id, Location_Name,IsNull(AllowMinusStock,0) as AllowMinusStock From tblDefLocation"
            'End If

            str = "If  exists(select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") " _
                   & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation where Location_id in (select Location_Id FROM tblUserLocationRights where UserID = " & LoginUserId & ") order by sort_order " _
                   & " Else " _
                   & " Select Location_Id, Location_Code,IsNull(AllowMinusStock,0) as AllowMinusStock from tblDefLocation order by sort_order"


            Dim dt As DataTable = GetDataTable(str)
            Me.grd.RootTable.Columns("LocationId").ValueList.PopulateValueList(dt.DefaultView, "Location_Id", "Location_Code")
        ElseIf strCondition = "grdSO" Then
            str = "Select SalesOrderID, SalesOrderNo from SalesOrderMasterTable Union Select 0, ''"
            Dim dt As DataTable = GetDataTable(str)
            Me.grd.RootTable.Columns("So_Id").ValueList.PopulateValueList(dt.DefaultView, "SalesOrderID", "SalesOrderNo")
        ElseIf strCondition = "Project" Then
            FillDropDown(Me.cmbProject, "If  exists(select CostCentre_Id FROM tblUserCostCentreRights where UserID = " & LoginUserId & " and ISNULL(CostCentre_Id, 0) > 0) " _
                    & "Select CostCenterID, Name from tblDefCostCenter where CostCenterID in (select CostCentre_Id FROM tblUserCostCentreRights where UserID = " & LoginUserId & ") order by SortOrder " _
                    & "Else " _
                    & "Select CostCenterID, Name from tblDefCostCenter where Active = 1 order by SortOrder")




        ElseIf strCondition = "ArticlePack" Then
            Me.cmbUnit.ValueMember = "ArticlePackId"
            Me.cmbUnit.DisplayMember = "PackName"
            Me.cmbUnit.DataSource = GetPackData(Me.cmbItem.Value)
            '//Task:2702 GET CMFA








        ElseIf strCondition = "CMFA" Then
            Dim strQuery As String = String.Empty
            strQuery = "SELECT CMFA.DocId, CMFA.DocNo + '~' + CONVERT(Varchar, CONVERT(Varchar, CMFA.DocDate, 102)) AS DocNo,CMFA.DocDate FROM dbo.CMFAMasterTable AS CMFA WHERE IsNull(CMFA.Approved,0)=1 AND CMFA.CustomerCode=" & IIf(Me.cmbVendor.ActiveRow Is Nothing, 0, cmbVendor.Value) & " AND CMFA.DocID IN(Select DocID From CMFADetailTable Group By DocID Having (SUM(IsNull(Sz1,0)-IsNull(SoldQty,0))) > 0)"
            FillDropDown(Me.cmbCMFADoc, strQuery)
            'End Task:2702
        ElseIf strCondition = "TaxRate" Then
            Dim strQuery As String = String.Empty
            strQuery = "Select ServicesID, ServicesType,Tax_Percent  From tblDefServices"
            FillDropDown(Me.cmbTaxCategory, strQuery)
        ElseIf strCondition = "Other_Company" Then
            FillDropDown(Me.cmbOtherCompany, "Select Other_Company,Other_Company From SalesMasterTable where other_company <> ''", False)
        ElseIf strCondition = "OutwardExpense" Then
            FillUltraDropDown(Me.cmbInwardExpense, "Select coa_detail_id, detail_title as [Account Title], detail_code as [Account Code], sub_sub_title as [Account Head], Account_Type as [Account Type] From vwCOADetail where detail_title <> ''")
            Me.cmbInwardExpense.Rows(0).Activate()
            If Me.cmbInwardExpense.DisplayLayout.Bands(0).Columns.Count > 0 Then
                Me.cmbInwardExpense.DisplayLayout.Bands(0).Columns(0).Hidden = True
            End If
            'Rafay:Modified query to add PO_NO
        ElseIf strCondition = "DeliveryChalan" Then
            str = "Select DeliveryChalanMasterTable.DeliveryId, DeliveryChalanMasterTable.DeliveryNo,DeliveryChalanMasterTable.BiltyNo,DeliveryChalanMasterTable.Remarks, IsNull(DeliveryChalanMasterTable.EmployeeCode,0) as EmployeeCode, IsNull(DeliveryChalanMasterTable.LocationId,0) as LocationId, IsNull(DeliveryChalanMasterTable.CostCenterId,0) as Project, SO.PONo, SO.PO_Date, Other_Company, IsNull(DeliveryChalanMasterTable.CustomerCode,0) as CustomerCode, DeliveryChalanMasterTable.Arrival_Time, DeliveryChalanMasterTable.Departure_Time, IsNull(DeliveryChalanMasterTable.JobCardId, 0) As JobCardId, IsNull(DeliveryChalanMasterTable.UserId, 0) As UserId , DeliveryChalanMasterTable.TransporterId,DeliveryChalanMasterTable.PO_NO From DeliveryChalanMasterTable LEFT OUTER JOIN SalesOrderMasterTable SO On So.SalesOrderID = DeliveryChalanMasterTable.POId  WHERE IsNull(Post,0)=1 AND (DeliveryChalanMasterTable.Status='Open' OR DeliveryChalanMasterTable.Status is null) AND CustomerCode=" & Me.cmbVendor.Value & ""
            FillDropDown(Me.cmbDeliveryChalan, str)
            'rafay
        ElseIf strCondition = "grdDeliveryChalan" Then
            Dim dt As New DataTable
            dt = GetDataTable("Select DeliveryID, DeliveryNo From DeliveryChalanMasterTable Union Select 0 as DeliveryID, 'N/A' as DeliveryNo ORDER BY DeliveryNo DESC")
            Me.grd.RootTable.Columns("DeliveryChalanID").ValueList.PopulateValueList(dt.DefaultView, "DeliveryID", "DeliveryNo")
        ElseIf strCondition = "Currency" Then ''TASK-407
            str = String.Empty
            str = "Select tblCurrency.currency_id, tblCurrency.currency_code, IsNull(tblCurrencyRate.CurrencyRate, 0) As CurrencyRate From tblCurrency Left Outer Join(Select * FROM tblCurrencyRate Where CurrencyRateId in (Select Max(CurrencyRateId) From tblCurrencyRate group by CurrencyId)) tblCurrencyRate On tblCurrency.currency_id = tblCurrencyRate.CurrencyId "
            FillDropDown(Me.cmbCurrency, str, False)
            Me.cmbCurrency.SelectedValue = BaseCurrencyId
        ElseIf strCondition = "Lift" Then
            FillUltraDropDown(Me.cmbLift, "Select CostCenterId, Name From tblDefCostCenter WHERE Active=1")
            If Me.cmbLift.DisplayLayout.Bands(0).Columns.Count > 0 Then
                Me.cmbLift.DisplayLayout.Bands(0).Columns(0).Hidden = True
            End If
            'Ali Faisal : TFS1362 : 22-Aug-2017 : Fill drop down
        ElseIf strCondition = "grdEngine" Then
            str = "SELECT Engine_No, Engine_No, Sum(InQty) InQty, Sum(OutQty) OutQty, Sum(InQty)-Sum(OutQty) Qty FROM StockDetailTable WHERE IsNull(Engine_No, '') <> '' GROUP BY Engine_No, Chassis_No HAVING Sum(InQty)-Sum(OutQty) > 0"
            Dim dt As DataTable = GetDataTable(str)
            Me.grd.RootTable.Columns("Engine_No").ValueList.PopulateValueList(dt.DefaultView, "Engine_No", "Engine_No")


        ElseIf strCondition = "grdChassis" Then
            str = "SELECT Chassis_No, Chassis_No, Sum(InQty) InQty, Sum(OutQty) OutQty, Sum(InQty)-Sum(OutQty) Qty FROM StockDetailTable WHERE IsNull(Engine_No, '') <> '' GROUP BY Engine_No, Chassis_No HAVING Sum(InQty)-Sum(OutQty) > 0"
            Dim dt As DataTable = GetDataTable(str)
            Me.grd.RootTable.Columns("Chassis_No").ValueList.PopulateValueList(dt.DefaultView, "Chassis_No", "Chassis_No")

        ElseIf strCondition = "grdBatch" Then
        str = "Select  BatchNo,BatchNo,ExpiryDate,Origin  From  StockDetailTable  where BatchNo not in ('','0','xxxx') Group by BatchNo,ExpiryDate,Origin Having (Sum(isnull(InQty, 0)) - Sum(isnull(OutQty, 0))) > 0 ORDER BY ExpiryDate  desc "
            Dim dt As DataTable = GetDataTable(str)
            Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).ValueList.PopulateValueList(dt.DefaultView, "BatchNo", "BatchNo")
            ''End TFS4181
        ElseIf strCondition = "GrdOrigin" Then
            str = "select CountryName, CountryName From tblListCountry Where Active = 1"
            Dim dtCountry As DataTable = GetDataTable(str)
            dtCountry.AcceptChanges()
            Me.grd.RootTable.Columns("Origin").ValueList.PopulateValueList(dtCountry.DefaultView, "CountryName", "CountryName")
            'Ali Faisal : TFS1362 : 22-Aug-2017 : End

            ''Commented bcz it needs to be Checked In
            'ElseIf strCondition = "grdBatchNo" Then
            '    str = "Select  DISTINCT BatchNo, BatchNo From  StockDetailTable  WHERE BatchNo NOT IN ('', '0') "
            '    If getConfigValueByType("ArticleFilterByLocation") = "True" Then
            '        If flgLocationWiseItems = True Then
            '            str += " AND LocationId=" & Me.cmbCategory.SelectedValue & " "
            '        End If
            '    End If
            '    If cmbItem.SelectedRow.Index > 0 Then
            '        str += " And ArticledefId=" & Me.cmbItem.Value & " 
            '    End If
            '    str += "  Group By BatchNo Having Sum(isnull(InQty, 0)) - Sum(isnull(OutQty, 0)) > 0 ORDER BY BatchNo ASC"
            '    Dim dt As DataTable = GetDataTable(str)
            '    Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).ValueList.PopulateValueList(dt.DefaultView, "BatchNo", "BatchNo")
        End If
    End Sub

    Private Sub txtPaid_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        txtBalance.Text = Val(txtAmount.Text) - Val(txtPaid.Text)
    End Sub

    Private Function Save() As Boolean

        'Changing Against Request No 836 By Imran Ali 
        '25-9-2013
        'Update Reference Of Bill No at Save/Update record

        If Me.chkPost.Visible = False Then
            Me.chkPost.Checked = False
        End If
        ''Start TFS3113
        If Me.chkDelivered.Visible = False Then
            Me.chkDelivered.Checked = False
        End If
        ''End TFS3113
        'cmbProject.SelectedValue = GetCostCenterId(Me.cmbCompany.SelectedValue)
        Me.txtPONo.Text = GetDocumentNo() 'GetNextDocNo("SI" & Me.cmbCompany.SelectedValue, 6, "SalesMasterTable", "SalesNo")
        Me.txtVoucherNo.Text = GetVoucherNo()
        Dim VoucherNo As String = GetVoucherNo()
        setVoucherNo = Me.txtPONo.Text
        Dim objCommand As New OleDbCommand
        Dim objCon As OleDbConnection
        Dim i As Integer
        gobjLocationId = MyCompanyId
        Dim lngVoucherMasterId As Integer = GetVoucherId(Me.Name, Me.txtPONo.Text)
        Dim InvAccountId As Integer = Val(getConfigValueByType("InvAccountId").ToString) 'GetConfigValue("InvAccountId") 'Inventory Account
        Dim CgsAccountId As Integer = Val(getConfigValueByType("CGSAccountId").ToString) 'GetConfigValue("CGSAccountId") 'Cost Of Good Sold Account
        Dim AccountId As Integer = Val(getConfigValueByType("SalesCreditAccount").ToString) 'GetConfigValue("SalesCreditAccount")
        'Dim SalesTaxId As Integer = Val(getConfigValueByType("SalesTaxCreditAccount").ToString) 'GetConfigValue("SalesTaxCreditAccount")
        Dim SalesTaxId As Integer = 0I
        If Me.cmbCompany.SelectedValue > 0 Then
            Dim str As String = "SELECT SalesTaxAccountId FROM CompanyDefTable WHERE CompanyId = " & cmbCompany.SelectedValue & " AND SalesTaxAccountId IS NOT NULL"
            Dim dt As DataTable = GetDataTable(str)
            If dt.Rows.Count > 0 Then
                SalesTaxId = dt.Rows(0).Item(0)
            End If
        End If
        If SalesTaxId = 0 Then
            SalesTaxId = Val(getConfigValueByType("SalesTaxCreditAccount").ToString) 'GetConfigValue("SalesTaxCreditAccount")
        End If
        Dim SEDAccountId As Integer = Val(getConfigValueByType("SEDAccountId").ToString) 'Val(GetConfigValue("SEDAccountId").ToString)
        Dim InsuranceAccountId As Integer = Val(getConfigValueByType("TransitInsuranceAccountId").ToString) 'Val(GetConfigValue("TransitInsuranceAccountId").ToString)
        Dim SalesDiscountAccount As Integer = Val(getConfigValueByType("SalesDiscountAccount").ToString)
        FuelExpAccount = Val(getConfigValueByType("FuelExpAccount").ToString)
        AdjustmentExpAccount = Val(getConfigValueByType("AdjustmentExpAccount").ToString)
        OtherExpAccount = Val(getConfigValueByType("OtherExpAccount").ToString)
        Dim IsDiscountVoucher As Boolean = Convert.ToBoolean(getConfigValueByType("DiscountVoucherOnSale").ToString) 'Convert.ToBoolean(GetConfigValue("DiscountVoucherOnSale").ToString)
        Dim GLAccountArticleDepartment As Boolean
        If Not getConfigValueByType("GLAccountArticleDepartment").ToString = "Error" Then
            GLAccountArticleDepartment = Convert.ToBoolean(getConfigValueByType("GLAccountArticleDepartment"))
        Else
            GLAccountArticleDepartment = False
        End If
        Dim blnCheckCurrentStockByItem As Boolean = False
        If Not getConfigValueByType("CheckCurrentStockByItem").ToString = "Error" Then
            blnCheckCurrentStockByItem = Convert.ToBoolean(getConfigValueByType("CheckCurrentStockByItem").ToString)
        End If
        'Val(GetConfigValue("SalesDiscountAccount").ToString)


        'Validtion on Configuration Account Id 
        '25-9-2013 by imran ali....

        If flgCgsVoucher = True Then
            If InvAccountId <= 0 Then
                ShowErrorMessage("Purchase account is not map.")
                Me.dtpPODate.Focus()
                Return False
            ElseIf CgsAccountId <= 0 Then
                ShowErrorMessage("Cost of good sold account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If AccountId <= 0 Then
            ShowErrorMessage("Sales account is not map.")
            Me.dtpPODate.Focus()
            Return False
        End If
        If Val(Me.txtTaxTotal.Text) > 0 Then
            If SalesTaxId <= 0 Then
                ShowErrorMessage("Sales tax account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtSEDTaxAmount.Text) > 0 Then
            If SEDAccountId <= 0 Then
                ShowErrorMessage("SED account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtAddTransitInsurance.Text) > 0 Then
            If InsuranceAccountId <= 0 Then
                ShowErrorMessage("Transit account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If IsDiscountVoucher = True Then
            If SalesDiscountAccount <= 0 Then
                ShowErrorMessage("Discount account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtFuel.Text) <> 0 Then
            If FuelExpAccount <= 0 Then
                ShowErrorMessage("Fuel account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtAdjustment.Text) <> 0 Then
            If AdjustmentExpAccount <= 0 Then
                ShowErrorMessage("Adjustment account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtExpense.Text) <> 0 Then
            If OtherExpAccount <= 0 Then
                ShowErrorMessage("Other expense account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If CheckDuplicateSerialNo() = True Then
            ShowErrorMessage("Serial No ALready Exist")
            Return False
        End If
        'R-974 Ehtisham ul Haq user friendly system modification on 3-1-14
        Me.lblProgress.Text = "Processing Please Wait ..."
        Me.lblProgress.Visible = True
        Application.DoEvents()
        Dim ReceiptVoucherFlg As String = Convert.ToString(getConfigValueByType("ReceiptVoucherOnSales").ToString) 'GetConfigValue("ReceiptVoucherOnSales").ToString

        'Dim ServiceItem As String = GetConfigValue("ServiceItem").ToString
        Dim DiscountedPrice As Double = 0
        'Dim strvoucherNo As String = GetNextDocNo("SV", 6, "tblVoucher", "voucher_no")
        Dim CurrentBalance As Double = CDbl(GetAccountBalance(Me.cmbVendor.ActiveRow.Cells(0).Value))
        Dim ExpenseChargeToCustomer As Boolean
        'If Not GetConfigValue("ExpenseChargeToCustomer").ToString = "Error" Then
        ExpenseChargeToCustomer = Convert.ToBoolean(getConfigValueByType("ExpenseChargeToCustomer").ToString) 'Convert.ToBoolean(GetConfigValue("ExpenseChargeToCustomer").ToString)
        'Code by Imran Ali
        Dim flgExcludeTaxPrice As Boolean = Convert.ToBoolean(getConfigValueByType("ExcludeTaxPrice").ToString) 'Task Against Req # 803 
        'Else
        '    ExpenseChargeToCustomer = False
        'End If
        ''TASK TFS1378
        Dim DCStockImpact As Boolean = False
        If Not getConfigValueByType("DCStockImpact").ToString = "Error" Then
            DCStockImpact = Convert.ToBoolean(getConfigValueByType("DCStockImpact").ToString)
        End If
        ''END TFS1378
        Dim str1 As String = ""
        Dim dt1 As DataTable
        str1 = "SELECT CustomerID, CustomerName, AccountId, UnBuiltAccountId FROM tblCustomer WHERE	Active = 1 AND AccountId = " & Me.cmbVendor.Value & " AND UnBuiltAccountId IS NOT NULL AND UnBuiltAccountId <> 0"
        dt1 = GetDataTable(str1)
        If dt1.Rows.Count > 0 Then
            UnbuildCustomerId = dt1.Rows(0).Item(3)
        Else
            UnbuildCustomerId = 0
        End If
        
        Dim AdjustmentAmountNew As Integer = 0I
        Dim SalesAccount As Integer = 0I
        If UnbuildCustomerId > 0 Then
            If msg_Confirm("Do you want to adjust invoice amount against unbuild A/C?") = True Then
                ''TASK TFS2741 Inclusion of deduction columns(Bardana deduction, other deduction)
                Dim DeductionAmount As Double = (Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.BardanaDeduction), Janus.Windows.GridEX.AggregateFunction.Sum)) + Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.OtherDeduction), Janus.Windows.GridEX.AggregateFunction.Sum))) * Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Price), Janus.Windows.GridEX.AggregateFunction.Sum))
                InvoiceAmount = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount), Janus.Windows.GridEX.AggregateFunction.Sum)) - DeductionAmount
                CostCenterId = Me.cmbProject.SelectedValue
                frmSalesUnBuildVoucher.ShowDialog()
                AdjustmentAmountNew = frmSalesUnBuildVoucher.AdjustmentAmount
                SalesAccount = frmSalesUnBuildVoucher.SalesAccount
            End If
        End If
       
        objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

        If objCon.State = ConnectionState.Open Then objCon.Close()

        objCon.Open()
        objCommand.Connection = objCon

        Dim trans As OleDbTransaction = objCon.BeginTransaction
        Try
            objCommand.CommandType = CommandType.Text


            objCommand.Transaction = trans

            GetTotal() 'Task:2770 Apply Total Amount.


            'Task#07072015 add Invoice_Status column in query
            'Task#1864 add InternalRemarks column in query
            'rafay :Modified the query to add PO_NO
            objCommand.CommandText = "Insert into SalesMasterTable (LocationId,SalesNo,SalesDate,CustomerCode,Poid, Employeecode,Com_Percentage,SalesQty,SalesAmount, CashPaid,PO_NO ,ContractNo, Remarks, InternalRemarks,UserName,PreviousBalance,TransporterId,BiltyNo,FuelExpense, OtherExpense, Adjustment, CostCenterId, Post,  DeliveryDate, Delivered, TransitInsurance, DeliveryChalanId, DcNo, Adj_Flag, Adj_Percentage, RefDocId, ManualInvoice, InvoiceParty, CMFADocID, DueDays,InvoiceType,Other_Company,Party_Mobile_No,Invoice_Status,Arrival_Time,Departure_Time, JobCardId, IsSOSeparateClosure, RevisionNumber) values( " _
            & Me.cmbCompany.SelectedValue & ", N'" & txtPONo.Text & "',N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'," & cmbVendor.ActiveRow.Cells(0).Value & "," & IIf(Me.cmbPo.SelectedIndex = -1, 0, cmbPo.SelectedValue) & "," & Me.cmbSalesMan.SelectedValue & ", " & IIf(Me.txtComPercentage.Text <> "", Me.txtComPercentage.Text, 0) & " , " & Math.Round(Val(txtTotalQty.Text), DecimalPointInValue) & "," & Val(txtAmount.Text) & ", " & Val(txtRecAmount.Text) & ",N'" & txtPO.Text.Replace("'", "''") & "',N'" & txtcontractno.Text.Replace("'", "''") & "',N'" & txtRemarks.Text.Replace("'", "''") & "',N'" & richTxtInternalRemarks.Text.Replace("'", "''") & "',N'" & LoginUserName & "'," & CurrentBalance & "," & Me.cmbTransporter.SelectedValue & ",N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "', " & Val(Me.txtFuel.Text) & "," & Val(Me.txtExpense.Text) & "," & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", " & Me.cmbProject.SelectedValue & ", " & IIf(Me.chkPost.Checked = True, 1, 0) & ", N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", " & Val(Me.txtAddTransitInsurance.Text) & ", " & IIf(DeliveryChalanId > 0, "" & DeliveryChalanId & "", "NULL") & ", N'" & Me.txtDcNo.Text.Replace("'", "''") & "', " & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", " & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", " & _RefDocId & ", " & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", N'" & Me.txtInvParty.Text.Replace("'", "''") & "', " & IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.SelectedValue, 0) & ", " & Val(Me.txtDueDays.Text) & ",N'" & Me.cmbInvType.Text.Replace("'", "''") & "', N'" & Me.cmbOtherCompany.Text.Replace("'", "''") & "','" & Me.txtMobileNo.Text.Replace("'", "''") & "'," & Me.cmbInvoiceStatus.Value & " ,N'" & dtpArrivalTime1.Value.ToString("h:mm:ss tt") & "', " & IIf(Me.dtpDepartureTime1.Checked = True, "Convert(Datetime,'" & Me.dtpDepartureTime1.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)", "NULL") & ", " & Val(Me.txtJobCardId.Text) & ", " & IIf(IsSOSeparateClosure = False, 0, 1) & ", 0)" _
            & " SELECT @@IDENTITY"
            InvId = objCommand.ExecuteScalar
            '//To Update JobCard History if radio button paid is checked//TASK # 943
            If txtJobCardNo.Text <> "" Then
                '29-Jun-2017: Task # 975: Waqar Raza: Change True and False to 1 and 0 for all SQL server.
                objCommand.CommandText = "Update tbljobcard set PaymentStatus = " & IIf(Paid = True, 1, 0) & " where JobCardId = " & Val(Me.txtJobCardId.Text) & ""
                InvId = objCommand.ExecuteScalar
            End If
            'End Task:2770
            getVoucher_Id = InvId
            If Mode = "Normal" Then
                '******************* if Post UnPost Sales Voucher Condition **********************
                '*********************************************************************************
                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                '                           & " cheque_no, cheque_date,post,Source,voucher_code, Employee_Id)" _
                '                           & " VALUES(" & gobjLocationId & ", 1,  7 , N'" & Me.txtPONo.Text & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                '                           & " NULL, NULL, " & IIf(Me.chkPost.Checked = True, 1, 0) & ",N'" & Me.Name & "',N'" & Me.txtPONo.Text & "', " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ")" _
                '                           & " SELECT @@IDENTITY"

                'Change Query for BillNo, set billno in reference
                objCommand.CommandText = ""
                'Before against task:M101
                'objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                '                           & " cheque_no, cheque_date,post,Source,voucher_code, Employee_Id, Reference)" _
                '                           & " VALUES(" & gobjLocationId & ", 1,  7 , N'" & Me.txtPONo.Text & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                '                           & " NULL, NULL, " & IIf(Me.chkPost.Checked = True, 1, 0) & ",N'" & Me.Name & "',N'" & Me.txtPONo.Text & "', " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ", N'" & _RefDocNo.Replace("'", "''") & "')" _
                '                           & " SELECT @@IDENTITY"
                'Task:M101 Added Field Remarks
                ''TASK TFS1427 Added User Name 
                objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                                       & " cheque_no, cheque_date,post,Source,voucher_code, Employee_Id, Reference,Remarks, UserName, Posted_UserName)" _
                                       & " VALUES(" & IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue) & ", 1,  7 , N'" & Me.txtPONo.Text & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                                       & " NULL, NULL, " & IIf(Me.chkPost.Checked = True, 1, 0) & ",N'" & Me.Name & "',N'" & Me.txtPONo.Text & "', " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ", N'" & _RefDocNo.Replace("'", "''") & "', N'" & Me.txtRemarks.Text.Replace("'", "''") & "', '" & LoginUserName & "', " & IIf(Me.chkPost.Checked = True, "N'" & LoginUserName & "'", "NULL") & ")" _
                                       & " SELECT @@IDENTITY"
                'End Task:M101
                'objCommand.Transaction = trans
                lngVoucherMasterId = objCommand.ExecuteScalar
                '***********************
                'Deleting Detail
                '***********************
                'objCommand = New OleDbCommand
                '  objCommand.Connection = Con
                objCommand.CommandText = ""
                objCommand.CommandText = "delete from tblVoucherDetail where voucher_Id =" & lngVoucherMasterId
                objCommand.ExecuteNonQuery()
            End If


            objCommand.CommandText = ""
            StockList = New List(Of StockDetail)

            For i = 0 To grd.GetRows.Length - 1
                'If CheckStock(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.LocationID).Value.ToString), Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value.ToString, Me.grd.GetRows(i).Cells(EnumGridDetail.Item).Value.ToString, Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value, Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) Then
                '    If _Qty > 0 Then
                '        Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value = _Qty
                '        _Qty = 0
                '    End If
                '    If _TotalQty > 0 Then
                '        Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value = _TotalQty
                '        Me.grd.GetRows(i).Cells(EnumGridDetail.LoadQty).Value = _TotalQty
                '        _TotalQty = 0
                '    End If

                If blnCheckCurrentStockByItem = True Then
                    CheckCurrentStockByItem(IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString), Me.grd, , trans)
                End If
                If GLAccountArticleDepartment = True Then
                    'Comment against task:2390
                    'AccountId = Val(grd.GetRows(i).Cells("SalesAccountId").Value.ToString)
                    InvAccountId = Val(grd.GetRows(i).Cells("InvAccountId").Value.ToString)
                    AccountId = Val(grd.GetRows(i).Cells("SalesAccountId").Value.ToString)
                    CgsAccountId = Val(grd.GetRows(i).Cells("CGSAccountId").Value.ToString)
                End If



                If blnTradePriceExceed = True Then
                    If Val(Me.grd.GetRows(i).Cells("TradePrice").Value.ToString) > Val(Me.grd.GetRows(i).Cells("Rate").Value.ToString) Then
                        'If Not msg_Confirm("Sales Price is greater than trade price" & (Chr(13)) & "Do u want to add this item?") = True Then
                        Throw New Exception("Sale price is less than trade price.")
                        'End If
                    End If
                End If
                Dim checkbatchno As String
                
                'checkbatchno = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0) as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) as BalanceAmount, IsNull(SUM(IsNull(InQty, 0) - IsNull(OutQty, 0)), 0) AS CheckStock From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " AND StockMasterTable.DocDate < " & Me.dtpPODate.Value.ToShortDateString & " And BatchNo = '" & Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString & "'  Group By ArticleDefId "
                'Dim dtbatchno As New DataTable
                'dtbatchno = GetDataTable(checkbatchno, trans)
                'dtbatchno.AcceptChanges()
                'If dtbatchno.Rows.Count > 0 Then
                '    If Val(dtbatchno.Rows(0).Item(1).ToString) < 1 Then
                '        ShowErrorMessage("(" & Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString & ") This Serial No is not in stock.")
                '        Exit Function
                '    End If
                'End If
                'Task:2415 Check Duplicate Engine No.
                If flgVehicleIdentificationInfo = True Then
                    ''Stuff(ArticleCode, 1, 4, '')
                    ''Retrieving Engine No
                    Dim Engine_No As String = ""
                    Dim Chassis_No As String = ""
                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                        Engine_No = Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Substring(4)
                    End If
                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                        Chassis_No = Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Substring(4)
                    End If
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesDetailTable.ArticleDefId, Stuff(SalesDetailTable.Engine_No, 1, 4, '') As Engine_No, Stuff(SalesDetailTable.Chassis_No, 1, 4, '') As Chassis_No " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"
                    If Engine_No.Length > 0 Then
                        objCommand.CommandText += " AND Stuff(SalesDetailTable.Engine_No, 1, 4, '') =N'" & Engine_No & "'"
                    End If
                    'Dim dt As DataTable = GetDataTable(objCommand.CommandText)
                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND DeliveryChalanDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                    'End If
                    Dim dtVehicleEngineNoIdentificationInfo As New DataTable
                    Dim daVehicleEngineNoIdentificationInfo As New OleDbDataAdapter(objCommand)
                    daVehicleEngineNoIdentificationInfo.Fill(dtVehicleEngineNoIdentificationInfo)

                    ''Retrieving Chasis No
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesDetailTable.ArticleDefId, Stuff(SalesDetailTable.Engine_No, 1, 4, '') As Engine_No, Stuff(SalesDetailTable.Chassis_No, 1, 4, '') As Chassis_No " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"
                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND DeliveryChalanDetailTable.Engine_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "'"
                    'End If
                    If Chassis_No.Length > 0 Then
                        objCommand.CommandText += " AND Stuff(SalesDetailTable.Chassis_No, 1, 4, '') =N'" & Chassis_No & "'"
                    End If
                    Dim dtVehicleChasisNoIdentificationInfo As New DataTable
                    Dim daVehicleChasisNoIdentificationInfo As New OleDbDataAdapter(objCommand)
                    daVehicleChasisNoIdentificationInfo.Fill(dtVehicleChasisNoIdentificationInfo)

                    'Task:2606 Engine_No and Chassis No Data From Sales Return
                    ''Retrieving Return Engine No
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesReturnDetailTable.ArticleDefId, SalesReturnDetailTable.Engine_No, SalesReturnDetailTable.Chassis_No  " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesReturnDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesReturnDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"

                    objCommand.CommandText += " AND Stuff(SalesReturnDetailTable.Engine_No, 1, 4, '')=N'" & Engine_No & "'"


                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND SalesReturnDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                    'End If
                    Dim dtSalesReturnVehichleEngineNoInfo As New DataTable
                    Dim daSalesReturnVehichleEngineNoInfo As New OleDbDataAdapter(objCommand)
                    daSalesReturnVehichleEngineNoInfo.Fill(dtSalesReturnVehichleEngineNoInfo)

                    ''Retrieving Return Chasis No
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesReturnDetailTable.ArticleDefId, SalesReturnDetailTable.Engine_No, SalesReturnDetailTable.Chassis_No  " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesReturnDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesReturnDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"

                    objCommand.CommandText += " AND Stuff(SalesReturnDetailTable.Chassis_No, 1, 4, '')=N'" & Chassis_No & "'"


                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND SalesReturnDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                    'End If
                    Dim dtSalesReturnVehichleChasisNoInfo As New DataTable
                    Dim daSalesReturnVehichleChasisNoInfo As New OleDbDataAdapter(objCommand)
                    daSalesReturnVehichleChasisNoInfo.Fill(dtSalesReturnVehichleChasisNoInfo)

                    If dtVehicleEngineNoIdentificationInfo IsNot Nothing Then
                        If dtVehicleEngineNoIdentificationInfo.Rows.Count > 0 Then
                            If dtVehicleEngineNoIdentificationInfo.Rows.Count > dtSalesReturnVehichleEngineNoInfo.Rows.Count Then
                                If dtVehicleEngineNoIdentificationInfo.Rows(0).Item("Engine_No").ToString.Length > 0 Or Engine_No.Length > 0 Then
                                    If Engine_No = dtVehicleEngineNoIdentificationInfo.Rows(0).Item("Engine_No").ToString Then
                                        Throw New Exception("Engine no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "] already exists")
                                    End If
                                End If
                            End If
                        End If
                    End If

                    If dtVehicleChasisNoIdentificationInfo IsNot Nothing Then
                        If dtVehicleChasisNoIdentificationInfo.Rows.Count > 0 Then
                            If dtVehicleChasisNoIdentificationInfo.Rows.Count > dtSalesReturnVehichleChasisNoInfo.Rows.Count Then
                                If dtVehicleChasisNoIdentificationInfo.Rows(0).Item("Chassis_No").ToString.Length > 0 Or Chassis_No.Length > 0 Then
                                    If Chassis_No = dtVehicleChasisNoIdentificationInfo.Rows(0).Item("Chassis_No").ToString Then
                                        Throw New Exception("Chassis no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "] already exists")
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If

                'If flgVehicleIdentificationInfo = True Then
                '    objCommand.CommandText = ""
                '    objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, StockDetailTable.Engine_No, StockDetailTable.Chassis_No  " _
                '                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                '                                    & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE dbo.ArticleDefTable.ArticleId <> 0  AND LEFT(StockMasterTable.DocNo,2)='SI' "
                '    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                '    objCommand.CommandText += " AND StockDetailTable.Engine_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "'"
                '    'End If
                '    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                '        objCommand.CommandText += " AND StockDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                '    End If
                '    Dim dtVehicleIdentificationInfo As New DataTable
                '    Dim daVehicleIdentificationInfo As New OleDbDataAdapter(objCommand)
                '    daVehicleIdentificationInfo.Fill(dtVehicleIdentificationInfo)

                '    ''Task:2527 Engine_No and Chassis No Data From Sales Return
                '    objCommand.CommandText = ""
                '    objCommand.CommandText = "SELECT dbo.SalesReturnDetailTable.ArticleDefId, SalesReturnDetailTable.Engine_No, SalesReturnDetailTable.Chassis_No  " _
                '                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                '                                    & " dbo.SalesReturnDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesReturnDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"
                '    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                '    objCommand.CommandText += " AND SalesReturnDetailTable.Engine_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "'"
                '    'End If
                '    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                '        objCommand.CommandText += " AND SalesReturnDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                '    End If
                '    Dim dtSalesReturnVehichleInfo As New DataTable
                '    Dim daSalesReturnVehichleInfo As New OleDbDataAdapter(objCommand)
                '    daSalesReturnVehichleInfo.Fill(dtSalesReturnVehichleInfo)
                '    'End Task:2527

                '    'If dtVehicleIdentificationInfo IsNot Nothing Then
                '    '    If dtVehicleIdentificationInfo.Rows.Count > 0 Then

                '    If dtVehicleIdentificationInfo IsNot Nothing AndAlso dtSalesReturnVehichleInfo IsNot Nothing Then
                '        If dtVehicleIdentificationInfo.Rows.Count > 0 Then
                '            If dtVehicleIdentificationInfo.Rows.Count > dtSalesReturnVehichleInfo.Rows.Count Then
                '                If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Or dtVehicleIdentificationInfo.Rows(0).Item("Engine_No").ToString.Length > 0 Then
                '                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString = dtVehicleIdentificationInfo.Rows(0).Item("Engine_No").ToString Then
                '                        Throw New Exception("Engine no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "] already exists")
                '                    End If
                '                End If
                '                If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Or dtVehicleIdentificationInfo.Rows(0).Item("Chassis_No").ToString.Length > 0 Then
                '                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString = dtVehicleIdentificationInfo.Rows(0).Item("Chassis_No").ToString Then
                '                        Throw New Exception("Chassis no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "] already exists")
                '                    End If
                '                End If
                '            End If
                '        End If
                '    End If
                'End If
                'End Task:2415

                Dim CostPrice As Double = 0D
                Dim CrrStock As Double = 0D

                'DiscountedPrice = Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value - Me.grd.GetRows(i).Cells(EnumGridDetail.Price).Value

                'Code Edit For TFS1153
                'DiscountedPrice = Me.grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value - Me.grd.GetRows(i).Cells(EnumGridDetail.Price).Value
                DiscountedPrice = Me.grd.GetRows(i).Cells(EnumGridDetail.DiscountValue).Value
                'Dim CostPrice As Double = 0D
                'Dim CrrStock As Double = 0D
                'If flgCgsVoucher = True Then 'Comment against task TASK 2517 PL and Item Problem
                

                Dim dblPurchasePrice As Double = 0D
                Dim dblCostPrice As Double = 0D
                Dim dblCurrencyAmount As Double = 0D
                Dim strData As String
                If flgAvgRate = True Then

                    Dim ClosingDate As DateTime = Convert.ToDateTime(getConfigValueByType("EndOfDate").ToString)
                    strData = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0) as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) as BalanceAmount, IsNull(SUM(IsNull(InQty, 0) - IsNull(OutQty, 0)), 0) AS CheckStock From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & " AND StockMasterTable.DocDate < '" & dtpPODate.Value & "' Group By ArticleDefId "
                    'Dim dblCostPrice As Double = 0D
                    Dim dtLastestPriceData As New DataTable
                    dtLastestPriceData = GetDataTable(strData, trans)
                    dtLastestPriceData.AcceptChanges()

                    If dtLastestPriceData.Rows.Count > 0 Then
                        If Val(dtLastestPriceData.Rows(0).Item(1).ToString) > 0 Then
                            dblCostPrice = Val(Val(dtLastestPriceData.Rows(0).Item(2).ToString) / Val(dtLastestPriceData.Rows(0).Item(1).ToString))
                        End If
                    End If

                Else

                    Dim strPriceData() As String = GetRateByItem(IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString))).Split(",")

                    If strPriceData.Length > 1 Then
                        dblCostPrice = Val(strPriceData(0).ToString)
                        dblPurchasePrice = Val(strPriceData(1).ToString)
                        dblCurrencyAmount = Val(strPriceData(2).ToString)
                        If dblCostPrice = 0 Then
                            dblCostPrice = dblPurchasePrice
                        End If
                    End If
                End If





                If flgAvgRate = True And getConfigValueByType("CostImplementationLotWiseOnStockMovement") = "True" Then 'Set Status Avg Rate Task:2517
                    If Convert.ToDouble(GetItemRateByBatch(IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)), Me.grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString)) > 0 Then
                        CostPrice = Convert.ToDouble(GetItemRateByBatch(IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)), Me.grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString))
                    Else
                        'CostPrice = CostPrice ''Commented Against TFS3528 : Ayesha Rehman
                        CostPrice = dblCostPrice
                    End If
                ElseIf flgAvgRate = True Then
                    'Tsk:2517 Set Cost Price Of Purchase Price
                    ''If dblCostPrice <> 0 Then
                    CostPrice = dblCostPrice 'Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString)
                    currencyamount = dblCurrencyAmount
                    'Else
                    '    CostPrice = dblPurchasePrice
                    '    currencyamount = dblCurrencyAmount
                    'End If
                Else
                    'CostPrice = IIf(Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString) <= 0, Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString), Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString))
                    CostPrice = dblPurchasePrice 'Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString)
                    currencyamount = dblCurrencyAmount
                    'End Task:2517
                End If
                ''Start TFS1957
                ''TASK TFS3324 done on 31-05-2018
                ''
                Dim IsLogicalItemStockMade As Boolean = False
                If CType(grd.GetRows(i).Cells("LogicalItem").Value, Boolean) = True Then
                    ''Below line is commented on 31-05-2018 against TASK TFS3324
                    'FillModelOfStockDetail(grd.GetRows(i).Cells("ArticleDefId").Value, grd.GetRows(i).Cells("LocationId").Value, Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString), grd.GetRows(i).Cells("Comments").Value.ToString)
                    IsLogicalItemStockMade = GetItemsOfLogicalItem(grd.GetRows(i).Cells("ArticleDefId").Value, grd.GetRows(i).Cells("LocationId").Value, Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString), grd.GetRows(i).Cells("Comments").Value.ToString, objCommand)
                End If
                Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ""
                Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem, trans)
                dt2serviceitem.AcceptChanges()
                Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem1 = False Then
                    If CType(grd.GetRows(i).Cells("LogicalItem").Value, Boolean) = False Or IsLogicalItemStockMade = False Then
                        If (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) > 0 Or Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString) > 0) Then
                            StockDetail = New StockDetail
                            StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                            StockDetail.LocationId = grd.GetRows(i).Cells("LocationId").Value
                            StockDetail.ArticleDefId = IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString))
                            StockDetail.InQty = 0
                            If IsSalesOrderAnalysis = True Then
                                ''TASK-408
                                'StockDetail.OutQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value), ((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * Val(grd.GetRows(i).Cells("Pack Qty").Value)))
                                StockDetail.OutQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString)
                            Else
                                ''TASK-408
                                'StockDetail.OutQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value), ((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * Val(grd.GetRows(i).Cells("Pack Qty").Value)))
                                StockDetail.OutQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString)
                            End If
                            If flgAvgRate = True Then
                                StockDetail.Rate = CostPrice
                            Else
                                StockDetail.Rate = Val(grd.GetRows(i).Cells(EnumGridDetail.PurchasePrice).Value)
                            End If

                            StockDetail.InAmount = 0
                            ''TASK-408
                            'StockDetail.OutAmount = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", ((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * IIf(CostPrice = 0, Val(grd.GetRows(i).Cells(EnumGridDetail.PurchasePrice).Value), CostPrice)), (((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * Val(grd.GetRows(i).Cells("Pack Qty").Value)) * IIf(CostPrice = 0, Val(grd.GetRows(i).Cells(EnumGridDetail.PurchasePrice).Value), CostPrice)))
                            StockDetail.OutAmount = ((Val(grd.GetRows(i).Cells("TotalQty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * StockDetail.Rate)
                            StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                            'Task:M16 Set Values In Engine_No and Chassis_No 
                            StockDetail.Engine_No = grd.GetRows(i).Cells("Engine_No").Value.ToString
                            StockDetail.Chassis_No = grd.GetRows(i).Cells("Chassis_No").Value.ToString
                            'End Task:M16
                            CostPrice = StockDetail.Rate
                            StockDetail.CostPrice = CostPrice
                            ''Start TASK-470
                            StockDetail.PackQty = Val(grd.GetRows(i).Cells("Pack Qty").Value.ToString)
                            StockDetail.Out_PackQty = Val(grd.GetRows(i).Cells("Qty").Value.ToString)
                            StockDetail.In_PackQty = 0
                            ''End TASK-470
                            ''Start TASK-TFS1596
                            StockDetail.BatchNo = grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString
                            StockDetail.ExpiryDate = CType(grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value, Date).ToString("yyyy-M-d h:mm:ss tt") 'grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value.ToString
                            ''End TASK-1596
                            StockDetail.Origin = grd.GetRows(i).Cells("Origin").Value.ToString
                            StockList.Add(StockDetail)
                        End If
                        ''END TASK TFS3324
                    End If
                    ''End TFS1957
                End If

                ' objCommand.CommandText = "Insert into SalesDetailTable (SalesId, ArticleDefId,ArticleSize, Sz1,Qty,Price, Sz7,CurrentPrice,BatchNo, BatchID, LocationId, TaxPercent, SampleQty, SEDPercent,TradePrice, Discount_Percentage, Freight, MarketReturns,SO_ID,LoadQty,PurchasePrice, PackPrice, Comments,Pack_Desc, Engine_No, Chassis_No, CostPrice,ExpiryDate,Other_Comments,SalesReturnQty,DeliveryChalanId,DeliveryChalanDetailId,Transport_Charges,ApplyAdjustmentFuelExp, SO_Detail_ID, Gross_Weights,Tray_Weights,Net_Weights ) values( " _
                ' & " ident_current('SalesMasterTable')," & Val(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value) & ",N'" & (grd.GetRows(i).Cells(EnumGridDetail.Unit).Value) & "'," & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", " _
                ' & " " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) & ", " _
                ' & Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) & " , " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) & ",N'" & grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString.Replace("'", "''") & "', " _
                '& Val(grd.GetRows(i).Cells(EnumGridDetail.BatchID).Value.ToString) & " , " & grd.GetRows(i).Cells(EnumGridDetail.LocationID).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value.ToString = "", 0, grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value.ToString()) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TradePrice).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value) & "," & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.LoadQty).Value) & ", " & Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackPrice).Value.ToString) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Pack_Desc).Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "', " & Val(CostPrice) & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value.ToString = "", "NULL", "Convert(DateTime,N'" & CDate(IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value.ToString = "", Date.Now, Me.grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value)).ToString("yyyy-M-d hh:mm:ss tt") & "',102)") & ", N'" & grd.GetRows(i).Cells("Other Comments").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("SalesReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("DeliveryChalanId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("DeliveryChalanDetailId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString) & "," & IIf(Convert.ToBoolean(grd.GetRows(i).Cells(EnumGridDetail.LocationID).Value) = True, 1, 0) & "," & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Gross_Weights").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Tray_Weights").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells("Net_Weights").Value.ToString) & " )"
                Dim TotalQty As Double = 0
                TotalQty = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.TotalQty), Janus.Windows.GridEX.AggregateFunction.Sum))
                Dim TransCharges As Double = 0
                TransCharges = Val(Val(Me.txtTransCharges.Text) / TotalQty)

                ''TFS1154 Added coloumn RetailPrice
                ''TFS1153 Added coloumn DiscountId,DiscountType,DiscountValue,DiscountFactor and PostDiscountPrice
                objCommand.CommandText = "Insert into SalesDetailTable (SalesId, ArticleDefId,ArticleSize, Sz1,Qty,Price, Sz7,CurrentPrice,BatchNo, BatchID, LocationId, TaxPercent, SampleQty, SEDPercent,TradePrice, RetailPrice, DiscountId, DiscountType, DiscountValue, DiscountFactor, PostDiscountPrice,Discount_Percentage, Freight, MarketReturns,SO_ID,LoadQty, PurchasePrice, PackPrice, Comments,Pack_Desc, Engine_No, Chassis_No, CostPrice,ExpiryDate,Other_Comments,SalesReturnQty,DeliveryChalanId, DeliveryChalanDetailId,Transport_Charges,ApplyAdjustmentFuelExp, SO_Detail_ID, Gross_Weights, Tray_Weights, Net_Weights, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, FlatDiscount, OldSalePrice, SalePriceProcessId, BardanaDeduction, OtherDeduction, Origin, AlternativeItem, AlternativeItemId) values( " _
                                 & " " & "ident_current('SalesMasterTable')" & " ," & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ",N'" & (grd.GetRows(i).Cells(EnumGridDetail.Unit).Value) & "'," & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", " _
                                 & " " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & ", " _
                                 & Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) & " , " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) & ",N'" & grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString.Replace("'", "''") & "', " _
                                 & grd.GetRows(i).Cells(EnumGridDetail.BatchID).Value & " , " & grd.GetRows(i).Cells(EnumGridDetail.LocationID).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value.ToString = "", 0, grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value.ToString()) & ", " _
                                 & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TradePrice).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.RetailPrice).Value) & ", " & grd.GetRows(i).Cells(EnumGridDetail.DiscountId).Value & ",'" & grd.GetRows(i).Cells(EnumGridDetail.DiscountType).Value.ToString.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.DiscountValue).Value) & ", " _
                                 & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.DiscountFactor).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value) & "," & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.LoadQty).Value) & "," _
                                 & Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackPrice).Value.ToString) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Pack_Desc).Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") _
                                 & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "', " & Val(CostPrice) & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value.ToString = "", "NULL", "Convert(DateTime,N'" & CDate(IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value.ToString = "", Date.Now, Me.grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value)).ToString("yyyy-M-d hh:mm:ss tt") & "',102)") _
                                 & ", N'" & grd.GetRows(i).Cells("Other Comments").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("SalesReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("DeliveryChalanId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("DeliveryChalanDetailId").Value.ToString) & "," & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(grd.GetRows(i).Cells(EnumGridDetail.Transport_Charges).Value.ToString)) & "," _
                                 & IIf(Convert.ToBoolean(grd.GetRows(i).Cells(EnumGridDetail.ApplyAdjustmentFuelExp).Value) = True, 1, 0) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value) & " ," & Val(grd.GetRows(i).Cells(EnumGridDetail.Gross_Weights).Value) & "," & Val(grd.GetRows(i).Cells(EnumGridDetail.Tray_Weights).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.Net_Weight).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) _
                                 & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.FlatDiscount).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.OldSalePrice).Value.ToString) _
                                 & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.SalePriceProcessId).Value.ToString) & " , " & Val(grd.GetRows(i).Cells(EnumGridDetail.BardanaDeduction).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.OtherDeduction).Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value & "', N'" & grd.GetRows(i).Cells(EnumGridDetail.AlternativeItem).Value.ToString & "', " & Val(grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) & ") Select @@Identity"


                objCommand.ExecuteNonQuery()

                ''Start TFS1957
                ''Below three lines are commented on 31-05-2018 against TASK TFS3324. Because it does not need to call it.
                'If CType(grd.GetRows(i).Cells("LogicalItem").Value, Boolean) = True Then
                '    FillAssemblyProductTable(grd.GetRows(i).Cells("ArticleDefId").Value, grd.GetRows(i).Cells("LocationId").Value)
                'End If
                ''End TFS1957
                'Dim value As Object = objCommand.ExecuteScalar()
                'If value Is DBNull.Value Or value Is Nothing Then
                '    InvId = 0
                'Else
                '    InvId = Convert.ToInt32(value)
                'End If
                ''InvId = objCommand.ExecuteScalar()
                'If SalesDetailId > 0 AndAlso InvId = 0 Then
                '    InvId = SalesDetailId
                'End If
                'If grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose" AndAlso getConfigValueByType("EmptyPackItem").ToString = "True" Then
                '    objCommand.CommandText = "INSERT INTO tblPackAdjustment(SalesDetailId, ArticleId, Qty) VALUES(" & InvId & "," & Val(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value) & "," & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & ")"
                '    objCommand.ExecuteNonQuery()

                '    objCommand.CommandText = "SELECT tblPackAdjustment.ArticleId, isnull(SUM(tblPackAdjustment.Qty),0) - isnull(SUM(tblPackAdjustment.AdjustedQty),0) AS AdjustedQty, ArticleDefTable.PackQty FROM tblPackAdjustment INNER JOIN ArticleDefTable ON tblPackAdjustment.ArticleId = ArticleDefTable.ArticleId WHERE ArticleDefTable.ArticleId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value) & " GROUP BY tblPackAdjustment.ArticleId, ArticleDefTable.PackQty"
                '    Dim da As New OleDbDataAdapter
                '    Dim dt As New DataTable
                '    da.SelectCommand = objCommand
                '    da.Fill(dt)
                '    dt.AcceptChanges()

                '    'For Each r As DataRow In dt.Rows
                '    If Val(dt.Rows(0).Item(1).ToString) >= Val(dt.Rows(0).Item(2).ToString) Then
                '        Dim value1 As Integer = Val(dt.Rows(0).Item(1).ToString) / Val(dt.Rows(0).Item(2).ToString)
                '        For i1 As Integer = 1 To value1
                '            objCommand.CommandText = "INSERT INTO tblPackAdjustment(ArticleId,AdjustedQty) VALUES(" & dt.Rows(0).Item(0).ToString & "," & dt.Rows(0).Item(2).ToString & ")"
                'objCommand.ExecuteNonQuery()
                'objCommand.CommandText = "Insert Into StockDetailTable(StockTransId, LocationId, ArticleDefId, InQty, Remarks) " _
                '                            & " Values (" & StockTransId() & ", " & StockDetail.LocationId & ",  " & StockDetail.ArticleDefId & ", " & StockDetail.InQty & ", N'" & StockDetail.Remarks.Replace("'", "''") & "')"
                'End Task:M16
                ' Next


                'update date Sale Order Detail and Sale Order Master table
                If Mode = "Normal" Then
                    If IsSOSeparateClosure = False Then
                        If Val(grd.GetRows(i).Cells("TotalQty").Value) <> 0 Or Val(grd.GetRows(i).Cells("Sample Qty").Value) <> 0 Then
                            If Not DeliveryChalanId > 0 Then  ''Commented against TFS3035
                                If flgMultipleSalesOrder = False Then
                                    If Not Me.cmbPo.SelectedIndex = -1 Then
                                        If Me.cmbPo.SelectedIndex > 0 Then
                                            'objCommand.CommandText = "UPDATE  SalesOrderDetailTable " _
                                            '                        & " SET              DeliveredQty = isnull(DeliveredQty,0) +  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value))) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & ") " _
                                            '                        & " WHERE     (SalesOrderId = " & Me.cmbPo.SelectedValue & ") AND (ArticleDefId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value) & ")"
                                            objCommand.CommandText = "UPDATE  SalesOrderDetailTable " _
                                                                    & " SET              DeliveredQty = isnull(DeliveredQty,0) + " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & "), DeliveredTotalQty=IsNull(DeliveredTotalQty,0)+ " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " " _
                                                                    & " WHERE     (SalesOrderId = " & Me.cmbPo.SelectedValue & ") AND (ArticleDefId = " & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & ") And (SalesOrderDetailId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value.ToString) & ")"
                                            objCommand.ExecuteNonQuery()
                                        End If
                                    End If
                                Else
                                    If Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) > 0 Then
                                        objCommand.CommandText = "UPDATE  SalesOrderDetailTable " _
                                                               & " SET              DeliveredQty = isnull(DeliveredQty,0) +  " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & "), DeliveredTotalQty=IsNull(DeliveredTotalQty,0)+ " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " " _
                                                               & " WHERE     (SalesOrderId = " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ") AND (ArticleDefId = " & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & ") And (SalesOrderDetailId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value.ToString) & ") "
                                        objCommand.ExecuteNonQuery()
                                    End If
                                End If
                            End If

                            'If DeliveryChalanId > 0 Then
                            '    objCommand.CommandText = "UPDATE  DeliveryChalanDetailTable " _
                            '                            & " SET              DeliveredQty = isnull(DeliveredQty,0) +  " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & ") " _
                            '                            & " WHERE     (DeliveryId = " & DeliveryChalanId & ") AND (ArticleDefId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value) & ")"
                            '    objCommand.ExecuteNonQuery()
                            'End If
                        End If  ''Commented against TFS3035
                    Else
                        If Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) > 0 Then
                            objCommand.CommandText = "UPDATE  SalesOrderDetailTable " _
                                                   & " SET DeliveredQty = isnull(DeliveredQty,0) +  " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & "), DeliveredTotalQty=IsNull(DeliveredTotalQty,0)+ " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " " _
                                                   & " WHERE     (SalesOrderId = " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ") AND (ArticleDefId = " & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & ") And (SalesOrderDetailId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value.ToString) & ") "
                            objCommand.ExecuteNonQuery()
                        End If
                    End If

                    ''==================================================================================
                    '***********************
                    'Inserting Debit Amount
                    '***********************
                    ' objCommand = New OleDbCommand
                    ' objCommand.Connection = Con
                    'If Not ServiceItem = "True" Then
                    ''TASK TFS2741 addition of deduction columns(Bardana Deduction, other deduction)
                    Dim Deduction As Double = Val(grd.GetRows(i).Cells(EnumGridDetail.BardanaDeduction).Value.ToString) + Val(grd.GetRows(i).Cells(EnumGridDetail.OtherDeduction).Value.ToString)
                    'Dim CurrencyDeduction As Double = (Val(grd.GetRows(i).Cells(EnumGridDetail.BardanaDeduction).Value.ToString) + Val(grd.GetRows(i).Cells(EnumGridDetail.OtherDeduction).Value.ToString)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString)
                    If Val(grd.GetRows(i).Cells("Qty").Value) <> 0 Or Val(grd.GetRows(i).Cells("Sample Qty").Value) <> 0 Then
                        If UnbuildCustomerId > 0 AndAlso AdjustmentAmountNew > 0 Then
                            Dim DiffAmount As Double = Val(InvoiceAmount) - Val(AdjustmentAmountNew)
                            If Val(InvoiceAmount) = Val(AdjustmentAmountNew) Then
                                objCommand.CommandText = ""
                                'Customer Debit
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "' )"
                                objCommand.ExecuteNonQuery()
                                objCommand.CommandText = ""
                                'UnBuild Customer A/C Credit
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & UnbuildCustomerId & ", " & 0 & ",  " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"
                                objCommand.ExecuteNonQuery()
                            Else
                                objCommand.CommandText = ""
                                'Customer Debit
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "' )"

                                objCommand.ExecuteNonQuery()
                                objCommand.CommandText = ""
                                Dim CurrencyDiffAmount As Double
                                Dim CurrencyAdjustmentAmountNew As Double
                                If Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) <> BaseCurrencyId Then
                                    CurrencyDiffAmount = Val(DiffAmount) / Val(txtCurrencyRate.Text)
                                    CurrencyAdjustmentAmountNew = Val(AdjustmentAmountNew) / Val(txtCurrencyRate.Text)
                                End If
                                'Net Sales A/C Credit
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & SalesAccount & ", " & 0 & ",  " & DiffAmount & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & CurrencyDiffAmount & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"
                                objCommand.ExecuteNonQuery()
                                objCommand.CommandText = ""
                                'Unbuild Customer A/C Credit
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & UnbuildCustomerId & ", " & 0 & ",  " & AdjustmentAmountNew & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & CurrencyAdjustmentAmountNew & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"
                                objCommand.ExecuteNonQuery()
                            End If
                        Else
                            If IsDiscountVoucher = False Then

                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                                '                      & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd1.Rows(i).Cells("Unit").Value = "Loose", Val(grd1.Rows(i).Cells("Qty").Value) * Val(grd1.Rows(i).Cells("rate").Value), (Val(grd1.Rows(i).Cells("Qty").Value) * Val(grd1.Rows(i).Cells("PackQty").Value)) * Val(grd1.Rows(i).Cells("rate").Value)) & ", 0, N'" & grd1.Rows(i).Cells("item").Value & "(" & Val(grd1.Rows(i).Cells("Qty").Value) & ")' )"

                                '********************* Change For Cost Center ********************************
                                ' By Imran Ali 26-01-2012
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                                If Not IsSalesOrderAnalysis = True Then
                                    objCommand.CommandText = ""
                                    'Before agaginst task2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'End Task:2369
                                    'Task:2391 Added Column ArticleDefId
                                    ''// Work of adding Multi currency values on 14-10-2016 By Ameen
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                    & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "' )"
                                    ''Commented below to add total quantity instead of Pack Qty * Qty against TASK-408
                                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"
                                    'End Task:2391
                                    'objCommand.Transaction = trans
                                    objCommand.ExecuteNonQuery()

                                    ''Start TFS1957
                                    ''Below function is commented against TASK TFS3324 on 11-06-2018 as it does not need to put voucher of child items of a logical item.
                                    'AddVocherForLogicalItemDebit(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value, lngVoucherMasterId)
                                    ''End TFS1957

                                    '***********************
                                    'Inserting Credit Amount
                                    '***********************
                                    'objCommand = New OleDbCommand
                                    ' objCommand.Connection = Con
                                    objCommand.CommandText = ""

                                    '******************* Change For Cost Center ******************
                                    ' By Imran Ali
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                                    'Code By Imran Task Against Req #803
                                    If flgExcludeTaxPrice = False Then
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change Comments
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Task:2391 Aidded Column ArticleDefId
                                        ''// Work of adding Multi currency values on 14-10-2016 By Ameen
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"
                                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented on 10-06-2016 against TASK-408

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()
                                        'End Task:2369

                                        ''Start TFS1957
                                        ''Below function is commented against TASK TFS3324 on 11-06-2018 as it does not need to put voucher of child items of a logical item.

                                        'AddVocherForLogicalItemCredit(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value, lngVoucherMasterId, AccountId)
                                        ''End TFS1957

                                    Else
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change Comments 
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Task:2391 Added Column ArticleDefId
                                        ''// Work of adding Multi currency values on 14-10-2016 By Ameen
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(txtCurrencyRate.Text) - ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(txtCurrencyRate.Text)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) - Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TaxAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"  ''TASK-408 Added TotalQty  
                                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented on 10-06-2016 against TASK-408

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()
                                        'End Task:2369


                                    End If


                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"
                                    ' objCommand.Transaction = trans
                                    'objCommand.ExecuteNonQuery()
                                Else
                                    ''''''''''''''''''' In Case Sales Order Analysis ----------------------------------------------
                                    objCommand.CommandText = ""
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, Direction, sp_refrence) " _
                                    '                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Tsk:2369 Change Comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, Direction, sp_refrence) " _
                                    '                                                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'End Task:2369
                                    'Task:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, Direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                    & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (((Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value - Deduction) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(txtCurrencyRate.Text)) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "' ) "    ''TASK-408 added TotalQty instead of Loose & Pack variation
                                    ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented on 10-06-2016 against TASK-408  

                                    'End Task:2391

                                    'objCommand.Transaction = trans
                                    objCommand.ExecuteNonQuery()

                                    '***********************
                                    'Inserting Credit Amount
                                    '***********************
                                    'objCommand = New OleDbCommand
                                    ' objCommand.Connection = Con
                                    objCommand.CommandText = ""

                                    '******************* Change For Cost Center ******************
                                    ' By Imran Ali
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                                    'Code By Imran Ali Task Against Req # 803
                                    If flgExcludeTaxPrice = False Then
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change Comments
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Tas:2391 Added Column ArticleDefId
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (((Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(txtCurrencyRate.Text)) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 ," & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"     ''TASK-408 replaced Qty * Pack Qty with TotalQty
                                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"   ''Commented this row against TASK-408 for adding TotalQty

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()
                                        'End Task:2369
                                    Else
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change Comments
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Task:2391 Added Column ArticleDefId
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " , 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" '' TASK-408 added TotalQty instead Qty * Pack Qty
                                        ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented against TASK-408

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()
                                        'End Task:2369
                                    End If

                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"
                                    ' objCommand.Transaction = trans
                                    'objCommand.ExecuteNonQuery()

                                    '''''''''''''''''''''' Includ Discount Voucher ''''''''''''''''''''''''''''''''''''''''''
                                    If DiscountedPrice > 0 Then
                                        objCommand.CommandText = ""
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                                & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against Task:2391 
                                        'Task:2369 Change 
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                                & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Task:2391 Added Column ArticleDefId
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                                        & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(txtCurrencyRate.Text)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value.ToString)) / 100) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408 added TotalQty
                                        ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented below against TASK-408 to replace TotalQty with Qty * Pack Qty

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()
                                        'End Task:2369

                                    End If
                                End If

                            Else

                                objCommand.CommandText = ""
                                'Before against task:2369
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ",0,N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'Before against task:2391
                                'Task:2369 Change Comments
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ",0,N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "'") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'End Task:2369
                                'Task:2391 Added Column ArticleDefId

                                ''Code Commented for TFS1153
                                'Price = Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)
                                'CurrentPrice = Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)
                                'If CurrentPrice = 0 Then
                                '    CurrentPrice = Price
                                'End If
                                'If Price < CurrentPrice Then
                                '    Price = CurrentPrice
                                'End If

                                ''Code Edit for TFS1153 
                                'Changing Current Price To Post Discount Price
                                Price = Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)
                                PDP = Val(grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value)
                                If PDP = 0 Then
                                    PDP = Price
                                End If
                                If Price < PDP Then
                                    Price = PDP
                                End If
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Price * Val(txtCurrencyRate.Text) & ",0,N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "'") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Price & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ")" ''TASK-408 replaced TotalQty with Pack Qty * Qty  ''TFS1153



                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, Direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                '                                            & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * ((Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(txtCurrencyRate.Text)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalCurrencyAmount).Value.ToString + DiscountedPrice) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408 replaced TotalQty with Pack Qty * Qty
                                ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ",0,N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "'") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row against TASK-408

                                'End Task:2391
                                objCommand.ExecuteNonQuery()

                                If DiscountedPrice > 0 Then
                                    objCommand.CommandText = ""
                                    'Before against task:2391
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Added Column ArticleDefId


                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                        & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString)) * DiscountedPrice * Val(txtCurrencyRate.Text) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & DiscountedPrice * (Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & " )" ''TASK-408 added TotalQty instead Pack Qty * Qty  ''TFS1153



                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                    '                                                                        & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * DiscountedPrice * Val(txtCurrencyRate.Text) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & DiscountedPrice & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "' )" ''TASK-408 added TotalQty instead Pack Qty * Qty
                                    ' 

                                    ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " )" ''Commented this row against TASK-408

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()

                                    objCommand.CommandText = ""
                                    'Before against task:2391
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ",'Ref Discount On Sales: " & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & (DiscountedPrice) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Added Column ArticleDefId


                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0," & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * DiscountedPrice * Val(txtCurrencyRate.Text) & ",N'Ref Discount On Sales: " & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & (DiscountedPrice) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & DiscountedPrice * (Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ")" ''TASK-408 added TotalQty insted of Pack Qty * Qty or Qty ''TFS1153



                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                    '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0," & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * DiscountedPrice * Val(txtCurrencyRate.Text) & ",N'Ref Discount On Sales: " & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & (DiscountedPrice) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & DiscountedPrice & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408 added TotalQty insted of Pack Qty * Qty or Qty
                                    '

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()

                                    If flgExcludeTaxPrice = False Then
                                        objCommand.CommandText = ""
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change Comments
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Task:2391 Added Column ArticleDefId

                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                        '                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(txtCurrencyRate.Text) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString + DiscountedPrice * (Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ")" ''TASK-408
                                        'Code Added For TFS1153
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value) * Val(txtCurrencyRate.Text) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) + DiscountedPrice & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ")" ''TASK-408  ''TFS1153 Changing Current Price To Post Discount Price


                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                        '                                                  & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(txtCurrencyRate.Text) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString + DiscountedPrice) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408
                                        ' ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"  ''Commented this row against TASK-408

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()
                                    Else
                                        objCommand.CommandText = ""
                                        'Before against Task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                        & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change Comments
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Task:2391 Added Column ArticleDefId
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(txtCurrencyRate.Text) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " , 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408 added TotalQty instead of Pack Qty * Qty or Qty
                                        ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented against TASK-408

                                        'End Task:2391
                                        'End Task:2369

                                        objCommand.ExecuteNonQuery()

                                    End If

                                    'objCommand.ExecuteNonQuery()

                                Else

                                    'objCommand.CommandText = ""
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction) " _
                                    '                                                  & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ")"
                                    'objCommand.ExecuteNonQuery()

                                    If flgExcludeTaxPrice = False Then
                                        objCommand.CommandText = ""
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change comments
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'End Task:2369
                                        'Task:2391 Added Column ArticleDefId
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" '' TASK-408 added TotalQty instead of Pack Qty * Qty or Qty
                                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row against TASK-408

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()
                                    Else
                                        'objCommand.CommandText = ""
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2369
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'Before against task:2391
                                        'Task:2369 Change Comments
                                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                        '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                        'End Task:2369
                                        'Task:2391 Added Column ArticleDefId
                                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408
                                        ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row on 10-06-2016 against TASK-408 

                                        'End Task:2391
                                        objCommand.ExecuteNonQuery()

                                    End If
                                    'objCommand.ExecuteNonQuery()
                                End If
                            End If
                        End If
                    End If
                End If
                'Else
                '    '***********************
                '    'Inserting Debit Amount
                '    '***********************
                '    If IsDiscountVoucher = False Then
                '        If Not IsSalesOrderAnalysis = True Then
                '            'objCommand.CommandText = ""
                '            ''objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '            ''                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"

                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '            '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"


                '            'objCommand.ExecuteNonQuery()

                '            ''***********************
                '            ''Inserting Credit Amount
                '            ''***********************
                '            'objCommand.CommandText = ""

                '            ''objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '            ''                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", 0,  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"

                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '            '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", 0,  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"

                '            ''objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '            ''                      & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"

                '            'objCommand.ExecuteNonQuery()

                '            'If UpdateVoucherEntry(7, txtPONo.Text, Me.dtpPODate.Value, "", Nothing, AccountId, Val(Me.cmbVendor.ActiveRow.Cells(0).Text.ToString), Val(Me.txtAmount.Text), Val(Me.txtAmount.Text), "Both", Me.Name, Me.txtPONo.Text, True) = False Then
                '            '    MsgBox("An error occured while updating voucher record could not updated")
                '            '    trans.Rollback()
                '            '    Update_Record = False
                '            '    Exit Function
                '            'End If
                '        Else
                '            objCommand.CommandText = ""
                '            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '                                                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ")"


                '            'objCommand.Transaction = trans
                '            objCommand.ExecuteNonQuery()

                '            '***********************
                '            'Inserting Credit Amount
                '            '***********************
                '            'objCommand = New OleDbCommand
                '            ' objCommand.Connection = Con
                '            objCommand.CommandText = ""

                '            '******************* Change For Cost Center ******************
                '            ' By Imran Ali
                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '            '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                '            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '                                   & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ")"

                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '            '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"
                '            ' objCommand.Transaction = trans
                '            objCommand.ExecuteNonQuery()

                '            '''''''''''''''''''''' Includ Discount Voucher ''''''''''''''''''''''''''''''''''''''''''
                '            objCommand.CommandText = ""
                '            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '                                                                                      & " VALUES(" & lngVoucherMasterId & ", 1, " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ")"
                '            objCommand.ExecuteNonQuery()
                '        End If
                '        'Else
                '        '    objCommand.CommandText = ""
                '        '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '        '                                                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"

                '        '    objCommand.ExecuteNonQuery()

                '        '    objCommand.CommandText = ""
                '        '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '        '                                                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Val(SalesDiscountAccount) & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"

                '        '    objCommand.ExecuteNonQuery()

                '        '    objCommand.CommandText = ""
                '        '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '        '                                                  & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", 0,  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"
                '        '    objCommand.ExecuteNonQuery()

                '        'End If
                '    End If
                ''''''''''''''''''' Preparing Cost Of Sale Voucher ''''''''''''''''''''''''''''''
                Dim str As String = "Select ServiceItem from ArticleDefView where ArticleId = " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ""
                Dim dt2 As DataTable = GetDataTable(str, trans)
                dt2.AcceptChanges()
                Dim ServiceItem As Boolean = Val(dt2.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem = False Then
                    If flgCgsVoucher = True Then

                        objCommand.CommandText = ""
                        'Before against task:2391
                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                        '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & CgsAccountId & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                        'Task;2391 Added column ArticleDefId
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                                 & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & CgsAccountId & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val((Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice) / Val(txtCurrencyRate.Text) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408
                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & CgsAccountId & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row on 10-06-2016 against TASK-408 replaced Pack Qty * Qty or Qty with TotalQty

                        'End Task:2391
                        objCommand.ExecuteNonQuery()

                        objCommand.CommandText = ""
                        'Before against task:2391
                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                        '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                        'Before against task:2390
                        'Task:2391 Added Column ArticleDefId
                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence,ArticleDefId) " _
                        '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"
                        'End Task:2391
                        'Task:2390 Change Inventory Account
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                                  & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val((Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice) / Val(txtCurrencyRate.Text) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408
                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row on 10-06-2016 against TASK-408

                        'End Task:2390
                        objCommand.ExecuteNonQuery()
                    End If
                    '''''''''''''''''''''''''''''' Code By Imran Ali 03/06/2013 '''''''''''''''''''''''''''''''''''''''
                End If




                ''''''''''''''''''''''''''''''''' Transport Charges ''''''''''''''''''''''''
                'If Me.cmbTransporter.SelectedIndex > 0 Then
                Dim intTransAccountID As Integer = Val(CType(Me.cmbTransporter.SelectedItem, DataRowView).Row.Item("AccountID").ToString)
                If intTransAccountID > 0 Then
                    If Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString) > 0 Then

                        objCommand.CommandText = ""
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                                 & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & OtherExpAccount & ", " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString)) * Val(txtCurrencyRate.Text) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & Val(grd.GetRows(i).Cells("Transport_Charges").Value.ToString) & ")" & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString)) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408 added TotalQty instead of Qty
                        objCommand.ExecuteNonQuery()


                        objCommand.CommandText = ""
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                                                                 & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & intTransAccountID & ",0, " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString)) * Val(txtCurrencyRate.Text) & ",  N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & Val(grd.GetRows(i).Cells("Transport_Charges").Value.ToString) & ")" & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " , 0, " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString)) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')" ''TASK-408 added TotalQty instead of Qty
                        objCommand.ExecuteNonQuery()

                    End If
                End If
                '---------------- End Transport Charges --------------------------------------
                'Else
                'If grd.RowCount = 1 Then
                '    Exit Function
                'End If
                'End If

            Next

            ''For test purposes
            'trans.Rollback()
            'Exit Function
            ''

            '***********************
            '06-Dec-2011    Added for Fuel, Other Expense, Adjustment
            '***********************
            'Task 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 

            If ExpenseChargeToCustomer = False Then
                ''Fuel
                If Val(Me.txtFuel.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"
                    'Task 1620 Added for DebitAmount Ayesha Rehman 
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) * Val(Me.txtCurrencyRate.Text) & ", 0, 'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & ", " & Val(Me.txtFuel.Text) & "," & 0 & ")"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0 , " & Val(Me.txtFuel.Text) * Val(Me.txtCurrencyRate.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtFuel.Text) & " )"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If

            '--------------------------- Fuel Expense Credit
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If ExpenseChargeToCustomer = True Then
                If Val(Me.txtFuel.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtFuel.Text)) * Val(Me.txtCurrencyRate.Text) & ", 0, 'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & ", " & Val(Me.txtFuel.Text) & "," & 0 & " )"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId,sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtFuel.Text)) * Val(Me.txtCurrencyRate.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtFuel.Text) & " )"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If ExpenseChargeToCustomer = False Then
                ''Other Exp
                If Val(Me.txtExpense.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) * Val(Me.txtCurrencyRate.Text) & ", 0, 'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & ", " & Val(Me.txtExpense.Text) & "," & 0 & ")"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) * Val(Me.txtCurrencyRate.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtExpense.Text) & " )"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
                ''end Other Exp
            End If



            '---------------------- Other Expense Credit
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If ExpenseChargeToCustomer = True Then
                If Val(Me.txtExpense.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtExpense.Text)) * Val(Me.txtCurrencyRate.Text) & ", 0, 'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & ", " & Val(Me.txtExpense.Text) & "," & 0 & ")"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence,BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtExpense.Text)) * Val(Me.txtCurrencyRate.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtExpense.Text) & ")"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If Val(Me.txtAddTransitInsurance.Text) > 0 Then

                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId,sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtAddTransitInsurance.Text) * Val(Me.txtCurrencyRate.Text) & ", 0, 'Transit Insurace Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & ", " & Val(Me.txtAddTransitInsurance.Text) & "," & 0 & " )"

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(InsuranceAccountId) & ", " & 0 & ",  " & Val(Me.txtAddTransitInsurance.Text) * Val(Me.txtCurrencyRate.Text) & ", 'Transit Insurace Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtAddTransitInsurance.Text) & " )"
                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


            End If
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If Val(Me.txtAdjustment.Text) > 0 Then

                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.AdjustmentExpAccount & ", " & Val(Me.txtAdjustment.Text) & ", 0, 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.AdjustmentExpAccount & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) * Val(Me.txtCurrencyRate.Text) & ", 0, 'Adjustment Ref: " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & "," & 0 & " )"

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) * Val(Me.txtCurrencyRate.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & " )"

                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()
            End If


            '***********************
            '01-Feb-2011    Added for tax calculation
            '***********************
            If Val(Me.txtTaxTotal.Text) > 0 Then

                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtTaxTotal.Text) & ", 0, 'Tax Ref: " & Me.txtPONo.Text & "' )"
                If flgExcludeTaxPrice = False Then
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtTaxTotal.Text) & ", 0, 'Tax Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(txtCurrencyRate.Text) & "," & Val(Me.txtTaxTotal.Text) / Val(txtCurrencyRate.Text) & ", " & 0 & ")" ''TASK-408
                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtTaxTotal.Text) & ", 0, 'Tax Ref: " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )" ''Commented this row agaisnt TASK-408 ON 10-06-2016

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()
                End If

                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & SalesTaxId & ", " & 0 & ",  " & Val(Me.txtTaxTotal.Text) & ", 'Tax Ref: " & Me.txtPONo.Text & "' )"
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & SalesTaxId & ", " & 0 & ",  " & Val(Me.txtTaxTotal.Text) & ", 'Tax Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtTaxTotal.Text) / Val(txtCurrencyRate.Text) & ")"

                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()

            End If
            '
            'SED Tax Apply
            '
            '01-07-2012 
            If Val(Me.txtSEDTaxAmount.Text) > 0 Then

                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtSEDTaxAmount.Text) & ", 0, 'W.H Tax Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
                                 & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SEDAccountId) & ", " & 0 & ",  " & Val(Me.txtSEDTaxAmount.Text) & ", 'W.H Tax Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


            End If
            'Edit againt task 1620
            'If Val(Me.txtAddTransitInsurance.Text) > 0 Then

            '    objCommand.CommandText = ""
            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId,sp_refrence) " _
            '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtAddTransitInsurance.Text) & ", 0, 'Transit Insurace Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '    'objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()


            '    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
            '                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(InsuranceAccountId) & ", " & 0 & ",  " & Val(Me.txtAddTransitInsurance.Text) & ", 'Transit Insurace Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
            '    ' objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()


            'End If

            '***********************

            ''***********************
            ''06-Dec-2011    Added for Fuel, Other Expense, Adjustment
            ''***********************
            'Edit againt task 1620
            'If ExpenseChargeToCustomer = False Then
            '    ''Fuel
            '    If Val(Me.txtFuel.Text) > 0 Then

            '        'objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"
            '        'Task 1620 Added for DebitAmount Ayesha Rehman 
            '        objCommand.CommandText = ""
            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
            '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) * Val(txtCurrencyRate.Text) & ", 0, 'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & " )"

            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()


            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
            '                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0 , " & Val(Me.txtFuel.Text) * Val(txtCurrencyRate.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & " )"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If

            ''--------------------------- Fuel Expense Credit
            'If ExpenseChargeToCustomer = True Then
            '    If Val(Me.txtFuel.Text) > 0 Then

            '        'objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = ""
            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
            '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtFuel.Text)) & ", 0, 'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()


            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId,sp_refrence) " _
            '                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtFuel.Text)) & ", 'Fuel Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If
            ' ''end Fuel
            'Edit againt task 1620
            'If ExpenseChargeToCustomer = False Then
            '    ''Other Exp
            '    If Val(Me.txtExpense.Text) > 0 Then

            '        'objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = ""
            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
            '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()


            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
            '                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            '    ''end Other Exp
            'End If



            ''---------------------- Other Expense Credit
            'If ExpenseChargeToCustomer = True Then
            '    If Val(Me.txtExpense.Text) > 0 Then

            '        'objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = ""
            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
            '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtExpense.Text)) & ", 0, 'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()


            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
            '                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtExpense.Text)) & ", 'Expense Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If

            '// Removed expense charge to customer condition
            ' If ExpenseChargeToCustomer = False Then
            ''Adjustment
            'Edit againt task 1620
            'If Val(Me.txtAdjustment.Text) > 0 Then

            '    'objCommand.CommandText = ""
            '    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.AdjustmentExpAccount & ", " & Val(Me.txtAdjustment.Text) & ", 0, 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

            '    objCommand.CommandText = ""
            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
            '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.AdjustmentExpAccount & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", 0, 'Adjustment Ref: " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '    'objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()


            '    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
            '                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", 'Adjustment Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '    ' objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()
            'End If
            ' End If

            'If ExpenseChargeToCustomer = True Then
            '    If Val(Me.txtAdjustment.Text) > 0 Then
            '        objCommand.CommandText = ""
            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
            '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.AdjustmentExpAccount & ", 0, " & Math.Abs(IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment)) & ", 'Adjustment Ref: " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()


            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId,sp_refrence) " _
            '                                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment)) & ", 0, 'Adjustment Ref: " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If

            ''end Adjustment

            '***********************

            '
            ' Receipt Voucher Master Information 
            If ReceiptVoucherFlg = "True" AndAlso Val(Me.txtRecAmount.Text) <> 0 Then
                objCommand.CommandText = ""
                'VoucherNo = GetVoucherNo()
                'Before against task:2391
                'objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                '                           & " cheque_no, cheque_date,post,Source,voucher_code, coa_detail_id, Employee_Id)" _
                '                           & " VALUES(" & Me.cmbCompany.SelectedValue & ", 1,  " & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", N'" & VoucherNo & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                '                           & " " & IIf(Me.txtChequeNo.Visible = True, "N'" & Me.txtChequeNo.Text & "'", "NULL") & ", " & IIf(Me.dtpChequeDate.Visible = True, "N'" & dtpChequeDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", " & IIf(Me.chkPost.Checked = True, 1, 0) & ",N'" & Me.Name & "',N'" & Me.txtPONo.Text & "', " & Me.cmbDepositAccount.SelectedValue & ", " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ")" _
                '                           & " SELECT @@IDENTITY"
                'Task:2391 Configured Apostrophe On Cheuqe No And Po No
                objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                           & " cheque_no, cheque_date,post,Source,voucher_code, coa_detail_id, Employee_Id, Reference, UserName, other_voucher )" _
                           & " VALUES(" & Me.cmbCompany.SelectedValue & ", 1,  " & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", N'" & VoucherNo & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                           & " " & IIf(Me.txtChequeNo.Visible = True, "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'", "NULL") & ", " & IIf(Me.dtpChequeDate.Visible = True, "N'" & dtpChequeDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", '" & IIf(ReceiptPost = True, 1, 0) & "' ,N'" & Me.Name & "',N'" & Me.txtPONo.Text.Replace("'", "''") & "', " & Me.cmbDepositAccount.SelectedValue & ", " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ", " _
                           & " N'" & Me.txtPONo.Text & " " & Me.cmbVendor.Text.ToString & "', '" & LoginUserName & "', 0  )" _
                           & " SELECT @@IDENTITY"
                'End Task:2391

                'Insert into tblVoucher (location_id,finiancial_year_id,voucher_type_id,voucher_no,voucher_date, post,source,Reference,UserName, other_voucher, coa_detail_id, Posted_UserName, CMFADocId, Checked,CheckedByUser
                'INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, cheque_no, cheque_date,post,Source,voucher_code, coa_detail_id, Employee_Id, Reference, UserName, other_voucher,Posted_UserName, CMFADocId, Checked, CheckedByUser
                'objCommand.Transaction = trans
                lngVoucherMasterId = objCommand.ExecuteScalar


                objCommand.CommandText = ""
                'Before against task:2391
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", " & Me.cmbCompany.SelectedValue & ", " & Me.cmbDepositAccount.SelectedValue & ", " & Val(Me.txtRecAmount.Text) & ", 0, 'Receipt Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
                'Task:2391 Configured Apostrophe On PO No. Vendor Text
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(Me.cmbCompany.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & Me.cmbDepositAccount.SelectedValue & ", " & Val(Me.txtRecAmount.Text) & ", 0, N'Receipt Ref By " & Me.cmbVendor.Text.Replace("'", "''") & ": " & Me.txtPONo.Text.Replace("'", "''") & ": " & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
                'End Task:2391

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
                objCommand.CommandText = ""
                'Before against task:2391
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
                '                                     & " VALUES(" & lngVoucherMasterId & ", " & Me.cmbCompany.SelectedValue & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtRecAmount.Text) & ", 'Receipt Ref: " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
                'Task:2391 Configured Apostrophe on PO No
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
                                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(Me.cmbCompany.SelectedValue, 0, Me.cmbProject.SelectedValue) & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtRecAmount.Text) & ", N'Receipt Ref: " & Me.txtPONo.Text.Replace("'", "''") & ": " & Me.txtRemarks.Text.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
                'End Task:2391

                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()

                objCommand.CommandText = " if exists (select COUNT(*) from VoucherApprovalGroupSetting) " _
                                       & " if not exists (select * from VoucherApprovedLog where voucher_id=" & Val(lngVoucherMasterId) & ") " _
                                       & " insert into VoucherApprovedLog (Voucher_Id , UserGroupId ,VALstatus,UserId ,UserName,ModificationDate ) values (" & Val(lngVoucherMasterId) & ",1,'Pending', " & LoginUserId & ",'" & LoginUserName & "',GETDATE())"
                objCommand.ExecuteNonQuery()


            End If
            If Mode = "Normal" Then
                If IsSOSeparateClosure = False Then
                If Not DeliveryChalanId > 0 Then
                    If flgMultipleSalesOrder = False Then
                        If Me.cmbPo.SelectedIndex > 0 Then
                            objCommand.CommandText = "Select IsNull(Sz1,0) as Qty , isnull(DeliveredQty , 0) as DeliveredQty from SalesOrderDetailTable where SalesOrderID = " & Me.cmbPo.SelectedValue & ""
                            Dim da As New OleDbDataAdapter(objCommand)
                            Dim dt As New DataTable
                            da.Fill(dt)
                            Dim blnEqual As Boolean = True
                            If dt.Rows.Count > 0 Then
                                For Each r As DataRow In dt.Rows
                                    If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
                                        blnEqual = False
                                        Exit For
                                    End If
                                Next
                            End If
                            If blnEqual = True Then
                                objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where SalesOrderID = " & Me.cmbPo.SelectedValue & ""
                                objCommand.ExecuteNonQuery()
                            Else
                                objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & Me.cmbPo.SelectedValue & ""
                                objCommand.ExecuteNonQuery()
                                End If
                            End If
                        Else
                            objCommand.CommandText = "Select DISTINCT ISNULL(SO_ID,0) as SO_ID From SalesDetailTable WHERE SalesID=ident_current('SalesMasterTable') AND ISNULL(Sz1,0) <> 0"
                            Dim dtPO As New DataTable
                            Dim daPO As New OleDbDataAdapter(objCommand)
                            daPO.Fill(dtPO)
                            If dtPO IsNot Nothing Then
                                If dtPO.Rows.Count > 0 Then
                                    For Each row As DataRow In dtPO.Rows
                                        objCommand.CommandText = "Select SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) as DeliveredQty from SalesOrderDetailTable where SalesOrderID = " & row("SO_ID") & " Having SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) > 0 "
                                        Dim daPOQty As New OleDbDataAdapter(objCommand)
                                        Dim dtPOQty As New DataTable
                                        daPOQty.Fill(dtPOQty)
                                        Dim blnEqual1 As Boolean = True
                                        If dtPOQty.Rows.Count > 0 Then
                                            'For Each r As DataRow In dtPOQty.Rows
                                            'If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
                                            blnEqual1 = False
                                            'Exit For
                                            'End If
                                            ' Next
                                        End If
                                        If blnEqual1 = True Then
                                            objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                            objCommand.ExecuteNonQuery()
                                        Else
                                            objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                            objCommand.ExecuteNonQuery()
                            End If
                                    Next
                                End If
                            End If
                        End If
                        End If
                    Else
                        objCommand.CommandText = "Select DISTINCT ISNULL(SO_ID,0) as SO_ID From SalesDetailTable WHERE SalesID=ident_current('SalesMasterTable') AND ISNULL(Sz1,0) <> 0"
                        Dim dtPO As New DataTable
                        Dim daPO As New OleDbDataAdapter(objCommand)
                        daPO.Fill(dtPO)
                        If dtPO IsNot Nothing Then
                            If dtPO.Rows.Count > 0 Then
                                For Each row As DataRow In dtPO.Rows

                                    objCommand.CommandText = "Select SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) as DeliveredQty from SalesOrderDetailTable where SalesOrderID = " & row("SO_ID") & " Having SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) > 0 "
                                    Dim daPOQty As New OleDbDataAdapter(objCommand)
                                    Dim dtPOQty As New DataTable
                                    daPOQty.Fill(dtPOQty)
                                    Dim blnEqual1 As Boolean = True
                                    If dtPOQty.Rows.Count > 0 Then
                                        'For Each r As DataRow In dtPOQty.Rows
                                        'If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
                                        blnEqual1 = False
                                        'Exit For
                                        'End If
                                        ' Next
                                    End If
                                    If blnEqual1 = True Then
                                        objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                        objCommand.ExecuteNonQuery()
                                    Else
                                        objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                        objCommand.ExecuteNonQuery()
                                    End If
                                Next
                            End If
                        End If
                    End If
                End If




            'If DeliveryChalanId > 0 Then
            '    objCommand.CommandText = "Select isnull(Sz1,0) as Qty, isnull(DeliveredQty , 0) as DeliveredQty from DeliveryChalanDetailTable where DeliveryId = " & DeliveryChalanId & ""
            '    Dim da As New OleDbDataAdapter(objCommand)
            '    Dim dt As New DataTable
            '    da.Fill(dt)
            '    Dim blnEqual As Boolean = True

            '    If dt.Rows.Count > 0 Then
            '        For Each r As DataRow In dt.Rows
            '            If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
            '                blnEqual = False
            '                Exit For
            '            End If
            '        Next
            '    End If
            '    If blnEqual = True Then
            '        objCommand.CommandText = "Update DeliveryChalanMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where DeliveryId = " & DeliveryChalanId & ""
            '        objCommand.ExecuteNonQuery()
            '    Else
            '        objCommand.CommandText = "Update DeliveryChalanMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where DeliveryId = " & DeliveryChalanId & ""
            '        objCommand.ExecuteNonQuery()
            '    End If
            'End If

            UpdateDeliveryChalanStatus(Val(InvId), "Update", trans)

            ''Task:2702 Update Sold Qty In CMFADetailTable
            'objCommand.CommandText = ""
            'If blnCMFADocumentLoad = True Then
            '    If Me.cmbCMFADoc.SelectedIndex > 0 Then
            '        objCommand.CommandText = "UPDATE CMFADetailTable SET CMFADetailTable.SoldQty=a.SoldQty From " _
            '         & " (SELECT SalesMasterTable.CMFADocID, SalesDetailTable.LocationId, SalesDetailTable.ArticleDefId, " _
            '         & " SUM(ISNULL(SalesDetailTable.Sz1, 0)) AS SoldQty " _
            '         & " FROM dbo.SalesDetailTable INNER JOIN SalesMasterTable On SalesMasterTable.SalesID = SalesDetailTable.SalesID " _
            '         & " WHERE(SalesMasterTable.CMFADocID <> 0 AND SalesMasterTable.CMFADocID=" & Me.cmbCMFADoc.SelectedValue & ") " _
            '         & "  GROUP BY SalesDetailTable.ArticleDefId,  SalesMasterTable.CMFADocID, SalesDetailTable.LocationId)a " _
            '         & " WHERE(a.CMFADocId = CMFADetailTable.docID) " _
            '         & " AND CMFADetailTable.ArticleDefID = a.ArticleDefID " _
            '         & " AND a.LocationID = CMFADetailTable.LocationID AND CMFADetailTable.DocId=" & Me.cmbCMFADoc.SelectedValue & ""
            '        objCommand.ExecuteNonQuery()
            '    End If
            'End If
            ''End Task:2702

            'SaveDocument(InvId, Me.Name, trans)
            'Marked Against Task#2015060001 Ali Ansari
            'Altered Against Task#2015060001 Ali Ansari
            SaveOutwardExpense(Val(getVoucher_Id), trans)

            If arrFile.Count > 0 Then
                SaveDocument(getVoucher_Id, Me.Name, trans)
            End If
            'Altered Against Task#2015060001 Ali Ansari
            'If IsValidate() = True Then

            'If IsValidate() = True AndAlso DCStockImpact = False AndAlso Me.cmbDeliveryChalan.SelectedValue <= 0 Then
            '    Call New StockDAL().Add(StockMaster, trans)
            'End If
            ''TASK TFS1378 changed conditions for stock impact on 16-10-2017
            If DCStockImpact = True AndAlso Me.cmbDeliveryChalan.SelectedValue > 0 Then

            Else
                If IsValidate() = True Then
                    Call New StockDAL().Add(StockMaster, trans)
                End If
            End If
            ''End TASK TFS1378

            ''TASK TFS4391 
            If getConfigValueByType("IsDuplicateSales").ToString.ToUpper = "TRUE" Then
                Call CreateDuplicateSales(getVoucher_Id, "Save", trans)
            End If
            ''END TFS4391

            trans.Commit()
            Save = True

            If Mode = "Normal" Then
                SaveActivityLog("POS", Me.Text, EnumActions.Save, LoginUserId, EnumRecordType.Sales, Me.txtPONo.Text.Trim, True)
                SaveActivityLog("Accounts", Me.Text, EnumActions.Save, LoginUserId, EnumRecordType.AccountTransaction, Me.txtPONo.Text, True)
            End If
            ''Start TFS3113
            ''insert Approval Log
            SaveApprovalLog(EnumReferenceType.Sales, getVoucher_Id, Me.txtPONo.Text.Trim, Me.dtpPODate.Value.Date, "Sales," & cmbVendor.Text & "", Me.Name, 7)
            ''End TFS3113

            If Not Mode = "Normal" Then
                Me.BackgroundWorker1.RunWorkerAsync()
            End If

            'Call Save1() 'Upgrading Stock here ...

            setEditMode = False
            Total_Amount = Val(Me.txtAmount.Text) 'Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)


            '...................... Send SMS .............................
            If GetSMSConfig("SMS To Location On Sale Invoice").Enable = True Then
                If msg_Confirm(str_ConfirmSendSMSMessage) = True Then
                    Dim strSMSBody As String = String.Empty
                    Dim objData As DataTable = CType(Me.grd.DataSource, DataTable)
                    Dim dt_Loc As DataTable = objData.DefaultView.ToTable("Default", True, "LocationId")
                    Dim drData() As DataRow
                    For j As Integer = 0 To dt_Loc.Rows.Count - 1
                        strSMSBody = String.Empty
                        strSMSBody += "Sale Invoice, Doc No: " & Me.txtPONo.Text & ", Doc Date: " & Me.dtpPODate.Value.ToShortDateString & ", Customer: " & Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString & ", Bilty No: " & Me.uitxtBiltyNo.Text & ", Remarks:" & Me.txtRemarks.Text & ", "
                        drData = objData.Select("LocationId=" & dt_Loc.Rows(j).Item(0).ToString & "")
                        Dim dblTotalQty As Double = 0D
                        Dim dblTotalAmount As Double = 0D
                        For Each dr As DataRow In drData
                            dblTotalQty += IIf(dr(EnumGridDetail.Unit).ToString = "Loose", Val(dr(EnumGridDetail.Qty).ToString), Val(dr(EnumGridDetail.Qty).ToString) * Val(dr(EnumGridDetail.PackQty).ToString))
                            strSMSBody += " " & dr(EnumGridDetail.Item).ToString & ", " & IIf(dr(EnumGridDetail.Unit).ToString = "Loose", " " & dr(EnumGridDetail.Qty).ToString & "", "" & (Val(dr(EnumGridDetail.Qty)).ToString * Val(dr(EnumGridDetail.PackQty)).ToString) & "") & ", "
                        Next
                        strSMSBody += " Total Qty: " & dblTotalQty & ""
                        Dim LocationPhone() As String = GetLocation(Val(dt_Loc.Rows(j).Item(0).ToString)).Mobile_No.Replace(",", ";").Replace("|", ";").Replace("\", ";").Replace("/", ";").Replace("^", ";").Replace("*", ";").Split(";")
                        If LocationPhone.Length > 0 Then
                            For Each strPhone As String In LocationPhone
                                If strPhone.Length > 0 Then
                                    Try
                                        SaveSMSLog(strSMSBody, strPhone, "SMS to Location")
                                    Catch ex As Exception
                                        Throw ex
                                    End Try
                                End If
                            Next
                        End If
                    Next
                End If
            End If

            If GetSMSConfig("Sale Invoice").Enable = True Or Len(Me.txtMobileNo.Text.Trim) > 0 Then
                If msg_Confirm(str_ConfirmSendSMSMessage) = False Then Exit Try
                Dim strDetailMessage As String = String.Empty
                For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    'Task#08082015 Add configuration for sending sms with just item qunatity and engine no
                    If getConfigValueByType("DeliveryChalanByEnigneNo").ToString = "True" Then
                        If strDetailMessage.Length = 0 Then
                            strDetailMessage = "Item Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        Else
                            strDetailMessage += ", Item Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        End If
                        'End Task#08082015
                    Else
                        If strDetailMessage.Length = 0 Then
                            strDetailMessage = r.Cells(EnumGridDetail.Item).Value.ToString & ", PackQty: " & Val(r.Cells(EnumGridDetail.PackQty).Value.ToString) & ", Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        Else
                            strDetailMessage += "," & r.Cells(EnumGridDetail.Item).Value.ToString & ", PackQty: " & Val(r.Cells(EnumGridDetail.PackQty).Value.ToString) & ", Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        End If
                    End If
                Next
                Dim objTemp As New SMSTemplateParameter
                Dim obj As Object = GetSMSTemplate("Sale Invoice")
                If obj IsNot Nothing Then
                    objTemp.SMSTemplate = CType(obj, SMSTemplateParameter).SMSTemplate
                    Dim strMessage As String = objTemp.SMSTemplate
                    strMessage = strMessage.Replace("@AccountTitle", Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString).Replace("@AccountCode", Me.cmbVendor.ActiveRow.Cells("Code").Value.ToString).Replace("@DocumentNo", Me.txtPONo.Text).Replace("@DocumentDate", Me.dtpPODate.Value.ToShortDateString).Replace("@OtherDoc", Me.uitxtBiltyNo.Text).Replace("@Remarks", Me.txtRemarks.Text).Replace("@Amount", Me.txtNetAmount.Text).Replace("@Quantity", Me.grd.GetTotal(grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)).Replace("@DCNo", Me.txtDcNo.Text).Replace("@CMFADocNo", IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.Text, String.Empty)).Replace("@SONo", IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.Text, String.Empty)).Replace("@InvParty", Me.txtInvParty.Text).Replace("@CompanyName", CompanyTitle).Replace("@SIRIUS", "Automated by www.siriussolution.com").Replace("@DetailInformation", strDetailMessage).Replace("@BiltyNo", Me.uitxtBiltyNo.Text.Replace("'", "''")).Replace("@PreviousBalance", _Previous_Balance).Replace("@Transporter", IIf(Me.cmbTransporter.SelectedIndex > 0, Me.cmbTransporter.Text, "' '"))
                    SaveSMSLog(strMessage, Me.cmbVendor.ActiveRow.Cells("Mobile").Value.ToString, "Sale Invoice")
                    If GetSMSConfig("Sale Invoice").EnabledAdmin = True Then
                        For Each strMob As String In strAdminMobileNo.Replace(",", ";").Replace("|", ";").Replace("^", ";").Split(";")
                            If strMob.Length > 10 Then
                                SaveSMSLog(strMessage, strMob, "Sale Invoice")
                            End If
                        Next
                    End If
                    Dim strMobiles() As String = CStr(Me.txtMobileNo.Text).Split(",")
                    If strMobiles.Length > 0 Then
                        For Each strMobNo As String In strMobiles
                            If strMobNo.Length >= 10 Then
                                SaveSMSLog(strMessage, strMobNo, "Sale Invoice")
                            End If
                        Next
                    End If
                End If
            End If
            'Dim ValueTable As DataTable = GetSingle(getVoucher_Id)
            'NotificationDAL.SaveAndSendNotification("Sales", "SalesMasterTable", getVoucher_Id, ValueTable, "Sales > Sales")
            '...................... End Send SMS ................
            ''TASK:945 dated 16-06-2017
            SendConfiguredNotification(setVoucherNo, getVoucher_Id, Me.grd.RowCount)
            ''END TAKS:945

        Catch ex As Exception
            trans.Rollback()
            Save = False
            ShowErrorMessage("An error occured while saving record" & ex.Message)
        Finally
            Me.lblProgress.Visible = False

        End Try
    End Function




    Sub InsertVoucher()

        Try
            'SaveVoucherEntry(GetVoucherTypeId("SV"), GetNextDocNo("SV", 6, "tblVoucher", "voucher_no"), Me.dtpPODate.Value, "", Nothing, GetConfigValue("SalesCreditAccount"), Val(Me.cmbVendor.ActiveRow.Cells(0).Text.ToString), Val(Me.txtAmount.Text), Val(Me.txtAmount.Text), "Both", Me.Name, Me.txtPONo.Text, True)
        Catch ex As Exception
            ShowErrorMessage("An error occured while saving voucher: " & ex.Message)
        End Try

    End Sub

    Private Function FormValidate() As Boolean


        If txtPONo.Text = "" Then
            msg_Error("You must enter Invoice No.")
            txtPONo.Focus() : FormValidate = False : Exit Function
        End If
        ''TASK TFS1669 
        If SalesInvoiceSkipDAL.IsSkipped(txtPONo.Text) Then
            msg_Error("This Invoice No has been skipped. Please click New button to get next Invoice No ")
            txtPONo.Focus() : FormValidate = False : Exit Function
        End If
        ''END TASK TFS1669
        If Val(Me.txtRecAmount.Text) > 0 Then
            If Me.cmbDepositAccount.SelectedIndex <= 0 Then
                ShowErrorMessage("Please Select Deposit Cash/Bank Account.")
                Me.cmbDepositAccount.Focus()
                Return False
            End If
        End If
        ''Start TFS2988 : Ayesha Rehman : 09-04-2018
        If IsEditMode = True Then
            If ValidateApprovalProcessMapped(Me.txtPONo.Text.Trim) Then
                If ValidateApprovalProcessInProgress(Me.txtPONo.Text.Trim) Then
                    msg_Error("Document is in Approval Process ") : Exit Function
                End If
            End If
        End If

        'Change by murtaza default currency rate(10/26/2022) 
        If cmbCurrency.SelectedValue <> BaseCurrencyId AndAlso Val(txtCurrencyRate.Text) = 1 Then
            msg_Error(cmbCurrency.Text + "Currency Rate cannot be 1")
            txtCurrencyRate.Focus() : FormValidate = False : Exit Function
        End If
        'Change by murtaza default currency rate(10/26/2022)
        ''End TFS2988
        If Me.Mode = "Normal" Then

            'If Me.cmbSalesMan.SelectedIndex <= 0 Then
            'msg_Error("You must select Sales Person")
            '  Me.cmbSalesMan.Focus() : FormValidate = False : Exit Function
            '   End If
            If cmbVendor.ActiveRow Is Nothing Then FormValidate = False : Exit Function
            If cmbVendor.ActiveRow.Cells(0).Value <= 0 Then
                msg_Error("Please Select Customer")
                cmbVendor.Focus() : FormValidate = False : Exit Function
            End If
            If Not IsDBNull(cmbVendor.ActiveRow.Cells("ExpiryDate").Value) Then
                If cmbVendor.ActiveRow.Cells("ExpiryDate").Value < Me.dtpPODate.Value Then
                    If Not msg_Confirm("Selected Customer has been expired" & (Chr(13)) & "Do you want to save?") = True Then
                        cmbVendor.Focus() : FormValidate = False : Exit Function
                    Else
                        Return True
                    End If
                End If
            End If
            If Val(cmbVendor.ActiveRow.Cells("Limit").Value.ToString) > 0 Then
                Dim CurrentBalance As Integer = GetAccountBalance(Me.cmbVendor.ActiveRow.Cells(0).Value)

                'If CurrentBalance + Val(Me.txtTotal.Text) > Val(cmbVendor.ActiveRow.Cells("Limit").Value.ToString) Then 'Comment against task:M29
                'Task:M29 Replace Amount 
                If ((CurrentBalance + Val(Me.txtAmount.Text)) - Val(Me.txtRecAmount.Text)) > Val(cmbVendor.ActiveRow.Cells("Limit").Value.ToString) Then
                    msg_Error("Credit Limit Of Customer is Over ")
                    cmbVendor.Focus() : FormValidate = False : Exit Function
                End If
            End If

            ' If Me.cmbTransporter.SelectedIndex <= 0 Then
            'msg_Error("You must select Transportor")
            'Me.cmbTransporter.Focus() : FormValidate = False : Exit Function
            'End If
        End If

        If Not Me.grd.RecordCount > 0 Then
            msg_Error(str_ErrorNoRecordFound)
            cmbItem.Focus() : FormValidate = False : Exit Function
        End If


        'Dim CurrentBalance As Integer = GetAccountBalance(Me.cmbVendor.ActiveRow.Cells(0).Value)
        'Comment Against Task:2388

        'Dim IsMinus As Boolean = getConfigValueByType("AllowMinusStock")

        'If IsMinus = False Then Return True
        'End Task:2388
        'Dim cmd As New OleDbCommand
        'cmd.CommandType = CommandType.Text
        'cmd.Connection = Con
        'Dim da As New OleDbDataAdapter(cmd)
        'Dim dt As New DataTable
        'If Con.State = ConnectionState.Closed Then Con.Open()
        'cmd.CommandText = "SELECT Stock , articleid , BatchNo    FROM         dbo.vw_Batch_Stock "
        'da.Fill(dt)
        Me.grd.UpdateData()
        Dim StockOutConfigration As String = "" ''1596
        ''Start Task 1596
        If Not getConfigValueByType("StockOutConfigration").ToString = "Error" Then ''1596
            StockOutConfigration = getConfigValueByType("StockOutConfigration").ToString
        End If
        'ShowInformationMessage(StockOutConfigration)
        For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
            If StockOutConfigration.Equals("Required") AndAlso r.Cells("Batch No").Value.ToString = String.Empty Then
                msg_Error("Please Enter Value in Batch No")
                Return False
                Exit For
            End If
        Next
        'End Task:1596

        ''Start TFS1663
        For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
            If getCustomerBottomSaleRate(Val(r.Cells(EnumGridDetail.ArticleID).Value.ToString)) > Val(r.Cells(EnumGridDetail.PostDiscountPrice).Value.ToString) Then
                ShowErrorMessage("Sale price is less than Bottom Sale Rate ")
                FormValidate = False : Exit Function

            End If
        Next
        ''End TFS1663
        If Me.IsEditMode = False Then
            If Me.cmbPo.SelectedIndex > 0 Then
                ' If dt.Rows.Count > 0 Then
                'Dim dv As DataView = dt.DefaultView
                For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    'dv.RowFilter = "articleid = " & r.Cells(EnumGridDetail.ArticleID).Value & " and BatchNo = N'" & r.Cells(EnumGridDetail.BatchNo).Value & "'"
                    'dv.RowFilter = "articleid = " & r.Cells(EnumGridDetail.ArticleID).Value & ""
                    'If dv.Count > 0 Then
                    'If r.Cells("Qty").Value <= 0 Then
                    '    msg_Error("Qty must be greate than 0")
                    '    Return False
                    'End If

                    If r.Cells("Rate").Value <= 0 Then
                        msg_Error("Price must be greate than 0")
                        Return False
                    End If

                    'If r.Cells("Qty").Value > dv(0)("Stock") Then
                    '    msg_Error("item : " & r.Cells("Item").Value & " out of stock. available is " & dv(0)("Stock"))
                    '    r.Selected = True
                    '    Return False
                    'End If
                    'End If
                Next
                'End If
            End If
        Else

            If Me.cmbPo.SelectedIndex > 0 Then
                'If dt.Rows.Count > 0 Then
                'Dim dv As DataView = dt.DefaultView
                For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    'dv.RowFilter = "articleid = " & r.Cells("articledefid").Value & " and BatchNo = N'" & r.Cells("Batch No").Value & "'"
                    'dv.RowFilter = "articleid = " & r.Cells("articledefid").Value & ""
                    'If dv.Count > 0 Then
                    'If r.Cells("Qty").Value <= 0 Then
                    '    msg_Error("Qty must be greate than 0")
                    '    Return False
                    'End If

                    If r.Cells("Rate").Value <= 0 Then
                        msg_Error("Price is not greate than 0")
                        Return False
                    End If

                    'If r.Cells("Qty").Value > r.Cells("SavedQty").Value + dv(0)("Stock") Then
                    '    msg_Error("item : " & r.Cells("Item").Value & " out of stock. available is " & dv(0)("Stock"))
                    '    r.Selected = True
                    '    Return False
                    'End If
                    'End If
                Next
                'End If
            End If
        End If
        'Task:2380 Validation Credit Sales
        'If CreditSales = False Then
        '    If Me.grd.RowCount > 0 Then
        '        If Val(Me.txtRecAmount.Text) = 0 Then
        '            'Me.btnReceipt_Click(Nothing, Nothing)
        '            Me.cmbInvType_SelectedIndexChanged(Nothing, Nothing)
        '            ShowErrorMessage("Please Enter Cash Amount")
        '            Me.txtRecAmount.Focus()
        '            Return False
        '        End If
        '    End If
        'End If
        'End Task:2380
        'Task:2415 Validation Engine No and Chassis No.


        If flgVehicleIdentificationInfo = True Then
            If CheckDuplicateEngineNo() = True Then
                ShowErrorMessage("Engine no already exist.")
                Me.grd.Focus()
                Return False
            End If
            If CheckDuplicateChassisNo() = True Then
                ShowErrorMessage("Chassis no already exist.")
                Me.grd.Focus()
                Return False
            End If
        End If
        'End Task:2415

        'Task:2796 Apply Validation On Order Qty Exceed.
        If blnOrderQtyExceed = True Then
            If Me.cmbPo.SelectedIndex > 0 Then
                Dim objDt As New DataTable
                '' TASK: TFS1263 to restrict to not take Qty more than Sales Order. on 07-08-2017
                'objDt = GetDataTable("SELECT SO_DT.ArticleDefId, SUM(ISNULL(SO_DT.Qty,0)) AS Qty, SUM(IsNull(DC_DT.Qty,0)) as DTQty FROM dbo.SalesOrderDetailTable AS SO_DT LEFT OUTER JOIN dbo.SalesMasterTable AS DC ON SO_DT.SalesOrderId = DC.POId LEFT OUTER JOIN (SELECT SalesId, ArticleDefId, IsNull(Qty, 0) AS Qty FROM SalesDetailTable " & IIf(Me.BtnSave.Text = "&Update", " WHERE SalesId <> " & Val(Me.txtReceivingID.Text) & "", "") & ") DC_DT ON DC_DT.SalesId = DC.SalesId AND  DC_DT.ArticleDefID = SO_DT.ArticleDefId WHERE SO_DT.SalesOrderId=" & Me.cmbPo.SelectedValue & " GROUP BY SO_DT.ArticleDefId, DC.POId")
                '' TASK: TFS4360 : Ayesha Rehman : Query Edit getting orignal SO qty without subrating DeliveredQty (IsNull(Sz1, 0)-IsNull(DeliveredQty, 0)) changes to IsNull(Sz1, 0) . on 07-08-2017
                For Each Row As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    If IsDBNull(Row.Cells(EnumGridDetail.DeliveryChalanId).Value) Then
                        objDt = GetDataTable("Select Detail.ArticleDefId, Detail.SalesOrderDetailId, IsNull(Sz1, 0) As SOQty, IsNull(Sales.Qty, 0) As SQty, IsNull(Sz1, 0) As UndeliveredQty, IsNull(DeliveredQty, 0) As DeliveredQty From SalesOrderDetailTable As Detail " _
                                             & " INNER JOIN SalesOrderMasterTable As Master ON Detail.SalesOrderId = Master.SalesOrderId " _
                                             & " LEFT OUTER JOIN (Select ArticleDefId, IsNull(SO_Detail_Id, 0) As SalesOrderDetailId, Sum(IsNull(Sz1, 0)) As Qty " _
                                             & " FROM SalesDetailTable As Detail INNER JOIN SalesMasterTable As Master ON Detail.SalesId = Master.SalesId Where POId =" & Row.Cells(EnumGridDetail.SO_ID).Value & " Group By ArticleDefId, SO_Detail_Id) " _
                                             & " As Sales ON Detail.SalesOrderDetailId = Sales.SalesOrderDetailId And Detail.ArticleDefId = Sales.ArticleDefId Where Master.SalesOrderId = " & Row.Cells(EnumGridDetail.SO_ID).Value & "")
                        If objDt IsNot Nothing Then
                            If objDt.Rows.Count > 0 Then
                                For Each grdRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                                    For Each r As DataRow In objDt.Rows
                                        If IsDBNull(grdRow.Cells(EnumGridDetail.DeliveryChalanId).Value) Then
                                            If grdRow.Cells(EnumGridDetail.ArticleID).Value = Val(r.Item("ArticleDefId").ToString) AndAlso grdRow.Cells(EnumGridDetail.SODetailId).Value = Val(r.Item("SalesOrderDetailId").ToString) Then
                                                If IsEditMode Then
                                                    ''TFS4360 : Ayesha Rehman : 04-09-2018 : Changes SQty to SOQty
                                                    If (Val(r.Item("DeliveredQty").ToString) + Val(grdRow.Cells(EnumGridDetail.Qty).Value) - Val(r.Item("SQty").ToString)) > Val(r.Item("SOQty").ToString) Then
                                                        'Dim remainingQty As Double = Val(grdRow.Cells(EnumGridDetail.Qty).Value) - Val(grdRow.Cells(EnumGridDetail.Qty).Value)
                                                        'If remainingQty > Val(r.Item("SOQty").ToString) Then
                                                        ShowErrorMessage("Order [" & grdRow.Cells(EnumGridDetail.Item).Value.ToString & "] qty exceed")
                                                        grd.Focus()
                                                        Return False
                                                        'End If
                                                    End If
                                                Else
                                                    ''TFS4360 : Ayesha Rehman : 04-09-2018 : Added DeliveredQty to check whole qty in Sales Order
                                                    If (Val(r.Item("DeliveredQty").ToString) + Val(grdRow.Cells(EnumGridDetail.Qty).Value)) > Val(r.Item("SOQty").ToString) Then
                                                        ShowErrorMessage("Order [" & grdRow.Cells(EnumGridDetail.Item).Value.ToString & "] qty exceed")
                                                        grd.Focus()
                                                        Return False
                                                    End If
                                                    ''TASK: TFS1263
                                                End If
                                            End If
                                        End If
                                    Next
                                Next
                            End If
                        End If
                    End If
                Next
            End If
        End If
        'End Task:2796


        'Task:2796 Apply Validation On Delivery Qty Exceed.
        'Task:4360 Apply Validation On Delivery Qty Exceed not working properly.
        If blnDeliveryQtyExceed = True Then
            If DeliveryChalanId > 0 Then
                Dim objDt As New DataTable
                For Each Row As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    If Not IsDBNull(Row.Cells(EnumGridDetail.DeliveryChalanId).Value) Then
                        objDt = GetDataTable("SELECT SO_DT.ArticleDefId, SUM(ISNULL(SO_DT.Qty,0)) AS Qty, SUM(IsNull(DC_DT.Qty,0)) as DCQty FROM dbo.DeliveryChalanDetailTable AS SO_DT LEFT OUTER JOIN dbo.SalesMasterTable AS DC ON SO_DT.DeliveryId = DC.DeliveryChalanId LEFT OUTER JOIN (SELECT SalesId, ArticleDefId, IsNull(Qty, 0) AS Qty FROM SalesDetailTable " & IIf(Me.BtnSave.Text = "&Update", " WHERE SalesId <> " & Val(Me.txtReceivingID.Text) & "", "") & ") DC_DT ON DC_DT.SalesId = DC.SalesId AND  DC_DT.ArticleDefID = SO_DT.ArticleDefId WHERE SO_DT.DeliveryId=" & Row.Cells(EnumGridDetail.DeliveryChalanId).Value & " GROUP BY SO_DT.ArticleDefId, DC.DeliveryChalanId")
                        If objDt IsNot Nothing Then
                            If objDt.Rows.Count > 0 Then
                                For Each grdRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                                    For Each r As DataRow In objDt.Rows
                                        If (grdRow.Cells(EnumGridDetail.ArticleID).Value = Val(r.Item("ArticleDefId").ToString)) Then
                                            If (grdRow.Cells(EnumGridDetail.Qty).Value + Val(r.Item("DCQty").ToString)) > Val(r.Item("Qty").ToString) Then
                                                ShowErrorMessage("Order [" & grdRow.Cells(EnumGridDetail.Item).Value.ToString & "] qty exceed")
                                                grd.Focus()
                                                Return False
                                            End If
                                        End If
                                    Next
                                Next
                            End If
                        End If
                    End If
                Next
            End If
        End If
        'End Task:2796

        'Dim dtchkCertificate As New DataTable
        'dtchkCertificate = GetDataTable("Select Count(*) From SalesCertificateTable WHERE SalesID=" & Val(Me.txtReceivingID.Text) & "")
        'dtchkCertificate.AcceptChanges()
        'If dtchkCertificate.Rows.Count > 0 Then
        '    If Val(dtchkCertificate.Rows(0).Item(0).ToString) > 0 Then
        '        ShowErrorMessage(str_ErrorDependentRecordFound)
        '        Return False
        '    End If
        'End If


        If Me.BtnSave.Text <> "&Save" Then
            Dim dt As New DataTable
            dt = GetDataTable("Select Count(*) From SalesMasterTable WHERE SalesId In(Select SalesId From SalesCertificateTable WHERE SalesId=" & Val(Me.txtReceivingID.Text) & ")")
            dt.AcceptChanges()
            If dt.Rows.Count > 0 Then
                If Val(dt.Rows(0).Item(0).ToString) > 0 Then
                    'If msg_Confirm("Certificate has been issued in this invoice." & Chr(10) & "Do you want update this record.?") = False Then Return False
                    blnCertificateIssued = True
                    'Return False
                End If
            End If
        End If


        Return True

    End Function

    Sub EditRecord()
        Try

            If Not Me.grdSaved.RecordCount > 0 Then Exit Sub
            If blnUpdateAll = False Then
                If Me.grd.RecordCount > 0 Then
                    If Not msg_Confirm(str_ConfirmGridClear) = True Then Exit Sub
                End If
            End If

            Me.IsEditMode = True
            IsDrillDown = False
            RemoveHandler Me.cmbCompany.SelectedIndexChanged, AddressOf Me.cmbCompany_SelectedIndexChanged
            RemoveHandler Me.cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
            RemoveHandler Me.cmbDeliveryChalan.SelectedIndexChanged, AddressOf Me.cmbDeliveryChalan_SelectedIndexChanged
            Me.cmbVendor.Enabled = IsDBNull(Me.grdSaved.GetRow.Cells("InvoiceID").Value)
            'Me.Mode = "Edit"
            'Dim dtVendor As DataTable = CType(Me.cmbVendor.DataSource, DataTable)
            'Dim drVendor() As DataRow = dtVendor.Select("Id=" & grdSaved.CurrentRow.Cells("CustomerCode").Value & "")
            'If drVendor IsNot Nothing Then
            '    If Not drVendor.Length > 0 Then
            '        FillCombo("Vendor")
            '    End If
            'End If
            ' Me.FillCombo("SOComplete")
            Me.btnAttachment.Text = "Attachment (" & grdSaved.CurrentRow.Cells("No Of Attachment").Value.ToString & ")"
            txtPONo.Text = grdSaved.CurrentRow.Cells(0).Value.ToString
            Me.BtnSave.Text = "&Update"
            Me.GetSecurityRights()
            'Task 1592
            If grdSaved.CurrentRow.Cells(1).Value > Date.Today.ToString("yyyy-MM-dd 23:59:59") AndAlso IsDateChangeAllowed = False Then
                dtpPODate.MaxDate = dtpPODate.Value.AddMonths(3)
                dtpPODate.Value = CType(grdSaved.CurrentRow.Cells(1).Value, Date)
            Else
                dtpPODate.MaxDate = System.DateTime.MaxValue.AddYears(-2) ''TFS3428 : Ayesha Rehman
                dtpPODate.Value = CType(grdSaved.CurrentRow.Cells(1).Value, Date)
            End If
            txtReceivingID.Text = grdSaved.CurrentRow.Cells("SalesId").Value

            ''Ayesha Rehman :TFS3113 :Making Approval Button Enable in Edit Mode
            Me.btnApprovalHistory.Visible = True
            Me.btnApprovalHistory.Enabled = True
            ''Ayesha Rehman :TFS3113 :End
            'TODO. ----
            ''ReqId-924 Validate disabled customer
            cmbVendor.Value = grdSaved.CurrentRow.Cells("CustomerCode").Value
            If Me.cmbVendor.ActiveRow Is Nothing Then
                ShowErrorMessage("Customer is disable.")
                Exit Sub
            End If
            cmbCompany.SelectedValue = grdSaved.CurrentRow.Cells("LocationId").Value
            cmbCompany.Enabled = False
            txtRemarks.Text = grdSaved.CurrentRow.Cells("Remarks").Value & ""
            'rafay
            Me.txtPO.Text = grdSaved.CurrentRow.Cells("PO_NO").Value & ""
            'rafay
            'Changes add to add column contract no (Murtaza) (11/15/2022)
            Me.txtcontractno.Text = grdSaved.CurrentRow.Cells("ContractNo").Value & ""
            'Changes add to add column contract no (Murtaza) (11/15/2022)
            richTxtInternalRemarks.Text = grdSaved.CurrentRow.Cells("InternalRemarks").Value & "" ''TFS1864
            txtPaid.Text = grdSaved.CurrentRow.Cells("CashPaid").Value & ""
            txtCurrentBalance.Text = Val(grdSaved.CurrentRow.Cells("PreviousBalance").Value.ToString)
            Me.uitxtBiltyNo.Text = grdSaved.CurrentRow.Cells("BiltyNo").Value & ""
            Me.cmbSalesMan.SelectedValue = grdSaved.CurrentRow.Cells("EmployeeCode").Value.ToString
            Me.txtComPercentage.Text = Val(grdSaved.CurrentRow.Cells("Com_Percentage").Value.ToString)
            'RemoveHandler cmbPo.SelectedIndexChanged, AddressOf cmbPo_SelectedIndexChanged
            Me.cmbPo.SelectedValue = Val(grdSaved.CurrentRow.Cells("POID").Value.ToString)
            'Dim chkPO As DataTable = CType(Me.cmbPo.DataSource, DataTable)
            'Dim drChkPO() As DataRow
            'drChkPO = chkPO.Select("SalesOrderNo=N'" & Me.grdSaved.CurrentRow.Cells("SalesOrderNo").Value.ToString & "'")
            If Me.cmbPo.SelectedValue Is Nothing Then
                Dim dt As New DataTable
                dt = CType(Me.cmbPo.DataSource, DataTable)
                dt.AcceptChanges()
                'dt.Columns.Add("SalesOrderID", GetType(System.Int32))
                'dt.Columns.Add("SalesOrderNo", GetType(System.String))
                Dim dr As DataRow
                dr = dt.NewRow
                dr(0) = Me.grdSaved.CurrentRow.Cells("PoId").Value
                dr(1) = Me.grdSaved.CurrentRow.Cells("SalesOrderNo").Value
                dt.Rows.Add(dr)
                dt.AcceptChanges()
                'Me.cmbPo.DataSource = dt
                'Me.cmbPo.DisplayMember = "SalesOrderNo"
                'Me.cmbPo.ValueMember = "SalesOrderId"
                'dt = Nothing
                Me.cmbPo.SelectedValue = Val(grdSaved.CurrentRow.Cells("POID").Value.ToString)
            End If

            'Task:2702 Get Validation On CMFA
            'AddHandler cmbPo.SelectedIndexChanged, AddressOf cmbPo_SelectedIndexChanged
            Dim chkDtCMFA As DataTable = CType(Me.cmbCMFADoc.DataSource, DataTable)
            Dim chkDrCMFA() As DataRow
            If chkDtCMFA IsNot Nothing Then
                chkDrCMFA = chkDtCMFA.Select("DocID=" & Me.grdSaved.CurrentRow.Cells("CMFADocId").Value.ToString & "")
                If chkDrCMFA.Length = 0 Then
                    Dim objdr As DataRow
                    objdr = chkDtCMFA.NewRow
                    objdr(0) = Me.grdSaved.CurrentRow.Cells("CMFADocId").Value.ToString
                    objdr(1) = Me.grdSaved.CurrentRow.Cells("CMFADocNo").Value.ToString
                    chkDtCMFA.Rows.Add(objdr)
                    chkDtCMFA.AcceptChanges()
                End If
            End If
            Me.cmbCMFADoc.SelectedValue = Me.grdSaved.CurrentRow.Cells("CMFADocId").Value.ToString
            'End Task:2702
            Me.cmbOtherCompany.Text = Me.grdSaved.GetRow.Cells("Other_Company").Value.ToString
            Me.cmbPo.SelectedValue = Me.grdSaved.CurrentRow.Cells("PoId").Value
            Me.cmbTransporter.SelectedValue = Me.grdSaved.CurrentRow.Cells("TransporterId").Value
            Me.txtExpense.Text = Me.grdSaved.CurrentRow.Cells("Expense").Value.ToString
            Me.txtFuel.Text = Me.grdSaved.CurrentRow.Cells("Fuel").Value.ToString
            Me.txtAddTransitInsurance.Text = Me.grdSaved.CurrentRow.Cells("TransitInsurance").Value.ToString
            Me.txtInvParty.Text = Me.grdSaved.GetRow.Cells("InvoiceParty").Value.ToString 'Task:2681 Get Invoice Party
            Me.DeliveryChalanId = Me.grdSaved.CurrentRow.Cells("DeliveryId").Value.ToString
            IsSOSeparateClosure = Me.grdSaved.CurrentRow.Cells("IsSOSeparateClosure").Value
            '  dtpArrivalTime.Value = CType(grdSaved.CurrentRow.Cells("Arrival_Time").Value, Date)
            ' dtpDepartureTime.Value = CType(grdSaved.CurrentRow.Cells("Departure_Time").Value, Date)

            ''TASK TFS4391
            Dim RevisionNumber As Integer = Me.CheckRevisionNumber(grdSaved.CurrentRow.Cells("SalesId").Value)
            If RevisionNumber > 0 Then
                IsRevisionRestrictedFirstTime = True
                Me.FillRevisionCombo(grdSaved.CurrentRow.Cells("SalesId").Value)
                Me.cmbRevisionNumber.Visible = False
                Me.lblRev.Visible = False
                Me.txtPONo.Size = New System.Drawing.Size(95, 21)
                Me.lnkLblRevisions.Visible = True
                Me.lnkLblRevisions.Text = "Rev (" & RevisionNumber & ")"
            Else
                Me.cmbRevisionNumber.Visible = False
                Me.lblRev.Visible = False
                Me.lnkLblRevisions.Visible = False
                Me.txtPONo.Size = New System.Drawing.Size(177, 21)
            End If
            ''END TASK TFS4391







            If IsDBNull(Me.grdSaved.GetRow.Cells("Arrival_Time").Value) Then
                Me.dtpArrivalTime1.Value = Date.Now
            Else
                Me.dtpArrivalTime1.Value = Me.grdSaved.GetRow.Cells("Arrival_Time").Value
            End If

            If IsDBNull(Me.grdSaved.GetRow.Cells("Departure_Time").Value) Then
                Me.dtpDepartureTime1.Value = Date.Now
                Me.dtpDepartureTime1.Checked = False
            Else
                Me.dtpDepartureTime1.Value = Me.grdSaved.GetRow.Cells("Departure_Time").Value
                Me.dtpDepartureTime1.Checked = True
            End If
            If Me.DeliveryChalanId > 0 Then
                Me.cmbDeliveryChalan.SelectedValue = Me.DeliveryChalanId
                If Me.cmbDeliveryChalan.SelectedValue Is Nothing Then
                    Dim dtdc As DataTable = CType(Me.cmbDeliveryChalan.DataSource, DataTable)
                    dtdc.AcceptChanges()
                    Dim dr As DataRow = dtdc.NewRow
                    dr(0) = Me.DeliveryChalanId
                    dr(1) = Me.grdSaved.GetRow.Cells("DeliveryNo").Value.ToString
                    dtdc.Rows.Add(dr)
                    dtdc.AcceptChanges()
                End If
            End If
            Me.cmbDeliveryChalan.SelectedValue = Me.DeliveryChalanId
            Me.txtDcNo.Text = Me.grdSaved.CurrentRow.Cells("DcNo").Value.ToString
            Me.txtDueDays.Text = Val(Me.grdSaved.GetRow.Cells("DueDays").Value.ToString) 'Task:2770 Get Due Days Value.
            'Me.txtChalanNo.Text = Me.grdSaved.GetRow.Cells("DeliveryNo").Value.ToString
            If Me.grdSaved.GetRow.Cells("Adj_Flag").Value = False Then
                Me.rbtAdjFlat.Checked = True
                Try
                    Me.txtAdjustment.Text = Val(Me.grdSaved.CurrentRow.Cells("Adjustment").Value.ToString())
                Catch ex As Exception

                End Try
            Else
                Me.rbtAdjPercentage.Checked = True
                Try
                    Me.txtAdjustment.Text = Val(Me.grdSaved.CurrentRow.Cells("Adj_Percentage").Value.ToString())
                Catch ex As Exception

                End Try
            End If
            
            If IsSalesOrderAnalysis = True Then
                Me.rbtAdjPercentage.Enabled = False
            Else
                Me.rbtAdjPercentage.Enabled = True
            End If
            Call DisplayDetail(grdSaved.CurrentRow.Cells("SalesId").Value)
            GetTotal()
            If Val(grdSaved.CurrentRow.Cells("JobCardId").Value.ToString) > 0 Then
                GetJobCard(Val(grdSaved.CurrentRow.Cells("JobCardId").Value.ToString))
                Me.gbJobCard.Visible = True
            Else
                Me.gbJobCard.Visible = False
            End If
            Me.ExistingBalance = Val(Me.txtAmount.Text)
            'Me.BtnSave.Text = "&Update"
            'Me.LinkLabel1.Enabled = False
            Me.cmbPo.Enabled = False
            If Me.cmbPo.SelectedValue > 0 Then
                Me.cmbVendor.Enabled = False
            Else
                Me.cmbVendor.Enabled = True
            End If
            'Customer Edit List flag here... 
            If Me.cmbPo.SelectedIndex = 0 Then
                If EditCustomerListOnSale = "False" Then
                    Me.cmbVendor.Enabled = True
                Else
                    Me.cmbVendor.Enabled = False
                End If
            End If

            If flgMultipleSalesOrder = False Then
                If getConfigValueByType("AllowChangeSO").ToString.ToUpper = "TRUE" Then
                    Me.cmbPo.Enabled = True
                Else
                    Me.cmbPo.Enabled = False
                End If
            End If

            Me.chkDelivered.Checked = Me.grdSaved.GetRow.Cells("Delivered").Value
            Me.cmbInvType.Text = Me.grdSaved.GetRow.Cells("Inv Type").Value.ToString
            'txtTransitInsurancePercentage_TextChanged(Nothing, Nothing)
            If Val(Me.txtAddTransitInsurance.Text) <> 0 Then
                Me.txtTransitInsurancePercentage.Text = ((Val(Me.txtAddTransitInsurance.Text) / (Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)))) * 100)
            End If
            Dim strInv As String = "Select Count(*) From InvoiceAdjustmentTable WHERE InvoiceId=" & grdSaved.CurrentRow.Cells("SalesId").Value & " And InvoiceType='Sales'"
            Dim dtInv As New DataTable
            dtInv = GetDataTable(strInv)
            dtInv.AcceptChanges()
            If dtInv IsNot Nothing Then
                If dtInv.Rows.Count > 0 Then
                    If Val(dtInv.Rows(0).Item(0).ToString) > 0 Then
                        Me.cmbVendor.Enabled = False
                    End If
                End If
            End If
            'Task#07072015 Edit field, if value less then zero then set Value 'Not Sent'
            If IsDBNull(Me.grdSaved.CurrentRow.Cells("SalesTaxInvoiceStatus_ID").Value) Then
                Me.cmbInvoiceStatus.Rows(0).Activate()
            Else
                Me.cmbInvoiceStatus.Value = Me.grdSaved.CurrentRow.Cells("SalesTaxInvoiceStatus_ID").Value
            End If
            'End Task#07072015
            'Me.GetSecurityRights()
            Me.chkPost.Checked = grdSaved.CurrentRow.Cells("Post").Value
            If blnUpdateAll = False Then Me.UltraTabControl2.SelectedTab = Me.UltraTabControl2.Tabs(0).TabPage.Tab : Me.tbSalesDetail.SelectedTab = Me.tbSalesDetail.Tabs(0).TabPage.Tab
            Me.CtrlGrdBar3_Load(Nothing, Nothing)
            VoucherDetail(Me.txtPONo.Text)
            Previouse_Amount = Val(Me.txtAmount.Text)
            Me.lblPrintStatus.Text = "Print Status: " & Me.grdSaved.GetRow.Cells("Print Status").Text.ToString
            Me.cmbProject.SelectedValue = grdSaved.CurrentRow.Cells("CostCenterId").Value
            If flgDateLock = True Then
                If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00"))) Then
                    'ShowErrorMessage("Previous date work not allowed") : Exit Sub
                    Me.dtpPODate.Enabled = False
                Else
                    Me.dtpPODate.Enabled = True
                End If
            Else
                Me.dtpPODate.Enabled = True
            End If
            Dim intCountAttachedFiles As Integer = 0I
            'Altered Against Task# 2015060001 Ali Ansari
            'Get no of attached files
            If Me.BtnSave.Text <> "&Save" Then
                If Me.grdSaved.RowCount > 0 Then
                    intCountAttachedFiles = Val(grdSaved.CurrentRow.Cells("No Of Attachment").Value)
                    Me.btnAttachment.Text = "Attachment (" & intCountAttachedFiles & ")"
                End If
            End If
            '//getpaymentstatus is called to check if invoice is paid then disable the update button on edit on sales
            '//Start TASK # 943
            '03-July-2017: Waqar Raza: If user dont have update rights then btnsave should not be enable true
            If BtnSave.Enabled = True Then
                Dim getid As Boolean = getpaymentstatus(Me.grdSaved.GetRow.Cells("JobCardId").Value)
                If getid = True Then
                    Me.BtnSave.Enabled = False
                Else
                    Me.BtnSave.Enabled = True
                End If
            End If
            'End Task # 943
            '//Start TASK # 1592
            '24-OCT-2017: Ayesha Rehman: If user dont have update rights then btnsave should not be enable true
            If BtnSave.Enabled = True Then
                If grdSaved.CurrentRow.Cells(1).Value > Date.Today.ToString("yyyy-MM-dd 23:59:59") AndAlso IsDateChangeAllowed = False Then
                    Me.BtnSave.Enabled = False
                    ErrorProvider2.SetError(Me.Label2, "Future Date can not be edit")
                    ErrorProvider2.BlinkRate = 1000
                    ErrorProvider2.BlinkStyle = ErrorBlinkStyle.AlwaysBlink


                    'If Me.dtpPODate.Focus Then
                    '    ShowInformationMessage("Future Date can not be edit")
                    'End If
                Else
                    Me.BtnSave.Enabled = True
                    ErrorProvider2.Clear()
                End If
            End If

            'End Task # 1592
            'Altered Against Task# 2015060001 Ali Ansari
            If Not Mode = "Normal" Then Me.txtBarcodescan.Focus()
            Me.BtnDelete.Visible = True
            Me.BtnPrint.Visible = True
            'Edit Against Task# 2015072401  Allow Multiple printing for invoice Ali Ansari
            GrpPrint.Visible = True
            BtnPrintNew.Visible = True
            ChkInvoice.Checked = True
            ChkBill.Checked = False
            ChkUnderTaking.Checked = False
            '12-July-2017: Task # TFS1042: Waqar Raza: Added by Waqar to load item by apply model filter on update mode.
            'Start TFS1042:
            FillCombo("Item")
            'End TFS1042:
            AddHandler Me.cmbCompany.SelectedIndexChanged, AddressOf Me.cmbCompany_SelectedIndexChanged
            AddHandler Me.cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
            AddHandler Me.cmbDeliveryChalan.SelectedIndexChanged, AddressOf Me.cmbDeliveryChalan_SelectedIndexChanged
            'Edit Against Task# 2015072401  Allow Multiple printing for invoice Ali Ansari
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub DisplayPODetail(ByVal ReceivingID As Integer)
        Dim str As String
        'Dim i As Integer


        'str = "SELECT tblDefLocation.Location_code AS Category, Article.ArticleDescription AS item, Recv_D.ArticleSize AS unit, Recv_D.Sz1 - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price, " _
        '      & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '      & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as PackQty ,Recv_D.Price as CurrentPrice,'xxxx' as BatchNo, Recv_D.LocationId  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '      & " ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '      & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id " _
        '      & " Where Recv_D.SalesOrderID =" & ReceivingID & " AND Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0 "
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item,  Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price, " _
        '      & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '      & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as PackQty ,Recv_D.Price as CurrentPrice, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as SampleQty, ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id,  '' as [Batch No], (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '      & " ArticleDefTable Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '      & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '      & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0 ", "")

        '' Changing against R916
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '     & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '     & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId, 0 as BatchId, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float, 0) as SED, 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id,  '' as [Batch No], (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as SalesAccountId  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '     & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '     & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '     & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")


        ''R916 Added Column Comments
        'Before against task:2374
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '      & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '      & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId, 0 as BatchId, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float, 0) as SED, 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id,  '' as [Batch No], (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as SalesAccountId  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '      & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '      & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '      & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")
        'Task:2374 Added Column Total Amount, Tax Amount
        'Before against task:M16
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '     & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '     & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId, 0 as BatchId, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id,  '' as [Batch No], (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, Recv_D.Comments, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as SalesAccountId  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '     & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '     & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '     & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")
        'End Task:2374
        '
        'Before against task:2435
        'Task:M16 Added Column Engine_No, Chassis_No
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '     & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '     & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId, 0 as BatchId, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id,  '' as [Batch No], (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as SalesAccountId  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '     & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '     & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '     & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")
        'End Task:M16
        'Before against task:2457
        'Task:2435 Added Column CostPrice
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '   & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '   & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId, 0 as BatchId, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id,  '' as [Batch No], (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as SalesAccountId, 0 as CostPrice  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '   & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '   & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '   & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")
        'End Task:2435
        ''Task:2457 Added Column CertificateNo
        'Before against task:2488
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '  & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '  & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId, 0 as BatchId, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id,  '' as [Batch No], (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as SalesAccountId, 0 as CostPrice, '' as CertificateNo  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '  & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '  & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '  & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")
        'End Task:2457
        'Task:2488 Remove Column SaleCertificateNo
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '  & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '  & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId,  ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id, (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId,'' as [Batch No], Convert(DateTime,Null) as ExpiryDate, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as SalesAccountId, 0 as CostPrice  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '  & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '  & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '  & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")
        'End Task:2488


        '  str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '& " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '& " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId,  ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id, (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId,'' as [Batch No], Convert(DateTime,Null) as ExpiryDate, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,0 as CostPrice  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '& " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '& " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '& " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")
        '     str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '& " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '& " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId,  ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id, (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId,'' as [Batch No], Convert(DateTime,Null) as ExpiryDate, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '& " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '& " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
        '& " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")


        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '    & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '    & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId,  ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, 0 as So_Id, (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId,'' as [Batch No], Convert(DateTime,Null) as ExpiryDate, Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '    & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '    & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId   " _
        '    & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")

        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '   & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '   & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId,  ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, IsNull(Recv_D.SalesOrderID,0) as So_Id, (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId,'' as [Batch No], Convert(DateTime,Null) as ExpiryDate, Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '   & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '   & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId   " _
        '   & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")


        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate, " _
        '   & " CASE WHEN recv_d.articlesize = 'Loose' THEN Recv_D.Sz1 * Recv_D.Price - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price  ELSE Recv_D.Sz1 * Recv_D.Price * Article.PackQty - isnull(Recv_D.DeliveredQty,0)  * Recv_D.Price END AS Total, " _
        '   & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, Recv_D.SalesOrderDetailId,  ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float, 0) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, IsNull(Recv_D.SalesOrderID,0) as So_Id, (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId,'' as [Batch No], Convert(DateTime,Null) as ExpiryDate, Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty, 0 as DeliveryChalanId, 0 as DeliveryChalanDetailId  FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '   & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '   & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId   " _
        '   & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")

        ''Below line is commented against TASK: TFS1357
        'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, Recv_D.Price as Rate,  IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount] , " _
        '   & " ((IsNull(Recv_D.Qty, 0) * Recv_D.Price *  Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End) - isnull(Recv_D.DeliveredTotalQty,0) * Recv_D.Price *  Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
        '   & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, 0 As SaleDetailId,  ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], Convert(float, IsNull(Recv_D.SED_Tax_Percent,0)) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, 0 As FlatDiscount, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, IsNull(Recv_D.SalesOrderID,0) as So_Id, (Isnull(Recv_D.Qty,0) - Isnull(DeliveredTotalQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId,'' as [Batch No], Convert(DateTime,Null) as ExpiryDate, Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,IsNull(Recv_D.CostPrice,0) as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty, 0 as DeliveryChalanId, 0 as DeliveryChalanDetailId,0 as Transport_Charges, Convert(bit,1) as ApplyAdjustmentFuelExp, 0 As Gross_Weights,  0 As Tray_Weights, 0 As Net_Weights, (IsNull(Recv_D.Qty,0) - IsNull(Recv_D.DeliveredTotalQty,0) ) as TotalQty, IsNull(Recv_D.SalesOrderDetailId, 0) As SODetailId, '' As ArticleLpoName FROM SalesOrderDetailTable Recv_D INNER JOIN " _
        '   & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
        '   & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId   " _
        '   & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")

        '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
        ''Task:TFS1154 Added Column RetailPrice
        ''Task:TFS1153 Added Column DiscountId, DiscountType , DiscountValue, Discountfactor,PostDiscountPrice
        ''Task:TFS2827 Updated Columns  DiscountId, DiscountType , DiscountValue, Discountfactor,PostDiscountPrice Against TFS2827
        str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Recv_D.AlternativeItem, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, Convert(Decimal(18, " & DecimalPointInQty & "), (ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0)), 1) AS Qty, " _
            & " Recv_D.PostDiscountPrice As PostDiscountPrice,  IsNull(Recv_D.DiscountId,1) as DiscountId, '' as [DiscountType],ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, 0 As FlatDiscount, IsNull(Recv_D.DiscountFactor , 0) As DiscountFactor,  IsNull(Recv_D.DiscountValue , 0) As DiscountValue,  " _
            & " Recv_D.Price as Rate,  IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount] , " _
            & " ((IsNull(Recv_D.Qty, 0) * Recv_D.Price *  Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End) - isnull(Recv_D.DeliveredTotalQty,0) * Recv_D.Price *  Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
            & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.CurrentPrice as CurrentPrice, 0 as PackPrice, 0 As SaleDetailId, 0 as RetailPrice, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], Convert(float, IsNull(Recv_D.SED_Tax_Percent,0)) as SED,Convert(float,0) as [Total Amount], 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, IsNull(Recv_D.SalesOrderID,0) as So_Id, Convert(Decimal(18, " & DecimalPointInQty & "), (Isnull(Recv_D.Qty,0) - Isnull(DeliveredTotalQty , 0)), 1)  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId, ISNULL(Recv_D.BatchNo, '') as [Batch No],  Recv_D.ExpiryDate, ISNULL(Recv_D.Origin, '') as Origin, 0 AS [Bardana Deduction], 0 AS [Other Deduction], Convert(float,0) AS [After Deduction Qty], Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,IsNull(Recv_D.CostPrice,0) as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty, 0 as DeliveryChalanId, 0 as DeliveryChalanDetailId,0 as Transport_Charges, IsNull(Article.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp, 0 As Gross_Weights,  0 As Tray_Weights, 0 As Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), (IsNull(Recv_D.Qty,0) - IsNull(Recv_D.DeliveredTotalQty,0)), 1) as TotalQty, IsNull(Recv_D.SalesOrderDetailId, 0) As SODetailId, '' As ArticleLpoName, 0 As OldSalePrice, 0 As SalePriceProcessId ,Convert(bit,0) as [LogicalItem], Recv_D.AlternativeItemId FROM SalesOrderDetailTable Recv_D INNER JOIN " _
            & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
            & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId   " _
            & " Where Recv_D.SalesOrderID =" & ReceivingID & " " & " " & IIf(flgLoadAllItems = False, " AND (isnull(SchemeQty,0) > 0 Or (Isnull(Recv_D.Sz1,0) - Isnull(DeliveredQty,0) > 0))", "")

        Dim objCommand As New OleDbCommand
        Dim objCon As OleDbConnection
        Dim objDataAdapter As New OleDbDataAdapter
        Dim objDataSet As New DataSet

        objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

        If objCon.State = ConnectionState.Open Then objCon.Close()

        objCon.Open()
        objCommand.Connection = objCon
        objCommand.CommandType = CommandType.Text


        objCommand.CommandText = str

        objDataAdapter.SelectCommand = objCommand
        objDataAdapter.Fill(objDataSet)
        Dim IsMinus As Boolean = True
        'If CType(Me.cmbItem.SelectedRow, Infragistics.Win.UltraWinGrid.UltraGridRow).Cells("ServiceItem").Value = False Then
        IsMinus = getConfigValueByType("AllowMinusStock")
        'End If
        'If IsMinus = True Then
        
            If objDataSet.Tables(0).Rows.Count > 0 Then
            For Each dr As DataRow In objDataSet.Tables(0).Rows
                Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & dr.Item("ArticleDefId") & ""
                Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem)
                dt2serviceitem.AcceptChanges()
                Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem1 = False Then
                    AvailableStock = Convert.ToDouble(GetStockById(dr.Item("ArticleDefId"), dr.Item("LocationId"), IIf(dr.Item("unit").ToString = "Loose", "Loose", "Pack")))
                    If IsMinus = True Then
                        If CheckLocationWiseMinusStock(dr.Item("LocationId")) = False Then
                            dr.BeginEdit()
                            If AvailableStock <= 0 Then
                                ShowErrorMessage("Stock is not available for this Location of Item " & dr.Item("Item").ToString & " ")
                                dr.Delete()
                            Else
                                If dr.Item("unit").ToString = "Loose" Then
                                    If Val(dr.Item("TotalQty")) > AvailableStock Then
                                        If msg_Confirm("Stock is not enough  against item " & dr.Item("Item").ToString & " . Do you want to load available Qty in stock as partial Qty?") = False Then
                                            Exit Sub
                                        Else
                                            StockChecked = True
                                            dr.Item("TotalQty") = AvailableStock
                                            dr.Item("Qty") = AvailableStock
                                        End If
                                    End If
                                Else
                                    If Val(dr.Item("Qty")) > AvailableStock Then
                                        If msg_Confirm("Stock is not enough. Do you want to load available Qty in stock as partial Qty?") = False Then
                                            Exit Sub
                                        Else
                                            StockChecked = True
                                            dr.Item("Qty") = AvailableStock
                                        End If
                                    End If
                                    If Val(dr.Item("CurrencyRateId") > 1 AndAlso dr.Item("CurrencyRateId") <> 1) Then

                                    End If

                                End If

                                dr.EndEdit()
                                AvailableStock = 0
                            End If
                        End If
                    Else
                        ''TASK TFS4228
                        dr.BeginEdit()
                        If AvailableStock <= 0 Then
                            ShowErrorMessage("Stock is not available for this Location of Item " & dr.Item("Item").ToString & " ")
                            dr.Delete()
                        Else
                            If dr.Item("unit").ToString = "Loose" Then
                                If Val(dr.Item("TotalQty")) > AvailableStock Then
                                    If msg_Confirm("Stock is not enough  against item " & dr.Item("Item").ToString & " . Do you want to load available Qty in stock as partial Qty?") = False Then
                                        Exit Sub
                                    Else
                                        StockChecked = True
                                        dr.Item("TotalQty") = AvailableStock
                                        dr.Item("Qty") = AvailableStock
                                    End If
                                End If
                            Else
                                If Val(dr.Item("Qty")) > AvailableStock Then
                                    If msg_Confirm("Stock is not enough. Do you want to load available Qty in stock as partial Qty?") = False Then
                                        Exit Sub
                                    Else
                                        StockChecked = True
                                        dr.Item("Qty") = AvailableStock
                                    End If
                                End If

                            End If

                            dr.EndEdit()
                            AvailableStock = 0
                        End If
                        ''END TASK TFS4228 
                    End If
                End If
            Next
            End If
        objDataSet.AcceptChanges()
        ''End 19-10-2016 Ameen


        If flgMultipleSalesOrder = False Then
            Me.DisplayDetail(-1)
        End If



        'objDataSet.Tables(0).Columns.Add(EnumGridDetail.NetBill.ToString, GetType(System.Double))
        'If Not IsSalesOrderAnalysis = True Then
        '    objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(CurrentPrice=0,0,IIF(Unit='Loose',(((((((Qty) * CurrentPrice) * Tax)/100) + (Freight * (Qty+[Sample Qty]))) - (((Qty * CurrentPrice) * Discount_Percentage)/100)) + (Qty  * CurrentPrice)),   ((((((((Qty  * [Pack Qty])) * CurrentPrice) * Tax)/100) + (Freight * ((Qty  * [Pack Qty])))) - ((((Qty * [Pack Qty]) * CurrentPrice) * Discount_Percentage)/100)) + ((Qty * [Pack Qty]) * CurrentPrice))))"
        '    objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "iif(Unit = 'Loose' , (isnull(Qty,0) * isnull(Rate,0)) , ((isnull(Qty,0) * isnull(Rate,0)) * isnull([Pack Qty],0)))"
        '    'ElseIf ServicesItem = "True" Then
        '    '    objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "iif(Unit = 'Loose' , (ServiceQty * Rate) , ((ServiceQty * [Pack Qty])*Rate))"
        'Else
        '    objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(CurrentPrice=0,0,IIF(Unit='Loose',(((((((Qty + [Sample Qty]) * CurrentPrice) * Tax)/100) + (Freight * (Qty+[Sample Qty]))) - (((Qty * CurrentPrice) * Discount_Percentage)/100)) + (Qty  * CurrentPrice)),   ((((((((Qty  * [Pack Qty]) + [Sample Qty]) * CurrentPrice) * Tax)/100) + (Freight * ((Qty  * [Pack Qty]) + [Sample Qty]))) - ((((Qty * [Pack Qty]) * CurrentPrice) * Discount_Percentage)/100)) + ((Qty * [Pack Qty]) * CurrentPrice))))"
        '    objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "iif(Unit = 'Loose' , isnull(Qty,0) * isnull(Rate,0) , isnull(Qty,0) * isnull(Rate,0) * isnull([Pack Qty],0)) "
        'End If
        ''Task:2374 Set Expression Total Amount, Tax Amount
        'If flgExcludeTaxPrice = False Then
        '    objDataSet.Tables(0).Columns("Tax Amount").Expression = "((Tax/100)*Total)"
        '    objDataSet.Tables(0).Columns("Total Amount").Expression = "(Total+[Tax Amount])" 'Task:2374 Set Expression Total Amount 
        'Else
        '    objDataSet.Tables(0).Columns("Tax Amount").Expression = "(Total/(Tax+100))*Tax"
        '    objDataSet.Tables(0).Columns("Total Amount").Expression = "(Total-[Tax Amount])" 'Task:2374 Set Expression Total Amount 
        'End If
        'End Task:2374

        If Not IsSalesOrderAnalysis = True Then
            'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,(((((((IsNull(TotalQty,0)) * IsNull(rate,0)) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)))) - (((IsNull(TotalQty,0) * IsNull(rate,0)) * IsNull(Discount_Percentage,0))/100)) + (IsNull(TotalQty,0)  * IsNull(rate,0))))"
            ''TFS1153
            objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountId= 1,((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountId= 1, IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))) * IsNull(rate,0) * CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(rate,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(rate,0) * CurrencyRate )))"
            objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)*CurrencyRate)"
            objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"
            'ElseIf ServicesItem = "True" Then
            '    objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "iif(Unit = 'Loose' , (ServiceQty * Rate) , ((ServiceQty * [Pack Qty])*Rate))"
        Else
            'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(CurrentPrice,0)=0,0,(((((((IsNull(TotalQty,0) + IsNull([Sample Qty],0)) * IsNull(CurrentPrice,0)) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)+IsNull([Sample Qty],0)))) - (((IsNull(TotalQty,0) * IsNull(CurrentPrice,0)) * IsNull(Discount_Percentage,0))/100)) + (IsNull(TotalQty,0)  * IsNull(CurrentPrice,0))))"
            ''TFS1153
            objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountId= 1,((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountId= 1, IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) + IsNull([Sample Qty],0)) * IsNull(rate,0) * CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))+IsNull([Sample Qty],0)))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(rate,0)* CurrencyRate) * IsNull(Discount_Percentage,0))/100)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(rate,0)* CurrencyRate)))"
            objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)) * CurrencyRate "
            objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"
        End If
        'objDataSet.Tables(0).Columns(EnumGridDetail.Total).ReadOnly = False
        If flgExcludeTaxPrice = False Then
            objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(CurrencyAmount,0))"
            objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)+IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))" 'Task:2374 Set Expression Total Amount 
            objDataSet.Tables(0).Columns("Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(Total,0))"
            objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)+IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))" 'Task:2374 Set Expression Total Amount 
        Else
            objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "(IsNull(CurrencyAmount,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
            objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)-IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))"
            objDataSet.Tables(0).Columns("Tax Amount").Expression = "(IsNull(Total,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
            objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)-IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))" 'Task:2374 Set Expression Total Amount 
        End If

        If Me.BtnSave.Text = "&Save" Then
            objDataSet.Tables(0).Columns(EnumGridDetail.LoadQty).Expression = "IsNull(TotalQty,0)"
        End If


        Me.grd.DataSource = objDataSet.Tables(0)

        If objDataSet.Tables(0).Rows.Count > 0 Then
            If IsDBNull(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId")) Or Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString) = Val(0) Then
                'Me.cmbCurrency.SelectedValue = Nothing
                Me.cmbCurrency.Enabled = False

            Else
                ''rafay waqar bhai ko error aya tha jab merge kia tha me ne apnay code k sath
                Me.CurrencyRate = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString)
                Me.cmbCurrency.SelectedValue = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString)
                Me.cmbCurrency.Enabled = False
            End If
            cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
            ''CurrencyRate = 1
        End If
        Me.grd.RetrieveStructure()
        'If objDataSet.Tables(0).Rows.Count > 0 Then
        '    If IsDBNull(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId")) Or Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
        '        'Me.cmbCurrency.SelectedValue = Nothing
        '        Me.cmbCurrency.Enabled = False

        '    Else
        '        Me.cmbCurrency.SelectedValue = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString)
        '        Me.txtCurrencyRate.Text = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString)
        '        Me.cmbCurrency.Enabled = False
        '    End If
        '    cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
        'End If
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Caption = "Challan"
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).HasValueList = True

        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).EditType = Janus.Windows.GridEX.EditType.Combo

        Me.grd.RootTable.Columns(EnumGridDetail.SO_ID).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.SO_ID).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.SO_ID).EditType = Janus.Windows.GridEX.EditType.Combo
        'Ali Faisal : TFS1362 : 22-Aug-2017 : Change column from text to drop down
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).EditType = Janus.Windows.GridEX.EditType.Combo

        'Ayesha Rehman: TFS1153 : 23-Nov-2017 : Change column from text to drop down
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).EditType = Janus.Windows.GridEX.EditType.Combo

        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).EditType = Janus.Windows.GridEX.EditType.Combo


        Me.grd.RootTable.Columns("Batch No").HasValueList = True
        Me.grd.RootTable.Columns("Batch No").LimitToList = False
        Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.Combo

        Me.grd.RootTable.Columns("Origin").HasValueList = True
        Me.grd.RootTable.Columns("Origin").LimitToList = False
        Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.Combo
        'Ali Faisal : TFS1362 : 22-Aug-2017 : End
        FillOutwardExpense(ReceivingID, "SO")
        FillCombo("grdLocation")
        FillCombo("grdSO")
        FillCombo("grdDeliveryChalan")
        'Ali Faisal : TFS1362 : 22-Aug-2017 : Fill combo boxes
        FillCombo("grdEngine")
        FillCombo("grdChassis")
        FillCombo("grdBatch")
        FillCombo("GrdOrigin")
        'Ali Faisal : TFS1362 : 22-Aug-2017 : End
        'Ayesha Rehman: TFS1153 : 23-NOV-2017 : Fill combo boxes
        FillCombo("grdDiscountType")
        'Ayesha Rehman : TFS1153 : 23-NOV-2017 : End

        ApplyGridSettings()

        GetTotal()
        GetSalesOrderAnalysis()
        Me.grd.RootTable.Columns(EnumGridDetail.Color).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.SED).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.Size).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanDetailId).Visible = False
        Me.grd.RootTable.Columns("SalesAccountId").Visible = False
        Me.grd.RootTable.Columns("InvAccountId").Visible = False
        Me.grd.RootTable.Columns("CGSAccountId").Visible = False
        Me.grd.RootTable.Columns("CR_SalesDetailId").Visible = False
        Me.grd.RootTable.Columns("SaleCertificateId").Visible = False
        Me.grd.RootTable.Columns("SalesReturnQty").Visible = False
        'Me.grd.RootTable.Columns(EnumGridDetail.ServiceQty).Visible = False
        Me.txtQty.Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.Stock).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.FlatDiscount).Visible = False
        'For i = 0 To objDataSet.Tables(0).Rows.Count - 1

        '    ''selecting the category
        '    'Me.cmbCategory.SelectedValue = objDataSet.Tables(0).Rows(i)("ArticleGroupId")
        '    'Me.cmbCategory_SelectedIndexChanged(Nothing, Nothing)
        '    ''selecting the item
        '    Me.cmbItem.Value = objDataSet.Tables(0).Rows(i)("ArticleDefId")
        '    Me.cmbItem_Leave(Nothing, Nothing)

        '    ''selecting batch no
        '    Me.cmbBatchNo.Text = objDataSet.Tables(0).Rows(i)("Batch No")
        '    Me.cmbBatchNo_Leave(Nothing, Nothing)

        '    ''selecting unit
        '    Me.cmbUnit.Text = objDataSet.Tables(0).Rows(i)("Unit")
        '    Me.cmbUnit_SelectedIndexChanged(Nothing, Nothing)

        '    ''selecting qty
        '    Me.txtQty.Text = objDataSet.Tables(0).Rows(i)("Qty")

        '    Me.txtQty_LostFocus(Nothing, Nothing)
        '    'Me.txtQty_TextChanged(Nothing, Nothing)
        '    ''selecing rate
        '    Me.txtRate.Text = objDataSet.Tables(0).Rows(i)("Price")
        '    If Me.cmbUnit.Text = "Pack" Then
        '        txtPackQty.Text = Val(objDataSet.Tables(0).Rows(i)("PackQty"))
        '        Me.txtTotal.Text = Val(Me.txtRate.Text) * (Val(objDataSet.Tables(0).Rows(i)("PackQty")) * Val(Me.txtQty.Text))
        '    Else
        '        Me.txtTotal.Text = Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
        '        txtPackQty.Text = "1"
        '    End If

        '    TradePrice = objDataSet.Tables(0).Rows(i)("TradePrice")
        '    SalesTax_Percentage = objDataSet.Tables(0).Rows(i)("Tax")
        '    SchemeQty = objDataSet.Tables(0).Rows(i)("SampleQty")
        '    Discount_Percentage = objDataSet.Tables(0).Rows(i)("Discount_Percentage")
        '    Freight = objDataSet.Tables(0).Rows(i)("Freight")
        '    MarketReturns = objDataSet.Tables(0).Rows(i)("MarketReturns")
        '    Me.txtDisc.Text = Val(Discount_Percentage)
        '    LoadQty = objDataSet.Tables(0).Rows(i)("LoadQty")
        '    Me.btnAdd_Click(Nothing, Nothing)

        '    TradePrice = 0
        '    SalesTax_Percentage = 0
        '    SchemeQty = 0
        '    Discount_Percentage = 0
        '    Freight = 0
        '    MarketReturns = 0
        '    '  grd.Rows.Add(objDataSet.Tables(0).Rows(i)(0), objDataSet.Tables(0).Rows(i)(1), objDataSet.Tables(0).Rows(i)("BatchNo"), objDataSet.Tables(0).Rows(i)(2), objDataSet.Tables(0).Rows(i)(3), objDataSet.Tables(0).Rows(i)(4), objDataSet.Tables(0).Rows(i)(5), objDataSet.Tables(0).Rows(i)(6), objDataSet.Tables(0).Rows(i)(7), objDataSet.Tables(0).Rows(i)(8), objDataSet.Tables(0).Rows(i)(9), objDataSet.Tables(0).Rows(i)(3))

        '    'grd.Rows(i).Cells(0).Value = objDataSet.Tables(0).Rows(i)(0)
        '    'grd.Rows(i).Cells(1).Value = objDataSet.Tables(0).Rows(i)(1)

        'Next

        'If GetConfigValue("ServiceItem").ToString = "True" Then
        '    Me.grd.RootTable.Columns(EnumGridDetail.Color).Visible = False
        '    Me.grd.RootTable.Columns(EnumGridDetail.Size).Visible = False
        'Else
        '    Me.grd.RootTable.Columns(EnumGridDetail.Color).Visible = True
        '    Me.grd.RootTable.Columns(EnumGridDetail.Size).Visible = True
        'End If


    End Sub
    Public Sub DisplayDetail(ByVal ReceivingID As Integer, Optional ByVal TypeId As Integer = -1, Optional ByVal Condition As String = "")
        Dim str As String = String.Empty
        Dim i As Integer = 0

        If Condition = "LoadAll" Then
            If getConfigValueByType("LoadAllItemsInSales").ToString = "True" Then

                'End Task:2457
                ''03-Aug-2014 Task:2767 Imran Ali Change Unit Option On Sales (ZR Traders)
                Dim LoadAllItemPackQty As String = getConfigValueByType("LoadAllItemPackQty").ToString
                'End Task:2767
                'Task:2488 Remove Column SaleCertificateNo


                '   str = "SELECT  Isnull(Detail.LocationId,0) as LocationId, ArticleDefView.ArticleCode as Code, ArticleDefView.ArticleDescription as Item, ArticleDefView.ArticleSizeName as Size, ArticleDefView.ArticleColorName as Color, " _
                '& " " & IIf(LoadAllItemPackQty = "False", "'Loose'", "'Pack'") & " as Unit, isnull(Detail.Qty,0) as Qty, ((IsNULL(ArticleDefView.SalePrice,0) - (IsNULL(ArticleDefView.SalePrice,0)*Isnull(CustomerDiscount.Discount,0))/100)) as Rate,  IsNull(Detail.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Detail.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Detail.CurrencyId, 0) As CurrencyId, Case When IsNull(Detail.CurrencyRate, 0)=0 Then 1 Else Detail.CurrencyRate End As CurrencyRate, IsNull(Detail.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount], Isnull(Detail.Total,0) as Total,  " _
                '& " ArticleDefView.ArticleGroupId,ArticleDefView.ArticleId as ArticleDefId, " & IIf(LoadAllItemPackQty = "False", " ISNULL(Detail.[Pack Qty],0) ", " ISNULL(dbo.ArticleDefView.PackQty,0)") & " as [Pack Qty], IsNULL(ArticleDefView.SalePrice,0) as CurrentPrice,  0 as PackPrice, ISNULL(Detail.SaleDetailId,0) as SaleDetailId,  ISNULL(Detail.TradePrice,0) as TradePrice, ISNULL(Detail.Tax,0) as Tax, Convert(float,0) [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Detail.SED,0) As SED, Convert(float,0) as [Total Amount], ISNULL(Detail.SavedQty,0) as SavedQty, ISNULL(Detail.[Sample Qty],0) as [Sample Qty], ISNULL(Detail.Discount_Percentage,0) as Discount_Percentage, IsNull(Detail.FlatDiscount, 0) As FlatDiscount, ISNULL(Detail.Freight,0) as Freight, ISNULL(Detail.MarketReturns,0) As MarketReturns, " _
                '& " ISNULL(Detail.SO_ID,0) as SO_ID,  isnull(Detail.LoadQty,0) as LoadQty, Isnull(Detail.PurchasePrice,0) as PurchasePrice, 0 as NetBill, ISNULL(Detail.BatchId, 0) as BatchId, ISNULL(Detail.[Batch No], '') as [Batch No], Detail.ExpiryDate, Detail.Comments, Detail.[Other Comments], Detail.Engine_No, Detail.Chassis_No, Detail.Pack_Desc, Isnull(ArticleDefView.SubSubId,0) as InvAccountId, ArticleDefView.SalesAccountId, ArticleDefView.CGSAccountId, Isnull(Detail.CostPrice,0) as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, 0.0 as Stock, 0.0 as SalesReturnQty, IsNull(Detail.DeliveryChalanId,0) as DeliveryChalanId, IsNull(Detail.DeliveryChalanDetailId,0) as DeliveryChalanDetailId, IsNull(Detail.Transport_Charges,0) as Transport_Charges, IsNull(Detail.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp, IsNull(Detail.Gross_Weights, 0) As Gross_Weights,IsNull(Detail.Tray_Weights, 0) As Tray_Weights, IsNull(Detail.Net_Weights, 0) As Net_Weights, Detail.TotalQty, Detail.SODetailId, ArticleLpoDefTable.ArticleLpoName From ArticleDefView  LEFT OUTER JOIN ( " _
                '& " SELECT recv_d.LocationId as LocationId, INNER JOIN ArticleLpoDefTable ON Article.ArticleLPOId = ArticleLpoDefTable.ArticleLpoId LEFT OUTER JOIN Recv_D.ArticleSize AS Unit, Recv_D.Sz1 AS Qty, Recv_D.Price as Rate,  " _
                '& " (Recv_D.Qty * Recv_D.Price * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End ) AS Total,  " _
                '& " Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], Isnull(Recv_D.CurrentPrice,0) as CurrentPrice, isnull(Recv_D.BatchNo,'') as [Batch No], Recv_D.SaleDetailId, Recv_D.BatchID, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax , Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, 0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0)  as Discount_Percentage, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(Recv_D.SO_ID,0) as SO_Id, BatchNo, ISNULL(Recv_D.LoadQty,0) as LoadQty, isnull(Recv_D.PurchasePrice,0) as PurchasePrice, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Recv_D.CostPrice,0) as CostPrice, Recv_D.ExpiryDate, Recv_D.Other_Comments as [Other Comments], IsNull(Recv_D.DeliveryChalanID,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryChalanDetailId,0) as DeliveryChalanDetailId, IsNull(recv_d.Transport_Charges,0) as Transport_Charges,IsNull(Recv_D.ApplyAdjustmentFuelExp ,1) as ApplyAdjustmentFuelExp, IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, IsNull(Recv_D.Qty, 0) As TotalQty, IsNull(Recv_D.SO_Detail_ID, 0) As SODetailId, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, IsNull(Recv_D.FlatDiscount, 0) As FlatDiscount FROM SalesDetailTable Recv_D   " _
                '& " Where(Recv_D.SalesID = " & ReceivingID & ") " _
                '& " ) Detail ON Detail.ArticleDefId = ArticleDefView.ArticleId " _
                '& " LEFT OUTER JOIN (SELECT ArticleDefId, Discount from tblDefCustomerBaseDiscounts WHERE TypeID=" & IIf(TypeId > 0, TypeId, -1) & ") " _
                '& " CustomerDiscount On CustomerDiscount.ArticleDefId = ArticleDefView.ArticleId " _
                '& " WHERE(ArticleDefView.SalesItem = 1 " & IIf(IsEditMode = False, " AND ArticleDefView.Active=1", "") & ") " _
                '& " ORDER BY ArticleDefView.SortOrder Asc"
                '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
                'Ali Faisal : TFS1634 : Altered to set the zero values of columns TotalQty and SodetailId if have null values
                'Ayesha Rehman : TFS1154 : Adding Coloumn RetailPrice
                ''Task:TFS1153 Added Column DiscountId, DiscountType , DiscountValue, DiscountFactor and PostDiscountPrice
                'Ali Faisal : TFS2003 : PDP Rate and Disc Type issues
                str = "SELECT  Isnull(Detail.LocationId,0) as LocationId, ArticleDefView.ArticleCode as Code, ArticleDefView.ArticleDescription as Item, Recv_D.AlternativeItem, ArticleDefView.ArticleSizeName as Size, ArticleDefView.ArticleColorName as Color, " _
                    & " " & IIf(LoadAllItemPackQty = "False", "'Loose'", "'Pack'") & " as Unit, Convert(Decimal(18, " & DecimalPointInQty & "), isnull(Detail.Qty,0), 1) as Qty, " _
                    & " CASE WHEN IsNull(Detail.PostDiscountPrice, 0) = 0 THEN IsNULL(ArticleDefView.SalePrice,0) ELSE IsNull(Detail.PostDiscountPrice, 0) END AS PostDiscountPrice,Isnull(Detail.DiscountId,1) as DiscountId,IsNull(Detail.DiscountType,'') AS DiscountType, ISNULL(Detail.Discount_Percentage,0) as Discount_Percentage, IsNull(Detail.FlatDiscount, 0) As FlatDiscount, CASE WHEN IsNull(Detail.DiscountFactor, 0) = 0 THEN Isnull(CustomerDiscount.Discount,0) ELSE IsNull(Detail.DiscountFactor, 0) END AS DiscountFactor, IsNull(Detail.DiscountValue, 0) As DiscountValue, " _
                    & " ((IsNULL(ArticleDefView.SalePrice,0) - (IsNULL(ArticleDefView.SalePrice,0)*Isnull(CustomerDiscount.Discount,0))/100)) as Rate,  IsNull(Detail.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Detail.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Detail.CurrencyId, 0) As CurrencyId, Case When IsNull(Detail.CurrencyRate, 0)=0 Then 1 Else Detail.CurrencyRate End As CurrencyRate, IsNull(Detail.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount], Isnull(Detail.Total,0) as Total,  " _
                    & " ArticleDefView.ArticleGroupId,ArticleDefView.ArticleId as ArticleDefId, " & IIf(LoadAllItemPackQty = "False", " ISNULL(Detail.[Pack Qty],0) ", " ISNULL(dbo.ArticleDefView.PackQty,0)") & " as [Pack Qty], IsNULL(ArticleDefView.SalePrice,0) as CurrentPrice,  0 as PackPrice, ISNULL(Detail.SaleDetailId,0) as SaleDetailId, ISNULL(Detail.RetailPrice,0) as RetailPrice,   ISNULL(Detail.TradePrice,0) as TradePrice, ISNULL(Detail.Tax,0) as Tax, Convert(float,0) [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Detail.SED,0) As SED, Convert(float,0) as [Total Amount], ISNULL(Detail.SavedQty,0) as SavedQty, ISNULL(Detail.[Sample Qty],0) as [Sample Qty],  ISNULL(Detail.Freight,0) as Freight, ISNULL(Detail.MarketReturns,0) As MarketReturns, " _
                    & " ISNULL(Detail.SO_ID,0) as SO_ID,  isnull(Detail.LoadQty,0) as LoadQty, Isnull(Detail.PurchasePrice,0) as PurchasePrice, 0 as NetBill, ISNULL(Detail.BatchId, 0) as BatchId, ISNULL(Detail.[Batch No], 'xxxx') as [Batch No], IsNull(Detail.ExpiryDate,DATEADD(Month , 1 , getDate())) As ExpiryDate,isnull(Detail.Origin,'') as Origin, IsNull(Detail.BardanaDeduction, 0) AS [Bardana Deduction], IsNull(Detail.OtherDeduction, 0) AS [Other Deduction], Convert(float,0) As [After Deduction Qty], Detail.Comments, Detail.[Other Comments], Detail.Engine_No, Detail.Chassis_No, Detail.Pack_Desc, Isnull(ArticleDefView.SubSubId,0) as InvAccountId, ArticleDefView.SalesAccountId, ArticleDefView.CGSAccountId, Isnull(Detail.CostPrice,0) as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, 0.0 as Stock, 0.0 as SalesReturnQty, IsNull(Detail.DeliveryChalanId,0) as DeliveryChalanId, IsNull(Detail.DeliveryChalanDetailId,0) as DeliveryChalanDetailId, IsNull(Detail.Transport_Charges,0) as Transport_Charges, IsNull(Detail.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp, IsNull(Detail.Gross_Weights, 0) As Gross_Weights,IsNull(Detail.Tray_Weights, 0) As Tray_Weights, IsNull(Detail.Net_Weights, 0) As Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), IsNull(Detail.TotalQty,0), 1) As TotalQty, IsNull(Detail.SODetailId,0) SODetailId, ArticleLpoDefTable.ArticleLpoName, Detail.OldSalePrice, Detail.SalePriceProcessId From ArticleDefView  LEFT OUTER JOIN ( " _
                    & " SELECT recv_d.LocationId as LocationId, Recv_D.ArticleSize AS Unit, Recv_D.Sz1 AS Qty, Recv_D.Price as Rate,  " _
                    & " (Recv_D.Qty * Recv_D.Price * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End ) AS Total,  " _
                    & " Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], Isnull(Recv_D.CurrentPrice,0) as CurrentPrice, isnull(Recv_D.BatchNo,'xxxx') as [Batch No],isnull(Recv_D.Origin,'') as Origin, Recv_D.SaleDetailId, Recv_D.BatchID, ISNULL(Recv_D.RetailPrice,0) as RetailPrice, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax , Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, 0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0)  as Discount_Percentage,ISNULL(Recv_D.DiscountId,0) as DiscountId, ISNULL(Recv_D.DiscountType, '') as [DiscountType], IsNull(Recv_D.DiscountFactor, 0) As DiscountFactor, IsNull(Recv_D.DiscountValue, 0) As DiscountValue, IsNull(Recv_D.PostDiscountPrice, 0) As PostDiscountPrice, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(Recv_D.SO_ID,0) as SO_Id,  ISNULL(Recv_D.LoadQty,0) as LoadQty, isnull(Recv_D.PurchasePrice,0) as PurchasePrice, Recv_D.Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Recv_D.CostPrice,0) as CostPrice, Recv_D.ExpiryDate, Recv_D.Other_Comments as [Other Comments], IsNull(Recv_D.DeliveryChalanID,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryChalanDetailId,0) as DeliveryChalanDetailId, IsNull(recv_d.Transport_Charges,0) as Transport_Charges,IsNull(Recv_D.ApplyAdjustmentFuelExp ,1) as ApplyAdjustmentFuelExp, IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, IsNull(Recv_D.Qty, 0) As TotalQty, IsNull(Recv_D.SO_Detail_ID, 0) As SODetailId, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, IsNull(Recv_D.FlatDiscount, 0) As FlatDiscount, IsNull(OldSalePrice, 0) As OldSalePrice, IsNull(SalePriceProcessId, 0) As SalePriceProcessId , IsNull(ArticleDefView.LogicalItem, 0)  AS LogicalItem, IsNull(Recv_D.BardanaDeduction, 0) AS BardanaDeduction, IsNull(Recv_D.OtherDeduction, 0) AS OtherDeduction, Recv_D.AlternativeItemId FROM SalesDetailTable Recv_D   " _
                    & " Where(Recv_D.SalesID = " & ReceivingID & ") " _
                    & " ) Detail ON Detail.ArticleDefId = ArticleDefView.ArticleId LEFT OUTER JOIN ArticleLpoDefTable ON ArticleDefView.ArticleLPOId = ArticleLpoDefTable.ArticleLpoId " _
                    & " LEFT OUTER JOIN (SELECT ArticleDefId, Discount from tblDefCustomerBaseDiscounts WHERE TypeID=" & IIf(TypeId > 0, TypeId, -1) & ") " _
                    & " CustomerDiscount On CustomerDiscount.ArticleDefId = ArticleDefView.ArticleId " _
                    & " WHERE(ArticleDefView.SalesItem = 1 " & IIf(IsEditMode = False, " AND ArticleDefView.Active=1", "") & ") " _
                    & " ORDER BY ArticleDefView.SortOrder Asc"
                'Ali Faisal : TFS2003 : End
                'Ali Faisal : TFS1634 : End
            End If
        ElseIf Condition = String.Empty Then


            'Before against task:2374 

            ''TFS1153 Added flat discount column
            '' Below lines are commented against TASK: TFS1357 on 22-08-2017
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, Recv_D.Sz1 AS Qty, Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount], " _
            '    & " (IsNull(Recv_D.Qty, 0) * IsNull(Recv_D.Price, 0) * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
            ' & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], ISNULL(Recv_D.CurrentPrice,0) as CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice,  Recv_D.SaleDetailId, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, Convert(float,0) as [Total Amount],0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, IsNull(Recv_D.FlatDiscount, 0) As FlatDiscount, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(So_ID,0) as So_Id,isnull(Recv_D.LoadQty,0) as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill,  Recv_D.BatchID,isnull(Recv_D.BatchNo,'') as [Batch No], Recv_D.ExpiryDate, Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId, Isnull(Recv_D.CostPrice,0) as CostPrice, IsNull(CR.SalesDetailId,0) as CR_SalesDetailId, IsNull(Cr.SaleCertificateId,0) as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock,IsNull(Recv_D.SalesReturnQty,0)  as SalesReturnQty, IsNull(Recv_D.DeliveryChalanId,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryChalanDetailId,0) as DeliveryChalanDetailId, IsNull(Recv_D.Transport_Charges,0) as Transport_Charges, IsNull(Recv_D.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp, IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, IsNull(Recv_D.Qty,0) as TotalQty, IsNull(Recv_D.SO_Detail_ID, 0) As SODetailId, ArticleLpoDefTable.ArticleLpoName " _
            ' & " FROM SalesDetailTable Recv_D INNER JOIN " _
            '    & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId inner JOIN " _
            '    & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId " _
            '    & " LEFT OUTER JOIN SalesCertificateTable CR On CR.SalesDetailId = Recv_D.SaleDetailId Left Outer Join ArticleLpoDefTable ON Article.ArticleLPOId = ArticleLpoDefTable.ArticleLpoId" _
            '    & " Where Recv_D.SalesID =" & ReceivingID & " ORDER BY Recv_D.SaleDetailId Asc"

            '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
            ''TFS1154 Added Retail Price column
            ''Task:TFS1153 Added Column DiscountType and DiscountValue
            ''TFS1957 :Added Reference column LogicalItem
            str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item,Recv_D.AlternativeItem, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, Convert(Decimal(18, " & DecimalPointInQty & "), Recv_D.Sz1, 1) AS Qty, " _
                & " IsNull(Recv_D.PostDiscountPrice, 0) As PostDiscountPrice, IsNull(Recv_D.DiscountId, 0) As DiscountId, Recv_D.DiscountType, ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, IsNull(Recv_D.FlatDiscount, 0) As FlatDiscount, IsNull(Recv_D.DiscountFactor, 0) As DiscountFactor, IsNull(Recv_D.DiscountValue, 0) As DiscountValue,  " _
                & " Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount], " _
                & " (IsNull(Recv_D.Qty, 0) * IsNull(Recv_D.Price, 0) * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
                & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], ISNULL(Recv_D.CurrentPrice,0) as CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice,  Recv_D.SaleDetailId, ISNULL(Recv_D.RetailPrice,0) as RetailPrice, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, Convert(float,0) as [Total Amount],0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(So_ID,0) as So_Id, Convert(Decimal(18, " & DecimalPointInQty & "), isnull(Recv_D.LoadQty,0), 1) as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill,  Recv_D.BatchID,isnull(Recv_D.BatchNo,'xxxx') as [Batch No], IsNull(Recv_D.ExpiryDate,DATEADD(Month , 1 , getDate())) As ExpiryDate,isnull(Recv_D.Origin,'') as Origin, IsNull(Recv_D.BardanaDeduction, 0) AS [Bardana Deduction], IsNull(Recv_D.OtherDeduction, 0) AS [Other Deduction], Convert(float, 0) [After Deduction Qty], Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId, Isnull(Recv_D.CostPrice,0) as CostPrice, IsNull(CR.SalesDetailId,0) as CR_SalesDetailId, IsNull(Cr.SaleCertificateId,0) as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock,IsNull(Recv_D.SalesReturnQty,0)  as SalesReturnQty, IsNull(Recv_D.DeliveryChalanId,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryChalanDetailId,0) as DeliveryChalanDetailId, IsNull(Recv_D.Transport_Charges,0) as Transport_Charges, IsNull(Recv_D.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp, IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), IsNull(Recv_D.Qty,0), 1) as TotalQty, IsNull(Recv_D.SO_Detail_ID, 0) As SODetailId, ArticleLpoDefTable.ArticleLpoName, IsNull(Recv_D.OldSalePrice, 0) As OldSalePrice, IsNull(Recv_D.SalePriceProcessId, 0) As SalePriceProcessId ,IsNull(Article.LogicalItem, 0) AS LogicalItem, Recv_D.AlternativeItemId" _
                & " FROM SalesDetailTable Recv_D INNER JOIN " _
                & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId inner JOIN " _
                & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId " _
                & " LEFT OUTER JOIN SalesCertificateTable CR On CR.SalesDetailId = Recv_D.SaleDetailId Left Outer Join ArticleLpoDefTable ON Article.ArticleLPOId = ArticleLpoDefTable.ArticleLpoId" _
                & " Where Recv_D.SalesID =" & ReceivingID & " ORDER BY Recv_D.SaleDetailId Asc"

        ElseIf Condition = "DeliveryChalanDetail" Then
            'Before against task:2374
            ''TFS1153 Added flat discount column
            '' Below lines are commented against TASK: TFS1357
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)) AS Qty, Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount], " _
            '                  & " ((IsNull(Recv_D.Qty, 0) * Recv_D.Price * (Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End)) - IsNull(Recv_D.DeliveredTotalQty, 0) * Recv_D.Price * (Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End)) AS Total, " _
            '               & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], ISNULL(Recv_D.CurrentPrice,0) as CurrentPrice, 0 as PackPrice, 0 As SaleDetailId, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, Convert(float,0) as [Total Amount], 0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, 0 As FlatDiscount, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(So_ID,0) as So_Id,  isnull(Recv_D.Sz1,0) as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice,  0 as NetBill,  Recv_D.BatchID, isnull(Recv_D.BatchNo,'') as [Batch No], Recv_D.ExpiryDate, Recv_D.comments as Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId, 0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty,IsNull(Recv_D.DeliveryID,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryDetailId,0) as DeliveryChalanDetailId, 0 as Transport_Charges, Convert(bit,1) as  ApplyAdjustmentFuelExp, IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, (IsNull(Recv_D.Qty,0) - IsNull(Recv_D.DeliveredTotalQty,0)) as TotalQty, 0 As SODetailId, '' As ArticleLpoName FROM DeliveryChalanDetailTable Recv_D INNER JOIN " _
            '                  & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId inner JOIN " _
            '                  & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id  LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId " _
            '                  & " Where Recv_D.DeliveryId =" & ReceivingID & " AND (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)) > 0 ORDER BY Recv_D.DeliveryDetailId Asc"
            '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
            ''TFS1154 Added Retail Price column
            ''Task:TFS1153 Added Column DiscountType and DiscountValue

            str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item,Recv_D.AlternativeItem, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, Convert(Decimal(18, " & DecimalPointInQty & "), (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)), 1) AS Qty, " _
                & " Recv_D.Price As PostDiscountPrice , 1 As DiscountId, '' as [DiscountType], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, 0 As FlatDiscount, 0 As DiscountFactor, 0 As DiscountValue, " _
                & " Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount], " _
                & " ((IsNull(Recv_D.Qty, 0) * Recv_D.Price * (Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End)) - IsNull(Recv_D.DeliveredTotalQty, 0) * Recv_D.Price * (Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End)) AS Total, " _
                & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], ISNULL(Recv_D.CurrentPrice,0) as CurrentPrice, 0 as PackPrice, 0 As SaleDetailId, ISNULL(Recv_D.RetailPrice,0) as RetailPrice, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, Convert(float,0) as [Total Amount], 0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(So_ID,0) as So_Id,  Convert(Decimal(18, " & DecimalPointInQty & "), isnull(Recv_D.Sz1,0), 1) as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice,  0 as NetBill,  Recv_D.BatchID, isnull(Recv_D.BatchNo,'xxxx') as [Batch No], IsNull(Recv_D.ExpiryDate,DATEADD(Month , 1 , getDate())) As ExpiryDate,isnull(Recv_D.Origin,'') as Origin, IsNull(Recv_D.BardanaDeduction, 0) AS [Bardana Deduction], IsNull(Recv_D.OtherDeduction, 0) AS [Other Deduction], Convert(float,0) AS [After Deduction Qty], Recv_D.comments as Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId, 0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty,IsNull(Recv_D.DeliveryID,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryDetailId,0) as DeliveryChalanDetailId, 0 as Transport_Charges,IsNull(Detail.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp, IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), (IsNull(Recv_D.Qty,0) - IsNull(Recv_D.DeliveredTotalQty,0)), 1) as TotalQty, 0 As SODetailId, '' As ArticleLpoName, 0 As OldSalePrice, 0 As SalePriceProcessId , IsNull(Article.LogicalItem, 0) AS LogicalItem, Recv_D.AlternativeItemId FROM DeliveryChalanDetailTable Recv_D INNER JOIN " _
                & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId inner JOIN " _
                & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id  LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId " _
                & " Where Recv_D.DeliveryId =" & ReceivingID & " AND (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)) > 0 ORDER BY Recv_D.DeliveryDetailId Asc"

        ElseIf Condition = "BillEmbroidery" Then

            str = " SELECT Isnull(Recv_D.LocationId,0) as LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, Recv_D.Qty AS Qty, " _
                & " 0 As PostDiscountPrice, 0 as DiscountId,  '' as [DiscountType],0 as Discount_Percentage, 0 As FlatDiscount,0 As DiscountFactor, 0 As DiscountValue,  " _
                & " Recv_D.Rate as Rate,  0 As BaseCurrencyId, 0 As BaseCurrencyRate, 0 As CurrencyId, 1 As CurrencyRate, 0 As CurrencyAmount, 0 As [Total Currency Amount], " _
                & " CASE WHEN recv_d.articlesize = 'Loose' THEN (Recv_D.Qty * Recv_D.Rate)  ELSE ((Recv_D.Qty * Recv_D.Rate) * Article.PackQty) END AS Total,  " _
                & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.PackQty as [Pack Qty], ISNULL(Recv_D.Rate,0) as CurrentPrice, Isnull(Recv_D.Rate,0) as PackPrice,  Recv_D.DocDetailId,  0 as RetailPrice, 0 as TradePrice, 0 as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], 0 As SED,Convert(float,0) as [Total Amount], 0 as savedqty , 0 as [Sample Qty],  0 as Freight, 0 as MarketReturns, 0 as So_Id,  isnull(Recv_D.Qty,0) as LoadQty, 0 as PurchasePrice, 0 as NetBill, 0 as BatchID,   '' as [Batch No], getDate() as ExpiryDate '' as Origin, 0 AS [Bardana Deduction], 0 AS [Other Deduction], Convert(float,0) AS [After Deduction Qty], '' as Comments, '' as [Other Comments], '' as Engine_No, '' as Chassis_No, Recv_D.articlesize as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId,Article.CGSAccountId, 0 as CostPrice, 0 as CR_SalesDetailId,0 as SaleCertificateId,IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty, 0 as DeliveryChalanId, 0 as DeliveryChalanDetailId, 0 as Transport_Charges, Convert(bit,1) as  ApplyAdjustmentFuelExp, 0 As Gross_Weights,  0 As Tray_Weights, 0 As Net_Weights, IsNull(Recv_D.Qty, 0) as TotalQty, 0 As OldSalePrice, 0 As SalePriceProcessId ,IsNull(Article.LogicalItem, 0) AS LogicalItem FROM tblBillAnalysisDetail Recv_D INNER JOIN  " _
                & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId  " _
                & " LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId   " _
                & " Where Recv_D.DocId = " & ReceivingID & " ORDER BY Recv_D.DocDetailId Asc "

        ElseIf Condition = "CMFADocument" Then

            str = "SELECT  CMFADT.LocationId, ART.ArticleCode as Code, ART.ArticleDescription as Item, ART.ArticleSizeName as Size, ART.ArticleColorName as Color, CMFADT.ArticleSize as [Unit], (IsNull(CMFADT.Sz1,0)-IsNull(CMFADT.SoldQty,0)) as Qty, " _
                & " 0 As PostDiscountPrice, 0 as DiscountId, '' as [DiscountType],0 AS Discount_Percentage, 0 As FlatDiscount, 0 As DiscountFactor, 0 As DiscountValue, " _
                & " Convert(float,IsNull(CMFADT.InvoicePrice,0)) as Rate,  0 As BaseCurrencyId, 0 As BaseCurrencyRate, 0 As CurrencyId, 1 As CurrencyRate, 0 As CurrencyAmount, 0 As [Total Currency Amount], " _
                & " 0 AS Total, ART.ArticleGroupId, CMFADT.ArticleDefId, CMFADT.Sz7 AS [Pack Qty], IsNull(CMFADT.InvoicePrice,0) AS CurrentPrice, 0 AS PackPrice, 0 AS DoDetailId,  " _
                & " 0 AS RetailPrice,  0 AS TradePrice, CMFADT.Tax_Percent AS Tax, 0 AS [Tax Amount], Convert(float,0) as [Currency Tax Amount] ,0 AS SED, 0 AS [Total Amount], 0 AS saveqty, 0 AS [Sample Qty],  " _
                & " 0 AS Freight, 0 AS MarketReturns, 0 AS SO_ID, CMFADT.Sz1 AS LoadQty, IsNull(ART.PurchasePrice,0) as PurchasePrice, 0 AS NetBill, 0 AS BatchId, 'xxxx' AS [Batch No], getDate() as ExpiryDate, '' as Origin, 0 AS [Bardana Deduction], 0 AS [Other Deduction], Convert(float,0) AS [After Deduction Qty], '' AS Comments , '' as [Other Comments],  " _
                & " '' AS Engine_No, '' AS Chassis_No, CMFADT.PackDesc AS Pack_Desc, ART.SubSubID AS InvAccountId, Art.SalesAccountId, Art.CGSAccountId, 0 AS CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty, 0 as DeliveryChalanId, 0 as DeliveryChalanDetailId, 0 as Transport_Charges,Convert(bit,1) as  ApplyAdjustmentFuelExp, 0 As Gross_Weights,  0 As Tray_Weights, 0 As Net_Weights, IsNull(CMFADT.Qty) as TotalQty, 0 As SODetailId, '' As ArticleLpoName, 0 As OldSalePrice, 0 As SalePriceProcessId , IsNull(ART.LogicalItem, 0) AS LogicalItem" _
                & " FROM  dbo.CMFADetailTable AS CMFADT INNER JOIN dbo.ArticleDefView AS ART ON CMFADT.ArticleDefId = ART.ArticleId LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = CMFADT.ArticleDefId  WHERE CMFADT.DocID=" & ReceivingID & " AND (IsNull(CMFADT.Sz1,0)-IsNull(CMFADT.SoldQty,0)) > 0 ORDER BY CMFADT.DocDetailID ASC "

        End If
        'End Task TASKM106151


        Dim objCommand As New OleDbCommand
        Dim objCon As OleDbConnection
        Dim objDataAdapter As New OleDbDataAdapter
        Dim objDataSet As New DataSet

        objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

        If objCon.State = ConnectionState.Open Then objCon.Close()

        objCon.Open()
        objCommand.Connection = objCon
        objCommand.CommandType = CommandType.Text


        objCommand.CommandText = str

        objDataAdapter.SelectCommand = objCommand
        objDataAdapter.Fill(objDataSet)

        If Not IsSalesOrderAnalysis = True Then
            'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,(((((((IsNull(TotalQty,0)) * IsNull(rate,0)) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)))) - (((IsNull(TotalQty,0) * IsNull(rate,0)) * IsNull(Discount_Percentage,0))/100)) + (IsNull(TotalQty,0)  * IsNull(rate,0))))"
            '
            objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountId= 1,((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountId= 1, IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"

            'If flgExcludeTaxPrice = True Then
            '    objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,(((((((IsNull(TotalQty,0)) * IsNull(rate,0) * CurrencyRate) / IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)))) - (((IsNull(TotalQty,0) * IsNull(rate,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + (IsNull(TotalQty,0)  * IsNull(rate,0) * CurrencyRate)))"
            'Else
            objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))) * IsNull(rate,0) * CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(rate,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(rate,0) * CurrencyRate)))"
            'End If

            'objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "(isnull(TotalQty,0) * isnull(Rate,0)*CurrencyRate)"
            objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)*CurrencyRate)"

            objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"

            objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"


            'ElseIf ServicesItem = "True" Then
            '    objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "iif(Unit = 'Loose' , (ServiceQty * Rate) , ((ServiceQty * [Pack Qty])*Rate))"
        Else
            'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(CurrentPrice,0)=0,0,(((((((IsNull(TotalQty,0) + IsNull([Sample Qty],0)) * IsNull(CurrentPrice,0)) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)+IsNull([Sample Qty],0)))) - (((IsNull(TotalQty,0) * IsNull(CurrentPrice,0)) * IsNull(Discount_Percentage,0))/100)) + (IsNull(TotalQty,0)  * IsNull(CurrentPrice,0))))"
            'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(CurrentPrice,0)=0,0,(((((((IsNull(TotalQty,0) + IsNull([Sample Qty],0)) * IsNull(CurrentPrice,0)) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)+IsNull([Sample Qty],0)))) - (((IsNull(TotalQty,0) * IsNull(CurrentPrice,0)) * IsNull(Discount_Percentage,0))/100)) + (IsNull(TotalQty,0)  * IsNull(CurrentPrice,0))))"
            ''change Against TFS1153
            objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountId= 1,((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountId= 1, IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"
            ''Edit Against TFS1799 
            'If flgExcludeTaxPrice = True Then
            'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(CurrentPrice,0)=0,0,(((((((IsNull(TotalQty,0) + IsNull([Sample Qty],0)) * IsNull(CurrentPrice,0) * CurrencyRate) / IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)+IsNull([Sample Qty],0)))) - (((IsNull(TotalQty,0) * IsNull(CurrentPrice,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + (IsNull(TotalQty,0)  * IsNull(CurrentPrice,0) * CurrencyRate)))"
            'Else
            objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) + IsNull([Sample Qty],0)) * IsNull(rate,0) * CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))+IsNull([Sample Qty],0)))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(rate,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(rate,0) * CurrencyRate)))"
            'End If

            objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)) * IsNull(CurrencyRate, 0) "
            objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"
            objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"
        End If
        'objDataSet.Tables(0).Columns(EnumGridDetail.Total).ReadOnly = False
        If flgExcludeTaxPrice = False Then
            objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(CurrencyAmount,0))"
            objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)+IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))" 'Task:2374 Set Expression Total Amount 
            objDataSet.Tables(0).Columns("Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(Total,0))"
            objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)+IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))" 'Task:2374 Set Expression Total Amount

        Else
            objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "(IsNull(CurrencyAmount,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
            objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)-IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))" 'Task:2374 Set Expression Total Amount 
            objDataSet.Tables(0).Columns("Tax Amount").Expression = "(IsNull(Total,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
            objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)-IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))"


        End If

        If Me.BtnSave.Text = "&Save" Then
            objDataSet.Tables(0).Columns(EnumGridDetail.LoadQty).Expression = "IsNull(TotalQty,0)"
        End If

        Me.grd.DataSource = objDataSet.Tables(0)
        Me.grd.RetrieveStructure()
        If objDataSet.Tables(0).Rows.Count > 0 Then
            If IsDBNull(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId")) Or Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
                'Me.cmbCurrency.SelectedValue = Nothing
                Me.cmbCurrency.Enabled = False
                CurrencyRate = 1
            Else
                Me.CurrencyRate = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString)
                Me.cmbCurrency.SelectedValue = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString)
                Me.cmbCurrency.Enabled = False
            End If
            cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
        End If
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Caption = "Challan"
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns("So_Id").HasValueList = True
        Me.grd.RootTable.Columns("So_Id").LimitToList = True
        Me.grd.RootTable.Columns("So_Id").EditType = Janus.Windows.GridEX.EditType.Combo
        'Ali Faisal : TFS1362 : 22-Aug-2017 : Change column type from text to dropdown
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).LimitToList = False
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).EditType = Janus.Windows.GridEX.EditType.Combo


        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).LimitToList = False
        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).EditType = Janus.Windows.GridEX.EditType.Combo

        Me.grd.RootTable.Columns("Batch No").HasValueList = True
        Me.grd.RootTable.Columns("Batch No").LimitToList = False
        Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.Combo

        Me.grd.RootTable.Columns("Origin").HasValueList = True
        Me.grd.RootTable.Columns("Origin").LimitToList = False
        Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.Combo
        'Ayesha Rehman: TFS1153 : 23-Nov-2017 : Change column from text to drop down
        'Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).HasValueList = True
        'Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).LimitToList = True
        'Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).EditType = Janus.Windows.GridEX.EditType.Combo

        ''Code Commented bcz it needs to be checked it
        ' ''Start TFS2739
        'Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).HasValueList = True
        'Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).LimitToList = True
        'Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).EditType = Janus.Windows.GridEX.EditType.Combo
        ' ''End TFS2739

        'Ali Faisal : TFS1362 : 22-Aug-2017 : End
        FillCombo("grdLocation")
        FillCombo("grdSO")
        FillCombo("grdDeliveryChalan")
        'Ali Faisal : TFS1362 : 22-Aug-2017 : Fill combo boxes
        FillCombo("grdEngine")
        FillCombo("grdChassis")
        FillCombo("grdBatch")
        FillCombo("GrdOrigin")
        'Ali Faisal : TFS1362 : 22-Aug-2017 : End
        FillOutwardExpense(ReceivingID, "SI")
        'Ayesha Rehman: TFS1153 : 23-NOV-2017 : Fill combo boxes
        FillCombo("grdDiscountType")
        'Ayesha Rehman : TFS1153 : 23-NOV-2017 : End

        ''Code Commented bcz it needs to be checked it
        ''Ayesha Rehman: TFS2739: 02-04-2018 : Fill combo boxes
        'FillCombo("grdBatchNo")
        ''Ayesha Rehman : TFS2739 : 02-04-2018 : End
        ApplyGridSettings()
        GetTotal()
        GetSalesOrderAnalysis()
        Me.grd.RootTable.Columns(EnumGridDetail.Color).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.SED).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.Size).Visible = True
        Me.grd.RootTable.Columns("SalesAccountId").Visible = False
        Me.grd.RootTable.Columns("InvAccountId").Visible = False
        Me.grd.RootTable.Columns("CGSAccountId").Visible = False
        Me.grd.RootTable.Columns("CR_SalesDetailId").Visible = False
        Me.grd.RootTable.Columns("SaleCertificateId").Visible = False
        Me.grd.RootTable.Columns("SalesReturnQty").Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.Stock).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanDetailId).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.FlatDiscount).Visible = False
        'Me.grd.RootTable.Columns(EnumGridDetail.ServiceQty).Visible = False
        Me.txtQty.Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).Visible = True
        If flgLoadAllItems = True Then
            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                If Me.grd.RowCount > 0 Then
                    r.BeginEdit()
                    r.Cells("LocationId").Value = Me.cmbCategory.SelectedValue
                    r.EndEdit()
                End If
            Next
        End If

    End Sub

    Public Sub DisplayDeliveryChalanDetail(ReceivingId As Integer)
        Try
            If ReceivingId = 0 Then Exit Sub
            Dim objCommand As New OleDbCommand
            Dim objCon As OleDbConnection
            Dim objDataAdapter As New OleDbDataAdapter
            Dim objDataSet As New DataSet

            objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

            If objCon.State = ConnectionState.Open Then objCon.Close()

            objCon.Open()
            objCommand.Connection = objCon
            objCommand.CommandType = CommandType.Text


            Dim str As String = String.Empty
            ''Below lines are commented against TASK: TFS1357
            'str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)) AS Qty, Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) AS BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) AS BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) AS CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End AS CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) AS CurrencyAmount, Convert(float,0) as [Total Currency Amount], " _
            '               & " ((IsNull(Recv_D.Qty, 0) * Recv_D.Price * (Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End)) - IsNull(Recv_D.DeliveredTotalQty, 0) * Recv_D.Price * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
            '               & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], ISNULL(Recv_D.CurrentPrice,0) as CurrentPrice, 0 as PackPrice, 0 As SaleDetailId, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, Convert(float,0) as [Total Amount], 0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, 0 As FlatDiscount, ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(So_ID,0) as So_Id,  isnull(Recv_D.Sz1,0) as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice , 0 as NetBill,  Recv_D.BatchID, isnull(Recv_D.BatchNo,'') as [Batch No], Recv_D.ExpiryDate, Recv_D.comments as Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId, 0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty,IsNull(Recv_D.DeliveryID,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryDetailId,0) as DeliveryChalanDetailId, 0 as Transport_Charges, 1 as  ApplyAdjustmentFuelExp   , IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, (IsNull(Recv_D.Qty,0) - IsNull(Recv_D.DeliveredTotalQty, 0)) as TotalQty, 0 As SODetailId   FROM DeliveryChalanDetailTable Recv_D INNER JOIN " _
            '               & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT JOIN " _
            '               & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id  LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId " _
            '               & " Where Recv_D.DeliveryId =" & ReceivingId & " AND (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)) > 0 ORDER BY Recv_D.DeliveryDetailId Asc"


            '' TASK: TFS1357 Converted Qty columns to decimal from double to show end zero after points. Ameen on 22-08-2017 
            ''TASK : TFS1398
            ''TASK : TFS1154 Added column for Retail Price
            ''TASK : TFS1153 Added columns for DicountType and DiscoutValue
            '' TASK: TFS3 
            str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item, Recv_D.AlternativeItem, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, Convert(Decimal(18, " & DecimalPointInQty & "), (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)), 1) AS Qty, " _
                & " Recv_D.PostDiscountPrice As PostDiscountPrice, Recv_D.DiscountId  As DiscountId, '' as DiscountType,ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, 0 As FlatDiscount, Recv_D.DiscountFactor As DiscountFactor, Recv_D.DiscountValue As DiscountValue,   " _
                & " Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) AS BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) AS BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) AS CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End AS CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) AS CurrencyAmount, Convert(float,0) as [Total Currency Amount], " _
                & " ((IsNull(Recv_D.Qty, 0) * Recv_D.Price * (Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End)) - IsNull(Recv_D.DeliveredTotalQty, 0) * Recv_D.Price * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
                & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], ISNULL(Recv_D.CurrentPrice,0) as CurrentPrice, 0 as PackPrice, 0 As SaleDetailId, 0 as RetailPrice,  ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, Convert(float,0) as [Total Amount], 0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(So_ID,0) as So_Id,  Convert(Decimal(18, " & DecimalPointInQty & "), isnull(Recv_D.Sz1,0), 1) as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice , 0 as NetBill,  Recv_D.BatchID, isnull(Recv_D.BatchNo,'') as [Batch No], Recv_D.ExpiryDate, isnull(Recv_D.Origin,'') as Origin, IsNull(Recv_D.BardanaDeduction, 0) AS [Bardana Deduction], IsNull(Recv_D.OtherDeduction, 0) AS [Other Deduction], Convert(float,0) AS [After Deduction Qty], Recv_D.comments as Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId, 0 as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock, 0 as SalesReturnQty,IsNull(Recv_D.DeliveryID,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryDetailId,0) as DeliveryChalanDetailId, 0 as Transport_Charges, ISNULL(Article.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp   , IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), (IsNull(Recv_D.Qty,0) - IsNull(Recv_D.DeliveredTotalQty, 0)), 1) as TotalQty, IsNull(Recv_D.SO_Detail_ID, 0) As SODetailId, '' As ArticleLpoName, 0 As OldSalePrice, 0 As SalePriceProcessId  , IsNull(Article.LogicalItem, 0) AS LogicalItem, Recv_D.AlternativeItemId  FROM DeliveryChalanDetailTable Recv_D INNER JOIN " _
                & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT JOIN " _
                & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id  LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId " _
                & " Where Recv_D.DeliveryId =" & ReceivingId & " AND (Isnull(Recv_D.Sz1,0)-isnull(Recv_D.DeliveredQty,0)) > 0 ORDER BY Recv_D.DeliveryDetailId "
            objCommand.CommandText = str
            objDataAdapter.SelectCommand = objCommand
            objDataAdapter.Fill(objDataSet)


            ''Start TFS4773 :  Ayesha Rehman : 11-10-2018 
            If DCStockImpact = False Then ''Edit Check,If DC Stock Impact is on ,then no need to check stock while making Sales from DC
            ''19-10-2016 Ameen
            Dim IsMinus As Boolean = True
            'If CType(Me.cmbItem.SelectedRow, Infragistics.Win.UltraWinGrid.UltraGridRow).Cells("ServiceItem").Value = False Then
            IsMinus = getConfigValueByType("AllowMinusStock")
            'End If
            If IsMinus = False Then
                If objDataSet.Tables(0).Rows.Count > 0 Then
                        For Each dr As DataRow In objDataSet.Tables(0).Rows
                            Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & dr.Item("ArticleDefId") & ""
                            Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem)
                            dt2serviceitem.AcceptChanges()
                            Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                            If ServiceItem1 = False Then
                                dr.BeginEdit()
                                AvailableStock = Convert.ToDouble(GetStockById(dr.Item("ArticleDefId"), dr.Item("LocationId"), IIf(dr.Item("unit").ToString = "Loose", "Loose", "Pack")))
                                If AvailableStock < 0 Then
                                    ShowErrorMessage("Stock is negative against item " & dr.Item("Item").ToString & " ")
                                    dr.Delete()
                                Else
                                    If dr.Item("unit").ToString = "Loose" Then
                                        If Val(dr.Item("TotalQty")) > AvailableStock Then
                                            If msg_Confirm("Stock is not enough " & dr.Item("Item").ToString & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                                Exit Sub
                                            Else
                                                StockChecked = True
                                                dr.Item("TotalQty") = AvailableStock
                                                dr.Item("Qty") = AvailableStock
                                            End If
                                        End If

                                    Else
                                        If Val(dr.Item("Qty")) > AvailableStock Then
                                            If msg_Confirm("Stock is not enough " & dr.Item("Item").ToString & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                                Exit Sub
                                            Else
                                                StockChecked = True
                                                dr.Item("Qty") = AvailableStock
                                            End If
                                        End If

                                    End If
                                    dr.EndEdit()
                                    AvailableStock = 0
                                End If
                            End If
                        Next
                End If
            End If
            End If
            ''End TFS4773
            objDataSet.AcceptChanges()
            ''End 19-10-2016 Ameen

            If Not IsSalesOrderAnalysis = True Then
                ''TFS1153 Added flat discount column
                'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,(((((((IsNull(TotalQty,0)) * IsNull(rate,0)) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)))) - (((IsNull(TotalQty,0) * IsNull(rate,0)) * IsNull(Discount_Percentage,0))/100)) + (IsNull(TotalQty,0)  * IsNull(rate,0))))"
                ''Changes Against TFS1153
                objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountType='Percentage',((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountType='Percentage', IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))) * IsNull(rate,0)*CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(rate,0)*CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(rate,0)*CurrencyRate)))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)*CurrencyRate)"
                objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"
                'ElseIf ServicesItem = "True" Then
                '    objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "iif(Unit = 'Loose' , (ServiceQty * Rate) , ((ServiceQty * [Pack Qty])*Rate))"
            Else
                'objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(CurrentPrice,0)=0,0,(((((((IsNull(TotalQty,0) + IsNull([Sample Qty],0)) * IsNull(CurrentPrice,0)) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * (IsNull(TotalQty,0)+IsNull([Sample Qty],0)))) - (((IsNull(TotalQty,0) * IsNull(CurrentPrice,0)) * IsNull(Discount_Percentage,0))/100)) + (IsNull(TotalQty,0)  * IsNull(CurrentPrice,0))))"
                ''Changes Against TFS1153
                objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountType='Percentage',((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountType='Percentage', IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(CurrentPrice,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) + IsNull([Sample Qty],0)) * IsNull(CurrentPrice,0) * CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))+IsNull([Sample Qty],0)))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(CurrentPrice,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(CurrentPrice,0) * CurrencyRate)))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)) * CurrencyRate "
                objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"
            End If
            'objDataSet.Tables(0).Columns(EnumGridDetail.Total).ReadOnly = False
            If flgExcludeTaxPrice = False Then
                objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(CurrencyAmount,0))"
                objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)+IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))" 'Task:2374 Set Expression Total Amount 
                objDataSet.Tables(0).Columns("Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(Total,0))"
                objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)+IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))" 'Task:2374 Set Expression Total Amount 
            Else
                objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "(IsNull(CurrencyAmount,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
                objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)-IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))"
                objDataSet.Tables(0).Columns("Tax Amount").Expression = "(IsNull(Total,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
                objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)-IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))" 'Task:2374 Set Expression Total Amount 
            End If
            If Me.BtnSave.Text = "&Save" Then
                objDataSet.Tables(0).Columns(EnumGridDetail.LoadQty).Expression = "IsNull(TotalQty,0)"
            End If
            '' 18-06-2016

            If grd.DataSource IsNot Nothing Then
                Dim dt As DataTable = CType(Me.grd.DataSource, DataTable)
                dt.TableName = "Table1"
                dt.AcceptChanges()
                'If objDataSet.Tables(0).Rows.Count > 0 Then
                '    If IsDBNull(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId")) Or Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
                '        'Me.cmbCurrency.SelectedValue = Nothing
                '        Me.cmbCurrency.Enabled = False
                '        cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
                '    Else
                '        Me.cmbCurrency.SelectedValue = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString)
                '        cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
                '        Me.txtCurrencyRate.Text = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString)
                '        Me.cmbCurrency.Enabled = False
                '    End If
                'End If

                If objDataSet.Tables(0).Rows.Count > 0 Then
                    If IsDBNull(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId")) Or Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
                        'Me.cmbCurrency.SelectedValue = Nothing
                        Me.cmbCurrency.Enabled = False

                    Else
                        ''rafay waqar bhai ko error aya tha jab merge kia tha me ne apnay code k sath
                        Me.CurrencyRate = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString)
                        Me.cmbCurrency.SelectedValue = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString)
                        Me.cmbCurrency.Enabled = False
                    End If
                    cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
                    ''CurrencyRate = 1
                    'If Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString) > 1 Then
                    '    Me.txtCurrencyRate.Text = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString)
                    'End If
                End If

                For Each drRow As DataRow In objDataSet.Tables(0).Rows
                    Dim dr As DataRow = dt.NewRow
                    dr(EnumGridDetail.LocationID) = drRow(EnumGridDetail.LocationID)
                    dr(EnumGridDetail.ArticleCode) = drRow(EnumGridDetail.ArticleCode)
                    dr(EnumGridDetail.Item) = drRow(EnumGridDetail.Item)
                    dr(EnumGridDetail.AlternativeItem) = drRow(EnumGridDetail.AlternativeItem)
                    dr(EnumGridDetail.Size) = drRow(EnumGridDetail.Size)
                    dr(EnumGridDetail.Color) = drRow(EnumGridDetail.Color)
                    dr(EnumGridDetail.Unit) = drRow(EnumGridDetail.Unit)
                    dr(EnumGridDetail.Qty) = drRow(EnumGridDetail.Qty)
                    dr(EnumGridDetail.Price) = drRow(EnumGridDetail.Price)
                    dr(EnumGridDetail.BaseCurrencyId) = drRow(EnumGridDetail.BaseCurrencyId)
                    dr(EnumGridDetail.BaseCurrencyRate) = drRow(EnumGridDetail.BaseCurrencyRate)
                    dr(EnumGridDetail.CurrencyId) = drRow(EnumGridDetail.CurrencyId)
                    dr(EnumGridDetail.CurrencyRate) = drRow(EnumGridDetail.CurrencyRate)
                    dr(EnumGridDetail.CurrencyAmount) = drRow(EnumGridDetail.CurrencyAmount)
                    dr(EnumGridDetail.TotalCurrencyAmount) = drRow(EnumGridDetail.TotalCurrencyAmount)
                    dr(EnumGridDetail.Total) = drRow(EnumGridDetail.Total)
                    dr(EnumGridDetail.GroupID) = drRow(EnumGridDetail.GroupID)
                    dr(EnumGridDetail.ArticleID) = drRow(EnumGridDetail.ArticleID)
                    dr(EnumGridDetail.PackQty) = drRow(EnumGridDetail.PackQty)
                    dr(EnumGridDetail.CurrentPrice) = drRow(EnumGridDetail.CurrentPrice)
                    dr(EnumGridDetail.PackPrice) = drRow(EnumGridDetail.PackPrice)
                    dr(EnumGridDetail.SaleDetailID) = drRow(EnumGridDetail.SaleDetailID)
                    dr(EnumGridDetail.RetailPrice) = drRow(EnumGridDetail.RetailPrice) 'TFS1154
                    dr(EnumGridDetail.TradePrice) = drRow(EnumGridDetail.TradePrice)
                    dr(EnumGridDetail.Tax) = drRow(EnumGridDetail.Tax)
                    dr(EnumGridDetail.TaxAmount) = drRow(EnumGridDetail.TaxAmount)
                    dr(EnumGridDetail.CurrencyTaxAmount) = drRow(EnumGridDetail.CurrencyTaxAmount)
                    dr(EnumGridDetail.SED) = drRow(EnumGridDetail.SED)
                    dr(EnumGridDetail.TotalAmount) = drRow(EnumGridDetail.TotalAmount)
                    dr(EnumGridDetail.SavedQty) = drRow(EnumGridDetail.SavedQty)
                    dr(EnumGridDetail.SampleQty) = drRow(EnumGridDetail.SampleQty)
                    dr(EnumGridDetail.Discount_Percentage) = drRow(EnumGridDetail.Discount_Percentage)
                    dr(EnumGridDetail.FlatDiscount) = 0
                    dr(EnumGridDetail.DiscountId) = drRow(EnumGridDetail.DiscountId) 'TFS1153
                    dr(EnumGridDetail.DiscountType) = drRow(EnumGridDetail.DiscountType) 'TFS1153
                    dr(EnumGridDetail.DiscountValue) = drRow(EnumGridDetail.DiscountValue) 'TFS1153
                    dr(EnumGridDetail.DiscountFactor) = drRow(EnumGridDetail.DiscountFactor) 'TFS1153
                    dr(EnumGridDetail.PostDiscountPrice) = drRow(EnumGridDetail.PostDiscountPrice) 'TFS1153
                    dr(EnumGridDetail.Freight) = drRow(EnumGridDetail.Freight)
                    dr(EnumGridDetail.MarketReturns) = drRow(EnumGridDetail.MarketReturns)
                    dr(EnumGridDetail.SO_ID) = drRow(EnumGridDetail.SO_ID)
                    dr(EnumGridDetail.LoadQty) = drRow(EnumGridDetail.LoadQty)
                    dr(EnumGridDetail.PurchasePrice) = drRow(EnumGridDetail.PurchasePrice)
                    dr(EnumGridDetail.BaseCurrencyId) = drRow(EnumGridDetail.BaseCurrencyId)
                    dr(EnumGridDetail.BaseCurrencyRate) = drRow(EnumGridDetail.BaseCurrencyRate)
                    dr(EnumGridDetail.CurrencyId) = drRow(EnumGridDetail.CurrencyId)
                    dr(EnumGridDetail.CurrencyRate) = drRow(EnumGridDetail.CurrencyRate)
                    dr(EnumGridDetail.CurrencyAmount) = drRow(EnumGridDetail.CurrencyAmount)
                    dr(EnumGridDetail.TotalCurrencyAmount) = drRow(EnumGridDetail.TotalCurrencyAmount)
                    dr(EnumGridDetail.NetBill) = drRow(EnumGridDetail.NetBill)
                    dr(EnumGridDetail.BatchNo) = drRow(EnumGridDetail.BatchNo) '"xxxx"
                    dr(EnumGridDetail.BatchID) = 0
                    dr(EnumGridDetail.Comments) = drRow(EnumGridDetail.Comments)
                    dr(EnumGridDetail.OtherComments) = drRow(EnumGridDetail.OtherComments)
                    dr(EnumGridDetail.Engine_No) = drRow(EnumGridDetail.Engine_No)
                    dr(EnumGridDetail.Chassis_No) = drRow(EnumGridDetail.Chassis_No)
                    dr(EnumGridDetail.Pack_Desc) = drRow(EnumGridDetail.Pack_Desc)
                    dr(EnumGridDetail.AccountId) = drRow(EnumGridDetail.AccountId)
                    dr(EnumGridDetail.SalesAccountId) = drRow(EnumGridDetail.SalesAccountId)
                    dr(EnumGridDetail.CGSAccountId) = drRow(EnumGridDetail.CGSAccountId)
                    dr(EnumGridDetail.CostPrice) = drRow(EnumGridDetail.CostPrice)
                    dr(EnumGridDetail.SalesDetailIdByCertificate) = drRow(EnumGridDetail.SalesDetailIdByCertificate)
                    dr(EnumGridDetail.SaleCertificateId) = drRow(EnumGridDetail.SaleCertificateId)
                    dr(EnumGridDetail.Stock) = drRow(EnumGridDetail.Stock)
                    dr(EnumGridDetail.SalesReturnQty) = drRow(EnumGridDetail.SalesReturnQty)
                    dr(EnumGridDetail.DeliveryChalanId) = drRow(EnumGridDetail.DeliveryChalanId)
                    dr(EnumGridDetail.DeliveryChalanDetailId) = drRow(EnumGridDetail.DeliveryChalanDetailId)
                    dr(EnumGridDetail.Transport_Charges) = drRow(EnumGridDetail.Transport_Charges)
                    dr(EnumGridDetail.ApplyAdjustmentFuelExp) = drRow(EnumGridDetail.ApplyAdjustmentFuelExp)
                    dr(EnumGridDetail.Gross_Weights) = drRow(EnumGridDetail.Gross_Weights)
                    dr(EnumGridDetail.LogicalItem) = 0 ''TFS1957
                    dr(EnumGridDetail.Tray_Weights) = drRow(EnumGridDetail.Tray_Weights)
                    dr(EnumGridDetail.Net_Weight) = drRow(EnumGridDetail.Net_Weight) ''TASK-408
                    dr(EnumGridDetail.TotalQty) = drRow(EnumGridDetail.TotalQty)
                    dr(EnumGridDetail.SODetailId) = drRow(EnumGridDetail.SODetailId)
                    dr(EnumGridDetail.ExpiryDate) = drRow(EnumGridDetail.ExpiryDate) ''TFS4360
                    dr(EnumGridDetail.Origin) = drRow(EnumGridDetail.Origin)
                    dr(EnumGridDetail.CurrencyId) = Me.cmbCurrency.SelectedValue
                    If Me.cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                        dr(EnumGridDetail.CurrencyAmount) = Val(0)
                    Else
                        dr(EnumGridDetail.CurrencyAmount) = Val(Me.txtTotalQty.Text) * Val(Me.txtRate.Text)
                    End If
                    dr(EnumGridDetail.CurrencyRate) = Val(Me.txtCurrencyRate.Text)
                    Dim ConfigCurrencyVal As String = getConfigValueByType("Currency").ToString
                    If ConfigCurrencyVal.Length > 0 AndAlso Not ConfigCurrencyVal.ToString.ToUpper = "ERROR" Then
                        dr(EnumGridDetail.BaseCurrencyId) = Val(ConfigCurrencyVal)
                        dr(EnumGridDetail.BaseCurrencyRate) = Val(GetCurrencyRate(Val(ConfigCurrencyVal)))
                    End If

                    ''TASK TFS2741
                    dr(EnumGridDetail.BardanaDeduction) = drRow(EnumGridDetail.BardanaDeduction)
                    dr(EnumGridDetail.OtherDeduction) = drRow(EnumGridDetail.OtherDeduction)
                    dr(EnumGridDetail.AlternativeItemId) = drRow(EnumGridDetail.AlternativeItemId)
                    ''END TASK TFS2741

                    ''Below line is commented against TASK TFS4076 to set the sequence according to delivery chalan. Done by Amin on 01-08-2018
                    '' dt.Rows.InsertAt(dr, 0)
                    dt.Rows.Add(dr)
                    dt.AcceptChanges()
                Next

            End If

        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Function Update_Record() As Boolean
        'If Not Me.chkPost.Checked = True Then
        '    If Me.chkPost.Visible = False Then
        '        Me.chkPost.Checked = False
        '    End If
        'End If
        Dim VoucherNo As String = GetVoucherNo()
        Dim objCommand As New OleDbCommand
        Dim objCon As OleDbConnection
        Dim i As Integer
        gobjLocationId = MyCompanyId
        Dim lngVoucherMasterId As Integer = GetVoucherId(Me.Name, Me.txtPONo.Text)

        Dim InvAccountId As Integer = Val(getConfigValueByType("InvAccountId").ToString) 'GetConfigValue("InvAccountId") 'Inventory Account
        Dim CgsAccountId As Integer = Val(getConfigValueByType("CGSAccountId").ToString) 'GetConfigValue("CGSAccountId") 'Cost Of Good Sold Account
        Dim AccountId As Integer = Val(getConfigValueByType("SalesCreditAccount").ToString) 'GetConfigValue("SalesCreditAccount")
        'Dim SalesTaxId As Integer = Val(getConfigValueByType("SalesTaxCreditAccount").ToString) 'GetConfigValue("SalesTaxCreditAccount")
        Dim SalesTaxId As Integer = 0I
        If Me.cmbCompany.SelectedValue > 0 Then
            Dim str As String = "SELECT SalesTaxAccountId FROM CompanyDefTable WHERE CompanyId = " & cmbCompany.SelectedValue & " AND SalesTaxAccountId IS NOT NULL"
            Dim dt As DataTable = GetDataTable(str)
            If dt.Rows.Count > 0 Then
                SalesTaxId = Val(dt.Rows(0).Item(0))
            End If
        End If
        If SalesTaxId = 0 Then
            SalesTaxId = Val(getConfigValueByType("SalesTaxCreditAccount").ToString) 'GetConfigValue("SalesTaxCreditAccount")
        End If
        Dim SEDAccountId As Integer = Val(getConfigValueByType("SEDAccountId").ToString) 'Val(GetConfigValue("SEDAccountId").ToString)
        Dim InsuranceAccountId As Integer = Val(getConfigValueByType("TransitInsuranceAccountId").ToString) 'Val(GetConfigValue("TransitInsuranceAccountId").ToString)
        FuelExpAccount = Val(getConfigValueByType("FuelExpAccount").ToString)
        AdjustmentExpAccount = Val(getConfigValueByType("AdjustmentExpAccount").ToString)
        OtherExpAccount = Val(getConfigValueByType("OtherExpAccount").ToString)
        Dim IsDiscountVoucher As Boolean = Convert.ToBoolean(getConfigValueByType("DiscountVoucherOnSale").ToString) 'Convert.ToBoolean(GetConfigValue("DiscountVoucherOnSale").ToString)
        Dim SalesDiscountAccount As Integer = Val(getConfigValueByType("SalesDiscountAccount").ToString) 'Val(GetConfigValue("SalesDiscountAccount").ToString)
        Dim GLAccountArticleDepartment As Boolean
        If Not getConfigValueByType("GLAccountArticleDepartment").ToString = "Error" Then
            GLAccountArticleDepartment = Convert.ToBoolean(getConfigValueByType("GLAccountArticleDepartment"))
        Else
            GLAccountArticleDepartment = False
        End If
        Dim blnCheckCurrentStockByItem As Boolean = False
        If Not getConfigValueByType("CheckCurrentStockByItem").ToString = "Error" Then
            blnCheckCurrentStockByItem = Convert.ToBoolean(getConfigValueByType("CheckCurrentStockByItem").ToString)
        End If
        'Validtion on Configuration Account Id 
        '25-9-2013 by imran ali....

        If flgCgsVoucher = True Then
            If InvAccountId <= 0 Then
                ShowErrorMessage("Purchase account is not map.")
                Me.dtpPODate.Focus()
                Return False
            ElseIf CgsAccountId <= 0 Then
                ShowErrorMessage("Cost of good sold account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If AccountId <= 0 Then
            ShowErrorMessage("Sales account is not map.")
            Me.dtpPODate.Focus()
            Return False
        End If
        If Val(Me.txtTaxTotal.Text) > 0 Then
            If SalesTaxId <= 0 Then
                ShowErrorMessage("Sales tax account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtSEDTaxAmount.Text) > 0 Then
            If SEDAccountId <= 0 Then
                ShowErrorMessage("SED account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtAddTransitInsurance.Text) > 0 Then
            If InsuranceAccountId <= 0 Then
                ShowErrorMessage("Transit account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If IsDiscountVoucher = True Then
            If SalesDiscountAccount <= 0 Then
                ShowErrorMessage("Discount account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtFuel.Text) <> 0 Then
            If FuelExpAccount <= 0 Then
                ShowErrorMessage("Fuel account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtAdjustment.Text) <> 0 Then
            If AdjustmentExpAccount <= 0 Then
                ShowErrorMessage("Adjustment account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If
        If Val(Me.txtExpense.Text) <> 0 Then
            If OtherExpAccount <= 0 Then
                ShowErrorMessage("Other expense account is not map.")
                Me.dtpPODate.Focus()
                Return False
            End If
        End If

        Dim ReceiptVoucherFlg As String = Convert.ToString(getConfigValueByType("ReceiptVoucherOnSales").ToString) 'GetConfigValue("ReceiptVoucherOnSales").ToString
        'Dim VoucherNo As String = GetVoucherNo()
        'cmbProject.SelectedValue = GetCostCenterId(Me.cmbCompany.SelectedValue)
        'Dim ServiceItem As String = GetConfigValue("ServiceItem").ToString

        Dim DiscountedPrice As Double = 0
        'Dim CurrentBalance As Double = CDbl(GetAccountBalance(Me.cmbVendor.ActiveRow.Cells(0).Value)) - Me.ExistingBalance
        'Dim CurrentBalance As Double = CDbl(GetAccountBalance(Me.cmbVendor.ActiveRow.Cells(0).Value, Me.txtPONo.Text))
        Dim ExpenseChargeToCustomer As Boolean
        'If Not GetConfigValue("ExpenseChargeToCustomer").ToString = "Error" Then
        ExpenseChargeToCustomer = Convert.ToBoolean(getConfigValueByType("ExpenseChargeToCustomer").ToString) 'Convert.ToBoolean(GetConfigValue("ExpenseChargeToCustomer").ToString)
        Dim flgExcludeTaxPrice As Boolean = Convert.ToBoolean(getConfigValueByType("ExcludeTaxPrice").ToString)
        'Else
        '    ExpenseChargeToCustomer = False
        'End If
        'Dim strVoucherNo As String = String.Empty
        'Dim dt As DataTable = GetRecords("SELECT voucher_no   FROM tblVoucher  WHERE voucher_id = " & lngVoucherMasterId & " ")

        'If Not dt Is Nothing Then
        '    If Not dt.Rows.Count = 0 Then
        '        strVoucherNo = dt.Rows(0)("voucher_no")
        '    End If
        'End If
        ''TASK TFS1378
        'Dim DCStockImpact As Boolean = False ''Commented to use this variable globaly : 11-10-2018
        If Not getConfigValueByType("DCStockImpact").ToString = "Error" Then
            DCStockImpact = Convert.ToBoolean(getConfigValueByType("DCStockImpact").ToString)
        End If
        ''END TFS1378
        Dim str1 As String = ""
        Dim dt1 As DataTable
        str1 = "SELECT CustomerID, CustomerName, AccountId, UnBuiltAccountId FROM tblCustomer WHERE	Active = 1 AND AccountId = " & Me.cmbVendor.Value & " AND UnBuiltAccountId IS NOT NULL AND UnBuiltAccountId <> 0"
        dt1 = GetDataTable(str1)
        If dt1.Rows.Count > 0 Then
            UnbuildCustomerId = dt1.Rows(0).Item(3)
        Else
            UnbuildCustomerId = 0
        End If
        Dim AdjustmentAmountNew As Integer = 0I
        Dim SalesAccount As Integer = 0I
        If UnbuildCustomerId > 0 Then
            If msg_Confirm("Do you want to adjust invoice amount against unbuild A/C?") = True Then
                ''Below line is commented against TASK TFS2741
                'InvoiceAmount = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount), Janus.Windows.GridEX.AggregateFunction.Sum))
                'Dim DeductionAmount As Double = (Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.BardanaDeduction), Janus.Windows.GridEX.AggregateFunction.Sum)) + Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.OtherDeduction), Janus.Windows.GridEX.AggregateFunction.Sum))) * Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Price), Janus.Windows.GridEX.AggregateFunction.Sum))
                InvoiceAmount = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount), Janus.Windows.GridEX.AggregateFunction.Sum))
                CostCenterId = Me.cmbProject.SelectedValue
                frmSalesUnBuildVoucher.ShowDialog()
                AdjustmentAmountNew = frmSalesUnBuildVoucher.AdjustmentAmount
                SalesAccount = frmSalesUnBuildVoucher.SalesAccount
            End If
        End If
        objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

        If objCon.State = ConnectionState.Open Then objCon.Close()

        objCon.Open()
        objCommand.Connection = objCon

        Dim cmd As New OleDbCommand
        cmd.Connection = objCon
        cmd.CommandType = CommandType.Text
        Dim dtSavedItems As New DataTable 'Task:2645 Create Datatable Object
        Dim da As New OleDbDataAdapter
        cmd.CommandText = "SELECT ISNULL(Sz1,0) as Qty, ISNULL(SampleQty,0) as SampleQty, ArticleDefID, ISNULL(SO_ID,0) as SO_ID, IsNull(Qty, 0) As TotalQty, IsNull(SO_Detail_ID, 0) FROM SalesDetailTable WHERE  SalesId = " & Me.txtReceivingID.Text & " AND ISNULL(Sz1,0) <> 0"
        'Dim da As New OleDbDataAdapter(cmd)
        'Dim dtSavedItems As New DataTable
        da = New OleDbDataAdapter(cmd)
        da.Fill(dtSavedItems)





        Dim trans As OleDbTransaction = objCon.BeginTransaction
        Try
            objCommand.CommandType = CommandType.Text


            objCommand.Transaction = trans
            'objCon.BeginTransaction()
            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '& " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & " Where SalesID= " & txtReceivingID.Text & ""
            'objCommand.ExecuteNonQuery()
            'Before against task:2645
            ''ReqId-924 Solve Comma error on remarks
            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '& " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & " Where SalesID= " & txtReceivingID.Text & ""
            'Task:2645 Added Field Manual Invoice
            'Before against task:2681
            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '            & " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & " Where SalesID= " & txtReceivingID.Text & ""
            'End Task:2645
            'Task:2681 Added Field Invoice Party
            'Before against task:2702
            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '           & " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", InvoiceParty=N'" & Me.txtInvParty.Text.Replace("'", "''") & "' Where SalesID= " & txtReceivingID.Text & ""
            'End Task:2681
            '' End ReqId-928

            'Task:2702 Update Sold Qty In CMFADetailTable
            objCommand.CommandText = ""
            If blnCMFADocumentLoad = True Then
                If Me.cmbCMFADoc.SelectedIndex > 0 Then
                    objCommand.CommandText = "UPDATE CMFADetailTable SET SoldQty=a.SoldQty-a.SoldQty From " _
                     & " (SELECT SalesMasterTable.CMFADocID, SalesDetailTable.LocationId, SalesDetailTable.ArticleDefId, " _
                     & " SUM(ISNULL(SalesDetailTable.Sz1, 0)) AS SoldQty " _
                     & " FROM dbo.SalesDetailTable INNER JOIN SalesMasterTable On SalesMasterTable.SalesID = SalesDetailTable.SalesID " _
                     & " WHERE(SalesMasterTable.CMFADocID <> 0 AND SalesMasterTable.CMFADocID=" & Me.cmbCMFADoc.SelectedValue & ") AND (SalesMasterTable.SalesID=" & Val(txtReceivingID.Text) & ") " _
                     & "  GROUP BY SalesDetailTable.ArticleDefId, SalesMasterTable.CMFADocID, SalesDetailTable.LocationId)a " _
                     & " WHERE(a.CMFADocId = CMFADetailTable.docID) " _
                     & " AND CMFADetailTable.ArticleDefID = a.ArticleDefID " _
                     & " AND a.LocationID = CMFADetailTable.LocationID AND CMFADetailTable.DocId=" & Me.cmbCMFADoc.SelectedValue & ""
                    objCommand.ExecuteNonQuery()

                End If
            End If
            'End Task:2702

            'Task:2702 Added Field CMFADocID
            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '           & " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", InvoiceParty=N'" & Me.txtInvParty.Text.Replace("'", "''") & "', CMFADocID=" & IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.SelectedValue, 0) & " Where SalesID= " & txtReceivingID.Text & ""
            'End Task:2702
            GetTotal() 'Task:2770 Apply Total Amount.
            'Task:2770 Added Field DueDays
            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '           & " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", InvoiceParty=N'" & Me.txtInvParty.Text.Replace("'", "''") & "', CMFADocID=" & IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.SelectedValue, 0) & ", DueDays=" & Val(Me.txtDueDays.Text) & " Where SalesID= " & txtReceivingID.Text & ""
            'Task:2770

            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '           & " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", InvoiceParty=N'" & Me.txtInvParty.Text.Replace("'", "''") & "', CMFADocID=" & IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.SelectedValue, 0) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", InvoiceType=N'" & Me.cmbInvType.Text.Replace("'", "''") & "' Where SalesID= " & txtReceivingID.Text & ""

            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '           & " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtPaid.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & DeliveryChalanId & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", InvoiceParty=N'" & Me.txtInvParty.Text.Replace("'", "''") & "', CMFADocID=" & IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.SelectedValue, 0) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", InvoiceType=N'" & Me.cmbInvType.Text.Replace("'", "''") & "', Other_Company=N'" & Me.cmbOtherCompany.Text.Replace("'", "''") & "' Where SalesID= " & txtReceivingID.Text & ""

            UpdateDeliveryChalanStatus(Val(Me.txtReceivingID.Text), "Delete", trans)

            'Task#07072015 add Invoice_Status column in query
            'objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
            '          & " SalesQty=" & Val(txtTotalQty.Text) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtRecAmount.Text) & ", Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "',UpdateUserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "',  PreviousBalance = " & CurrentBalance & ", FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & IIf(DeliveryChalanId > 0, "" & DeliveryChalanId & "", "NULL") & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", InvoiceParty=N'" & Me.txtInvParty.Text.Replace("'", "''") & "', CMFADocID=" & IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.SelectedValue, 0) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", InvoiceType=N'" & Me.cmbInvType.Text.Replace("'", "''") & "', Other_Company=N'" & Me.cmbOtherCompany.Text.Replace("'", "''") & "',Party_Mobile_No='" & Me.txtMobileNo.Text.Replace("'", "''") & "',Invoice_Status=" & Me.cmbInvoiceStatus.Value & " Where SalesID= " & txtReceivingID.Text & ""
            'Task # 1864 Updating Column internal Remarks in SalesMasterTable
            'Rafay:ADD COlumn PO_NO in SalesMAsterTable
            objCommand.CommandText = "Update SalesMasterTable set SalesNo =N'" & txtPONo.Text & "',SalesDate=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "',CustomerCode=" & cmbVendor.ActiveRow.Cells(0).Value & ", PoID=" & Val(Me.cmbPo.SelectedValue) & ",EmployeeCode=" & Val(cmbSalesMan.SelectedValue.ToString) & ", " _
                     & " SalesQty=" & Val(txtTotalQty.Text) & ", Com_Percentage=" & IIf(Val(txtComPercentage.Text) <> 0, Val(txtComPercentage.Text), 0) & ", SalesAmount=" & Val(txtAmount.Text) & ", CashPaid=" & Val(txtRecAmount.Text) & ",PO_NO=N'" & txtPO.Text.Replace("'", "''") & "',ContractNo=N'" & txtcontractno.Text.Replace("'", "''") & "', Remarks=N'" & txtRemarks.Text.Replace("'", "''") & "', InternalRemarks=N'" & richTxtInternalRemarks.Text.Replace("'", "''") & "',UpdateUserName=N'" & LoginUserName & "', TransporterId=" & Me.cmbTransporter.SelectedValue & ",BiltyNo=N'" & Me.uitxtBiltyNo.Text.Replace("'", "''") & "', FuelExpense=" & Val(Me.txtFuel.Text) & ", OtherExpense=" & Val(Me.txtExpense.Text) & ", adjustment = " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & ", CostCenterId=" & cmbProject.SelectedValue & ", Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & ", Delivered=" & IIf(Me.chkDelivered.Checked = True, 1, 0) & ", TransitInsurance=" & Val(Me.txtAddTransitInsurance.Text) & ", DeliveryChalanId=" & IIf(DeliveryChalanId > 0, "" & DeliveryChalanId & "", "NULL") & ", DcNo=N'" & Me.txtDcNo.Text.Replace("'", "''") & "', Adj_Flag=" & IIf(Me.rbtAdjFlat.Checked = True, 0, 1) & ", Adj_Percentage=" & IIf(Me.rbtAdjPercentage.Checked = True, "" & Val(Me.txtAdjustment.Text) & "", "0") & ", ManualInvoice=" & IIf(blnNoneFinancialEffectInvoice = True, 1, 0) & ", InvoiceParty=N'" & Me.txtInvParty.Text.Replace("'", "''") & "', CMFADocID=" & IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.SelectedValue, 0) & ", DueDays=" & Val(Me.txtDueDays.Text) & ", InvoiceType=N'" & Me.cmbInvType.Text.Replace("'", "''") & "', Other_Company=N'" & Me.cmbOtherCompany.Text.Replace("'", "''") & "',Party_Mobile_No='" & Me.txtMobileNo.Text.Replace("'", "''") & "',Invoice_Status=" & Me.cmbInvoiceStatus.Value & ",Arrival_Time=N'" & dtpArrivalTime1.Value.ToString("yyyy-M-d h:mm:ss tt") & "',Departure_Time=" & IIf(Me.dtpDepartureTime1.Checked = True, "Convert(Datetime,'" & Me.dtpDepartureTime1.Value.ToString("yyyy-M-d hh:mm:ss tt") & "',102)", "NULL") & ", JobCardId = " & Val(Me.txtJobCardId.Text) & ", RevisionNumber = ISNULL(RevisionNumber, 0) + 1  Where SalesID= " & txtReceivingID.Text & ""
            objCommand.ExecuteNonQuery()
            '//To update jobcard history if invoice is paid or not //TASK # 943
            '29-Jun-2017: Start Task # 943: Waqar Raza: Change True and False to 1 and 0 for all SQL server.
            If txtJobCardNo.Text <> "" Then
                objCommand.CommandText = "Update tbljobcard set PaymentStatus = " & IIf(Paid = True, 1, 0) & " where JobCardId = " & Val(Me.txtJobCardId.Text) & ""
                objCommand.ExecuteNonQuery()
            End If
            'End Task # 943
            If arrFile.Count > 0 Then
                SaveDocument(Val(txtReceivingID.Text), Me.Name, trans)
            End If
            'Altered Against Task#2015060001 Ali Ansari


            ''==========================================
            objCommand.CommandText = ""
            'Before against task:M101
            'objCommand.CommandText = "update tblVoucher set voucher_date=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & "" _
            '                        & " , Employee_Id=" & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & "  where voucher_id=" & lngVoucherMasterId
            'Task:M101 Added Field Remarks
            If lngVoucherMasterId > 0 Then
                objCommand.CommandText = "update tblVoucher set voucher_date=N'" & dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', Post=" & IIf(Me.chkPost.Checked = True, 1, 0) & "" _
                                       & " , Employee_Id=" & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ",Remarks=N'" & Me.txtRemarks.Text.Replace("'", "''") & "', Posted_UserName = " & IIf(Me.chkPost.Checked = True, "N'" & LoginUserName & "'", "NULL") & "  where voucher_id=" & lngVoucherMasterId
                'End Task:M101
                objCommand.ExecuteNonQuery()
            Else

                objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                                    & " cheque_no, cheque_date,post,Source,voucher_code, Employee_Id, Reference,Remarks, UserName, Posted_UserName)" _
                                    & " VALUES(" & IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue) & ", 1,  7 , N'" & Me.txtPONo.Text & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                                    & " NULL, NULL, " & IIf(Me.chkPost.Checked = True, 1, 0) & ",N'" & Me.Name & "',N'" & Me.txtPONo.Text & "', " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ", N'" & _RefDocNo.Replace("'", "''") & "',N'" & Me.txtRemarks.Text.Replace("'", "''") & "', N'" & LoginUserName & "', " & IIf(Me.chkPost.Checked = True, "N'" & LoginUserName & "'", "NULL") & ")" _
                                    & " SELECT @@IDENTITY"
                'End Task:M101
                'objCommand.Transaction = trans
                lngVoucherMasterId = objCommand.ExecuteScalar

            End If


            ''==========================================

            objCommand.CommandText = ""
            objCommand.CommandText = "Delete from SalesDetailTable where SalesID = " & txtReceivingID.Text
            objCommand.ExecuteNonQuery()

            ''==========================================

            ''Start TFS1957 :Deleting Record Against Logical Item IN ProductAssemblyTable
            ''==========================================

            objCommand.CommandText = ""
            objCommand.CommandText = "Delete from ProductAssemblyTable where SalesID = " & txtReceivingID.Text
            objCommand.ExecuteNonQuery()

            ''==========================================
            ''End TFS1957
            '***********************
            'Deleting Detail
            '***********************
            objCommand.CommandText = ""
            objCommand.CommandText = "delete from tblVoucherDetail where voucher_Id =" & lngVoucherMasterId
            objCommand.ExecuteNonQuery()

            ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
            If VoucherId > 0 Then
                objCommand.CommandText = ""
                objCommand.CommandText = "delete from tblVoucherDetail where voucher_Id =" & VoucherId
                objCommand.ExecuteNonQuery()
            End If
            'End Task:2483

            ''==========================================

            ''make reversal of saved items in sale order detail table against poid
            If IsSOSeparateClosure = False Then
            If Not DeliveryChalanId > 0 Then
                If dtSavedItems.Rows.Count > 0 Then
                    If flgMultipleSalesOrder = False Then
                        If Not Me.cmbPo.SelectedIndex = -1 Then
                            For Each r As DataRow In dtSavedItems.Rows
                                objCommand.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(Isnull(DeliveredSchemeQty,0) - " & r.Item(1) & "),  DeliveredTotalQty = abs(Isnull(DeliveredTotalQty, 0) - " & r.Item(4) & ") where SalesOrderID = " & r("SO_ID") & " and ArticleDefID = " & r.Item(2) & " And SalesOrderDetailId = " & r.Item(5) & ""
                                objCommand.ExecuteNonQuery()
                            Next
                        End If
                    Else
                        For Each r As DataRow In dtSavedItems.Rows
                            objCommand.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(Isnull(DeliveredSchemeQty,0) - " & r.Item(1) & "), DeliveredTotalQty = abs(Isnull(DeliveredTotalQty, 0) - " & r.Item(4) & ") where SalesOrderID = " & r("SO_ID") & " and ArticleDefID = " & r.Item(2) & " And SalesOrderDetailId = " & r.Item(5) & " "
                            objCommand.ExecuteNonQuery()
                        Next
                    End If
                End If
                End If
            Else
                For Each r As DataRow In dtSavedItems.Rows
                    objCommand.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(Isnull(DeliveredSchemeQty,0) - " & r.Item(1) & "), DeliveredTotalQty = abs(Isnull(DeliveredTotalQty, 0) - " & r.Item(4) & ") where SalesOrderID = " & r("SO_ID") & " and ArticleDefID = " & r.Item(2) & " And SalesOrderDetailId = " & r.Item(5) & " "
                    objCommand.ExecuteNonQuery()
                Next

            End If

            'If dtSavedItems.Rows.Count > 0 Then
            '    If DeliveryChalanId > 0 Then
            '        For Each r As DataRow In dtSavedItems.Rows
            '            objCommand.CommandText = "Update DeliveryChalanDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(Isnull(DeliveredSchemeQty,0) - " & r.Item(1) & ") where DeliveryId = " & DeliveryChalanId & " and ArticleDefID = " & r.Item(2) & ""
            '            objCommand.ExecuteNonQuery()
            '        Next
            '    End If
            'End If



            objCommand.CommandText = ""
            StockList = New List(Of StockDetail)
            For i = 0 To grd.GetRows.Length - 1
                'If CheckStock(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.LocationID).Value.ToString), Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value.ToString, Me.grd.GetRows(i).Cells(EnumGridDetail.Item).Value.ToString, Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value, Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) Then
                '    If _Qty > 0 Then
                '        Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value = _Qty
                '        _Qty = 0
                '    End If
                '    If _TotalQty > 0 Then
                '        Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value = _TotalQty
                '        Me.grd.GetRows(i).Cells(EnumGridDetail.LoadQty).Value = _TotalQty
                '        _TotalQty = 0
                '    End If
                If blnCheckCurrentStockByItem = True Then
                    CheckCurrentStockByItem(IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)), IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)), Me.grd, Me.txtPONo.Text, trans)
                End If

                Dim CostPrice As Double = 0D
                Dim CrrStock As Double = 0D

                'Code Edit For TFS1153
                'DiscountedPrice = Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value - Me.grd.GetRows(i).Cells(EnumGridDetail.Price).Value
                'DiscountedPrice = Me.grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value - Me.grd.GetRows(i).Cells(EnumGridDetail.Price).Value
                DiscountedPrice = Me.grd.GetRows(i).Cells(EnumGridDetail.DiscountValue).Value

                If GLAccountArticleDepartment = True Then
                    'Comment against task:2390
                    'AccountId = Val(grd.GetRows(i).Cells("SalesAccountId").Value.ToString)
                    'Task:2390 Change Inventory Account Id
                    InvAccountId = Val(grd.GetRows(i).Cells("InvAccountId").Value.ToString)
                    AccountId = Val(grd.GetRows(i).Cells("SalesAccountId").Value.ToString)
                    CgsAccountId = Val(grd.GetRows(i).Cells("CGSAccountId").Value.ToString)

                End If

                If blnTradePriceExceed = True Then
                    If Val(Me.grd.GetRows(i).Cells("TradePrice").Value.ToString) > Val(Me.grd.GetRows(i).Cells("Rate").Value.ToString) Then
                        'ShowErrorMessage("Sales Price is less than trade price" & (Chr(13)) & "Do u want to add this item?")
                        Throw New Exception(" Sale price is less than trade price.")
                    End If
                End If

                'Task:2415 Check Duplicate Engine No.
                'If flgVehicleIdentificationInfo = True Then
                '    objCommand.CommandText = ""
                '    'objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, StockDetailTable.Engine_No, StockDetailTable.Chassis_No " _
                '    '                                & " FROM dbo.ArticleDefTable INNER JOIN " _
                '    '                                & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId WHERE StockTransId in (Select StockTransId From StockMasterTable WHERE DocNo <> N'" & Me.txtPONo.Text.Replace("'", "''") & "') "
                '    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                '    '    objCommand.CommandText += " AND StockDetailTable.Engine_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "'"
                '    'End If
                '    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                '    '    objCommand.CommandText += " AND StockDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                '    'End If
                '    objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, StockDetailTable.Engine_No, StockDetailTable.Chassis_No " _
                '                                   & " FROM dbo.ArticleDefTable INNER JOIN " _
                '                                   & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE StockDetailTable.StockTransId in (Select StockTransId From StockMasterTable WHERE DocNo <> N'" & Me.txtPONo.Text.Replace("'", "''") & "') AND LEFT(StockMasterTable.DocNo,2)='SI' "
                '    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                '    objCommand.CommandText += " AND StockDetailTable.Engine_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "' "
                '    'End If
                '    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                '        objCommand.CommandText += " AND StockDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                '    End If
                '    Dim dtVehicleIdentificationInfo As New DataTable
                '    Dim daVehicleIdentificationInfo As New OleDbDataAdapter(objCommand)
                '    daVehicleIdentificationInfo.Fill(dtVehicleIdentificationInfo)


                '    ''Task:2527 Engine_No and Chassis No Data From Sales Return
                '    objCommand.CommandText = ""
                '    objCommand.CommandText = "SELECT dbo.SalesReturnDetailTable.ArticleDefId, SalesReturnDetailTable.Engine_No, SalesReturnDetailTable.Chassis_No  " _
                '                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                '                                    & " dbo.SalesReturnDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesReturnDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0 And SalesReturnId in (Select SalesReturnId From SalesReturnMasterTable WHERE SalesReturnNo <> N'" & Me.txtPONo.Text.Replace("'", "''") & "')"
                '    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                '    objCommand.CommandText += " AND SalesReturnDetailTable.Engine_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "'"
                '    'End If
                '    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                '        objCommand.CommandText += " AND SalesReturnDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                '    End If
                '    Dim dtSalesReturnVehichleInfo As New DataTable
                '    Dim daSalesReturnVehichleInfo As New OleDbDataAdapter(objCommand)
                '    daSalesReturnVehichleInfo.Fill(dtSalesReturnVehichleInfo)
                '    'End Task:2527

                '    'If dtVehicleIdentificationInfo IsNot Nothing Then
                '    '    If dtVehicleIdentificationInfo.Rows.Count > 0 Then

                '    If dtVehicleIdentificationInfo IsNot Nothing AndAlso dtSalesReturnVehichleInfo IsNot Nothing Then
                '        If dtVehicleIdentificationInfo.Rows.Count > 0 Then
                '            If dtVehicleIdentificationInfo.Rows.Count > dtSalesReturnVehichleInfo.Rows.Count Then
                '                If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Or dtVehicleIdentificationInfo.Rows(0).Item("Engine_No").ToString.Length > 0 Then
                '                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString = dtVehicleIdentificationInfo.Rows(0).Item("Engine_No").ToString Then
                '                        Throw New Exception("Engine no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "] already exists")
                '                    End If
                '                End If
                '                If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Or dtVehicleIdentificationInfo.Rows(0).Item("Chassis_No").ToString.Length > 0 Then
                '                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString = dtVehicleIdentificationInfo.Rows(0).Item("Chassis_No").ToString Then
                '                        Throw New Exception("Chassis no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "] already exists")
                '                    End If
                '                End If
                '            End If
                '        End If
                '    End If
                'End If
                If flgVehicleIdentificationInfo = True Then
                    ''Stuff(ArticleCode, 1, 4, '')
                    ''Retrieving Engine No
                    Dim Engine_No As String = ""
                    Dim Chassis_No As String = ""
                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                        Engine_No = Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Substring(4)
                    End If
                    If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                        Chassis_No = Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Substring(4)
                    End If
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesDetailTable.ArticleDefId, Stuff(SalesDetailTable.Engine_No, 1, 4, '') As Engine_No, Stuff(SalesDetailTable.Chassis_No, 1, 4, '') As Chassis_No " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"
                    If Engine_No.Length > 0 Then
                        objCommand.CommandText += " AND Stuff(SalesDetailTable.Engine_No, 1, 4, '') =N'" & Engine_No & "'"
                    End If
                    'Dim dt As DataTable = GetDataTable(objCommand.CommandText)
                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND DeliveryChalanDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                    'End If
                    Dim dtVehicleEngineNoIdentificationInfo As New DataTable
                    Dim daVehicleEngineNoIdentificationInfo As New OleDbDataAdapter(objCommand)
                    daVehicleEngineNoIdentificationInfo.Fill(dtVehicleEngineNoIdentificationInfo)

                    ''Retrieving Chasis No
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesDetailTable.ArticleDefId, Stuff(SalesDetailTable.Engine_No, 1, 4, '') As Engine_No, Stuff(SalesDetailTable.Chassis_No, 1, 4, '') As Chassis_No " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"
                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND DeliveryChalanDetailTable.Engine_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "'"
                    'End If
                    If Chassis_No.Length > 0 Then
                        objCommand.CommandText += " AND Stuff(SalesDetailTable.Chassis_No, 1, 4, '') =N'" & Chassis_No & "'"
                    End If
                    Dim dtVehicleChasisNoIdentificationInfo As New DataTable
                    Dim daVehicleChasisNoIdentificationInfo As New OleDbDataAdapter(objCommand)
                    daVehicleChasisNoIdentificationInfo.Fill(dtVehicleChasisNoIdentificationInfo)

                    'Task:2606 Engine_No and Chassis No Data From Sales Return
                    ''Retrieving Return Engine No
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesReturnDetailTable.ArticleDefId, SalesReturnDetailTable.Engine_No, SalesReturnDetailTable.Chassis_No  " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesReturnDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesReturnDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"

                    objCommand.CommandText += " AND Stuff(SalesReturnDetailTable.Engine_No, 1, 4, '')=N'" & Engine_No & "'"


                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND SalesReturnDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                    'End If
                    Dim dtSalesReturnVehichleEngineNoInfo As New DataTable
                    Dim daSalesReturnVehichleEngineNoInfo As New OleDbDataAdapter(objCommand)
                    daSalesReturnVehichleEngineNoInfo.Fill(dtSalesReturnVehichleEngineNoInfo)

                    ''Retrieving Return Chasis No
                    objCommand.CommandText = ""
                    objCommand.CommandText = "SELECT dbo.SalesReturnDetailTable.ArticleDefId, SalesReturnDetailTable.Engine_No, SalesReturnDetailTable.Chassis_No  " _
                                                    & " FROM dbo.ArticleDefTable INNER JOIN " _
                                                    & " dbo.SalesReturnDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.SalesReturnDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId <> 0"

                    objCommand.CommandText += " AND Stuff(SalesReturnDetailTable.Chassis_No, 1, 4, '')=N'" & Chassis_No & "'"


                    'If Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                    '    objCommand.CommandText += " AND SalesReturnDetailTable.Chassis_No=N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "'"
                    'End If
                    Dim dtSalesReturnVehichleChasisNoInfo As New DataTable
                    Dim daSalesReturnVehichleChasisNoInfo As New OleDbDataAdapter(objCommand)
                    daSalesReturnVehichleChasisNoInfo.Fill(dtSalesReturnVehichleChasisNoInfo)

                    If dtVehicleEngineNoIdentificationInfo IsNot Nothing Then
                        If dtVehicleEngineNoIdentificationInfo.Rows.Count > 0 Then
                            If dtVehicleEngineNoIdentificationInfo.Rows.Count > dtSalesReturnVehichleEngineNoInfo.Rows.Count Then
                                If dtVehicleEngineNoIdentificationInfo.Rows(0).Item("Engine_No").ToString.Length > 0 Or Engine_No.Length > 0 Then
                                    If Engine_No = dtVehicleEngineNoIdentificationInfo.Rows(0).Item("Engine_No").ToString Then
                                        Throw New Exception("Engine no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString & "] already exists")
                                    End If
                                End If
                            End If
                        End If
                    End If

                    If dtVehicleChasisNoIdentificationInfo IsNot Nothing Then
                        If dtVehicleChasisNoIdentificationInfo.Rows.Count > 0 Then
                            If dtVehicleChasisNoIdentificationInfo.Rows.Count > dtSalesReturnVehichleChasisNoInfo.Rows.Count Then
                                If dtVehicleChasisNoIdentificationInfo.Rows(0).Item("Chassis_No").ToString.Length > 0 Or Chassis_No.Length > 0 Then
                                    If Chassis_No = dtVehicleChasisNoIdentificationInfo.Rows(0).Item("Chassis_No").ToString Then
                                        Throw New Exception("Chassis no [" & Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString & "] already exists")
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
                'End Task:2415

                'Dim CostPrice As Double = 0D
                'Dim CrrStock As Double = 0D
                'If flgCgsVoucher = True Then 'Comment against task TASK 2517 PL and Item Problem
                Dim dblPurchasePrice As Double = 0D
                Dim dblCostPrice As Double = 0D
                Dim dblcurrencyamount As Double = 0D
                Dim strData As String
                If flgAvgRate = True Then

                    Dim ClosingDate As DateTime = Convert.ToDateTime(getConfigValueByType("EndOfDate").ToString)
                    strData = "Select ArticleDefID, IsNull(SUM(IsNull(InQty,0)-IsNull(OutQty,0)),0) as BalanceQty, SUM((IsNull(InAmount,0))-(IsNull(OutAmount,0))) as BalanceAmount, IsNull(SUM(IsNull(InQty, 0) - IsNull(OutQty, 0)), 0) AS CheckStock From StockDetailTable INNER JOIN StockMasterTable On StockMasterTable.StockTransId = StockDetailTable.StockTransId WHERE ArticleDefID=" & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & " AND StockMasterTable.DocDate < '" & dtpPODate.Value & "' Group By ArticleDefId "

                    'Dim dblCostPrice As Double = 0D
                    Dim dtLastestPriceData As New DataTable
                    dtLastestPriceData = GetDataTable(strData, trans)
                    dtLastestPriceData.AcceptChanges()

                    If dtLastestPriceData.Rows.Count > 0 Then
                        If Val(dtLastestPriceData.Rows(0).Item(1).ToString) > 0 Then
                            dblCostPrice = Val(Val(dtLastestPriceData.Rows(0).Item(2).ToString) / Val(dtLastestPriceData.Rows(0).Item(1).ToString))
                        End If
                    End If

                Else

                    Dim strPriceData() As String = GetRateByItem(IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString))).Split(",")

                    If strPriceData.Length > 1 Then
                        dblCostPrice = Val(strPriceData(0).ToString)
                        dblPurchasePrice = Val(strPriceData(1).ToString)
                        dblcurrencyamount = Val(strPriceData(2).ToString)
                        If dblCostPrice = 0 Then
                            dblCostPrice = dblPurchasePrice
                        End If
                    End If
                End If
                If flgAvgRate = True Then 'Set Status TASK 2517 PL and Item Problem
                    'CostPrice = Val(grd.GetRows(i).Cells("CostPrice").Value.ToString) 'Task:3435 Set CostPrice Value

                    'If CostPrice = 0 Then
                    '    objCommand.CommandText = ""
                    '    'Before against task:2435
                    '    'objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, 0 as PurchasePrice, ABS(Convert(float, SUM(Isnull(dbo.StockDetailTable.InQty,0) - Isnull(dbo.StockDetailTable.OutQty,0)))) AS qty, ABS(SUM(Isnull(dbo.StockDetailTable.InAmount,0) - Isnull(dbo.StockDetailTable.OutAmount,0))) as Amount  " _
                    '    '                                & " FROM dbo.ArticleDefTable INNER JOIN " _
                    '    '                                & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId=" & grd.GetRows(i).Cells("ArticleDefId").Value & " AND StockTransId in (Select StockTransId From StockMasterTable WHERE DocNo <> N'" & Me.txtPONo.Text.Replace("'", "''") & "')" _
                    '    '                                & " GROUP BY dbo.StockDetailTable.ArticleDefId "
                    '    'Before against task:2712
                    '    'Task:2435 Filter by Date
                    '    'objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, 0 as PurchasePrice, ABS(Convert(float, SUM(Isnull(dbo.StockDetailTable.InQty,0) - Isnull(dbo.StockDetailTable.OutQty,0)))) AS qty, ABS(SUM(Isnull(dbo.StockDetailTable.InAmount,0) - Isnull(dbo.StockDetailTable.OutAmount,0))) as Amount  " _
                    '    '                              & " FROM dbo.ArticleDefTable INNER JOIN " _
                    '    '                              & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId=" & grd.GetRows(i).Cells("ArticleDefId").Value & " AND StockTransId in (Select StockTransId From StockMasterTable WHERE DocNo <> N'" & Me.txtPONo.Text.Replace("'", "''") & "' AND  (Convert(Varchar, DocDate, 102) <= Convert(DateTime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102)))" _
                    '    '                              & " GROUP BY dbo.StockDetailTable.ArticleDefId "
                    '    'End Task:2435
                    '    'Task:2712 Rounded Amount
                    '    objCommand.CommandText = "SELECT dbo.StockDetailTable.ArticleDefId, 0 as PurchasePrice, ABS(Convert(float, SUM(Isnull(dbo.StockDetailTable.InQty,0) - Isnull(dbo.StockDetailTable.OutQty,0)))) AS qty, Round(ABS(SUM(Isnull(dbo.StockDetailTable.InAmount,0) - Isnull(dbo.StockDetailTable.OutAmount,0))),1) as Amount  " _
                    '                               & " FROM dbo.ArticleDefTable INNER JOIN " _
                    '                               & " dbo.StockDetailTable ON dbo.ArticleDefTable.ArticleId = dbo.StockDetailTable.ArticleDefId WHERE dbo.ArticleDefTable.ArticleId=" & grd.GetRows(i).Cells("ArticleDefId").Value & " AND StockTransId in (Select StockTransId From StockMasterTable WHERE DocNo <> N'" & Me.txtPONo.Text.Replace("'", "''") & "' AND  (Convert(Varchar, DocDate, 102) <= Convert(DateTime, N'" & Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") & "', 102)))" _
                    '                               & " GROUP BY dbo.StockDetailTable.ArticleDefId "
                    '    'End Task:2712

                    '    Dim dtCrrStock As New DataTable
                    '    Dim daCrrStock As New OleDbDataAdapter(objCommand)
                    '    daCrrStock.Fill(dtCrrStock)
                    '    If dtCrrStock IsNot Nothing Then
                    '        If dtCrrStock.Rows.Count > 0 Then
                    '            'Before against ta sk:2401
                    '            'If Val(grd.GetRows(i).Cells("rate").Value) <> 0 Then
                    '            If Val(grd.GetRows(i).Cells("rate").Value) <> 0 AndAlso Val(dtCrrStock.Rows(0).Item("qty").ToString) <> 0 Then
                    '                'End Task:2401
                    '                CrrStock = dtCrrStock.Rows(0).Item(2)
                    '                CostPrice = IIf(Val(dtCrrStock.Rows(0).Item(3).ToString) = 0, 0, Val(dtCrrStock.Rows(0).Item(3)) / CrrStock)
                    '            Else
                    '                CostPrice = Val(grd.GetRows(i).Cells("PurchasePrice").Value)
                    '            End If
                    '        Else
                    '            CostPrice = Val(grd.GetRows(i).Cells("PurchasePrice").Value)
                    '        End If
                    '    End If
                    'End If
                    'Tsk:2517 Set Cost Price Of Purchase Price
                    'If dblCostPrice > 0 Then
                    CostPrice = dblCostPrice 'Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString)
                    'Else
                    '    CostPrice = dblPurchasePrice
                    'End If
                Else
                'CostPrice = IIf(Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString) <= 0, Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString), Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString))
                CostPrice = dblPurchasePrice 'Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString)
                currencyamount = dblcurrencyamount
                'End Task:2517
                End If
                ''Start TFS1957
                ''TASK TFS3324 on 31-05-2018
                Dim IsLogicalItemStockMade As Boolean = False
                If CType(grd.GetRows(i).Cells("LogicalItem").Value, Boolean) = True Then
                    ''Below line is commented on 31-05-2018 against TASK TFS3324
                    'FillModelOfStockDetail(grd.GetRows(i).Cells("ArticleDefId").Value, grd.GetRows(i).Cells("LocationId").Value, Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString), grd.GetRows(i).Cells("Comments").Value.ToString)
                    IsLogicalItemStockMade = GetItemsOfLogicalItem(grd.GetRows(i).Cells("ArticleDefId").Value, grd.GetRows(i).Cells("LocationId").Value, Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString), grd.GetRows(i).Cells("Comments").Value.ToString, objCommand)
                End If
                ''
                ''

                ''End TFS1957
                Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & ""
                Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem, trans)
                dt2serviceitem.AcceptChanges()
                Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem1 = False Then
                    If CType(grd.GetRows(i).Cells("LogicalItem").Value, Boolean) = False Or IsLogicalItemStockMade = False Then
                        If (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) > 0 Or Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString) > 0) Then
                            StockDetail = New StockDetail
                            StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                            StockDetail.LocationId = grd.GetRows(i).Cells("LocationId").Value
                            StockDetail.ArticleDefId = IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString))
                            StockDetail.InQty = 0
                            If IsSalesOrderAnalysis = True Then
                                ''TASK-408
                                StockDetail.OutQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString)
                                'StockDetail.OutQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value), ((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * Val(grd.GetRows(i).Cells("Pack Qty").Value)))  ''Commented row on 10-06-2016 for TotalQty
                            Else
                                ''TASK-408
                                StockDetail.OutQty = Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) + Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString)                        'StockDetail.OutQty = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value), ((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * Val(grd.GetRows(i).Cells("Pack Qty").Value))) ''Commented row on 10-06-2016 for TotalQty
                            End If
                            If flgAvgRate = True Then
                                StockDetail.Rate = CostPrice
                            Else
                                StockDetail.Rate = Val(grd.GetRows(i).Cells(EnumGridDetail.PurchasePrice).Value)
                            End If

                            StockDetail.InAmount = 0
                            ''TASK-408
                            StockDetail.OutAmount = ((Val(grd.GetRows(i).Cells("TotalQty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * StockDetail.Rate) ''TASK-408
                            'StockDetail.OutAmount = IIf(grd.GetRows(i).Cells("Unit").Value = "Loose", ((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * IIf(CostPrice = 0, Val(grd.GetRows(i).Cells(EnumGridDetail.PurchasePrice).Value), CostPrice)), (((Val(grd.GetRows(i).Cells("Qty").Value) + Val(grd.GetRows(i).Cells("Sample Qty").Value)) * Val(grd.GetRows(i).Cells("Pack Qty").Value)) * IIf(CostPrice = 0, Val(grd.GetRows(i).Cells(EnumGridDetail.PurchasePrice).Value), CostPrice))) ''Commented row on 10-06-2016 against TASK-408 for TotalQty
                            StockDetail.Remarks = grd.GetRows(i).Cells("Comments").Value.ToString
                            'Task:M16 Set Values In Engine_No and Chassis_No 
                            StockDetail.Engine_No = grd.GetRows(i).Cells("Engine_No").Value.ToString
                            StockDetail.Chassis_No = grd.GetRows(i).Cells("Chassis_No").Value.ToString
                            'End Task:M16
                            CostPrice = StockDetail.Rate
                            StockDetail.CostPrice = CostPrice
                            ''Start TASK-470
                            StockDetail.PackQty = Val(grd.GetRows(i).Cells("Pack Qty").Value.ToString)
                            StockDetail.Out_PackQty = Val(grd.GetRows(i).Cells("Qty").Value.ToString)
                            StockDetail.In_PackQty = 0
                            ''End TASK-470
                            ''Start TASK-TFS1596
                            StockDetail.BatchNo = grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString
                            StockDetail.ExpiryDate = CType(grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value, Date).ToString("yyyy-M-d h:mm:ss tt")
                            ''End TASK-1596
                            StockDetail.Origin = grd.GetRows(i).Cells("Origin").Value.ToString
                            StockList.Add(StockDetail)
                        End If
                    End If
                    ''END TASK TFS3324
                End If
                Dim TotalQty As Double = 0
                TotalQty = Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Qty), Janus.Windows.GridEX.AggregateFunction.Sum))
                Dim TransCharges As Double = 0
                TransCharges = Val(Val(Me.txtTransCharges.Text) / TotalQty)

                objCommand.CommandText = ""

                ''TFS1153 Added flat discount column
                ''TFS1154 Added RetailPrice column
                ''TFS1153 Added column DiscountId, DiscountType, DiscountValue,DiscountFactor , PostDiscountPrice
                ''Query Edit Aganist TFS3528 : Ayesha Rehman : 19-06-2018
                objCommand.CommandText = "Insert into SalesDetailTable (SalesId, ArticleDefId,ArticleSize, Sz1,Qty,Price, Sz7,CurrentPrice,BatchNo, BatchID, LocationId, TaxPercent, SampleQty, SEDPercent,TradePrice,RetailPrice, Discount_Percentage, DiscountId, DiscountType, DiscountValue, DiscountFactor, PostDiscountPrice, Freight, MarketReturns,SO_ID,LoadQty, PurchasePrice, PackPrice, Comments,Pack_Desc, Engine_No, Chassis_No, CostPrice,ExpiryDate,Other_Comments,SalesReturnQty,DeliveryChalanId, DeliveryChalanDetailId,Transport_Charges,ApplyAdjustmentFuelExp, SO_Detail_ID,Gross_Weights,Tray_Weights,Net_Weights, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, CurrencyAmount, FlatDiscount, OldSalePrice, SalePriceProcessId, BardanaDeduction, OtherDeduction, Origin, AlternativeItem, AlternativeItemId) values( " _
                                 & " " & txtReceivingID.Text & " ," & Val(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value) & ",N'" & (grd.GetRows(i).Cells(EnumGridDetail.Unit).Value) & "'," & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", " _
                                 & " " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & ", " _
                                 & Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) & " , " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) & ",N'" & grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString.Replace("'", "''") & "', " _
                                 & grd.GetRows(i).Cells(EnumGridDetail.BatchID).Value & " , " & grd.GetRows(i).Cells(EnumGridDetail.LocationID).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value.ToString = "", 0, grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value.ToString()) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SED).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TradePrice).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.RetailPrice).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value.ToString) & " , " & grd.GetRows(i).Cells(EnumGridDetail.DiscountId).Value & ",'" & grd.GetRows(i).Cells(EnumGridDetail.DiscountType).Value.ToString.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.DiscountValue).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.DiscountFactor).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Freight).Value) & "," & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.MarketReturns).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.LoadQty).Value) & "," & Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackPrice).Value.ToString) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells(EnumGridDetail.Pack_Desc).Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "', " & CostPrice & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value.ToString = "", "NULL", "Convert(DateTime,N'" & CDate(IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value.ToString = "", Date.Now, Me.grd.GetRows(i).Cells(EnumGridDetail.ExpiryDate).Value)).ToString("yyyy-M-d hh:mm:ss tt") & "',102)") & ", N'" & grd.GetRows(i).Cells("Other Comments").Value.ToString.Replace("'", "''") & "'," & Val(Me.grd.GetRows(i).Cells("SalesReturnQty").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("DeliveryChalanId").Value.ToString) & "," & Val(Me.grd.GetRows(i).Cells("DeliveryChalanDetailId").Value.ToString) & "," & IIf(Val(TransCharges) > 0, Val(TransCharges), Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString)) & "," & IIf(Convert.ToBoolean(grd.GetRows(i).Cells(EnumGridDetail.ApplyAdjustmentFuelExp).Value) = True, 1, 0) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value) & "," & Val(grd.GetRows(i).Cells(EnumGridDetail.Gross_Weights).Value) & "," & Val(grd.GetRows(i).Cells(EnumGridDetail.Tray_Weights).Value) & "," & Val(grd.GetRows(i).Cells(EnumGridDetail.Net_Weight).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.FlatDiscount).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.OldSalePrice).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.SalePriceProcessId).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.BardanaDeduction).Value.ToString) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.OtherDeduction).Value.ToString) & ",N'" & grd.GetRows(i).Cells("Origin").Value & "', N'" & grd.GetRows(i).Cells(EnumGridDetail.AlternativeItem).Value.ToString & "', " & Val(grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) & ") Select @@Identity"

                Dim intSalesDetailId As Integer = 0I
                intSalesDetailId = objCommand.ExecuteScalar()

                ''Start TFS1957
                '' Below three lines are commented against TASK TFS3324
                'If CType(grd.GetRows(i).Cells("LogicalItem").Value, Boolean) = True Then
                '    FillAssemblyProductTable(grd.GetRows(i).Cells("ArticleDefId").Value, grd.GetRows(i).Cells("LocationId").Value)
                'End If
                ''End TFS1957

                objCommand.CommandText = ""
                objCommand.CommandText = "Update SalesCertificateTable Set SalesDetailId=" & intSalesDetailId & " WHERE SalesId=" & Val(Me.txtReceivingID.Text) & " AND SalesDetailId=" & Val(grd.GetRows(i).Cells("CR_SalesDetailId").Value.ToString) & ""
                objCommand.ExecuteNonQuery()

                objCommand.CommandText = ""
                objCommand.CommandText = "Update SalesDetailTable Set SaleCertificateId=" & Val(grd.GetRows(i).Cells("SaleCertificateId").Value.ToString) & " WHERE SalesId=" & Val(Me.txtReceivingID.Text) & " AND SaleDetailId=" & intSalesDetailId & ""
                objCommand.ExecuteNonQuery()

                'TaskM610151 New SalesDetaild Update In Sales Return Detail Table, because there is exist partial sales return qty
                objCommand.CommandText = ""
                objCommand.CommandText = "Update SalesReturnDetailTable Set RefSalesDetailId=" & intSalesDetailId & " WHERE SalesReturnId In(Select SalesReturnId From SalesReturnMasterTable WHERE POId=" & Val(Me.txtReceivingID.Text) & ") AND RefSalesDetailId=" & Val(grd.GetRows(i).Cells("SaleDetailId").Value.ToString) & ""
                objCommand.ExecuteNonQuery()

                'End TaskM610151

                'Val(grd.Rows(i).Cells(5).Value)
                'Update SO and SO Detail
                If Val(grd.GetRows(i).Cells("TotalQty").Value) <> 0 Or Val(grd.GetRows(i).Cells("Sample Qty").Value) <> 0 Then
                    If IsSOSeparateClosure = False Then
                        If Not DeliveryChalanId > 0 Then
                            If flgMultipleSalesOrder = False Then
                                If Not Me.cmbPo.SelectedIndex = -1 Then
                                    objCommand.CommandText = "UPDATE SalesOrderDetailTable " _
                                                                            & " SET DeliveredQty = isnull(DeliveredQty,0) + " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & ") , DeliveredTotalQty = ISNULL(DeliveredTotalQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " " _
                                                                           & " WHERE     (SalesOrderId = " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ") AND (ArticleDefId = " & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & ") AND (SalesOrderDetailId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value) & ")"
                                    objCommand.ExecuteNonQuery()

                                    'Else
                                End If
                            Else
                                If Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) > 0 Then
                                    objCommand.CommandText = "UPDATE SalesOrderDetailTable " _
                                                                           & " SET              DeliveredQty = isnull(DeliveredQty,0) + " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & "), DeliveredTotalQty = ISNULL(DeliveredTotalQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " " _
                                                                          & " WHERE     (SalesOrderId = " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ") AND (ArticleDefId = " & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & ") AND (SalesOrderDetailId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value) & ")"
                                    objCommand.ExecuteNonQuery()
                                End If
                            End If
                        End If

                    Else
                        If Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) > 0 Then
                            objCommand.CommandText = "UPDATE SalesOrderDetailTable " _
                                                                   & " SET              DeliveredQty = isnull(DeliveredQty,0) + " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & "), DeliveredTotalQty = ISNULL(DeliveredTotalQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " " _
                                                                  & " WHERE     (SalesOrderId = " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SO_ID).Value) & ") AND (ArticleDefId = " & IIf(Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString) <> 0, Val(Me.grd.GetRows(i).Cells(EnumGridDetail.AlternativeItemId).Value.ToString), Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString)) & ") AND (SalesOrderDetailId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.SODetailId).Value) & ")"
                            objCommand.ExecuteNonQuery()
                        End If
                    End If
                    'If DeliveryChalanId > 0 Then
                    '    objCommand.CommandText = "UPDATE DeliveryChalanDetailTable " _
                    '                                            & " SET              DeliveredQty = isnull(DeliveredQty,0) + " & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ", DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) + " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) & ") " _
                    '                                           & " WHERE     (DeliveryId = " & DeliveryChalanId & ") AND (ArticleDefId = " & Val(grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value) & ")"
                    '    objCommand.ExecuteNonQuery()
                    '    'Else
                    'End If
                End If

                'If Not ServiceItem = "True" Then
                Dim Deduction As Double = Val(grd.GetRows(i).Cells(EnumGridDetail.BardanaDeduction).Value.ToString) + Val(grd.GetRows(i).Cells(EnumGridDetail.OtherDeduction).Value.ToString)
                'Dim CurrencyDeduction As Double = (Val(grd.GetRows(i).Cells(EnumGridDetail.BardanaDeduction).Value.ToString) + Val(grd.GetRows(i).Cells(EnumGridDetail.OtherDeduction).Value.ToString)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString)
                If Val(Me.grd.GetRows(i).Cells("TotalQty").Value) <> 0 Or Val(grd.GetRows(i).Cells("Sample Qty").Value.ToString) <> 0 Then
                    If UnbuildCustomerId > 0 AndAlso AdjustmentAmountNew > 0 Then
                        Dim DiffAmount As Double = Val(InvoiceAmount) - Val(AdjustmentAmountNew)
                        If Val(InvoiceAmount) = Val(AdjustmentAmountNew) Then
                            objCommand.CommandText = ""
                            'Customer Debit
                            ''TASK TFS2741 Bardana and other deductions
                            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                            & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(txtCurrencyRate.Text) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "' )"
                            objCommand.ExecuteNonQuery()
                            objCommand.CommandText = ""
                            'UnBuild Customer A/C Credit
                            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & UnbuildCustomerId & ", " & 0 & ",  " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(txtCurrencyRate.Text) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"
                            objCommand.ExecuteNonQuery()
                        Else
                            objCommand.CommandText = ""
                            'Customer Debit
                            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                            & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "',N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "' )"

                            objCommand.ExecuteNonQuery()
                            objCommand.CommandText = ""
                            Dim CurrencyDiffAmount As Double
                            Dim CurrencyAdjustmentAmountNew As Double
                            If Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) > 1 Then
                                CurrencyDiffAmount = Val(DiffAmount) / Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString)
                                CurrencyAdjustmentAmountNew = Val(AdjustmentAmountNew) / Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString)
                            End If
                            'Net Sales A/C Credit
                            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & SalesAccount & ", " & 0 & ",  " & DiffAmount & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & CurrencyDiffAmount & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"
                            objCommand.ExecuteNonQuery()
                            objCommand.CommandText = ""
                            'Unbuild Customer A/C Credit
                            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & UnbuildCustomerId & ", " & 0 & ",  " & AdjustmentAmountNew & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & CurrencyAdjustmentAmountNew & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", N'" & Me.grd.GetRows(i).Cells("Engine_No").Value.ToString.Replace("'", "''") & "', N'" & Me.grd.GetRows(i).Cells("Chassis_No").Value.ToString.Replace("'", "''") & "')"
                            objCommand.ExecuteNonQuery()
                        End If
                    Else
                        If IsDiscountVoucher = False Then
                            If IsSalesOrderAnalysis = False Then
                                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                                objCommand.CommandText = ""
                                'Before agaginst task2369
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'Before against task:2391
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'End Task:2369
                                'Task:2391 Added Column ArticleDefId
                                ''// Work of adding Multi currency values on 14-10-2016 By Ameen
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & " )"
                                ''Commented below to add total quantity instead of Pack Qty * Qty against TASK-408
                                '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"
                                'End Task:2391
                                'objCommand.Transaction = trans
                                objCommand.ExecuteNonQuery()

                                '***********************
                                'Inserting Credit Amount
                                '***********************
                                'objCommand = New OleDbCommand
                                ' objCommand.Connection = Con
                                objCommand.CommandText = ""

                                '******************* Change For Cost Center ******************
                                ' By Imran Ali
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                                'Code By Imran Task Against Req #803
                                If flgExcludeTaxPrice = False Then
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change Comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Aidded Column ArticleDefId
                                    ''// Work of adding Multi currency values on 14-10-2016 By Ameen
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")"
                                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented on 10-06-2016 against TASK-408

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()
                                    'End Task:2369
                                Else
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change Comments 
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Added Column ArticleDefId
                                    ''// Work of adding Multi currency values on 14-10-2016 By Ameen
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) - ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) - Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TaxAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")"  ''TASK-408 Added TotalQty  
                                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented on 10-06-2016 against TASK-408

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()
                                    'End Task:2369


                                End If


                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"
                                ' objCommand.Transaction = trans
                                'objCommand.ExecuteNonQuery()
                            Else
                                ''''''''''''''''''' In Case Sales Order Analysis ----------------------------------------------
                                objCommand.CommandText = ""
                                'Before against task:2369
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, Direction, sp_refrence) " _
                                '                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'Before against task:2391
                                'Tsk:2369 Change Comments
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, Direction, sp_refrence) " _
                                '                                                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'End Task:2369
                                'Task:2391 Added Column ArticleDefId
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, Direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (((Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value - Deduction) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString)) & ", 0, N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408 added TotalQty instead of Loose & Pack variation
                                ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented on 10-06-2016 against TASK-408  

                                'End Task:2391

                                'objCommand.Transaction = trans
                                objCommand.ExecuteNonQuery()

                                '***********************
                                'Inserting Credit Amount
                                '***********************
                                'objCommand = New OleDbCommand
                                ' objCommand.Connection = Con
                                objCommand.CommandText = ""

                                '******************* Change For Cost Center ******************
                                ' By Imran Ali
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                                'Code By Imran Ali Task Against Req # 803
                                If flgExcludeTaxPrice = False Then
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change Comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Tas:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * (((Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString)) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0 ," & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")"     ''TASK-408 replaced Qty * Pack Qty with TotalQty
                                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"   ''Commented this row against TASK-408 for adding TotalQty

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()
                                    'End Task:2369
                                Else
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change Comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " , 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" '' TASK-408 added TotalQty instead Qty * Pack Qty
                                    ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented against TASK-408

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()
                                    'End Task:2369
                                End If

                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"
                                ' objCommand.Transaction = trans
                                'objCommand.ExecuteNonQuery()

                                '''''''''''''''''''''' Includ Discount Voucher ''''''''''''''''''''''''''''''''''''''''''
                                If DiscountedPrice > 0 Then
                                    objCommand.CommandText = ""
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                                & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against Task:2391 
                                    'Task:2369 Change 
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                                & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                    & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408 added TotalQty
                                    ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented below against TASK-408 to replace TotalQty with Qty * Pack Qty

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()
                                    'End Task:2369

                                End If
                            End If

                        Else

                            objCommand.CommandText = ""
                            'Before against task:2369
                            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                            '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ",0,N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                            'Before against task:2391
                            'Task:2369 Change Comments
                            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                            '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ",0,N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "'") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                            'End Task:2369
                            'Task:2391 Added Column ArticleDefId
                            ''Code Commented for TFS1153
                            'Price = Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)
                            'CurrentPrice = Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)
                            'If CurrentPrice = 0 Then
                            '    CurrentPrice = Price
                            'End If
                            'If Price < CurrentPrice Then
                            '    Price = CurrentPrice
                            'End If
                            ''Code Edit for TFS1153
                            'Changing Current Price To Post Discount Price
                            Price = Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)
                            PDP = Val(grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value)
                            If PDP = 0 Then
                                PDP = Price
                            End If
                            If Price < PDP Then
                                Price = PDP
                            End If

                            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Price * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ",0,N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "'") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Price & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408 replaced TotalQty with Pack Qty * Qty ''TFS1153
                            '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & "," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ",0,N'" & SetComments(Me.grd.GetRows(i)).Replace("" & Me.cmbVendor.Text & ",", "").Replace("'", "'") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row against TASK-408

                            'End Task:2391
                            objCommand.ExecuteNonQuery()

                            If DiscountedPrice > 0 Then
                                objCommand.CommandText = ""
                                'Before against task:2391
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'Task:2391 Added Column ArticleDefId
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                        & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * DiscountedPrice * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & DiscountedPrice * (Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) & ", 0 , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & " )" ''TASK-408 added TotalQty instead Pack Qty * Qty ''TFS1153
                                ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SalesDiscountAccount) & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " )" ''Commented this row against TASK-408

                                'End Task:2391
                                objCommand.ExecuteNonQuery()

                                objCommand.CommandText = ""
                                'Before against task:2391
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0," & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ",'Ref Discount On Sales: " & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & (DiscountedPrice) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                'Task:2391 Added Column ArticleDefId
                                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0," & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * DiscountedPrice * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ",N'Ref Discount On Sales: " & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & (DiscountedPrice) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & DiscountedPrice * (Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408 added TotalQty insted of Pack Qty * Qty or Qty ''TFS1153
                                'End Task:2391
                                objCommand.ExecuteNonQuery()

                                If flgExcludeTaxPrice = False Then
                                    objCommand.CommandText = ""
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change Comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                   & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) + DiscountedPrice & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408  ''TFS1153 : Changing Current Price To Post Discount Price
                                    ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"  ''Commented this row against TASK-408

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()
                                Else
                                    objCommand.CommandText = ""
                                    'Before against Task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                        & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change Comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Task:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " , 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408 added TotalQty instead of Pack Qty * Qty or Qty
                                    ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented against TASK-408

                                    'End Task:2391
                                    'End Task:2369

                                    objCommand.ExecuteNonQuery()

                                End If

                                'objCommand.ExecuteNonQuery()

                            Else

                                'objCommand.CommandText = ""
                                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction) " _
                                '                                                  & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ")"
                                'objCommand.ExecuteNonQuery()

                                If flgExcludeTaxPrice = False Then
                                    objCommand.CommandText = ""
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'End Task:2369
                                    'Task:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" '' TASK-408 added TotalQty instead of Pack Qty * Qty or Qty
                                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row against TASK-408

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()
                                Else
                                    'objCommand.CommandText = ""
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100)), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / 100), 2) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2369
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & ((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'Before against task:2391
                                    'Task:2369 Change Comments
                                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence) " _
                                    '                                                      & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                                    'End Task:2369
                                    'Task:2391 Added Column ArticleDefId
                                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value.ToString) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i), (Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) - Deduction)).Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408
                                    ''& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) - (Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value)) / (Val(grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) + 100))) & ", N'" & SetComments(Me.grd.GetRows(i)).Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row on 10-06-2016 against TASK-408 

                                    'End Task:2391
                                    objCommand.ExecuteNonQuery()

                                End If
                                'objCommand.ExecuteNonQuery()
                            End If
                        End If
                    End If
                End If

                'Else
                '    '***********************
                '    'Inserting Debit Amount
                '    '***********************
                '    If IsDiscountVoucher = False Then
                '        If Not IsSalesOrderAnalysis = True Then
                '            'objCommand.CommandText = ""
                '            ''objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '            ''                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"

                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '            '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"


                '            'objCommand.ExecuteNonQuery()

                '            ''***********************
                '            ''Inserting Credit Amount
                '            ''***********************
                '            'objCommand.CommandText = ""

                '            ''objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '            ''                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", 0,  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"

                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '            '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", 0,  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"

                '            ''objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '            ''                      & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"

                '            'objCommand.ExecuteNonQuery()

                '            'If UpdateVoucherEntry(7, txtPONo.Text, Me.dtpPODate.Value, "", Nothing, AccountId, Val(Me.cmbVendor.ActiveRow.Cells(0).Text.ToString), Val(Me.txtAmount.Text), Val(Me.txtAmount.Text), "Both", Me.Name, Me.txtPONo.Text, True) = False Then
                '            '    MsgBox("An error occured while updating voucher record could not updated")
                '            '    trans.Rollback()
                '            '    Update_Record = False
                '            '    Exit Function
                '            'End If
                '        Else
                '            objCommand.CommandText = ""
                '            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '                                                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ")"


                '            'objCommand.Transaction = trans
                '            objCommand.ExecuteNonQuery()

                '            '***********************
                '            'Inserting Credit Amount
                '            '***********************
                '            'objCommand = New OleDbCommand
                '            ' objCommand.Connection = Con
                '            objCommand.CommandText = ""

                '            '******************* Change For Cost Center ******************
                '            ' By Imran Ali
                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '            '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & ")' )"
                '            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '                                   & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.NetBill).Value) - IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value = 0, 0, (Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Tax).Value) / 100) * IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", ((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (((Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value) + Me.grd.GetRows(i).Cells(EnumGridDetail.SampleQty).Value) * Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value))) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ")"

                '            'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '            '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", " & 0 & ",  " & IIf(grd.Rows(i).Cells("Unit").Value = "Loose", (Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text), ((Val(grd.Rows(i).Cells("Qty").Value) * Val(grd.Rows(i).Cells("PackQty").Value)) * Val(grd.Rows(i).Cells("rate").Value)) + Val(Me.txtTaxTotal.Text)) & ", N'" & grd.Rows(i).Cells("item").Value & "(" & Val(grd.Rows(i).Cells("Qty").Value) & ")' )"
                '            ' objCommand.Transaction = trans
                '            objCommand.ExecuteNonQuery()

                '            '''''''''''''''''''''' Includ Discount Voucher ''''''''''''''''''''''''''''''''''''''''''
                '            objCommand.CommandText = ""
                '            objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '                                                                                      & " VALUES(" & lngVoucherMasterId & ", 1, " & Val(SalesDiscountAccount) & ", " & IIf(Me.grd.GetRows(i).Cells(EnumGridDetail.Unit).Text = "Loose", (((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100), ((((Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) * Val(Me.grd.GetRows(i).Cells(EnumGridDetail.Discount_Percentage).Value)) / 100)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & Math.Round((Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value),2), 2) & ")', " & cmbProject.SelectedValue & ")"
                '            objCommand.ExecuteNonQuery()
                '        End If
                '        'Else
                '        '    objCommand.CommandText = ""
                '        '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '        '                                                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.Price).Value)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"

                '        '    objCommand.ExecuteNonQuery()

                '        '    objCommand.CommandText = ""
                '        '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                '        '                                                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Val(SalesDiscountAccount) & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * DiscountedPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * DiscountedPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"

                '        '    objCommand.ExecuteNonQuery()

                '        '    objCommand.CommandText = ""
                '        '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId) " _
                '        '                                                  & " VALUES(" & lngVoucherMasterId & ", 1, " & AccountId & ", 0,  " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value), (Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * Val(grd.GetRows(i).Cells(EnumGridDetail.CurrentPrice).Value)) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.ServiceQty).Value) & ")', " & cmbProject.SelectedValue & ")"
                '        '    objCommand.ExecuteNonQuery()

                '        'End If
                '    End If
                Dim str As String = "Select ServiceItem from ArticleDefView where ArticleId = " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ""
                Dim dt2 As DataTable = GetDataTable(str, trans)
                dt2.AcceptChanges()
                Dim ServiceItem As Boolean = Val(dt2.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem = False Then
                    ''''''''''''''''''' Preparing Cost Of Sale Voucher ''''''''''''''''''''''''''''''
                    If flgCgsVoucher = True Then

                        objCommand.CommandText = ""
                        'Before against task:2391
                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                        '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & CgsAccountId & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                        'Task;2391 Added column ArticleDefId
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                 & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & CgsAccountId & ", " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val((Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408
                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & CgsAccountId & ", " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row on 10-06-2016 against TASK-408 replaced Pack Qty * Qty or Qty with TotalQty

                        'End Task:2391
                        objCommand.ExecuteNonQuery()

                        objCommand.CommandText = ""
                        'Before against task:2391
                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence) " _
                        '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "')"
                        'Before against task:2390
                        'Task:2391 Added Column ArticleDefId
                        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence,ArticleDefId) " _
                        '                                                                          & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & ")', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")"
                        'End Task:2391
                        'Task:2390 Change Inventory Account
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                  & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", 0, " & Val((Me.grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value.ToString) * CostPrice) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408
                        '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & InvAccountId & ", 0, " & IIf(grd.GetRows(i).Cells(EnumGridDetail.Unit).Value = "Loose", Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * CostPrice, (Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) * Val(grd.GetRows(i).Cells(EnumGridDetail.PackQty).Value)) * CostPrice) & ", N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.Qty).Value) & " X " & CostPrice & "), " & grd.GetRows(i).Cells(EnumGridDetail.Comments).Value.ToString.Replace("'", "''") & "', " & cmbProject.SelectedValue & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ")" ''Commented this row on 10-06-2016 against TASK-408

                        'End Task:2390
                        objCommand.ExecuteNonQuery()
                    End If
                    '''''''''''''''''''''''''''''' Code By Imran Ali 03/06/2013 '''''''''''''''''''''''''''''''''''''''
                End If




                ''''''''''''''''''''''''''''''''' Transport Charges ''''''''''''''''''''''''
                'If Me.cmbTransporter.SelectedIndex > 0 Then
                Dim intTransAccountID As Integer = Val(CType(Me.cmbTransporter.SelectedItem, DataRowView).Row.Item("AccountID").ToString)
                If intTransAccountID > 0 Then
                    If Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString) > 0 Then

                        objCommand.CommandText = ""
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                 & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & OtherExpAccount & ", " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString)) & ", 0, N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & Val(grd.GetRows(i).Cells("Transport_Charges").Value.ToString) & ")" & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408 added TotalQty instead of Qty
                        objCommand.ExecuteNonQuery()


                        objCommand.CommandText = ""
                        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence,ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate) " _
                                                                                                 & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & intTransAccountID & ",0, " & (Val(grd.GetRows(i).Cells("TotalQty").Value.ToString) * Val(Me.grd.GetRows(i).Cells("Transport_Charges").Value.ToString)) & ",  N'" & grd.GetRows(i).Cells(EnumGridDetail.Item).Value & "  " & Me.grd.GetRows(i).Cells(EnumGridDetail.Size).Value & " " & "(" & Val(grd.GetRows(i).Cells(EnumGridDetail.TotalQty).Value) & " X " & Val(grd.GetRows(i).Cells("Transport_Charges").Value.ToString) & ")" & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", " & grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.ArticleID).Value.ToString) & " , 0, " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyAmount).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ")" ''TASK-408 added TotalQty instead of Qty
                        objCommand.ExecuteNonQuery()

                    End If
                End If
                'Else
                'If grd.RowCount = 1 Then
                '    Exit Function
                'End If
                'End If

            Next

            '***********************
            '06-Dec-2011    Added for Fuel, Other Expense, Adjustment
            '***********************
            'Task 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 

            Dim CurrencyRate As Double = 0
            CurrencyRate = Val(Me.grd.GetRow.Cells(EnumGridDetail.CurrencyRate).Value.ToString)

            If ExpenseChargeToCustomer = False Then
                ''Fuel
                If Val(Me.txtFuel.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"
                    'Task 1620 Added for DebitAmount Ayesha Rehman 
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 0, 'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", " & Val(Me.txtFuel.Text) & "," & 0 & ")"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", 0 , " & Val(Me.txtFuel.Text) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 'Fuel Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & "," & 0 & ", " & Val(Me.txtFuel.Text) & " )"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If

            '--------------------------- Fuel Expense Credit
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If ExpenseChargeToCustomer = True Then
                If Val(Me.txtFuel.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtFuel.Text)) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 0, 'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", " & Val(Me.txtFuel.Text) & "," & 0 & " )"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId,sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtFuel.Text)) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 'Fuel Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & "," & 0 & ", " & Val(Me.txtFuel.Text) & " )"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If ExpenseChargeToCustomer = False Then
                ''Other Exp
                If Val(Me.txtExpense.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 0, 'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", " & Val(Me.txtExpense.Text) & "," & 0 & ")"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 'Expense Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & "," & 0 & ", " & Val(Me.txtExpense.Text) & " )"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
                ''end Other Exp
            End If



            '---------------------- Other Expense Credit
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If ExpenseChargeToCustomer = True Then
                If Val(Me.txtExpense.Text) > 0 Then

                    'objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtExpense.Text)) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 0, 'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", " & Val(Me.txtExpense.Text) & "," & 0 & ")"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence,BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtExpense.Text)) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 'Expense Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & "," & 0 & ", " & Val(Me.txtExpense.Text) & ")"
                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If Val(Me.txtAddTransitInsurance.Text) > 0 Then

                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId,sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtAddTransitInsurance.Text) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 0, 'Transit Insurace Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", " & Val(Me.txtAddTransitInsurance.Text) & "," & 0 & " )"

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(InsuranceAccountId) & ", " & 0 & ",  " & Val(Me.txtAddTransitInsurance.Text) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 'Transit Insurace Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & "," & 0 & ", " & Val(Me.txtAddTransitInsurance.Text) & " )"
                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


            End If
            'Task 1620 25-10-2017 Ayesha Rehman Currency Based Control on sales Screen 
            If Val(Me.txtAdjustment.Text) > 0 Then

                'objCommand.CommandText = ""
                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.AdjustmentExpAccount & ", " & Val(Me.txtAdjustment.Text) & ", 0, 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.AdjustmentExpAccount & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 0, 'Adjustment Ref: " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & "," & 0 & " )"

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) * IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & ", 'Adjustment Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & IIf(IsEditMode = True, CurrencyRate, Val(Me.txtCurrencyRate.Text)) & "," & 0 & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) & " )"

                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()
            End If

            '***********************
            '01-Feb-2011    Added for tax calculation
            '***********************

            If Val(Me.txtTaxTotal.Text) > 0 Then

                'If flgExcludeTaxPrice = False Then
                '    objCommand.CommandText = ""
                '    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
                '    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtTaxTotal.Text) & ", 0, 'Tax Ref: " & Me.txtPONo.Text & "' )"
                '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                '                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtTaxTotal.Text) & ", 0, N'Tax Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & Val(Me.txtTaxTotal.Text) / Val(Me.txtCurrencyRate.Text) & ", " & 0 & ")"


                '    'objCommand.Transaction = trans
                '    objCommand.ExecuteNonQuery()
                'End If
                ''objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                ''                     & " VALUES(" & lngVoucherMasterId & ", 1, " & SalesTaxId & ", " & 0 & ",  " & Val(Me.txtTaxTotal.Text) & ", 'Tax Ref: " & Me.txtPONo.Text & "' )"

                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & SalesTaxId & ", " & 0 & ",  " & Val(Me.txtTaxTotal.Text) & ", N'Tax Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtTaxTotal.Text) / Val(Me.txtCurrencyRate.Text) & ")"

                '' objCommand.Transaction = trans
                'objCommand.ExecuteNonQuery()
                If flgExcludeTaxPrice = False Then
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtTaxTotal.Text) & ", 0, 'Tax Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & Val(Me.txtTaxTotal.Text) / Val(Me.txtCurrencyRate.Text) & ", " & 0 & ")" ''TASK-408
                    '& " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtTaxTotal.Text) & ", 0, 'Tax Ref: " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )" ''Commented this row agaisnt TASK-408 ON 10-06-2016

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()
                End If

                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & SalesTaxId & ", " & 0 & ",  " & Val(Me.txtTaxTotal.Text) & ", 'Tax Ref: " & Me.txtPONo.Text & "' )"
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
                                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & SalesTaxId & ", " & 0 & ",  " & Val(Me.txtTaxTotal.Text) & ", 'Tax Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , 1, 1, " & Val(Me.cmbCurrency.SelectedValue) & ", " & Val(Me.txtCurrencyRate.Text) & "," & 0 & ", " & Val(Me.txtTaxTotal.Text) / Val(Me.txtCurrencyRate.Text) & ")"


                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()
            End If
            '
            'SED Tax Apply 01-07-2012
            '
            If Val(Me.txtSEDTaxAmount.Text) > 0 Then

                objCommand.CommandText = ""
                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
                                       & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtSEDTaxAmount.Text) & ", 0, N'W.H Tax Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

                'objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()


                'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

                objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
                                     & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(SEDAccountId) & ", " & 0 & ",  " & Val(Me.txtSEDTaxAmount.Text) & ", N'W.H Tax Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
                ' objCommand.Transaction = trans
                objCommand.ExecuteNonQuery()

            End If

            ' ''Edit Task 1620
            'If Val(Me.txtAddTransitInsurance.Text) > 0 Then

            '    objCommand.CommandText = ""
            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId,sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(Me.txtAddTransitInsurance.Text) * Val(Me.txtCurrencyRate.Text) & ", 0, N'Transit Insurace Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", " & Val(Me.txtFuel.Text) & "," & 0 & ")"

            '    'objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()


            '    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Val(InsuranceAccountId) & ", " & 0 & ",  " & Val(Me.txtAddTransitInsurance.Text) * Val(Me.txtCurrencyRate.Text) & ", N'Transit Insurace Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & "," & 0 & ", " & Val(Me.txtFuel.Text) & ")"
            '    ' objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()


            'End If
            '***********************

            '***********************
            '06-Dec-2011    Added for Fuel, Other Expense, Adjustment
            '***********************
            ''Edit Task 1620
            'If ExpenseChargeToCustomer = False Then
            '    ''Fuel
            '    If Val(Me.txtFuel.Text) > 0 Then

            '        objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) * Val(Me.txtCurrencyRate.Text) & ", 0, N'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", " & Val(Me.txtFuel.Text) & "," & 0 & " )"
            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) * Val(Me.txtCurrencyRate.Text) & ", N'Fuel Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & "," & 0 & ", " & Val(Me.txtFuel.Text) & ")"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If

            ''---------------------------------- Fuel Expense Credit  
            'If ExpenseChargeToCustomer = True Then
            '    If Val(Me.txtFuel.Text) > 0 Then
            '        objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.FuelExpAccount & ", " & Val(Me.txtFuel.Text) & ", 0, 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtFuel.Text)) * Val(Me.txtCurrencyRate.Text) & ", 0, N'Fuel Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", " & Val(Me.txtFuel.Text) & "," & 0 & " )"
            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtFuel.Text) & ", 'Fuel Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.FuelExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtFuel.Text)) * Val(Me.txtCurrencyRate.Text) & ", N'Fuel Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & "," & 0 & ", " & Val(Me.txtFuel.Text) & ")"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If

            ' ''end Fuel

            'If ExpenseChargeToCustomer = False Then
            '    ''Other Exp
            '    If Val(Me.txtExpense.Text) > 0 Then

            '        objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) * Val(Me.txtCurrencyRate.Text) & ", 0, N'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", " & Val(Me.txtFuel.Text) & "," & 0 & ")"


            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) * Val(Me.txtCurrencyRate.Text) & ", N'Expense Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & "," & 0 & ", " & Val(Me.txtFuel.Text) & ")"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If
            ''--------------------------  Credit Other Expense 
            'If ExpenseChargeToCustomer = True Then
            '    If Val(Me.txtExpense.Text) > 0 Then

            '        objCommand.CommandText = ""
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.OtherExpAccount & ", " & Val(Me.txtExpense.Text) & ", 0, 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                                               & " VALUES(" & lngVoucherMasterId & "," & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(Val(Me.txtExpense.Text)) * Val(Me.txtCurrencyRate.Text) & ", 0, N'Expense Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", " & Val(Me.txtFuel.Text) & "," & 0 & " )"


            '        'objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()
            '        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtExpense.Text) & ", 'Expense Ref: " & Me.txtPONo.Text & "' )"

            '        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.OtherExpAccount & ", " & 0 & ",  " & Math.Abs(Val(Me.txtExpense.Text)) * Val(Me.txtCurrencyRate.Text) & ", N'Expense Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & "," & 0 & ", " & Val(Me.txtFuel.Text) & " )"
            '        ' objCommand.Transaction = trans
            '        objCommand.ExecuteNonQuery()

            '    End If
            'End If
            ' ''end Other Exp

            ''// Removed condition of expense charged to customer
            '' If ExpenseChargeToCustomer = False Then
            ' ''Adjustment
            'If Val(Me.txtAdjustment.Text) > 0 Then

            '    objCommand.CommandText = ""
            '    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            '    '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.AdjustmentExpAccount & ", " & Val(Me.txtAdjustment.Text) & ", 0, 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.AdjustmentExpAccount & ", " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) * Val(Me.txtCurrencyRate.Text) & ", 0, N'Adjustment Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & ", " & Val(Me.txtFuel.Text) & "," & 0 & ")"

            '    'objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()
            '    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            '    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

            '    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, Currency_debit_amount, Currency_Credit_Amount) " _
            '                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment) * Val(Me.txtCurrencyRate.Text) & ", N'Adjustment Ref: " & Me.txtPONo.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' , " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.BaseCurrencyRate).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyId).Value.ToString) & ", " & Val(Me.grd.GetRows(i).Cells(EnumGridDetail.CurrencyRate).Value.ToString) & "," & 0 & ", " & Val(Me.txtFuel.Text) & ")"
            '    ' objCommand.Transaction = trans
            '    objCommand.ExecuteNonQuery()
            'End If

            ''End If
            ''If ExpenseChargeToCustomer = True Then
            ''    If Val(Me.txtAdjustment.Text) > 0 Then
            ''        objCommand.CommandText = ""
            ''        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments) " _
            ''        '                       & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.AdjustmentExpAccount & ", " & Val(Me.txtAdjustment.Text) & ", 0, 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

            ''        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
            ''                                               & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.AdjustmentExpAccount & ", 0, " & Math.Abs(IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment)) & ", N'Adjustment Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

            ''        'objCommand.Transaction = trans
            ''        objCommand.ExecuteNonQuery()
            ''        'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
            ''        '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"

            ''        objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
            ''                                             & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Math.Abs(IIf(Me.rbtAdjFlat.Checked = True, Val(Me.txtAdjustment.Text), Adjustment)) & ", 0, N'Adjustment Ref: " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
            ''        ' objCommand.Transaction = trans
            ''        objCommand.ExecuteNonQuery()

            ''    End If
            ''End If
            ' ''end Adjustment

            ''***********************

            ' Receipt Voucher Master Information 
            If ReceiptVoucherFlg = "True" Then
                objCommand.CommandText = ""
                objCommand.CommandText = "Delete From tblVoucherDetail WHERE Voucher_Id=" & VoucherId
                objCommand.ExecuteNonQuery()
            End If
            If ReceiptVoucherFlg = "True" AndAlso Val(Me.txtRecAmount.Text) <> 0 Then
                If Not ExistingVoucherFlg = True Then
                    objCommand.CommandText = ""
                    'Before against task:2391
                    'objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                    '                           & " cheque_no, cheque_date,post,Source,voucher_code, coa_detail_id, Employee_Id)" _
                    '                           & " VALUES(" & Me.cmbCompany.SelectedValue & ", 1,  " & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", N'" & VoucherNo & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                    '                           & " " & IIf(Me.txtChequeNo.Visible = True, "N'" & Me.txtChequeNo.Text & "'", "NULL") & ", " & IIf(Me.dtpChequeDate.Visible = True, "N'" & dtpChequeDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", " & IIf(Me.chkPost.Checked = True, 1, 0) & ",N'" & Me.Name & "',N'" & Me.txtPONo.Text & "', " & Me.cmbDepositAccount.SelectedValue & ", " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ")" _
                    '                           & " SELECT @@IDENTITY"
                    'Task:2391 Configured Apostrophe on Cheque no and PO No.
                    objCommand.CommandText = "INSERT INTO tblVoucher(location_id, finiancial_year_id, voucher_type_id, voucher_no, voucher_date, " _
                                             & " cheque_no, cheque_date,post,Source,voucher_code, coa_detail_id, Employee_Id)" _
                                             & " VALUES(" & Me.cmbCompany.SelectedValue & ", 1,  " & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", N'" & VoucherNo & "', N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', " _
                                             & " " & IIf(Me.txtChequeNo.Visible = True, "N'" & Me.txtChequeNo.Text.Replace("'", "''") & "'", "NULL") & ", " & IIf(Me.dtpChequeDate.Visible = True, "N'" & dtpChequeDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ", " & IIf(Me.ReceiptPost = True, 1, 0) & ",N'" & Me.Name & "',N'" & Me.txtPONo.Text.Replace("'", "''") & "', " & Me.cmbDepositAccount.SelectedValue & ", " & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & ")" _
                                             & " SELECT @@IDENTITY"
                    'End Task:2391

                    'objCommand.Transaction = trans
                    lngVoucherMasterId = objCommand.ExecuteScalar


                    objCommand.CommandText = ""
                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
                    '                       & " VALUES(" & lngVoucherMasterId & ", " & Me.cmbCompany.SelectedValue & ", " & Me.cmbDepositAccount.SelectedValue & ", " & Val(Me.txtRecAmount.Text) & ", 0, 'Receipt Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & "', " & cmbProject.SelectedValue & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
                                           & " VALUES(" & lngVoucherMasterId & ", " & IIf(Me.cmbCompany.SelectedValue = Nothing, 0, Me.cmbCompany.SelectedValue) & ", " & Me.cmbDepositAccount.SelectedValue & ", " & Val(Me.txtRecAmount.Text) & ", 0, N'Receipt Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
                                                         & " VALUES(" & lngVoucherMasterId & ", " & IIf(Me.cmbCompany.SelectedValue = Nothing, 0, Me.cmbCompany.SelectedValue) & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtRecAmount.Text) & ", N'Receipt Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                Else

                    objCommand.CommandText = ""
                    objCommand.CommandText = "Update tblVoucher Set Voucher_Type_Id=" & Convert.ToInt32(Me.cmbMethod.SelectedValue) & ", Voucher_No=N'" & Me.txtVoucherNo.Text & "',  Voucher_Date=N'" & Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt") & "', Cheque_No=" & IIf(Me.txtChequeNo.Visible = True, "N'" & Me.txtChequeNo.Text & "'", "NULL") & ", Cheque_Date=" & IIf(Me.dtpChequeDate.Visible = True, "N'" & Me.dtpChequeDate.Value.ToString("yyyy-M-d h:mm:ss tt") & "'", "NULL") & ",Post =" & IIf(Me.ReceiptPost = True, 1, 0) & ", coa_detail_id=" & Me.cmbDepositAccount.SelectedValue & ", Employee_Id=" & IIf(Me.cmbSalesMan.SelectedIndex = -1, 0, Me.cmbSalesMan.SelectedValue) & " WHERE Voucher_Id=" & VoucherId
                    objCommand.ExecuteNonQuery()

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, sp_refrence) " _
                                           & " VALUES(" & VoucherId & ", " & IIf(Me.cmbCompany.SelectedValue = Nothing, 0, Me.cmbCompany.SelectedValue) & ", " & Me.cmbDepositAccount.SelectedValue & ", " & Val(Me.txtRecAmount.Text) & ", 0, N'Receipt Ref By " & Me.cmbVendor.Text & ": " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

                    'objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()


                    'objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments) " _
                    '                     & " VALUES(" & lngVoucherMasterId & ", 1, " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtAdjustment.Text) & ", 'Adjustment Ref: " & Me.txtPONo.Text & "' )"
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId, sp_refrence) " _
                                                         & " VALUES(" & VoucherId & ", " & IIf(Me.cmbCompany.SelectedValue = Nothing, 0, Me.cmbCompany.SelectedValue) & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & 0 & ",  " & Val(Me.txtRecAmount.Text) & ", N'Receipt Ref: " & Me.txtPONo.Text & ": " & Me.txtRemarks.Text & "', " & IIf(Me.cmbProject.SelectedValue = Nothing, 0, Me.cmbProject.SelectedValue) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "' )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            End If

            If IsSOSeparateClosure = False Then
            If Not DeliveryChalanId > 0 Then
                If flgMultipleSalesOrder = False Then
                    If Me.cmbPo.SelectedIndex > 0 Then
                        objCommand.CommandText = "Select isnull(Sz1,0) as Qty , isnull(DeliveredQty, 0) as DeliveredQty, Isnull(DeliveredSchemeQty,0) as DeliveredSchemeQty  from SalesOrderDetailTable where SalesOrderID = " & Me.cmbPo.SelectedValue & ""
                        da.SelectCommand = objCommand
                        Dim dt As New DataTable
                        da.Fill(dt)
                        Dim blnEqual As Boolean = True
                        If dt.Rows.Count > 0 Then
                            For Each r As DataRow In dt.Rows
                                If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
                                    blnEqual = False
                                    Exit For
                                End If
                            Next
                        End If
                        If blnEqual = True Then
                            objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where SalesOrderID = " & Me.cmbPo.SelectedValue & ""
                            objCommand.ExecuteNonQuery()
                        Else
                            objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & Me.cmbPo.SelectedValue & ""
                            objCommand.ExecuteNonQuery()
                        End If
                    End If

                Else
                        objCommand.CommandText = "Select DISTINCT ISNULL(SO_ID,0) as SO_ID From SalesDetailTable WHERE SalesID=" & Val(Me.txtReceivingID.Text) & " AND ISNULL(Sz1,0) <> 0"
                        Dim dtPO As New DataTable
                        Dim daPO As New OleDbDataAdapter(objCommand)
                        daPO.Fill(dtPO)
                        If dtPO IsNot Nothing Then
                            If dtPO.Rows.Count > 0 Then
                                For Each row As DataRow In dtPO.Rows

                                    objCommand.CommandText = "Select SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) as DeliveredQty from SalesOrderDetailTable where SalesOrderID = " & row("SO_ID") & " Having SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) > 0 "
                                    Dim daPOQty As New OleDbDataAdapter(objCommand)
                                    Dim dtPOQty As New DataTable
                                    daPOQty.Fill(dtPOQty)
                                    Dim blnEqual1 As Boolean = True
                                    If dtPOQty.Rows.Count > 0 Then
                                        'For Each r As DataRow In dtPOQty.Rows
                                        'If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
                                        blnEqual1 = False
                                        'Exit For
                                        'End If
                                        ' Next
                                    End If
                                    If blnEqual1 = True Then
                                        objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                        objCommand.ExecuteNonQuery()
                                    Else
                                        objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                        objCommand.ExecuteNonQuery()
                                    End If
                                Next
                            End If
                        End If
                    End If
                End If
            Else
                    objCommand.CommandText = "Select DISTINCT ISNULL(SO_ID,0) as SO_ID From SalesDetailTable WHERE SalesID=" & Val(Me.txtReceivingID.Text) & " AND ISNULL(Sz1,0) <> 0"
                    Dim dtPO As New DataTable
                    Dim daPO As New OleDbDataAdapter(objCommand)
                    daPO.Fill(dtPO)
                    If dtPO IsNot Nothing Then
                        If dtPO.Rows.Count > 0 Then
                            For Each row As DataRow In dtPO.Rows

                                objCommand.CommandText = "Select SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) as DeliveredQty from SalesOrderDetailTable where SalesOrderID = " & row("SO_ID") & " Having SUM(isnull(Sz1,0)-isnull(DeliveredQty , 0)) > 0 "
                                Dim daPOQty As New OleDbDataAdapter(objCommand)
                                Dim dtPOQty As New DataTable
                                daPOQty.Fill(dtPOQty)
                                Dim blnEqual1 As Boolean = True
                                If dtPOQty.Rows.Count > 0 Then
                                    'For Each r As DataRow In dtPOQty.Rows
                                    'If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
                                    blnEqual1 = False
                                    'Exit For
                                    'End If
                                    ' Next
                                End If
                                If blnEqual1 = True Then
                                    objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                    objCommand.ExecuteNonQuery()
                                Else
                                    objCommand.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & row("SO_ID") & ""
                                    objCommand.ExecuteNonQuery()
                                End If
                            Next
                        End If
                    End If
                End If




            'If DeliveryChalanId > 0 Then
            '    objCommand.CommandText = "Select isnull(Sz1,0) as Qty, isnull(DeliveredQty, 0) as DeliveredQty, Isnull(DeliveredSchemeQty,0) as DeliveredSchemeQty  from DeliveryChalanDetailTable where DeliveryId = " & DeliveryChalanId & ""
            '    da.SelectCommand = objCommand
            '    Dim dt As New DataTable
            '    da.Fill(dt)
            '    Dim blnEqual As Boolean = True
            '    If dt.Rows.Count > 0 Then
            '        For Each r As DataRow In dt.Rows
            '            If r.Item(0) <> r.Item(1) AndAlso r.Item(0) > r.Item(1) Then
            '                blnEqual = False
            '                Exit For
            '            End If
            '        Next
            '    End If
            '    If blnEqual = True Then
            '        objCommand.CommandText = "Update DeliveryChalanMasterTable set Status = N'" & EnumStatus.Close.ToString & "' where DeliveryId = " & DeliveryChalanId & ""
            '        objCommand.ExecuteNonQuery()
            '    Else
            '        objCommand.CommandText = "Update DeliveryChalanMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where DeliveryId = " & DeliveryChalanId & ""
            '        objCommand.ExecuteNonQuery()
            '    End If
            'End If

            UpdateDeliveryChalanStatus(Val(Me.txtReceivingID.Text), "Update", trans)

            ''Task:2702 Update Sold Qty In CMFADetailTable
            'objCommand.CommandText = ""
            'If blnCMFADocumentLoad = True Then
            '    If Me.cmbCMFADoc.SelectedIndex > 0 Then
            '        objCommand.CommandText = "UPDATE CMFADetailTable SET SoldQty=a.SoldQty From " _
            '         & " (SELECT SalesMasterTable.CMFADocID, SalesDetailTable.LocationId, SalesDetailTable.ArticleDefId, " _
            '         & " SUM(ISNULL(SalesDetailTable.Sz1, 0)) AS SoldQty " _
            '         & " FROM dbo.SalesDetailTable INNER JOIN SalesMasterTable On SalesMasterTable.SalesID = SalesDetailTable.SalesID " _
            '         & " WHERE(SalesMasterTable.CMFADocID <> 0 AND SalesMasterTable.CMFADocID=" & Me.cmbCMFADoc.SelectedValue & ") " _
            '         & "  GROUP BY SalesDetailTable.ArticleDefId, SalesMasterTable.CMFADocID, SalesDetailTable.LocationId)a " _
            '         & " WHERE(a.CMFADocId = CMFADetailTable.docID) " _
            '         & " AND CMFADetailTable.ArticleDefID = a.ArticleDefID " _
            '         & " AND a.LocationID = CMFADetailTable.LocationID AND CMFADetailTable.DocId=" & Me.cmbCMFADoc.SelectedValue & ""
            '        objCommand.ExecuteNonQuery()
            '    End If
            'End If
            ''End Task:2702
            '' Commented becasue it is called twice
            'If arrFile.Count > 0 Then
            '    SaveDocument(Val(Me.txtReceivingID.Text), Me.Name, trans)
            'End If
            SaveOutwardExpense(Val(Me.txtReceivingID.Text), trans)

            'If IsValidate() = True Then
            '    StockMaster.StockTransId = StockTransId(Me.txtPONo.Text, trans)
            '    Call New StockDAL().Update(StockMaster, trans)
            'End If

            ''TASK TFS1378 changed conditions for stock impact on 16-10-2017
            If DCStockImpact = True AndAlso Me.cmbDeliveryChalan.SelectedValue > 0 Then

            Else
                If IsValidate() = True Then
                    StockMaster.StockTransId = StockTransId(Me.txtPONo.Text, trans)
                    Call New StockDAL().Update(StockMaster, trans)
                End If
            End If
            ''End TASK TFS1378

            ''TASK TFS4391 
            If getConfigValueByType("IsDuplicateSales").ToString.ToUpper = "TRUE" Then
                Call CreateDuplicateSales(Val(Me.txtReceivingID.Text), "Update", trans)
            End If
            ''END TFS4391


            trans.Commit()
            Update_Record = True

            SaveActivityLog("POS", Me.Text, EnumActions.Update, LoginUserId, EnumRecordType.Sales, Me.txtPONo.Text.Trim, True)
            SaveActivityLog("Accounts", Me.Text, EnumActions.Update, LoginUserId, EnumRecordType.AccountTransaction, Me.txtPONo.Text.Trim, True)
            ''Start TFS3113
            If ValidateApprovalProcessMapped(Me.txtPONo.Text.Trim, Me.Name) Then
                If ValidateApprovalProcessIsInProgressAgain(Me.txtPONo.Text.Trim, Me.Name) = False Then
                    SaveApprovalLog(EnumReferenceType.Sales, Val(Me.txtReceivingID.Text), Me.txtPONo.Text.Trim, Me.dtpPODate.Value.Date, "Sales ," & cmbVendor.Text & "", Me.Name, 7)
                End If
            End If
            ''End TFS3113
            'insertvoucher()

            'Call Update1() 'Upgrading Stock here ...

            setEditMode = True
            getVoucher_Id = Me.txtReceivingID.Text
            setVoucherNo = Me.txtPONo.Text
            Total_Amount = Val(Me.txtAmount.Text) 'Me.grd.GetTotal(Me.grd.RootTable.Columns("Total"), Janus.Windows.GridEX.AggregateFunction.Sum)

            '...................... Send SMS .............................
            If GetSMSConfig("SMS To Location On Sale Invoice").Enable = True Then
                Dim strSMSBody As String = String.Empty
                Dim objData As DataTable = CType(Me.grd.DataSource, DataTable)
                Dim dt_Loc As DataTable = objData.DefaultView.ToTable("Default", True, "LocationId")
                Dim drData() As DataRow
                For j As Integer = 0 To dt_Loc.Rows.Count - 1
                    strSMSBody = String.Empty
                    strSMSBody += "Sale Invoice, Doc No: " & Me.txtPONo.Text & ", Doc Date: " & Me.dtpPODate.Value.ToShortDateString & ", Customer: " & Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString & ", Bilty No: " & Me.uitxtBiltyNo.Text & ", Remarks:" & Me.txtRemarks.Text & ", "
                    drData = objData.Select("LocationId=" & dt_Loc.Rows(j).Item(0).ToString & "")
                    Dim dblTotalQty As Double = 0D
                    Dim dblTotalAmount As Double = 0D
                    For Each dr As DataRow In drData
                        dblTotalQty += IIf(dr(EnumGridDetail.Unit).ToString = "Loose", Val(dr(EnumGridDetail.Qty).ToString), Val(dr(EnumGridDetail.Qty).ToString) * Val(dr(EnumGridDetail.PackQty).ToString))
                        strSMSBody += " " & dr(EnumGridDetail.Item).ToString & ", " & IIf(dr(EnumGridDetail.Unit).ToString = "Loose", " " & dr(EnumGridDetail.Qty).ToString & "", "" & (Val(dr(EnumGridDetail.Qty)).ToString * Val(dr(EnumGridDetail.PackQty)).ToString) & "") & ", "
                    Next
                    strSMSBody += " Total Qty: " & dblTotalQty & ""
                    Dim LocationPhone() As String = GetLocation(Val(dt_Loc.Rows(j).Item(0).ToString)).Mobile_No.Replace(",", ";").Replace("|", ";").Replace("\", ";").Replace("/", ";").Replace("^", ";").Replace("*", ";").Split(";")
                    If LocationPhone.Length > 0 Then
                        For Each strPhone As String In LocationPhone
                            If strPhone.Length > 0 Then
                                Try
                                    SaveSMSLog(strSMSBody, strPhone, "SMS to Location")
                                Catch ex As Exception
                                    Throw ex
                                End Try
                            End If
                        Next
                    End If
                Next
            End If
            If GetSMSConfig("Sale Invoice").Enable = True Or Len(Me.txtMobileNo.Text.Trim) > 0 Then
                If msg_Confirm(str_ConfirmSendSMSMessage) = False Then Exit Try
                Dim strDetailMessage As String = String.Empty
                For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    'Task#08082015 Add configuration for sending sms with just item qunatity and engine no
                    If getConfigValueByType("DeliveryChalanByEnigneNo").ToString = "True" Then
                        If strDetailMessage.Length = 0 Then
                            strDetailMessage = "Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        Else
                            strDetailMessage += ", Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        End If
                        'End Task#08082015
                    Else
                        If strDetailMessage.Length = 0 Then
                            strDetailMessage = r.Cells(EnumGridDetail.Item).Value.ToString & ", PackQty: " & Val(r.Cells(EnumGridDetail.PackQty).Value.ToString) & ",  Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        Else
                            strDetailMessage += "," & r.Cells(EnumGridDetail.Item).Value.ToString & ",  PackQty: " & Val(r.Cells(EnumGridDetail.PackQty).Value.ToString) & ", Qty: " & IIf(r.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(r.Cells(EnumGridDetail.Qty).Value.ToString), Val(r.Cells(EnumGridDetail.Qty).Value.ToString) * Val(r.Cells(EnumGridDetail.PackQty).Value.ToString)) & IIf(r.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0, ", Engine No: " & r.Cells(EnumGridDetail.Engine_No).Value.ToString, "")
                        End If
                    End If
                Next
                Dim objTemp As New SMSTemplateParameter
                Dim obj As Object = GetSMSTemplate("Sale Invoice")
                If obj IsNot Nothing Then
                    objTemp.SMSTemplate = CType(obj, SMSTemplateParameter).SMSTemplate
                    Dim strMessage As String = objTemp.SMSTemplate
                    'strMessage = strMessage.Replace("@AccountTitle", Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString).Replace("@AccountCode", Me.cmbVendor.ActiveRow.Cells("Code").Value.ToString).Replace("@DocumentNo", Me.txtPONo.Text).Replace("@DocumentDate", Me.dtpPODate.Value.ToShortDateString).Replace("@OtherDoc", Me.uitxtBiltyNo.Text).Replace("@Remarks", Me.txtRemarks.Text).Replace("@Amount", Me.txtNetAmount.Text).Replace("@Quantity", Me.grd.GetTotal(grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)).Replace("@CompanyName", CompanyTitle).Replace("@SIRIUS", "Automated by www.SIRIUS.net")
                    strMessage = strMessage.Replace("@AccountTitle", Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString).Replace("@AccountCode", Me.cmbVendor.ActiveRow.Cells("Code").Value.ToString).Replace("@DocumentNo", Me.txtPONo.Text).Replace("@DocumentDate", Me.dtpPODate.Value.ToShortDateString).Replace("@OtherDoc", Me.uitxtBiltyNo.Text).Replace("@Remarks", Me.txtRemarks.Text).Replace("@Amount", Me.txtNetAmount.Text).Replace("@Quantity", Me.grd.GetTotal(grd.RootTable.Columns("Qty"), Janus.Windows.GridEX.AggregateFunction.Sum)).Replace("@DCNo", Me.txtDcNo.Text).Replace("@CMFADocNo", IIf(Me.cmbCMFADoc.SelectedIndex > 0, Me.cmbCMFADoc.Text, String.Empty)).Replace("@SONo", IIf(Me.cmbPo.SelectedIndex > 0, Me.cmbPo.Text, String.Empty)).Replace("@InvParty", Me.txtInvParty.Text).Replace("@CompanyName", CompanyTitle).Replace("@SIRIUS", "Automated by www.siriussolution.com").Replace("@DetailInformation", strDetailMessage).Replace("@BiltyNo", Me.uitxtBiltyNo.Text.Replace("'", "''")).Replace("@PreviousBalance", _Previous_Balance).Replace("@Transporter", IIf(Me.cmbTransporter.SelectedIndex > 0, Me.cmbTransporter.Text, "' '"))
                    SaveSMSLog(strMessage, Me.cmbVendor.ActiveRow.Cells("Mobile").Value.ToString, "Sale Invoice")
                    If GetSMSConfig("Sale Invoice").EnabledAdmin = True Then
                        For Each strMob As String In strAdminMobileNo.Replace(",", ";").Replace("|", ";").Replace("^", ";").Split(";")
                            If strMob.Length > 10 Then
                                SaveSMSLog(strMessage, strMob, "Sale Invoice")
                            End If
                        Next
                    End If
                    Dim strMobiles() As String = {}
                    strMobiles = CStr(Me.txtMobileNo.Text).Split(",")
                    If strMobiles.Length > 0 Then
                        For Each strMobNo As String In strMobiles
                            If strMobNo.Length >= 10 Then
                                SaveSMSLog(strMessage, strMobNo, "Sale Invoice")
                            End If
                        Next
                    End If

                End If
            End If

            '...................... End Send SMS ................
            'SendConfiguredNotificationOnUpdate(setVoucherNo, getVoucher_Id, Me.grd.RowCount)
        Catch ex As Exception
            trans.Rollback()
            Update_Record = False
            ShowErrorMessage("An error occured while updating record" & ex.Message)
        End Try
    End Function




    '' ReqId-924 Commented Information Message
    Public Sub SaveToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnSave.Click
        If Me.BtnSave.Enabled = False Then Exit Sub
        Me.Cursor = Cursors.WaitCursor
        Me.cmbProject.SelectedIndex = IIf(Me.cmbProject.SelectedIndex > 0, Me.cmbProject.SelectedIndex, 0)
        Try
            'ValidateDateLock()
            'If flgDateLock = True Then ShowErrorMessage("Previous date work not allowed") : Exit Sub
            Mode = "Normal"
            'If flgDateLock = True Then
            '    If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00"))) Then
            '        ShowErrorMessage("Previous date work not allowed") : Exit Sub
            '    End If
            'End If
            If IsDateLock(Me.dtpPODate.Value) = True Then
                ShowErrorMessage(str_ErrorPreviouseDateRecordUpdateAllow) : Exit Sub
            End If
            If Me.dtpPODate.Value <= Convert.ToDateTime((getConfigValueByType("EndOfDate").ToString)) Then
                ShowErrorMessage("Your can not change this becuase financial year is closed")
                Me.dtpPODate.Focus()
                Exit Sub
            End If
            If FormValidate() Then
                Me.grd.UpdateData()
                If Me.BtnSave.Text = "Save" Or Me.BtnSave.Text = "&Save" Then
                    If flgAutoInvoiceGenerate = False Then 'If Not msg_ firm(str_ConfirmSave) = True Then Exit Sub
                        '//To check if jobcard is loaded and messagebox(msg_confirm1) return true then update that jobcard history//
                        ''Start TASK # 943 
                        If txtJobCardNo.Text <> "" AndAlso msg_Confirm1("Do you want to Save") = False Then Exit Sub
                        'End TASK # 943 
                        If Save() Then
                            'EmailSave()
                            'If flgAutoInvoiceGenerate = False Then msg_Information(str_informSave)
                            DisplayRecord()
                            '' Made changes to  against TASK TFS1462 on 13-09-2017
                            Dim Printing As Boolean
                            Printing = Convert.ToBoolean(getConfigValueByType("Print").ToString)
                            Dim DirectVoucherPrinting As Boolean = False
                            If Not getConfigValueByType("DirectVoucherPrinting").ToString = "Error" Then
                                DirectVoucherPrinting = Convert.ToBoolean(getConfigValueByType("DirectVoucherPrinting").ToString)
                            End If
                            If Printing = True Or DirectVoucherPrinting = True Then
                                If msg_Confirm("Do you want to print", Printing, DirectVoucherPrinting) = True Then
                                    Dim Print1 As Boolean = frmMessages.Print
                                    Dim PrintVoucher As Boolean = frmMessages.DirectVoucherPrinting
                                    If Print1 = True Then
                                        Call IsPrint()
                                    End If
                                    If PrintVoucher = True Then
                                        GetVoucherPrint(Me.txtPONo.Text, Me.Name, BaseCurrencyName, BaseCurrencyId, True)
                                    End If
                                End If
                            End If
                            ''END TASK TFS1462

                            RefreshControls()
                            ClearDetailControls()
                            '''''''''''''''''''''''''''''''''
                            ' Altered against Task# 20150504 Ali Ansari
                            ''Commented on 13-09-2017
                            'Dim Printing As Boolean
                            'Printing = Convert.ToBoolean(getConfigValueByType("Print").ToString)

                            'If Printing = True Or DirectVoucherPrinting = True Then
                            '    If msg_Confirm("Do you want to print") = True Then
                            '      Call IsPrint()
                            '   End If
                            'End If

                            ' Altered against Task# 20150504 Ali Ansari
                            ''''''''''''''''''''''''''''''''
                            'grd1.Rows.Clear()
                            'Me.DisplayDetail(-1)
                            'DisplayRecord()
                            If BackgroundWorker2.IsBusy Then Exit Sub
                            BackgroundWorker2.RunWorkerAsync()
                            'Do While BackgroundWorker2.IsBusy
                            '    Application.DoEvents()
                            'Loop
                            '-=--------------------------------
                            If BackgroundWorker3.IsBusy Then Exit Sub
                            BackgroundWorker3.RunWorkerAsync()
                            'Do While BackgroundWorker3.IsBusy
                            '    Application.DoEvents()
                            'Loop
                        Else
                            Exit Sub 'MsgBox("Record has not been added")
                        End If
                    End If
                Else
                    If blnCertificateIssued = False Then
                        '//Modified by Waqar To check if jobcard is loaded and messagebox(msg_confirm1) return true then update that jobcard history
                        '//Start TASK # 943
                        If txtJobCardNo.Text <> "" AndAlso msg_Confirm1(str_ConfirmUpdate) = False Then
                            Exit Sub
                        Else
                            '//End TASK # 943

                            '//If JobCard is not loaded then show this (msg_confirm)//TASK # 943
                            If txtJobCardNo.Text = "" Then
                                If flgAutoInvoiceGenerate = False AndAlso msg_Confirm(str_ConfirmUpdate) = False Then
                                    Exit Sub
                                End If
                            End If
                        End If
                    Else
                        If msg_Confirm("Certificate has been issued in this invoice." & Chr(10) & "Do you want update this record.?") = False Then Exit Sub
                    End If

                    If Update_Record() Then
                        'EmailSave()
                        'If flgAutoInvoiceGenerate = False Then msg_Information(str_informUpdate)
                        'DisplayRecord()
                        '' Made changes to  against TASK TFS1462 on 13-09-2017
                        Dim Printing As Boolean
                        Printing = Convert.ToBoolean(getConfigValueByType("Print").ToString)
                        Dim DirectVoucherPrinting As Boolean
                        DirectVoucherPrinting = Convert.ToBoolean(getConfigValueByType("DirectVoucherPrinting").ToString)
                        If Printing = True Or DirectVoucherPrinting = True Then
                            If msg_Confirm("Do you want to print", Printing, DirectVoucherPrinting) = True Then
                                Dim Print1 As Boolean = frmMessages.Print
                                Dim PrintVoucher As Boolean = frmMessages.DirectVoucherPrinting
                                If Print1 = True Then
                                    Call IsPrint()
                                End If
                                If PrintVoucher = True Then
                                    GetVoucherPrint(Me.txtPONo.Text, Me.Name, BaseCurrencyName, BaseCurrencyId, True)
                                End If
                            End If
                        End If
                        ''END TASK TFS1462

                        'DisplayRecord()
                        ''''''''''''''''ali
                        ''''''''''''''''ali
                        ' Altered against Task# 20150504 Ali Ansari
                        ''Commented on 13-09-2017
                        'Dim Printing As Boolean
                        'Printing = Convert.ToBoolean(getConfigValueByType("Print").ToString)
                        'If Printing = True Then

                        '    If msg_Confirm("Do you want to print") = True Then
                        '        Call IsPrint()
                        '    End If
                        'End If
                        ' Altered against Task# 20150504 Ali Ansari

                        RefreshControls()
                        ClearDetailControls()
                        'Me.DisplayDetail(-1)
                        'DisplayRecord()
                        If BackgroundWorker2.IsBusy Then Exit Sub
                        BackgroundWorker2.RunWorkerAsync()
                        'Do While BackgroundWorker2.IsBusy
                        '    Application.DoEvents()
                        'Loop
                        '-=--------------------------------
                        If BackgroundWorker3.IsBusy Then Exit Sub
                        BackgroundWorker3.RunWorkerAsync()
                        'Do While BackgroundWorker3.IsBusy
                        '    Application.DoEvents()
                        'Loop
                    Else
                        Exit Sub 'MsgBox("Record has not been updated")
                    End If
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub NewToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnNew.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            If Me.grd.RecordCount > 0 Then
                If Not msg_Confirm(str_ConfirmGridClear) = True Then Exit Sub
            End If
            Me.cmbSalesMan.SelectedIndex = 0
            txtPDP.Text = "0"
            RefreshControls()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub OpenToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnEdit.Click
        Me.Cursor = Cursors.WaitCursor
        Try
            EditRecord()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    Private Sub grdSaved_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles grdSaved.KeyDown
        'R-974 Ehtisham ul Haq user friendly system modification on 20-1-14
        If e.KeyCode = Keys.F2 Then
            OpenToolStripButton_Click(Nothing, Nothing)
            Exit Sub
        End If

        If e.KeyCode = Keys.Delete Then
            If Me.grdSaved.RowCount <= 0 Then Exit Sub
            DeleteToolStripButton_Click(Nothing, Nothing)
            Exit Sub
        End If
    End Sub

    Private Sub grdSaved_LinkClicked(ByVal sender As Object, ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdSaved.LinkClicked
        Try
            If e.Column.Key = "No Of Attachment" Then
                If AttachmentRight = False Then
                    msg_Information("You do not have right to see attachments")
                    Exit Sub
                End If
                Dim frm As New frmAttachmentView
                frm._Source = Me.Name
                frm._VoucherId = Me.grdSaved.GetRow.Cells("SalesID").Value.ToString
                frm.ShowDialog()
                Exit Sub
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub grdSaved_CellDoubleClick(ByVal sender As Object, ByVal e As Janus.Windows.GridEX.RowActionEventArgs) Handles grdSaved.RowDoubleClick
        Try
            EditRecord()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub cmbPo_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbPo.SelectedIndexChanged
        If Not flgMultipleSalesOrder = True Then
            If Me.cmbPo.SelectedIndex <= 0 Then Exit Sub

            If Me.BtnSave.Text <> "&Save" Then
                If flgMultipleSalesOrder = False Then
                    If Val(Me.grdSaved.GetRow.Cells("POId").Value.ToString) > 0 Then
                        If Me.cmbPo.SelectedIndex > 0 Then
                            If Me.cmbPo.SelectedValue <> (Me.grdSaved.GetRow.Cells("POId").Value.ToString) Then
                                If msg_Confirm("You have changed Sales Order [" & CType(Me.cmbPo.SelectedItem, DataRowView).Row.Item("SalesOrderNo").ToString & "], do you want to proceed. ?") = False Then
                                    RemoveHandler cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
                                    Me.cmbPo.SelectedValue = (Me.grdSaved.GetRow.Cells("POId").Value.ToString)
                                    AddHandler cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
                                    Exit Sub
                                End If
                            Else
                                Exit Sub
                            End If
                        End If
                    End If
                End If
            End If

            Me.txtRemarks.Text = CType(Me.cmbPo.SelectedItem, DataRowView).Item("Remarks").ToString 'GetSalesRemarks(Me.cmbPo.SelectedValue)
            Me.cmbProject.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("CostCenterId").ToString) 'getCostCenterIdByInvoiceId(Me.cmbPo.SelectedValue)

            ''TASK TFS1764
            Me.cmbTransporter.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("TransporterId").ToString)
            ''END TASK TFS1764
            Me.cmbSalesMan.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("SOP_ID").ToString) ''TFS4339
            Me.DisplayPODetail(Me.cmbPo.SelectedValue)
            'If Me.cmbPo.SelectedIndex > 0 Then
            '    Dim adp As New OleDbDataAdapter
            '    Dim dt As New DataTable
            '    Dim Sql As String = "Select * from salesorderMasterTable where SalesOrderId=" & Me.cmbPo.SelectedValue
            '    adp = New OleDbDataAdapter(Sql, Con)
            '    adp.Fill(dt)
            '    'TODO -----
            '    Me.cmbVendor.Value = dt.Rows(0).Item("VendorId")
            '    Me.cmbVendor.Enabled = False

            'Else
            '    Me.cmbVendor.Enabled = True
            '    If Me.cmbVendor.Rows.Count > 0 Then Me.cmbVendor.Rows(0).Activate()
            'End If


            If Me.grd.RowCount = 0 Then Exit Sub
            If IsSalesOrderAnalysis = True Then
                'If Not Val(Me.txtWHTaxPercent.Text) > 0 Then Exit Sub 'Comment Against Task:2582 
                If Val(Me.txtWHTaxPercent.Text) > 0 Then 'Task:2582 Set Validation On With Holding Tax
                    Dim dt As New DataTable
                    dt = CType(Me.grd.DataSource, DataTable)
                    If dt IsNot Nothing Then
                        If dt.Rows.Count > 0 Then
                            For Each r As DataRow In dt.Rows
                                r.BeginEdit()
                                r("SED") = Val(Me.txtWHTaxPercent.Text)
                                r.EndEdit()
                            Next
                        End If
                    End If
                End If
                GetAdjustment(Me.cmbPo.SelectedValue)
                Me.GetTotal()
                'Me.txtExpense_LostFocus(Nothing, Nothing)
                'Me.txtFuel_LostFocus(Nothing, Nothing)
            Else
                Exit Sub
            End If
        End If 'Task:2582 End Multi Sales Order Status
    End Sub
    'Private Sub grd_CellEndEdit(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs)
    '    With Me.grd1.CurrentRow

    '        If Me.grd1.CurrentRow.Cells("Unit").Value = "Loose" Then
    '            'txtPackQty.Text = 1
    '            .Cells("Total").Value = Val(.Cells("Qty").Value) * Val(.Cells("Rate").Value)
    '        Else
    '            .Cells("Total").Value = Val(.Cells("Qty").Value) * Val(.Cells("Rate").Value) * Val(.Cells("PackQty").Value)
    '        End If
    '        GetTotal()
    '    End With
    'End Sub

    Private Sub cmbItem_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbItem.Leave
        Try
            Me.cmbBatchNo.LimitToList = True
            If Me.cmbItem.IsItemInList = False Then Exit Sub
            If Me.cmbItem.ActiveRow Is Nothing Then Exit Sub
            'Me.txtStock.Text = UiGetStockDataTable(Me.cmbItem.Value)
            ''Commented Against TFS4685 : Ayesha Rehman : 02-10-2018 : Retaining PDP value for leaving item Drop down
            ' ClearDetailControls() ''TASK-408
            'Me.cmbItem.Focus()
            'Me.txtRate.Text = Me.cmbItem.ActiveRow.Cells("").Value.ToString
            'TFS15161:Rai Haider : Rate from keydown of cmbitem set if keydown true to Correct the wrong rate selection in item filter on sales screen 
            ''Commented Agianst TFS4161 :  Ayesha Rehman : txtPDP.text already setting while Unit is Selected
            'If IsKeyDownCalled = False Then
            '    Me.txtRate.Text = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString
            '    Me.txtPDP.Text = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString 'TFS1153
            'Else
            '    Me.txtRate.Text = KeyDownPrice
            '    Me.txtPDP.Text = KeyDownPrice 'TFS1153
            'End If
            'End TFS1561: Rai Haider
            'Me.txtRate.Text = Me.cmbItem.SelectedRow.Cells("Price").Value.ToString

            'Me.txtRate.Text = Me.cmbItem.Rows


            'Dim txtName As String = Me.cmbItem.Text

            'Me.txtStock.Text = Me.cmbItem.ActiveRow.Cells("Stock").Value.ToString
            ' Me.txtBatchNo.Text = Me.cmbItem.ActiveRow.Cells("BatchNo").Value.ToString
            'If Not GetConfigValue("ServiceItem").ToString = "True" Then
            If Val(Me.txtQty.Text) <= 0 Then
                Me.txtQty.Text = 1
                Me.txtTotalQuantity.Text = 1
                'Else
                'Me.txtQty.Text = 0
                'If Val(Me.txtServiceQty.Text) <= 0 Then Me.txtServiceQty.Text = 1
            End If
            Dim strSQl As String = String.Empty
            'If GetConfigValue("WithSizeRange") = "False" Then '& "   FROM vw_Batch_Stock " _
            'If GetConfigValue("WithSizeRange") = "True" Then
            '    strSQl = " SELECT ISNULL(a.Stock, 0) AS Stock, PurchaseBatchTable.BatchNo AS [Batch No], PurchaseBatchTable.BatchID" _
            '            & " FROM SizeRangeTable INNER JOIN" _
            '            & " PurchaseBatchTable ON SizeRangeTable.BatchID = PurchaseBatchTable.BatchID LEFT OUTER JOIN " _
            '            & " (SELECT     * " _
            '            & " From vw_Batch_Stock_ByLocation " _
            '            & " WHERE      articleID = " & Me.cmbItem.Value & ") a ON PurchaseBatchTable.BatchID = a.BatchID " _
            '            & " WHERE(SizeRangeTable.SizeID = " & IIf(Val(Me.cmbItem.ActiveRow.Cells("Size ID").Value.ToString) > 0, Me.cmbItem.ActiveRow.Cells("Size ID").Value, 0) & ") and LocationId = " & Me.cmbCategory.SelectedValue & " "
            'Else
            '    'strSQl = "SELECT Stock, BatchNo as [Batch No], BatchID FROM  dbo.vw_Batch_Stock WHERE     (NOT (Stock = 0))and articleid= " & Me.cmbItem.ActiveRow.Cells(0).Value
            '    'strSQl = "SELECT Stock, BatchNo as [Batch No] , BatchID FROM         dbo.vw_Batch_Stock WHERE     (NOT (Stock = 0))and articleid= " & Me.cmbItem.ActiveRow.Cells(0).Value
            '    strSQl = "SELECT Stock, BatchNo as [Batch No] , BatchID FROM         dbo.vw_Batch_Stock_ByLocation WHERE     (NOT (Stock = 0))and LocationId = " & Me.cmbCategory.SelectedValue & " and articleid= " & Me.cmbItem.ActiveRow.Cells(0).Value
            'End If

            'FillUltraDropDown(cmbBatchNo, strSQl, False)

            'cmbBatchNo.DataSource = Nothing

            Dim objCommand As New OleDbCommand
            Dim objDataAdapter As New OleDbDataAdapter
            Dim objDataSet As New DataSet

            If Con.State = ConnectionState.Open Then Con.Close()

            Con.Open()
            objCommand.Connection = Con
            objCommand.CommandType = CommandType.Text


            'objCommand.CommandText = strSQl


            Dim dt As New DataTable
            Dim dr As DataRow
            dt.Columns.Add("BatchID", GetType(System.Int32))
            dt.Columns.Add("Batch No", GetType(System.String))

            'objDataAdapter.SelectCommand = objCommand
            'objDataAdapter.Fill(dt)

            dr = dt.NewRow
            dr.Item(1) = ""
            dr.Item(0) = 0
            dr.Item(1) = 0
            dt.Rows.Add(dr)

            cmbBatchNo.DisplayMember = "Batch No"
            cmbBatchNo.ValueMember = "BatchID"
            cmbBatchNo.DataSource = dt

            cmbBatchNo.DisplayLayout.Bands(0).Columns("BatchId").Hidden = True

            'Con.Close()

            'Dim i As Integer
            'For i = 0 To Me.cmbBatchNo.Rows.Count - 2
            '    Dim Gi As Integer
            '    For Gi = 0 To Me.grd.GetRows.Length - 1
            '        If Me.cmbBatchNo.Rows(i).Cells("Batch No").Value = Me.grd.GetRow(Gi).Cells(EnumGridDetail.BatchNo).Value AndAlso Me.grd.GetRow(Gi).Cells(EnumGridDetail.SaleDetailID).Value.ToString = "0" Then
            '            Me.cmbBatchNo.Rows(i).Cells("Stock").Value = Me.cmbBatchNo.Rows(i).Cells("Stock").Value - Me.grd.GetRow(Gi).Cells(EnumGridDetail.Qty).Value
            '        End If
            '    Next
            '    'me.cmbBatchNo.Rows(i).Cells("BatchNo)
            'Next
            'Me.cmbBatchNo.Rows(0).Activate()
            objCommand.CommandText = " SELECT   Price" _
                                 & " FROM SalesDetailTable" _
                                 & " WHERE     SaleDetailId =" _
                                 & " (SELECT     MAX(SaleDetailID) " _
                                 & "   FROM SalesDetailTable, SalesMasterTable " _
                                 & " WHERE(SalesdetailTable.Salesid = SalesMasterTable.SalesId) " _
                                 & " and SalesMasterTable.CustomerCode=" & Val(Me.cmbVendor.ActiveRow.Cells(0).Value) & " and ArticleDefID =" & Me.cmbItem.ActiveRow.Cells(0).Value _
                                 & " )"
            objDataAdapter.SelectCommand = objCommand
            objDataAdapter.Fill(objDataSet)


            If objDataSet.Tables(0).Rows.Count > 0 Then
                Me.txtLastPrice.Text = objDataSet.Tables(0).Rows(0)(0)
            Else
                Me.txtLastPrice.Text = 0
            End If
            '20-July-2017: Task TFS1084: Waqar Raza: Added for HFR to Show rack on item load.
            'Start Task:
            If Me.txtRack.Visible = True Then
                Dim dt1 As DataTable
                Dim str As String = "SELECT ArticalDefLocation.Ranks FROM ArticalDefLocation INNER JOIN ArticleDefTable ON ArticalDefLocation.ArticalID = ArticleDefTable.MasterID where ArticleDefTable.ArticleID = " & Me.cmbItem.ActiveRow.Cells(0).Value & " and LocationID = " & Me.cmbCategory.SelectedValue & ""
                dt1 = GetDataTable(str)
                If dt1.Rows.Count > 0 Then
                    Me.txtRack.Text = dt1.Rows(0).Item("Ranks").ToString
                End If
            End If
            'End Task:
            ''calculate customer base discont
            Me.txtDisc.TabStop = True
            Try
                If Me.cmbVendor.ActiveRow.Cells(0).Value > 0 Then

                    If getConfigValueByType("ApplyFlatDiscountOnSale").ToString = "False" Then
                        strSQl = "select discount from tbldefcustomerbasediscounts where articledefid = " & Me.cmbItem.ActiveRow.Cells(0).Value _
                        & " and typeid = " & Me.cmbVendor.ActiveRow.Cells("typeid").Value & "  and discount > 0 "
                        Dim dtdiscount As DataTable = GetDataTable(strSQl)
                        dtdiscount.AcceptChanges()

                        If Not dtdiscount Is Nothing Then
                            If dtdiscount.Rows.Count <> 0 Then

                                Dim disc As Double = 0D
                                Double.TryParse(dtdiscount.Rows(0)(0).ToString, disc)

                                Dim price As Double = 0D
                                'Ayesha Tip
                                Double.TryParse(Me.txtRate.Text, price)
                                Double.TryParse(Me.txtPDP.Text, price) 'TFS1153
                                Me.txtRate.Text = price - ((price / 100) * disc)
                                Me.txtPDP.Text = price - ((price / 100) * disc) 'TFS1153
                                Me.txtDisc.TabStop = False
                            Else
                                If IsSalesOrderAnalysis = True Then
                                    Me.txtDisc.TabStop = True
                                End If
                            End If
                        End If
                    Else

                        strSQl = "select discount from tbldefcustomerbasediscountsFlat where articledefid = " & Me.cmbItem.ActiveRow.Cells(0).Value _
                                              & " and typeid = " & Me.cmbVendor.ActiveRow.Cells("typeid").Value & "  and discount > 0 "
                        Dim dtdiscountFlat As DataTable = GetDataTable(strSQl)
                        dtdiscountFlat.AcceptChanges()


                        If Not dtdiscountFlat Is Nothing Then
                            If dtdiscountFlat.Rows.Count <> 0 Then

                                Dim disc As Double = 0D
                                Double.TryParse(dtdiscountFlat.Rows(0)(0).ToString, disc)

                                Dim price As Double = 0D
                                Double.TryParse(Me.txtRate.Text, price)
                                Double.TryParse(Me.txtPDP.Text, price) 'TFS1153
                                Dim dblDiscountPercent As Double = 0D
                                If disc > 0 Then
                                    dblDiscountPercent = (disc / price) * 100

                                    If price > 0 Then
                                        Me.txtRate.Text = price - ((price / 100) * dblDiscountPercent)
                                        Me.txtPDP.Text = price - ((price / 100) * dblDiscountPercent) 'TFS1153
                                        Me.txtDisc.TabStop = False
                                    Else
                                        Me.txtRate.Text = Me.txtRate.Text
                                        Me.txtPDP.Text = Me.txtPDP.Text 'TFS1153
                                        Me.txtDisc.TabStop = True
                                    End If
                                Else
                                    dblDiscountPercent = 0
                                    Me.txtDisc.TabStop = True
                                End If
                            End If
                        End If
                    End If
                End If

                If Me.cmbItem.ActiveRow.Cells(0).Value > 0 Then
                    cmbTaxCategory.SelectedValue = Me.cmbItem.ActiveRow.Cells("Tax ID").Value
                End If
            Catch ex As Exception

            End Try



            objCommand = Nothing
            objDataAdapter = Nothing
            objDataSet = Nothing
            'Me.cmbItem.DisplayLayout.Bands(0).ColumnFilters.ClearAllFilters()
        Catch ex As Exception
            '  cmbItem.Focus()
            ShowErrorMessage(ex.Message)

        End Try

        If Not Me.cmbBatchNo.Rows.Count > 0 Then Me.cmbBatchNo.LimitToList = False
        'Me.txtStock.Text = GetItemStock(Me.cmbItem.ActiveRow.Cells(0).Value.ToString)
        'Me.cmbVendor.DisplayLayout.Grid.Show( me.cmbVendor.contr)
        Me.cmbBatchNo.Enabled = True
    End Sub
    Private Sub cmbItem_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbItem.Enter
        Me.cmbItem.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.ToggleDropdown)

    End Sub

    Private Sub cmbVendor_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbVendor.Enter
        Me.cmbVendor.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.ToggleDropdown)
    End Sub

    Private Sub DeleteToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnDelete.Click
        'ValidateDateLock()
        'If (flgDateLock = True Or DateLock.ToString("yyyy-M-d 00:00:00") > Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00")) Then ShowErrorMessage("Previous date work not allowed") : Exit Sub
        'If flgDateLock = True Then
        '    If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00"))) Then
        '        ShowErrorMessage("Previous date work not allowed") : Exit Sub
        '    End If
        'End If
        If BtnDelete.Enabled = False Then Exit Sub
        If Me.grdSaved.RowCount = 0 Then Exit Sub
        If IsDateLock(Me.dtpPODate.Value) = True Then
            ShowErrorMessage(str_ErrorPreviouseDateRecordDeleteAllow) : Exit Sub
        End If
        If Not Me.grdSaved.RowCount > 0 Then
            msg_Error(str_ErrorNoRecordFound)
            Exit Sub
        End If
        ''Start TFS2988 : Ayesha Rehman : 09-04-2018
        If IsEditMode = True Then
            If ValidateApprovalProcessMapped(Me.txtPONo.Text.Trim) Then
                If ValidateApprovalProcessInProgress(Me.txtPONo.Text.Trim) Then
                    msg_Error("Document is in Approval Process ") : Exit Sub
                End If
            End If
        End If
        ''End TFS2988

        'Task:2794 Check Invoice Based Receipt/Payment Depanded Record Exist
        Dim dt As New DataTable
        dt = GetDataTable("Select Count(*) From InvoiceBasedReceiptsDetails WHERE InvoiceNo=N'" & Me.grdSaved.GetRow.Cells("SalesNo").Value.ToString.Replace("'", "''") & "'")
        If Val(dt.Rows(0).Item(0).ToString) > 0 Then
            ShowErrorMessage(str_ErrorDependentRecordFound)
            Exit Sub
        End If
        'End Task:2794


        If Not msg_Confirm(str_ConfirmDelete) = True Then Exit Sub
        Me.Cursor = Cursors.WaitCursor
        Dim objTrans As OleDbTransaction
        Try
            DeliveryChalanId = Val(Me.grdSaved.CurrentRow.Cells("DeliveryId").Value.ToString)
            Dim lngVoucherMasterId As Integer = GetVoucherId(Me.Name, grdSaved.CurrentRow.Cells(0).Value.ToString)
            IsSOSeparateClosure = Me.grdSaved.CurrentRow.Cells("IsSOSeparateClosure").Value
            'Dim strVoucherNo As String = String.Empty
            'Dim dt As DataTable = GetRecords("SELECT voucher_no   FROM tblVoucher  WHERE voucher_id = " & lngVoucherMasterId & " ")

            'If Not dt Is Nothing Then
            '    If Not dt.Rows.Count = 0 Then
            '        strVoucherNo = dt.Rows(0)("voucher_no")
            '    End If
            'End If

            Dim cmd As New OleDbCommand
            'Dim objTrans As OleDbTransaction
            If Con.State = ConnectionState.Closed Then Con.Open()
            objTrans = Con.BeginTransaction
            cmd.Connection = Con
            cmd.Transaction = objTrans
            cmd.CommandType = CommandType.Text
            cmd.CommandText = String.Empty
            cmd.CommandText = "SELECT  ISNULL(Sz1,0) as Qty, ISNULL(SampleQty,0) as SampleQty, ArticleDefID, ISNULL(SO_ID,0) AS SO_ID, IsNull(Qty, 0) As TotalQty, IsNull(SO_Detail_ID, 0) FROM SalesDetailTable WHERE  SalesId = " & Val(Me.grdSaved.CurrentRow.Cells("SalesId").Value) & ""
            Dim da As New OleDbDataAdapter(cmd)
            Dim dtSavedItems As New DataTable
            da.Fill(dtSavedItems)
            dtSavedItems.AcceptChanges()
            If IsSOSeparateClosure = False Then
            If Not DeliveryChalanId > 0 Then
                If dtSavedItems.Rows.Count > 0 Then
                    If flgMultipleSalesOrder = False Then
                        For Each r As DataRow In dtSavedItems.Rows
                            cmd.CommandText = String.Empty
                            cmd.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) - " & r.Item(1) & "), DeliveredTotalQty = abs(Isnull(DeliveredTotalQty,0) - " & r.Item(4) & ") where SalesOrderID = " & Val(r.Item("SO_ID")) & " and ArticleDefID = " & r.Item(2) & " And SalesOrderDetailId =" & r.Item(5) & ""
                            cmd.ExecuteNonQuery()
                        Next
                    Else
                        For Each r As DataRow In dtSavedItems.Rows
                            cmd.CommandText = String.Empty
                            cmd.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) - " & r.Item(1) & "), DeliveredTotalQty = abs(Isnull(DeliveredTotalQty,0) - " & r.Item(4) & ") where SalesOrderID = " & Val(r.Item("SO_ID")) & " and ArticleDefID = " & r.Item(2) & " And SalesOrderDetailId =" & r.Item(5) & ""
                            cmd.ExecuteNonQuery()
                        Next
                    End If
                End If
                If flgMultipleSalesOrder = False Then
                    cmd.CommandText = String.Empty
                    cmd.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & Me.grdSaved.CurrentRow.Cells("PoId").Value & ""
                    cmd.ExecuteNonQuery()
                    '  End If
                Else
                    'cmd.Connection = Con
                    'cmd.Transaction = objTrans
                    cmd.CommandText = String.Empty
                    cmd.CommandText = "Select distinct isnull(so_id,0) as so_id From SalesDetailTable where SalesId=" & Val(Me.txtReceivingID.Text)
                    Dim dtSO As New DataTable
                    Dim da1 As New OleDbDataAdapter(cmd)
                    da1.Fill(dtSO)
                    dtSO.AcceptChanges()
                    If dtSO IsNot Nothing Then
                        If dtSO.Rows.Count > 0 Then
                            For Each r As DataRow In dtSO.Rows
                                cmd.CommandText = String.Empty
                                cmd.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & Val(r.Item("SO_ID").ToString) & ""
                                cmd.ExecuteNonQuery()
                            Next
                        End If
                        End If
                    End If
                End If
            Else
                For Each r As DataRow In dtSavedItems.Rows
                    cmd.CommandText = String.Empty
                    cmd.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) - " & r.Item(1) & "), DeliveredTotalQty = abs(Isnull(DeliveredTotalQty,0) - " & r.Item(4) & ") where SalesOrderID = " & Val(r.Item("SO_ID")) & " and ArticleDefID = " & r.Item(2) & " And SalesOrderDetailId =" & r.Item(5) & ""
                    cmd.ExecuteNonQuery()
                Next
                cmd.CommandText = String.Empty
                cmd.CommandText = "Select distinct isnull(so_id,0) as so_id From SalesDetailTable where SalesId=" & Val(Me.txtReceivingID.Text)
                Dim dtSO As New DataTable
                Dim da1 As New OleDbDataAdapter(cmd)
                da1.Fill(dtSO)
                dtSO.AcceptChanges()
                If dtSO IsNot Nothing Then
                    If dtSO.Rows.Count > 0 Then
                        For Each r As DataRow In dtSO.Rows
                            cmd.CommandText = String.Empty
                            cmd.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & Val(r.Item("SO_ID").ToString) & ""
                            cmd.ExecuteNonQuery()
                        Next
                    End If
                End If
            End If

            'If DeliveryChalanId > 0 Then
            '    For Each r As DataRow In dtSavedItems.Rows
            '        cmd.CommandText = String.Empty
            '        cmd.CommandText = "Update DeliveryChalanDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) - " & r.Item(1) & ") where DeliveryId = " & Me.grdSaved.CurrentRow.Cells("DeliveryId").Value & " and ArticleDefID = " & r.Item(2) & ""
            '        cmd.ExecuteNonQuery()
            '    Next
            '    cmd.CommandText = String.Empty
            '    cmd.CommandText = "Update DeliveryChalanMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where DeliveryId = " & Me.grdSaved.CurrentRow.Cells("DeliveryId").Value & ""
            '    cmd.ExecuteNonQuery()
            'End If
            ''Task:2702 Update Sold Qty In CMFADetailTable
            'cmd.CommandText = ""
            'If blnCMFADocumentLoad = True Then
            '    If Me.cmbCMFADoc.SelectedIndex > 0 Then
            '        cmd.Connection = Con
            '        cmd.CommandText = "UPDATE CMFADetailTable SET CMFADetailTable.SoldQty=a.SoldQty-a.SoldQty From " _
            '         & " (SELECT SalesMasterTable.CMFADocID, SalesDetailTable.LocationId, SalesDetailTable.ArticleDefId, " _
            '         & " SUM(ISNULL(SalesDetailTable.Sz1, 0)) AS SoldQty " _
            '         & " FROM dbo.SalesDetailTable INNER JOIN SalesMasterTable On SalesMasterTable.SalesID = SalesDetailTable.SalesID " _
            '         & " WHERE(SalesMasterTable.CMFADocID <> 0 AND SalesMasterTable.CMFADocID=" & Me.cmbCMFADoc.SelectedValue & ") AND (SalesMasterTable.SalesID=" & Me.grdSaved.CurrentRow.Cells(6).Value.ToString & ") " _
            '         & "  GROUP BY SalesDetailTable.ArticleDefId, SalesMasterTable.CMFADocID, SalesDetailTable.LocationId)a " _
            '         & " WHERE(a.CMFADocId = CMFADetailTable.docID) " _
            '         & " AND CMFADetailTable.ArticleDefID = a.ArticleDefID " _
            '         & " AND a.LocationID = CMFADetailTable.LocationID WHERE CMFADetailTable.DocId=" & Me.cmbCMFADoc.SelectedValue & ""
            '        cmd.ExecuteNonQuery()
            '    End If
            'End If
            'End Task:2702
            'cmd = New OleDbCommand
            'cmd.Connection = Con

            UpdateDeliveryChalanStatus(Val(Me.grdSaved.CurrentRow.Cells("SalesId").Value), "Delete", objTrans)

            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from OutwardExpenseDetailTable WHERE SalesId =" & Val(Me.grdSaved.GetRow.Cells("SalesId").Value.ToString) & ""
            cmd.ExecuteNonQuery()


            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from tblVoucherDetail WHERE Voucher_Id In(Select Voucher_Id From tblVoucher WHERE Voucher_Code=N'" & Me.grdSaved.GetRow.Cells("SalesNo").Value.ToString & "' And Voucher_Code <> Voucher_No)"
            'cm.Transaction = objTrans
            cmd.ExecuteNonQuery()

            'cmd = New OleDbCommand
            'cmd.Connection = Con
            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from tblVoucher WHERE Voucher_Code=N'" & Me.grdSaved.GetRow.Cells("SalesNo").Value.ToString & "' And Voucher_Code <> Voucher_No"
            'cmd.Transaction = objTrans
            cmd.ExecuteNonQuery()

            'cmd = New OleDbCommand
            'cmd.Connection = Con
            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from SalesDetailTable where Salesid=" & Val(Me.grdSaved.CurrentRow.Cells("SalesId").Value)
            'cmd.Transaction = objTrans
            cmd.ExecuteNonQuery()

            ''Start TFS1957
            'cmd = New OleDbCommand
            'cmd.Connection = Con
            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from ProductAssemblyTable where SalesId=" & Val(Me.grdSaved.CurrentRow.Cells("SalesId").Value)
            'cmd.Transaction = objTrans
            cmd.ExecuteNonQuery()
            ''End TFS1957

            'cmd = New OleDbCommand
            'cmd.Connection = Con
            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from SalesMasterTable where Salesid=" & Val(Me.grdSaved.CurrentRow.Cells("SalesId").Value)
            'cmd.Transaction = objTrans
            cmd.ExecuteNonQuery()

            'cmd = New OleDbCommand
            'cmd.Connection = Con
            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from tblvoucherdetail where voucher_id=" & lngVoucherMasterId
            'cmd.Transaction = objTrans
            cmd.ExecuteNonQuery()

            'cmd = New OleDbCommand
            'cmd.Connection = Con
            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from tblvoucher where voucher_id=" & lngVoucherMasterId
            'cmd.Transaction = objTrans
            cmd.ExecuteNonQuery()

            'TASKM166151 Delete Sales Certificate Document Against Salary Invoice
            'cmd = New OleDbCommand
            'cmd.Connection = Con
            cmd.CommandText = String.Empty
            cmd.CommandText = "delete from SalesCertificateTable where SalesCertificateTable.SalesId=" & Val(Me.grdSaved.CurrentRow.Cells("SalesId").Value)
            'cmd.Transaction = objTrans
            cmd.ExecuteNonQuery()
            'End TaskM166151


            'cm = New OleDbCommand
            'cm.Connection = Con
            'cm.Transaction = objTrans

            ''make reversal of saved items in sale order detail table against poid
            'If dtSavedItems.Rows.Count > 0 Then
            '    If flgMultipleSalesOrder = False Then
            '        For Each r As DataRow In dtSavedItems.Rows
            '            cmd.CommandText = String.Empty
            '            cmd.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) - " & r.Item(1) & ") where SalesOrderID = " & Me.grdSaved.CurrentRow.Cells("PoId").Value & " and ArticleDefID = " & r.Item(2) & ""
            '            cmd.ExecuteNonQuery()
            '        Next
            '    Else
            '        For Each r As DataRow In dtSavedItems.Rows
            '            cmd.CommandText = String.Empty
            '            cmd.CommandText = "Update SalesOrderDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) - " & r.Item(1) & ") where SalesOrderID = " & Val(r.Item("SO_ID")) & " and ArticleDefID = " & r.Item(2) & ""
            '            cmd.ExecuteNonQuery()
            '        Next
            '    End If
            'End If
            'If flgMultipleSalesOrder = False Then
            '    cmd.CommandText = String.Empty
            '    cmd.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & Me.grdSaved.CurrentRow.Cells("PoId").Value & ""
            '    cmd.ExecuteNonQuery()
            '    '  End If
            'Else
            '    'cmd.Connection = Con
            '    'cmd.Transaction = objTrans
            '    cmd.CommandText = String.Empty
            '    cmd.CommandText = "Select distinct isnull(so_id,0) as so_id From SalesDetailTable where SalesId=" & Val(Me.txtReceivingID.Text)
            '    Dim dtSO As New DataTable
            '    Dim da1 As New OleDbDataAdapter(cmd)
            '    da1.Fill(dtSO)
            '    dtSO.AcceptChanges()
            '    If dtSO IsNot Nothing Then
            '        If dtSO.Rows.Count > 0 Then
            '            For Each r As DataRow In dtSO.Rows
            '                cmd.CommandText = String.Empty
            '                cmd.CommandText = "Update SalesOrderMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where SalesOrderID = " & Val(r.Item("SO_ID").ToString) & ""
            '                cmd.ExecuteNonQuery()
            '            Next
            '        End If
            '    End If

            'End If


            'If DeliveryChalanId > 0 Then
            '    For Each r As DataRow In dtSavedItems.Rows
            '        cmd.CommandText = String.Empty
            '        cmd.CommandText = "Update DeliveryChalanDetailTable set DeliveredQty = abs(Isnull(DeliveredQty,0) - " & r.Item(0) & "), DeliveredSchemeQty=abs(ISNULL(DeliveredSchemeQty,0) - " & r.Item(1) & ") where DeliveryId = " & Me.grdSaved.CurrentRow.Cells("DeliveryId").Value & " and ArticleDefID = " & r.Item(2) & ""
            '        cmd.ExecuteNonQuery()
            '    Next
            '    cmd.CommandText = String.Empty
            '    cmd.CommandText = "Update DeliveryChalanMasterTable set Status = N'" & EnumStatus.Open.ToString & "' where DeliveryId = " & Me.grdSaved.CurrentRow.Cells("DeliveryId").Value & ""
            '    cmd.ExecuteNonQuery()
            'End If

            lngVoucherId = lngVoucherMasterId
            Voucher_Delete(objTrans)

            StockMaster = New StockMaster
            StockMaster.StockTransId = Convert.ToInt32(StockTransId(grdSaved.CurrentRow.Cells(0).Value, objTrans))
            Call New StockDAL().Delete(StockMaster, objTrans)


            ''TASK TFS4391 
            'If getConfigValueByType("IsDuplicateSales").ToString.ToUpper = "TRUE" Then
            '    Call CreateDuplicateSales(Val(Me.txtReceivingID.Text), "Delete", objTrans)
            'End If
            ''END TFS4391

            objTrans.Commit()

            'Call Delete() 'Upgrading Stock here ...


            SaveActivityLog("POS", Me.Text, EnumActions.Delete, LoginUserId, EnumRecordType.Sales, Me.grdSaved.CurrentRow.Cells(0).Value, True)
            SaveActivityLog("Accounts", Me.Text, EnumActions.Delete, LoginUserId, EnumRecordType.AccountTransaction, Me.grdSaved.CurrentRow.Cells(0).Value, True)
            Me.grdSaved.CurrentRow.Delete()
            'lngVoucherId = lngVoucherMasterId ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
        Catch ex As Exception
            objTrans.Rollback()
            msg_Error("Error occured while deleting record: " & ex.Message)
        Finally
            Con.Close()
            Me.Cursor = Cursors.Default
        End Try

        'Voucher_Delete()
        'msg_Information(str_informDelete)
        Me.txtReceivingID.Text = 0
        Call DisplayRecord()  'Task 2389 Ehtisham ul Haq, reload history after delete record on 21-1-14
        Me.RefreshControls()
        lngVoucherId = 0I
    End Sub

    Private Sub PrintToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnPrint.Click

        'ShowReport("SalesInvoice", "{SalesMasterTable.SalesId}=" & grdSaved.CurrentRow.Cells("SalesId").Value, "Nothing", "Nothing", True)
    End Sub

    Private Sub grd_RowsRemoved(ByVal sender As Object, ByVal e As System.Windows.Forms.DataGridViewRowsRemovedEventArgs)
        Me.GetTotal()
    End Sub


    Private Sub RdoCode_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles RdoCode.CheckedChanged
        If Not Me.IsFormOpend = True Then Exit Sub 'Me.FillCombo("Item")
        'rafay show error index was out of range
        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(1).Column.Key.ToString
    End Sub

    Private Sub rdoName_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdoName.CheckedChanged
        'If Me.IsFormOpend = True Then Me.FillCombo("Item")
        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells(2).Column.Key.ToString
    End Sub

    Private Sub PrintToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintToolStripMenuItem.Click
        Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
        Dim newinvoice As Boolean = False
        Dim strCriteria As String = "Nothing"
        Me.Cursor = Cursors.WaitCursor
        Try

            If Me.grdSaved.RowCount = 0 Then Exit Sub
            PrintLog = New SBModel.PrintLogBE
            PrintLog.DocumentNo = grdSaved.GetRow.Cells("SalesNo").Value.ToString
            PrintLog.UserName = LoginUserName
            PrintLog.PrintDateTime = Date.Now
            Call SBDal.PrintLogDAL.PrintLog(PrintLog)


            '29-Jun-2017: Task # 975: Waqar Raza: Added to apply Sales print if jobcardcard is not selected. 
            If Me.grdSaved.GetRow.Cells("JobCardId").Value > 0 Then

                AddRptParam("@SaleID", Me.grdSaved.GetRow.Cells("JobCardId").Value)
                ShowReport("rptSalesInvoiceJobCard")

            Else

                newinvoice = getConfigValueByType("NewInvoice")

                If newinvoice = True Then
                    str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
                Else
                    str_ReportParam = String.Empty
                    strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
                End If

                If IsPreviewSaleInvoice = False Then
                    'ShowReport(IIf(newinvoice = False, "SalesInvoice", "SalesInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New")
                    ShowReport(IIf(newinvoice = False, "SalesInvoice", "SalesInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
                Else
                    'ShowReport(IIf(newinvoice = False, "SalesInvoice", "SalesInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New")
                    ShowReport(IIf(newinvoice = False, "SalesInvoice", "SalesInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
                End If

            End If

        Catch ex As Exception
            Throw ex
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub PrintGatePToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintGatePToolStripMenuItem.Click
        Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
        Dim newinvoice As Boolean = False
        Dim strCriteria As String = "Nothing"
        Me.Cursor = Cursors.WaitCursor
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            'PrintLog = New SBModel.PrintLogBE
            'PrintLog.DocumentNo = grdSaved.GetRow.Cells("PurchaseReturnNo").Value.ToString
            'PrintLog.UserName = LoginUserName
            'PrintLog.PrintDateTime = Date.Now
            'Call SBDal.PrintLogDAL.PrintLog(PrintLog)
            newinvoice = getConfigValueByType("NewInvoice")
            If newinvoice = True Then
                str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
            Else
                str_ReportParam = String.Empty
                strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
            End If
            If IsPreviewSaleInvoice = False Then
                ShowReport(IIf(newinvoice = False, "GatePass", "GatePassNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            Else
                ShowReport(IIf(newinvoice = False, "GatePass", "GatePassNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            End If
        Catch ex As Exception
            Throw ex
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub PrintListToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintListToolStripMenuItem.Click
        Try
            Me.Cursor = Cursors.WaitCursor
            Dim frmPrintList As New frmPrintInvoice
            ApplyStyleSheet(frmPrintList)
            frmPrintList.ShowDialog()
        Catch ex As Exception
            Throw ex
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    '' ReqId-924 Validation on Group Rights
    Private Sub GetSecurityRights()
        Try
            If LoginGroup = "Administrator" Then
                Me.BtnSave.Enabled = True
                Me.BtnDelete.Enabled = True
                Me.BtnPrint.Enabled = True
                Me.btnSearchDelete.Enabled = True ''R934 Added Dlete Button
                Me.btnSearchPrint.Enabled = True  ''R934 Added Print Button
                Me.btnAttachment.Enabled = True
                AttachmentRight = True
                blnTradePriceExceed = False
                ReceiptPost = True
                PrintVoucherToolStripMenuItem.Enabled = True
                PrintVoucherToolStripMenuItem1.Enabled = True
                IsAdminGroup = True
                IsGetAllAllowed = True
                'Task:1592 Added Future Date Rights
                IsDateChangeAllowed = True
                dtpPODate.MaxDate = Date.Today.AddMonths(3)
                '  DateChange(True)
                ''Start TFS4719
                txtAdjustment.Enabled = True
                Panel3.Enabled = True
                ''End TFS4719
                IsAllowPDPEdit = True ''TFS4718 
                Me.txtPDP.Enabled = True ''TFS4718 
                Exit Sub
            End If
            If getConfigValueByType("NewSecurityRights").ToString = "False" Or getConfigValueByType("NewSecurityRights").ToString = "Error" Then
                If RegisterStatus = EnumRegisterStatus.Expired Then
                    Me.BtnSave.Enabled = False
                    Me.BtnDelete.Enabled = False
                    Me.btnSearchDelete.Enabled = False
                    Me.BtnPrint.Enabled = False
                    Me.btnAttachment.Enabled = False
                    Me.PrintListToolStripMenuItem.Enabled = False
                    PrintToolStripMenuItem.Enabled = False
                    Me.btnSearchDelete.Enabled = False ''R934 Added Dlete Button
                    Me.btnSearchPrint.Enabled = False  ''R934 Added Print Button
                    Me.chkPost.Visible = True
                    If Me.BtnSave.Text <> "&Save" Then Me.chkPost.Checked = True
                    blnTradePriceExceed = False
                    PrintVoucherToolStripMenuItem.Enabled = False
                    PrintVoucherToolStripMenuItem1.Enabled = False
                    IsAdminGroup = False
                    IsGetAllAllowed = False
                    'Task:1592 Added Future Date Rights
                    IsDateChangeAllowed = False
                    DateChange(False)
                    ''Start TFS4719
                    txtAdjustment.Enabled = False
                    Panel3.Enabled = False
                    ''End TFS4719
                    IsAllowPDPEdit = False ''TFS4718
                    Me.txtPDP.Enabled = False ''TFS4718
                    Exit Sub
                End If
                Dim dt As DataTable = GetFormRights(EnumForms.frmSales)
                If Not dt Is Nothing Then
                    If Not dt.Rows.Count = 0 Then

                        If Me.BtnSave.Text = "Save" Or Me.BtnSave.Text = "&Save" Then
                            Me.BtnSave.Enabled = dt.Rows(0).Item("Save_Rights").ToString()
                        Else
                            Me.BtnSave.Enabled = dt.Rows(0).Item("Update_Rights").ToString
                        End If
                        Me.BtnDelete.Enabled = dt.Rows(0).Item("Delete_Rights").ToString
                        Me.btnSearchDelete.Enabled = dt.Rows(0).Item("Delete_Rights").ToString
                        Me.BtnPrint.Enabled = dt.Rows(0).Item("Print_Rights").ToString
                        Me.PrintListToolStripMenuItem.Enabled = dt.Rows(0).Item("Print_Rights").ToString
                        PrintToolStripMenuItem.Enabled = dt.Rows(0).Item("Print_Rights").ToString
                        Me.btnSearchDelete.Enabled = dt.Rows(0).Item("Delete_Rights").ToString ''R934 Added Dlete Button
                        Me.btnSearchPrint.Enabled = dt.Rows(0).Item("Print_Rights").ToString  ''R934 Added Print Button
                        Me.Visible = dt.Rows(0).Item("View_Rights").ToString
                    End If
                End If
                UserPostingRights = GetUserPostingRights(LoginUserId)
                If UserPostingRights = True Then
                    Me.chkPost.Visible = True
                    Me.chkDelivered.Visible = True
                Else
                    Me.chkPost.Visible = False
                    Me.chkPost.Checked = False
                    Me.chkDelivered.Visible = False
                End If
                UserPriceAllowedRights = GetUserPriceAllowedRights(LoginUserId)
                If UserPriceAllowedRights = True Then
                    'Me.Panel2.Visible = True
                    Me.grd.RootTable.Columns(EnumGridDetail.Price).Visible = True
                    Me.grd.RootTable.Columns(EnumGridDetail.Total).Visible = True
                    Me.chkDelivered.Visible = True
                Else
                    'Me.Panel2.Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.Price).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.Total).Visible = False
                    Me.chkDelivered.Visible = False
                End If
                GetSecurityByPostingUser(UserPostingRights, BtnSave, BtnDelete)
            Else
                'Me.Visible = False
                Me.BtnSave.Enabled = False
                Me.BtnDelete.Enabled = False
                Me.btnSearchDelete.Enabled = False
                Me.BtnPrint.Enabled = False
                Me.btnAttachment.Enabled = False
                AttachmentRight = False
                Me.chkPost.Visible = False
                Me.chkPost.Checked = False
                ReceiptPost = False
                Me.chkDelivered.Visible = False
                CtrlGrdBar3.mGridPrint.Enabled = False
                CtrlGrdBar2.mGridPrint.Enabled = False ''TFS1823
                CtrlGrdBar2.mGridExport.Enabled = False ''TFS1823
                CtrlGrdBar3.mGridExport.Enabled = False
                CtrlGrdBar2.mGridExport.Enabled = False  ''TFS1823
                Me.btnSearchDelete.Enabled = False ''R934 Added Dlete Button
                Me.btnSearchPrint.Enabled = False  ''R934 Added Print Button
                CreditSales = False 'Task:2380 Default Cash Sales
                IsAdminGroup = False
                IsGetAllAllowed = False
                'Task:1592 Added Future Date Rights
                IsDateChangeAllowed = False
                DateChange(False)
                CtrlGrdBar3.mGridChooseFielder.Enabled = False ''Task:2406 Added Field Chooser Rights
                'For i As Integer = 0 To Rights.Count - 1
                ''ReqId-924
                blnTradePriceExceed = False
                PrintVoucherToolStripMenuItem.Enabled = False
                PrintVoucherToolStripMenuItem1.Enabled = False
                ''Start TFS4719
                txtAdjustment.Enabled = False
                Panel3.Enabled = False
                ''End TFS4719
                IsAllowPDPEdit = False ''TFS4718
                Me.txtPDP.Enabled = False ''TFS4718
                If Rights Is Nothing Then Exit Sub
                For Each RightstDt As GroupRights In Rights
                    If RightstDt.FormControlName = "View" Then
                        'Me.Visible = True
                    ElseIf RightstDt.FormControlName = "Save" Then
                        If Me.BtnSave.Text = "&Save" Then BtnSave.Enabled = True
                    ElseIf RightstDt.FormControlName = "Update" Then
                        If Me.BtnSave.Text = "&Update" Then BtnSave.Enabled = True
                    ElseIf RightstDt.FormControlName = "Delete" Then
                        Me.BtnDelete.Enabled = True
                        Me.btnSearchDelete.Enabled = True
                    ElseIf RightstDt.FormControlName = "Print" Then
                        Me.BtnPrint.Enabled = True
                        Me.btnSearchPrint.Enabled = True  ''R934 Added Print Button
                        CtrlGrdBar3.mGridPrint.Enabled = True
                        CtrlGrdBar2.mGridPrint.Enabled = True ''TFS1823
                    ElseIf RightstDt.FormControlName = "Export" Then
                        CtrlGrdBar3.mGridExport.Enabled = True
                        CtrlGrdBar2.mGridExport.Enabled = True ''TFS1823
                    ElseIf RightstDt.FormControlName = "Post" Then
                        Me.chkPost.Visible = True
                        If Me.BtnSave.Text = "&Save" Then Me.chkPost.Checked = True
                    ElseIf RightstDt.FormControlName = "Price Allow" Then
                        'Me.Panel2.Visible = True
                        Me.grd.RootTable.Columns("Rate").Visible = True
                        Me.grd.RootTable.Columns("Total").Visible = True
                        Me.chkDelivered.Visible = True
                        'Task:2380 Added Security Rights
                    ElseIf RightstDt.FormControlName = "Credit Sales" Then
                        CreditSales = True
                        'End Task:2380
                        'Task:2406 Added Field Chooser Rights
                    ElseIf RightstDt.FormControlName = "Field Chooser" Then
                        CtrlGrdBar3.mGridChooseFielder.Enabled = True
                        'End Task:2406
                    ElseIf RightstDt.FormControlName = "Trade Price Exceed" Then
                        blnTradePriceExceed = True
                    ElseIf RightstDt.FormControlName = "Receipt Voucher Post" Then
                        ReceiptPost = True
                    ElseIf RightstDt.FormControlName = "Get All" Then
                        IsGetAllAllowed = True
                        'Task:1592 Added Future Date Rights
                    ElseIf RightstDt.FormControlName = "Future Transaction" Then
                        IsDateChangeAllowed = True
                        DateChange(True)
                    ElseIf RightstDt.FormControlName = "Attachment" Then
                        Me.btnAttachment.Enabled = True
                        AttachmentRight = True
                    ElseIf RightstDt.FormControlName = "Receipt Voucher Post" Then
                        ReceiptPost = True
                    ElseIf RightstDt.FormControlName = "Print Voucher" Then
                        PrintVoucherToolStripMenuItem.Enabled = True
                        PrintVoucherToolStripMenuItem1.Enabled = True
                    ElseIf RightstDt.FormControlName = "Allow Price Editing" Then
                        ''Start TFS4719
                        txtAdjustment.Enabled = True
                        Panel3.Enabled = True
                        ''End TFS4719
                        IsAllowPDPEdit = True
                        Me.txtPDP.Enabled = True ''TFS4718 
                    End If
                Next
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    'Task:1592 Added Future Date Rights
    Private Sub DateChange(ByRef IsDateChangeAllowed As Boolean)
        Try
            If IsDateChangeAllowed = False Then
                dtpPODate.MaxDate = DateTime.Now.ToString("yyyy/M/d 23:59:59")
            Else
                dtpPODate.MaxDate = Date.Today.AddMonths(3)
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    'END TASk:1592
    Private Sub cmbBatchNo_Enter(ByVal sender As Object, ByVal e As System.EventArgs)
        Me.cmbBatchNo.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.Dropdown)
    End Sub
    Private Sub cmbBatchNo_Leave(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            Me.txtStock.Text = Me.cmbBatchNo.ActiveRow.Cells("Stock").Value.ToString
        Catch ex As Exception
        End Try
    End Sub
    Private Sub cmbBatchNo_ValueChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        If Not Me.cmbBatchNo.ActiveRow Is Nothing Then
            Me.txtStock.Text = Me.cmbBatchNo.ActiveRow.Cells("Stock").Value
        End If
    End Sub

    Private Sub cmbVendor_KeyDown(sender As Object, e As KeyEventArgs) Handles cmbVendor.KeyDown
        Try
            ''TFS1781 : Ayesha Rehman :Added for Selection of Customer or Vendor
            If e.KeyCode = Keys.F1 Then
                If getConfigValueByType("Show Vendor On Sales") = "True" Then
                    'frmSearchCustomersVendors.rbtCustomers.Checked = True
                    'frmSearchCustomersVendors.rbtVendors.Checked = True
                    'frmSearchCustomersVendors.rbtCustomers.Visible = True
                    'frmSearchCustomersVendors.rbtVendors.Visible = True
                    frmAccountSearch.AccountType = "'Vendor','Customer' "
                Else
                    'frmSearchCustomersVendors.rbtCustomers.Checked = True
                    'frmSearchCustomersVendors.rbtVendors.Checked = False
                    'frmSearchCustomersVendors.rbtCustomers.Visible = True
                    'frmSearchCustomersVendors.rbtVendors.Visible = False
                    frmAccountSearch.AccountType = "'Customer'"
                End If

                frmAccountSearch.BringToFront()
                frmAccountSearch.ShowDialog()
                If frmAccountSearch.DialogResult = Windows.Forms.DialogResult.OK Then
                    cmbVendor.Value = frmAccountSearch.SelectedAccountId
                End If
            End If
            '1686 : Ayesha Rehman :Added for Showing Customer or Vendor
            If e.KeyCode = Keys.F2 Then
                frmShowCustomerVendor.SelectedAccountId = Me.cmbVendor.Value
                frmShowCustomerVendor.BringToFront()
                frmShowCustomerVendor.ShowDialog()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Task:2702 Added Event CMFA Document Load
    Private Sub cmbVendor_Leave(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbVendor.Leave
        Try
            If cmbVendor.ActiveRow Is Nothing Then Exit Sub
            If IsFormOpend = True Then
                If Me.cmbVendor.ActiveRow IsNot Nothing Then
                    If Me.cmbVendor.IsItemInList = False Then Exit Sub
                    _Previous_Balance = GetCurrentBalance(Me.cmbVendor.Value)
                    FillCombo("CMFA")
                End If

                If Val(Me.cmbVendor.ActiveRow.Cells(Customer.SaleMan).Value.ToString) > 0 Then
                    Me.cmbSalesMan.SelectedValue = Val(Me.cmbVendor.ActiveRow.Cells(Customer.SaleMan).Value.ToString)
                    If Me.cmbSalesMan.SelectedValue Is Nothing Then
                        If Me.cmbSalesMan.SelectedIndex = -1 Then Me.cmbSalesMan.SelectedIndex = 0
                    End If
                End If
                Me.txtCurrentBalance.Text = GetCurrentBalance(Me.cmbVendor.Value)
                Me.txtDueDays.Text = Val(Me.cmbVendor.ActiveRow.Cells("CreditDays").Value.ToString)
                'If Val(Me.cmbVendor.ActiveRow.Cells("discount").Value.ToString) > 0 Then
                '    Me.rbtAdjPercentage.Checked = True
                '    Me.txtAdjustment.Text = Val(Me.cmbVendor.ActiveRow.Cells("discount").Value.ToString)
                'Else
                '    rbtAdjFlat.Checked = True
                '    Me.txtAdjustment.Text = ""
                'End If
                If Val(Me.cmbVendor.ActiveRow.Cells("Other Expense").Value.ToString) > 0 Then
                    Me.txtExpense.Text = Val(Me.cmbVendor.ActiveRow.Cells("Other Expense").Value.ToString)
                Else
                    Me.txtExpense.Text = ""
                End If
            Else
                Exit Sub
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2702
    'Task:2417 Added Event Item Filter By Customer
    Private Sub cmbVendor_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            If IsFormOpend = True Then
                If Me.rbtCustomer.Checked = True Then
                    If Me.cmbVendor.IsItemInList = False Then Exit Sub
                    FillCombo("Item")
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2417
    Private Sub cmbVendor_ValueChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbVendor.ValueChanged
        Try

            If Me.cmbVendor.ActiveRow Is Nothing Then Exit Sub
            If Me.cmbVendor.IsItemInList = False Then Exit Sub
            Dim Str As String = String.Empty
            'If Me.IsEditMode = False Then
            '    'Before against R:M6
            '    'Str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(Varchar(12), SalesOrderDate, 113) As SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date,ISNULL(SpecialAdjustment,0) as SpecialAdjustment from SalesOrderMasterTable where  status = N'" & EnumStatus.Open.ToString & "' and VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & " and Status = N'" & EnumStatus.Open.ToString & "'"
            '    'R:M6 Filter By Post
            '    Str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(Varchar(12), SalesOrderDate, 113) As SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date,ISNULL(SpecialAdjustment,0) as SpecialAdjustment from SalesOrderMasterTable where  status = N'" & EnumStatus.Open.ToString & "' and VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & " and Status = N'" & EnumStatus.Open.ToString & "' AND Posted=1"
            '    'End R:M6
            '    FillDropDown(cmbPo, Str)
            '    Me.txtFuel.Text = Val(Me.cmbVendor.ActiveRow.Cells(Customer.Fuel).Text)
            '    Me.txtExpense.Text = Val(Me.cmbVendor.ActiveRow.Cells(Customer.Other_Exp).Text)
            'Else
            '    'Before against R:M6
            '    'Str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(Varchar(12), SalesOrderDate, 113) As SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date,ISNULL(SpecialAdjustment,0) as SpecialAdjustment  from SalesOrderMasterTable where VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & ""
            '    'R:M6 Filter By Post
            '    Str = "Select SalesOrderID, SalesOrderNo + ' ~ ' + Convert(Varchar(12), SalesOrderDate, 113) As SalesOrderNo,Remarks, CostCenterId, PONo,PO_Date,SOP_ID,Delivery_Date,ISNULL(SpecialAdjustment,0) as SpecialAdjustment  from SalesOrderMasterTable where VendorID = " & Me.cmbVendor.ActiveRow.Cells(0).Value & " AND Posted=1"
            '    'End R:M6
            '    FillDropDown(cmbPo, Str)
            'End If
            FillCombo("SO")
            FillCombo("DeliveryChalan")
            FillCombo("CMFA") 'Task:2702 Get CMFA
            If Me.rdoCNG.Checked = True Then
                Me.txtFuel.Text = Val(Me.cmbVendor.ActiveRow.Cells("CNG").Value.ToString)
            ElseIf Me.rdoFuel.Checked = True Then
                Me.txtFuel.Text = Val(Me.cmbVendor.ActiveRow.Cells("Fuel").Value.ToString)
            End If
            If Me.rbtCustomer.Checked = True Then
                If IsFormOpend = True Then FillCombo("Item")
            End If
            'If IsFormOpend = True Then
            'If Not GetConfigValue("ServiceItem").ToString = "True" Then

            If Val(Me.cmbVendor.ActiveRow.Cells(Customer.SaleMan).Value.ToString) > 0 Then
                Me.cmbSalesMan.SelectedValue = Val(Me.cmbVendor.ActiveRow.Cells(Customer.SaleMan).Value.ToString)
                If Me.cmbSalesMan.SelectedValue Is Nothing Then
                    If Me.cmbSalesMan.SelectedIndex = -1 Then Me.cmbSalesMan.SelectedIndex = 0
                End If
            End If

            ''Customer wise discount should be applied on value changed.
            'start
            If Val(Me.cmbVendor.ActiveRow.Cells("discount").Value.ToString) > 0 Then
                Me.rbtAdjPercentage.Checked = True
                Me.txtAdjustment.Text = Val(Me.cmbVendor.ActiveRow.Cells("discount").Value.ToString)
            Else
                rbtAdjFlat.Checked = True
                Me.txtAdjustment.Text = ""
            End If
            'end

            If flgLoadAllItems = True Then
                Str = "Select CustomerTypes From tblCustomer WHERE AccountId=" & Me.cmbVendor.Value
                Dim dt As DataTable = GetDataTable(Str)
                If Not dt Is Nothing Then
                    If dt.Rows.Count > 0 Then
                        Me.DisplayDetail(-1, dt.Rows(0).Item(0), "LoadAll")
                    Else
                        Me.DisplayDetail(-1, -1, "LoadAll")
                    End If
                End If
                For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    If Me.grd.RowCount > 0 Then
                        r.BeginEdit()
                        r.Cells("LocationId").Value = Me.cmbCategory.SelectedValue
                        r.EndEdit()
                    End If
                Next
            Else
                'Me.DisplayDetail(-1)
            End If
            'End If
            Me.txtInvParty.Text = Me.cmbVendor.ActiveRow.Cells("Name").Value.ToString ''19-June-2014 TASK:2698 IMRAN ALI Default Selected Invoice Party Through Customer List(Ravi)
            Me.CtrlGrdBar3_Load(Nothing, Nothing)
            CtrlGrdBar3_Load(Nothing, Nothing)
            CtrlGrdBar3.Email = New SBModel.SendingEmail
            CtrlGrdBar3.Email.ToEmail = Me.cmbVendor.ActiveRow.Cells("Email").Text
            CtrlGrdBar3.Email.Subject = "Sales: " + "(" & Me.txtPONo.Text & ")"
            CtrlGrdBar3.Email.DocumentNo = Me.txtPONo.Text
            CtrlGrdBar3.Email.DocumentDate = Me.dtpPODate.Value
            'End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub txtPackQty_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtPackQty.TextChanged
    '    txtTotal.Text = Val(txtQty.Text) * Val(txtPackQty.Text) * Val(txtRate.Text)
    '    If Me.txtPackQty.Text.Length > 0 Then
    '        Me.txtPackRate.Text = Val(Me.txtPackQty.Text) * Val(Me.txtRate.Text)
    '    End If
    'End Sub
    Private Sub cmbCompany_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbCompany.SelectedIndexChanged
        Try
            If Not IsEditMode = True AndAlso IsFormOpend = True Then
                If blnRefreshMod = False Then Me.RefreshControls()
                Me.DisplayRecord()
                'Task:2677 Enabled/Disabled Controls
                blnCommercialInvoice = CType(Me.cmbCompany.SelectedItem, DataRowView).Row.Item("CommercialInvoice")
                If blnCommercialInvoice = True Then
                    Me.txtTax.Enabled = False
                    Me.grd.RootTable.Columns(EnumGridDetail.Tax).EditType = Janus.Windows.GridEX.EditType.NoEdit
                Else
                    Me.txtTax.Enabled = True
                    Me.grd.RootTable.Columns(EnumGridDetail.Tax).EditType = Janus.Windows.GridEX.EditType.TextBox
                End If
                'End Task:2677
            End If
            'companyId = IIf(Me.cmbCompany.SelectedIndex = 0, 0, Me.cmbCompany.SelectedValue) 'Comment Against Task:M28
            companyId = IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue) ''Task:M28 #TODO Nothing Status
            'Task:2427 CostCenter Selected Company Wise
            If Not Me.cmbCompany.SelectedIndex = -1 Then
                If Not Me.cmbProject.SelectedIndex = -1 Then Me.cmbProject.SelectedValue = Val(CType(Me.cmbCompany.SelectedItem, DataRowView).Row.Item("CostCenterId").ToString)
            End If
            'End Task:2427
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtBarcode_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs)
        Try
            If e.KeyCode = Keys.Enter Then
                '    Me.ErrorProvider1.Clear()
                '    lblError.Text = String.Empty
                '    If Me.cmbCodes.Focused Then
                '        If Me.cmbCodes.ActiveRow.Index = 0 Then Exit Sub
                '        Me.txtBarcode.Text = Me.cmbCodes.ActiveRow.Cells("Code").Value
                '        Me.cmbCodes.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.CloseDropdown)
                '    End If

                '    If Me.cmbItem.IsItemInList(Me.txtBarcode.Text) Then
                '        'Me.cmbCategory.SelectedValue = objDataSet.Tables(0).Rows(i)("ArticleGroupId")
                '        'Me.cmbCategory_SelectedIndexChanged(Nothing, Nothing)

                '        ''selecting the item
                '        ' Me.cmbItem.Value = Me.txtBarcode.Text
                '        Me.cmbItem.Text = Me.txtBarcode.Text
                '        'me.cmbItem.ActiveRow=me.cmbItem.Rows(me.cmbItem.S               'Me.cmbItem.Text = Me.txtBarcode.Text
                '        'Me.cmbItem.Select()

                '        'Me.cmbItem.SelectedRow=me
                '        Me.cmbItem_Leave(Nothing, Nothing)

                '        ''selecting batch no
                '        ' Me.cmbBatchNo.Text = objDataSet.Tables(0).Rows(i)("BatchNo")
                '        Me.cmbBatchNo_Leave(Nothing, Nothing)

                '        ''selecting unit
                '        Me.cmbUnit.SelectedIndex = 0
                '        Me.cmbUnit_SelectedIndexChanged(Nothing, Nothing)

                '        ''selecting qty
                '        Me.txtQty.Text = 1
                '        txtPackQty.Text = "1"
                '        Me.txtQty_LostFocus(Nothing, Nothing)
                '        'Me.txtQty_TextChanged(Nothing, Nothing)

                '        ''selecing rate
                '        'Me.txtRate.Text = objDataSet.Tables(0).Rows(i)(4)

                '        Me.txtTotal.Text = Val(Me.txtRate.Text) * Val(Me.txtQty.Text)

                '        Me.btnAdd_Click(Nothing, Nothing)


                '        'lblError.Text = "Code Found"
                '        Me.txtBarcode.Text = String.Empty
                '        Me.txtBarcode.Focus()

                '    Else
                '        Me.txtBarcode.Focus()
                '        Me.txtBarcode.SelectAll()
                '        lblError.Text = "Invalid code"
                '        Me.ErrorProvider1.SetError(Me.txtBarcode, "Invalid Code")
                '        'Spech.SelectVoice("Error")
                '        'Spech.SpeakAsync("Try again")

                '    End If
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
        End Try
    End Sub

    Private Sub cmbCodes_Leave(ByVal sender As Object, ByVal e As System.EventArgs)
    End Sub

    'Private Sub cmbCodes_Enter(ByVal sender As Object, ByVal e As System.EventArgs)
    '    Me.cmbCodes.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.ToggleDropdown)
    'End Sub

    Private Sub ToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        SaveToolStripButton_Click(Me, Nothing)
    End Sub

    Private Sub RefreshItemsToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            FillCombo("Item")
            FillCombo("Barcodes")

        Catch ex As Exception

        End Try
    End Sub

    Private Sub BackgroundWorker1_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs)
        Me.txtReceivingID.Text = InvId
        str_ReportParam = "@SaleID|" & IIf(Val(Me.txtReceivingID.Text) > 0, Val(Me.txtReceivingID.Text), grdSaved.CurrentRow.Cells("SalesId").Value)
        Dim newinvoice As Boolean = False
        Try
            newinvoice = getConfigValueByType("NewInvoice")
        Catch ex As Exception
            newinvoice = False
        End Try
        ShowReport(IIf(newinvoice = False, "SalesInvoice", "SalesInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, "Nothing", "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
    End Sub


    Private Sub SummaryOfSalesInvoicesToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles SummaryOfSalesInvoicesToolStripMenuItem2.Click
        frmMain.LoadControl("rptSumOfInv")
    End Sub

    Private Sub SummaryOfSalesInvoicesToolStripMenuItem2_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        frmMain.LoadControl("rptSumOfInv")
    End Sub

    Private Sub ReciveablesToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ReciveablesToolStripMenuItem1.Click
        ShowReport("AgeingReceivable", "Nothing", "Nothing", Date.Now.Date.ToString("yyyy-M-d 00:00:00"), False)
    End Sub

    Private Sub CatageoryWiseSaleToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CatageoryWiseSaleToolStripMenuItem1.Click
        frmMain.LoadControl("rptCategoryWiseSaleReport")
    End Sub

    Private Sub AreaWiseSaleReportToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles AreaWiseSaleReportToolStripMenuItem1.Click
        frmMain.LoadControl("rptAreaProdSale")
    End Sub

    Private Sub ItemWiseSaleReToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ItemWiseSaleReToolStripMenuItem.Click
        frmMain.LoadControl("ItemWiseSalesrpt")
    End Sub

    Private Sub ItemWiseSaleReToolStripMenuItem_Click_1(ByVal sender As System.Object, ByVal e As System.EventArgs)
    End Sub

    Private Sub ItemWiseSaleReToolStripMenuItem_Click_2(ByVal sender As System.Object, ByVal e As System.EventArgs)
        frmMain.LoadControl("itemWiseRpt")
    End Sub

    Private Sub grd_CellContentClick(ByVal sender As System.Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs)

    End Sub
    Private Sub ToolStripButton2_Click_1(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ToolStripButton2.Click
        '    frmMain.LoadControl("AddCustomer")
        Dim CustId As Integer = 0
        CustId = Me.cmbVendor.Value

        ''Task 3461: Aashir: Edited Becuase Shortcut link account add option was not working 
        'FrmAddCustomers.FormType = "Customer"
        'FrmAddCustomers.ShowDialog()
        frmMain.LoadControl("AddCustomer")


        Me.FillCombo("Vendor")
        Me.cmbVendor.Value = CustId
    End Sub

    Private Sub CustomerTypeToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CustomerTypeToolStripMenuItem.Click
        frmMain.LoadControl("CustomerType")
    End Sub

    Private Sub PrepareGrid()
        Try
            Me.DisplayDetail(-1)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub ApplyGridSettings(Optional ByVal condition As String = "") Implements IGeneral.ApplyGridSettings
        Try
            Dim StockInConfigration As String = "" ''1596
            If getConfigValueByType("WeighbridgeSaleOrder").ToString.ToUpper = "TRUE" Then

                Me.grd.RootTable.Columns(EnumGridDetail.Gross_Weights).Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.Tray_Weights).Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.Net_Weight).Visible = True

            Else

                Me.grd.RootTable.Columns(EnumGridDetail.Gross_Weights).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.Tray_Weights).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.Net_Weight).Visible = False

            End If

            Me.grd.AutomaticSort = False
            Me.grd.AllowEdit = Janus.Windows.GridEX.InheritableBoolean.True
            Me.grd.AllowDelete = Janus.Windows.GridEX.InheritableBoolean.True
            Me.grd.RootTable.Columns(EnumGridDetail.ArticleID).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.BatchID).Visible = False
            Me.grd.RootTable.Columns("Batch No").Visible = True
            'Me.grd.RootTable.Columns(EnumGridDetail.LoadQty).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.CurrentPrice).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.GroupID).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.LocationID).Visible = True
            Me.grd.RootTable.Columns(EnumGridDetail.LocationID).Caption = "Location"
            Me.grd.RootTable.Columns(EnumGridDetail.TradePrice).Caption = "Trade Price"
            Me.grd.RootTable.Columns(EnumGridDetail.RetailPrice).Caption = "Retail Price" ''TFS1154
            'Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).Caption = "Discount Type" ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).Caption = "Discount Type" ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountFactor).Caption = "Discount Factor" ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountValue).Caption = "Discount value" ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).Caption = "PDP" ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).Visible = True    ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).Visible = True      ''TFS1153
            Me.grd.RootTable.Columns("So_Id").Caption = "Sales Order"
            Me.grd.RootTable.Columns(EnumGridDetail.SaleDetailID).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.PackQty).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.SavedQty).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.PurchasePrice).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.Discount_Percentage).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.PackPrice).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.Pack_Desc).Visible = True
            Me.grd.RootTable.Columns(EnumGridDetail.Unit).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.CostPrice).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.Pack_Desc).Caption = "Unit"
            Me.grd.RootTable.Columns(EnumGridDetail.ApplyAdjustmentFuelExp).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.BaseCurrencyId).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.CurrencyId).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.ApplyAdjustmentFuelExp).Visible = False
            'Me.grd.RootTable.Columns(EnumGridDetail.BaseCurrencyId).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.BaseCurrencyRate).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.SODetailId).Visible = False

            Me.grd.RootTable.Columns(EnumGridDetail.OldSalePrice).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.SalePriceProcessId).Visible = False

            Me.grd.TotalRow = Janus.Windows.GridEX.InheritableBoolean.True
            Me.grd.TotalRowPosition = Janus.Windows.GridEX.TotalRowPosition.BottomFixed
            Me.grd.RootTable.Columns(EnumGridDetail.Qty).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.Price).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.Tax).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.SED).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            'Me.grd.RootTable.Columns(EnumGridDetail.ServiceQty).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.Total).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.Freight).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.NetBill).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.TradePrice).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.RetailPrice).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1154
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountValue).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountFactor).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.Discount_Percentage).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far

            Me.grd.RootTable.Columns(EnumGridDetail.BardanaDeduction).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.OtherDeduction).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.AfterDeductionQty).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.BardanaDeduction).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.OtherDeduction).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.AfterDeductionQty).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum

            Me.grd.RootTable.Columns(EnumGridDetail.BardanaDeduction).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.OtherDeduction).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.AfterDeductionQty).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.BardanaDeduction).TotalFormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.OtherDeduction).TotalFormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.AfterDeductionQty).TotalFormatString = "N" & DecimalPointInQty


            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).FormatString = "N" & DecimalPointInValue  ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).FormatString = "N" & TotalAmountRounding  ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.Price).FormatString = "N" & DecimalPointInValue ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.Price).FormatString = "N" & TotalAmountRounding ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum  ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.Price).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).FormatString = "N" & TotalAmountRounding   ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).TotalFormatString = "N" & TotalAmountRounding   ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.Price).FormatString = "N" & TotalAmountRounding ''TFS1964
            Me.grd.RootTable.Columns(EnumGridDetail.Price).TotalFormatString = "N" & TotalAmountRounding ''TFS1964

            Me.grd.RootTable.Columns(EnumGridDetail.Total).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(EnumGridDetail.Total).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.Total).TotalFormatString = "N" & TotalAmountRounding ''27-Jul-2014 Task:2762 Imran Ali Total Amount Rounding configuration

            Me.grd.RootTable.Columns(EnumGridDetail.Price).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.Qty).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.Qty).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.SED).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            'Me.grd.RootTable.Columns(EnumGridDetail.ServiceQty).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            'Me.grd.RootTable.Columns(EnumGridDetail.ServiceQty).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.Total).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.Total).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.TradePrice).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.RetailPrice).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1154
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountValue).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountFactor).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far ''TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.Discount_Percentage).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            'Me.grd.RootTable.Columns(EnumGridDetail.Freight).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.Freight).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far

            Me.grd.RootTable.Columns(EnumGridDetail.PackPrice).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.PackPrice).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far

            Me.grd.RootTable.Columns(EnumGridDetail.MarketReturns).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.MarketReturns).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far

            Me.grd.RootTable.Columns(EnumGridDetail.NetBill).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.NetBill).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far

            Me.grd.RootTable.Columns(EnumGridDetail.Price).FormatString = "N"
            Me.grd.RootTable.Columns(EnumGridDetail.CurrentPrice).FormatString = "N"
            Me.grd.RootTable.Columns(EnumGridDetail.RetailPrice).FormatString = "N"
            Me.grd.RootTable.Columns(EnumGridDetail.CostPrice).FormatString = "N"
            Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount).FormatString = "N"
            Me.grd.RootTable.Columns(EnumGridDetail.TradePrice).FormatString = "N"


            Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).FormatString = str_DisplayDateFormat


            'Me.grd.RootTable.Columns(EnumGridDetail.Tax).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.Tax).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far

            'Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).Position = EnumGridDetail.NetBill

            For Each c As Janus.Windows.GridEX.GridEXColumn In Me.grd.RootTable.Columns

                If c.Index <> EnumGridDetail.LocationID AndAlso c.Index <> EnumGridDetail.LoadQty AndAlso c.Index <> EnumGridDetail.Price AndAlso c.Index <> EnumGridDetail.RetailPrice AndAlso c.Index <> EnumGridDetail.Tax AndAlso c.Index <> EnumGridDetail.SampleQty AndAlso c.Index <> EnumGridDetail.SED AndAlso c.Index <> EnumGridDetail.TradePrice AndAlso c.Index <> EnumGridDetail.Discount_Percentage AndAlso c.Index <> EnumGridDetail.Freight AndAlso c.Index <> EnumGridDetail.MarketReturns AndAlso c.Index <> EnumGridDetail.BatchNo AndAlso c.Index <> EnumGridDetail.Origin AndAlso c.Index <> EnumGridDetail.PackPrice AndAlso c.Index <> EnumGridDetail.Comments AndAlso c.Index <> EnumGridDetail.Engine_No AndAlso c.Index <> EnumGridDetail.Chassis_No AndAlso c.Index <> EnumGridDetail.ExpiryDate AndAlso c.Index <> EnumGridDetail.OtherComments AndAlso c.Index <> EnumGridDetail.Transport_Charges AndAlso c.Index <> EnumGridDetail.TotalQty AndAlso c.Index <> EnumGridDetail.Gross_Weights AndAlso c.Index <> EnumGridDetail.Tray_Weights AndAlso c.Index <> EnumGridDetail.Net_Weight AndAlso c.Index <> EnumGridDetail.CurrencyAmount AndAlso c.Index <> EnumGridDetail.DiscountId AndAlso c.Index <> EnumGridDetail.BardanaDeduction AndAlso c.Index <> EnumGridDetail.OtherDeduction Then
                    c.EditType = Janus.Windows.GridEX.EditType.NoEdit
                End If


            Next
            ''Start TFS4161
            If IsPackQtyDisabled = True Then
                Me.grd.RootTable.Columns(EnumGridDetail.TotalQty).EditType = Janus.Windows.GridEX.EditType.NoEdit
            Else
                Me.grd.RootTable.Columns(EnumGridDetail.TotalQty).EditType = Janus.Windows.GridEX.EditType.TextBox
            End If
            ''End TFS4161
          

            For Each col As Janus.Windows.GridEX.GridEXColumn In Me.grdOutwardExpDetail.RootTable.Columns
                If col.Index <> 3 AndAlso col.Index <> 4 Then
                    col.EditType = Janus.Windows.GridEX.EditType.NoEdit
                End If
            Next
            ''Start Task 1596
            If Not getConfigValueByType("StockOutConfigration").ToString = "Error" Then ''1596
                StockInConfigration = getConfigValueByType("StockOutConfigration").ToString
            End If
            'ShowInformationMessage(StockInConfigration)
            If StockInConfigration.Equals("Disabled") Then
                Me.grd.RootTable.Columns("Batch No").Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).Visible = False
                Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.NoEdit
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).EditType = Janus.Windows.GridEX.EditType.NoEdit
                Me.grd.RootTable.Columns("Origin").Visible = False
                Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.NoEdit
            ElseIf StockInConfigration.Equals("Enabled") Then
                Me.grd.RootTable.Columns("Batch No").Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).Visible = True
                Me.grd.RootTable.Columns("Batch No").HasValueList = True
                Me.grd.RootTable.Columns("Batch No").LimitToList = False
                Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.Combo
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).EditType = Janus.Windows.GridEX.EditType.CalendarDropDown
                Me.grd.RootTable.Columns("Origin").Visible = True
                Me.grd.RootTable.Columns("Origin").HasValueList = True
                Me.grd.RootTable.Columns("Origin").LimitToList = False
                Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.Combo
                'Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).EditType = Janus.Windows.GridEX.EditType.TextBox
            Else
                Me.grd.RootTable.Columns("Batch No").Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).Visible = True
                Me.grd.RootTable.Columns("Batch No").HasValueList = True
                Me.grd.RootTable.Columns("Batch No").LimitToList = False
                Me.grd.RootTable.Columns("Batch No").EditType = Janus.Windows.GridEX.EditType.Combo
                Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).EditType = Janus.Windows.GridEX.EditType.CalendarDropDown
                Me.grd.RootTable.Columns("Origin").Visible = True
                Me.grd.RootTable.Columns("Origin").HasValueList = True
                Me.grd.RootTable.Columns("Origin").LimitToList = False
                Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.Combo
                'Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).EditType = Janus.Windows.GridEX.EditType.TextBox
            End If
            ''End Task 1596
            Me.grd.RootTable.Columns(EnumGridDetail.RetailPrice).EditType = Janus.Windows.GridEX.EditType.TextBox 'TFS1154
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountValue).EditType = Janus.Windows.GridEX.EditType.NoEdit 'TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountFactor).EditType = Janus.Windows.GridEX.EditType.TextBox 'TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).EditType = Janus.Windows.GridEX.EditType.TextBox  'TFS1153

            Me.grd.RootTable.Columns(EnumGridDetail.Price).EditType = Janus.Windows.GridEX.EditType.NoEdit 'TFS1153
            Me.grd.RootTable.Columns(EnumGridDetail.Qty).EditType = Janus.Windows.GridEX.EditType.TextBox
            Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).EditType = Janus.Windows.GridEX.EditType.TextBox
            Me.grd.RootTable.Columns(EnumGridDetail.LoadQty).EditType = Janus.Windows.GridEX.EditType.TextBox

            Me.grd.RootTable.Columns.Add(EnumGridDetail.DeleteButton).EditType = Janus.Windows.GridEX.EditType.NoEdit
            Me.grd.RootTable.Columns(EnumGridDetail.DeleteButton).Key = "Delete"
            Me.grd.RootTable.Columns(EnumGridDetail.DeleteButton).Caption = "Action"
            Me.grd.RootTable.Columns(EnumGridDetail.DeleteButton).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Center
            Me.grd.RootTable.Columns(EnumGridDetail.DeleteButton).TextAlignment = Janus.Windows.GridEX.TextAlignment.Center
            Me.grd.RootTable.Columns(EnumGridDetail.DeleteButton).ButtonDisplayMode = Janus.Windows.GridEX.CellButtonDisplayMode.Always
            Me.grd.RootTable.Columns(EnumGridDetail.DeleteButton).ButtonStyle = Janus.Windows.GridEX.ButtonStyle.ButtonCell
            Me.grd.RootTable.Columns(EnumGridDetail.DeleteButton).ButtonText = "Delete"

            'Task:2374 Total Amount Column Format
            Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum
            Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).TotalFormatString = "N" & TotalAmountRounding ''27-Jul-2014 Task:2762 Imran Ali Total Amount Rounding configuration
            Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).TotalFormatString = "N" & TotalAmountRounding ''27-Jul-2014 Task:2762 Imran Ali Total Amount Rounding configuration

            Me.grd.RootTable.Columns(EnumGridDetail.Qty).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.Qty).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.LoadQty).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.LoadQty).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.TotalQty).FormatString = "N" & DecimalPointInQty
            Me.grd.RootTable.Columns(EnumGridDetail.TotalQty).FormatString = "N" & TotalAmountRounding


            Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum

            Me.grd.RootTable.Columns("CurrencyAmount").TextAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns("CurrencyAmount").HeaderAlignment = Janus.Windows.GridEX.TextAlignment.Far
            Me.grd.RootTable.Columns("CurrencyAmount").AggregateFunction = Janus.Windows.GridEX.AggregateFunction.Sum

            Me.grd.RootTable.Columns(EnumGridDetail.Tax).Caption = "Tax %"
            Me.grd.RootTable.Columns(EnumGridDetail.SED).Caption = "SED %"

            'End Task:2374 Total Amount 

            'Me.grd.RootTable.Columns(EnumGridDetail.SO_ID).EditType = Janus.Windows.GridEX.EditType.Combo
            If flgLoadAllItems = False Then
                Me.grd.RootTable.Columns("Pack_Desc").Position = Me.grd.RootTable.Columns("Unit").Index
                Me.grd.RootTable.Columns("Unit").Position = Me.grd.RootTable.Columns("Pack_Desc").Index
                Me.grd.RootTable.Columns("Pack_Desc").Visible = True
                Me.grd.RootTable.Columns("Unit").Visible = False
            Else
                Me.grd.RootTable.Columns("Pack_Desc").Visible = False
                Me.grd.RootTable.Columns("Unit").Visible = True
            End If
            'Task:M16 Engine_No And Chassis_No Column Enable/Disabled
            If flgVehicleIdentificationInfo = True Then
                Me.grd.RootTable.Columns("Engine_No").Visible = True
                Me.grd.RootTable.Columns("Chassis_No").Visible = True
            Else
                Me.grd.RootTable.Columns("Engine_No").Visible = False
                Me.grd.RootTable.Columns("Chassis_No").Visible = False
            End If
            'End Task:M16


            Me.grd.RootTable.Columns("SalesReturnQty").Visible = False 'TaskM610151  Hidden Column SalesReturnQty
            'Me.grd.RootTable.Columns("BaseCurrencyId").Visible = False
            'Me.grd.RootTable.Columns("BaseCurrencyRate").Visible = False
            'Me.grd.RootTable.Columns("CurrencyId").Visible = False
            ''Start TFS4161
            If IsAllowPDPEdit = False Then
                Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).EditType = Janus.Windows.GridEX.EditType.NoEdit
            Else
                Me.grd.RootTable.Columns(EnumGridDetail.PostDiscountPrice).EditType = Janus.Windows.GridEX.EditType.TextBox
            End If
            ''End TFS4161



            'Task:2759 Set Rounded Amount Format
            'Me.grd.RootTable.Columns(EnumGridDetail.Total).FormatString = "N" & DecimalPointInValue
            'Me.grd.RootTable.Columns(EnumGridDetail.Total).TotalFormatString = "N" & TotalAmountRounding

            'Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).FormatString = "N" & DecimalPointInValue
            'Me.grd.RootTable.Columns(EnumGridDetail.TotalAmount).TotalFormatString = "N" & TotalAmountRounding

            'Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).FormatString = "N" & DecimalPointInValue
            'Me.grd.RootTable.Columns(EnumGridDetail.TaxAmount).TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.NetBill).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(EnumGridDetail.NetBill).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.NetBill).TotalFormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("CurrencyRate").FormatString = "N" & 4
            Me.grd.RootTable.Columns("CurrencyRate").FormatString = "N" & 4
            Me.grd.RootTable.Columns("CurrencyRate").TotalFormatString = "N" & 4
            Me.grd.RootTable.Columns("CurrencyAmount").FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns("CurrencyAmount").FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns("CurrencyAmount").TotalFormatString = "N" & TotalAmountRounding
            'Rafay: task Start
            Me.grd.RootTable.Columns(EnumGridDetail.TotalCurrencyAmount).FormatString = "N" & DecimalPointInValue
            Me.grd.RootTable.Columns(EnumGridDetail.TotalCurrencyAmount).FormatString = "N" & TotalAmountRounding
            Me.grd.RootTable.Columns(EnumGridDetail.TotalCurrencyAmount).TotalFormatString = "N" & TotalAmountRounding
            'Rafay: Task End
            'Me.grd.RootTable.Columns("CurrencyTotalAmount").FormatString = "N" & DecimalPointInValue
            'Me.grd.RootTable.Columns("CurrencyTotalAmount").FormatString = "N" & TotalAmountRounding
            'Me.grd.RootTable.Columns("CurrencyTotalAmount").TotalFormatString = "N" & TotalAmountRounding
            Dim bln As Boolean = Convert.ToBoolean(getConfigValueByType("GridFreezColumn").Replace("Error", "False").Replace("''", "False"))
            If bln = True Then
                Me.grd.FrozenColumns = Me.grd.RootTable.Columns("Size").Index
            Else
                Me.grd.FrozenColumns = 0
            End If
            'End Task:2759
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub grd_CellUpdated(ByVal sender As Object, ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.CellUpdated
        Try
            
            Dim DiscountFactor As Double = Me.grd.GetRow.Cells(EnumGridDetail.DiscountFactor).Value
            Dim DiscountType As Decimal = Me.grd.GetRow.Cells(EnumGridDetail.DiscountId).Value
            Dim PostDiscountPrice As Decimal = Me.grd.GetRow.Cells(EnumGridDetail.PostDiscountPrice).Value
            If DiscountFactor <> 0 Then
                If DiscountType = 1 Then
                    If Not (DiscountFactor >= 0 AndAlso DiscountFactor <= 100) Then
                        ShowErrorMessage("Enter value according to the discount Type")
                        grd.CancelCurrentEdit()
                    End If

                ElseIf DiscountType = 2 Then
                    If Not (DiscountFactor >= 0 AndAlso DiscountFactor <= PostDiscountPrice) Then
                        ShowErrorMessage("Enter value according to the discount Type")
                        grd.CancelCurrentEdit()
                    End If
                End If
            End If
            ''TFS4773
            If DCStockImpact = True Then
                'If Not IsDBNull(Me.grd.GetRow.Cells(EnumGridDetail.DeliveryChalanId).Value) Then
                If Val(Me.grd.GetRow.Cells(EnumGridDetail.DeliveryChalanId).Value.ToString) > 0 Then
                    Dim DCQty As Decimal = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
                    If DCQty > QtyBefore Then
                        ShowErrorMessage("Qty Can Not be greater then DC Qty")
                        grd.CancelCurrentEdit()
                    End If
                End If
                'End If
            End If
            ''End TFS4773
            'ValidateStock()
            GetGridDetailQtyCalculate(e) ''TASKM22815
            ''Start TFS4773 
            If DCStockImpact = True Then
                If Val(Me.grd.GetRow.Cells(EnumGridDetail.DeliveryChalanId).Value.ToString) <= 0 Then
                    ValidateStock(e)
                End If
            Else
                ValidateStock(e)
            End If
            ''End TFS4773
            ' ValidateStockByBatch(e) ''Commented bcz form needs to be checked in
            GetGridDetailTotal() ''TASKM22815
            GetTotal()

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try

    End Sub
    Private Sub grd_RecordsDeleted(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            GetGridDetailQtyCalculate(e) ''TASKM22815
            GetGridDetailTotal() ''TASKM22815
            GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Public Sub ApplySecurity(ByVal Mode As SBUtility.Utility.EnumDataMode, Optional ByVal Condition As String = "") Implements IGeneral.ApplySecurity

    End Sub

    Public Function Delete(Optional ByVal Condition As String = "") As Boolean Implements IGeneral.Delete
        Try

            StockMaster = New StockMaster
            StockMaster.StockTransId = Convert.ToInt32(GetStockTransId(grdSaved.CurrentRow.Cells(0).Value))
            Return New StockDAL().Delete(StockMaster)

        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Public Sub FillCombos(Optional ByVal Condition As String = "") Implements IGeneral.FillCombos

    End Sub

    Public Sub FillModel(Optional ByVal Condition As String = "") Implements IGeneral.FillModel
        Try

            'Dim transId As Integer = 0

            'transId = Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
            'cmbProject.SelectedValue = GetCostCenterId(IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue))
            Dim idProject As Integer = 0I
            idProject = Val(CType(Me.cmbCompany.SelectedItem, DataRowView).Row.Item("CostCenterId").ToString)
            If Me.cmbProject.SelectedValue = idProject Then
                Me.cmbProject.SelectedValue = idProject
            End If

            StockMaster = New StockMaster
            StockMaster.StockTransId = 0I 'transId
            StockMaster.DocNo = Me.txtPONo.Text.ToString.Replace("'", "''")
            StockMaster.DocDate = Me.dtpPODate.Value.ToString("yyyy-M-d h:mm:ss tt")
            StockMaster.DocType = 3 'Convert.ToInt32(GetStockDocTypeId("Sales").ToString)
            StockMaster.Remaks = Me.txtRemarks.Text.ToString.Replace("'", "''")
            StockMaster.Project = IIf(Me.cmbProject.SelectedIndex > 0, cmbProject.SelectedValue, idProject)
            StockMaster.AccountId = Me.cmbVendor.Value
            StockMaster.StockDetailList = StockList 'New List(Of StockDetail)
            'StockMaster.StockListForAssembly = StockAssemblyList  'New List(Of StockDetail)
            'For Each grdRow As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
            '    If (Val(grdRow.Cells("Qty").Value.ToString) > 0 Or Val(grdRow.Cells("Sample Qty").Value.ToString) > 0) Then
            '        StockDetail = New StockDetail
            '        StockDetail.StockTransId = Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
            '        StockDetail.LocationId = grdRow.Cells("LocationId").Value
            '        StockDetail.ArticleDefId = grdRow.Cells("ArticleDefId").Value
            '        StockDetail.InQty = 0
            '        If IsSalesOrderAnalysis = True Then
            '            StockDetail.OutQty = IIf(grdRow.Cells("Unit").Value = "Loose", Val(grdRow.Cells("Qty").Value) + Val(grdRow.Cells("Sample Qty").Value), ((Val(grdRow.Cells("Qty").Value) + Val(grdRow.Cells("Sample Qty").Value)) * Val(grdRow.Cells("Pack Qty").Value)))
            '        Else
            '            StockDetail.OutQty = IIf(grdRow.Cells("Unit").Value = "Loose", Val(grdRow.Cells("Qty").Value) + Val(grdRow.Cells("Sample Qty").Value), ((Val(grdRow.Cells("Qty").Value) + Val(grdRow.Cells("Sample Qty").Value)) * Val(grdRow.Cells("Pack Qty").Value)))
            '        End If
            '        StockDetail.Rate = Val(grdRow.Cells("Rate").Value)
            '        StockDetail.InAmount = 0
            '        StockDetail.OutAmount = IIf(grdRow.Cells("Unit").Value = "Loose", ((Val(grdRow.Cells("Qty").Value) + Val(grdRow.Cells("Sample Qty").Value)) * Val(grdRow.Cells("Rate").Value)), (((Val(grdRow.Cells("Qty").Value) + Val(grdRow.Cells("Sample Qty").Value)) * Val(grdRow.Cells("Pack Qty").Value)) * Val(grdRow.Cells("Rate").Value)))
            '        StockDetail.Remarks = String.Empty
            '        StockMaster.StockDetailList.Add(StockDetail)
            '    End If
            'Next
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    ''' <summary>
    ''' This Sub Is Added To Apply The Effect of Stock of Items residing in logical item
    ''' </summary>
    ''' <param name="ArticleID"></param>
    ''' <param name="LocationId"></param>
    ''' <param name="Qty"></param>
    ''' <param name="Remarks"></param>
    ''' <remarks>''TFS1957 :Ayesha Rehman :Logical Item</remarks>
    Private Sub FillModelOfStockDetail(ByVal ArticleID As Integer, ByVal LocationId As Integer, ByVal Qty As Integer, ByVal Remarks As String)
        Try
            Dim LogicalRate As Integer = 0I
            Dim LogicalAmount As Integer = 0I
            StockAssemblyList = New List(Of StockDetail)
            'Dim idProject As Integer = 0I
            'idProject = Val(CType(Me.cmbCompany.SelectedItem, DataRowView).Row.Item("CostCenterId").ToString)
            'If Me.cmbProject.SelectedValue = idProject Then
            '    Me.cmbProject.SelectedValue = idProject
            'End If
            'StockMaster = New StockMaster
            'StockMaster.StockTransId = 0I 'transId
            'StockMaster.DocNo = Me.txtPONo.Text.ToString.Replace("'", "''")
            'StockMaster.DocDate = Me.dtpPODate.Value.Date
            'StockMaster.DocType = 3 'Convert.ToInt32(GetStockDocTypeId("Sales").ToString)
            'StockMaster.Remaks = Me.txtRemarks.Text.ToString.Replace("'", "''")
            'StockMaster.Project = IIf(Me.cmbProject.SelectedIndex > 0, cmbProject.SelectedValue, idProject)
            'StockMaster.AccountId = Me.cmbVendor.Value
            'StockMaster.StockDetailList = StockList
            Dim i As Integer
            Dim strsql As String = "SELECT  ArticleDefTable.ArticleId, ArticleDefTable.ArticleCode AS [Article code], ArticleDefTable.ArticleDescription AS [Article Description]," _
                         & " Case When IsNull(tblCostSheet.CostPrice,0)=0 Then IsNull(ArticleDefTable.PurchasePrice,0.0) Else IsNull(tblCostSheet.CostPrice,0.0) End AS [Purchase Price], IsNull(ArticleDefTable.SalePrice,0.0) AS [Sale Price], tblCostSheet.Total_Qty As Qty," _
                         & " ISNULL(tblCostSheet.Qty,0) as TotalQty,ISNULL(tblCostSheet.Remarks,'') as Remarks, IsNull(tblCostSheet.ParentId, 0) As ParentId " _
                         & " FROM tblCostSheet Left Outer JOIN  ArticleDefTable ON tblCostSheet.ArticleID = ArticleDefTable.ArticleId " _
                         & " where tblCostSheet.ParentId = " & ArticleID

            Dim dtInventoryEffect As DataTable = GetDataTable(strsql)
            Me.grdInventoryEffect.DataSource = dtInventoryEffect

            Me.grdInventoryEffect.RetrieveStructure()

            For i = 0 To grdInventoryEffect.GetRows.Length - 1
                Dim ObjDetail As New StockDetail

                ObjDetail.LocationId = LocationId
                ObjDetail.ArticleDefId = Val(dtInventoryEffect.Rows(i).Item(EnmGrdInventoryEffect.AritcleID).ToString)
                'ObjDetail.ArticleDefId = grdInventoryEffect.GetRows(i).Cells(EnmGrdInventoryEffect.AritcleID).Value
                ObjDetail.InQty = 0
                ObjDetail.OutQty = Val(dtInventoryEffect.Rows(i).Item(EnmGrdInventoryEffect.Qty).ToString) * Qty
                ObjDetail.Rate = Val(dtInventoryEffect.Rows(i).Item(EnmGrdInventoryEffect.PurchasePrice).ToString)
                LogicalRate = LogicalRate + ObjDetail.Rate
                ObjDetail.InAmount = 0
                ObjDetail.OutAmount = ObjDetail.OutQty * ObjDetail.Rate
                LogicalAmount = LogicalAmount + ObjDetail.OutAmount
                ObjDetail.Remarks = dtInventoryEffect.Rows(i).Item(EnmGrdInventoryEffect.Remarks).ToString

                StockAssemblyList.Add(ObjDetail)
            Next

            Dim ObjLogicalDetail As New StockDetail
            ObjLogicalDetail.LocationId = LocationId
            ObjLogicalDetail.ArticleDefId = ArticleID
            ObjLogicalDetail.InQty = Qty
            ObjLogicalDetail.OutQty = 0
            ObjLogicalDetail.Rate = LogicalRate
            ObjLogicalDetail.InAmount = LogicalAmount
            ObjLogicalDetail.OutAmount = 0
            ObjLogicalDetail.Remarks = Remarks
            StockAssemblyList.Add(ObjLogicalDetail)
            'Call New StockDAL().Add(StockMaster, trans)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    ''' <summary>
    ''' This Sub Is Added To Add the Details of Items in Product Assembly Table Residing in logical item
    ''' </summary>
    ''' <param name="ArticleID"></param>
    ''' <param name="LocationId"></param>
    ''' <remarks>''TFS1957 :Ayesha Rehman :Logical Item</remarks>
    Private Sub FillAssemblyProductTable(ByVal ArticleID As Integer, ByVal LocationId As Integer)
        Try

            Dim ProductAssemblyList As List(Of SBModel.ProductAssemblyTableBE) = New List(Of SBModel.ProductAssemblyTableBE)
            Dim objDAL As ProductAssemblyTableDAL = New ProductAssemblyTableDAL()
            Dim i As Integer
            Dim strsql As String = "SELECT  ArticleDefTable.ArticleId, ArticleDefTable.ArticleCode AS [Article code], ArticleDefTable.ArticleDescription AS [Article Description]," _
                         & " Case When IsNull(tblCostSheet.CostPrice,0)=0 Then IsNull(ArticleDefTable.PurchasePrice,0.0) Else IsNull(tblCostSheet.CostPrice,0.0) End AS [Purchase Price], IsNull(ArticleDefTable.SalePrice,0.0) AS [Sale Price], tblCostSheet.Total_Qty As Qty," _
                         & " ISNULL(tblCostSheet.Qty,0) as TotalQty,ISNULL(tblCostSheet.Remarks,'') as Remarks, IsNull(tblCostSheet.ParentId, 0) As ParentId " _
                         & " FROM tblCostSheet Left Outer JOIN  ArticleDefTable ON tblCostSheet.ArticleID = ArticleDefTable.ArticleId " _
                         & " where tblCostSheet.ParentId = " & ArticleID

            Dim dt As DataTable = GetDataTable(strsql)


            For i = 0 To dt.Rows.Count - 1
                Dim ObjDetail As New SBModel.ProductAssemblyTableBE

                ObjDetail.LocationId = LocationId
                ObjDetail.ArticleDefId = Val(dt.Rows(i).Item("ArticleId").ToString)
                ObjDetail.SalesId = getVoucher_Id
                ObjDetail.Qty = Val(dt.Rows(i).Item("Qty").ToString)
                ObjDetail.Price = Val(dt.Rows(i).Item("Purchase Price").ToString)
                ObjDetail.ArticleSize = "Loose"
                ProductAssemblyList.Add(ObjDetail)
            Next

            objDAL.Add(ProductAssemblyList)
            'Insert Activity Log by Ayesha Rehman 
            SaveActivityLog("Sales", Me.Text, EnumActions.Save, LoginUserId, EnumRecordType.Sales, "", True)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    ''' <summary>
    ''' This Sub Is Added To Add the Details of Items in tblVoucherDetail Residing in logical item
    ''' </summary>
    ''' <param name="ArticleID"></param>
    ''' <param name="VoucherId"></param>
    ''' <remarks>''TFS1957 :Ayesha Rehman :Logical Item</remarks>
    Private Sub AddVocherForLogicalItemDebit(ByVal ArticleID As Integer, ByVal VoucherId As Integer)
        Dim Con As New SqlConnection(SQLHelper.CON_STR)
        If Con.State = ConnectionState.Closed Then Con.Open()
        Dim trans As SqlTransaction = Con.BeginTransaction()
        Try
            Dim i As Integer
            Dim strsql As String = "SELECT  ArticleDefTable.ArticleId, ArticleDefTable.ArticleCode AS [Article code], ArticleDefTable.ArticleDescription AS [Article Description]," _
                         & " Case When IsNull(tblCostSheet.CostPrice,0)=0 Then IsNull(ArticleDefTable.PurchasePrice,0.0) Else IsNull(tblCostSheet.CostPrice,0.0) End AS [Purchase Price], IsNull(ArticleDefTable.SalePrice,0.0) AS [Sale Price], tblCostSheet.Total_Qty As Qty," _
                         & " ISNULL(tblCostSheet.Qty,0) as TotalQty,ISNULL(tblCostSheet.Remarks,'') as Remarks, IsNull(tblCostSheet.ParentId, 0) As ParentId " _
                         & " FROM tblCostSheet Left Outer JOIN  ArticleDefTable ON tblCostSheet.ArticleID = ArticleDefTable.ArticleId " _
                         & " where tblCostSheet.ParentId = " & ArticleID

            Dim dt As DataTable = GetDataTable(strsql)


            For i = 0 To dt.Rows.Count - 1
                Dim str As String = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                    & " VALUES(" & VoucherId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & Me.cmbVendor.ActiveRow.Cells(0).Value & ", " & Val(dt.Rows(i).Item("TotalQty").ToString) * Val(dt.Rows(i).Item("Purchase Price").ToString) & ", 0, ' Ayesha ', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & Val(dt.Rows(i).Item("ArticleId").ToString) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(dt.Rows(i).Item("ArticleId").ToString) & ", " & Val(dt.Rows(i).Item("TotalQty").ToString) * Val(dt.Rows(i).Item("Purchase Price").ToString) & ", 0, 1 , 1 , 1, 1, 'ABC ', ' ABC ' )"
                SQLHelper.ExecuteNonQuery(trans, CommandType.Text, str)
            Next
            trans.Commit()

            'Insert Activity Log by Ayesha Rehman 
            SaveActivityLog("Sales", Me.Text, EnumActions.Save, LoginUserId, EnumRecordType.Sales, "", True)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    ''' <summary>
    ''' This Sub Is Added To Add the Details of Items in tblVoucherDetail Residing in logical item
    ''' </summary>
    ''' <param name="ArticleID"></param>
    ''' <param name="VoucherId"></param>
    ''' <remarks>''TFS1957 :Ayesha Rehman :Logical Item</remarks>
    Private Sub AddVocherForLogicalItemCredit(ByVal ArticleID As Integer, ByVal VoucherId As Integer, ByVal AccountId As Integer)
        Dim Con As New SqlConnection(SQLHelper.CON_STR)
        If Con.State = ConnectionState.Closed Then Con.Open()
        Dim trans As SqlTransaction = Con.BeginTransaction()
        Try

            Dim i As Integer
            Dim strsql As String = "SELECT  ArticleDefTable.ArticleId, ArticleDefTable.ArticleCode AS [Article code], ArticleDefTable.ArticleDescription AS [Article Description]," _
                         & " Case When IsNull(tblCostSheet.CostPrice,0)=0 Then IsNull(ArticleDefTable.PurchasePrice,0.0) Else IsNull(tblCostSheet.CostPrice,0.0) End AS [Purchase Price], IsNull(ArticleDefTable.SalePrice,0.0) AS [Sale Price], tblCostSheet.Total_Qty As Qty," _
                         & " ISNULL(tblCostSheet.Qty,0) as TotalQty,ISNULL(tblCostSheet.Remarks,'') as Remarks, IsNull(tblCostSheet.ParentId, 0) As ParentId " _
                         & " FROM tblCostSheet Left Outer JOIN  ArticleDefTable ON tblCostSheet.ArticleID = ArticleDefTable.ArticleId " _
                         & " where tblCostSheet.ParentId = " & ArticleID

            Dim dt As DataTable = GetDataTable(strsql)


            For i = 0 To dt.Rows.Count - 1
                Dim str As String = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount, comments, CostCenterId, direction, sp_refrence, ArticleDefId, Currency_debit_amount, Currency_Credit_Amount, BaseCurrencyId, BaseCurrencyRate, CurrencyId, CurrencyRate, EngineNo, ChassisNo) " _
                                    & " VALUES(" & VoucherId & ", " & IIf(flgCompanyRights = True, " " & MyCompanyId & "", "1") & ", " & AccountId & ", 0," & Val(dt.Rows(i).Item("TotalQty").ToString) * Val(dt.Rows(i).Item("Purchase Price").ToString) & ",' Ayesha ', " & IIf(cmbProject.SelectedValue = Nothing, 0, cmbProject.SelectedValue) & ", " & Val(dt.Rows(i).Item("ArticleId").ToString) & ", N'" & Me.txtRemarks.Text.Replace("'", "''") & "', " & Val(dt.Rows(i).Item("ArticleId").ToString) & ", 0 , " & Val(dt.Rows(i).Item("TotalQty").ToString) * Val(dt.Rows(i).Item("Purchase Price").ToString) & ", 1 , 1 , 1, 1, 'ABC ', ' ABC ' )"
                SQLHelper.ExecuteNonQuery(trans, CommandType.Text, str)
            Next
            trans.Commit()

            'Insert Activity Log by Ayesha Rehman 
            SaveActivityLog("Sales", Me.Text, EnumActions.Save, LoginUserId, EnumRecordType.Sales, "", True)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Public Function IsValidate(Optional ByVal Mode As SBUtility.Utility.EnumDataMode = SBUtility.Utility.EnumDataMode.Disabled, Optional ByVal Condition As String = "") As Boolean Implements IGeneral.IsValidate
        Try
            FillModel()
            Return True
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Public Sub ReSetControls(Optional ByVal Condition As String = "") Implements IGeneral.ReSetControls

    End Sub

    Public Function Save1(Optional ByVal Condition As String = "") As Boolean Implements IGeneral.Save
        Try
            If IsValidate() = True Then
                Return New StockDAL().Add(StockMaster)
            Else
                Return False
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Public Sub SetButtonImages() Implements IGeneral.SetButtonImages

    End Sub

    Public Sub SetConfigurationBaseSetting() Implements IGeneral.SetConfigurationBaseSetting

    End Sub

    Public Sub SetNavigationButtons(ByVal Mode As SBUtility.Utility.EnumDataMode, Optional ByVal Condition As String = "") Implements IGeneral.SetNavigationButtons

    End Sub

    Public Function Update1(Optional ByVal Condition As String = "") As Boolean Implements IGeneral.Update
        Try
            If IsValidate() = True Then
                Return New StockDAL().Update(StockMaster)
            Else
                Return False
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub txtAdjustment_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            If IsFormOpend = True Then GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub grdSaved_CellContentClick(ByVal sender As System.Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs)

    End Sub
    Private Sub UltraTabControl2_SelectedTabChanged(ByVal sender As System.Object, ByVal e As Infragistics.Win.UltraWinTabControl.SelectedTabChangedEventArgs)
        'If Me.UltraTabControl2.SelectedTab.Index = 0 Then
        '    Me.btnLoadAll.Visible = False
        '    Me.ToolStripButton1.Visible = False
        '    ToolStripSeparator1.Visible = False
        'Else
        '    Me.btnLoadAll.Visible = True
        '    Me.ToolStripButton1.Visible = True
        '    ToolStripSeparator1.Visible = True
        'End If
        Try
            If e.Tab.Index = 1 Then
                DisplayRecord()
                Me.BtnDelete.Visible = True
                Me.BtnPrint.Visible = True
            Else
                If IsEditMode = False Then Me.BtnDelete.Visible = False
                If IsEditMode = False Then BtnPrint.Visible = False
                Me.BtnEdit.Visible = False
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Task:2681 Numeric Validation
    Private Sub txtDisc_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtDisc.KeyPress
        Try
            NumValidation(sender, e)

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681


    Private Sub TextBox1_LostFocus(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            ' Before ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
            Dim disc As Double = 0D
            Double.TryParse(Me.txtDisc.Text.Trim, disc)
            Dim price As Double = 0D
            'Double.TryParse(Me.cmbItem.ActiveRow.Cells("Price").Value.ToString, price)
            Double.TryParse(txtRate.Text, price)

            If Val(disc) <> 0 AndAlso Val(price) <> 0 Then
                'Change Againt TFS1153 
                'If rbPer.Checked = True Then
                If Me.cmbDiscountType.SelectedIndex = 1 Then
                    Me.txtRate.Text = price - ((price / 100) * disc)
                Else
                    Me.txtRate.Text = price - (disc)
                End If
            Else
                Me.txtRate.Text = txtRate.Text
            End If
            'Commented against task:2367
            '' After ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
            'If Val(Me.txtDisc.Text) > 0 Then
            '    disc = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
            '    Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(disc, 2).ToString()
            '    'Calculate Tax
            '    If Val(Me.txtTax.Text) > 0 Then
            '        Dim tax As Double = 0D
            '        tax = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(tax, 2).ToString()
            '    Else
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
            '    End If
            'Else
            '    'Calculate Tax
            '    If Val(Me.txtTax.Text) > 0 Then
            '        Dim tax As Double = 0D
            '        tax = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(tax, 2).ToString()
            '    Else
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
            '    End If
            'End If
            '''''''''''''''''''''''''''''''''''''''''''''''''''''''
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub BalanceSheetToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BalanceSheetToolStripMenuItem.Click
        rptDateRange.ReportName = rptDateRange.ReportList.rptBSFomated
        ApplyStyleSheet(rptDateRange)
        rptDateRange.ShowDialog()
    End Sub
    'Private Sub btnLoadAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnLoadAll.Click
    '    Me.Cursor = Cursors.WaitCursor
    '    DisplayRecord("All")
    '    Me.DisplayDetail(-1)
    '    Me.Cursor = Cursors.Default
    'End Sub
    Private Sub BtnRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnRefresh.Click
        Me.Cursor = Cursors.WaitCursor
        Try

            blnRefreshMod = True

            If Not getConfigValueByType("PrintLog").ToString = "Error" Then
                flgPrintLog = getConfigValueByType("PrintLog").ToString
            Else
                flgPrintLog = False
            End If

            'Task:M16 Added Flag Vehicle Identification Info
            If Not getConfigValueByType("flgVehicleIdentificationInfo").ToString = "Error" Then
                flgVehicleIdentificationInfo = getConfigValueByType("flgVehicleIdentificationInfo")
            Else
                flgVehicleIdentificationInfo = False
            End If
            'End Task:M16

            'Task:2432 Added Flag Marge Item 
            If Not getConfigValueByType("flgMargeItem").ToString = "Error" Then
                flgMargeItem = getConfigValueByType("flgMargeItem")
            Else
                flgMargeItem = False
            End If
            'End Task:2432

            'Task:2702 Get Config CMFA Document Load
            If Not getConfigValueByType("CMFADocumentOnSales").ToString = "Error" Then
                blnCMFADocumentLoad = getConfigValueByType("CMFADocumentOnSales")
            Else
                blnCMFADocumentLoad = False
            End If
            'End Task:2702


            'TAsk:2795 Set ByRef Variable blnOrderQtyExceed
            If Not getConfigValueByType("OrderQtyExceedAgainstSales").ToString = "Error" Then
                blnOrderQtyExceed = getConfigValueByType("OrderQtyExceedAgainstSales").ToString
            Else
                blnOrderQtyExceed = False
            End If
            'End Task:2796

            'TAsk:2795 Set ByRef Variable blnOrderQtyExceed
            If Not getConfigValueByType("DCQtyExceedAgainstSales").ToString = "Error" Then
                blnDeliveryQtyExceed = getConfigValueByType("DCQtyExceedAgainstSales").ToString
            Else
                blnDeliveryQtyExceed = False
            End If
            'End Task:2796

            If Not getConfigValueByType("BiltyCommentsSales").ToString = "Error" Then
                BiltyCommentSales = getConfigValueByType("BiltyCommentsSales")
            Else
                flgVehicleIdentificationInfo = False
            End If
            If Not getConfigValueByType("TransporterCommentsSales").ToString = "Error" Then
                TransporterCommentsSales = getConfigValueByType("TransporterCommentsSales")
            Else
                TransporterCommentsSales = False
            End If
            ''Start TFS4161
            If Not getConfigValueByType("DiablePackQuantity").ToString = "Error" Then
                IsPackQtyDisabled = Convert.ToBoolean(getConfigValueByType("DiablePackQuantity").ToString)
            End If
            ''End TFS4161
            If Not getConfigValueByType("AvgRate").ToString = "Error" Then
                flgAvgRate = getConfigValueByType("AvgRate")
            Else
                flgAvgRate = False
            End If

            Me.lblProgress.Text = "Processing Please Wait ..."
            Me.lblProgress.Visible = True
            Application.DoEvents()
            'If Not msg_Confirm(str_ConfirmRefresh) = True Then Exit Sub
            Dim id As Integer
            id = 0

            id = Me.cmbVendor.Value
            FillCombo("Vendor")
            Me.cmbVendor.Value = id

            id = Me.cmbPo.SelectedIndex
            FillCombo("SO")
            Me.cmbPo.SelectedIndex = id

            id = Me.cmbDeliveryChalan.SelectedIndex
            FillCombo("DeliveryChalan")
            Me.cmbDeliveryChalan.SelectedIndex = id


            id = Me.cmbCompany.SelectedValue
            RemoveHandler cmbCompany.SelectedIndexChanged, AddressOf cmbCompany_SelectedIndexChanged
            FillCombo("Company")
            AddHandler cmbCompany.SelectedIndexChanged, AddressOf cmbCompany_SelectedIndexChanged
            Me.cmbCompany.SelectedValue = id

            id = Me.cmbSalesMan.SelectedIndex
            FillCombo("SM")
            Me.cmbSalesMan.SelectedIndex = id

            id = Me.cmbTransporter.SelectedIndex
            FillCombo("Transporter")
            Me.cmbTransporter.SelectedIndex = id

            id = Me.cmbCategory.SelectedIndex
            FillCombo("Category")
            Me.cmbCategory.SelectedIndex = id

            'id = Me.cmbCodes.Value
            'FillCombo("Barcodes")
            'Me.cmbCodes.Value = id

            id = Me.cmbItem.Value
            FillCombo("Item")
            Me.cmbItem.Value = id


            id = Me.cmbProject.SelectedIndex
            FillCombo("Project")
            Me.cmbProject.SelectedIndex = id

            id = Me.cmbProject.SelectedIndex
            FillCombo("CMFA")
            Me.cmbProject.SelectedIndex = id
            id = Me.cmbTaxCategory.SelectedIndex
            FillCombo("TaxRate")
            Me.cmbTaxCategory.SelectedIndex = id

            'Task 1153
            id = Me.cmbDiscountType.SelectedIndex
            FillCombo("Discount Type")
            Me.cmbDiscountType.SelectedIndex = id

            If Me.cmbInwardExpense.ActiveRow.Cells(0).Value Is Nothing Then
                id = 0
            Else
                id = Me.cmbInwardExpense.ActiveRow.Cells(0).Value
            End If
            FillCombo("OutwardExpense")
            Me.cmbInwardExpense.Value = id

            '' Setting Account ids
            FuelExpAccount = Val(getConfigValueByType("FuelExpAccount").ToString)
            AdjustmentExpAccount = Val(getConfigValueByType("AdjustmentExpAccount").ToString)
            OtherExpAccount = Val(getConfigValueByType("OtherExpAccount").ToString)
            '' End setting account ids

            FillCombo("grdLocation")
            FillCombo("grdSO")
            GetSalesOrderAnalysis()
            FillCombo("Currency")
            'Ali Faisal : TFS1362 : 22-Aug-2017 : Fill combo boxes
            FillCombo("grdEngine")
            FillCombo("grdChassis")
            'FillCombo("grdBatch")

            'Ali Faisal : TFS1362 : 22-Aug-2017 : End
            'Ayesha Rehman: TFS1153 : 23-NOV-2017 : Fill combo boxes
            FillCombo("grdDiscountType")
            'Ayesha Rehman : TFS1153 : 23-NOV-2017 : End

            If Not getConfigValueByType("Company-Based-Prefix").ToString = "Error" Then
                CompanyBasePrefix = Convert.ToBoolean(getConfigValueByType("Company-Based-Prefix").ToString)
            End If

            If Not getConfigValueByType("MultipleSalesOrder").ToString = "Error" Then
                flgMultipleSalesOrder = Convert.ToBoolean(getConfigValueByType("MultipleSalesOrder").ToString)
            Else
                flgMultipleSalesOrder = False
            End If

            If flgMultipleSalesOrder = True Then
                Me.btnLoad.Visible = True
            Else
                Me.btnLoad.Visible = False
            End If

            If Not getConfigValueByType("LoadAllItemsInSales").ToString = "Error" Then
                flgLoadAllItems = getConfigValueByType("LoadAllItemsInSales")
            End If

            If Not getConfigValueByType("ArticleFilterByLocation").ToString = "Error" Then
                flgLocationWiseItems = getConfigValueByType("ArticleFilterByLocation")
            End If

            If Not getConfigValueByType("ExcludeTaxPrice").ToString = "Error" Then
                flgExcludeTaxPrice = Convert.ToBoolean(getConfigValueByType("ExcludeTaxPrice").ToString)
            End If
            ''TASK TFS4544
            If getConfigValueByType("ItemFilterByName").ToString = "True" Then
                ItemFilterByName = Convert.ToBoolean(getConfigValueByType("ItemFilterByName").ToString)
            End If
            ''END TFS4544

            SOBatchNo = String.Empty
            SOExpiryDate = Date.Now.AddMonths(1)
            SOOrigin = String.Empty
            If Me.BackgroundWorker4.IsBusy Then Exit Sub
            Me.BackgroundWorker4.RunWorkerAsync()
            Do While Me.BackgroundWorker4.IsBusy
                Application.DoEvents()
            Loop

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.lblProgress.Visible = False
            Me.Cursor = Cursors.Default
            blnRefreshMod = False
        End Try

    End Sub
    Private Sub LinkLabel1_LinkClicked(ByVal sender As System.Object, ByVal e As System.Windows.Forms.LinkLabelLinkClickedEventArgs)
        Me.Cursor = Cursors.WaitCursor
        Try
            Me.LoadAllItems()
            'Me.LinkLabel1.Enabled = False
            Me.pnlSimple.Height = 85
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub LoadAllItems()
        Try
            For Each Row As Infragistics.Win.UltraWinGrid.UltraGridRow In Me.cmbItem.Rows
                If Row.Index > 0 Then
                    Me.cmbItem.Focus()
                    Row.Selected = True
                    Me.txtQty.Focus()
                    'Me.txtRate.Text = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString
                    AddItemToGrid(True)
                    Application.DoEvents()
                End If
            Next
            Me.cmbItem.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.CloseDropdown)
            GetTotal()
            ClearDetailControls()
        Catch ex As Exception
            Throw ex
        Finally
        End Try
    End Sub
    Function GetCostCenterId(ByVal CompanyId As Integer) As Integer
        Try
            Dim str As String
            Dim dt As New DataTable
            Dim adp As New OleDb.OleDbDataAdapter
            str = "select IsNull(CostCenterId,0) as CostCenterId From CompanyDefTable WHERE CompanyId=" & CompanyId & ""
            If Con.State = ConnectionState.Closed Then Con.Open()
            adp = New OleDb.OleDbDataAdapter(str, Con)
            adp.Fill(dt)
            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then
                    Return dt.Rows(0).Item(0)
                Else
                    Return 0
                End If
            Else : Return 0
            End If


        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Function GetSalesRemarks(ByVal SOID As Integer) As String
        Try
            Dim str As String
            Dim dt As New DataTable
            Dim adp As New OleDb.OleDbDataAdapter
            str = "Select Remarks From SalesOrderMasterTable WHERE SalesOrderId= " & SOID & ""
            adp = New OleDb.OleDbDataAdapter(str, Con)
            adp.Fill(dt)
            Return dt.Rows(0).Item(0)
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Function getCostCenterIdByInvoiceId(ByVal SOID As Integer) As String
        Try
            Dim str As String
            Dim dt As New DataTable
            Dim adp As New OleDb.OleDbDataAdapter
            str = "Select Isnull(CostCenterId,0) as CostCenterId From SalesOrderMasterTable WHERE SalesOrderId= " & SOID & ""
            adp = New OleDb.OleDbDataAdapter(str, Con)
            adp.Fill(dt)
            Return dt.Rows(0).Item(0)
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub FillComboByEdit()
        Try
            If IsEditMode = True Then
                FillCombo("Vendor")
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub GridBarUserControl2_Load(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            If IO.File.Exists(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name) Then
                Dim fs1 As New IO.FileStream(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name, IO.FileMode.Open, IO.FileAccess.ReadWrite)
                Me.grdSaved.LoadLayoutFile(fs1)
                fs1.Flush()
                fs1.Close()
                fs1.Dispose()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub grd_ColumnButtonClick(ByVal sender As System.Object, ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.ColumnButtonClick
        Try
            If Not msg_Confirm(str_ConfirmDelete) = True Then Exit Sub
            If e.Column.Key = "Delete" Then
                Me.grd.GetRow.Delete()
                grd.UpdateData()
                GetTotal()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub ComboFillByEdit()
        Try
            FillCombo("Vendor")
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CtrlGrdBar1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            If IO.File.Exists(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grd.Name) Then
                Dim fs As New IO.FileStream(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grd.Name, IO.FileMode.Open, IO.FileAccess.ReadWrite, IO.FileShare.ReadWrite)
                'Me.grd.SaveLayoutFile(fs)
                Me.grd.LoadLayoutFile(fs)
                fs.Close()
                fs.Dispose()
            End If
            CtrlGrdBar.strForm_Name = CtrlGrdBar.EnmAccountType.Customers
            Me.CtrlGrdBar1.txtGridTitle.Text = CompanyTitle & Chr(10) & "Sales"
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Function GetDocumentNo() As String
        Dim DocNo As String = String.Empty
        Try
            'If Me.txtPONo.Text = "" Then
            If getConfigValueByType("VoucherNo").ToString = "Yearly" Then
                ' Return GetSerialNo(IIf(CompanyBasePrefix = False & IIf(Me.GetPrefix(IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue)).Length = 0, "SI" & Me.cmbCompany.SelectedValue & "-" & Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year & "-", "SalesMasterTable", "SalesNo")
                If CompanyBasePrefix = True AndAlso GetPrefix(IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue)).Length > 0 Then
                    DocNo = GetSerialNo("" & GetPrefix(Me.cmbCompany.SelectedValue) & "" & "-", "SalesMasterTable", "SalesNo")
                Else
                    'rafay
                    If CompanyPrefix = "V-ERP (UAE)" Then
                        'companyinitials = "UE"
                        DocNo = GetSerialNo("SI" & Me.cmbCompany.SelectedValue & "-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "SalesMasterTable", "SalesNo")
                        'DocNo = GetSerialNo("SI" & "-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "SalesMasterTable", "SalesNo")
                        'DocNo = GetNextDocNo("SI" & Me.cmbCompany.SelectedValue & "-" & Format(Me.dtpPODate.Value, "yy") & Me.dtpPODate.Value.Month.ToString("00"), 2, "SalesMasterTable", "SalesNo")
                    Else
                        companyinitials = "PK"
                        DocNo = GetNextDocNo("SI" & "-" & companyinitials & "-" & Format(Me.dtpPODate.Value, "yy"), 4, "SalesMasterTable", "SalesNo")
                    End If
                    '  DocNo = GetSerialNo("SI" & Me.cmbCompany.SelectedValue & "-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "SalesMasterTable", "SalesNo")
                    'Rafay
                End If
            ElseIf getConfigValueByType("VoucherNo").ToString = "Monthly" Then
                If CompanyBasePrefix = True AndAlso GetPrefix(IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue)).Length > 0 Then
                    DocNo = GetSerialNo("" & GetPrefix(Me.cmbCompany.SelectedValue) & "" & "-", "SalesMasterTable", "SalesNo")
                Else
                    'rafay
                    '' DocNo = GetNextDocNo("SI" & Me.cmbCompany.SelectedValue & "-" & Format(Me.dtpPODate.Value, "yy") & Me.dtpPODate.Value.Month.ToString("00"), 4, "SalesMasterTable", "SalesNo")
                    If CompanyPrefix = "V-ERP (UAE)" Then
                        'companyinitials = "UE"
                        DocNo = GetNextDocNo("SI" & Me.cmbCompany.SelectedValue & "-" & Format(Me.dtpPODate.Value, "yy") & Me.dtpPODate.Value.Month.ToString("00"), 2, "SalesMasterTable", "SalesNo")
                        'DocNo = GetSerialNo("SI" & "-" & companyinitials & "-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "SalesMasterTable", "SalesNo")
                    Else
                        companyinitials = "PK"
                        DocNo = GetNextDocNo("SI" & "-" & companyinitials & "-" & Format(Me.dtpPODate.Value, "yy"), 4, "SalesMasterTable", "SalesNo")
                    End If
                    'rafay
                End If
                'DocNo = GetNextDocNo("SI" & Me.cmbCompany.SelectedValue & "-" & Format(Me.dtpPODate.Value, "yy") & Me.dtpPODate.Value.Month.ToString("00"), 4, "SalesMasterTable", "SalesNo")
            Else
                If CompanyBasePrefix = True AndAlso GetPrefix(IIf(Me.cmbCompany.SelectedIndex = -1, 0, Me.cmbCompany.SelectedValue)).Length > 0 Then
                    DocNo = GetSerialNo("SI" & GetPrefix(Me.cmbCompany.SelectedValue) & "" & "-", "SalesMasterTable", "SalesNo")
                Else
                    DocNo = GetNextDocNo("SI" & Me.cmbCompany.SelectedValue, 6, "SalesMasterTable", "SalesNo")
                End If
                'DocNo = GetNextDocNo("SI" & Me.cmbCompany.SelectedValue, 6, "SalesMasterTable", "SalesNo")
            End If
            'TASK TFS1971
            While SalesInvoiceSkipDAL.IsSkipped(DocNo)
                Dim LastIndexOfDash As Integer = DocNo.LastIndexOf("-")
                Dim DocumentNo As String = DocNo.Substring(LastIndexOfDash + 1)
                Dim DocumentNoPrefix As String = DocNo.Substring(0, LastIndexOfDash + 1)
                Dim LeadingZeros As String = GetLeadingZerosLength(DocumentNo)
                Dim IncrementDocumentNo As String = DocumentNo + 1
                If LeadingZeros.Length > 0 Then
                    DocumentNo = LeadingZeros & IncrementDocumentNo
                End If
                DocNo = DocumentNoPrefix & DocumentNo
            End While
            ''END TASK TFS1803
            Return DocNo
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub btnAddNewItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAddNewItem.Click
        'Rai Haider:06-Sep-2017:TFS1364:Add new form for Add new item button on sales having All field for Add new item
        'Start Task
        frmDefArticleAdd.ShowDialog()
        'End Task
        'TFS1364:Rai Haider
        If Not DialogResult = Windows.Forms.DialogResult.OK Then Call FillCombo("Item")
    End Sub
    Private Sub CtrlGrdBar2_Load(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            If IO.File.Exists(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name) Then
                Dim fs As New IO.FileStream(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grdSaved.Name, IO.FileMode.Open, IO.FileAccess.ReadWrite)
                'Me.grdSaved.SaveLayoutFile(fs)
                Me.grdSaved.LoadLayoutFile(fs)
                fs.Close()
                fs.Dispose()
            End If
            Me.CtrlGrdBar2.txtGridTitle.Text = CompanyTitle & Chr(10) & "Sales"
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Function FindExistsItem(ByVal ArticleId As Integer, ByVal Rate As Double, ByVal Pack As String, ByVal PackQty As Double, ByVal SO_Id As Integer, ByVal LocationID As Integer) As Boolean
        Try
            'Task:2432 Added Flg Marge Item
            If flgMargeItem = True Then
                Dim dt As DataTable = CType(Me.grd.DataSource, DataTable)
                Dim dr() As DataRow
                ''Added new condition of location against TASK TFS1648
                dr = dt.Select("ArticleDefId=" & ArticleId & " And Rate=" & Val(Rate) & " AND Unit='" & Pack & "' AND [Pack Qty]=" & Val(PackQty) & " AND SO_ID=" & Val(Me.cmbPo.SelectedValue) & " AND LocationId=" & LocationID & "")
                If dr.Length > 0 Then
                    For Each r As DataRow In dr
                        'If dr(0).ItemArray(0) = r.ItemArray(11) AndAlso dr(0).ItemArray(11) = r.ItemArray(11) AndAlso dr(0).ItemArray(8) = r.ItemArray(8) AndAlso dr(0).ItemArray(5) = r.ItemArray(5) Then
                        '    r.BeginEdit()
                        '    r(6) = Val(dr(0).ItemArray(6)) + Val(Me.txtQty.Text)
                        '    'r("LoadQty") = Val(dr(0).ItemArray(6)) + Val(Me.txtQty.Text)
                        '    r("TotalQty") = r(6)
                        '    r.EndEdit()
                        'End If
                        If dr(0).ItemArray(0) = LocationID AndAlso dr(0).ItemArray(11) = r.ItemArray(11) AndAlso dr(0).ItemArray(8) = r.ItemArray(8) AndAlso dr(0).ItemArray(5) = r.ItemArray(5) Then
                            If dr(0).ItemArray(5) = "Pack" Then
                                r.BeginEdit()
                                r(6) = Val(dr(0).ItemArray(6)) + Val(Me.txtQty.Text)
                                r("TotalQty") = r(6) * Val(Me.txtPackQty.Text)
                                r.EndEdit()
                            Else
                                r.BeginEdit()
                                r(6) = Val(dr(0).ItemArray(6)) + Val(Me.txtQty.Text)
                                r("TotalQty") = r(6)
                                r.EndEdit()
                            End If
                        End If
                    Next
                    Return True
                Else
                    Return False
                End If
            Else
                Return False
            End If
            'End Task:2432
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub cmbItem_RowSelected(ByVal sender As System.Object, ByVal e As Infragistics.Win.UltraWinGrid.RowSelectedEventArgs) Handles cmbItem.RowSelected
        Try
            If Me.cmbItem.IsItemInList = False Then
                Me.txtStock.Text = 0
                Exit Sub
            End If
            If Me.cmbItem.ActiveRow Is Nothing Then
                Exit Sub
            End If
            If Not getConfigValueByType("StockViewOnSale").ToString = "True" Then
                If Me.cmbItem.Value Is Nothing Then Exit Sub
                If IsSalesOrderAnalysis = True Then
                    Dim dt As DataTable = GetCostManagement(Me.cmbItem.Value)
                    If dt IsNot Nothing Then
                        TradePrice = dt.Rows(0).Item("TradePrice")
                        Freight_Rate = dt.Rows(0).Item("Freight")
                        MarketReturns_Rate = dt.Rows(0).Item("MarketReturns")
                        GST_Applicable = dt.Rows(0).Item("Gst_Applicable")
                        FlatRate_Applicable = dt.Rows(0).Item("FlatRate_Applicable")
                        FlatRate = dt.Rows(0).Item("FlatRate")
                        Freight = Freight_Rate
                        MarketReturns = MarketReturns_Rate
                    End If
                    Dim dtDiscount As DataTable = GetAnalysisLastDiscount(Me.cmbVendor.Value, Me.cmbItem.Value)
                    If dtDiscount IsNot Nothing Then
                        If dtDiscount.Rows.Count > 0 Then
                            Me.txtDisc.Text = dtDiscount.Rows(0).Item(0)
                            'Change Againt TFS1153 
                            'Me.rbPer.Checked = True
                            'Me.cmbDiscountType.SelectedIndex = 2
                        Else
                            Me.txtDisc.Text = 0
                        End If
                    Else
                        txtDisc.Text = 0
                    End If
                Else
                    txtDisc.Text = GetLastDiscount(IIf(Me.cmbItem.IsItemInList = True, Me.cmbVendor.Value, 0), Me.cmbItem.Value)
                    'Change Againt TFS1153 
                    'Me.rbPer.Checked = True
                    'Me.cmbDiscountType.SelectedIndex = 2
                End If
            Else
                txtDisc.Text = GetLastDiscount(IIf(Me.cmbItem.IsItemInList = True, Me.cmbVendor.Value, 0), Me.cmbItem.Value)
                'Change Againt TFS1153 
                'Me.rbPer.Checked = True
                'Me.cmbDiscountType.SelectedIndex = 2
            End If

            'If GetConfigValue("ApplyFlatDiscountOnSale") = True Then

            'End If


            Me.txtStock.Text = Convert.ToDouble(GetStockById(Me.cmbItem.ActiveRow.Cells(0).Value, Me.cmbCategory.SelectedValue))
            ''Start TFS4804
            Dim Str As String = " Select  BatchNo,ExpiryDate,Origin  From  StockDetailTable  where BatchNo not in ('','0','xxxx')  And ArticledefId = " & Me.cmbItem.ActiveRow.Cells(0).Value & "  Group by BatchNo,ExpiryDate,Origin Having Sum(isnull(InQty, 0)) - Sum(isnull(OutQty, 0)) > 0  ORDER BY ExpiryDate Asc"
            Dim dtBatchNo As DataTable = GetDataTable(Str)
            If dtBatchNo.Rows.Count > 0 Then
                Me.SOBatchNo = dtBatchNo.Rows(0).Item("BatchNo").ToString
                Me.SOExpiryDate = Convert.ToDateTime(dtBatchNo.Rows(0).Item("ExpiryDate").Date)
                Me.SOOrigin = dtBatchNo.Rows(0).Item("Origin").ToString
            Else
                Me.SOBatchNo = "xxxx"
                Me.SOExpiryDate = Convert.ToDateTime(Date.Now.AddMonths(1))
                Me.SOOrigin = ""
            End If
            ''End TFS4804
            If IsFormOpend = True Then FillCombo("ArticlePack")

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Private Sub btnReceipt_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnReceipt.Click
    '    Try
    '        If Me.grd.RowCount = 0 Then Exit Sub
    '        If getConfigValueByType("ReceiptVoucherOnSales").ToString = "True" Then
    '            Me.SplitContainer1.Panel2Collapsed = False
    '        Else
    '            Me.SplitContainer1.Panel2Collapsed = True
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Sub FillPaymentMethod()

        Dim dt As New DataTable
        Dim dr As DataRow
        Dim dr1 As DataRow
        dt.Columns.Add("Id")
        dt.Columns.Add("Name")
        dr = dt.NewRow
        dr1 = dt.NewRow

        dr(0) = Convert.ToInt32(5)
        dr(1) = "Bank"
        dt.Rows.InsertAt(dr, 0)

        dr1(0) = Convert.ToInt32(3)
        dr1(1) = "Cash"
        dt.Rows.InsertAt(dr1, 0)
        Me.cmbMethod.DisplayMember = dt.Columns(1).ColumnName.ToString() 'objDataSet.Tables(0).Columns(1).ColumnName
        Me.cmbMethod.ValueMember = dt.Columns(0).ColumnName.ToString() 'objDataSet.Tables(0).Columns(0).ColumnName)
        Me.cmbMethod.DataSource = dt

    End Sub
    Function GetVoucherNo() As String
        Dim docNo As String = String.Empty
        Dim VType As String = String.Empty
        If Me.cmbMethod.SelectedIndex > 0 Then
            ''Start TFS2611
            VType = "BRV" & IIf(getConfigValueByType("CompanyWisePrefix").ToString = "True", Me.cmbCompany.SelectedValue, String.Empty)
        Else
            VType = "CRV" & IIf(getConfigValueByType("CompanyWisePrefix").ToString = "True", Me.cmbCompany.SelectedValue, String.Empty)
            ''End TFS2611
        End If
        Try
            If getConfigValueByType("VoucherNo").ToString = "Yearly" Then
                Return GetSerialNo(VType + "-" + Microsoft.VisualBasic.Right(Me.dtpPODate.Value.Year, 2) + "-", "tblVoucher", "voucher_no")
            Else
                Dim strSQL As String = "Select * from ConfigValuesTable Where Config_type='VoucherNo'"
                Dim dr As DataRow = SBDal.UtilityDAL.ReturnDataRow(strSQL)
                If Not dr Is Nothing Then
                    If dr("config_Value") = "Monthly" Then
                        Return GetNextDocNo(VType & "-" & Format(Me.dtpPODate.Value, "yy") & Me.dtpPODate.Value.Month.ToString("00"), 4, "tblVoucher", "voucher_no")
                    Else
                        docNo = GetNextDocNo(VType, 6, "tblVoucher", "voucher_no")
                        Return docNo
                    End If
                Else
                    docNo = GetNextDocNo(VType, 6, "tblVoucher", "voucher_no")
                    Return docNo
                End If
                Return ""
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub cmbMethod_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmbMethod.SelectedIndexChanged
        Try
            Dim str As String = String.Empty
            If Me.cmbMethod Is Nothing Then Exit Sub

            str = "If  exists(select Account_Id FROM tblUserAccountRights where UserID = " & LoginUserId & " And Rights = 1 And Account_Id Is Not Null) " _
                    & " select coa_detail_id, detail_title from vwCoaDetail where account_type=N'" & Me.cmbMethod.Text & "' And coa_detail_id in (select Account_Id FROM tblUserAccountRights where UserID = " & LoginUserId & " And Rights = 1) " _
                    & " Else " _
                    & " select coa_detail_id, detail_title from vwCoaDetail where account_type=N'" & Me.cmbMethod.Text & "'"


            'str = "select coa_detail_id,detail_title from vwCoaDetail where account_type=N'" & Me.cmbMethod.Text & "'"
            FillDropDown(Me.cmbDepositAccount, str, True)
            'If getConfigValueByType("ReceiptVoucherOnSales").ToString = "True" Then
            If Me.cmbMethod.SelectedIndex = 0 Then
                'Me.txtChequeNo.Visible = False
                'Me.dtpChequeDate.Visible = False
                Me.GroupBox4.Visible = False
            Else
                'Me.txtChequeNo.Visible = True
                'Me.dtpChequeDate.Visible = True
                Me.GroupBox4.Visible = True
            End If
            Me.txtVoucherNo.Text = GetVoucherNo()
            'End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub VoucherDetail(ByVal SalesNo As String)
        Try
            Dim str As String = String.Empty
            str = "SELECT dbo.tblVoucher.voucher_id, dbo.tblVoucher.location_id, dbo.tblVoucher.voucher_code, dbo.tblVoucher.voucher_type_id, dbo.tblVoucher.voucher_no, " _
                  & " dbo.tblVoucherDetail.credit_amount, tblVoucherDetail.debit_amount, dbo.tblVoucherDetail.CostCenterID, tblVoucher.coa_detail_id, tblVoucher.Cheque_No, tblVoucher.Cheque_Date " _
                  & " FROM  dbo.tblVoucher INNER JOIN " _
                  & " dbo.tblVoucherDetail ON dbo.tblVoucher.voucher_id = dbo.tblVoucherDetail.voucher_id " _
                  & " WHERE (dbo.tblVoucher.voucher_type_id = 3 Or dbo.tblVoucher.voucher_type_id=5) AND (tblVoucherDetail.coa_detail_id=" & Me.cmbVendor.Value & ") AND (dbo.tblVoucher.voucher_Code = N'" & SalesNo & "')"
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then
                    Me.cmbMethod.SelectedValue = Convert.ToInt32(dt.Rows(0).ItemArray(3))
                    Me.cmbDepositAccount.SelectedValue = Convert.ToInt32(dt.Rows(0).ItemArray(8))

                    If Not IsDBNull(dt.Rows(0).ItemArray(9)) Then
                        Me.txtChequeNo.Text = dt.Rows(0).ItemArray(9).ToString
                    Else
                        Me.txtChequeNo.Text = String.Empty
                    End If

                    If Not IsDBNull(dt.Rows(0).ItemArray(10)) Then
                        Me.dtpChequeDate.Value = Convert.ToDateTime(dt.Rows(0).ItemArray(10))
                    Else
                        Me.dtpChequeDate.Value = Date.Today
                    End If

                    Me.txtVoucherNo.Text = dt.Rows(0).ItemArray(4)
                    Me.txtRecAmount.Text = Convert.ToDouble(dt.Rows(0).ItemArray(5))
                    VNo = dt.Rows(0).ItemArray(4)
                    VoucherId = dt.Rows(0).ItemArray(0)
                    'Me.cmbMethod.Enabled = False
                    ExistingVoucherFlg = True
                Else
                    Me.cmbMethod.SelectedIndex = 0
                    cmbDepositAccount.SelectedIndex = 0
                    Me.txtChequeNo.Text = String.Empty
                    Me.dtpChequeDate.Value = Date.Today
                    VoucherId = 0I
                    VNo = String.Empty
                    Me.txtVoucherNo.Text = String.Empty
                    Me.txtRecAmount.Text = String.Empty
                    ExistingVoucherFlg = False
                End If
            Else
                Me.cmbMethod.SelectedIndex = 0
                cmbDepositAccount.SelectedIndex = 0
                Me.txtChequeNo.Text = String.Empty
                Me.dtpChequeDate.Value = Date.Today
                VoucherId = 0I
                VNo = String.Empty
                Me.txtVoucherNo.Text = String.Empty
                Me.txtRecAmount.Text = String.Empty
                ExistingVoucherFlg = False
            End If
        Catch ex As Exception

        End Try
    End Sub
    Private Function EmailSave()
        EmailSave = Nothing
        Dim flg As Boolean = False
        If Me.cmbVendor.ActiveRow Is Nothing Then Exit Function

        If IsEmailAlert = True Then
            Dim dtForm As DataTable = GetDataTable("Select ISNULL(EmailAlert,0) as EmailAlert  From tblForm WHERE Form_Name='frmSales' AND EmailAlert=1")
            If dtForm.Rows.Count > 0 Then
                flg = True
            Else
                flg = False
            End If
            If flg = True Then
                Email = New Email
                Email.ToEmail = AdminEmail
                Email.CCEmail = String.Empty
                Email.BccEmail = Me.cmbVendor.ActiveRow.Cells("Email").Text.ToString
                Email.Attachment = SourceFile
                Email.Subject = "Sales Invoice " & setVoucherNo & ""
                Email.Body = "Sales Invoice " _
                & " " & IIf(setEditMode = False, "of amount " & Total_Amount & " is made", "of amount " & Previouse_Amount & " is updated to " & Total_Amount & "") & " by user " & LoginUserName & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & " " & vbCrLf & "Auto Generated By SIRIUS ERP System"
                Email.Status = "Pending"
                Call New MailSentDAL().Add(Email)
            End If
        End If
        Return EmailSave

    End Function
    'Private Sub ToolStripButton1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ToolStripButton1.Click
    '    Try
    '        If Me.SplitContainer2.Panel1Collapsed = True Then
    '            Me.SplitContainer2.Panel1Collapsed = False
    '        Else
    '            Me.SplitContainer2.Panel1Collapsed = True
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Private Sub btnSearch_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearch.Click
        Try
            DisplayRecord("All")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Public Function GetDetail(ByVal Voucher_No As String) As Integer
    '    Try
    '        Dim str As String = "Select * From SalesMasterTable WHERE SalesNo=N'" & Voucher_No & "'"
    '        Dim dt As DataTable = GetDataTable(str)
    '        Dim SalesId As Integer = 0
    '        If dt IsNot Nothing Then
    '            If dt.Rows.Count > 0 Then
    '                SalesId = dt.Rows(0).Item(0)
    '                Me.cmbCompany.SelectedValue = Convert.ToInt32(dt.Rows(0).Item("LocationId"))
    '            End If
    '        End If
    '        DisplayRecord("All")
    '        For i As Integer = 0 To Me.grdSaved.RowCount - 1
    '            If SalesId = Me.grdSaved.GetRows(i).Cells("SalesId").Value Then
    '                If Me.grdSaved.GetRows(i).CheckState = Janus.Windows.GridEX.RowCheckState.Checked Then
    '                    If Not Me.grdSaved.RecordCount > 0 Then Exit Function
    '                    Me.IsEditMode = True
    '                    FillCombo("Vendor")
    '                    ' Me.FillCombo("SOComplete")
    '                    txtPONo.Text = grdSaved.GetRows(i).Cells(0).Value.ToString
    '                    dtpPODate.Value = CType(grdSaved.GetRows(i).Cells(1).Value, Date)
    '                    txtReceivingID.Text = grdSaved.GetRows(i).Cells("SalesId").Value
    '                    'TODO. ----
    '                    cmbVendor.Value = grdSaved.GetRows(i).Cells("CustomerCode").Value
    '                    cmbCompany.SelectedValue = grdSaved.GetRows(i).Cells("LocationId").Value
    '                    cmbCompany.Enabled = False
    '                    Me.chkPost.Checked = grdSaved.GetRows(i).Cells("Post").Value
    '                    txtRemarks.Text = grdSaved.GetRows(i).Cells("Remarks").Value & ""
    '                    txtPaid.Text = grdSaved.GetRows(i).Cells("CashPaid").Value & ""
    '                    Me.uitxtBiltyNo.Text = grdSaved.GetRows(i).Cells("BiltyNo").Value & ""
    '                    Me.cmbSalesMan.SelectedValue = grdSaved.GetRows(i).Cells("EmployeeCode").Value.ToString
    '                    Me.cmbPo.SelectedValue = Me.grdSaved.GetRows(i).Cells("PoId").Value
    '                    Me.cmbTransporter.SelectedValue = Me.grdSaved.GetRows(i).Cells("TransporterId").Value
    '                    Me.txtExpense.Text = Me.grdSaved.GetRows(i).Cells("Expense").Value.ToString
    '                    Me.txtFuel.Text = Me.grdSaved.GetRows(i).Cells("Fuel").Value.ToString
    '                    Try
    '                        Me.txtAdjustment.Text = Val(Me.grdSaved.GetRows(i).Cells("Adjustment").Value.ToString())
    '                    Catch ex As Exception
    '                    End Try
    '                    Call DisplayDetail(grdSaved.GetRows(i).Cells("SalesId").Value)
    '                    GetTotal()
    '                    Me.ExistingBalance = Val(Me.txtAmount.Text)
    '                    Me.BtnSave.Text = "&Update"
    '                    Me.LinkLabel1.Enabled = False
    '                    Me.cmbPo.Enabled = False
    '                    If Me.cmbPo.SelectedValue > 0 Then
    '                        Me.cmbVendor.Enabled = False
    '                    Else
    '                        Me.cmbVendor.Enabled = True
    '                    End If
    '                    'Customer Edit List flag here... 
    '                    If Me.cmbPo.SelectedIndex = 0 Then
    '                        If EditCustomerListOnSale = "False" Then
    '                            Me.cmbVendor.Enabled = True
    '                        Else
    '                            Me.cmbVendor.Enabled = False
    '                        End If
    '                    End If
    '                    If Not Mode = "Normal" Then Me.txtBarcode.Focus()
    '                    Me.GetSecurityRights()
    '                    Me.UltraTabControl2.SelectedTab = Me.UltraTabControl2.Tabs(0).TabPage.Tab
    '                    Me.CtrlGrdBar1_Load(Nothing, Nothing)
    '                    VoucherDetail(Me.txtPONo.Text)
    '                    Exit Function
    '                End If
    '            End If
    '        Next

    '    Catch ex As Exception
    '        Throw ex
    '    End Try
    'End Function
    Public Sub Voucher_Delete(ByVal Objtrans As OleDb.OleDbTransaction)
        ''10-Mar-2014   Task:2483  Imran Ali  Cutomer Balance Not Match in Daily Working Report
        'Dim lngVoucherId As Integer = GetVoucherId(Me.Name, grdSaved.CurrentRow.Cells(0).Value.ToString)
        'End Task:2483
        Dim cm As New OleDbCommand
        'If Con.State = ConnectionState.Closed Then Con.Open()
        'Dim objTrans As OleDbTransaction
        'objTrans = Con.BeginTransaction
        Try

            cm = New OleDbCommand
            cm.Connection = Con
            cm.CommandText = "delete from tblvoucherdetail where voucher_id=" & lngVoucherId

            cm.Transaction = Objtrans
            cm.ExecuteNonQuery()

            cm = New OleDbCommand
            cm.Connection = Con
            cm.CommandText = "delete from tblvoucher where voucher_id=" & lngVoucherId

            cm.Transaction = Objtrans
            cm.ExecuteNonQuery()

            'objTrans.Commit()

        Catch ex As Exception
            Objtrans.Rollback()
            Throw ex
            'Finally
            '    Con.Close()
        End Try
    End Sub
    Public Function Get_All(ByVal SalesNo As String)
        Try
            Get_All = Nothing
            If Not SalesNo.Length > 0 Then Exit Try
            If IsFormOpend = True Then
                If SalesNo.Length > 0 Then


                    '' Task# H08062015  Ahmad Sharif:
                    IsDrillDown = True
                    If Me.grdSaved.RowCount <= 50 Then
                        blnDisplayAll = True
                        Me.btnSearchLoadAll_Click(Nothing, Nothing)
                        blnDisplayAll = False
                    End If

                    Dim flag As Boolean = False

                    flag = Me.grdSaved.FindAll(Me.grdSaved.RootTable.Columns("SalesNo"), Janus.Windows.GridEX.ConditionOperator.Equal, SalesNo.Trim)

                    If flag = True Then

                        Me.grdSaved_CellDoubleClick(Nothing, Nothing)

                    Else
                        Exit Function
                    End If
                    ''End Task# H08062015
                End If
            End If
            'IsDrillDown = False
            Return Get_All
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Private Sub btnSearchDocument_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchDocument.Click
        Try
            If Not Me.cmbSearchAccount.IsItemInList Then
                FillCombo("SearchVendor")
                Me.cmbSearchAccount.Rows(0).Activate()
            Else
                Me.cmbSearchAccount.Rows(0).Activate()
            End If
            If Not Me.cmbSearchLocation.Items.Count > 0 Then
                FillCombo("SearchLocation")
                If Not Me.cmbSearchLocation.SelectedIndex = -1 Then Me.cmbSearchLocation.SelectedIndex = 0
            Else
                If Not Me.cmbSearchLocation.SelectedIndex = -1 Then Me.cmbSearchLocation.SelectedIndex = 0
            End If
            If Me.SplitContainer2.Panel1Collapsed = True Then
                Me.SplitContainer2.Panel1Collapsed = False
            Else
                Me.SplitContainer2.Panel1Collapsed = True
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnSearchLoadAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchLoadAll.Click
        Try
            DisplayDetail(-1)
            DisplayRecord("All")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnSearchDelete_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchDelete.Click
        Try
            DeleteToolStripButton_Click(Nothing, Nothing)

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintSelectedToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintSelectedToolStripMenuItem.Click
        Try
            PrintToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintGatepToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintGatepToolStripMenuItem1.Click
        Try
            PrintGatePToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintListToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintListToolStripMenuItem1.Click
        Try
            PrintListToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Function GetSalesOrderAnalysis() As Boolean
        Try
            IsSalesOrderAnalysis = Convert.ToBoolean(getConfigValueByType("SalesOrderAnalysis").ToString)
            If IsSalesOrderAnalysis = True Then
                Me.grd.RootTable.Columns(EnumGridDetail.TradePrice).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.Freight).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.MarketReturns).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.NetBill).Visible = True
            Else
                Me.grd.RootTable.Columns(EnumGridDetail.TradePrice).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.Freight).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.MarketReturns).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.NetBill).Visible = False
            End If

            If getConfigValueByType("WeighbridgeSaleOrder").ToString.ToUpper = "TRUE" Then

                Me.grd.RootTable.Columns(EnumGridDetail.Gross_Weights).Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.Tray_Weights).Visible = True
                Me.grd.RootTable.Columns(EnumGridDetail.Net_Weight).Visible = True

            Else

                Me.grd.RootTable.Columns(EnumGridDetail.Gross_Weights).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.Tray_Weights).Visible = False
                Me.grd.RootTable.Columns(EnumGridDetail.Net_Weight).Visible = False

            End If

        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Public Sub ExportFile(ByVal VoucherId As Integer)
        Try
            If IsEmailAlert = True Then
                If IsAttachmentFile = True Then
                    crpt = New ReportDocument
                    If IO.File.Exists(str_ApplicationStartUpPath & "\Reports\SalesInvoiceNew" & companyId & ".rpt") = False Then Exit Sub
                    crpt.Load(str_ApplicationStartUpPath & "\Reports\SalesInvoiceNew" & companyId & ".rpt", DBServerName)
                    If DBUserName <> "" Then
                        crpt.DataSourceConnections.Item(0).SetConnection(DBServerName, DBName, DBUserName, DBPassword)
                        crpt.DataSourceConnections.Item(0).SetLogon(DBName, DBPassword)
                    Else
                        crpt.DataSourceConnections.Item(0).SetConnection(DBServerName, DBName, True)
                    End If

                    Dim ConnectionInfo As New ConnectionInfo
                    With ConnectionInfo
                        .ServerName = DBServerName
                        .DatabaseName = DBName
                        If DBUserName <> "" Then
                            .UserID = DBUserName
                            .Password = DBPassword
                            .IntegratedSecurity = False
                        Else
                            .IntegratedSecurity = True
                        End If
                    End With
                    Dim tbLogOnInfo As New TableLogOnInfo
                    For Each dt As Table In crpt.Database.Tables
                        tbLogOnInfo = dt.LogOnInfo
                        tbLogOnInfo.ConnectionInfo = ConnectionInfo
                        dt.ApplyLogOnInfo(tbLogOnInfo)
                    Next

                    Dim crExportOps As New ExportOptions
                    Dim crDiskOps As New DiskFileDestinationOptions
                    Dim crExportType As New PdfRtfWordFormatOptions


                    If Not IO.Directory.Exists(str_ApplicationStartUpPath & "\EmailAttachments") Then
                        IO.Directory.CreateDirectory(str_ApplicationStartUpPath & "\EmailAttachments")
                    Else
                    End If
                    FileName = String.Empty
                    FileName = "Sales Invoice" & "-" & setVoucherNo & ""
                    SourceFile = String.Empty
                    SourceFile = _FileExportPath & "\" & FileName & ".pdf"
                    crDiskOps.DiskFileName = SourceFile
                    crExportOps = crpt.ExportOptions
                    With crExportOps
                        .ExportDestinationType = CrystalDecisions.Shared.ExportDestinationType.DiskFile
                        .ExportFormatType = CrystalDecisions.Shared.ExportFormatType.PortableDocFormat
                        .ExportDestinationOptions = crDiskOps
                        .ExportFormatOptions = crExportType
                    End With
                    'crpt.Refresh()
                    crpt.SetParameterValue("@SaleID", VoucherId)
                    crpt.Export(crExportOps)
                End If
            End If
        Catch ex As Exception

        End Try
    End Sub

    Private Sub BackgroundWorker2_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs) Handles BackgroundWorker2.DoWork
        Try
            ExportFile(getVoucher_Id)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub BackgroundWorker3_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs) Handles BackgroundWorker3.DoWork
        Try
            EmailSave()
        Catch ex As Exception
            ' Throw ex
        End Try
    End Sub
    Public Function GetAnalysisLastSchemeQty(ByVal CustomerCode As Integer, ByVal ItemId As Integer) As DataTable
        Try
            Dim str As String = String.Empty
            str = "Select b.SchemeQty From SalesOrderDetailTable b INNER JOIN SalesOrderMasterTable a ON a.SalesOrderId = b.SalesOrderId WHERE SalesOrderDetailId In (Select Max(SalesOrderDetailId) From SalesOrderDetailTable WHERE (SchemeQty Is Not Null Or SchemeQty <> 0) Group By ArticleDefId) And a.VendorId=" & CustomerCode & " AND b.ArticleDefId=" & ItemId & ""
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                Return dt
            Else
                Return Nothing
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Public Function GetAnalysisLastDiscount(ByVal CustomerCode As Integer, ByVal ItemId As Integer) As DataTable
        Try
            Dim str As String = String.Empty
            str = "Select ISNULL(b.Discount_Percentage,0) as Discount_Percentage From SalesOrderDetailTable b INNER JOIN SalesOrderMasterTable a ON a.SalesOrderId = b.SalesOrderId WHERE SalesOrderDetailId In (Select Max(SalesOrderDetailId) From SalesOrderDetailTable WHERE (Discount_Percentage Is Not Null Or Discount_Percentage <> 0) Group By ArticleDefId) And a.VendorId=" & CustomerCode & " AND b.ArticleDefId=" & ItemId & ""
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                Return dt
            Else
                Return Nothing
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub txtTransitInsurancePercentage_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtTransitInsurancePercentage.TextChanged
        Try
            If Not IsFormOpend = True Then Exit Sub
            If Me.grd.RootTable Is Nothing Then Exit Sub
            Me.grd.UpdateData()
            If Val(Me.txtAmount.Text) <> 0 Then
                Me.txtAddTransitInsurance.Text = (((Val(Me.txtTransitInsurancePercentage.Text) / 100) * (Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)))))
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtRemarks_Validating(ByVal sender As System.Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles txtRemarks.Validating
        Try
            SpellChecker(Me.txtRemarks)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub DeliveryChalanToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
        Dim newinvoice As Boolean = False
        Dim strCriteria As String = "Nothing"
        Me.Cursor = Cursors.WaitCursor
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            'PrintLog = New SBModel.PrintLogBE
            'PrintLog.DocumentNo = grdSaved.GetRow.Cells("PurchaseReturnNo").Value.ToString
            'PrintLog.UserName = LoginUserName
            'PrintLog.PrintDateTime = Date.Now
            'Call SBDal.PrintLogDAL.PrintLog(PrintLog)
            newinvoice = getConfigValueByType("NewInvoice")
            If newinvoice = True Then
                str_ReportParam = "@SaleID|" & IIf(Val(Me.txtReceivingID.Text) > 0, Val(Me.txtReceivingID.Text), grdSaved.CurrentRow.Cells("SalesId").Value)
            Else
                str_ReportParam = String.Empty
                strCriteria = "{SalesDetailTable.SalesId} = " & IIf(Val(Me.txtReceivingID.Text) > 0, Val(Me.txtReceivingID.Text), grdSaved.CurrentRow.Cells("SalesId").Value)
            End If
            If IsPreviewSaleInvoice = False Then
                ShowReport(IIf(newinvoice = False, "DeliveryChalan", "DeliveryChalanNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            Else
                ShowReport(IIf(newinvoice = False, "DeliveryChalan", "DeliveryChalanNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            End If
        Catch ex As Exception
            Throw ex
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub DeliveryChalanToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            DeliveryChalanToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Sub GetAdjustment(ByVal SalesOrderId As Integer)
        Try
            Me.grd.Update()
            Dim spadj As Double = 0D
            Dim adj As Double = 0D
            'Dim dt As DataTable = GetDataTable("Select ISNULL(SpecialAdjustment,0) as SpecialAdjustment From SalesOrderMasterTable WHERE SalesOrderId=" & SalesOrderId)
            'If dt IsNot Nothing Then
            '    If dt.Rows.Count > 0 Then
            '        spadj = dt.Rows(0).Item(0)
            '    End If
            'End If
            spadj = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("SpecialAdjustment").ToString)
            ''Start TFS3668 : Ayesha Rehman 
            adj = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("Adjustment").ToString)
            If spadj > 0 Then
                adj = 0
                For i As Integer = 0 To Me.grd.RowCount - 1
                    adj += (Me.grd.GetRows(i).Cells("Qty").Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value) - (((Me.grd.GetRows(i).Cells("Qty").Value * Me.grd.GetRows(i).Cells(EnumGridDetail.PostDiscountPrice).Value) * Me.grd.GetRows(i).Cells("DiscountFactor").Value) / 100)
                Next
                adj = ((adj * spadj) / 100)
            End If
            ''End TFS3668
            Me.txtAdjustment.Text = adj
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Public Function GetPrefix(ByVal CompanyId As Integer) As String
        Try
            GetPrefix = Nothing
            Dim str As String = "Select Prefix From CompanyDefTable WHERE CompanyId=" & CompanyId
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then
                    GetPrefix = dt.Rows(0).Item(0).ToString
                End If
            End If

            If GetPrefix.ToString.Length > 1 Then
                Return GetPrefix
            Else
                Return ""
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub rbtAll_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtAll.CheckedChanged, rbtCustomer.CheckedChanged
        Try
            If IsFormOpend = True Then FillCombo("Item")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub CommercialBillToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CommercialBillToolStripMenuItem.Click
        'Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
        'Dim newinvoice As Boolean = False
        'Dim strCriteria As String = "Nothing"
        'Me.Cursor = Cursors.WaitCursor
        'Try
        '    If Me.grdSaved.RowCount = 0 Then Exit Sub
        '    'PrintLog = New SBModel.PrintLogBE
        '    'PrintLog.DocumentNo = grdSaved.GetRow.Cells("PurchaseReturnNo").Value.ToString
        '    'PrintLog.UserName = LoginUserName
        '    'PrintLog.PrintDateTime = Date.Now
        '    'Call SBDal.PrintLogDAL.PrintLog(PrintLog)
        '    newinvoice = getConfigValueByType("NewInvoice")
        '    If newinvoice = True Then
        '        str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
        '    Else
        '        str_ReportParam = String.Empty
        '        strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
        '    End If
        '    If IsPreviewSaleInvoice = False Then
        '        ShowReport(IIf(newinvoice = False, "CommercialInvoice", "CommercialInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
        '    Else
        '        ShowReport(IIf(newinvoice = False, "CommercialInvoice", "CommercialInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
        '    End If
        'Catch ex As Exception
        '    Throw ex
        'Finally
        '    Me.Cursor = Cursors.Default
        'End Try
        'Altered by Ali Ansari to add Bill report for Humayun Welcan 

        Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
        Dim newinvoice As Boolean = False
        Dim strCriteria As String = "Nothing"
        Me.Cursor = Cursors.WaitCursor
        Try

            If Me.grdSaved.RowCount = 0 Then Exit Sub
            PrintLog = New SBModel.PrintLogBE
            PrintLog.DocumentNo = grdSaved.GetRow.Cells("SalesNo").Value.ToString
            PrintLog.UserName = LoginUserName
            PrintLog.PrintDateTime = Date.Now
            Call SBDal.PrintLogDAL.PrintLog(PrintLog)
            newinvoice = getConfigValueByType("NewInvoice")
            If newinvoice = True Then
                str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
            Else
                str_ReportParam = String.Empty
                strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
            End If


            ShowReport(IIf(newinvoice = False, "CommercialInvoiceNew", "CommercialInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)

        Catch ex As Exception
            Throw ex
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub CommercialInvoiceToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CommercialInvoiceToolStripMenuItem.Click
        Try
            CommercialBillToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Task:2681 Numeric validation
    Private Sub txtTax_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtTax.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681
    Private Sub txtTax_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtTax.LostFocus
        Try
            ' Before ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
            'If Val(Me.txtPackQty.Text) = 0 Then
            '    'txtPackQty.Text = 1
            '    txtTotal.Text = Val(txtQty.Text) * Val(txtRate.Text) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
            'Else
            '    txtTotal.Text = ((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
            'End If

            ' After  ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
            'Dim dbl As Double = 0D
            'If Val(Me.txtPackQty.Text) = 0 Or Val(Me.txtPackQty.Text) = 1 Then
            '    dbl = ((Val(Me.txtQty.Text) * Val(Me.txtRate.Text)) * Val(Me.txtTax.Text)) / 100
            '    Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(dbl, 2).ToString()
            'Else
            '    dbl = ((Val(Me.txtPackQty.Text) * Val(Me.txtQty.Text) * Val(Me.txtRate.Text)) * Val(Me.txtTax.Text)) / 100
            '    Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(dbl, 2).ToString()
            'End If
            '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
          
            GetDetailTotal()

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Function GetLastDiscount(ByVal CustomerCode As Integer, ByVal ArticleId As Integer) As Double
        Try

            Dim str As String = "Select ISNULL(Max(Discount_Percentage),0) From SalesDetailTable INNER JOIN SalesMasterTable On SalesDetailTable.SalesId = SalesDetailTable.SalesId WHERE CustomerCode=" & CustomerCode & " AND ArticleDefId=" & ArticleId & ""
            Dim dt As DataTable = GetDataTable(str)
            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then
                    Return Val(dt.Rows(0).Item(0).ToString)
                Else
                    Return 0
                End If
            Else
                Return 0
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    'TAsk:2681 Numeric Validation
    Private Sub txtFuel_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtFuel.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681
    Private Sub txtFuel_LostFocus(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtFuel.LostFocus
        Try
            If IsFormOpend = True Then GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    'Private Sub txtExpense_LostFocus(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtExpense.LostFocus
    '    Try
    '        If IsFormOpend = True Then GetTotal()
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Private Sub btnLoad_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnLoad.Click
        Try
            If Me.cmbPo.SelectedIndex <= 0 Then Exit Sub
            Dim ii As Integer = 0
            For ii = 0 To grd.RowCount - 1
                If Me.cmbPo.SelectedValue = Val(grd.GetRows(ii).Cells(EnumGridDetail.SO_ID).Value.ToString) Then
                    msg_Error("This SO has been already loaded.")
                    Exit Sub
                End If
            Next
            'Me.txtRemarks.Text = GetSalesRemarks(Me.cmbPo.SelectedValue)
            'Me.DisplayPODetail(Me.cmbPo.SelectedValue)
            ''If Me.cmbPo.SelectedIndex > 0 Then
            ''    Dim adp As New OleDbDataAdapter
            ''    Dim dt As New DataTable
            ''    Dim Sql As String = "Select * from salesorderMasterTable where SalesOrderId=" & Me.cmbPo.SelectedValue
            ''    adp = New OleDbDataAdapter(Sql, Con)
            ''    adp.Fill(dt)
            ''    'TODO -----
            ''    Me.cmbVendor.Value = dt.Rows(0).Item("VendorId")
            ''    Me.cmbVendor.Enabled = False

            ''Else
            ''    Me.cmbVendor.Enabled = True
            ''    If Me.cmbVendor.Rows.Count > 0 Then Me.cmbVendor.Rows(0).Activate()
            ''End If
            Dim i As Integer = 0I
            Dim str As String = String.Empty
            ''TFS1153 Added flat discount column on 07-08-2017
            ''TFS1154 Added RetailPrice column on 07-11-2017
            ''TFS1153 Added column Discount Type and Discount Value on 14-11-2017
            str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS item, Article.ArticleSizeName as Size, Article.ArticleColorName as Color, Recv_D.ArticleSize AS unit, ISNULL(Recv_D.Sz1,0) - Isnull(DeliveredQty , 0) AS Qty, " _
                & "  Recv_D.PostDiscountPrice As PostDiscountPrice, ISNULL(Recv_D.DiscountId,1) as DiscountId,  ' '  as [Discount Type],ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, 0 As FlatDiscount, ISNULL(Recv_D.DiscountFactor,0) As DiscountFactor, ISNULL(Recv_D.DiscountValue,0) As DiscountValue, " _
                & " Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount]," _
                & " ((IsNull(Recv_D.Qty, 0) * Recv_D.Price *  Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End) - isnull(Recv_D.DeliveredTotalQty,0) * Recv_D.Price *  Case When IsNull(Recv_D.CurrencyRate, 0)=0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
                & " Article.ArticleGroupId, Recv_D.ArticleDefId,Sz7 as [Pack Qty] ,Recv_D.Price as CurrentPrice, 0 As SaleDetailId, 0 as RetailPrice, ISNULL(Recv_D.TradePrice,0) as TradePrice,  ISNULL(Recv_D.SalesTax_Percentage,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], IsNull(Recv_D.SED_Tax_Percent,0) as SED, 0 as SavedQty, (ISNULL(Recv_D.SchemeQty,0)-ISNULL(Recv_D.DeliveredSchemeQty,0)) as [Sample Qty], ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, IsNull(Recv_D.SalesOrderID,0) as So_Id, (Isnull(Recv_D.Qty,0) - Isnull(DeliveredTotalQty , 0))  as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill, 0 as BatchId, IsNull(Recv_D.BatchNo,'xxxx') as [Batch No], IsNull(Recv_D.ExpiryDate,DATEADD(Month , 1 , getDate())) as ExpiryDate , IsNull(Recv_D.Origin,'') as Origin, Recv_D.Comments, Recv_D.Other_Comments, Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc, Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId,IsNull(Recv_D.CostPrice,0) as CostPrice, 0 as CR_SalesDetailId, 0 as SaleCertificateId, 0 as Stock, 0 as SalesReturnQty, 0 as DeliveryChalanId, 0 as DeliveryChalanDetailId,0 as Transport_Charges, Convert(bit,1) as ApplyAdjustmentFuelExp, (IsNull(Recv_D.Qty,0) - IsNull(Recv_D.DeliveredTotalQty,0)) as TotalQty, IsNull(Recv_D.SalesOrderDetailId, 0) As SODetailId , Convert(bit,0) as [LogicalItem] FROM SalesOrderDetailTable Recv_D INNER JOIN " _
                & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId LEFT OUTER JOIN " _
                & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id INNER JOIN SalesOrderMasterTable Recv ON Recv.SalesOrderId = Recv_D.SalesOrderId" _
                & " Where Recv_D.SalesOrderID =" & cmbPo.SelectedValue & " " & " " & IIf(flgLoadAllItems = False, " AND Recv_D.Sz1 - Isnull(DeliveredQty , 0) > 0 ", "")

            '
            Dim objCommand As New OleDbCommand
            Dim objCon As OleDbConnection
            Dim objDataAdapter As New OleDbDataAdapter
            Dim objDataSet As New DataSet

            objCon = Con 'New SqlConnection("Password=sa;Integrated Security Info=False;User ID=sa;Initial Catalog=SimplePos;Data Source=MKhalid")

            If objCon.State = ConnectionState.Open Then objCon.Close()

            objCon.Open()
            objCommand.Connection = objCon
            objCommand.CommandType = CommandType.Text


            objCommand.CommandText = str

            objDataAdapter.SelectCommand = objCommand
            objDataAdapter.Fill(objDataSet)

            ''19-10-2016 Ameen
            Dim IsMinus As Boolean = True
            StockChecked = False
            'If CType(Me.cmbItem.SelectedRow, Infragistics.Win.UltraWinGrid.UltraGridRow).Cells("ServiceItem").Value = False Then
            IsMinus = getConfigValueByType("AllowMinusStock")
            'End If
            'If IsMinus = False Then
            If objDataSet.Tables(0).Rows.Count > 0 Then
                For Each dr As DataRow In objDataSet.Tables(0).Rows
                    Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & dr.Item("ArticleDefId") & ""
                    Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem)
                    dt2serviceitem.AcceptChanges()
                    Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                    If ServiceItem1 = False Then
                        AvailableStock = Convert.ToDouble(GetStockById(dr.Item("ArticleDefId"), dr.Item("LocationId"), IIf(dr.Item("unit").ToString = "Loose", "Loose", "Pack")))
                        If IsMinus = True Then
                            If CheckLocationWiseMinusStock(dr.Item("LocationId")) = False Then
                                dr.BeginEdit()
                                If AvailableStock <= 0 Then
                                    ShowErrorMessage("Stock is negative against item " & dr.Item("Item").ToString & " ")
                                    dr.Delete()
                                Else
                                    If dr.Item("unit").ToString = "Loose" Then
                                        If Val(dr.Item("TotalQty")) > AvailableStock Then
                                            If msg_Confirm("Stock is not enough  " & dr.Item("Item").ToString & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                                Exit Sub
                                            Else
                                                StockChecked = True
                                                dr.Item("TotalQty") = AvailableStock
                                                dr.Item("Qty") = AvailableStock
                                            End If
                                        End If

                                    Else
                                        If Val(dr.Item("Qty")) > AvailableStock Then
                                            If msg_Confirm("Stock is not enough  " & dr.Item("Item").ToString & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                                Exit Sub
                                            Else
                                                StockChecked = True
                                                dr.Item("Qty") = AvailableStock
                                            End If
                                        End If
                                    End If
                                    dr.EndEdit()
                                    AvailableStock = 0
                                End If
                            End If
                        Else
                            ''TASK TFS4228
                            dr.BeginEdit()
                            If AvailableStock <= 0 Then
                                ShowErrorMessage("Stock is negative against item " & dr.Item("Item").ToString & " ")
                                dr.Delete()
                            Else
                                If dr.Item("unit").ToString = "Loose" Then
                                    If Val(dr.Item("TotalQty")) > AvailableStock Then
                                        If msg_Confirm("Stock is not enough  " & dr.Item("Item").ToString & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                            Exit Sub
                                        Else
                                            StockChecked = True
                                            dr.Item("TotalQty") = AvailableStock
                                            dr.Item("Qty") = AvailableStock
                                        End If
                                    End If

                                Else
                                    If Val(dr.Item("Qty")) > AvailableStock Then
                                        If msg_Confirm("Stock is not enough  " & dr.Item("Item").ToString & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                            Exit Sub
                                        Else
                                            StockChecked = True
                                            dr.Item("Qty") = AvailableStock
                                        End If
                                    End If
                                End If
                                dr.EndEdit()
                                AvailableStock = 0
                            End If

                            '' END TASK 
                        End If
                    End If
                Next
            End If

            objDataSet.AcceptChanges()
            ''End 19-10-2016 Ameen



            For i = 0 To objDataSet.Tables(0).Rows.Count - 1
                dblSEDPercent = 0D
                ''selecting the category
                'Me.cmbCategory.SelectedValue = objDataSet.Tables(0).Rows(i)("ArticleGroupId")
                'Me.cmbCategory_SelectedIndexChanged(Nothing, Nothing)

                If Val(objDataSet.Tables(0).Rows(i)("CurrencyId").ToString) = 0 Then
                    Me.cmbCurrency.Enabled = False
                    Me.cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
                Else
                    Me.cmbCurrency.SelectedValue = objDataSet.Tables(0).Rows(i)("CurrencyId")
                    Me.txtCurrencyRate.Text = Math.Round(Convert.ToInt32(objDataSet.Tables(0).Rows(i)("CurrencyRate").ToString), 4)
                    Me.cmbCurrency.Enabled = False
                    Me.cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
                    If Val(objDataSet.Tables(0).Rows(i)("CurrencyRate")) > 1 Then
                        Me.txtCurrencyRate.Text = Math.Round(Convert.ToInt32(objDataSet.Tables(0).Rows(i)("CurrencyRate").ToString), 4)
                    End If
                End If
                ''selecting the item
                Me.cmbCategory.SelectedValue = objDataSet.Tables(0).Rows(i)("LocationId")
                'Me.cmbCategory_Leave(Nothing, Nothing)

                Me.cmbItem.Value = objDataSet.Tables(0).Rows(i)("ArticleDefId")
                Me.cmbItem_Leave(Nothing, Nothing)

                ''selecting batch no
                If objDataSet.Tables(0).Rows(i)("Batch No") = 0 Then
                Else
                Me.cmbBatchNo.Text = objDataSet.Tables(0).Rows(i)("Batch No")
                Me.cmbBatchNo_Leave(Nothing, Nothing)
                End If

                ''selecting unit
                Me.cmbUnit.Text = objDataSet.Tables(0).Rows(i)("Unit")
                Me.cmbUnit_SelectedIndexChanged(Nothing, Nothing)

                ''selecting qty
                Me.txtQty.Text = objDataSet.Tables(0).Rows(i)("Qty")

                Me.txtQty_LostFocus(Nothing, Nothing)
                'Me.txtQty_TextChanged(Nothing, Nothing)
                ''selecing rate
                Me.txtRate.Text = objDataSet.Tables(0).Rows(i)("Rate")
                Me.txtPDP.Text = objDataSet.Tables(0).Rows(i)("PostDiscountPrice") ''TFS2827
                ''18-06-2016
                'If Me.cmbUnit.Text <> "Loose" Then
                '    txtPackQty.Text = Val(objDataSet.Tables(0).Rows(i)("Pack Qty"))
                '    Me.txtTotal.Text = Val(Me.txtRate.Text) * (Val(objDataSet.Tables(0).Rows(i)("Pack Qty")) * Val(Me.txtQty.Text))
                'Else
                '    Me.txtTotal.Text = Val(Me.txtRate.Text) * Val(Me.txtQty.Text)
                '    txtPackQty.Text = "1"
                'End If

                txtPackQty.Text = Val(objDataSet.Tables(0).Rows(i)("Pack Qty"))
                txtTotalQuantity.Text = Val(objDataSet.Tables(0).Rows(i)("TotalQty"))
                Me.txtTotal.Text = Math.Round(Val(Me.txtRate.Text) * Val(Me.txtTotalQty.Text), TotalAmountRounding)
                TradePrice = objDataSet.Tables(0).Rows(i)("TradePrice")
                SalesTax_Percentage = objDataSet.Tables(0).Rows(i)("Tax")
                SchemeQty = objDataSet.Tables(0).Rows(i)("Sample Qty")
                Discount_Percentage = objDataSet.Tables(0).Rows(i)("Discount_Percentage")
                Freight = objDataSet.Tables(0).Rows(i)("Freight")
                MarketReturns = objDataSet.Tables(0).Rows(i)("MarketReturns")
                Me.txtDisc.Text = Val(Discount_Percentage)
                Me.txtDisc.Text = objDataSet.Tables(0).Rows(i)("DiscountFactor")  ''TFS2827
                Me.cmbDiscountType.SelectedValue = objDataSet.Tables(0).Rows(i)("DiscountId") ''TFS2827
                'Change Againt TFS1153 
                'Me.rbPer.Checked = True
                'Me.cmbDiscountType.SelectedIndex = 2
                LoadQty = objDataSet.Tables(0).Rows(i)("LoadQty")
                strComments = objDataSet.Tables(0).Rows(i)("Comments").ToString
                strOtherComments = objDataSet.Tables(0).Rows(i)("Other_Comments").ToString
                dblSEDPercent = Val(objDataSet.Tables(0).Rows(i)("SED").ToString)
                'dblTaxPercent = Val(objDataSet.Tables(0).Rows(i)("Tax").ToString)
                soDetailId = Val(objDataSet.Tables(0).Rows(i)("SODetailId").ToString)
                soID = Val(objDataSet.Tables(0).Rows(i)("So_Id").ToString)
                Me.txtWHTaxPercent.Text = dblSEDPercent
                Me.txtTax.Text = SalesTax_Percentage

                SOBatchNo = objDataSet.Tables(0).Rows(i)("Batch No").ToString
                SOExpiryDate = objDataSet.Tables(0).Rows(i)("ExpiryDate")
                SOOrigin = objDataSet.Tables(0).Rows(i)("Origin")
                Me.btnAdd_Click(Nothing, Nothing)
                dblSEDPercent = 0D
                TradePrice = 0
                SalesTax_Percentage = 0
                SchemeQty = 0
                Discount_Percentage = 0
                Freight = 0
                MarketReturns = 0
                strOtherComments = String.Empty
                strComments = String.Empty
                SOBatchNo = String.Empty
                SOOrigin = String.Empty
                SOExpiryDate = Date.Now.AddMonths(1)
                '  grd.Rows.Add(objDataSet.Tables(0).Rows(i)(0), objDataSet.Tables(0).Rows(i)(1), objDataSet.Tables(0).Rows(i)("BatchNo"), objDataSet.Tables(0).Rows(i)(2), objDataSet.Tables(0).Rows(i)(3), objDataSet.Tables(0).Rows(i)(4), objDataSet.Tables(0).Rows(i)(5), objDataSet.Tables(0).Rows(i)(6), objDataSet.Tables(0).Rows(i)(7), objDataSet.Tables(0).Rows(i)(8), objDataSet.Tables(0).Rows(i)(9), objDataSet.Tables(0).Rows(i)(3))

                'grd.Rows(i).Cells(0).Value = objDataSet.Tables(0).Rows(i)(0)
                'grd.Rows(i).Cells(1).Value = objDataSet.Tables(0).Rows(i)(1)

            Next

            ''TASK TFS1764
            Me.cmbTransporter.SelectedValue = IIf(Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("TransporterId").ToString) > 0, Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("TransporterId").ToString), Me.cmbTransporter.SelectedValue)
            ''END TASK TFS1764
            Me.cmbSalesMan.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("SOP_ID").ToString) ''TFS4339
            Me.GetTotal()
            GetAdjustment(Me.cmbPo.SelectedValue)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtExpense_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtExpense.LostFocus
        Try
            If IsFormOpend = True Then GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub


    Private Sub PrintByItemCodeToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintByItemCodeToolStripMenuItem.Click
        Try
            Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
            Dim newinvoice As Boolean = False
            Dim strCriteria As String = "Nothing"
            Me.Cursor = Cursors.WaitCursor
            Try
                If Me.grdSaved.RowCount = 0 Then Exit Sub
                PrintLog = New SBModel.PrintLogBE
                PrintLog.DocumentNo = grdSaved.GetRow.Cells("SalesNo").Value.ToString
                PrintLog.UserName = LoginUserName
                PrintLog.PrintDateTime = Date.Now
                Call SBDal.PrintLogDAL.PrintLog(PrintLog)
                newinvoice = getConfigValueByType("NewInvoice")
                If newinvoice = True Then
                    str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
                Else
                    str_ReportParam = String.Empty
                    strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
                End If
                If IsPreviewSaleInvoice = False Then
                    ShowReport(IIf(newinvoice = False, "SalesInvoiceCodeWise", "SalesInvoiceNewCodeWise") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
                Else
                    ShowReport(IIf(newinvoice = False, "SalesInvoiceCodeWise", "SalesInvoiceNewCodeWise") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
                End If
            Catch ex As Exception
                Throw ex
            Finally
                Me.Cursor = Cursors.Default
            End Try
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub PrintSelectedItemCodeWiseToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintSelectedItemCodeWiseToolStripMenuItem.Click
        Try
            PrintByItemCodeToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintUndertakingLetterToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintUndertakingLetterToolStripMenuItem.Click
        Dim newinvoice As Boolean = False
        Dim strCriteria As String = "Nothing"
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            newinvoice = getConfigValueByType("NewInvoice")
            If newinvoice = True Then
                str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
            Else
                str_ReportParam = String.Empty
                strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
            End If

            'ShowReport("rptUnderTaking", "{SP_UndertakingLetter;1.SalesId}=" & grdSaved.CurrentRow.Cells("SalesId").Value & "", , , , , , , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            ShowReport(IIf(newinvoice = False, "rptUnderTaking", "rptUnderTaking") & grdSaved.CurrentRow.Cells("locationid").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub PrintUndertakingLetterToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintUndertakingLetterToolStripMenuItem1.Click
        Try
            PrintUndertakingLetterToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintAddressToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintAddressToolStripMenuItem.Click
        Try
            If Me.grdSaved.RowCount = 0 Then Exit Sub
            AddRptParam("@SalesId", Me.grdSaved.GetRow.Cells("SalesId").Value)
            ShowReport("PrintAddressEnvelop", , "Nothing", "Nothing", True)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintAddressToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintAddressToolStripMenuItem1.Click
        Try
            PrintAddressToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub PrintItemCodeGatePassToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintItemCodeGatePassToolStripMenuItem.Click
        Try
            Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
            Dim newinvoice As Boolean = False
            Dim strCriteria As String = "Nothing"
            Me.Cursor = Cursors.WaitCursor
            Try
                If Me.grdSaved.RowCount = 0 Then Exit Sub
                PrintLog = New SBModel.PrintLogBE
                PrintLog.DocumentNo = grdSaved.GetRow.Cells("SalesNo").Value.ToString
                PrintLog.UserName = LoginUserName
                PrintLog.PrintDateTime = Date.Now
                Call SBDal.PrintLogDAL.PrintLog(PrintLog)
                newinvoice = getConfigValueByType("NewInvoice")
                If newinvoice = True Then
                    str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
                Else
                    str_ReportParam = String.Empty
                    strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
                End If
                If IsPreviewSaleInvoice = False Then
                    ShowReport(IIf(newinvoice = False, "GatePassCodeWise", "GatePassNewCodeWise") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
                Else
                    ShowReport(IIf(newinvoice = False, "GatePassCodeWise", "GatePassNewCodeWise") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
                End If
            Catch ex As Exception
                Throw ex
            Finally
                Me.Cursor = Cursors.Default
            End Try
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintItemCodeGatePassToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintItemCodeGatePassToolStripMenuItem1.Click
        Try
            PrintItemCodeGatePassToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnOrderDeliver_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnOrderDeliver.Click
        Try
            Dim frm As New frmOrderStatusChange
            ApplyStyleSheet(frm)
            frm.ShowDialog()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnLoadDeliveryChalan_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnLoadDeliveryChalan.Click
        Try
            Dim frm As New frmDeliveryChalanStatusChalan
            ApplyStyleSheet(frm)
            If frm.ShowDialog() = Windows.Forms.DialogResult.Yes Then
                If Me.grd.RowCount = 0 Then Exit Sub
                If Not Val(Me.txtWHTaxPercent.Text) > 0 Then Exit Sub
                Dim dt As New DataTable
                dt = CType(Me.grd.DataSource, DataTable)
                If dt IsNot Nothing Then
                    If dt.Rows.Count > 0 Then
                        For Each r As DataRow In dt.Rows
                            r.BeginEdit()
                            r("SED") = Val(Me.txtWHTaxPercent.Text)
                            r.EndEdit()
                        Next
                    End If
                End If
                GetTotal()
                GetSalesOrderAnalysis()
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Protected Overrides Sub Finalize()
        MyBase.Finalize()
    End Sub
    Private Sub rbtAdjFlat_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rbtAdjFlat.CheckedChanged, rbtAdjPercentage.CheckedChanged
        Try
            If IsFormOpend = True Then GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub BackgroundWorker4_DoWork(ByVal sender As System.Object, ByVal e As System.ComponentModel.DoWorkEventArgs) Handles BackgroundWorker4.DoWork
        Try

            If Not getConfigValueByType("CompanyRights").ToString = "Error" Then
                flgCompanyRights = getConfigValueByType("CompanyRights")
            End If

            If Not getConfigValueByType("CGSVoucher").ToString = "Error" Then
                flgCgsVoucher = getConfigValueByType("CGSVoucher")
            End If

            DefaultTax = Val(getConfigValueByType("Default_Tax_Percentage").ToString)

            If Not getConfigValueByType("TransitInssuranceTax").ToString = "Error" Then
                TransitInssuranceTax = Val(getConfigValueByType("TransitInssuranceTax").ToString)
            Else
                TransitInssuranceTax = 0
            End If

            If Not getConfigValueByType("WHTax_Percentage").ToString = "Error" Then
                WHTax = Val(getConfigValueByType("WHTax_Percentage").ToString)
            Else
                WHTax = 0
            End If
            If Not getConfigValueByType("Company-Based-Prefix").ToString = "Error" Then
                CompanyBasePrefix = Convert.ToBoolean(getConfigValueByType("Company-Based-Prefix").ToString)
            End If
            If Not getConfigValueByType("MultipleSalesOrder").ToString = "Error" Then
                flgMultipleSalesOrder = Convert.ToBoolean(getConfigValueByType("MultipleSalesOrder").ToString)
            Else

                flgMultipleSalesOrder = False
            End If
            ''Task:2369 Get Comments Configurations
            If Not getConfigValueByType("CommentCustomerFormat").ToString = "Error" Then
                flgCommentCustomerFormat = Convert.ToBoolean(getConfigValueByType("CommentCustomerFormat").ToString)
            Else
                flgCommentCustomerFormat = False
            End If
            If Not getConfigValueByType("CommentArticleFormat").ToString = "Error" Then
                flgCommentArticleFormat = Convert.ToBoolean(getConfigValueByType("CommentArticleFormat").ToString)
            Else
                flgCommentArticleFormat = False
            End If
            If Not getConfigValueByType("CommentArticleSizeFormat").ToString = "Error" Then
                flgCommentArticleSizeFormat = Convert.ToBoolean(getConfigValueByType("CommentArticleSizeFormat").ToString)
            Else
                flgCommentArticleSizeFormat = False
            End If
            If Not getConfigValueByType("CommentArticleColorFormat").ToString = "Error" Then
                flgCommentArticleColorFormat = Convert.ToBoolean(getConfigValueByType("CommentArticleColorFormat").ToString)
            Else
                flgCommentArticleColorFormat = False
            End If
            If Not getConfigValueByType("CommentQtyFormat").ToString = "Error" Then
                flgCommentQtyFormat = Convert.ToBoolean(getConfigValueByType("CommentQtyFormat").ToString)
            Else
                flgCommentQtyFormat = False
            End If
            If Not getConfigValueByType("CommentPriceFormat").ToString = "Error" Then
                flgCommentPriceFormat = Convert.ToBoolean(getConfigValueByType("CommentPriceFormat").ToString)
            Else
                flgCommentPriceFormat = False
            End If
            If Not getConfigValueByType("CommentRemarksFormat").ToString = "Error" Then
                flgCommentRemarksFormat = Convert.ToBoolean(getConfigValueByType("CommentRemarksFormat").ToString)
            Else
                flgCommentRemarksFormat = False
            End If
            'End Task:2369


            'Task:2432 Added Flag Marge Item 
            If Not getConfigValueByType("flgMargeItem").ToString = "Error" Then
                flgMargeItem = getConfigValueByType("flgMargeItem")
            Else
                flgMargeItem = False
            End If
            'End Task:2432
            'Task:2446 Set Dc No, Engine No Flag Value
            If Not getConfigValueByType("CommentEngineNo").ToString = "Error" Then
                flgCommentEngineNo = getConfigValueByType("CommentEngineNo")
            Else
                flgCommentEngineNo = False
            End If

            If Not getConfigValueByType("CommentSalesDCNo").ToString = "Error" Then
                flgCommentSalesDcNo = getConfigValueByType("CommentSalesDCNo")
            Else
                flgCommentSalesDcNo = False
            End If
            'End Task:2446
            'Task:2517 Added Flag Average Rate
            If Not getConfigValueByType("AvgRate").ToString = "Error" Then
                flgAvgRate = getConfigValueByType("AvgRate")
            Else
                flgAvgRate = False
            End If
            'End Task:2517

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Function chkDateLock(ByVal DateLock As SBModel.DateLockBE) As Boolean
        Try
            If DateLock.DateLock.ToString("yyyy-M-d 00:00:00") = Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00") Then
                If DateLock.Lock = True Then
                    Return True
                End If
            End If
        Catch ex As Exception

        End Try
    End Function
    Public Sub ValidateDateLock()
        Try
            Dim dateLock As New SBModel.DateLockBE
            dateLock = DateLockList.Find(AddressOf chkDateLock)
            If dateLock IsNot Nothing Then
                If dateLock.DateLock.ToString.Length > 0 Then
                    flgDateLock = True
                Else
                    flgDateLock = False
                End If
            Else
                flgDateLock = False
            End If
        Catch ex As Exception

        End Try
    End Sub
    'Task:2681 Numeric Validation
    Private Sub txtPackRate_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtPackRate.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681

    Private Sub txtPackRate_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtPackRate.LostFocus
        Try
            'If Val(Me.txtPackQty.Text) = 0 Then
            '    txtPackQty.Text = 1
            '    txtTotal.Text = Math.Round((Val(txtQty.Text) * Val(txtRate.Text)) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), TotalAmountRounding)
            'Else
            '    txtTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), TotalAmountRounding)
            '    Total = Val(txtTotal.Text)
            'End If
            'GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtPackRate_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtPackRate.TextChanged
        ''Uncommented Against TFS3330 : Ayesha Rehman : 23-05-2018
        Try
            If Val(Me.txtPackRate.Text) > 0 Then
                If getConfigValueByType("Apply40KgRate").ToString = "True" AndAlso Me.cmbUnit.Text <> "Loose" Then
                    ' Me.txtRate.Text = (Val(Me.txtPackRate.Text) / 40) 'commented Against TFS3330
                    Me.txtPDP.Text = Math.Round((Val(Me.txtPackRate.Text) / 40), TotalAmountRounding)
                    Me.txtPDP.Enabled = False
                ElseIf Me.cmbUnit.Text <> "Loose" Then
                    ' Me.txtRate.Text = (Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text)) 'commented Against TFS3330
                    Me.txtPDP.Text = Math.Round((Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text)), TotalAmountRounding)
                    Me.txtPDP.Enabled = False
                End If
                If Val(Me.txtPackQty.Text) = 0 Then
                    txtPackQty.Text = 1
                    txtTotal.Text = Math.Round((Val(txtQty.Text) * Val(txtRate.Text)) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), TotalAmountRounding)
                Else
                    txtTotal.Text = Math.Round(((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100), TotalAmountRounding)
                    Total = Val(txtTotal.Text)
                End If
                GetDetailTotal()
            Else
                If IsAllowPDPEdit = True Then ''TFS4718 ,Check Wether PDP change Allowed or not
                Me.txtPDP.Enabled = True
                Else
                    Me.txtPDP.Enabled = False
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Task:2681 Numeric Validation
    Private Sub txtPackQty_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtPackQty.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub


    'End Task:2681

    Private Sub txtPackQty_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtPackQty.TextChanged
        Try

            If Me.txtPackRate.Text.Length > 0 AndAlso Val(Me.txtPackRate.Text) > 0 Then
                If Me.cmbUnit.Text <> "Loose" Then
                    Me.txtRate.Text = ((Val(Me.txtPackRate.Text)) / Val(Me.txtPackQty.Text))
                    Me.txtPDP.Text = ((Val(Me.txtPackRate.Text)) / Val(Me.txtPackQty.Text))
                Else
                    Me.txtRate.Text = Val(Me.txtRate.Text)
                    Me.txtPDP.Text = Val(Me.txtPDP.Text)
                End If
            End If
            If Val(Me.txtPackQty.Text) > 0 Then
                Me.txtTotalQuantity.Text = Math.Round(Val(Me.txtPackQty.Text) * Val(Me.txtQty.Text), TotalAmountRounding)
            Else
                Me.txtTotalQuantity.Text = Math.Round(Val(Me.txtQty.Text), TotalAmountRounding)
            End If

            ''Commented out on 17-05-2016
            '    If Me.txtPackRate.Text.Length > 0 AndAlso Val(Me.txtPackRate.Text) > 0 Then
            '        If Me.cmbUnit.Text <> "Loose" Then
            '            Me.txtRate.Text = ((Val(Me.txtPackRate.Text)) / Val(Me.txtPackQty.Text))
            '        End If
            '    End If
            '    If Val(Me.txtPackQty.Text) > 0 Then
            '        Me.txtTotalQuantity.Text = Val(Me.txtPackQty.Text) * Val(Me.txtQty.Text)
            '    Else
            '        Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
            '    End If
            '    GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtQty_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtQty.TextChanged
        Try
            'If Val(Me.txtPackQty.Text) > 0 Then
            '    Me.txtTotalQuantity.Text = Val(Me.txtPackQty.Text) * Val(Me.txtQty.Text)
            'Else
            '    Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
            'End If

            If Val(Me.txtPackQty.Text) > 0 AndAlso Me.txtQty.Text <> "" Then
                Me.txtTotalQuantity.Text = Math.Round(Convert.ToDecimal(Me.txtPackQty.Text) * Convert.ToDecimal(Me.txtQty.Text), TotalAmountRounding)
            ElseIf Me.txtQty.Text <> "" Then
                Me.txtTotalQuantity.Text = Convert.ToDecimal(Me.txtQty.Text)
            End If




            'If Me.txtPackRate.Text.Length > 0 AndAlso (Me.txtPackRate.Text) > 0 Then
            '    If Me.cmbUnit.Text <> "Loose" Then
            '        Me.txtRate.Text = (Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text))
            '    End If
            'End If
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub ToolStripButton1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnBillEmbriodery.Click
        Try
            ApplyStyleSheet(frmAddBillEmbroidery)
            If frmAddBillEmbroidery.ShowDialog = Windows.Forms.DialogResult.Yes Then
                Me.cmbCompany.SelectedValue = frmAddBillEmbroidery._CompanyId
                Me.txtPONo.Text = GetDocumentNo()
                _RefDocId = frmAddBillEmbroidery.cmbInvoice.SelectedValue
                Me.dtpPODate.Value = frmAddBillEmbroidery._DocDate
                Me.cmbVendor.Value = frmAddBillEmbroidery._CustomerId
                Me.txtRemarks.Text = frmAddBillEmbroidery._Note
                _RefDocNo = frmAddBillEmbroidery._DocNo
                Me.BtnSave.Text = "&Save"
                DisplayDetail(-1)
                DisplayDetail(_RefDocId, -1, "BillEmbroidery")
                Me.UltraTabControl2.SelectedTab = Me.UltraTabControl2.Tabs(0).TabPage.Tab
                Me.tbSalesDetail.SelectedTab = Me.tbSalesDetail.Tabs(0).TabPage.Tab
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnBarCode_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnBarCode.Click
        Try
            If getConfigValueByType("BarcodeEnabled") = "True" Then
                If Me.Panel4.Visible = True Then
                    Mode = "Normal"
                    Me.Panel4.Visible = False
                    'Me.Panel4.BringToFront()
                    Me.cmbItem.Focus()
                Else
                    Mode = "BarcodeEnabled"
                    Me.Panel4.Visible = True
                    Me.Panel4.BringToFront()
                    Me.txtBarcodescan.Focus()
                End If
            Else
                Mode = "Normal"
                Me.Panel4.Visible = False
                Me.cmbItem.Focus()
                Exit Sub
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtBarcodescan_KeyDown(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtBarcodescan.KeyDown
        Try

            If e.KeyCode = Keys.OemQuestion Then
                e.SuppressKeyPress = True
            End If

            If e.KeyCode = Keys.Enter Then
                Me.ErrorProvider1.Clear()
                Me.lblError.Text = ""

                If Me.txtBarcodescan.Text.Length = 0 Then Exit Sub
                lblError.Text = String.Empty
                If Me.cmbItem.Focused Then
                    If Me.cmbItem.ActiveRow.Index = 0 Then Exit Sub
                    Me.txtBarcodescan.Text = Me.cmbItem.ActiveRow.Cells("ItemId").Value
                    Me.cmbItem.PerformAction(Infragistics.Win.UltraWinGrid.UltraComboAction.CloseDropdown)
                End If

                If Me.cmbItem.IsItemInList(Me.txtBarcodescan.Text) Then
                    'Me.cmbCategory.SelectedValue = objDataSet.Tables(0).Rows(i)("ArticleGroupId")
                    'Me.cmbCategory_SelectedIndexChanged(Nothing, Nothing)

                    ''selecting the item
                    ' Me.cmbItem.Value = Me.txtBarcode.Text
                    Me.cmbItem.Text = Me.cmbItem.Text
                    'me.cmbItem.ActiveRow=me.cmbItem.Rows(me.cmbItem.S               'Me.cmbItem.Text = Me.txtBarcode.Text
                    'Me.cmbItem.Select()

                    'Me.cmbItem.SelectedRow=me
                    Me.cmbItem_Leave(Nothing, Nothing)

                    ''selecting batch no
                    ' Me.cmbBatchNo.Text = objDataSet.Tables(0).Rows(i)("BatchNo")
                    Me.cmbBatchNo_Leave(Nothing, Nothing)

                    ''selecting unit
                    Me.cmbUnit.SelectedIndex = 0
                    Me.cmbUnit_SelectedIndexChanged(Nothing, Nothing)

                    ''selecting qty
                    Me.txtQty.Text = 1
                    txtPackQty.Text = "1"
                    Me.txtQty_LostFocus(Nothing, Nothing)
                    'Me.txtQty_TextChanged(Nothing, Nothing)

                    ''selecing rate
                    'Me.txtRate.Text = objDataSet.Tables(0).Rows(i)(4)

                    Me.txtTotal.Text = Math.Round(Val(Me.txtRate.Text) * Val(Me.txtQty.Text), TotalAmountRounding)

                    Me.btnAdd_Click(Nothing, Nothing)


                    'lblError.Text = "Code Found"
                    Me.txtBarcodescan.Text = String.Empty
                    Me.txtBarcodescan.Focus()

                Else
                    Me.txtBarcodescan.Focus()
                    Me.txtBarcodescan.SelectAll()
                    lblError.Text = "Invalid code"
                    Me.ErrorProvider1.SetError(Me.txtBarcodescan, "Invalid Code")
                    'Spech.SelectVoice("Error")
                    'Spech.SpeakAsync("Try again")

                End If
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Function GetItemIdByBarCode(ByVal Item As String) As Integer
        Try
            If Not Item.Contains("|") Then Return 0
            Dim intItem As Integer = 0I
            If IsNumeric(Item.Substring(0, Item.LastIndexOf("|"))) Then
                intItem = Item.Substring(0, Item.LastIndexOf("|"))
                Return intItem
            Else
                Return 0
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Function

    Private Sub rdoFuel_CheckedChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles rdoFuel.CheckedChanged, rdoCNG.CheckedChanged
        Try
            If IsFormOpend = False Then Exit Sub
            If IsSalesOrderAnalysis = True Then Exit Sub
            Dim rdo As RadioButton = CType(sender, RadioButton)
            Select Case rdo.Name
                Case rdoFuel.Name
                    Me.txtFuel.Text = Val(Me.cmbVendor.ActiveRow.Cells("Fuel").Value.ToString)
                Case rdoCNG.Name
                    Me.txtFuel.Text = Val(Me.cmbVendor.ActiveRow.Cells("CNG").Value.ToString)
            End Select
            GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub btnSearchPrint_ButtonClick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchPrint.ButtonClick
        Try
            '' Request No 876 
            '' 19-11-2013 By Imran Ali
            '' Multiple Sales Invoice Print ... 

            If Me.grdSaved.RowCount = 0 Then Exit Sub
            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grdSaved.GetCheckedRows 'Loop Checked Rows
                Dim newinvoice As Boolean = False
                Dim strCriteria As String = "Nothing"
                'Me.Cursor = Cursors.WaitCursor
                Try

                    If Me.grdSaved.RowCount = 0 Then Exit Sub


                    newinvoice = getConfigValueByType("NewInvoice")
                    If newinvoice = True Then
                        str_ReportParam = "@SaleID|" & r.Cells("SalesId").Value 'Sales Invoice Id Value Assign in Parameter
                    Else
                        str_ReportParam = String.Empty
                        strCriteria = "{SalesDetailTable.SalesId} = " & r.Cells("SalesId").Value 'Sales Invoice Id Value Assign in Parameter
                    End If
                    '' Print Sale Invoice
                    ShowReport(IIf(newinvoice = False, "SalesInvoice", "SalesInvoiceNew") & r.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)

                    '' Save Print Log
                    PrintLog = New SBModel.PrintLogBE
                    PrintLog.DocumentNo = r.Cells("SalesNo").Value.ToString
                    PrintLog.UserName = LoginUserName
                    PrintLog.PrintDateTime = Date.Now
                    Call SBDal.PrintLogDAL.PrintLog(PrintLog)

                Catch ex As Exception
                    Throw ex
                Finally
                    'Me.Cursor = Cursors.Default
                End Try



            Next '' Move Next Sales Invoice No
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''ReqId-926 Button Hide Edit/Delete/Print
    Private Sub UltraTabControl2_SelectedTabChanging(ByVal sender As System.Object, ByVal e As Infragistics.Win.UltraWinTabControl.SelectedTabChangingEventArgs) Handles UltraTabControl2.SelectedTabChanging
        Try
            If e.Tab.Index = 0 Then
                Me.BtnEdit.Visible = False
                Me.BtnDelete.Visible = False
                Me.BtnPrint.Visible = False
            Else
                Me.BtnEdit.Visible = True
                Me.BtnDelete.Visible = True
                Me.BtnPrint.Visible = True
                Me.DisplayRecord()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnSearchEdit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSearchEdit.Click
        Try
            OpenToolStripButton_Click(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Task:2681 Numeric Validation
    Private Sub txtTotal_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtTotal.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''' <summary>
    ''' This Sub Is Made to Change PDP ,When the Total Amount is Changed
    ''' </summary>
    ''' <param name="sender"></param>
    ''' <param name="e"></param>
    ''' <remarks>TFS3330 : Ayesha Rehman : 23-05-2018</remarks>
    Private Sub txtTotal_Leave(sender As Object, e As EventArgs) Handles txtTotal.Leave, txtTotal.MouseLeave
        Try
            '' Below lines are added against TASK TFS3330  : Ayesha Rehman
            ''TASK TFS4546 : It should also work in case of loose unit. So Pack condition is going to be removed.
            'If Me.cmbUnit.Text = "Pack" Then
            If Total > 0 Then
            If Val(txtTotal.Text) <> Total Then
                If Val(Me.txtTotal.Text) > 0 AndAlso Val(Me.txtTotalQuantity.Text) > 0 Then
                    Me.txtPDP.Text = Math.Round((Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text)), TotalAmountRounding)
                    End If
                End If
            End If
            If Val(txtPDP.Text) = 0 Then
                If Val(Me.txtTotal.Text) > 0 AndAlso Val(Me.txtTotalQuantity.Text) > 0 Then
                    Me.txtPDP.Text = Math.Round((Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text)), TotalAmountRounding)
                End If
            End If
            'End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681
    ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
    Private Sub txtTotal_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtTotal.LostFocus

        Try
            'Tsk:2367 Check Item List 
            If Me.cmbItem.ActiveRow Is Nothing Then Exit Sub
            If Not Me.cmbItem.ActiveRow.Cells(0).Value > 0 Or Me.cmbItem.ActiveRow Is Nothing Then Exit Sub
            'End Tsk:2367
            'Dim db As Double = 0D
            'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtRate.Text) <> 0 Then
            '    db = Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)
            '    Me.txtQty.Text = Math.Round(db, 2).ToString()
            '    ' For Minus Disc %
            '    Dim discount As Double = 0D
            '    'Before against task:2367
            '    'If Val(Me.txtDisc.Text) <> 0 Then
            '    'Task:2367 Change validation 
            '    If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '        'End Task:2367
            '        discount = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
            '        Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(discount, 2).ToString()
            '    End If
            '    'Calculate Tax
            '    'Before against task:2367
            '    'If Val(Me.txtTax.Text) <> 0 Then
            '    'Task:2367 Change Validtion
            '    If Val(Me.txtTax.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '        'End Task:2367
            '        db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
            '    Else
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
            '    End If
            'Else
            '    If Val(Me.txtQty.Text) <> 0 Then
            '        db = Val(Me.txtTotal.Text) / Val(Me.txtQty.Text)
            '    Else
            '        db = 0
            '    End If
            '    Me.txtRate.Text = Math.Round(db, 2).ToString()
            '    ' For Minus Disc %
            '    Dim discount As Double = 0D
            '    'Before against task:2367
            '    'If Val(Me.txtDisc.Text) <> 0  Then
            '    'Task:2367 Change Validation
            '    If Val(Me.txtDisc.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '        'end Task:2367
            '        discount = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
            '        Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(discount, 2).ToString()
            '    End If
            '    'Calculate Tax
            '    'Before against task:2367
            '    'If Val(Me.txtTax.Text) > 0 Then
            '    'Task:2367 Change Validation
            '    If Val(Me.txtTax.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '        'End Task:2367
            '        db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
            '    Else
            '        Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
            '    End If
            'End If
            'Task:2367 Change Total
            'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtQty.Text) = 0 Then
            '    Me.txtQty.Text = Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)
            'End If

            'If Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtQty.Text) <> 0 AndAlso Val(Me.txtRate.Text) = 0 Then
            '    Me.txtRate.Text = Val(Me.txtTotal.Text) / Val(Me.txtQty.Text)
            'End If

            'If Val(Me.txtPackQty.Text) = 0 Then
            '    txtPackQty.Text = 1
            '    txtNetTotal.Text = (Val(txtQty.Text) * Val(txtRate.Text)) + ((Val(txtQty.Text) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
            'Else
            '    txtNetTotal.Text = ((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text)) + (((Val(txtQty.Text) * Val(txtPackQty.Text)) * Val(txtRate.Text) * Val(Me.txtTax.Text)) / 100)
            'End If
            'End Task:2367
            ''Below line is commented againsyt task tfs4546 on 18-9-18
            'GetDetailTotal() ''Uncommented Against TFS3330
            'TFS1153
            'DiscountCalculation()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''27-Dec-2013   ReqId-954   M Ijaz Javed    Item rate against generate Total
    'Private Sub txtTotal_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtTotal.LostFocus
    '    Try
    '        Dim db As Double = 0D
    '        If Val(Me.txtTotal.Text) > 0 And Val(Me.txtRate.Text) > 0 Then
    '            db = Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)
    '            Me.txtQty.Text = Math.Round(db, 2).ToString()
    '            ' For Minus Disc %
    '            Dim discount As Double = 0D
    '            If Val(Me.txtDisc.Text) > 0 Then
    '                discount = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
    '                Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(discount, 2).ToString()
    '            End If
    '            'Calculate Tax
    '            If Val(Me.txtTax.Text) > 0 Then
    '                db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
    '                Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
    '            Else
    '                Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
    '            End If

    '        ElseIf Val(Me.txtTotal.Text) = 0.0 Then
    '            Exit Sub
    '        Else
    '            db = Val(Me.txtTotal.Text) / Val(Me.txtQty.Text)
    '            Me.txtRate.Text = Math.Round(db, 2).ToString()
    '            ' For Minus Disc %
    '            Dim discount As Double = 0D
    '            If Val(Me.txtDisc.Text) > 0 Then
    '                discount = (Val(Me.txtTotal.Text) * Val(Me.txtDisc.Text)) / 100
    '                Me.txtTotal.Text = Val(Me.txtTotal.Text) - Math.Round(discount, 2).ToString()
    '            End If
    '            'Calculate Tax
    '            If Val(Me.txtTax.Text) > 0 Then
    '                db = (Val(Me.txtTotal.Text) * Val(Me.txtTax.Text)) / 100
    '                Me.txtNetTotal.Text = Val(Me.txtTotal.Text) + Math.Round(db, 2).ToString()
    '            Else
    '                Me.txtNetTotal.Text = Val(Me.txtTotal.Text)
    '            End If
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Private Sub grd_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles grd.KeyDown
        'R-974 Ehtisham ul Haq user friendly system modification on 31-12-13
        If e.KeyCode = Keys.F2 Then
            OpenToolStripButton_Click(Nothing, Nothing)
            Exit Sub
        End If
        ''31-Jan-2014     Task:2404 Imran Delete Record Problem In Transaction Forms   
        'If e.KeyCode = Keys.Delete Then
        '    DeleteToolStripButton_Click(Nothing, Nothing)
        '    Exit Sub
        'End If
        If e.KeyCode = Keys.F5 Then
            BtnRefresh_Click(Nothing, Nothing)
        End If
    End Sub
    ''Task:2369 Added Function Set Comments
    Public Function SetComments(ByVal GridExRow As Janus.Windows.GridEX.GridEXRow, Optional ByVal TotalQty As Double = 0) As String
        Try
            Dim Comments As String = String.Empty
            If GridExRow IsNot Nothing Then
                If gbJobCard.Visible = True Then
                    Comments += " JC Customer. " & Me.txtJobCardCustomer.Text & ","
                    Comments += " Reg No. " & Me.txtRegistrationNo.Text & ","
                End If
                If flgCommentCustomerFormat = True Then
                    Comments += Me.cmbVendor.Text.Replace("'", "''") & ","
                End If
                If flgCommentArticleFormat = True Then
                    Comments += " " & GridExRow.Cells(EnumGridDetail.Item).Value.ToString & ","
                End If
                If flgCommentArticleSizeFormat = True Then
                    Comments += " " & GridExRow.Cells(EnumGridDetail.Size).Value.ToString & ","
                End If
                If flgCommentArticleColorFormat = True Then
                    Comments += " " & GridExRow.Cells(EnumGridDetail.Color).Value.ToString & ","
                End If
                If flgCommentQtyFormat = True Then
                    'Before against Task:2583 
                    'Comments += " " & IIf(Val(GridExRow.Cells(EnumGridDetail.PackQty).Value.ToString) = 0, Val(GridExRow.Cells(EnumGridDetail.Qty).Value.ToString), Val(GridExRow.Cells(EnumGridDetail.Qty).Value.ToString) * Val(GridExRow.Cells(EnumGridDetail.PackQty).Value.ToString))
                    'Task:2583 Changed Format Of Quantity And Price
                    ''Below line is commented against TASK: TFS1357
                    'Comments += " (" & IIf(GridExRow.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", Val(GridExRow.Cells(EnumGridDetail.Qty).Value.ToString), Val(GridExRow.Cells(EnumGridDetail.Qty).Value.ToString) * Val(GridExRow.Cells(EnumGridDetail.PackQty).Value.ToString))
                    ''TASK : TFS1357 removed Val() method from Qty value on 22-08-2017
                    ''Below line is commented on 28-03-2018
                    'Comments += " (" & IIf(GridExRow.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", GridExRow.Cells(EnumGridDetail.Qty).Value.ToString, GridExRow.Cells(EnumGridDetail.Qty).Value.ToString * GridExRow.Cells(EnumGridDetail.PackQty).Value.ToString)
                    If TotalQty > 0 Then
                        Comments += " (" & TotalQty
                    Else
                    Comments += " (" & IIf(GridExRow.Cells(EnumGridDetail.Unit).Value.ToString = "Loose", GridExRow.Cells(EnumGridDetail.Qty).Value.ToString, GridExRow.Cells(EnumGridDetail.Qty).Value.ToString * GridExRow.Cells(EnumGridDetail.PackQty).Value.ToString)
                    End If
                End If
                If flgCommentPriceFormat = True AndAlso flgCommentQtyFormat = True Then
                    'Before against task:2583
                    'Comments += " X " & Val(GridExRow.Cells(EnumGridDetail.Price).Value.ToString)
                    'Task:2583 Changed Format Of Quantity And Price
                    'Comments += " X " & Val(GridExRow.Cells(EnumGridDetail.Price).Value.ToString) & ")"
                    'Task No 2608 Rounding The Values Palced In Grid View 
                    If getConfigValueByType("DiscountVoucherOnSale").ToString = "True" Then
                        If Price = PDP Then
                            Comments += " X " & Math.Round(Val(Price), DecimalPointInValue) & ")"
                        End If
                        If PDP = 0 Then
                            PDP = Price
                            Comments += " X " & Math.Round(Val(PDP), DecimalPointInValue) & ")"
                        End If
                        If Price < PDP Then
                            Price = PDP
                            Comments += " X " & Math.Round(Val(Price), DecimalPointInValue) & ")"
                        End If
                    Else
                        Comments += " X " & Math.Round(Val(GridExRow.Cells(EnumGridDetail.Price).Value.ToString), DecimalPointInValue) & ")"
                    End If
                    'End Task 2608
                    'End Task:2583
                    'Comment line against task:2583
                    'ElseIf flgCommentPriceFormat = True Then
                    '    Comments += " " & Val(GridExRow.Cells(EnumGridDetail.Price).Value.ToString) & ","
                End If
                If flgCommentRemarksFormat = True Then
                    If Me.txtRemarks.Text.Length > 0 Then Comments += " " & Me.txtRemarks.Text.Replace("'", "''") & ","
                End If
                'Task:2446 Take DcNo and Engine No Comment
                If flgCommentSalesDcNo = True Then
                    If Me.txtDcNo.Text.Length > 0 Then Comments += " DC No:" & Me.txtDcNo.Text.ToString.Replace("'", "''") & ","
                End If
                If flgCommentEngineNo = True Then
                    If GridExRow.Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then Comments += " Engine No:" & GridExRow.Cells(EnumGridDetail.Engine_No).Value.ToString.Replace("'", "''") & ","
                End If
                If BiltyCommentSales = True Then
                    If Me.uitxtBiltyNo.Text.Length > 0 Then Comments += " Bilty No: " & Me.uitxtBiltyNo.Text.Replace("'", "''") & ", "
                End If

                If TransporterCommentsSales = True Then
                    If Me.cmbTransporter.SelectedIndex > 0 Then Comments += " Transporter: " & Me.cmbTransporter.Text.Replace("'", "''") & ","
                End If
                'End Task:2446
            End If

            Comments += " " & GridExRow.Cells(EnumGridDetail.Comments).Value.ToString & ","
            If Comments.Contains(",") Then
                Comments += " " & GridExRow.Cells(EnumGridDetail.OtherComments).Value.ToString
                Dim str As String = Comments.Substring(Comments.LastIndexOf(","))
                If str.Length > 1 Then
                    Comments = Comments
                Else
                    Comments = Comments.Substring(0, Comments.LastIndexOf(",") - 1)
                End If
            End If
            Return Comments
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    'End Task:2369
    'Task:2415 Add New Fields Engine No and Chassis No In Sales Module
    Public Function CheckDuplicateEngineNo() As Boolean
        Try
            If Me.grd.RowCount = 0 Then Return False
            For i As Int32 = 0 To Me.grd.RowCount - 1
                For j As Int32 = i + 1 To Me.grd.RowCount - 1
                    If Me.grd.GetRows(j).Cells(EnumGridDetail.Engine_No).Value.ToString.Length > 0 Then
                        If Me.grd.GetRows(j).Cells(EnumGridDetail.Engine_No).Value.ToString = Me.grd.GetRows(i).Cells(EnumGridDetail.Engine_No).Value.ToString Then
                            Return True
                        End If
                    End If
                Next
            Next
            Return False
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    'End Task:2415
    'Task:2415 Add New Fields Engine No and Chassis No In Sales Module
    Public Function CheckDuplicateChassisNo() As Boolean
        Try
            If Me.grd.RowCount = 0 Then Return False
            For i As Int32 = 0 To Me.grd.RowCount - 1
                For j As Int32 = i + 1 To Me.grd.RowCount - 1
                    If Me.grd.GetRows(j).Cells(EnumGridDetail.Chassis_No).Value.ToString.Length > 0 Then
                        If Me.grd.GetRows(j).Cells(EnumGridDetail.Chassis_No).Value.ToString = Me.grd.GetRows(i).Cells(EnumGridDetail.Chassis_No).Value.ToString Then
                            Return True
                        End If
                    End If
                Next
            Next
            Return False
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    'End Task:2415
    ''04-Mar-2014  Task:2457  Imran Ali      Sales Certificate Report And Add New Field Certificate No In Sale Form
    Private Sub PrintSaleCertificateToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            AddRptParam("@SalesId", Me.grdSaved.GetRow.Cells("SalesId").Value)
            ShowReport("rptSalesCertificate")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub PrintSaleCertificateToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Try
            AddRptParam("@SalesId", Me.grdSaved.GetRow.Cells("SalesId").Value)
            ShowReport("rptSalesCertificate")
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2457
    'Task:2681 Numeric Validation
    Private Sub txtAdjustment_KeyPress(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtAdjustment.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681

    Private Sub txtAmount_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtAmount.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Task:2681 Numeric validation
    Private Sub txtWHTaxPercent_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtWHTaxPercent.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'End Task:2681

    'Private Sub cmbCMFADoc_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbCMFADoc.SelectedIndexChanged
    '    Try
    '        If IsFormOpend = False Then Exit Sub
    '        If Me.cmbCMFADoc.SelectedIndex > 0 Then
    '            DisplayDetail(Me.cmbCMFADoc.SelectedValue, -1, "CMFADocument")
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub

    Private Sub cmbTaxCategory_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbTaxCategory.SelectedIndexChanged
        Try
            If IsFormOpend = True Then
                If Me.cmbTaxCategory.SelectedIndex > 0 Then
                    Me.txtTax.Text = Val(CType(Me.cmbTaxCategory.SelectedItem, DataRowView).Row.Item("Tax_Percent").ToString)
                Else
                    Me.txtTax.Text = 0D
                End If
            Else
                Me.txtTax.Text = 0D
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtDueDays_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtDueDays.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
#Region "SMS Template Setting"
    Public Function GetSMSParamters() As List(Of String)
        Try
            Dim str As New List(Of String)
            str.Add("@AccountCode")
            str.Add("@AccountTitle")
            str.Add("@DocumentNo")
            str.Add("@DocumentDate")
            str.Add("@OtherDocNo")
            str.Add("@Remarks")
            str.Add("@Amount")
            str.Add("@Quantity")
            str.Add("@DCNo")
            str.Add("@CMFADocNo")
            str.Add("@SONo")
            str.Add("@InvParty")
            'rafay
            str.Add("@PO_NO")
            'rafay
            str.Add("@DetailInformation")
            str.Add("@BiltyNo")
            str.Add("@Transporter")
            str.Add("@CompanyName")
            str.Add("@PreviousBalance")
            str.Add("@SIRIUS")
            Return str
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Public Function GetSMSKey() As List(Of String)
        Try
            Dim str As New List(Of String)
            str.Add("Sale Invoice")
            Return str
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub btnSMSTemplate_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSMSTemplate.Click
        Try
            Dim frmSMS As New frmSMSTemplate
            ApplyStyleSheet(frmSMS)
            frmSMS.cmbKey.DataSource = GetSMSKey()
            frmSMS.lstParameters.DataSource = GetSMSParamters()
            frmSMS.Show()
            frmSMS.BringToFront()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
#End Region

    Private Sub btnUpdateAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnUpdateAll.Click
        Try
            blnUpdateAll = True
            Dim blnStatus As Boolean = False
            Me.btnUpdateAll.Enabled = False
            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grdSaved.GetCheckedRows
                Me.grdSaved.Row = r.Position
                Me.txtReceivingID.Text = 0I
                EditRecord()
                If Update_Record() = True Then
                    blnStatus = True
                Else
                    blnStatus = False
                End If
            Next
            If blnStatus = True Then msg_Information("Records update successful.") : Me.btnUpdateAll.Enabled = True : RefreshControls()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Function SaveDocument(ByVal DocId As Integer, ByVal Source As String, ByVal objTrans As OleDb.OleDbTransaction) As Boolean
        Dim cmd As New OleDbCommand
        cmd.Connection = objTrans.Connection
        cmd.Transaction = objTrans
        Try

            Dim dt As New DataTable
            dt = GetDataTable("Select DocId, Source, Path + '\' + FileName  as [FileNames]  From DocumentAttachment WHERE DocId=" & DocId & " AND Source=N'" & Source & "'", objTrans)
            dt.AcceptChanges()


            Dim objdt As New DataTable
            objdt = GetDataTable("Select IsNull(Count(*),0)+1 as Cont From DocumentAttachment WHERE DocId=" & DocId & " AND Source=N'" & Source & "'", objTrans)
            Dim intId As Integer = objdt.Rows(0)(0)

            Dim strSQL As String = String.Empty
            cmd.CommandText = String.Empty
            strSQL = "Delete From DocumentAttachment WHERE DocId=" & DocId & " AND Source=N'" & Source & "'"
            cmd.CommandText = strSQL
            cmd.ExecuteNonQuery()

            Dim objPath As String = getConfigValueByType("FileAttachmentPath").ToString

            If arrFile.Count > 0 Then
                'Altered Against Task#2015060001 Ali Ansari
                'Marked Against Task#2015060001 Ali Ansari
                '            If arrFile.Length > 0 Then
                'Marked Against Task#2015060001 Ali Ansari
                For Each objFile As String In arrFile
                    If IO.File.Exists(objFile) Then
                        If IO.Directory.Exists(objPath) = False Then
                            IO.Directory.CreateDirectory(objPath)
                        End If
                        Dim New_Files As String = intId & "_" & DocId & "_SI" & Me.cmbCompany.SelectedValue & "_" & Me.dtpPODate.Value.ToString("yyyyMMdd") & "." & objFile.Substring(objFile.LastIndexOf(".") + 1)
                        Dim dr As DataRow
                        dr = dt.NewRow
                        dr(0) = DocId
                        dr(1) = Source
                        dr(2) = objPath & "\" & New_Files
                        dt.Rows.Add(dr)
                        dt.AcceptChanges()
                        If IO.File.Exists(objPath & "\" & New_Files) Then
                            IO.File.Delete(objPath & "\" & New_Files)
                        End If
                        IO.File.Copy(objFile, objPath & "\" & New_Files)
                        intId += 1
                    End If
                Next
            End If


            If dt IsNot Nothing Then
                If dt.Rows.Count > 0 Then
                    For Each r As DataRow In dt.Rows
                        Dim strPath As String = objPath
                        Dim strFileName As String = r.Item("FileNames").ToString.Substring(r.Item("FileNames").ToString.LastIndexOf("\") + 1)
                        cmd.CommandText = String.Empty
                        strSQL = "INSERT INTO DocumentAttachment(DocId, Source, FileName, Path) Values(" & Val(r("DocId").ToString) & ",N'" & r.Item("Source").ToString.Replace("'", "''") & "', N'" & strFileName.Replace("'", "''") & "', N'" & strPath.Replace("'", "''") & "')"
                        cmd.CommandText = strSQL
                        cmd.ExecuteNonQuery()
                    Next
                End If
            End If


        Catch ex As Exception
            objTrans.Rollback()
            Throw ex
        End Try
    End Function
    Public Function GetVoucherRecord() As DataSet
        Try

            Dim strSQL As String = String.Empty
            Dim ds As New dsVoucherDocumentAttachment
            ds.Tables.Clear()
            strSQL = "SP_SalesInvoice " & Val(Me.grdSaved.GetRow.Cells("SalesID").Value.ToString) & ""
            Dim dt As New DataTable
            dt = GetDataTable(strSQL)
            dt.AcceptChanges()
            ds.Tables.Add(dt)
            ds.Tables(0).TableName = "dtSalesInvoice"


            strSQL = String.Empty
            strSQL = "Select DocId,FileName,Path,Convert(Image,'') as Attachment_Image From DocumentAttachment WHERE (DocId=" & Me.grdSaved.GetRow.Cells("SalesID").Value & ") AND Source=N'" & Me.Name & "'"
            Dim dtAttach As New DataTable
            dtAttach.TableName = "dtAttachment"
            dtAttach = GetDataTable(strSQL)

            If dtAttach IsNot Nothing Then
                If dtAttach.Rows.Count > 0 Then
                    For Each r As DataRow In dtAttach.Rows
                        r.BeginEdit()
                        If IO.File.Exists(CStr(r("Path").ToString & "\" & r("FileName").ToString)) Then
                            LoadPicture(r, "Attachment_Image", CStr(r("Path").ToString & "\" & r("FileName").ToString))
                        End If
                        r.EndEdit()
                    Next
                End If
            End If

            ds.Tables.Add(dtAttach)
            ds.Tables(1).TableName = "dtAttachment"
            ds.AcceptChanges()

            Return ds
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub PrintAttachmentSalesInvoiceToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintAttachmentSalesInvoiceToolStripMenuItem.Click
        Try

            If Me.grdSaved.RowCount = 0 Then Exit Sub
            'AddRptParam("Pm-dtVoucher.Voucher_Id", Me.grdVouchers.GetRow.Cells(0).Value)
            DataSetShowReport("RptSaleInvoiceDocument", GetVoucherRecord())


        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub PrintAttachmentSalesInvoiceToolStripMenuItem1_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles PrintAttachmentSalesInvoiceToolStripMenuItem1.Click
        Try
            PrintAttachmentSalesInvoiceToolStripMenuItem_Click(Nothing, Nothing)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub btnAttachment_ButtonClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles btnAttachment.ButtonClick
        Try
            ' Dim intCountAttachedFiles As Integer = 0I
            ' OpenFileDialog1.FileName = String.Empty

            ' OpenFileDialog1.Filter = "Word Documents|*.doc|Excel Worksheets|*.xls|Portable Document Format|*.pdf|Corel Draw Files|*.cdr|All Images|*.BMP;*.DIB;*.RLE;*.JPG;*.JPEG;*.JPE;*.JFIF;*.GIF;*.TIF;*.TIFF;*.PNG|" + _
            '"All files (*.*)|*.*"
            ' If OpenFileDialog1.ShowDialog = Windows.Forms.DialogResult.OK Then
            '     Dim a As Integer = 0I
            '     For a = 0 To OpenFileDialog1.FileNames.Length - 1
            '         arrFile.Add(OpenFileDialog1.FileNames(a))
            '     Next a
            '     If Me.BtnSave.Text <> "&Save" Then
            '         If Me.grdSaved.RowCount > 0 Then
            '             intCountAttachedFiles = Val(grdSaved.CurrentRow.Cells("No Of Attachment").Value)
            '         End If
            '     End If
            '     Me.btnAttachment.Text = "Attachment (" & arrFile.Count + intCountAttachedFiles & ")"
            ' End If

            Dim intCountAttachedFiles As Integer = 0I
            OpenFileDialog1.FileName = String.Empty

            OpenFileDialog1.Filter = "Word Documents|*.doc|Excel Worksheets|*.xls|Portable Document Format|*.pdf|Corel Draw Files|*.cdr|All Images|*.BMP;*.DIB;*.RLE;*.JPG;*.JPEG;*.JPE;*.JFIF;*.GIF;*.TIF;*.TIFF;*.PNG|" + _
            "All files (.)|*.*"
            If OpenFileDialog1.ShowDialog = Windows.Forms.DialogResult.OK Then
                Dim a As Integer = 0I
                For a = 0 To OpenFileDialog1.FileNames.Length - 1
                    arrFile.Add(OpenFileDialog1.FileNames(a))
                Next a
                If Me.BtnSave.Text <> "&Save" Then
                    If Me.grdSaved.RowCount > 0 Then
                        intCountAttachedFiles = Val(grdSaved.CurrentRow.Cells("No Of Attachment").Value)
                    End If
                End If
                Me.btnAttachment.Text = "Attachment (" & arrFile.Count + intCountAttachedFiles & ")"
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtMobileNo_KeyPress(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtMobileNo.KeyPress
        Try
            If e.KeyChar <> ControlChars.Back Then
                e.Handled = ("0123456789,".IndexOf(e.KeyChar) = -1)
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    'Altered  by Ali Ansari Task#20150503 
    Public Sub IsPrint()

        Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
        Dim newinvoice As Boolean = False
        Dim strCriteria As String = "Nothing"
        Me.Cursor = Cursors.WaitCursor
        Try

            If Me.grdSaved.RowCount = 0 Then Exit Sub
            PrintLog = New SBModel.PrintLogBE
            PrintLog.DocumentNo = grdSaved.GetRow.Cells("SalesNo").Value.ToString
            PrintLog.UserName = LoginUserName
            PrintLog.PrintDateTime = Date.Now
            Call SBDal.PrintLogDAL.PrintLog(PrintLog)
            newinvoice = getConfigValueByType("NewInvoice")
            '29-Jun-2017: Task # 975: Waqar Raza: Added to apply Sales print if jobcardcard is selected. 
            If Me.grdSaved.GetRow.Cells("JobCardId").Value > 0 Then
                AddRptParam("@SaleID", Me.grdSaved.GetRow.Cells("JobCardId").Value)
                'Print call to printer for HFR
                ShowReport("rptSalesInvoiceJobCard", , , , True)
            ElseIf newinvoice = True Then
                str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
                'strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
            Else
                str_ReportParam = String.Empty
                strCriteria = "{SalesDetailTable.SalesId} = " & Val(grdSaved.CurrentRow.Cells("SalesId").Value)
            End If
            '29-Jun-2017: Task # 975: Waqar Raza: Added to apply Sales print if jobcardcard is not selected.
            If Me.grdSaved.GetRow.Cells("JobCardId").Value = 0 Then
                ShowReport(IIf(newinvoice = False, "SalesInvoice", "SalesInvoiceNew") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", True, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            End If

        Catch ex As Exception
            Throw ex
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    'Altered  by Ali Ansari Task#20150503
    Private Sub TooStripPrintBill_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TooStripPrintBill.Click
        'Altered by Ali Ansari to add Bill report for Humayun Welcan 

        Dim IsPreviewSaleInvoice As Boolean = Convert.ToBoolean(getConfigValueByType("PreviewInvoice").ToString)
        Dim newinvoice As Boolean = False
        Dim strCriteria As String = "Nothing"
        Me.Cursor = Cursors.WaitCursor
        Try

            If Me.grdSaved.RowCount = 0 Then Exit Sub
            PrintLog = New SBModel.PrintLogBE
            PrintLog.DocumentNo = grdSaved.GetRow.Cells("SalesNo").Value.ToString
            PrintLog.UserName = LoginUserName
            PrintLog.PrintDateTime = Date.Now
            Call SBDal.PrintLogDAL.PrintLog(PrintLog)
            newinvoice = getConfigValueByType("NewInvoice")
            If newinvoice = True Then
                str_ReportParam = "@SaleID|" & grdSaved.CurrentRow.Cells("SalesId").Value
            Else
                str_ReportParam = String.Empty
                strCriteria = "{SalesDetailTable.SalesId} = " & grdSaved.CurrentRow.Cells("SalesId").Value
            End If

            ShowReport(IIf(newinvoice = False, "Bill", "Bill") & grdSaved.CurrentRow.Cells("LocationId").Value, strCriteria, "Nothing", "Nothing", False, , "New", , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)

        Catch ex As Exception
            Throw ex
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    Private Sub BtnPrintNew_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnPrintNew.Click
        Try
            If ChkInvoice.Checked = False And ChkBill.Checked = False And ChkUnderTaking.Checked = False Then
                ShowErrorMessage("Select atleast one option to proceed print")
                Exit Sub
            End If
            If ChkInvoice.Checked = True Then
                PrintToolStripMenuItem_Click(sender, e)
            End If


            If ChkBill.Checked = True Then
                CommercialBillToolStripMenuItem_Click(sender, e)
            End If

            If ChkUnderTaking.Checked = True Then
                PrintUndertakingLetterToolStripMenuItem_Click(sender, e)
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub
    Private Sub txtStock_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtStock.Click
        Try
            If Me.cmbItem.IsItemInList = False Then Exit Sub
            If Me.cmbItem.ActiveRow Is Nothing Then Exit Sub

            ApplyStyleSheet(frmCurrentStock)
            If Not getConfigValueByType("ArticleFilterByLocation").ToString = "Error" Then
                flgLocationWiseItems = getConfigValueByType("ArticleFilterByLocation")
            End If

            Call New frmCurrentStock(cmbItem.Value, IIf(flgLocationWiseItems = True, Me.cmbCategory.SelectedValue, 0), Me.cmbItem.ActiveRow.Cells("Item").Value.ToString()).ShowDialog()
            Exit Sub
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub FillOutwardExpense(ReceivingID As Integer, Optional DocType As String = "")
        Try

            'Dim dtOutwardExpDetail As DataTable = GetDataTable("Select IsNull(PurchaseId,0) as PurchaseId, IsNull(coa.coa_detail_id,0)  as AccountId ,coa.detail_title, IsNull(Exp_Amount,0) as Exp_Amount From tblDefOutwardAccounts INNER JOIN vwCOADetail coa on coa.coa_detail_id = tblDefOutwardAccounts.OutwardAccountId LEFT OUTER JOIN (select PurchaseId, AccountId,Exp_Amount From OutwardExpenseDetailTable WHERE PurchaseId=" & ReceivingID & " AND DocType=N'" & DocType & "') Exp_D  ON Exp_D.AccountId = COA.coa_detail_id")
            Dim dtOutwardExpDetail As DataTable = GetDataTable("Select Exp.SalesId, tblDefOutwardAccounts.OutwardAccountId as AccountId,vw.Detail_Title,Case When  isnull(Exp_Amount,0) > 0 then isnull(Exp_Amount,0) else 0 end as Debit,Case When  isnull(Exp_Amount,0) <0 then abs(isnull(Exp_Amount,0))  else 0 end as Credit From vwCoaDetail vw INNER JOIN tblDefOutwardAccounts on tblDefOutwardAccounts.OutwardAccountId = vw.coa_detail_id LEFT OUTER JOIN (select SalesId,AccountId,Exp_Amount From OutwardExpenseDetailTable WHERE SalesId=" & ReceivingID & " AND DocType='" & DocType.Replace("'", "''") & "') Exp ON Exp.AccountId = vw.coa_detail_id")
            dtOutwardExpDetail.AcceptChanges()
            Me.grdOutwardExpDetail.DataSource = Nothing
            Me.grdOutwardExpDetail.DataSource = dtOutwardExpDetail
            Me.grdOutwardExpDetail.RootTable.Columns("Debit").FormatString = "N" & DecimalPointInValue
            Me.grdOutwardExpDetail.RootTable.Columns("Credit").FormatString = "N" & DecimalPointInValue
            Me.grdOutwardExpDetail.RootTable.Columns("Debit").TotalFormatString = "N" & DecimalPointInValue
            Me.grdOutwardExpDetail.RootTable.Columns("Credit").TotalFormatString = "N" & DecimalPointInValue
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub btnAddExp_Click(sender As Object, e As EventArgs) Handles btnAddExp.Click
        Try

            If Me.cmbInwardExpense.IsItemInList = False Then Exit Sub
            If Me.cmbInwardExpense.ActiveRow Is Nothing Then Exit Sub
            If Con Is Nothing Then Exit Sub
            If Me.grdOutwardExpDetail.RowCount > 0 Then
                Dim bln As Boolean = Me.grdOutwardExpDetail.Find(Me.grdOutwardExpDetail.RootTable.Columns("AccountId"), Janus.Windows.GridEX.ConditionOperator.Equal, Me.cmbInwardExpense.Value, 0, 1)
                If bln = True Then
                    ShowErrorMessage("Account is already added")
                    Exit Sub
                End If
            End If
            Dim objcon As New OleDbConnection(Con.ConnectionString)
            Dim cmd As New OleDbCommand

            If objcon.State = ConnectionState.Closed Then objcon.Open()
            Dim objtrans As OleDbTransaction = objcon.BeginTransaction
            cmd.Connection = objcon
            cmd.Transaction = objtrans
            cmd.CommandType = CommandType.Text

            cmd.CommandText = String.Empty
            cmd.CommandText = "INSERT INTO tblDefOutwardAccounts(OutwardAccountId,Active) VALUES(" & Me.cmbInwardExpense.Value & ",1) Select @@Identity"

            cmd.ExecuteNonQuery()
            objtrans.Commit()

            objcon.Close()
            objtrans.Dispose()
            objcon.Dispose()

            Dim dt As DataTable = CType(Me.grdOutwardExpDetail.DataSource, DataTable)
            dt.AcceptChanges()
            Dim dr As DataRow
            dr = dt.NewRow
            If Me.BtnSave.Text <> "&Save" Then
                dr(0) = Val(Me.grdSaved.GetRow.Cells("SalesId").Value.ToString)
            Else
                dr(0) = 0
            End If
            dr(1) = Me.cmbInwardExpense.Value
            dr(2) = Me.cmbInwardExpense.ActiveRow.Cells("Account Title").Value.ToString
            dr(3) = 0
            dr(4) = 0
            dt.Rows.Add(dr)
            dt.AcceptChanges()


        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub grdOutwardExpDetail_CellUpdated(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdOutwardExpDetail.CellUpdated
        Try
            Me.grdOutwardExpDetail.UpdateData()
            If Me.grdOutwardExpDetail.RootTable.Columns(e.Column.Index).DataMember.ToString = "Debit" Then
                If Val(Me.grdOutwardExpDetail.GetRow.Cells("Credit").Value.ToString) > 0 Then
                    Me.grdOutwardExpDetail.GetRow.Cells("Credit").Value = 0
                End If
            End If

            If Me.grdOutwardExpDetail.RootTable.Columns(e.Column.Index).DataMember.ToString = "Credit" Then
                If Val(Me.grdOutwardExpDetail.GetRow.Cells("Debit").Value.ToString) > 0 Then
                    Me.grdOutwardExpDetail.GetRow.Cells("Debit").Value = 0
                End If
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub grdOutwardExpDetail_ColumnButtonClick(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdOutwardExpDetail.ColumnButtonClick
        Try


            Dim objcon As New OleDbConnection(Con.ConnectionString)
            Dim cmd As New OleDbCommand

            If objcon.State = ConnectionState.Closed Then objcon.Open()
            Dim objtrans As OleDbTransaction = objcon.BeginTransaction
            cmd.Connection = objcon
            cmd.Transaction = objtrans
            cmd.CommandType = CommandType.Text

            cmd.CommandText = String.Empty
            cmd.CommandText = "Delete From tblDefOutwardAccounts  WHERE OutwardAccountId=" & Val(grdOutwardExpDetail.GetRow.Cells("AccountId").Value.ToString) & ""

            cmd.ExecuteNonQuery()
            objtrans.Commit()

            objcon.Close()
            objtrans.Dispose()
            objcon.Dispose()

            Me.grdOutwardExpDetail.GetRow.Delete()
            '' TASK TFS1495 ON 25-09-2017
            Me.grdOutwardExpDetail.UpdateData()
            GetTotal()
            ''END TASK TFS1495

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub



    Public Sub SaveOutwardExpense(SalesId As Integer, trans As OleDbTransaction)
        Dim objCommand As New OleDbCommand
        objCommand.CommandType = CommandType.Text
        objCommand.Connection = trans.Connection
        objCommand.Transaction = trans
        Try


            objCommand.CommandText = ""
            objCommand.CommandText = "Select Voucher_ID From tblVoucher WHERE Voucher_No In (Select SalesNo From SalesMasterTable WHERE SalesId=" & SalesId & ")"
            Dim lngVoucherMasterId As Long = objCommand.ExecuteScalar

            objCommand.CommandText = ""
            objCommand.CommandText = "Delete From OutwardExpenseDetailTable WHERE SalesId=" & SalesId & ""
            objCommand.ExecuteNonQuery()


            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grdOutwardExpDetail.GetRows


                If Val(r.Cells("Debit").Value.ToString) <> 0 Or Val(r.Cells("Credit").Value.ToString) <> 0 Then
                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO OutwardExpenseDetailTable(SalesId, AccountId, Exp_Amount,DocType) Values(" & SalesId & ", " & Val(r.Cells("AccountId").Value.ToString) & ", " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), -Val(r.Cells("Credit").Value.ToString)) & ",'SI')"
                    objCommand.ExecuteNonQuery()

                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(Me.cmbVendor.Value.ToString), Val(r.Cells("AccountId").Value.ToString)) & ", " & 0 & ",  " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), Val(r.Cells("Credit").Value.ToString)) & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & " " & Me.txtRemarks.Text & "', " & Me.cmbProject.SelectedValue & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()



                    objCommand.CommandText = ""
                    objCommand.CommandText = "INSERT INTO tblVoucherDetail(voucher_id, location_id, coa_detail_id, debit_amount, credit_amount,comments, CostCenterId) " _
                                                              & " VALUES(" & lngVoucherMasterId & ", " & IIf(flgCompanyRights = True, "" & MyCompanyId & "", "1") & ", " & IIf(Val(r.Cells("Credit").Value.ToString) > 0, Val(Me.cmbVendor.Value), Val(r.Cells("AccountId").Value.ToString)) & ",   " & IIf(Val(r.Cells("Debit").Value.ToString) > 0, Val(r.Cells("Debit").Value.ToString), Val(r.Cells("Credit").Value.ToString)) & "," & 0 & ", N'" & r.Cells("detail_title").Value.ToString & " Ref: " & Me.txtPONo.Text & " " & Me.txtRemarks.Text & "', " & Me.cmbProject.SelectedValue & " )"

                    ' objCommand.Transaction = trans
                    objCommand.ExecuteNonQuery()

                End If
            Next

            UpdateOutwardExpense(Val(SalesId), trans)

        Catch ex As Exception
            trans.Rollback()
            Throw ex
        End Try
    End Sub
    Protected Sub UpdateOutwardExpense(ReceivingId As Integer, objtrans As OleDbTransaction)
        Dim cmd As New OleDbCommand
        cmd.Connection = objtrans.Connection
        cmd.Transaction = objtrans
        cmd.CommandType = CommandType.Text

        Try
            Dim Str As String = String.Empty
            Str = "Update SalesMasterTable SET TotalOutwardExpense= 0 Where SalesId= " & ReceivingId & ""
            cmd.CommandText = Str
            cmd.ExecuteNonQuery()

            Dim strSQL As String = String.Empty
            strSQL = "if exists(Select * from information_schema.tables where table_name='OutwardExpenseDetailTable') " _
                   & " Update SalesMasterTable SET TotalOutwardExpense=IsNull(a.Exp_Amount,0) From SalesMasterTable," _
                   & " (Select SalesId, ISNull(SUM(Exp_Amount),0) as Exp_Amount From OutwardExpenseDetailTable WHERE DocType='SI' AND SalesId=" & ReceivingId & " Group By SalesId) a WHERE a.SalesId = SalesMasterTable.SalesId AND SalesMasterTable.SalesId=" & ReceivingId & ""
            cmd.CommandText = strSQL
            cmd.ExecuteNonQuery()


        Catch ex As Exception
            objtrans.Rollback()
            Throw ex
        End Try
    End Sub

    Private Sub cmbDeliveryChalan_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbDeliveryChalan.SelectedIndexChanged
        Try
            If IsFormOpend = False Then Exit Sub
            If cmbVendor.IsItemInList = False Then Exit Sub
            If cmbVendor.ActiveRow Is Nothing Then Exit Sub
            If Me.cmbDeliveryChalan.Items.Count = 0 Then Exit Sub
            If grd.DataSource Is Nothing Then Exit Sub
            Dim bln As Boolean = False
            Dim blnLoadMultiChalan As Boolean = False
            Dim _DeliveryChalanId As Integer = 0I
            Boolean.TryParse(getConfigValueByType("LoadMultiChalanOnSale"), blnLoadMultiChalan)
            If blnLoadMultiChalan = False Then
                If Me.BtnSave.Text <> "&Save" Then
                    If Me.grdSaved.RowCount > 0 Then
                        If Val(Me.grdSaved.GetRow.Cells("DeliveryId").Value.ToString) > 0 Then
                            If Me.cmbDeliveryChalan.SelectedIndex > 0 Then
                                If Me.cmbDeliveryChalan.SelectedValue <> (Me.grdSaved.GetRow.Cells("DeliveryId").Value.ToString) Then
                                    If msg_Confirm("You have changed Delivery Chalan [" & CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("DeliveryNo").ToString & "], do you want to proceed. ?") = False Then
                                        RemoveHandler cmbDeliveryChalan.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
                                        Me.cmbDeliveryChalan.SelectedValue = (Me.grdSaved.GetRow.Cells("DeliveryId").Value.ToString)
                                        Exit Sub
                                    End If
                                Else
                                    Exit Sub
                                End If
                            End If
                        End If
                    End If
                End If
                If Me.cmbDeliveryChalan.SelectedIndex > 0 Then
                    'cmbCompany.SelectedValue = Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("LocationId").ToString)
                    DeliveryChalanId = Me.cmbDeliveryChalan.SelectedValue
                    txtRemarks.Text = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("Remarks").ToString
                    'rafay
                    txtPO.Text = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("PO_NO").ToString
                    'rafay
                    uitxtBiltyNo.Text = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("BiltyNo").ToString
                    cmbProject.SelectedValue = Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("Project").ToString)
                    cmbOtherCompany.Text = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("Other_Company").ToString
                    ''Strat TFS4339
                    Me.cmbSalesMan.SelectedValue = IIf(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("EmployeeCode").ToString) > 0, Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("EmployeeCode").ToString), Me.cmbSalesMan.SelectedValue)
                    Me.cmbTransporter.SelectedValue = IIf(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("TransporterId").ToString) > 0, Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("TransporterId").ToString), Me.cmbTransporter.SelectedValue)
                    ''End TFS4339
                    If IsDBNull(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("Arrival_Time")) Then
                        Me.dtpArrivalTime1.Value = Date.Now
                    Else
                        Me.dtpArrivalTime1.Value = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("Arrival_Time")
                    End If

                    If IsDBNull(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("Departure_Time")) Then
                        Me.dtpDepartureTime1.Value = Date.Now
                        Me.dtpDepartureTime1.Checked = False
                    Else
                        Me.dtpDepartureTime1.Value = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("Departure_Time")
                        Me.dtpDepartureTime1.Checked = True
                    End If
                    If Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("JobCardId").ToString) > 0 Then
                        GetJobCard(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("JobCardId").ToString))
                        Me.gbJobCard.Visible = True
                    Else
                        Me.gbJobCard.Visible = False
                    End If
                    ''// Incorrect coding by someone
                    'If IsDBNull(Me.grdSaved.GetRow.Cells("Arrival_Time").Value.ToString) Then
                    '    Me.dtpArrivalTime.Value = Date.Now
                    'Else
                    '    Me.dtpArrivalTime.Value = Me.grdSaved.GetRow.Cells("Arrival_Time").Value
                    'End If

                    'If IsDBNull(Me.grdSaved.GetRow.Cells("Departure_Time").Value) Then
                    '    Me.dtpDepartureTime.Value = Date.Now
                    '    Me.dtpDepartureTime.Checked = False
                    'Else
                    '    Me.dtpDepartureTime.Value = Me.grdSaved.GetRow.Cells("Departure_Time").Value
                    '    Me.dtpDepartureTime.Checked = True
                    'End If
                    'Me.cmbVendor.Value = Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("CustomerCode").ToString)
                    If Me.cmbVendor.ActiveRow.Cells(0).Value > 0 Then
                        Me.cmbVendor.Enabled = False
                    Else
                        Me.cmbVendor.Enabled = True
                    End If
                    DisplayDetail(-1)
                    DisplayDeliveryChalanDetail(Me.cmbDeliveryChalan.SelectedValue)
                    'AddHandler cmbDeliveryChalan.SelectedIndexChanged, AddressOf Me.cmbDeliveryChalan_SelectedIndexChanged
                    'Exit Sub
                End If
            Else
                If Me.cmbDeliveryChalan.SelectedIndex > 0 Then
                    If Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("JobCardId").ToString) > 0 Then
                        GetJobCard(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("JobCardId").ToString))
                        Me.gbJobCard.Visible = True
                    Else
                        Me.gbJobCard.Visible = False
                    End If
                    ''Strat TFS4339
                    Me.cmbSalesMan.SelectedValue = IIf(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("EmployeeCode").ToString) > 0, Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("EmployeeCode").ToString), Me.cmbSalesMan.SelectedValue)
                    Me.cmbTransporter.SelectedValue = IIf(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("TransporterId").ToString) > 0, Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("TransporterId").ToString), Me.cmbTransporter.SelectedValue)
                    ''End TFS4339
                    'Rafay:Task Start:this line will show automatically PO_NO when delivery challan combo box  is selected
                    Me.txtPO.Text = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Row.Item("PO_NO").ToString
                    'RAfay task end
                End If
             
                DeliveryChalanId = 0I
                Dim intDeliveryChalanID As Integer = 0I
                Int32.TryParse(Me.cmbDeliveryChalan.SelectedValue, intDeliveryChalanID)
                DeliveryChalanId = intDeliveryChalanID
                grd.UpdateData()
                Dim dtSelect As DataTable = CType(grd.DataSource, DataTable)
                dtSelect.AcceptChanges()
                Dim dr() As DataRow = dtSelect.Select("DeliveryChalanID=" & intDeliveryChalanID & "")
                If Not dr.Length > 0 Then
                    DisplayDeliveryChalanDetail(intDeliveryChalanID)
                End If
            End If
            GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        Finally
            '
        End Try
    End Sub

    Protected Sub UpdateDeliveryChalanStatus(SalesId As Integer, Condition As String, trans As OleDb.OleDbTransaction)
        Try
            Dim cmd As New OleDbCommand
            cmd.Connection = trans.Connection
            cmd.Transaction = trans
            cmd.CommandType = CommandType.Text
            cmd.CommandTimeout = 300
            cmd.CommandText = ""
            cmd.CommandText = "Update DeliveryChalanDetailTable Set DeliveredQty=IsNull(DeliveredQty,0)  " & IIf(Condition = "Delete", "-", "+") & " IsNull(SalesDetailTable.Sz1,0), DeliveredTotalQty=IsNull(DeliveredTotalQty,0)  " & IIf(Condition = "Delete", "-", "+") & " IsNull(SalesDetailTable.Qty,0) From DeliveryChalanDetailTable, SalesDetailTable  WHERE DeliveryChalanDetailTable.DeliveryDetailID = SalesDetailTable.DeliveryChalanDetailID AND SalesDetailTable.SalesID=" & SalesId & ""
            cmd.ExecuteNonQuery()
            cmd.CommandText = ""
            cmd.CommandText = "Update DeliveryChalanMasterTable Set Status=Case When IsNull(a.RemainingQty,0) > 0 then 'Open' else 'Close' End From DeliveryChalanMasterTable, (Select DeliveryId, SUM(IsNull(DeliveryChalanDetailTable.Sz1,0)-IsNull(DeliveryChalanDetailTable.DeliveredQty,0)) RemainingQty From DeliveryChalanDetailTable INNER JOIN SalesDetailTable on SalesDetailTable.DeliveryChalanID = DeliveryChalanDetailTable.DeliveryID  WHERE SalesDetailTable.SalesID=" & SalesId & " Group By DeliveryID) a WHERE a.DeliveryId = DeliveryChalanMasterTable.DeliveryId"
            cmd.ExecuteNonQuery()
        Catch ex As Exception
            trans.Rollback()
            Throw ex
        End Try
    End Sub

    Private Sub txtNetAmount_TextChanged(sender As Object, e As EventArgs) Handles txtNetAmount.TextChanged

        Try
            ''TASKTFS126
            Dim CurrentBalance As Double = 0
            Dim NetAmount As Double = 0
            Dim TotalAmount As Double = 0
            CurrentBalance = IIf(txtCurrentBalance.Text = "", 0, Val(txtCurrentBalance.Text.ToString()))
            NetAmount = IIf(txtNetAmount.Text = "", 0, Val(txtNetAmount.Text.ToString()))
            TotalAmount = Math.Round(CurrentBalance + NetAmount, TotalAmountRounding)
            txtTotalAmount.Text = TotalAmount.ToString()
        Catch ex As Exception
            Throw ex
        End Try

    End Sub

    Public Sub GetAllRecords(Optional Condition As String = "") Implements IGeneral.GetAllRecords

    End Sub

    Private Sub GetExclueExpenseTotal()
        Try
            Me.grd.UpdateData()
            Dim dblTotal As Double = 0D
            Dim dblExclTotal As Double = 0D
            For Each r As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                If Convert.ToBoolean(r.Cells("ApplyAdjustmentFuelExp").Value.ToString) = True Then
                    dblTotal += Val(r.Cells("Total Amount").Value.ToString)
                Else
                    dblExclTotal += Val(r.Cells("Total Amount").Value.ToString)
                End If
            Next
            ''Start TFS1799
            For Each r As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                If flgExcludeTaxPrice = True Then
                    dblTotal += Val(r.Cells("Tax Amount").Value.ToString)
                Else
                    dblTotal = dblTotal
                End If
            Next
            ''End TFS1799
            If Convert.ToBoolean(getConfigValueByType("ExpenseChargeToCustomer").ToString) = False Then
                If rbtAdjFlat.Checked = True Then
                    dblTotal = dblTotal - (Val(Me.txtFuel.Text) + Val(Me.txtExpense.Text) + Val(Me.txtAdjustment.Text))
                    dblTotal = dblTotal + dblExclTotal + Val(Me.txtAddTransitInsurance.Text)
                Else
                    'Ali Faisal : TFS2001 : Invoice adjustment for multi currency
                    'dblTotal = dblTotal - (Val(Me.txtFuel.Text) + Val(Me.txtExpense.Text))
                    'Adjustment = Math.Round(((Val(dblTotal) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    If Val(Me.grd.GetRow.Cells(EnumGridDetail.CurrencyId).Value.ToString) > 1 Then
                        Adjustment = Math.Round(((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount), Janus.Windows.GridEX.AggregateFunction.Sum)) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    Else
                        Adjustment = Math.Round(((Val(dblTotal) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    End If
                    'Ali Faisal : TFS2001 : End
                    dblTotal = dblTotal - (Val(Me.txtFuel.Text) + Val(Me.txtExpense.Text) + Val(Adjustment))
                    dblTotal = dblTotal + dblExclTotal + Val(Me.txtAddTransitInsurance.Text)
                End If


            Else
                If rbtAdjFlat.Checked = True Then
                    dblTotal = dblTotal + ((Val(Me.txtFuel.Text) + Val(Me.txtExpense.Text)) - Val(Me.txtAdjustment.Text))
                    dblTotal = dblTotal + dblExclTotal + Val(Me.txtAddTransitInsurance.Text)
                Else
                    'Ali Faisal : TFS2001 : Invoice adjustment for multi currency
                    'dblTotal = dblTotal + (Val(Me.txtFuel.Text) + Val(Me.txtExpense.Text))
                    'Adjustment = Math.Round(((Val(dblTotal) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    If Val(Me.grd.GetRow.Cells(EnumGridDetail.CurrencyId).Value.ToString) > 1 Then
                        Adjustment = Math.Round(((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount), Janus.Windows.GridEX.AggregateFunction.Sum)) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    Else
                        Adjustment = Math.Round(((Val(dblTotal) * Val(Me.txtAdjustment.Text)) / 100), DecimalPointInValue)
                    End If
                    'Ali Faisal : TFS2001 : End
                    dblTotal = dblTotal + ((Val(Me.txtFuel.Text) + Val(Me.txtExpense.Text)) - Val(Adjustment))
                    dblTotal = dblTotal + dblExclTotal + Val(Me.txtAddTransitInsurance.Text)
                End If

            End If
            txtAmount.Text = Math.Round((((Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum))))), DecimalPointInValue)
            ''TASK TFS1495
            Dim TotalDebit As Double = Me.grdOutwardExpDetail.GetTotal(Me.grdOutwardExpDetail.RootTable.Columns("Debit"), Janus.Windows.GridEX.AggregateFunction.Sum)
            Dim TotalCredit As Double = Me.grdOutwardExpDetail.GetTotal(Me.grdOutwardExpDetail.RootTable.Columns("Credit"), Janus.Windows.GridEX.AggregateFunction.Sum)
            dblTotal += (TotalCredit - TotalDebit)
            ''End TASK TFS1495
            Me.txtNetAmount.Text = Math.Round(dblTotal, TotalAmountRounding)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub txtTotalQuantity_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtTotalQuantity.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtTotalQuantity_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtTotalQuantity.LostFocus
        Try
            'GetTotal()
            If Not Val(Me.txtPackQty.Text) > 0 Then
                Me.txtQty.Text = Val(Me.txtTotalQuantity.Text)
            End If
            'Me.txtRate_LostFocus(Nothing, Nothing)
            'TASKM22815
            'GetDetailTotal()

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'TASKM22815


    Private Sub DiscountCalculation()
        Try
            Dim Rate As Double = 0D


            'Rate = Me.cmbItem.ActiveRow.Cells("Price").Value.ToString
            'Rate = Val(txtRate.Text)
            Rate = Val(Me.txtPDP.Text)

            If Val(Me.txtDisc.Text) <> 0 AndAlso Rate > 0 Then
                Dim discount As Double = 0D
                'Change Againt TFS1153 
                'If rbPer.Checked = True Then
                If Me.cmbDiscountType.Text.Equals(DiscountType_Percentage) Then
                    discount = (Val(Rate) * Val(Me.txtDisc.Text)) / 100
                    Me.txtDiscountValue.Text = discount
                Else
                    discount = Val(Me.txtDisc.Text)
                    Me.txtDiscountValue.Text = discount
                End If
                Me.txtRate.Text = Val(Rate) - Math.Round(discount, 2).ToString()

            Else
                Rate = Me.txtRate.Text
                Me.txtDiscountValue.Text = 0
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Public Sub GetDetailTotal()
        Try
            'Task#26082015 by Ahmad Sharif
            If Val(Me.txtPackRate.Text) > 0 Then
                If getConfigValueByType("Apply40KgRate").ToString = "True" AndAlso Me.cmbUnit.Text <> "Loose" Then
                    'Me.txtRate.Text = (Val(Me.txtPackRate.Text) / 40)  ''TFS1964 :Ayesha Rehman : Edit Against TFS1964
                    Me.txtPDP.Text = Math.Round((Val(Me.txtPackRate.Text) / 40), TotalAmountRounding) ''TFS1964 :Ayesha Rehman : Edit Against TFS1964
                ElseIf Me.cmbUnit.Text <> "Loose" Then

                    'Me.txtRate.Text = (Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text)) ''TFS1964 :Ayesha Rehman : Edit Against TFS1964
                    ''Below line is commented on 08-03-2018 against TASK TFS2623
                    'Me.txtPDP.Text = (Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text)) ''TFS1964 :Ayesha Rehman : Edit Against TFS1964
                End If
            End If
            'End Task#26082015
            If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtTotal.Text) = 0 Then
                Me.txtTotal.Text = Math.Round((Val(Me.txtTotalQuantity.Text) * Val(Me.txtRate.Text)), TotalAmountRounding)
                Total = Val(Me.txtTotal.Text)
            End If
            ''Commented Against TFS4868
            'If Val(Me.txtTotalQuantity.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 Then
            '    ''Below lines are commented on 08-03-2018 against TASK TFS2623
            '    'Me.txtRate.Text = Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text)
            '    Me.txtPDP.Text = Math.Round((Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text)), TotalAmountRounding)
            'End If
            If Val(Me.txtRate.Text) <> 0 AndAlso Val(Me.txtTotal.Text) <> 0 AndAlso Val(Me.txtTotalQuantity.Text) = 0 Then
                If Not Me.cmbUnit.Text <> "Loose" Then
                    Me.txtQty.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtRate.Text), TotalAmountRounding)
                    Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
                Else
                    If Val(Me.txtPackQty.Text) > 0 Then
                        Me.txtQty.Text = (Val(Me.txtTotal.Text) / Val(Me.txtRate.Text)) / Val(Me.txtPackQty.Text)
                        Me.txtTotalQuantity.Text = Math.Round((Val(Me.txtQty.Text) * Val(Me.txtPackQty.Text)), TotalAmountRounding)
                    Else
                        Me.txtQty.Text = Math.Round(Val(Me.txtTotal.Text) / Val(Me.txtRate.Text), TotalAmountRounding)
                        Me.txtTotalQuantity.Text = Val(Me.txtQty.Text)
                    End If
                End If
            Else
                Me.txtTotal.Text = Math.Round(Val(Me.txtTotalQuantity.Text) * Val(Me.txtRate.Text), TotalAmountRounding)     'Task#26082015
                Total = Val(Me.txtTotal.Text)
            End If
            Dim dblTaxPercent As Double = 0D
            Double.TryParse(Me.txtTax.Text, dblTaxPercent)

            If flgExcludeTaxPrice = True Then
                Me.txtNetTotal.Text = Math.Round(Val(Me.txtTotal.Text), TotalAmountRounding) ''TFS1799,
            Else
                Me.txtNetTotal.Text = Math.Round((((dblTaxPercent / 100) * Val(Me.txtTotal.Text)) + Val(Me.txtTotal.Text)), TotalAmountRounding)
            End If


        Catch ex As Exception
            Throw ex
        End Try
    End Sub


    Public Sub GetGridDetailTotal()
        Try

            Me.grd.UpdateData()
            Me.grd.EditMode = Janus.Windows.GridEX.EditMode.EditOn
            If Val(grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString) <> 0 AndAlso Val(grd.GetRow.Cells(EnumGridDetail.Price).Value.ToString) <> 0 AndAlso Val(grd.GetRow.Cells(EnumGridDetail.Total).Value.ToString) = 0 Then
                'grd.GetRow.Cells(EnumGridDetail.Total).Value = Math.Round((Val(grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString) * Val(grd.GetRow.Cells(EnumGridDetail.Price).Value.ToString)), DecimalPointInValue)
            End If
            If Val(grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString) <> 0 AndAlso Val(grd.GetRow.Cells(EnumGridDetail.Total).Value.ToString) <> 0 AndAlso Val(grd.GetRow.Cells(EnumGridDetail.Price).Value.ToString) = 0 Then
                Me.txtRate.Text = Val(grd.GetRow.Cells(EnumGridDetail.Total).Value.ToString) / Val(grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString)
            End If
            If Val(grd.GetRow.Cells(EnumGridDetail.Price).Value.ToString) <> 0 AndAlso Val(grd.GetRow.Cells(EnumGridDetail.Total).Value.ToString) <> 0 AndAlso Val(grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString) = 0 Then
                If Not Me.cmbUnit.Text <> "Loose" Then
                    grd.GetRow.Cells(EnumGridDetail.Qty).Value = Val(grd.GetRow.Cells(EnumGridDetail.Total).Value.ToString) / Val(grd.GetRow.Cells(EnumGridDetail.Price).Value.ToString)
                    grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = Val(grd.GetRow.Cells(EnumGridDetail.Qty).Value.ToString)
                Else
                    If Val(grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) > 0 Then
                        grd.GetRow.Cells(EnumGridDetail.Qty).Value = (Val(grd.GetRow.Cells(EnumGridDetail.Total).Value.ToString) / Val(grd.GetRow.Cells(EnumGridDetail.Price).Value.ToString)) / Val(grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString)
                        grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = (Val(grd.GetRow.Cells(EnumGridDetail.Qty).Value.ToString) * Val(grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString))
                    Else
                        grd.GetRow.Cells(EnumGridDetail.Qty).Value = Val(grd.GetRow.Cells(EnumGridDetail.Total).Value.ToString) / Val(grd.GetRow.Cells(EnumGridDetail.Price).Value.ToString)
                        grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = Val(grd.GetRow.Cells(EnumGridDetail.Qty).Value.ToString)
                    End If
                End If
            End If

            Me.grd.EditMode = Janus.Windows.GridEX.EditMode.EditOff

        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    'TASKM22815
    Private Sub txtTotalQuantity_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtTotalQuantity.TextChanged
        Try
            'GetTotal()
            If Not Val(Me.txtPackQty.Text) > 0 Then
                If Not Val(Me.txtTotalQty.Text) = 0 Then
                    Me.txtQty.Text = Val(Me.txtTotalQuantity.Text)
                End If
            End If
            'If Not Val(Me.txtPackQty.Text) > 0 Then
            '    Me.txtQty.Text = Val(Me.txtTotalQuantity.Text)
            'End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'TASKM22815
    Public Sub GetGridDetailQtyCalculate(ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs)
        Try
            Me.grd.UpdateData()
            Dim AfterDeductionQty As Double = 0
            Dim BardanaDeductionQty As Double = Val(Me.grd.GetRow.Cells(EnumGridDetail.BardanaDeduction).Value.ToString)
            Dim OtherDeductionQty As Double = Val(Me.grd.GetRow.Cells(EnumGridDetail.OtherDeduction).Value.ToString)
            Dim TotalDeduction As Double = BardanaDeductionQty + OtherDeductionQty
            If TotalDeduction <= Val(Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString) Then
                AfterDeductionQty = Val(Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString) - (Val(Me.grd.GetRow.Cells(EnumGridDetail.BardanaDeduction).Value.ToString) + Val(Me.grd.GetRow.Cells(EnumGridDetail.OtherDeduction).Value.ToString))
            Else
                AfterDeductionQty = Val(Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString)
            End If
            If e.Column.Index = EnumGridDetail.Qty Or e.Column.Index = EnumGridDetail.PackQty Then
                If Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) > 1 Then
                    Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = (Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) * Val(Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value.ToString))
                    Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
                Else
                    Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = Val(Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value.ToString)
                    Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
                End If
            ElseIf e.Column.Index = EnumGridDetail.TotalQty Then
                If Not Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) > 1 Then
                    Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = Val(Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString)
                    Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
                End If
            ElseIf e.Column.Index = EnumGridDetail.PackPrice Then
                If Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) > 1 Then
                    Me.grd.GetRow.Cells(EnumGridDetail.Price).Value = (Val(Me.grd.GetRow.Cells(EnumGridDetail.PackPrice).Value.ToString) / Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString))
                End If

            ElseIf e.Column.Index = EnumGridDetail.BardanaDeduction Then
                If TotalDeduction > AfterDeductionQty Then
                    ShowErrorMessage("You can not enter more than remaining quantity.")
                    Me.grd.GetRow.Cells(EnumGridDetail.BardanaDeduction).Value = AfterDeductionQty - OtherDeductionQty
                End If
            ElseIf e.Column.Index = EnumGridDetail.OtherDeduction Then
                If TotalDeduction > AfterDeductionQty Then
                    ShowErrorMessage("You can not enter more than remaining quantity.")
                    Me.grd.GetRow.Cells(EnumGridDetail.OtherDeduction).Value = AfterDeductionQty - BardanaDeductionQty
                End If
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub grd_CellEdited(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.CellEdited
        Try

            If flgVehicleIdentificationInfo = True Then
                Select Case e.Column.Key
                    Case "Qty"
                        Dim str As String
                        str = "SELECT Engine_No, Chassis_No, Sum(InQty) InQty, Sum(OutQty) OutQty, Sum(InQty)-Sum(OutQty) Qty FROM StockDetailTable WHERE Engine_No <> '' And ArticleDefId = " & Val(Me.grd.GetRow.Cells("ArticleDefId").Value.ToString) & " GROUP BY Engine_No, Chassis_No HAVING Sum(InQty)-Sum(OutQty) > 0"
                        Dim dt As DataTable = GetDataTable(str)
                        If dt.Rows.Count > 0 Then
                            If Val(grd.GetRow.Cells("TotalQty").Value) > dt.Rows(0).Item("Qty") Then
                                ShowErrorMessage("This Qty not exists in Stock ")
                                grd.CancelCurrentEdit()
                                Exit Sub
                            End If
                        End If
                End Select
            End If

            If Not IsDBNull(Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value) Then
                Dim str As String = String.Empty
                str = " Select   ExpiryDate, Origin  From  StockDetailTable  where BatchNo not in ('','0','xxxx') And BatchNo ='" & Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString & "'" _
                     & " And ArticledefId = " & Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value & "  And LocationId = " & Val(Me.grd.GetRow.Cells(EnumGridDetail.LocationID).Value.ToString) & "  And (isnull(InQty, 0) - isnull(OutQty, 0)) > 0 Group by BatchNo,ExpiryDate,Origin ORDER BY ExpiryDate  Asc "
                Dim dtExpiry As DataTable = GetDataTable(str)
                If dtExpiry.Rows.Count > 0 Then
                    If IsDBNull(dtExpiry.Rows(0).Item("ExpiryDate")) = False Then
                        ''grd.GetRow.Cells(EnumGridDetail.ExpiryDate).Value = CType(dtExpiry.Rows(0).Item("ExpiryDate").ToString, Date)
                        grd.GetRow.Cells("Origin").Value = dtExpiry.Rows(0).Item("Origin").ToString
                    End If
                End If
            End If

            Dim Qty As Double = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value

            Dim Gross_weight As Decimal = IIf(grd.GetRow.Cells(EnumGridDetail.Gross_Weights).Value Is Nothing, 0, grd.GetRow.Cells(EnumGridDetail.Gross_Weights).Value)
            Dim Tray_weight As Decimal = IIf(grd.GetRow.Cells(EnumGridDetail.Tray_Weights).Value Is Nothing, 0, grd.GetRow.Cells(EnumGridDetail.Tray_Weights).Value)

            If Gross_weight <> 0 AndAlso Tray_weight <> 0 Then
                grd.GetRow.Cells(EnumGridDetail.Net_Weight).Value = Gross_weight - Tray_weight
                grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = Gross_weight - Tray_weight
                grd.GetRow.Cells(EnumGridDetail.Qty).Value = Gross_weight - Tray_weight

            End If
            If IsEditMode = False Then ''TFS3528
                Dim CostPrice As Double = 0D
                Dim dblPurchasePrice As Double = 0D
                Dim dblCostPrice As Double = 0D

                Dim strPriceData() As String = GetRateByItem(Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString)).Split(",")

                If strPriceData.Length > 1 Then
                    dblCostPrice = Val(strPriceData(0).ToString)
                    dblPurchasePrice = Val(strPriceData(1).ToString)
                    If dblCostPrice = 0 Then
                        dblCostPrice = dblPurchasePrice
                    End If
                End If

                If flgAvgRate = True And getConfigValueByType("CostImplementationLotWiseOnStockMovement") = "True" Then
                    If Convert.ToDouble(GetItemRateByBatch(Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString), Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString)) > 0 Then
                        Me.grd.GetRow.Cells("CostPrice").Value = Convert.ToDouble(GetItemRateByBatch(Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString), Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString))
                    Else
                        ' Me.grd.GetRow.Cells("CostPrice").Value = dblPurchasePrice ''Commented Against TFS3528
                        Me.grd.GetRow.Cells("CostPrice").Value = dblCostPrice
                    End If
                ElseIf flgAvgRate = True Then

                    If dblCostPrice > 0 Then
                        Me.grd.GetRow.Cells("CostPrice").Value = dblCostPrice
                    Else
                        Me.grd.GetRow.Cells("CostPrice").Value = dblPurchasePrice
                    End If
                Else
                    'CostPrice = IIf(Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString) <= 0, Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString), Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString))
                    Me.grd.GetRow.Cells("CostPrice").Value = dblCostPrice 'Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString)
                    'End Task:2517
                End If
            End If
            ''Start TFS3528
            If IsEditMode = True Then ''TFS3528
                If Me.grd.GetRow.Cells(EnumGridDetail.SaleDetailID).Value <= 0 Then
                    Dim CostPrice As Double = 0D
                    Dim dblPurchasePrice As Double = 0D
                    Dim dblCostPrice As Double = 0D

                    Dim strPriceData() As String = GetRateByItem(Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString)).Split(",")

                    If strPriceData.Length > 1 Then
                        dblCostPrice = Val(strPriceData(0).ToString)
                        dblPurchasePrice = Val(strPriceData(1).ToString)
                        If dblCostPrice = 0 Then
                            dblCostPrice = dblPurchasePrice
                        End If
                    End If

                    If flgAvgRate = True And getConfigValueByType("CostImplementationLotWiseOnStockMovement") = "True" Then
                        If Convert.ToDouble(GetItemRateByBatch(Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString), Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString)) > 0 Then
                            Me.grd.GetRow.Cells("CostPrice").Value = Convert.ToDouble(GetItemRateByBatch(Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString), Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString))
                        Else
                            ' Me.grd.GetRow.Cells("CostPrice").Value = dblPurchasePrice ''Commented Against TFS3528
                            Me.grd.GetRow.Cells("CostPrice").Value = dblCostPrice
                        End If
                    ElseIf flgAvgRate = True Then

                        If dblCostPrice > 0 Then
                            Me.grd.GetRow.Cells("CostPrice").Value = dblCostPrice
                        Else
                            Me.grd.GetRow.Cells("CostPrice").Value = dblPurchasePrice
                        End If
                    Else
                        'CostPrice = IIf(Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString) <= 0, Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString), Val(Me.grd.GetRows(i).Cells("CostPrice").Value.ToString))
                        Me.grd.GetRow.Cells("CostPrice").Value = dblCostPrice 'Val(Me.grd.GetRows(i).Cells("PurchasePrice").Value.ToString)
                        'End Task:2517
                    End If
                End If
            End If
            ''End TFS3528
        Catch ex As Exception

        End Try

    End Sub
    'Public Sub GetGridDetailQtyCalculate(ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs)
    '    Try
    '        Me.grd.UpdateData()
    '        If e.Column.Index = EnumGridDetail.Qty Or e.Column.Index = EnumGridDetail.PackQty Then
    '            If Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) > 1 Then
    '                Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = (Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) * Val(Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value.ToString))
    '                Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
    '            Else
    '                Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = Val(Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value.ToString)
    '                Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
    '            End If
    '        ElseIf e.Column.Index = EnumGridDetail.TotalQty Then
    '            If Not Val(Me.grd.GetRow.Cells(EnumGridDetail.PackQty).Value.ToString) > 1 Then
    '                Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = Val(Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value.ToString)
    '                Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
    '            End If

    '        End If
    '        'Me.grd.Refetch()
    '    Catch ex As Exception
    '        Throw ex
    '    End Try
    'End Sub


    Private Sub cmbCurrency_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbCurrency.SelectedIndexChanged
        Try
            If IsSOLoaded = True Then Exit Sub
            If Not Me.cmbCurrency.SelectedItem Is Nothing Then
                Dim dr As DataRowView = CType(cmbCurrency.SelectedItem, DataRowView)
                If IsEditMode = True Then

                Else
                    Me.txtCurrencyRate.Text = Math.Round(Convert.ToDouble(dr.Row.Item("CurrencyRate").ToString), 4)
                End If

                ''TASK TFS1474
                If Me.cmbCurrency.SelectedValue = BaseCurrencyId Then
                    Me.txtCurrencyRate.Enabled = False
                Else
                    Me.txtCurrencyRate.Enabled = True

                End If
                ''END TASK TFS1474
                ' R@!    11-Jun-2016 Dollor account
                ' Setting default rate to zero
                If Val(Me.txtCurrencyRate.Text) = 0 Then
                    Me.txtCurrencyRate.Text = 1
                End If

                ''TASK TFS3781
                If Me.CurrencyRate > 1 Then
                    Me.txtCurrencyRate.Text = CurrencyRate
                End If
                '' END TASK TFS3781


                'R@!    11-Jun-2016 Dollor account
                'Code Commented
                ' Me.grd.RootTable.Columns("CurrencyAmount").Caption = "" & Me.cmbCurrency.Text & " Amount"
                ' Added 2 coloumns and changed caption
                Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount).Caption = "Amount (" & Me.cmbCurrency.Text & ")"

                Me.grd.RootTable.Columns(EnumGridDetail.CurrencyRate).Caption = "Currency Rate (" & Me.cmbCurrency.Text & ")"

                Me.grd.RootTable.Columns(EnumGridDetail.TotalCurrencyAmount).Caption = "Total Amount (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(EnumGridDetail.CurrencyTaxAmount).Caption = "Tax Amount (" & Me.cmbCurrency.Text & ")"

                Me.grd.RootTable.Columns("NetBill").Caption = "Net Amount (" & Me.BaseCurrencyName & ")"
                Me.grd.RootTable.Columns("Total Amount").Caption = "Total Amount (" & Me.BaseCurrencyName & ")"
                Me.grd.RootTable.Columns("Total").Caption = "Total (" & Me.BaseCurrencyName & ")"

                'grd.AutoSizeColumns()
                If cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.BaseCurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.TotalCurrencyAmount).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyTaxAmount).Visible = False

                    'Me.grd.RootTable.Columns(EnumGrid.Credit).Visible = False
                Else
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount).Visible = True
                    'Me.grd.RootTable.Columns(EnumGridDetail.BaseCurrencyRate).Visible = True
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyRate).Visible = True
                    Me.grd.RootTable.Columns(EnumGridDetail.TotalCurrencyAmount).Visible = True
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyTaxAmount).Visible = True

                    'Ali Faisal : TFS1494 : Currency from history reset to default
                    If IsEditMode = False AndAlso Not Me.cmbPo.SelectedValue > 0 AndAlso Not Me.cmbDeliveryChalan.SelectedValue > 0 Then
                        If Me.grd.RowCount > 0 Then
                            For Each GriDEX As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                                GriDEX.BeginEdit()
                                GriDEX.Cells("CurrencyRate").Value = Val(Me.txtCurrencyRate.Text)
                                GriDEX.Cells("CurrencyId").Value = Me.cmbCurrency.SelectedValue
                                GriDEX.Cells("BaseCurrencyId").Value = BaseCurrencyId
                                GriDEX.Cells("BaseCurrencyRate").Value = 1
                                GriDEX.EndEdit()
                            Next
                        End If
                    End If
                    'Me.grd.RootTable.Columns(EnumGridDetail.Curr = Val(Me.txtCurrencyRate.Text)
                    'Me.grd.RootTable.Columns(EnumGrid.Credit).Visible = True
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Function GetCurrencyRate(ByVal currencyId As Integer) As Double ''TAKS-407
        Dim str As String = String.Empty
        Dim dt As New DataTable
        Dim currencyRate As Double = 0
        Try
            str = " Select CurrencyRate, CurrencyId From tblCurrencyRate Where CurrencyRateId in ( Select Max(CurrencyRateId) From tblCurrencyRate group by CurrencyId) And CurrencyId = " & currencyId & ""
            dt = GetDataTable(str)
            dt.AcceptChanges()
            If dt.Rows.Count > 0 Then
                currencyRate = Val(dt.Rows.Item(0).Item(0).ToString)
            End If
            Return currencyRate
        Catch ex As Exception
            Throw ex
        End Try
    End Function



    'Private Sub grdSaved_DoubleClick(sender As Object, e As EventArgs) Handles grdSaved.DoubleClick
    '    Try
    '        EditRecord()
    '        Me.UltraTabControl2.SelectedTab = Me.UltraTabControl2.Tabs(0).TabPage.Tab
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub
    Public Function CheckStock(ByVal ArticleDefId As Integer, ByVal LocationId As Integer, ByVal Unit As String, ByVal Item As String, ByVal Qty As Double, ByVal TotalQty As Double) As Boolean
        ''19-10-2016 Ameen
        Dim IsMinus As Boolean = True
        'StockChecked = False
        Try


            'If CType(Me.cmbItem.SelectedRow, Infragistics.Win.UltraWinGrid.UltraGridRow).Cells("ServiceItem").Value = False Then
            IsMinus = getConfigValueByType("AllowMinusStock")
            'End If
            If IsMinus = False Then
                'If objDataSet.Tables(0).Rows.Count > 0 Then
                '    For Each dr As DataRow In objDataSet.Tables(0).Rows
                '        dr.BeginEdit()
                AvailableStock = Convert.ToDouble(GetStockById(ArticleDefId, LocationId, Unit))

                If AvailableStock < 0 Or AvailableStock = 0 Then
                    ShowErrorMessage(" Quantity will not change because stock is negative against item " & Item & " ")
                    CheckStock = False
                    '_TotalQty = TotalQty
                    '_Qty = Qty
                Else
                    If Unit = "Loose" Then
                        If TotalQty > AvailableStock Then
                            If msg_Confirm("Stock is not enough  " & Item & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                CheckStock = False
                            Else
                                'StockChecked = True
                                _TotalQty = AvailableStock
                                _Qty = AvailableStock
                                CheckStock = True
                            End If
                        Else
                            CheckStock = True
                        End If

                    Else
                        If Qty > AvailableStock Then
                            If msg_Confirm("Stock is not enough  " & Item & ". Do you want to load available Qty in stock as partial Qty?") = False Then
                                CheckStock = False
                            Else
                                'StockChecked = True
                                CheckStock = True
                                _Qty = AvailableStock
                            End If
                        Else
                            CheckStock = True
                        End If
                    End If
                    'dr.EndEdit()
                    AvailableStock = 0
                End If
                '        Next
                'End If
            End If
            'objDataSet.AcceptChanges()
            ''End 19-10-2016 Ameen

        Catch ex As Exception
            Throw ex
        End Try
    End Function




    Public Function ValidateStock(ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) As Boolean
        Try
            Dim QtyBefore1 As Double = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
            'If Me.grd.GetRow.Cells(EnumGridDetail.Qty).DataChanged = True Or Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).DataChanged = True Or Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).DataChanged = True Then
            If e.Column.Index = EnumGridDetail.Qty Or e.Column.Index = EnumGridDetail.LoadQty Or e.Column.Index = EnumGridDetail.TotalQty Then
                Dim IsMinus As Boolean = True
                IsMinus = getConfigValueByType("AllowMinusStock")

                'Dim QtyBefore As Double = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
                'Dim LoadQtyBefore As Double = Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value
                'Dim TotalQtyBefore As Double = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
                grd.UpdateData()
                Dim QtyAfter As Double = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
                Dim LoadQtyAfter As Double = Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value
                Dim TotalQtyAfter As Double = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
                Dim strserviceitem As String = "Select ServiceItem from ArticleDefView where ArticleId = " & Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value & ""
                Dim dt2serviceitem As DataTable = GetDataTable(strserviceitem)
                dt2serviceitem.AcceptChanges()
                Dim ServiceItem1 As Boolean = Val(dt2serviceitem.Rows(0).Item("ServiceItem").ToString)
                If ServiceItem1 = False Then
                    If IsMinus = False Then
                        AvailableStock = Convert.ToDouble(GetStockById(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value, Me.grd.GetRow.Cells(EnumGridDetail.LocationID).Value, Me.grd.GetRow.Cells(EnumGridDetail.Unit).Value.ToString))
                        If AvailableStock < 0 Or AvailableStock = 0 Then
                            If IsEditMode Then
                                If QtyAfter > QtyBefore Or LoadQtyAfter > LoadQtyBefore Or TotalQtyAfter > TotalQtyBefore Then
                                    ShowErrorMessage(" Larger quantity than stock is not allowed for item " & Me.grd.GetRow.Cells(EnumGridDetail.Item).Value.ToString & " ")
                                    Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = QtyBefore
                                    Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = LoadQtyBefore
                                    Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = TotalQtyBefore
                                End If
                            Else
                                ShowErrorMessage(" Larger quantity than stock is not allowed for item " & Me.grd.GetRow.Cells(EnumGridDetail.Item).Value.ToString & " ")
                                Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = QtyBefore
                                Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = LoadQtyBefore
                                Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = TotalQtyBefore
                            End If
                        ElseIf TotalQtyAfter > (AvailableStock + TotalQtyBefore) Then
                            ShowErrorMessage(" Larger quantity than stock is not allowed for item " & Me.grd.GetRow.Cells(EnumGridDetail.Item).Value.ToString & " ")
                            Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = QtyBefore
                            Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = LoadQtyBefore
                            Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = TotalQtyBefore
                        End If
                    End If
                End If
            End If
            QtyBefore = 0
            LoadQtyBefore = 0
            TotalQtyBefore = 0
            ValidateStock = True
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Function
    ''' <summary>
    ''' This Fucntion is Added to validate Stock By Batch No
    ''' </summary>
    ''' <param name="e"></param>
    ''' <returns></returns>
    ''' <remarks>Ayesha Rehman : TFS2739 : 02-04-2018</remarks>
    'Public Function ValidateStockByBatch(ByVal e As Janus.Windows.GridEX.ColumnActionEventArgs) As Boolean
    '    Try
    '        Dim QtyBefore1 As Double = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
    '        'If Me.grd.GetRow.Cells(EnumGridDetail.Qty).DataChanged = True Or Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).DataChanged = True Or Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).DataChanged = True Then
    '        If e.Column.Index = EnumGridDetail.Qty Or e.Column.Index = EnumGridDetail.LoadQty Or e.Column.Index = EnumGridDetail.TotalQty Or e.Column.Index = EnumGridDetail.BatchNo Then
    '            Dim IsMinus As Boolean = True
    '            IsMinus = getConfigValueByType("AllowMinusStock")

    '            'Dim QtyBefore As Double = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
    '            'Dim LoadQtyBefore As Double = Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value
    '            'Dim TotalQtyBefore As Double = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
    '            grd.UpdateData()
    '            Dim QtyAfter As Double = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
    '            Dim LoadQtyAfter As Double = Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value
    '            Dim TotalQtyAfter As Double = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value

    '            If IsMinus = False Then
    '                AvailableStock = Convert.ToDouble(GetStockByBatch(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value, Me.grd.GetRow.Cells(EnumGridDetail.LocationID).Value, Me.grd.GetRow.Cells(EnumGridDetail.Unit).Value.ToString, Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString))
    '                If AvailableStock < 0 Or AvailableStock = 0 Then
    '                    If IsEditMode Then
    '                        If QtyAfter > QtyBefore Or LoadQtyAfter > LoadQtyBefore Or TotalQtyAfter > TotalQtyBefore Then
    '                            ShowErrorMessage(" Larger quantity than stock is not allowed for item " & Me.grd.GetRow.Cells(EnumGridDetail.Item).Value.ToString & " ")
    '                            Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = QtyBefore
    '                            Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = LoadQtyBefore
    '                            Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = TotalQtyBefore
    '                        End If
    '                    Else
    '                        ShowErrorMessage(" Larger quantity than stock is not allowed for item " & Me.grd.GetRow.Cells(EnumGridDetail.Item).Value.ToString & " ")
    '                        Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = QtyBefore
    '                        Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = LoadQtyBefore
    '                        Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = TotalQtyBefore
    '                    End If
    '                ElseIf TotalQtyAfter > (AvailableStock + TotalQtyBefore) Then
    '                    ShowErrorMessage(" Larger quantity than stock is not allowed for item " & Me.grd.GetRow.Cells(EnumGridDetail.Item).Value.ToString & " ")
    '                    Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value = QtyBefore
    '                    Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value = LoadQtyBefore
    '                    Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value = TotalQtyBefore
    '                End If
    '            End If
    '        End If
    '        QtyBefore = 0
    '        LoadQtyBefore = 0
    '        TotalQtyBefore = 0
    '        ValidateStockByBatch = True
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Function


    Private Sub grd_CellValueChanged(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grd.CellValueChanged
        Try
            QtyBefore = Me.grd.GetRow.Cells(EnumGridDetail.Qty).Value
            LoadQtyBefore = Me.grd.GetRow.Cells(EnumGridDetail.LoadQty).Value
            TotalQtyBefore = Me.grd.GetRow.Cells(EnumGridDetail.TotalQty).Value
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtAdjustment_TextChanged(sender As Object, e As EventArgs) Handles txtAdjustment.TextChanged
        Try
            GetTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub cmbItem_AfterSortChange(sender As Object, e As Win.UltraWinGrid.BandEventArgs) Handles cmbItem.AfterSortChange
        '' This can work as well for our requirement. Succeeded on 16-03-2017

        Try
            'Dim SortedColums As Infragistics.Win.UltraWinGrid.SortedColumnsCollection = e.Band.SortedColumns
            'If SortedColums.Count > 0 Then
            '    If SortedColums.Exists("Combination") Then
            '        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells("Combination").Column.Key.ToString
            '    ElseIf SortedColums.Exists("Size") Then
            '        Me.cmbItem.DisplayMember = Me.cmbItem.Rows(0).Cells("Size").Column.Key.ToString
            '    End If
            'End If
            'If e.Band.SortedIndex Then


            'End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub cmbItem_InitializeLayout(sender As Object, e As Win.UltraWinGrid.InitializeLayoutEventArgs) Handles cmbItem.InitializeLayout
        Try
            Dim Layout As UltraGridLayout = e.Layout
            Dim ov As UltraGridOverride = Layout.Override
            ov.HeaderClickAction = HeaderClickAction.SortMulti
            ov.AllowRowFiltering = DefaultableBoolean.True
            'ov.FilterOperatorDefaultValue = FilterOperatorDefaultValue.Equals
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub cmbItem_MouseUp(sender As Object, e As MouseEventArgs) Handles cmbItem.MouseUp
        'Try
        '    Me.cmbItem.DisplayLayout.Bands(0).ColumnFilters.ClearAllFilters()
        'Catch ex As Exception
        '    ShowErrorMessage(ex.Message)
        'End Try
    End Sub
    Private Sub cmbItem_TextChanged(sender As Object, e As EventArgs) Handles cmbItem.TextChanged
        Try
            ' Ayesha Rehman : TFS1154 : Adding Trade and Retail price to their respective text boxes
            If cmbItem.ActiveRow IsNot Nothing Then
                Me.txtTradePrice.Text = Val(Me.cmbItem.ActiveRow.Cells("Trade Price").Value.ToString)
                Me.txtRetailPrice.Text = Val(Me.cmbItem.ActiveRow.Cells("Retail Price").Value.ToString)
                Me.cmbItem.DisplayLayout.Bands(0).ColumnFilters.ClearAllFilters()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Function GetSingle(ByVal SalesId As Integer) As DataTable
        Dim Str As String = ""
        Try
            Str = "SELECT Recv.SalesNo, Recv.SalesDate, Case When IsNull(DV.POID,0)=0 Then V.SalesOrderNo else SO_DL.SalesOrderNo End as SalesOrderNo,  Case When IsNull(DV.POID,0)=0 Then V.SalesOrderDate else SO_DL.SalesOrderDate End as SalesOrderDate, vwCOADetail.detail_title as CustomerName, Recv.SalesQty, Recv.SalesAmount, Recv.SalesId, Recv.Arrival_Time , Recv.Departure_Time,  " & _
                     "Recv.CustomerCode, tbldefEmployee.Employee_Name, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid, Recv.EmployeeCode, Recv.PoId, Recv.BiltyNo,isnull(Recv.TransporterId ,0) as TransporterId, Recv.LocationId, Recv.FuelExpense, Recv.OtherExpense, recv.Adjustment, IsNull(Recv.Invoice_Status,0) as Invoice_Status, isnull(recv.TransitInsurance,0) as TransitInsurance, IsNull(Recv.Post,0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end As Status, ISNULL(Recv.ServiceItemSale,0) as ServiceItemSale, Recv.DeliveryDate, ISNULL(Recv.Delivered,0) as Delivered, isnull(Recv.DeliveryChalanId, 0) as DeliveryId, DV.DeliveryNo, DV.DeliveryDate as [Dc Date], Recv.DcNo, isnull(Recv.Adj_Flag,0) as Adj_Flag, isnull(Recv.Adj_Percentage,0) as Adj_Percentage ,Isnull(Recv.CostCenterId,0) as CostCenterId, tblDefCostCenter.Name, Isnull(Recv.ManualInvoice,0) as ManualInvoice, Recv.InvoiceParty, ISNULL(Recv.CMFADocId,0) as CMFADocID, (CMFA.DocNo + '~' + Convert(varchar,Convert(varchar,CMFA.DocDate, 102))) as CMFADocNo, IsNull(Recv.DueDays,0) as DueDays, dbo.vwCOADetail.Contact_Email as Email, IsNull(Recv.InvoiceType,'Credit') as [Inv Type], Recv.Other_Company, Recv.Party_Mobile_No , Adjustment.InvoiceID,Recv.UserName as 'User Name', Recv.UpdateUserName, IsNull(tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID,0) as SalesTaxInvoiceStatus_ID, tblSalesTaxInvoiceStatus.SalesTaxInvoice_Status as [Invoice Status], IsNull(Recv.PreviousBalance,0) as PreviousBalance " & _
                     "FROM tblDefCostCenter Right Outer JOIN SalesMasterTable Recv ON tblDefCostCenter.CostCenterID=Recv.CostCenterId INNER JOIN " & _
                     "vwCOADetail ON Recv.CustomerCode = vwCOADetail.coa_detail_id LEFT OUTER JOIN " & _
                     "tblDefEmployee ON Recv.EmployeeCode = tblDefEmployee.Employee_Id LEFT OUTER JOIN " & _
                     "SalesOrderMasterTable V ON Recv.POId = V.SalesOrderId LEFT OUTER JOIN DeliveryChalanMasterTable DV ON DV.DeliveryId = Recv.DeliveryChalanId LEFT OUTER JOIN CMFAMasterTable CMFA ON CMFA.DocId = Recv.CMFADocID LEFT OUTER JOIN SalesOrderMasterTable SO_DL On SO_DL.SalesOrderId = DV.POId " & _
                     " left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Sales') as Adjustment on Recv.SalesId = Adjustment.InvoiceID  Left Outer Join tblSalesTaxInvoiceStatus on Recv.Invoice_Status = tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID   " & _
                     " where Recv.SalesNo <> '' And Recv.SalesId = " & SalesId & ""
            Dim dt As DataTable = GetDataTable(Str)
            Return dt
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub btnJobCard_Click(sender As Object, e As EventArgs) Handles btnJobCard.Click
        Try
            'Ali Faisal : TFS1606 : Apply SalesCompanyId to get records from job cards of that company
            SalesCompanyId = Me.cmbCompany.SelectedValue
            Dim frmJobCards As New frmLoadJobCards
            frmJobCards.IsSales = True
            frmJobCards.ShowDialog()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Function GetJobCard(ByVal JobCardId As Integer) As DataTable
        Dim dtJobCard As DataTable
        Try
            '12-Huly-2017: Task # TFS1042: Waqar Raza: Query Modified to add MODELID and filter item on basis of this MODELID. 
            Dim strJobCard As String = " SELECT Card.JobCardID, Card.JobCardNo, Card.JobCardDate, tblVehicleInfo.RegistrationNo, Card.LiftID, tblDefCostCenter.Name AS LiftName, tblDefModelList.Name As Model, ArticleColorDefTable.ArticleColorName As Color, tblVehicleInfo.EngineNo, tblVehicleInfo.ChessisNo, tblVehicleInfo.DOP, " _
           & " tblCompanyContacts.ContactName, TblCompanyContacts.Mobile, Card.Remarks, TblCompanyContacts.Address, tblDefModelList.ModelId " _
           & " FROM tblJobCard AS Card INNER JOIN " _
           & " tblVehicleInfo ON Card.VehicleID = tblVehicleInfo.VahicleID INNER JOIN " _
           & " tblCompanyContacts ON tblVehicleInfo.CompanyContactID = TblCompanyContacts.PK_Id LEFT JOIN " _
           & " tblDefModelList ON tblVehicleInfo.ModelID = tblDefModelList.ModelId LEFT JOIN " _
           & " ArticleColorDefTable ON tblVehicleInfo.ColorID = ArticleColorDefTable.ArticleColorId LEFT OUTER JOIN " _
           & " tblDefCostCenter ON Card.LiftID = tblDefCostCenter.CostCenterID Where JobCardId =" & JobCardId & " "
            dtJobCard = GetDataTable(strJobCard)
            If dtJobCard.Rows.Count > 0 Then
                Me.txtJobCardId.Text = Val(dtJobCard.Rows(0).Item("JobCardID").ToString)
                Me.txtJobCardNo.Text = dtJobCard.Rows(0).Item("JobCardNo").ToString
                Me.dtpJobCardDate.Value = dtJobCard.Rows(0).Item("JobCardDate")
                Me.cmbLift.Value = Val(dtJobCard.Rows(0).Item("LiftID").ToString)
                'Me.txtLeft.Text = dtJobCard.Rows(0).Item("LiftName").ToString
                Me.txtJobCardCustomer.Text = dtJobCard.Rows(0).Item("ContactName").ToString
                Me.txtVehicle.Text = dtJobCard.Rows(0).Item("Model").ToString
                Me.txtRegistrationNo.Text = dtJobCard.Rows(0).Item("RegistrationNo").ToString
                'Added by Waqar where assinging the value of ModelId retrived from database 
                ModelId = Val(dtJobCard.Rows(0).Item("ModelId").ToString)
            End If
            Return dtJobCard
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    '29-Jun-2017: Task # 975: Waqar Raza: Remove because this functionality is handled in print 
    'Private Sub PrintJobCardToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles PrintJobCardToolStripMenuItem.Click
    'Private Sub PrintJobCardToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles PrintJobCardToolStripMenuItem.Click
    '        AddRptParam("@JobCardId ", Val(Me.txtJobCardId.Text))
    '        ShowReport("rptJobCardInvoice")
    '        ShowReport("rptJobCardInvoice")
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub

    '04-07-2017: Task # 943: Waqar Raza: Removed at the time of rollback
    Private Sub frmSales_KeyDown(sender As Object, e As KeyEventArgs) Handles MyBase.KeyDown
        Try
            If e.KeyCode = Keys.J And e.Alt Then
                'Ali Faisal : TFS1606 : Apply SalesCompanyId to get records from job cards of that company
                SalesCompanyId = Me.cmbCompany.SelectedValue
                Dim frmJobCards As New frmLoadJobCards
                frmJobCards.IsSales = True
                frmJobCards.ShowDialog()
            End If
            If e.KeyCode = Keys.Escape Then
                NewToolStripButton_Click(Nothing, Nothing)
                Exit Sub
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try

    End Sub
    Private Sub cmbLift_EditorButtonClick(sender As Object, e As UltraWinEditors.EditorButtonEventArgs) Handles cmbLift.EditorButtonClick
        Try
            If Me.gbJobCard.Visible = True Then
                ModelListDAL.SetCostCentreOnListAssociation(Me.cmbLift.Value, Val(Me.txtJobCardId.Text))
                msg_Information("Lift has been associated successfully.")
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub btnLiftAssociation_Click(sender As Object, e As EventArgs) Handles btnLiftAssociation.Click
        If Me.gbJobCard.Visible = True Then
            ModelListDAL.SetCostCentreOnListAssociation(Me.cmbLift.Value, Val(Me.txtJobCardId.Text))
            msg_Information("Lift has been associated successfully.")
        End If
    End Sub
    Private Sub SendConfiguredNotification(ByVal DocNo As String, ByVal SalesId As Integer, ByVal RowCount As Integer)
        Try
            ''TASK:945
            ' *** New Segment *** By Muhammad Ameen *** 16-Jun-2017 ***
            '// Adding notification

            '// Creating new object of Notification configuration dal
            '// Dal will be used to get users list for the notification 
            Dim NDal As New NotificationConfigurationDAL

            '// Creating new object of Agrius Notification class
            Dim Notification As New AgriusNotifications

            '// Reference document number
            Notification.ApplicationReference = SalesId

            '// Date of notification
            Notification.NotificationDate = Now

            '// Preparing notification title string
            Notification.NotificationTitle = "New Sales [" & DocNo & "]  is added with " & RowCount & " items."

            '// Preparing notification description string
            Notification.NotificationDescription = "New Sales  [" & DocNo & "] is added by user " & LoginUser.LoginUserName & " on " & Date.Now.ToString("dd-MMM-yyy hh:mm:ss")

            '// Setting source application as refrence in the notification
            Notification.SourceApplication = "Sales "



            '// Starting to get users list to add child

            '// Creating notification detail object list
            Dim List As New List(Of NotificationDetail)

            '// Getting users list
            List = NDal.GetNotificationUsers("Sales Created")

            ''TASK:957 Added role based notifications
            Dim RolesList As List(Of String) = NDal.GetNotificationRoles1("Sales Created")
            If RolesList.Count > 0 Then
                If Not Me.cmbDeliveryChalan.SelectedValue Is Nothing Then
                    If Me.cmbDeliveryChalan.SelectedValue > 0 Then
                        If RolesList.Contains("Delivery Chalan Created By") Then
                            Dim objDetail As New NotificationDetail
                            objDetail.NotificationUser = New SecurityUser(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("UserId").ToString))
                            List.Add(objDetail)
                        End If
                    End If
                End If
                If Not Me.cmbPo.SelectedValue Is Nothing Then
                    If Me.cmbPo.SelectedValue > 0 Then
                        If RolesList.Contains("Sales Order Created By") Then
                            Dim objDetail As New NotificationDetail
                            objDetail.NotificationUser = New SecurityUser(Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("UserId").ToString))
                            List.Add(objDetail)
                        End If
                    End If
                End If
            End If

            ''End TASK:957


            '// Adding users list in the Notification object of current inquiry
            Notification.NotificationDetils.AddRange(List)

            '// Getting and adding user groups list in the Notification object of current inquiry
            Notification.NotificationDetils.AddRange(NDal.GetNotificationGroups("Sales Created"))

            '// Not getting role list because no role is associated at the moment
            '// We will need this in future and we can use it later
            '// We can consult to Update function of this class


            '// ***This segment will be used to save notification in database table

            '// Creating new list of objects of Agrius Notification
            Dim NList As New List(Of AgriusNotifications)

            '// Copying notification object from current sales inquiry to newly defined instance
            '// Reason to copy here is that while saving record we need list of Notification object but we have only one object of Agrius Notification
            NList.Add(Notification)

            '// Creating object of Notification DAL
            Dim GNotification As New NotificationDAL

            '// Saving notification to database
            GNotification.AddNotification(NList)

            '// End Adding Notification

            '// End Adding Notification
            ' *** End Segment ***

        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Private Sub SendConfiguredNotificationOnUpdate(ByVal DocNo As String, ByVal SalesId As Integer, ByVal RowCount As Integer)
        Try
            ''TASK:945
            ' *** New Segment *** By Muhammad Ameen *** 16-Jun-2017 ***
            '// Adding notification

            '// Creating new object of Notification configuration dal
            '// Dal will be used to get users list for the notification 
            Dim NDal As New NotificationConfigurationDAL

            '// Creating new object of Agrius Notification class
            Dim Notification As New AgriusNotifications

            '// Reference document number
            Notification.ApplicationReference = SalesId

            '// Date of notification
            Notification.NotificationDate = Now

            '// Preparing notification title string
            Notification.NotificationTitle = "Sales [" & DocNo & "]  is updated with " & RowCount & " items."

            '// Preparing notification description string
            Notification.NotificationDescription = "Sales  [" & DocNo & "] is updated by user " & LoginUser.LoginUserName & " on " & Date.Now.ToString("dd-MMM-yyy hh:mm:ss")

            '// Setting source application as refrence in the notification
            Notification.SourceApplication = "Sales "



            '// Starting to get users list to add child

            '// Creating notification detail object list
            Dim List As New List(Of NotificationDetail)

            '// Getting users list
            List = NDal.GetNotificationUsers("Sales Updated")

            ''TASK:957 Added role based notifications
            Dim RolesList As List(Of String) = NDal.GetNotificationRoles1("Sales Updated")
            If RolesList.Count > 0 Then
                If Not Me.cmbDeliveryChalan.SelectedValue Is Nothing Then
                    If Me.cmbDeliveryChalan.SelectedValue > 0 Then
                        If RolesList.Contains("Delivery Chalan Updated By") Then
                            Dim objDetail As New NotificationDetail
                            objDetail.NotificationUser = New SecurityUser(Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("UserId").ToString))
                            List.Add(objDetail)
                        End If
                    End If
                End If
                If Not Me.cmbPo.SelectedValue Is Nothing Then
                    If Me.cmbPo.SelectedValue > 0 Then
                        If RolesList.Contains("Sales Order Updated By") Then
                            Dim objDetail As New NotificationDetail
                            objDetail.NotificationUser = New SecurityUser(Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("UserId").ToString))
                            List.Add(objDetail)
                        End If
                    End If
                End If
            End If

            ''End TASK:957


            '// Adding users list in the Notification object of current inquiry
            Notification.NotificationDetils.AddRange(List)

            '// Getting and adding user groups list in the Notification object of current inquiry
            Notification.NotificationDetils.AddRange(NDal.GetNotificationGroups("Sales Updated"))

            '// Not getting role list because no role is associated at the moment
            '// We will need this in future and we can use it later
            '// We can consult to Update function of this class


            '// ***This segment will be used to save notification in database table

            '// Creating new list of objects of Agrius Notification
            Dim NList As New List(Of AgriusNotifications)

            '// Copying notification object from current sales inquiry to newly defined instance
            '// Reason to copy here is that while saving record we need list of Notification object but we have only one object of Agrius Notification
            NList.Add(Notification)

            '// Creating object of Notification DAL
            Dim GNotification As New NotificationDAL

            '// Saving notification to database
            GNotification.AddNotification(NList)

            '// End Adding Notification

            '// End Adding Notification
            ' *** End Segment ***

        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    ''' <summary>
    ''' Added by Waqar to check if paymentstatus in jobcard on specific ID//Task # 943
    ''' </summary>
    ''' <param name="jobcardid"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function getpaymentstatus(ByVal jobcardid As Integer) As Boolean
        Try
            Dim ar As Boolean = False
            Dim str As String = "select ISNULL(PaymentStatus, 0) As PaymentStatus from tbljobcard where JobCardId =" & jobcardid & ""
            Dim dt As DataTable = GetDataTable(str)
            If dt.Rows.Count > 0 Then
                ar = dt.Rows(0).Item("PaymentStatus")
            End If
            Return ar
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    '12-July-2017: Task # TFS1042: Waqar Raza: To get the saved invoice against unpaid jobcardID.
    ''' <summary>
    ''' Function to check the value of JobCardId from each Row of grid and assign this value to current row and apply to edit record to get the saved sale invoice against that JobCardId.
    ''' </summary>
    ''' <param name="jobcardid"></param>

    ''' <remarks></remarks>
    Public Sub jobcarddetail(ByVal jobcardid As Integer)
        Try
            If grdSaved.RowCount <= 150 Then
                For Each row As Janus.Windows.GridEX.GridEXRow In grdSaved.GetRows
                    If row.Cells("JobCardId").Value = jobcardid Then
                        Me.grdSaved.Row = row.RowIndex
                        EditRecord()
                        Exit Sub
                    End If
                Next
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    ''' <summary>
    ''' Print voucher against selected document.
    ''' </summary>
    ''' <param name="sender"></param>
    ''' <param name="e"></param>
    ''' <remarks> TASK:TFS1077  Build central  function to print voucher from any transaction screen. Done by Ameen</remarks>
    Private Sub PrintVoucherToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles PrintVoucherToolStripMenuItem.Click
        Try
            GetVoucherPrint(Me.grdSaved.CurrentRow.Cells("SalesNo").Value.ToString, Me.Name, BaseCurrencyName, BaseCurrencyId)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''END TASK:TFS1077

    Private Sub PrintVoucherToolStripMenuItem1_Click(sender As Object, e As EventArgs) Handles PrintVoucherToolStripMenuItem1.Click
        Try
            GetVoucherPrint(Me.grdSaved.CurrentRow.Cells("SalesNo").Value.ToString, Me.Name, BaseCurrencyName, BaseCurrencyId)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''' <summary>
    ''' 'Ali Faisal : TFS1362 : 22-Aug-2017 : Fill Dropdown for selected row to get engine / chassis number for selected item
    ''' </summary>
    ''' <param name="sender"></param>
    ''' <param name="e"></param>
    ''' <remarks>'Ali Faisal : TFS1362 : 22-Aug-2017</remarks>
    Private Sub grd_Click(sender As Object, e As EventArgs) Handles grd.Click
        Try
            If Me.grd.RowCount > 0 AndAlso Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value IsNot Nothing Then

                If flgVehicleIdentificationInfo = True Then
                    Dim str1 As String
                    str1 = "SELECT Engine_No, Chassis_No, Sum(InQty) InQty, Sum(OutQty) OutQty, Sum(InQty)-Sum(OutQty) Qty FROM StockDetailTable WHERE Engine_No <> '' And ArticleDefId = " & Val(Me.grd.GetRow.Cells("ArticleDefId").Value.ToString) & " GROUP BY Engine_No, Chassis_No HAVING Sum(InQty)-Sum(OutQty) > 0"
                    Dim dt2 As DataTable = GetDataTable(str1)
                    If dt2.Rows.Count > 0 Then
                        If Val(grd.GetRow.Cells("TotalQty").Value) > dt2.Rows(0).Item("Qty") Then
                            ShowErrorMessage("This Qty not exists in Stock ")
                            grd.CancelCurrentEdit()
                            Exit Sub
                        End If
                    End If
                End If

                Dim Str As String = ""
                ''Query Edit Against TFS3528 : Ayesha Rehman
                Str = "SELECT Engine_No, Chassis_No, Sum(InQty) InQty, Sum(OutQty) OutQty, Sum(InQty)-Sum(OutQty) Qty FROM StockDetailTable WHERE Engine_No <> '' And ArticleDefId = " & Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString) & " GROUP BY Engine_No, Chassis_No HAVING Sum(InQty)-Sum(OutQty) > 0"
                Dim dt As DataTable = GetDataTable(Str)
                Me.grd.RootTable.Columns("Engine_No").ValueList.PopulateValueList(dt.DefaultView, "Engine_No", "Engine_No")
                Str = "SELECT Engine_No, Chassis_No, Sum(InQty) InQty, Sum(OutQty) OutQty, Sum(InQty)-Sum(OutQty) Qty FROM StockDetailTable WHERE Engine_No <> '' And ArticleDefId = " & Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString) & " GROUP BY Engine_No, Chassis_No HAVING Sum(InQty)-Sum(OutQty) > 0"
                Dim dt1 As DataTable = GetDataTable(Str)
                Me.grd.RootTable.Columns("Chassis_No").ValueList.PopulateValueList(dt1.DefaultView, "Chassis_No", "Chassis_No")

                'Str = "SELECT BatchNo, BatchNo FROM StockDetailTable WHERE IsNull(BatchNo, '') <> '' And ArticleDefId = " & Val(Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value.ToString) & " ORDER BY ExpiryDate"
                'Dim dt3 As DataTable = GetDataTable(Str)
                'Me.grd.RootTable.Columns("Batch No").ValueList.PopulateValueList(dt3.DefaultView, "BatchNo", "BatchNo")
            End If

            Dim StockOutConfigration As String = "" ''4181
            ''Start Task 1596
            If Not getConfigValueByType("StockOutConfigration").ToString = "Error" Then ''1596
                StockOutConfigration = getConfigValueByType("StockOutConfigration").ToString
            End If

            If Not StockOutConfigration.Equals("Disabled") Then
                If Me.grd.RowCount > 0 AndAlso Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value IsNot Nothing Then
                    Dim str As String = ""
                    str = " Select  BatchNo,BatchNo,ExpiryDate,Origin  From  StockDetailTable  where BatchNo not in ('','0','xxxx')  And ArticledefId = " & Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value & "  And LocationId = " & Val(Me.grd.GetRow.Cells(EnumGridDetail.LocationID).Value.ToString) & " Group by BatchNo,ExpiryDate,Origin Having Sum(isnull(InQty, 0)) - Sum(isnull(OutQty, 0)) > 0  ORDER BY ExpiryDate Asc"
                    Dim dt As DataTable = GetDataTable(str)
                    Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).ValueList.PopulateValueList(dt.DefaultView, "BatchNo", "BatchNo")
                    If Not dt.Rows.Count > 0 Then
                        grd.GetRow.Cells(EnumGridDetail.BatchNo).Value = "xxxx"
                    Else
                        If IsDBNull(grd.GetRow.Cells(EnumGridDetail.BatchNo).Value) Or grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString = "" Then
                            grd.GetRow.Cells(EnumGridDetail.BatchNo).Value = dt.Rows(0).Item("BatchNo").ToString
                        End If
                    End If
                    If dt.Rows.Count > 0 Then
                        If Not IsDBNull(dt.Rows(0).Item("BatchNo").ToString) Then
                            str = " Select   ExpiryDate, Origin  From  StockDetailTable  where BatchNo not in ('','0','xxxx') And BatchNo ='" & Me.grd.GetRow.Cells(EnumGridDetail.BatchNo).Value.ToString & "'" _
                                 & " And ArticledefId = " & Me.grd.GetRow.Cells(EnumGridDetail.ArticleID).Value & "  And LocationId = " & Val(Me.grd.GetRow.Cells(EnumGridDetail.LocationID).Value.ToString) & "  And (isnull(InQty, 0) - isnull(OutQty, 0)) > 0 Group by BatchNo,ExpiryDate,Origin ORDER BY ExpiryDate  Asc "
                            Dim dtExpiry As DataTable = GetDataTable(str)
                            If dtExpiry.Rows.Count > 0 Then
                                If IsDBNull(dtExpiry.Rows(0).Item("ExpiryDate")) = False Then
                                    grd.GetRow.Cells(EnumGridDetail.ExpiryDate).Value = CType(dtExpiry.Rows(0).Item("ExpiryDate").ToString, Date)
                                    grd.GetRow.Cells("Origin").Value = dtExpiry.Rows(0).Item("Origin").ToString
                                End If
                            End If
                        End If
                    End If
                End If
            End If

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub grdOutwardExpDetail_CellEdited(sender As Object, e As Janus.Windows.GridEX.ColumnActionEventArgs) Handles grdOutwardExpDetail.CellEdited
        Try
            If Me.grdOutwardExpDetail.GetRow.RowType = Janus.Windows.GridEX.RowType.Record Then
                '' TASK TFS1495 ON 25-09-2017
                Me.grdOutwardExpDetail.UpdateData()
                GetTotal()
                ''END TASK TFS1495
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub cmbItem_KeyDown(sender As Object, e As KeyEventArgs) Handles cmbItem.KeyDown
        Try
            ''TFS1858 : Ayesha Rehman :Item dropdown shall be searchable
            If e.KeyCode = Keys.F1 Then
                If flgCompanyRights = True Then
                    frmItemSearch.CompanyId = MyCompanyId
                End If
                If getConfigValueByType("ArticleFilterByLocation") = "True" Then
                    If GetRestrictedItemFlg(Me.cmbCategory.SelectedValue) = True Then
                        frmItemSearch.LocationId = Me.cmbCategory.SelectedValue
                    Else
                        frmItemSearch.LocationId = 0
                    End If
                End If
                If ModelId > 0 Then
                    'If GetRestrictedItemFlg(Me.cmbCategory.SelectedValue) = True Then
                    frmItemSearch.ModelId = ModelId

                    'End If
                End If
                If Me.rbtCustomer.Checked = True Then
                    If Me.cmbVendor.ActiveRow Is Nothing Then Exit Sub
                    frmItemSearch.VendorId = Me.cmbVendor.Value
                End If
                frmItemSearch.formName = "" ''TFS3332
                frmItemSearch.BringToFront()
                frmItemSearch.ShowDialog()
                If frmItemSearch.DialogResult = Windows.Forms.DialogResult.OK Then
                    cmbItem.Value = frmItemSearch.ArticleId
                    txtQty.Text = frmItemSearch.Qty
                End If
            End If
            If e.KeyCode = Keys.Enter Or e.KeyCode = Keys.Tab Then
                'Dim Row As Infragistics.Win.UltraWinGrid.UltraGridRow = Me.cmbProduct.GetRow(Win.UltraWinGrid.ChildRow.First).Cells("Qty").Value
                If Me.cmbItem.IsItemInList = False Then Exit Sub
                If Me.cmbItem.Value > 0 AndAlso IsKeyDownCalled = False Then
                    KeyDownPrice = Val(Me.cmbItem.ActiveRow.Cells("Price").Value.ToString)
                    KeyDownArticleId = Val(Me.cmbItem.ActiveRow.Cells("Id").Value.ToString)
                    KeyDownArticleCode = Me.cmbItem.ActiveRow.Cells("Code").Value.ToString
                    Dim Model As String = Me.cmbItem.ActiveRow.Cells("Model").Value.ToString
                    IsKeyDownCalled = True
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub cmbItem_AfterDropDown(sender As Object, e As EventArgs) Handles cmbItem.AfterDropDown
        Try
            IsKeyDownCalled = False
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Public Sub New()
        ' This call is required by the designer.
        InitializeComponent()
        ' Add any initialization after the InitializeComponent() call.

    End Sub


    Private Sub txtDisc_Leave(sender As Object, e As EventArgs) Handles txtDisc.Leave
        Try
            If cmbDiscountType.Text = DiscountType_Percentage Then
                If Not Val(txtDisc.Text) >= 0 AndAlso Val(txtDisc.Text) <= 100 Then
                    ShowErrorMessage("Enter value according to the discount Type")
                    txtDisc.SelectAll()
                    Me.txtDisc.Focus()
                End If

            ElseIf cmbDiscountType.Text = DiscountType_Flat Then
                If Not (Val(txtDisc.Text) >= 0 AndAlso Val(txtDisc.Text) <= Val(txtPDP.Text)) Then
                    ShowErrorMessage("Enter value according to the discount Type")
                    txtDisc.SelectAll()
                    Me.txtDisc.Focus()
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ' TFS1153 Events added for calculation
    Private Sub cmbDiscountType_Leave(sender As Object, e As EventArgs) Handles cmbDiscountType.Leave
        Try
            'TFS1153
            DiscountCalculation()
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtDisc_LostFocus(sender As Object, e As EventArgs) Handles txtDisc.LostFocus

        Try
            'TFS1153
            DiscountCalculation()
            GetDetailTotal()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    'Private Sub cmbDiscountType_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbDiscountType.SelectedIndexChanged
    '    Try
    '        'TFS1153
    '        GetDetailTotal()
    '        DiscountCalculation()
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try

    'End Sub
    Private Sub txtComPercentage_TextChanged(sender As Object, e As EventArgs) Handles txtComPercentage.TextChanged
        Try
            If Val(txtComPercentage.Text) > 100 Then
                ShowErrorMessage("Comission Percentage Should be less then 100")
                txtComPercentage.Text = "100"
                txtComPercentage.Focus()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Private Sub txtComPercentage_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtComPercentage.KeyPress
        Try
            NumValidation(sender, e)
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''TFS1153 : Ayesha Rehman: 14-12-2017: Added for Allowing the user to enter a value in the PostDiscountPrice and the value of Rate is Changed accordingly
    Private Sub txtPDP_Leave(sender As Object, e As EventArgs) Handles txtPDP.Leave
        Try
            txtRate.Text = Val(txtPDP.Text)

        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''' <summary>
    ''' 'TASK TFS1803
    ''' </summary>
    ''' <param name="str"></param>
    ''' <returns></returns>
    ''' <remarks>This function is created against TASK TFS1803 to get leading zeros</remarks>
    Private Function GetLeadingZerosLength(ByVal str As String) As String
        Try
            Dim Zeros As String = String.Empty
            For Each c As Char In str
                If c = "0"c Then
                    Zeros += "0"
                    'Else
                    '    Exit For
                End If
            Next
            Return Zeros
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    ''' <summary>
    ''' TASK TFS1777
    ''' </summary>
    ''' <param name="sender"></param>
    ''' <param name="e"></param>
    ''' <remarks></remarks>
    'Private Sub lnkRelatedItems_LinkClicked(sender As Object, e As LinkLabelLinkClickedEventArgs) Handles lnkRelatedItems.LinkClicked
    '    Try
    '        Dim frmname As String = Me.Text
    '        If Not Me.cmbItem.ActiveRow Is Nothing Then
    '            If Val(Me.cmbItem.ActiveRow.Cells("MasterId").Value.ToString) > 0 Then
    '                Dim frmRelItems As New frmRelatedItems(Val(Me.cmbItem.ActiveRow.Cells("MasterId").Value.ToString), frmname)
    '                frmRelItems.ShowDialog()
    '            End If
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub

    
  

    'Private Sub txtTotal_TextChanged(sender As Object, e As EventArgs) Handles txtTotal.TextChanged
    '    Try
    '        If Me.txtPDP.Text = 0 Then
    '            Me.txtPDP.Text = txtTotal.Text / Me.txtTotalQuantity.Text
    '        End If
    '    Catch ex As Exception
    '        ShowErrorMessage(ex.Message)
    '    End Try
    'End Sub

    Private Sub richTxtInternalRemarks_KeyDown(sender As Object, e As KeyEventArgs) Handles richTxtInternalRemarks.KeyDown
        Try
            'F1 will show a new popup window where user can enter remarks 
            If e.KeyCode = Keys.F1 Then
                frmShowSalesRichtext.richTextBox.Rtf = Me.richTxtInternalRemarks.Rtf

                frmShowSalesRichtext.ShowDialog()
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub


    Private Sub txtPDP_TextChanged(sender As Object, e As EventArgs) Handles txtPDP.TextChanged
        Try
            txtRate.Text = Val(txtPDP.Text)
            DiscountCalculation()  ''TFS3330
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub txtTotal_TextChanged(sender As Object, e As EventArgs) Handles txtTotal.TextChanged
        ''The Code Below is Commented Against TFS3330 , Bcz total->textchanged called when rate changes
        'Try
        '    '' Below lines are added against TASK TFS2623
        '    If Me.cmbUnit.Text = "Pack" Then
        '        If Val(Me.txtTotal.Text) > 0 AndAlso Val(Me.txtTotalQuantity.Text) > 0 Then
        '            Me.txtPDP.Text = Val(Me.txtTotal.Text) / Val(Me.txtTotalQuantity.Text)
        '        End If
        '    End If
        'Catch ex As Exception
        '    ShowErrorMessage(ex.Message)
        'End Try
    End Sub

    Private Sub txtPackRate_Leave(sender As Object, e As EventArgs) Handles txtPackRate.Leave
        'Try
        '    If Val(Me.txtPackRate.Text) > 0 Then
        '        If getConfigValueByType("Apply40KgRate").ToString = "True" AndAlso Me.cmbUnit.Text <> "Loose" Then
        '            Me.txtPDP.Text = Math.Round((Val(Me.txtPackRate.Text) / 40), TotalAmountRounding)
        '            Me.txtPDP.Enabled = False
        '        ElseIf Me.cmbUnit.Text <> "Loose" Then
        '            Me.txtPDP.Text = Math.Round((Val(Me.txtPackRate.Text) / Val(Me.txtPackQty.Text)), TotalAmountRounding)
        '            Me.txtPDP.Enabled = False
        '        End If
        '    Else
        '        Me.txtPDP.Enabled = True
        '    End If
        'Catch ex As Exception
        '    ShowErrorMessage(ex.Message)
        'End Try
    End Sub

    ''' <summary>
    ''' This function is added to get Cost Price w.r.t Batch No
    ''' </summary>
    ''' <param name="ItemId"></param>
    ''' <param name="BatchNo"></param>
    ''' <returns></returns>
    ''' <remarks>Ayesha Rehman : TFS2739 : Lot wise rate for costing on Dispatch</remarks>
    Public Function GetItemRateByBatch(ByVal ItemId As Integer, ByVal BatchNo As String) As Double

        Dim str As String = ""
        Dim dt As DataTable
        Try
            str = "Select Rate From  StockDetailTable  where BatchNo  <> '' "
            str += " And ArticledefId=" & ItemId & " And BatchNo = '" & BatchNo & " ' ORDER BY StockTransDetailId Desc"
            dt = GetDataTable(str)
            dt.AcceptChanges()
            If dt.Rows.Count > 0 Then
                Return Convert.ToDouble(dt.Rows(0).Item("Rate").ToString)
            Else
                Return 0
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Private Sub btnLoadSOAndDC_Click(sender As Object, e As EventArgs) Handles btnLoadSOAndDC.Click
        Try
            Dim frmSOAndDC As New frmSOPopup(CType(Me.grd.DataSource, DataTable), , False)
            frmSOAndDC.ShowDialog()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Public Sub LoadFromPopup(ByVal dt As DataTable, ByVal CustomerId As Integer, ByVal SalesOrderId As Integer, ByVal DeliveryChalanId As Integer)
        Dim str As String = String.Empty
        Dim i As Integer = 0
        Dim dtBaseSource As DataTable = CType(grd.DataSource, DataTable)
        IsSOSeparateClosure = True
        Me.cmbVendor.Value = CustomerId
        Me.cmbPo.SelectedValue = SalesOrderId
        Me.cmbDeliveryChalan.SelectedValue = DeliveryChalanId
        ''Start TFS4339
        'rafay
        If DeliveryChalanId = 0 Then
            Me.cmbSalesMan.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("SOP_ID").ToString)
            Me.cmbTransporter.SelectedValue = Val(CType(Me.cmbPo.SelectedItem, DataRowView).Item("TransporterId").ToString)
            Me.txtPO.Text = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("PO_NO").ToString
        Else
            Me.cmbSalesMan.SelectedValue = Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("EmployeeCode").ToString)
            Me.cmbTransporter.SelectedValue = Val(CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("TransporterId").ToString)
            Me.txtPO.Text = CType(Me.cmbDeliveryChalan.SelectedItem, DataRowView).Item("PO_NO").ToString
        End If
        ''End TFS4339
        'Dim dt As DataTable = Rows.AsEnumerable().ToList()
        'Me.grd.DataSource = dt
        ''Start TFS4802 : Load Multi DC
        Dim ii As Integer = 0
        If DeliveryChalanId = 0 Then
            If flgMultipleSalesOrder = True Then
                If grd.RowCount > 0 Then
                    For ii = 0 To grd.RowCount - 1
                        'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
                        If Me.cmbPo.SelectedValue = Val(grd.GetRows(ii).Cells(EnumGridDetail.SO_ID).Value.ToString) Then
                            'msg_Error("This SO has been already loaded.")
                            Exit Sub
                        End If
                    Next
                    dt.Merge(dtBaseSource)
                    Me.grd.DataSource = dt
                Else
                    Me.grd.DataSource = dt
                End If
            Else
                If grd.RowCount > 0 Then
                    For ii = 0 To grd.RowCount - 1
                        'Ali Faisal : UDL : Changes for Reports and other for UDL on 14-16 Nov 2018.
                        If Me.cmbPo.SelectedValue = Val(grd.GetRows(ii).Cells(EnumGridDetail.SO_ID).Value.ToString) Then
                            'msg_Error("This SO has been already loaded.")
                            Exit Sub
                        End If
                    Next
                    Me.grd.DataSource = dt
                Else
                    Me.grd.DataSource = dt
                End If
            End If
        Else
            Dim blnLoadMultiChalan As Boolean = False
            Boolean.TryParse(getConfigValueByType("LoadMultiChalanOnSale"), blnLoadMultiChalan)
            If blnLoadMultiChalan = True Then
                If grd.RowCount > 0 Then
                    For ii = 0 To grd.RowCount - 1
                        If Me.cmbDeliveryChalan.SelectedValue = Val(grd.GetRows(ii).Cells(EnumGridDetail.DeliveryChalanId).Value.ToString) Then
                            Exit Sub
                        End If
                    Next
                    dt.Merge(dtBaseSource)
                    Me.grd.DataSource = dt
                Else
                    Me.grd.DataSource = dt
                End If
            Else
                If grd.RowCount > 0 Then
                    For ii = 0 To grd.RowCount - 1
                        If Me.cmbDeliveryChalan.SelectedValue = Val(grd.GetRows(ii).Cells(EnumGridDetail.DeliveryChalanId).Value.ToString) Then
                            Exit Sub
                        End If
                    Next
                    'dt.Merge(dtBaseSource)
                    Me.grd.DataSource = dt
                Else
                    Me.grd.DataSource = dt
                End If
            End If
        End If
        ''End TFS4802
       
        If dt.Rows.Count > 0 Then
            IsSOLoaded = True
            For Each _Row As DataRow In dt.Rows
                ''TASK TFS3781
                'If DT.Rows.Count > 0 Then
                If IsDBNull(_Row.Item("CurrencyId")) Or Val(_Row.Item("CurrencyId").ToString) = 0 Then
                    'Me.cmbCurrency.SelectedValue = Nothing
                    Me.cmbCurrency.Enabled = False
                Else
                    'IsCurrencyEdit = True
                    'IsNotCurrencyRateToAll = True
                    FillCombo("Currency")
                    Me.CurrencyRate = Val(_Row.Item("CurrencyRate").ToString)
                    Me.txtCurrencyRate.Text = Me.CurrencyRate

                    Me.cmbCurrency.SelectedValue = Val(_Row.Item("CurrencyId").ToString)
                    Me.cmbCurrency.Enabled = False
                End If
                'cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
                'End If
            Next
        End If
        ' '' TASKT TFS3781
        'If dt.Rows.Count > 0 Then
        '    If IsDBNull(dt.Rows.Item(0).Item("CurrencyId")) Or Val(dt.Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
        '        'Me.cmbCurrency.SelectedValue = Nothing
        '        Me.cmbCurrency.Enabled = False
        '    Else
        '        Me.CurrencyRate = Val(dt.Rows.Item(0).Item("CurrencyRate").ToString)
        '        Me.cmbCurrency.SelectedValue = Val(dt.Rows.Item(0).Item("CurrencyId").ToString)
        '        Me.cmbCurrency.Enabled = False
        '    End If
        '    cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
        '    CurrencyRate = 1
        'End If
        ' '' END TASK TFS3781




        Me.grd.RetrieveStructure()
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Caption = "Challan"
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.LocationID).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns("So_Id").HasValueList = True
        Me.grd.RootTable.Columns("So_Id").LimitToList = True
        Me.grd.RootTable.Columns("So_Id").EditType = Janus.Windows.GridEX.EditType.Combo
        'Ali Faisal : TFS1362 : 22-Aug-2017 : Change column type from text to dropdown
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).LimitToList = False
        Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).LimitToList = False
        Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).EditType = Janus.Windows.GridEX.EditType.Combo
        'Ayesha Rehman: TFS1153 : 23-Nov-2017 : Change column from text to drop down
        'Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).HasValueList = True
        'Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).LimitToList = True
        'Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).LimitToList = True
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).EditType = Janus.Windows.GridEX.EditType.Combo
        Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).HasValueList = True
        Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).LimitToList = False
        Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).EditType = Janus.Windows.GridEX.EditType.Combo
        ''Start TFS4181
        Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).EditType = Janus.Windows.GridEX.EditType.CalendarDropDown
        Me.grd.RootTable.Columns(EnumGridDetail.ExpiryDate).FormatString = str_DisplayDateFormat
        Me.grd.RootTable.Columns("Origin").HasValueList = True
        Me.grd.RootTable.Columns("Origin").LimitToList = False
        Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.Combo
        ''End TFS4181
        'Ali Faisal : TFS1362 : 22-Aug-2017 : End
        FillCombo("grdLocation")
        FillCombo("grdSO")
        FillCombo("grdDeliveryChalan")
        'Ali Faisal : TFS1362 : 22-Aug-2017 : Fill combo boxes
        FillCombo("grdEngine")
        FillCombo("grdChassis")
        FillCombo("grdBatch")
        FillCombo("GrdOrigin")
        'Ali Faisal : TFS1362 : 22-Aug-2017 : End
        'FillOutwardExpense(ReceivingID, "SI")
        'Ayesha Rehman: TFS1153 : 23-NOV-2017 : Fill combo boxes
        FillCombo("grdDiscountType")
        'Ayesha Rehman : TFS1153 : 23-NOV-2017 : End
        ApplyGridSettings()
        GetTotal()
        GetAdjustment(Me.cmbPo.SelectedValue) ''Ayesha Rehman - 25-06-2018 : TFS3668
        GetSalesOrderAnalysis()
        Me.grd.RootTable.Columns(EnumGridDetail.Color).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.SED).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.Size).Visible = True
        Me.grd.RootTable.Columns("SalesAccountId").Visible = False
        Me.grd.RootTable.Columns("InvAccountId").Visible = False
        Me.grd.RootTable.Columns("CGSAccountId").Visible = False
        Me.grd.RootTable.Columns("CR_SalesDetailId").Visible = False
        Me.grd.RootTable.Columns("SaleCertificateId").Visible = False
        Me.grd.RootTable.Columns("SalesReturnQty").Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.Stock).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanDetailId).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).Visible = False
        Me.grd.RootTable.Columns(EnumGridDetail.FlatDiscount).Visible = False
        'Me.grd.RootTable.Columns(EnumGridDetail.ServiceQty).Visible = False
        Me.txtQty.Visible = True
        Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).Visible = True
        If flgLoadAllItems = True Then
            For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                If Me.grd.RowCount > 0 Then
                    r.BeginEdit()
                    r.Cells("LocationId").Value = Me.cmbCategory.SelectedValue
                    r.EndEdit()
                End If
            Next
        End If

    End Sub
    ''Start TFS3113
    Private Sub btnApprovalHistory_Click(sender As Object, e As EventArgs) Handles btnApprovalHistory.Click
        Try
            frmApprovalHistory.DocumentNo = Me.txtPONo.Text
            frmApprovalHistory.Source = Me.Name
            frmApprovalHistory.ShowDialog()
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''End TFS3113

    Private Sub CtrlGrdBar3_Load(sender As Object, e As EventArgs) Handles CtrlGrdBar1.Load
        Try
            If IO.File.Exists(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grd.Name) Then
                Dim fs As New IO.FileStream(Application.ExecutablePath & "\..\Layouts\" & Me.Name & "_" & Me.grd.Name, IO.FileMode.OpenOrCreate, IO.FileAccess.ReadWrite)
                Me.grd.LoadLayoutFile(fs)
                fs.Close()
                fs.Dispose()
            End If
            CtrlGrdBar.strForm_Name = CtrlGrdBar.EnmAccountType.Customers
            Me.CtrlGrdBar3.txtGridTitle.Text = CompanyTitle & Chr(10) & "Sales"
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    ''' <summary>
    ''' TASK TFS3324
    ''' </summary>
    ''' <param name="ArticleID"></param>
    ''' <returns></returns>
    ''' <remarks> Stock should be effected from items of a logical item not logical item</remarks>




    Private Function GetItemsOfLogicalItem(ByVal ArticleID As Integer, ByVal LocationId As Integer, ByVal Qty As Double, ByVal Remarks As String, ByVal Command As OleDbCommand) As Boolean
        Try
            Dim dtItems As New DataTable
            Dim dataAdapter As OleDbDataAdapter
            Dim Query As String = " SELECT tblCostSheet.ArticleID AS ArticleId, Case When IsNull(tblCostSheet.CostPrice,0)=0 Then IsNull(ArticleDefTable.PurchasePrice,0.0) Else IsNull(tblCostSheet.CostPrice,0.0) End AS [Purchase Price], IsNull(ArticleDefTable.SalePrice,0.0) AS [Sale Price], tblCostSheet.Total_Qty As Qty, " _
                        & " ISNULL(tblCostSheet.Qty,0) as TotalQty FROM tblCostSheet INNER JOIN ArticleDefTable ON tblCostSheet.ArticleID = ArticleDefTable.ArticleId WHERE tblCostSheet.MasterArticleID IN (SELECT DISTINCT MasterID FROM ArticleDefTable WHERE ArticleId = " & ArticleID & ")"
            Command.CommandText = Query
            dataAdapter = New OleDbDataAdapter()
            dataAdapter.SelectCommand = Command
            dataAdapter.Fill(dtItems)
            dtItems.AcceptChanges()
            If dtItems.Rows.Count > 0 Then
                For Each Row As DataRow In dtItems.Rows
                    If Val(Row.Item("TotalQty").ToString) > 0 Then
                        StockDetail = New StockDetail
                        StockDetail.StockTransId = 0 'Convert.ToInt32(GetStockTransId(Me.txtPONo.Text).ToString)
                        StockDetail.LocationId = LocationId
                        StockDetail.ArticleDefId = Row.Item("ArticleId")
                        StockDetail.InQty = 0
                        If IsSalesOrderAnalysis = True Then
                            StockDetail.OutQty = Val(Row.Item("TotalQty").ToString) * Qty
                        Else
                            StockDetail.OutQty = Val(Row.Item("TotalQty").ToString) * Qty
                        End If
                        StockDetail.Rate = Val(Row.Item("Purchase Price").ToString)
                        StockDetail.InAmount = 0
                        StockDetail.OutAmount = Val(Row.Item("Purchase Price").ToString) * StockDetail.OutQty
                        StockDetail.Remarks = Remarks
                        StockDetail.Engine_No = ""
                        StockDetail.Chassis_No = ""
                        StockDetail.PackQty = Val(Row.Item("Qty").ToString)
                        StockDetail.Out_PackQty = Val(Row.Item("Qty").ToString) * Qty
                        StockDetail.In_PackQty = 0
                        StockDetail.BatchNo = ""
                        StockDetail.Origin = ""
                        StockList.Add(StockDetail)
                    End If
                Next
            Else
                Return False
            End If
            Return True
        Catch ex As Exception
            Throw ex
        End Try
    End Function

    Private Sub lnkLblRevisions_Click(sender As Object, e As EventArgs) Handles lnkLblRevisions.Click
        If lblRev.Visible = False AndAlso cmbRevisionNumber.Visible = False Then
            Me.lblRev.Visible = True
            Me.cmbRevisionNumber.Visible = True
            lnkLblRevisions.Visible = False
        End If
    End Sub

    Private Sub lnkLblRevisions_LinkClicked(sender As Object, e As LinkLabelLinkClickedEventArgs) Handles lnkLblRevisions.LinkClicked
        If lblRev.Visible = False AndAlso cmbRevisionNumber.Visible = False Then
            Me.lblRev.Visible = True
            Me.cmbRevisionNumber.Visible = True
            lnkLblRevisions.Visible = False
        End If
    End Sub

    Private Sub cmbRevisionNumber_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbRevisionNumber.SelectedIndexChanged
        Try
            If cmbRevisionNumber.SelectedValue > 0 AndAlso IsRevisionRestrictedFirstTime = False Then
                DisplayHistory(Val(cmbRevisionNumber.Text), cmbRevisionNumber.SelectedValue)
                DisplayDetailHistory(Val(cmbRevisionNumber.Text), cmbRevisionNumber.SelectedValue)
            End If
            IsRevisionRestrictedFirstTime = False
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    Public Function CheckRevisionNumber(ByVal SalesId As Integer) As Integer
        Dim str As String = String.Empty
        Try
            str = "Select Distinct RevisionNumber, RevisionNumber FROM SalesHistory Where SalesId =" & SalesId & " Order by 1 DESC"
            dt = GetDataTable(str)
            dt.AcceptChanges()
            If dt.Rows.Count > 0 Then
                Return dt.Rows.Item(0).Item(0)
            Else
                Return 0
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Public Function FillRevisionCombo(ByVal SalesId As Integer) As Integer
        Dim str As String = String.Empty
        Try
            str = "Select SalesHistoryId, RevisionNumber FROM SalesHistory Where SalesId =" & SalesId & " Order by 1 DESC"
            FillDropDown(Me.cmbRevisionNumber, str, False)
            dt = GetDataTable(str)
            dt.AcceptChanges()
            If dt.Rows.Count > 0 Then
                Return dt.Rows.Item(0).Item(0)
            Else
                Return 0
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Function
    Private Sub DisplayHistory(ByVal revisionNumber As Integer, ByVal historyId As Integer)
        Dim str As String = String.Empty
        Dim dt As New DataTable
        Try
            'str = "SELECT Recv.SalesOrderNo, Recv.SalesOrderDate AS Date, dbo.vwCOADetail.detail_title AS CustomerName, Recv.SalesOrderQty, " & _
            '               "Recv.SalesOrderAmount, Recv.SalesOrderId, Recv.VendorId, Recv.Remarks, CONVERT(varchar, Recv.CashPaid) AS CashPaid, ISNULL(Recv.LocationId,0) as LocationId, ISNULL(Recv.SpecialAdjustment,0) as SpecialAdjustment, Recv.PoNo as [Po No], isnull(Recv.SOP_ID,0) as SOP_ID, tblDefEmployee.Employee_Name, ISNULL(Recv.Posted,0) as Posted, Recv.Delivery_Date, Isnull(Recv.Adj_Flag,0) as Adj_Flag, Isnull(Recv.Adjustment,0) as Adjustment, Isnull(Recv.CostCenterID,0) as CostCenterId, Recv.PO_Date,  ISNULL(Recv.EditionalTax_Percentage,0) as EditionalTax_Percentage, ISNULL(Recv.SED_Percentage,0) as SED_Percentage, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], CstCntr.Name, dbo.vwCOADetail.Contact_Email as Email,IsNull(Recv.SaleOrderStatusId,0) as SaleOrderStatusId, SalesOrderStatusTable.OrderStatus as [Order Status], IsNull(Recv.QuotationId,0) as QuotationId, Quot.QuotationNo, IsNull(Doc_Att.[No Of Attachment],0) as  [No Of Attachment],Recv.Terms_And_Condition,recv.UserName,Recv.UpdateUserName as [Modified By], IsNull(Recv.SaleOrderTypeId,0) as SaleOrderTypeId, SalesOrderTypeTable.SalesOrderTypeName as [Order Type]   " & _
            '               "FROM tblDefCostCenter CstCntr Right Outer Join dbo.SalesOrderHistory Recv ON CstCntr.CostCenterID=Recv.CostCenterId LEFT OUTER JOIN " & _
            '               "dbo.vwCOADetail ON Recv.VendorId = dbo.vwCOADetail.coa_detail_id LEFT OUTER JOIN tblDefEmployee ON tblDefEmployee.Employee_ID = Recv.SOP_ID LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.SalesOrderNo LEFT OUTER JOIN QuotationMasterTable Quot On Quot.QuotationId = Recv.QuotationId  LEFT OUTER JOIN  SalesOrderStatusTable on SalesOrderStatusTable.OrderStatusID = Recv.SaleOrderStatusID LEFT OUTER JOIN (Select Count(*) as [No Of Attachment],DocId From DocumentAttachment WHERE (source = N'" & Me.Name & "') Group By DocId, Source) Doc_Att on Doc_Att.DocId = Recv.SalesOrderId LEFT OUTER JOIN SalesOrderTypeTable on SalesOrderTypeTable.SaleOrderTypeId = Recv.SaleOrderTypeId WHERE Recv.SalesOrderNo IS NOT NULL And Recv.RevisionNumber = " & revisionNumber & " And Recv.SalesOrderHistoryId = " & historyId & ""
            'dt = GetDataTable(str)
            str = "SELECT Recv.SalesNo, Recv.SalesDate AS Date,Case When IsNull(DV.POID,0)=0 Then V.SalesOrderNo else SO_DL.SalesOrderNo End as SalesOrderNo,  Case When IsNull(DV.POID,0)=0 Then V.SalesOrderDate else SO_DL.SalesOrderDate End as SalesOrderDate, vwCOADetail.detail_title as CustomerName, Pack.Packs, Recv.SalesQty, Recv.SalesAmount, Recv.SalesId, Recv.Arrival_Time , Recv.Departure_Time, Recv.Com_Percentage,  " & _
                  "Recv.CustomerCode, tbldefEmployee.Employee_Name, Recv.Remarks, Recv.InternalRemarks,CONVERT(varchar, Recv.CashPaid) AS CashPaid, Recv.EmployeeCode, Recv.PoId, Recv.BiltyNo,isnull(Recv.TransporterId ,0) as TransporterId, Recv.LocationId, Recv.FuelExpense as Fuel, Recv.OtherExpense as Expense ,recv.Adjustment, IsNull(Recv.Invoice_Status,0) as InvoiceStatus , isnull(recv.TransitInsurance,0) as TransitInsurance, IsNull(Recv.Post,0) as Post, Case When IsNull(Recv.Post,0)=1 then 'Posted' else 'UnPosted' end As Status, ISNULL(Recv.ServiceItemSale,0) as ServiceItemSale, Recv.DeliveryDate, ISNULL(Recv.Delivered,0) as Delivered, isnull(Recv.DeliveryChalanId, 0) as DeliveryId, DV.DeliveryNo, DV.DeliveryDate as [Dc Date], Recv.DcNo, isnull(Recv.Adj_Flag,0) as Adj_Flag, isnull(Recv.Adj_Percentage,0) as Adj_Percentage ,Isnull(Recv.CostCenterId,0) as CostCenterId, CASE WHEN ISNULL(PrintLog.Cont,0)=0 THEN 'Print Pending' ELSE 'Printed' end as [Print Status], tblDefCostCenter.Name, Isnull(Recv.ManualInvoice,0) as ManualInvoice, Recv.InvoiceParty, ISNULL(Recv.CMFADocId,0) as CMFADocID, (CMFA.DocNo + '~' + Convert(varchar,Convert(varchar,CMFA.DocDate, 102))) as CMFADocNo, IsNull(Recv.DueDays,0) as DueDays, dbo.vwCOADetail.Contact_Email as Email, IsNull(Recv.InvoiceType,'Credit') as [Inv Type], IsNull([No Of Attachment],0) as  [No Of Attachment],Recv.Other_Company, Recv.Party_Mobile_No , Adjustment.InvoiceID,Recv.UserName as 'User Name',Recv.UpdateUserName as [Modified By], IsNull(tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID,0) as SalesTaxInvoiceStatus_ID, tblSalesTaxInvoiceStatus.SalesTaxInvoice_Status as [Invoice Status], IsNull(Recv.PreviousBalance,0) as PreviousBalance, IsNull(Recv.JobCardId, 0) As JobCardId, tblJobCard.JobCardNo,  Convert(bit, IsNull(Recv.IsSOSeparateClosure, 0)) AS IsSOSeparateClosure " & _
                  "FROM tblDefCostCenter Right Outer JOIN SalesHistory Recv ON tblDefCostCenter.CostCenterID=Recv.CostCenterId INNER JOIN " & _
                  "vwCOADetail ON Recv.CustomerCode = vwCOADetail.coa_detail_id LEFT OUTER JOIN tblJobCard ON Recv.JobCardId = tblJobCard.JobCardID LEFT OUTER JOIN (Select SalesId, Sum(IsNull(Sz1, 0)) As Packs From SalesDetailHistory Group By SalesId) As Pack ON Recv.SalesId = Pack.SalesId LEFT OUTER JOIN " & _
                  "tblDefEmployee ON Recv.EmployeeCode = tblDefEmployee.Employee_Id LEFT OUTER JOIN " & _
                  "SalesOrderMasterTable V ON Recv.POId = V.SalesOrderId  LEFT OUTER JOIN (Select Count(*) as [No Of Attachment],DocId From DocumentAttachment WHERE (source = N'" & Me.Name & "') Group By DocId, Source) Doc_Att on Doc_Att.DocId = Recv.SalesId LEFT OUTER JOIN DeliveryChalanMasterTable DV ON DV.DeliveryId = Recv.DeliveryChalanId LEFT OUTER JOIN CMFAMasterTable CMFA ON CMFA.DocId = Recv.CMFADocID LEFT OUTER JOIN(Select Count(Id) as Cont, DocumentNo From tblPrint_Log Group By DocumentNo) PrintLog On PrintLog.DocumentNo = Recv.SalesNo LEFT OUTER JOIN SalesOrderMasterTable SO_DL On SO_DL.SalesOrderId = DV.POId " & _
                  " left outer join (Select InvoiceId from InvoiceAdjustmentTable where InvoiceType = 'Sales') as Adjustment on Recv.SalesId = Adjustment.InvoiceID  Left Outer Join tblSalesTaxInvoiceStatus on Recv.Invoice_Status = tblSalesTaxInvoiceStatus.SalesTaxInvoiceStatus_ID   " & _
                  " WHERE Recv.SalesNo <> ''  AND Recv.SalesHistoryId = " & historyId & " AND Recv.RevisionNumber = " & revisionNumber & ""
            dt = GetDataTable(str)
            dt.AcceptChanges()


            '' Assignment of values
            RemoveHandler Me.cmbCompany.SelectedIndexChanged, AddressOf Me.cmbCompany_SelectedIndexChanged
            RemoveHandler Me.cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
            RemoveHandler Me.cmbDeliveryChalan.SelectedIndexChanged, AddressOf Me.cmbDeliveryChalan_SelectedIndexChanged
            'Dim ID As Integer = dt.Rows(0).Item("InvoiceID").ToString
            Me.cmbVendor.Enabled = IsDBNull(dt.Rows(0).Item("InvoiceID"))
            Me.btnAttachment.Text = "Attachment (" & dt.Rows(0).Item("InvoiceID").ToString & ")"
            txtPONo.Text = dt.Rows(0).Item(0).ToString
            Me.GetSecurityRights()
            If dt.Rows(0).Item(1) > Date.Today.ToString("yyyy-MM-dd 23:59:59") AndAlso IsDateChangeAllowed = False Then
                dtpPODate.MaxDate = dtpPODate.Value.AddMonths(3)
                dtpPODate.Value = CType(dt.Rows(0).Item(1), Date)
            Else
                dtpPODate.MaxDate = System.DateTime.MaxValue.AddYears(-2)
                dtpPODate.Value = CType(dt.Rows(0).Item(1), Date)
            End If
            txtReceivingID.Text = dt.Rows(0).Item("SalesId")
            Me.btnApprovalHistory.Visible = True
            Me.btnApprovalHistory.Enabled = True
            cmbVendor.Value = dt.Rows(0).Item("CustomerCode")
            If Me.cmbVendor.ActiveRow Is Nothing Then
                ShowErrorMessage("Customer is disable.")
                Exit Sub
            End If
            cmbCompany.SelectedValue = dt.Rows(0).Item("LocationId")
            cmbCompany.Enabled = False
            txtRemarks.Text = dt.Rows(0).Item("Remarks") & ""
            richTxtInternalRemarks.Text = dt.Rows(0).Item("InternalRemarks") & "" ''TFS1864
            txtPaid.Text = dt.Rows(0).Item("CashPaid") & ""
            txtCurrentBalance.Text = Val(dt.Rows(0).Item("PreviousBalance").ToString)
            Me.uitxtBiltyNo.Text = dt.Rows(0).Item("BiltyNo") & ""
            Me.cmbSalesMan.SelectedValue = dt.Rows(0).Item("EmployeeCode").ToString
            Me.txtComPercentage.Text = Val(dt.Rows(0).Item("Com_Percentage").ToString)
            Me.cmbPo.SelectedValue = Val(dt.Rows(0).Item("POID").ToString)
            If Me.cmbPo.SelectedValue Is Nothing Then
                Dim dt1 As New DataTable
                dt1 = CType(Me.cmbPo.DataSource, DataTable)
                dt1.AcceptChanges()
                Dim dr As DataRow
                dr = dt1.NewRow
                dr(0) = dt.Rows(0).Item("PoId")
                dr(1) = dt.Rows(0).Item("SalesOrderNo")
                dt1.Rows.Add(dr)
                dt1.AcceptChanges()
                Me.cmbPo.SelectedValue = Val(dt.Rows(0).Item("POID"))
            End If
            Dim chkDtCMFA As DataTable = CType(Me.cmbCMFADoc.DataSource, DataTable)
            Dim chkDrCMFA() As DataRow
            If chkDtCMFA IsNot Nothing Then
                chkDrCMFA = chkDtCMFA.Select("DocID=" & dt.Rows(0).Item("CMFADocId").ToString & "")
                If chkDrCMFA.Length = 0 Then
                    Dim objdr As DataRow
                    objdr = chkDtCMFA.NewRow
                    objdr(0) = dt.Rows(0).Item("CMFADocId").ToString
                    objdr(1) = dt.Rows(0).Item("CMFADocNo").ToString
                    chkDtCMFA.Rows.Add(objdr)
                    chkDtCMFA.AcceptChanges()
                End If
            End If
            Me.cmbCMFADoc.SelectedValue = dt.Rows(0).Item("CMFADocId").ToString
            Me.cmbOtherCompany.Text = dt.Rows(0).Item("Other_Company").ToString
            Me.cmbPo.SelectedValue = dt.Rows(0).Item("PoId")
            Me.cmbTransporter.SelectedValue = dt.Rows(0).Item("TransporterId")
            Me.txtExpense.Text = dt.Rows(0).Item("Expense").ToString
            Me.txtFuel.Text = dt.Rows(0).Item("Fuel").ToString
            Me.txtAddTransitInsurance.Text = dt.Rows(0).Item("TransitInsurance").ToString
            Me.txtInvParty.Text = dt.Rows(0).Item("InvoiceParty").ToString

            Me.DeliveryChalanId = dt.Rows(0).Item("DeliveryId").ToString
            IsSOSeparateClosure = dt.Rows(0).Item("IsSOSeparateClosure")
            'Dim RevisionNumber As Integer = Me.CheckRevisionNumber(grdSaved.CurrentRow.Cells("SalesId").Value)
            'If RevisionNumber > 0 Then
            '    IsRevisionRestrictedFirstTime = True
            '    Me.FillRevisionCombo(grdSaved.CurrentRow.Cells("SalesOrderId").Value)
            '    Me.cmbRevisionNumber.Visible = False
            '    Me.lblRev.Visible = False
            '    Me.txtPONo.Size = New System.Drawing.Size(95, 21)
            '    Me.lnkLblRevisions.Visible = True
            '    Me.lnkLblRevisions.Text = "Rev (" & RevisionNumber & ")"
            'Else
            '    Me.cmbRevisionNumber.Visible = False
            '    Me.lblRev.Visible = False
            '    Me.lnkLblRevisions.Visible = False
            '    Me.txtPONo.Size = New System.Drawing.Size(177, 21)
            'End If
            ''END TASK TFS4391
            If IsDBNull(dt.Rows(0).Item("Arrival_Time")) Then
                Me.dtpArrivalTime1.Value = Date.Now
            Else
                Me.dtpArrivalTime1.Value = dt.Rows(0).Item("Arrival_Time")
            End If
            If IsDBNull(dt.Rows(0).Item("Departure_Time")) Then
                Me.dtpDepartureTime1.Value = Date.Now
                Me.dtpDepartureTime1.Checked = False
            Else
                Me.dtpDepartureTime1.Value = dt.Rows(0).Item("Departure_Time")
                Me.dtpDepartureTime1.Checked = True
            End If
            If Me.DeliveryChalanId > 0 Then
                Me.cmbDeliveryChalan.SelectedValue = Me.DeliveryChalanId
                If Me.cmbDeliveryChalan.SelectedValue Is Nothing Then
                    Dim dtdc As DataTable = CType(Me.cmbDeliveryChalan.DataSource, DataTable)
                    dtdc.AcceptChanges()
                    Dim dr As DataRow = dtdc.NewRow
                    dr(0) = Me.DeliveryChalanId
                    dr(1) = dt.Rows(0).Item("DeliveryNo").ToString
                    dtdc.Rows.Add(dr)
                    dtdc.AcceptChanges()
                End If
            End If
            Me.cmbDeliveryChalan.SelectedValue = Me.DeliveryChalanId
            Me.txtDcNo.Text = dt.Rows(0).Item("DcNo").ToString
            Me.txtDueDays.Text = Val(dt.Rows(0).Item("DueDays").ToString)
            If dt.Rows(0).Item("Adj_Flag") = False Then
                Me.rbtAdjFlat.Checked = True
                Try
                    Me.txtAdjustment.Text = Val(dt.Rows(0).Item("Adjustment").ToString())
                Catch ex As Exception

                End Try
            Else
                Me.rbtAdjPercentage.Checked = True
                Try
                    Me.txtAdjustment.Text = Val(dt.Rows(0).Item("Adj_Percentage").ToString())
                Catch ex As Exception

                End Try
            End If
            Me.BtnSave.Text = "&Update"
            If IsSalesOrderAnalysis = True Then
                Me.rbtAdjPercentage.Enabled = False
            Else
                Me.rbtAdjPercentage.Enabled = True
            End If
            'Call DisplayDetail(grdSaved.CurrentRow.Cells("SalesId").Value)
            GetTotal()
            If Val(dt.Rows(0).Item("JobCardId").ToString) > 0 Then
                GetJobCard(Val(dt.Rows(0).Item("JobCardId").ToString))
                Me.gbJobCard.Visible = True
            Else
                Me.gbJobCard.Visible = False
            End If
            Me.ExistingBalance = Val(Me.txtAmount.Text)
            'Me.BtnSave.Text = "&Update"
            'Me.LinkLabel1.Enabled = False
            Me.cmbPo.Enabled = False
            If Me.cmbPo.SelectedValue > 0 Then
                Me.cmbVendor.Enabled = False
            Else
                Me.cmbVendor.Enabled = True
            End If
            'Customer Edit List flag here... 
            If Me.cmbPo.SelectedIndex = 0 Then
                If EditCustomerListOnSale = "False" Then
                    Me.cmbVendor.Enabled = True
                Else
                    Me.cmbVendor.Enabled = False
                End If
            End If
            If flgMultipleSalesOrder = False Then
                If getConfigValueByType("AllowChangeSO").ToString.ToUpper = "TRUE" Then
                    Me.cmbPo.Enabled = True
                Else
                    Me.cmbPo.Enabled = False
                End If
            End If
            If flgAutoInvoiceGenerate = False Then

            End If
            Me.chkDelivered.Checked = dt.Rows(0).Item("Delivered")
            Me.cmbInvType.Text = dt.Rows(0).Item("Inv Type").ToString
            If Val(Me.txtAddTransitInsurance.Text) <> 0 Then
                Me.txtTransitInsurancePercentage.Text = ((Val(Me.txtAddTransitInsurance.Text) / (Val(Me.grd.GetTotal(Me.grd.RootTable.Columns(EnumGridDetail.Total), Janus.Windows.GridEX.AggregateFunction.Sum)))) * 100)
            End If
            Dim strInv As String = "Select Count(*) From InvoiceAdjustmentTable WHERE InvoiceId=" & dt.Rows(0).Item("SalesId") & " And InvoiceType='Sales'"
            Dim dtInv As New DataTable
            dtInv = GetDataTable(strInv)
            dtInv.AcceptChanges()
            If dtInv IsNot Nothing Then
                If dtInv.Rows.Count > 0 Then
                    If Val(dtInv.Rows(0).Item(0).ToString) > 0 Then
                        Me.cmbVendor.Enabled = False
                    End If
                End If
            End If
            If IsDBNull(dt.Rows(0).Item("SalesTaxInvoiceStatus_ID")) Then
                Me.cmbInvoiceStatus.Rows(0).Activate()
            Else
                Me.cmbInvoiceStatus.Value = dt.Rows(0).Item("SalesTaxInvoiceStatus_ID")
            End If
            Me.chkPost.Checked = dt.Rows(0).Item("Post")
            If blnUpdateAll = False Then Me.UltraTabControl2.SelectedTab = Me.UltraTabControl2.Tabs(0).TabPage.Tab : Me.tbSalesDetail.SelectedTab = Me.tbSalesDetail.Tabs(0).TabPage.Tab
            Me.CtrlGrdBar3_Load(Nothing, Nothing)
            VoucherDetail(Me.txtPONo.Text)
            Previouse_Amount = Val(Me.txtAmount.Text)
            Me.lblPrintStatus.Text = "Print Status: " & dt.Rows(0).Item("Print Status").ToString
            Me.cmbProject.SelectedValue = dt.Rows(0).Item("CostCenterId")
            If flgDateLock = True Then
                If Convert.ToDateTime(CDate(MyDateLock.ToString("yyyy-M-d 00:00:00"))) >= Convert.ToDateTime(CDate(Me.dtpPODate.Value.ToString("yyyy-M-d 00:00:00"))) Then
                    Me.dtpPODate.Enabled = False
                Else
                    Me.dtpPODate.Enabled = True
                End If
            Else
                Me.dtpPODate.Enabled = True
            End If
            Dim intCountAttachedFiles As Integer = 0I
            If Me.BtnSave.Text <> "&Save" Then
                If Me.grdSaved.RowCount > 0 Then
                    intCountAttachedFiles = Val(dt.Rows(0).Item("No Of Attachment"))
                    Me.btnAttachment.Text = "Attachment (" & intCountAttachedFiles & ")"
                End If
            End If
            If BtnSave.Enabled = True Then
                Dim getid As Boolean = getpaymentstatus(dt.Rows(0).Item("JobCardId"))
                If getid = True Then
                    Me.BtnSave.Enabled = False
                Else
                    Me.BtnSave.Enabled = True
                End If
            End If
            If BtnSave.Enabled = True Then
                If dt.Rows(0).Item(1) > Date.Today.ToString("yyyy-MM-dd 23:59:59") AndAlso IsDateChangeAllowed = False Then
                    Me.BtnSave.Enabled = False
                    ErrorProvider2.SetError(Me.Label2, "Future Date can not be edit")
                    ErrorProvider2.BlinkRate = 1000
                    ErrorProvider2.BlinkStyle = ErrorBlinkStyle.AlwaysBlink
                Else
                    Me.BtnSave.Enabled = True
                    ErrorProvider2.Clear()
                End If
            End If
            If Not Mode = "Normal" Then Me.txtBarcodescan.Focus()
            Me.BtnDelete.Visible = True
            Me.BtnPrint.Visible = True
            GrpPrint.Visible = True
            BtnPrintNew.Visible = True
            ChkInvoice.Checked = True
            ChkBill.Checked = False
            ChkUnderTaking.Checked = False
            FillCombo("Item")
            AddHandler Me.cmbCompany.SelectedIndexChanged, AddressOf Me.cmbCompany_SelectedIndexChanged
            AddHandler Me.cmbPo.SelectedIndexChanged, AddressOf Me.cmbPo_SelectedIndexChanged
            AddHandler Me.cmbDeliveryChalan.SelectedIndexChanged, AddressOf Me.cmbDeliveryChalan_SelectedIndexChanged
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
    Public Sub DisplayDetailHistory(ByVal RevisionNumber As Integer, ByVal HistoryId As Integer)
        Dim str As String = String.Empty
        Dim i As Integer = 0
        Try
            str = "SELECT Recv_D.LocationId, Article.ArticleCode as Code, Article.ArticleDescription AS Item, Article.ArticleSizeName AS Size, Article.ArticleColorName AS Color , Recv_D.ArticleSize AS Unit, Convert(Decimal(18, " & DecimalPointInQty & "), Recv_D.Sz1, 1) AS Qty, " _
                    & " IsNull(Recv_D.PostDiscountPrice, 0) As PostDiscountPrice, IsNull(Recv_D.DiscountId, 0) As DiscountId, Recv_D.DiscountType, ISNULL(Recv_D.Discount_Percentage,0) as Discount_Percentage, IsNull(Recv_D.FlatDiscount, 0) As FlatDiscount, IsNull(Recv_D.DiscountFactor, 0) As DiscountFactor, IsNull(Recv_D.DiscountValue, 0) As DiscountValue,  " _
                    & " Recv_D.Price as Rate, IsNull(Recv_D.BaseCurrencyId, 0) As BaseCurrencyId, IsNull(Recv_D.BaseCurrencyRate, 0) As BaseCurrencyRate, IsNull(Recv_D.CurrencyId, 0) As CurrencyId, Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End As CurrencyRate, IsNull(Recv_D.CurrencyAmount, 0) As CurrencyAmount, Convert(float,0) as [Total Currency Amount], " _
                    & " (IsNull(Recv_D.Qty, 0) * IsNull(Recv_D.Price, 0) * Case When IsNull(Recv_D.CurrencyRate, 0) = 0 Then 1 Else Recv_D.CurrencyRate End) AS Total, " _
                    & " Article.ArticleGroupId,Recv_D.ArticleDefId, Recv_D.Sz7 as [Pack Qty], ISNULL(Recv_D.CurrentPrice,0) as CurrentPrice, Isnull(Recv_D.PackPrice,0) as PackPrice,  Recv_D.SaleDetailId, ISNULL(Recv_D.RetailPrice,0) as RetailPrice, ISNULL(Recv_D.TradePrice,0) as TradePrice, isnull(Recv_D.TaxPercent,0) as Tax, Convert(float,0) as [Tax Amount], Convert(float,0) as [Currency Tax Amount], ISNULL(Recv_D.SEDPercent,0) As SED, Convert(float,0) as [Total Amount],0 as savedqty , SampleQty as [Sample Qty], ISNULL(Recv_D.Freight,0) as Freight, ISNULL(Recv_D.MarketReturns,0) as MarketReturns, ISNULL(So_ID,0) as So_Id, Convert(Decimal(18, " & DecimalPointInQty & "), isnull(Recv_D.LoadQty,0), 1) as LoadQty, Isnull(Recv_D.PurchasePrice,0) as PurchasePrice, 0 as NetBill,  Recv_D.BatchID,isnull(Recv_D.BatchNo,'') as [Batch No], Recv_D.ExpiryDate,isnull(Recv_D.Origin,'') as Origin, IsNull(Recv_D.BardanaDeduction, 0) AS [Bardana Deduction], IsNull(Recv_D.OtherDeduction, 0) AS [Other Deduction], Convert(float, 0) [After Deduction Qty], Recv_D.Comments, Recv_D.Other_Comments as [Other Comments], Recv_D.Engine_No, Recv_D.Chassis_No, Isnull(Recv_D.Pack_Desc,Recv_D.ArticleSize) as Pack_Desc, Isnull(Article.SubSubId,0) as InvAccountId, Article.SalesAccountId, Article.CGSAccountId, Isnull(Recv_D.CostPrice,0) as CostPrice, IsNull(CR.SalesDetailId,0) as CR_SalesDetailId, IsNull(Cr.SaleCertificateId,0) as SaleCertificateId, IsNull(Stock.CurrStock,0) as Stock,IsNull(Recv_D.SalesReturnQty,0)  as SalesReturnQty, IsNull(Recv_D.DeliveryChalanId,0) as DeliveryChalanId, IsNull(Recv_D.DeliveryChalanDetailId,0) as DeliveryChalanDetailId, IsNull(Recv_D.Transport_Charges,0) as Transport_Charges, IsNull(Recv_D.ApplyAdjustmentFuelExp,1) as  ApplyAdjustmentFuelExp, IsNull(Recv_D.Gross_Weights, 0) As Gross_Weights,IsNull(Recv_D.Tray_Weights, 0) As Tray_Weights, IsNull(Recv_D.Net_Weights, 0) As Net_Weights, Convert(Decimal(18, " & DecimalPointInQty & "), IsNull(Recv_D.Qty,0), 1) as TotalQty, IsNull(Recv_D.SO_Detail_ID, 0) As SODetailId, ArticleLpoDefTable.ArticleLpoName, IsNull(Recv_D.OldSalePrice, 0) As OldSalePrice, IsNull(Recv_D.SalePriceProcessId, 0) As SalePriceProcessId ,IsNull(Article.LogicalItem, 0) AS LogicalItem" _
                    & " FROM SalesDetailHistory Recv_D INNER JOIN SalesHistory AS Recv ON Recv_D.SaleHistoryId = Recv.SalesHistoryId INNER JOIN " _
                    & " ArticleDefView Article ON Recv_D.ArticleDefId = Article.ArticleId inner JOIN " _
                    & " tblDefLocation ON Recv_D.LocationId = tblDefLocation.Location_id LEFT OUTER JOIN(Select ArticleDefID, SUM(IsNull(InQty,0)-ISNull(OutQty,0)) as CurrStock From StockDetailTable Group By ArticleDefId Having SUM(IsNull(InQty,0)-ISNull(OutQty,0)) <> 0) Stock On Stock.ArticleDefId = Recv_D.ArticleDefId " _
                    & " LEFT OUTER JOIN SalesCertificateTable CR On CR.SalesDetailId = Recv_D.SaleDetailId Left Outer Join ArticleLpoDefTable ON Article.ArticleLPOId = ArticleLpoDefTable.ArticleLpoId" _
                    & " Where Recv_D.SaleHistoryId =" & HistoryId & " AND Recv.RevisionNumber = " & RevisionNumber & " ORDER BY Recv_D.SaleDetailHistoryId Asc"
            Dim objCommand As New OleDbCommand
            Dim objCon As OleDbConnection
            Dim objDataAdapter As New OleDbDataAdapter
            Dim objDataSet As New DataSet
            objCon = Con
            If objCon.State = ConnectionState.Open Then objCon.Close()
            objCon.Open()
            objCommand.Connection = objCon
            objCommand.CommandType = CommandType.Text
            objCommand.CommandText = str
            objDataAdapter.SelectCommand = objCommand
            objDataAdapter.Fill(objDataSet)
            If Not IsSalesOrderAnalysis = True Then
                objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountId= 1,((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountId= 1, IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))) * IsNull(rate,0) * CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(rate,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(rate,0) * CurrencyRate)))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)*CurrencyRate)"
                objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"
            Else
                objDataSet.Tables(0).Columns(EnumGridDetail.DiscountValue).Expression = "IIF(DiscountId= 1,((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Price).Expression = "IIF(DiscountId= 1, IsNull(PostDiscountPrice,0)-((IsNull(PostDiscountPrice,0)*IsNull(DiscountFactor,0))/100), IsNull(PostDiscountPrice,0)-IsNull(DiscountFactor,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.NetBill).Expression = "IIF(IsNull(rate,0)=0,0,((((((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) + IsNull([Sample Qty],0)) * IsNull(rate,0) * CurrencyRate) * IsNull(Tax,0))/100) + (IsNull(Freight,0) * ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))+IsNull([Sample Qty],0)))) - ((((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * IsNull(rate,0) * CurrencyRate) * IsNull(Discount_Percentage,0))/100)) - (IsNull(FlatDiscount, 0)) + ((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))  * IsNull(rate,0) * CurrencyRate)))"
                objDataSet.Tables(0).Columns(EnumGridDetail.Total).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0)) * IsNull(CurrencyRate, 0) "
                objDataSet.Tables(0).Columns(EnumGridDetail.CurrencyAmount).Expression = "((isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction])) * isnull(Rate,0))"
                objDataSet.Tables(0).Columns(EnumGridDetail.AfterDeductionQty).Expression = "(isnull(TotalQty,0)-([Bardana Deduction]+[Other Deduction]))"
            End If
            If flgExcludeTaxPrice = False Then
                objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(CurrencyAmount,0))"
                objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)+IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))" 'Task:2374 Set Expression Total Amount 
                objDataSet.Tables(0).Columns("Tax Amount").Expression = "((IsNull(Tax,0)/100)*IsNull(Total,0))"
                objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)+IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))" 'Task:2374 Set Expression Total Amount

            Else
                objDataSet.Tables(0).Columns("Currency Tax Amount").Expression = "(IsNull(CurrencyAmount,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
                objDataSet.Tables(0).Columns("Total Currency Amount").Expression = "(IsNull(CurrencyAmount,0)-IsNull([Currency Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(CurrencyAmount,0)))" 'Task:2374 Set Expression Total Amount 
                objDataSet.Tables(0).Columns("Tax Amount").Expression = "(IsNull(Total,0)/(IsNull(Tax,0)+100))*IsNull(Tax,0)"
                objDataSet.Tables(0).Columns("Total Amount").Expression = "(IsNull(Total,0)-IsNull([Tax Amount],0)+((IsNull(SED,0)/100)*IsNull(Total,0)))"
            End If
            If Me.BtnSave.Text = "&Save" Then
                objDataSet.Tables(0).Columns(EnumGridDetail.LoadQty).Expression = "IsNull(TotalQty,0)"
            End If
            Me.grd.DataSource = objDataSet.Tables(0)
            Me.grd.RetrieveStructure()
            If objDataSet.Tables(0).Rows.Count > 0 Then
                If IsDBNull(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId")) Or Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString) = 0 Then
                    Me.cmbCurrency.Enabled = False
                Else

                    Me.CurrencyRate = Math.Round(Convert.ToInt32(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyRate").ToString), 4)
                    Me.cmbCurrency.SelectedValue = Val(objDataSet.Tables(0).Rows.Item(0).Item("CurrencyId").ToString)
                    Me.cmbCurrency.Enabled = False
                End If
                cmbCurrency_SelectedIndexChanged(Nothing, Nothing)
                CurrencyRate = 1
            End If
            Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Caption = "Challan"
            Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).LimitToList = True
            Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).HasValueList = True
            Me.grd.RootTable.Columns(EnumGridDetail.LocationID).HasValueList = True
            Me.grd.RootTable.Columns(EnumGridDetail.LocationID).LimitToList = True
            Me.grd.RootTable.Columns(EnumGridDetail.LocationID).EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns("So_Id").HasValueList = True
            Me.grd.RootTable.Columns("So_Id").LimitToList = True
            Me.grd.RootTable.Columns("So_Id").EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).HasValueList = True
            Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).LimitToList = False
            Me.grd.RootTable.Columns(EnumGridDetail.Engine_No).EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).HasValueList = True
            Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).LimitToList = False
            Me.grd.RootTable.Columns(EnumGridDetail.Chassis_No).EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).HasValueList = True
            Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).LimitToList = True
            Me.grd.RootTable.Columns(EnumGridDetail.BatchNo).EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).HasValueList = True
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).LimitToList = True
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountId).EditType = Janus.Windows.GridEX.EditType.Combo
            Me.grd.RootTable.Columns("Origin").HasValueList = True
            Me.grd.RootTable.Columns("Origin").LimitToList = True
            Me.grd.RootTable.Columns("Origin").EditType = Janus.Windows.GridEX.EditType.Combo
            FillCombo("grdLocation")
            FillCombo("grdSO")
            FillCombo("grdDeliveryChalan")
            FillCombo("grdEngine")
            FillCombo("grdChassis")
            FillCombo("grdBatch")
            FillCombo("GrdOrigin")
            FillOutwardExpense(Val(txtReceivingID.Text), "SI")
            FillCombo("grdDiscountType")
            ApplyGridSettings()
            GetTotal()
            GetSalesOrderAnalysis()
            Me.grd.RootTable.Columns(EnumGridDetail.Color).Visible = True
            Me.grd.RootTable.Columns(EnumGridDetail.SED).Visible = True
            Me.grd.RootTable.Columns(EnumGridDetail.Size).Visible = True
            Me.grd.RootTable.Columns("SalesAccountId").Visible = False
            Me.grd.RootTable.Columns("InvAccountId").Visible = False
            Me.grd.RootTable.Columns("CGSAccountId").Visible = False
            Me.grd.RootTable.Columns("CR_SalesDetailId").Visible = False
            Me.grd.RootTable.Columns("SaleCertificateId").Visible = False
            Me.grd.RootTable.Columns("SalesReturnQty").Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.Stock).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanId).Visible = True
            Me.grd.RootTable.Columns(EnumGridDetail.DeliveryChalanDetailId).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.DiscountType).Visible = False
            Me.grd.RootTable.Columns(EnumGridDetail.FlatDiscount).Visible = False
            Me.txtQty.Visible = True
            Me.grd.RootTable.Columns(EnumGridDetail.SampleQty).Visible = True
            If flgLoadAllItems = True Then
                For Each r As Janus.Windows.GridEX.GridEXRow In Me.grd.GetRows
                    If Me.grd.RowCount > 0 Then
                        r.BeginEdit()
                        r.Cells("LocationId").Value = Me.cmbCategory.SelectedValue
                        r.EndEdit()
                    End If
                Next
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub btnPrintSelectedRevision_Click(sender As Object, e As EventArgs) Handles btnPrintSelectedRevision.Click
        Try
            ''TASK TFS4391
            If Not Me.cmbRevisionNumber.SelectedValue Is Nothing Then
                AddRptParam("@RevisionNumber", Val(Me.cmbRevisionNumber.Text)) ''SalesHistoryId
                AddRptParam("@SalesHistoryId", Me.cmbRevisionNumber.SelectedValue) ''SalesHistoryId
                ShowReport("rptSalesHistory", , , , , , , , , , , Me.grdSaved.GetRow.Cells("Email").Value.ToString)
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub

    Private Sub frmSales_Load(sender As Object, e As EventArgs) Handles MyBase.Load

    End Sub

    Private Sub txtStock_TextChanged(sender As Object, e As EventArgs) Handles txtStock.TextChanged

    End Sub

    Private Sub lblCurrencyRate_Validated(sender As Object, e As EventArgs) Handles lblCurrencyRate.Validated

    End Sub

    'Change by Murtaza for txtcurrencyrate text change (11/09/2022) 
    Private Sub txtCurrencyRate_TextChanged(sender As Object, e As EventArgs) Handles txtCurrencyRate.TextChanged
        Try
            If Not Me.cmbCurrency.SelectedItem Is Nothing Then
                Dim dr As DataRowView = CType(cmbCurrency.SelectedItem, DataRowView)
                If Me.cmbCurrency.SelectedValue = BaseCurrencyId Then
                    Me.txtCurrencyRate.Enabled = False
                Else
                    Me.txtCurrencyRate.Enabled = True

                End If
                If Val(Me.txtCurrencyRate.Text) = 0 Then
                    Me.txtCurrencyRate.Text = 1
                End If

                Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount).Caption = "Amount (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(EnumGridDetail.CurrencyRate).Caption = "Currency Rate (" & Me.cmbCurrency.Text & ")"
                Me.grd.RootTable.Columns(EnumGridDetail.CurrencyTaxAmount).Caption = "Tax Amount (" & Me.cmbCurrency.Text & ")"

                'grd.AutoSizeColumns()
                If cmbCurrency.SelectedValue = Me.BaseCurrencyId Then
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.BaseCurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyRate).Visible = False
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyTaxAmount).Visible = False
                    If Me.grd.RowCount > 0 Then
                        For Each GriDEX As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                            GriDEX.BeginEdit()
                            GriDEX.Cells("CurrencyRate").Value = Val(Me.txtCurrencyRate.Text)
                            GriDEX.Cells("CurrencyId").Value = Me.cmbCurrency.SelectedValue
                            GriDEX.Cells("BaseCurrencyId").Value = BaseCurrencyId
                            GriDEX.Cells("BaseCurrencyRate").Value = 1
                            GriDEX.EndEdit()
                        Next
                    End If
                Else
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyAmount).Visible = True
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyRate).Visible = True
                    Me.grd.RootTable.Columns(EnumGridDetail.CurrencyTaxAmount).Visible = False
                    If Me.grd.RowCount > 0 Then
                        For Each GriDEX As Janus.Windows.GridEX.GridEXRow In grd.GetRows
                            GriDEX.BeginEdit()
                            GriDEX.Cells("CurrencyRate").Value = Val(Me.txtCurrencyRate.Text)
                            GriDEX.Cells("CurrencyId").Value = Me.cmbCurrency.SelectedValue
                            GriDEX.Cells("BaseCurrencyId").Value = BaseCurrencyId
                            GriDEX.Cells("BaseCurrencyRate").Value = 1
                            GriDEX.EndEdit()
                        Next
                    End If
                End If
            End If
        Catch ex As Exception
            ShowErrorMessage(ex.Message)
        End Try
    End Sub
    'Change by Murtaza for txtcurrencyrate text change (11/09/2022)
    Public Function CheckDuplicateSerialNo() As Boolean
        Try
            Dim Display As String
            If Me.grd.RowCount = 0 Then Return False
            For i As Int32 = 0 To Me.grd.RowCount - 1
                For j As Int32 = i + 1 To Me.grd.RowCount - 1
                    If Me.grd.GetRows(j).Cells(EnumGridDetail.BatchNo).Value.ToString.Length > 0 Then
                        If Me.grd.GetRows(j).Cells(EnumGridDetail.BatchNo).Value.ToString = "xxxx" Or Me.grd.GetRows(j).Cells(EnumGridDetail.BatchNo).Value.ToString = "" Or Me.grd.GetRows(j).Cells(EnumGridDetail.BatchNo).Value.ToString = "0" Then

                        Else
                            If Me.grd.GetRows(j).Cells(EnumGridDetail.BatchNo).Value.ToString = Me.grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString Then
                                Display = Me.grd.GetRows(i).Cells(EnumGridDetail.BatchNo).Value.ToString
                                ShowErrorMessage("Serial No [ " & Display & " ] already exist ")
                                Return True
                            End If
                        End If
                    End If
                Next
            Next
            Return False
        Catch ex As Exception
            Throw ex
        End Try
    End Function


End Class


